{"componentChunkName":"component---src-templates-post-js","path":"/blog/rails-slack-app-part4-action-modal-submission/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">Welcome to the fourth installment of this multi-part series on building a Slack application with Rails. This series will guide you through the process of creating a Slack application with Rails and is structured as follows:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"../rails-slack-app-part1-oauth\" class=\"markdown-link\">Part 1: Rails new, Slack, and OAuth</a></li>\n<li class=\"markdown-list-item\"><a href=\"../rails-slack-app-part2-slash-command-with-text-response\" class=\"markdown-link\">Part 2: Slack Slash Command with Text Response</a></li>\n<li class=\"markdown-list-item\"><a href=\"../rails-slack-app-part3-slash-command-with-modal-response\" class=\"markdown-link\">Part 3: Slack Slash Command with Modal Response</a></li>\n<li class=\"markdown-list-item\">Part 4: Slack Action Modal Submission === YOU ARE HERE ===</li>\n<li class=\"markdown-list-item\"><a href=\"../rails-slack-app-part5-slash-block-kit-response\" class=\"markdown-link\">Part 5: Slack Slash Command with Block Kit Response</a></li>\n</ul>\n<p class=\"markdown-para\">Feel free to jump to a specific part of interest using the links above or follow along sequentially. You can also checkout the <a href=\"https://github.com/danielabar/retro-pulse\" class=\"markdown-link\">source code on Github</a> for the application we'll be building.</p>\n<p class=\"markdown-para\">This post assumes the reader has at least a beginner level familiarity with Ruby on Rails. It's also assumed the reader has used <a href=\"https://slack.com/\" class=\"markdown-link\">Slack</a> as an end user with basic interactions such as joining channels, sending messages, and participating in conversations.</p>\n<p class=\"markdown-para\">Part 1 of this series introduced <a href=\"../rails-slack-app-part1-oauth#introducing-retro-pulse\" class=\"markdown-link\">Retro Pulse</a>, a Slack app built with Rails for agile teams to manage their retrospectives with Slack. <a href=\"../rails-slack-app-part2-slash-command-with-text-response\" class=\"markdown-link\">Part 2</a> explained how to implement a Slack slash command to open a retrospective and return a markdown text response to the same Slack channel that initiated the request. <a href=\"../rails-slack-app-part3-slash-command-with-modal-response\" class=\"markdown-link\">Part 3</a> covered how to implement a slash command that responds with a modal form, allowing the user to enter feedback for the retrospective.</p>\n<p class=\"markdown-para\">Now in Part 4, we will learn how to handle the modal submission, save the user's feedback in the database, and reply back with a DM to the user letting them know their input has been received. The interaction looks like this:</p>\n<p class=\"markdown-para\">In Part 3 we learned how to build this modal form in response to the <code>/retro-feedback</code> slash command:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 678px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 87.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACpklEQVR42oVU2XKbQBDkA2LJCCTuQyAOAeIWOmzJsR0ndjkPyUs+I1X5jFQ+ulMzSKqU4igPXb0ss83MbA/CSJpAHI0xFGW8G4gYXEu4Go4YxzXtEyhGGisYyT0kWYFI56UJPw+GIoQ2b/Dt8RlFs8Gnl8+42d9j9/4Rdw9PuN0/YH//hMePL3h6fkVZd9BMF4btw7A9aNYUQZxhFqVw/RiiNIYwC1KU+Yo36EBW1CjqJbKiwTwrkSxKFHWHqlnxYdVwWPQIexrAcmcwHZ8rFRwvRLKoEM4zyIrBkA48Vs1+TzV5reg2dGt6Ejuu6SO05gzdWYx6ueas/DDBdBYzz6IEXhAzUxZU4r9AGRI4Q8PxuQdxmiPN654XFZeeZCXysmXhvnd/i1FmJEYfZUEvmPMhEqAASv8c+qG8E78Bg0omQTdtkHR7JMsdnLSBNa/OUDObcXV6b8Yl7KQ+xdA7AtlIMOISedXyTTbdlvtJ6DY7NMsN2tWWQe+W6xu03RZls8JyfYv1zZ7jHC+CHhZQVAOCFeVsiabrD5N1qKfRfIE4yfn2gzhl9sM5gihFGGfMFEOXRiWbYQ5JtSCY86q/2SiFH6awvRATnXrnQjUvQznEaLbPJYtUshWXfQ+ikntz7A+xERUXYR7XcQnSEUcyhDBOsd7u0HYbFFWLJCsYluNDO9ywZjqXwcZ2e2M7fniYxQgTzTpZhaeBJuEMf1qF92imyY+O1wsezcleOjPsWziOGokZmgNd1hmm7vJfpxe8YNhz0ER4YQLH9iG3BdSvT1C+fMC4LSGJcj96HHz4HWn/EQznCyw3t4hmCYavdwh+/YD38zuuX+8gXY0gjBUd8kRj2IYFw7C4wbrpMBTNxEQzmWVFhzRWuTRieh7KEwxlBaQzGI7wG5Ov+PuSs5tbAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"slack app demo retro feedback keep\"\n        title=\"slack app demo retro feedback keep\"\n        src=\"/static/8ee5000634d8afeb7b51d0605eed0856/38cea/slack-app-demo-retro-feedback-keep.png\"\n        srcset=\"/static/8ee5000634d8afeb7b51d0605eed0856/772e8/slack-app-demo-retro-feedback-keep.png 200w,\n/static/8ee5000634d8afeb7b51d0605eed0856/e17e5/slack-app-demo-retro-feedback-keep.png 400w,\n/static/8ee5000634d8afeb7b51d0605eed0856/38cea/slack-app-demo-retro-feedback-keep.png 678w\"\n        sizes=\"(max-width: 678px) 100vw, 678px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">After submitting the form, the app responds with a direct message (DM) to the user confirming their feedback has been received:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA2klEQVR42mWPwUrEMBBA+wm6LrSxbZq0TdMm7SJIdYuy6km8iizoUf//G55MwJOHxwwzw5uZrKs0bVnT5Ap1sWMOC422GOuw3YA2HZVuKSuDKhv6IWA6jyo1VW3/kdnTJ9fHD/brO/l2Zl5feFo37rcTd9sjh5tbYowM00I3BGw/0g0TvY8UZZNQsqwyFJUhm99+mF6/yY9niocvwvpMY3uadkBbl2LvRtw443xMIsklilz6tenRgnVkardHXV6ld4UYltSQt4Qk9DM+HNKVgp+WJJWaiGXmb/4Xi35zVFKWIbAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"slack app demo retro feedback received\"\n        title=\"slack app demo retro feedback received\"\n        src=\"/static/edfb78a6e3397c39482cc80834a0362b/5a190/slack-app-demo-retro-feedback-received.png\"\n        srcset=\"/static/edfb78a6e3397c39482cc80834a0362b/772e8/slack-app-demo-retro-feedback-received.png 200w,\n/static/edfb78a6e3397c39482cc80834a0362b/e17e5/slack-app-demo-retro-feedback-received.png 400w,\n/static/edfb78a6e3397c39482cc80834a0362b/5a190/slack-app-demo-retro-feedback-received.png 800w,\n/static/edfb78a6e3397c39482cc80834a0362b/8ae78/slack-app-demo-retro-feedback-received.png 1096w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 class=\"markdown-subtitle\" id=\"comment-model\" style=\"position:relative;\"><a href=\"#comment-model\" aria-label=\"comment model permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comment Model</h2>\n<p class=\"markdown-para\">Before implementing the Slack portion of this, we need to ensure there's a place in the database to save the user's retrospective comments. In Part 2 of this series, we introduced the <a href=\"../rails-slack-app-part2-slash-command-with-text-response#implement-slash-command\" class=\"markdown-link\">Retrospective model</a>, with <code>title</code> and <code>status</code> attributes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: retrospectives</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :bigint           not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  status     :enum             default(&quot;open&quot;), not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  title      :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Indexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  index_retrospectives_on_title  (title) UNIQUE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">open:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">closed:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">To save the user's feedback, let's add a <code>Comment</code> model that <code>belongs_to</code> a <code>Retrospective</code>. It has a <code>text</code> column to store the content, some columns to store the Slack user information, and a <code>boolean</code> to indicate if this comment should be anonymous. Here is the migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateComments</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:comments</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">text</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:content</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">boolean</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:anonymous</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:slack_user_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:slack_username</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:retrospective</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">foreign_key:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">We also need to know what kind of comment this is, i.e. whether this is something the team should <em class=\"markdown-emphasis\">keep</em> on doing, <em class=\"markdown-emphasis\">stop</em> doing, or <em class=\"markdown-emphasis\">try</em> something new for next time. This can be modelled with a <a href=\"../rails-enum-mysql-postgres\" class=\"markdown-link\">Postgres enum</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddCategoryToComments</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;-SQL.squish</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">CREATE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TYPE</span><span class=\"mtk6\"> </span><span class=\"mtk5\">comment_category</span><span class=\"mtk6\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk6\"> ENUM (&#39;keep&#39;, &#39;stop&#39;, &#39;try&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_column </span><span class=\"mtk4\">:comments</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:category</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:comment_category</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;keep&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    remove_column </span><span class=\"mtk4\">:comments</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;-SQL.squish</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">DROP</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TYPE</span><span class=\"mtk6\"> comment_category;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">After running the migrations with <code>bin/rails db:migrate</code>, the resulting <code>Comment</code> model is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: comments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id               :bigint           not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  anonymous        :boolean          default(FALSE), not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  category         :enum             default(&quot;keep&quot;), not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  content          :text             not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  slack_username   :string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  slack_user_id    :string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at       :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at       :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  retrospective_id :bigint           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Indexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  index_comments_on_retrospective_id  (retrospective_id)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Foreign Keys</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  fk_rails_...  (retrospective_id =&gt; retrospectives.id)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Comment</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">category:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">keep:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;keep&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">stop:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;stop&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">try:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;try&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The retrospective model is also updated to indicate it <code>has_many</code> comments. The <code>dependent: :destroy</code> option is used to ensure that when a <code>Retrospective</code> record is deleted, all associated <code>Comment</code> records belonging to that retrospective are also deleted. This prevents orphaned records by ensuring that comments tied to a specific retrospective are removed when the retrospective is no longer needed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: retrospectives</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :bigint           not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  status     :enum             default(&quot;open&quot;), not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  title      :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Indexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  index_retrospectives_on_title  (title) UNIQUE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:comments</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIf you want to learn more about ActiveRecord dependent options and how they affect removing associated models from the database, checkout this post I wrote on <a href=\"https://danielabaron.me/blog/activerecord-dependent-options/\" class=\"markdown-link\">Activerecord Dependent Options</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"anonymous-enforcement\" style=\"position:relative;\"><a href=\"#anonymous-enforcement\" aria-label=\"anonymous enforcement permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Anonymous Enforcement</h2>\n<p class=\"markdown-para\">There's one more thing to handle in the <code>Comment</code> model. The requirements of this app are that if the user selects the Anonymous checkbox when filling out the feedback form:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 87.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACE0lEQVR42pWU247aMBCG8wLtRbtb4mNi50gSUlggUIQWtIKybXdbCamP0Zve9iV62bf9q3EAURWtyMUXTxznnxnP2N6krFGkBUycI0r6MFEKE2Wwce6gOYLswCTgMoRQxkG21BY6jKGCyL17+80T7pt7rDc7PH56xu7AdvcZD5sdPj5+wfO3PZ6+7tHMl+gxfRJkInCO8qJ2Trky8GQQQygLLjQY1xAUgQxO7wTZ7VxwGs/tdk3g/vWG0wUW6y3y9xOwIIEwGbjJ3HjOpbl/voepi9qT/TvorIZMBxBxCZFULxOfkVTgcQWZVNBV45x6PBvCt30wEiPRI8l18GTggpHF2EXpDcczzBYr1HcNuLJgtJ/aQtDedkHbtso2ypAXA8QptUeONCtdxaQy3aAgaA9DmyLNKyeSZCX6Re1G8taFkyA9fGoPEcDngbN9aoFDr13Df4JdoznnXJDwjG2PGqVOR+s4HhdcCx09F+Fw3GDczDGZfkA5GDn6ZX3y3CVtV+U8rTCspuA6BBcdUyYhfeAg6kUqx4PeIlQpmOpWDClCyHeqxW8vDY9EpLIY6ilSVYGrl9PUYQRtEmgdwc9z3KxmuF3PcdOMjlW2ToSpEJUawajM2Zf3ybgenS9XGOQ1Xi/HkL9/ovzzC69+fAejlH2m3PUjhUaPS7DjtSU0fK4u0mMS9F9Ph3gbR3gTW9xa6+b/AohZ9tP4YKEQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"slack app feedback form callout anon\"\n        title=\"slack app feedback form callout anon\"\n        src=\"/static/13f058b344e87aff38ccd58cce085047/5a190/slack-app-demo-retro-feedback-modal-callout-anon.png\"\n        srcset=\"/static/13f058b344e87aff38ccd58cce085047/772e8/slack-app-demo-retro-feedback-modal-callout-anon.png 200w,\n/static/13f058b344e87aff38ccd58cce085047/e17e5/slack-app-demo-retro-feedback-modal-callout-anon.png 400w,\n/static/13f058b344e87aff38ccd58cce085047/5a190/slack-app-demo-retro-feedback-modal-callout-anon.png 800w,\n/static/13f058b344e87aff38ccd58cce085047/c1b63/slack-app-demo-retro-feedback-modal-callout-anon.png 1200w,\n/static/13f058b344e87aff38ccd58cce085047/e4611/slack-app-demo-retro-feedback-modal-callout-anon.png 1298w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Then their Slack user id and name <em class=\"markdown-emphasis\">should not</em> be persisted in the database. Otherwise if the feedback is not anonymous (i.e. user left the Anonymous checkbox unchecked), then their Slack user id and name <em class=\"markdown-emphasis\">should</em> be persisted in the database. This will be used later when the team wants to discuss the retrospective feedback and the app displays all the feedback that has been submitted:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlElEQVR42m2S65KkIAyF5zGmF1HE9gKireK1tXbn/V/q2xKrp3eq9kfICSmSkxM+OtfxtX8xrjt+3mj7kbodyApLYRqkunOLFL9k+l87c6/86T+E1OSlC8X6ccHPz4CHacNPG3Ga8ymS74c3od74n0Yv/HECEWt0btB5hcpKEl2E+PRRkgWWkcqQ6Z1Y56HJ6c+7m1SXvQqe3c/xpnVnmFYGv9D7hc7PDMPKPB8MfmWadqb5wNY9eeEoqxadWUSUIWR2MZbqYih1hc5tYNQ0PUVVBwZGPigih44MTbxSyxkjRioxYsREHS008YaLl7eG5xHrIiwgrxylbcmNozCO0jQhLu2Vq05sWqzrgzd1F/SXyf3nyPeyZjv+MK0HfnkybwfzejBtO+vxO+T8suHXjXF9BuunhXk/cN3wU8ObSEhzG75KVbd03Ujz8Jimw1mPtR2u9dhiQElDpmp0YkljQ5pYlCqvYlH63nKUFqjs2rCtH6T3CpFoKtFQRg1aVJSy55HsQa86noN2j3gnkw2fUfL9ff4CUuYF8npS44wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"slack app demo keep comments callout anon\"\n        title=\"slack app demo keep comments callout anon\"\n        src=\"/static/ca5f591018c4b3df9c52bd4004685e05/5a190/slack-app-demo-keep-comments-callout-anon.png\"\n        srcset=\"/static/ca5f591018c4b3df9c52bd4004685e05/772e8/slack-app-demo-keep-comments-callout-anon.png 200w,\n/static/ca5f591018c4b3df9c52bd4004685e05/e17e5/slack-app-demo-keep-comments-callout-anon.png 400w,\n/static/ca5f591018c4b3df9c52bd4004685e05/5a190/slack-app-demo-keep-comments-callout-anon.png 800w,\n/static/ca5f591018c4b3df9c52bd4004685e05/72aae/slack-app-demo-keep-comments-callout-anon.png 964w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">To enforce this rule, a combination of <code>presence</code> and <code>absence</code> options can be passed to the ActiveRecord <code>validates</code> macro, together with conditional options:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Comment</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:slack_user_id</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">absence:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">message:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;must be empty when anonymous is true&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">if:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:anonymous</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:slack_username</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">absence:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">message:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;must be empty when anonymous is true&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">if:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:anonymous</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:slack_user_id</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">message:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;must be provided when anonymous is false&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">unless:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:anonymous</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:slack_username</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">message:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;must be provided when anonymous is false&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">unless:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:anonymous</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">However, the above validation rules will only be performed at the application level. Someone with direct database access would still be able to insert invalid data. To ensure data integrity at the database level, a <a href=\"https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-CHECK-CONSTRAINTS\" class=\"markdown-link\">CHECK CONSTRAINT</a> can be added to the table using the Rails migration method <code>add_check_constraint</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddCheckConstraintForSlackInfoInComments</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># If a comment is anonymous, then the slack info fields should be null.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># If a comment is not anonymous, then the slack info fields should be populated.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">add_check_constraint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">:comments</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;(anonymous AND slack_user_id IS NULL AND slack_username IS NULL)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      OR</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      (NOT anonymous AND slack_user_id IS NOT NULL AND slack_username IS NOT NULL)&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;check_slack_info_if_not_anonymous&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nAre you interested in learning more about maintaining data correctness and consistency when working with Rails and PostgreSQL? The book <a class=\"markdown-link\"\nhref=\"https://pragprog.com/titles/aapsql/high-performance-postgresql-for-rails/\">High Performance PostgreSQL for Rails</a> is a comprehensive guide to optimizing your PostgreSQL database for use with Rails. From indexing and partitioning to advanced query optimization and database maintenance.\n</aside>\n<p class=\"markdown-para\">Now that the <code>Comment</code> model is implemented, we can move on to handling the Slack form submission.</p>\n<h2 class=\"markdown-subtitle\" id=\"configure-slack-interactivity\" style=\"position:relative;\"><a href=\"#configure-slack-interactivity\" aria-label=\"configure slack interactivity permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configure Slack Interactivity</h2>\n<p class=\"markdown-para\">When the user clicks the Submit button on the modal form we generated, Slack will send an <a href=\"https://api.slack.com/messaging/interactivity\" class=\"markdown-link\">interaction payload</a> to the <code>request_url</code> that is configured as part of the Interactivity Settings of the app. We haven't configured this yet so let's go ahead and do that now.</p>\n<p class=\"markdown-para\">Navigate to <a href=\"https://api.slack.com/apps/\" class=\"markdown-link\">Your Apps</a> in Slack, select the \"Retro Pulse\" application, then select \"Interactivity &#x26; Shortcuts\" from the Features section:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 255px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAArCAYAAAB4pah1AAAACXBIWXMAAAsTAAALEwEAmpwYAAAFgklEQVR42p1W225bRRT1P/AFPCKQQPDSP+AFeOAjeOOFi6jUVyTgCdGgtmmaNipJCgolQYWkkKZJnIvjSxLbx5fj4+O7jx0nju3E9+tCa5xxbNdOKiJtz2TOmXXW7L323mOq1+qoVWvg2PvrXE77n3McZ/K5iT/tVhuJhIHZ2XnMzDzG/JNf8fffK1hdXcP5eQmVag3lcnWsVSpVAUgTgI16A2hUoXlc0BQnEiEN+5ZtKA7rBd3rrN1jaiJqtVLDbzs67q0Fcf8lTcODDR1T60FMrHjw07KCn1c8uL2s4PaKgokL49qPf7kxZ9bQkEdu1RvIFkp47+YibtxaxPvf/I43P3+Cd75awLtfL+DtLxfwwc0/cOPWEt76YgGmTydh+ugOTB/fhemTuzB9OIE3PptDs35xZP5UKjXMrKuCyf01FRP/+HBnVcXdC7u36u+yW1bww59OfLd0iO+XDsX826cHmHrhu2TIn2ajCdTKSOgqAooTQY8TyZCGaMCLmOZD/sh4NfwDf51epE1yUiyWkU5nkDTSiCcMYYaRFnZycorSRURLI4zrA7JhlAv5AvSgjlg0hpAeQjwWh+pXoQU0nByfiHf6NTfOeoClYkkA0giSOcogHArD7XIjmUj+P8Cj9JFgc5w5RspI9Zi1mq2xmTESkEHJ5/JwOV1wHjrhURQc7B/AsmtB7jQnAAksbRzYQFAq5YrwY/+LBOMaR37wrHAmrFqpXs+Qm7bMW7BZbdhY3xDsPIoHDrsD1j0rtre2xTPO6Q7uGQkov8QXWCQ4J4NhFnJt2I9jg1I8LyJ7khUvct4PMGrjWEBu6rQ7Qnf3JyextLiI2V9mhc3NziEei4mgjGI31ofyAaVDqZxmT4VPOS+XylcyGhtlqUNGkUenEZjro6r2tcImECNJ/SluBfuOfRFhZky/sF+bIUd5PClg+o1r1Ohw1K+MssyUne0dOGx2HB4cCr25nS6xtrG+LnJcfuSqNOzpsFbpHp1s+lnSh9KP1Ck/LguF2FsZ7nqVGtqdNvKFPOw2+0B2MLfp192dXZE5XOec0Zdib7abaDQuP2BqtJrIxXI4eOSA7ZEVew8ssM/YsDu1A8vUDvYfO2B5sAvr9B72pi2wTlvgmnNCfeqH8sQN17wTxdNiD9TUQgvuORdSwRTcXje8Xi8CgQDc7st5JBKBoijCvD4vtKAmlJA9yyLjycC35EUHHVTL1S6gf8kHfSOImC+GsDOEkFMXFnVHEHKGEPNEEfPEoB8GodpVscYxHUoj+FxDaF1Hm725wr5cr6NWqsLzTMHziRVsPTRjZ2ZbmHl6U9j2QzNeTq7BPm9D5N8wgssaQs91BJ6piJjDA/ndFTbP36pBDarQQhqOTo4QN+LQIzrCsTACekCspzIptNFBs9MUxtOR2YBs5KRcLCMZT+Isf4ZUMoVMOoPSeQnZ4ywKubx4LiJbrnal0m/DlyXZ9ew2m2gBlAeLKR0fUANC3JQUs4Y6fK0WQE3J8k4hU+AcuUYgKfDzs/OBCjQM3Es9MjRvmrvpZ3cIpiwQZMqCQaGTJZ/7vN6rAfuPwOPLfsFRdjyZcsNHHgnITUynPcueYMXmTlZkw/TjfHNjUzCkX68qugM+pH/oO/YUVh8WWG7m/3QJfci5LCBjj8yjEIyFgfcZv88vzOf19cbuBcADI2mMbaGvNHq2AN5jyIyMyNJIJgVINByBEYsid3J5caqPO7JkqAUCYjNvXwFVRVALCksbBnLlBpyJAqLZ0pW9ZeCyxGCofr9gyWOySlPYRjyBo3wJVv0YeubsekB5ZIpYOl72EtlreIdGq4l2XzEd60MpmxerL3opx8pMGVHklI1QwlAPufJuw5HAjKC0/itcF6CO2oCoX2X4H6PFePBg3PXwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"slack-app-interactivity-feature\"\n        title=\"slack-app-interactivity-feature\"\n        src=\"/static/8815d1d53226bef481926fa5d4c427aa/b8c8f/slack-app-interactivity-feature.png\"\n        srcset=\"/static/8815d1d53226bef481926fa5d4c427aa/772e8/slack-app-interactivity-feature.png 200w,\n/static/8815d1d53226bef481926fa5d4c427aa/b8c8f/slack-app-interactivity-feature.png 255w\"\n        sizes=\"(max-width: 255px) 100vw, 255px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Enable the interactivity toggle:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 764px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABFklEQVR42pWRW3LCMAxF2f/GugKcF6EQ8yrEgSaOLcspt2MBLZ32p/JoZFnSkUaenbszqrLCsl6iyAuURYnV6wqZysTWixqX8wUcGIECbGdhzQCODPL0Q1N8lpLzPBfYoloIvFk3UEqhLAp5N8YIkIjgrMOpOsKsDEIIYGZEjhJL0FmMEVdcQYHgyUvgL7nez0Po3UO/aAyXAb3tMU3THcgRpjNQmcJczVFWJfqhF7j3HqMbpZnz7sumd4oEpgDvHNr29A1MI9vRYn/Y43g64vB2wG6/g95orJu16Ha3hdZacpK/2W7Q6AZtb9FTlLmnjzswLTLtQiYgunUP9OuebMpL+vB9YLhUzyy7FODzD/1fb3XPv/wJJRkYM0WW1q0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"slack app interactivity toggle\"\n        title=\"slack app interactivity toggle\"\n        src=\"/static/8246855fdd61331dfb67c9e32a3dd908/f3c12/slack-app-interactivity-toggle.png\"\n        srcset=\"/static/8246855fdd61331dfb67c9e32a3dd908/772e8/slack-app-interactivity-toggle.png 200w,\n/static/8246855fdd61331dfb67c9e32a3dd908/e17e5/slack-app-interactivity-toggle.png 400w,\n/static/8246855fdd61331dfb67c9e32a3dd908/f3c12/slack-app-interactivity-toggle.png 764w\"\n        sizes=\"(max-width: 764px) 100vw, 764px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Fill in your ngrok forwarding address in the Request URL field, and then <code>/api/slack/action</code>. This is the URL that Slack will POST a message to when the user submits the feedback modal. <a href=\"../rails-slack-app-part1-oauth#ngrok\" class=\"markdown-link\">Ngrok was setup</a> in Part 1 of this series.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 727px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABj0lEQVR42o2SbXKbMBCGuf8hcoReoX8zaTINdkwct3GQZD5EjMApICRhvRkttutpZzqFeebdXcGutKvo4f4BySrB4/dHLOIF1s/ri716WuFl/YJRjzDakF4TYlpr6EFf/Gi73UJwgTRNSRljCLHA2/aN4pRgPPGHjckDR8CMc8HIw6PrO4xmRD/0+N/HnzQuGG75Bu44wRiDqGkbxIsYyXOC5dMSspLQo8aghwvBD8XOGmJzcY8vqzvc3H+FnRxsSBgWS1mieq8gpUSWZxBCgHMGxhnEToALTuR5Ti3Ish2tV6qFdfN2PY507KjvOxRlQQnD0a2zhLGGOPtucjPO0k4J6/AReurmrJQw3yt8WyaI1xtsUgFR1RByD1a+gxUVuJw1LaqTv0fdDVCdJm16Ddl2qH8NmKxFpLoBr1lJH7+KHD95RhoIBX6wHenZDuT7BkXdIq+bGXVA22u4kHAcNWpVoz20xOHjAKUUaZi8MeGKaNKzra8GFobjJvv7yKEv9KM1f6n/53t9hTyOfh7KJ2cN+UYDzHzdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"slack app interactivity enter url\"\n        title=\"slack app interactivity enter url\"\n        src=\"/static/79d4da9a6e444a22b68322055bb86f09/c54b3/slack-app-interactivity-enter-url.png\"\n        srcset=\"/static/79d4da9a6e444a22b68322055bb86f09/772e8/slack-app-interactivity-enter-url.png 200w,\n/static/79d4da9a6e444a22b68322055bb86f09/e17e5/slack-app-interactivity-enter-url.png 400w,\n/static/79d4da9a6e444a22b68322055bb86f09/c54b3/slack-app-interactivity-enter-url.png 727w\"\n        sizes=\"(max-width: 727px) 100vw, 727px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">As soon as you enter a valid URL, it will be saved automatically.</p>\n<h2 class=\"markdown-subtitle\" id=\"receive-form-submission-in-rails\" style=\"position:relative;\"><a href=\"#receive-form-submission-in-rails\" aria-label=\"receive form submission in rails permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Receive Form Submission in Rails</h2>\n<p class=\"markdown-para\">Now that the Slack app has been configured to POST the form submission to the Rails app (via Ngrok), we need to write a handler to receive this payload. In Part 2 of this series, we learned how to use the <a href=\"https://github.com/slack-ruby/slack-ruby-bot-server-events\" class=\"markdown-link\">slack-ruby-bot-server-events</a> gem to setup a command handler to <a href=\"../rails-slack-app-part2-slash-command-with-text-response#receive-slash-command-in-rails\" class=\"markdown-link\">receive a slash command</a>. Now we'll do something similar, but for receiving the form submission. The <code>slack-ruby-bot-server-events</code> gem calls these <a href=\"https://github.com/slack-ruby/slack-ruby-bot-server-events?tab=readme-ov-file#actions\" class=\"markdown-link\">Actions</a>.</p>\n<p class=\"markdown-para\">Starting from the root of the project, create the following directory and files:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># The `bot` directory was created in Part 2 of this series</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">touch bot/actions.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">mkdir bot/actions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">touch bot/actions/view_submission.rb</span></span></span></code></pre>\n<p class=\"markdown-para\">You should have a directory structure that looks like this. Note that the <code>bot</code> directory is a sibling to the Rails <code>app</code> directory, and the <code>slash_commands</code> were created in Parts 2 and 3 of this series:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── bot</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── actions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    │   └── view_submission.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── actions.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── slash_commands</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    │   ├── retro_feedback.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    │   └── retro_open.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── slash_commands.rb</span></span></code></pre>\n<p class=\"markdown-para\">Add the following in <code>bot/actions.rb</code> to load all the actions, there's only one for now:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># bot/actions.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require_relative</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;actions/view_submission&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Fill in the implementation for the <code>view_submission</code> action handler. For now, it will only log out the payload it received:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># bot/actions/view_submission.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">SlackRubyBotServer</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Events</span><span class=\"mtk1\">.</span><span class=\"mtk5\">configure</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Essentially this is saying to the SlackRubyBotServer,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># If a &quot;view_submission&quot; interaction is received from Slack,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># then execute this block.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.</span><span class=\"mtk5\">on</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:action</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;view_submission&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |action|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> action[</span><span class=\"mtk4\">:payload</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    action.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;=== ACTION: payload = </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Return `nil`, otherwise the slack-ruby-bot-server-events gem</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># replies to the channel with a message &quot;true&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Update <code>config.ru</code> file in the root of the Rails app to load the action handlers in the <code>bot</code> directory. This will ensure the the Slack bot code is loaded when Rails starts:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This file is used by Rack-based servers to start the application.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require_relative</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;config/environment&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This line was added in Part 2 of this series</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require_relative</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bot/slash_commands&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === NEW: Load Slack action handlers ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require_relative</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bot/actions&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># We added this line previously in Part 1 of this series:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">SlackRubyBotServer</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">App</span><span class=\"mtk1\">.</span><span class=\"mtk5\">instance</span><span class=\"mtk1\">.</span><span class=\"mtk5\">prepare!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">run </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">load_server</span></span></span></code></pre>\n<p class=\"markdown-para\">To see the action handler working, restart the Rails server <code>bin/dev</code>. Then in any Slack workspace that has the Retro Pulse app installed, enter the <code>/retro-feedback</code> slash command to launch the feedback modal. Fill it in by selecting any Category, enter some test text in the Comment, and check off the Anonymous option:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 85.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACCklEQVR42o1T7Y7SQBTlCYxxt1/T6bSdQimltAU2KMZoZJcFXZON0Vcw+wC+gv995KNnoKUSwP1xeuerZ+45907vleVgqAfQoYavIvhBCM8P4MsQfrCbcyz3e64IOpDmrJAKQoa4thz0Xl45+H7/gLu3H/B+tcZm+4Dtpy+4337G7XqDj6u1GT9+/Ybbuw3CuG9+9oPYxDhJMRwV6Kcj2I5Ajx8ZphAqQaBiBKGGihIT5X7egHOSnAIvsBwPPdsVKKsp3izfIUkzOB5lKLhCmdhAtBacBi8zGZI1GWSYVFMU5RSjcYm8KDGpZsiLCkVZY5RP2p+OwXVmH+nBQTIJ6UOajc1Y94fGk13MzNopsi5IuiN0hclsdrMwpKzeTvIhEue9O0i2upIplRkyjic1chMrM+aFtIEWcJ/2ZPkEZT03VSYxC8nkTIac0IMueJCSm6iT1Iy5xznbh5FSqcRIbgibRd7Urexz0EhvCdnt1H984FxVz1WaKl1P7ghHeWH8YKvQI/rDKl/qu2O0VXa8ALPlCtP5AoNh3vrEG89V9h8EEQTfu9q/FMfzodPCkPCRH8u+CBlBCmUQyOjQ2A3Rc6S13gUx/EjDyTPY4wxeNjw0dmPs/8Cs2S71zQLVuMJVXcD59YT+75948eMR15aLnmV7bbuIS+ioIKlSGm6sYb+u4S7nsOsC1l/CP0HK1vVtR8OpAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"slack app modal test\"\n        title=\"slack app modal test\"\n        src=\"/static/ea5c6484b421dd5666a22ee22a598e39/5a190/slack-app-modal-test.png\"\n        srcset=\"/static/ea5c6484b421dd5666a22ee22a598e39/772e8/slack-app-modal-test.png 200w,\n/static/ea5c6484b421dd5666a22ee22a598e39/e17e5/slack-app-modal-test.png 400w,\n/static/ea5c6484b421dd5666a22ee22a598e39/5a190/slack-app-modal-test.png 800w,\n/static/ea5c6484b421dd5666a22ee22a598e39/c1b63/slack-app-modal-test.png 1200w,\n/static/ea5c6484b421dd5666a22ee22a598e39/47218/slack-app-modal-test.png 1344w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Then click the Submit button in Slack, and watch the Rails server output. It will show something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Started POST &quot;/api/slack/action&quot; for 34.201.19.177 at 2024-02-06 07:10:16 -0500</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">INFO -- : === ACTION: payload = {&quot;type&quot;=&gt;&quot;view_submission&quot;, &quot;team&quot;=&gt;{&quot;id&quot;=&gt;&quot;your-team-id&quot;, ...}</span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">What's going on:</strong></p>\n<p class=\"markdown-para\">The above output from the Rails server shows that a POST to <code>/api/slack/action</code> is being processed. Recall when we configured Slack interactivity earlier, we told Slack to post payloads to this url. Slack is actually posting to the ngrok url, which forwards to the Rails server running on <code>localhost:3000</code>.</p>\n<p class=\"markdown-para\">To view the \"raw\" request sent by Slack, open a browser at <code>http://127.0.0.1:4040</code>. This is the web interface exposed by ngrok which shows all HTTP requests and responses that were received by ngrok and responded to by the Rails app. For example, the form we just submitted was posted to ngrok as a url-encoded form with the following HTTP headers and body:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">POST /api/slack/action HTTP/1.1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Host: 05f9-70-51-246-153.ngrok-free.app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">User-Agent: Slackbot 1.0 (+https://api.slack.com/robots)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Content-Length: 4137</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Accept: application/json,*/*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Accept-Encoding: gzip,deflate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Content-Type: application/x-www-form-urlencoded</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">X-Forwarded-For: 32.423.15.766</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">X-Forwarded-Host: 12e4-203-0-113-42.ngrok-free.app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">X-Forwarded-Proto: https</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">X-Slack-Request-Timestamp: 1707220000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">X-Slack-Signature: v0=88a...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">payload=%7B%22type%22%3A%22view_submission%...</span></span></code></pre>\n<p class=\"markdown-para\">The <code>POST /api/slack/action</code> is handled by the routing provided by the <a href=\"https://github.com/slack-ruby/slack-ruby-bot-server-events\" class=\"markdown-link\">slack-ruby-bot-server-events</a> gem, which takes care of a lot of the boilerplate including providing a controller to parse the raw url-encoded form body, and logic to verify the <code>X-Slack-Signature</code> HTTP header.</p>\n<p class=\"markdown-para\">Then the <code>slack-ruby-bot-server-events</code> gem's controller for <code>/api/slack/action</code> parses out the specific action name, which it finds in the <code>type</code> section of the payload. From this example, the type is <code>view_submission</code>. The gem will then run all <a href=\"https://github.com/slack-ruby/slack-ruby-bot-server-events?tab=readme-ov-file#implement-callbacks\" class=\"markdown-link\">callbacks that are registered for that action</a>.</p>\n<p class=\"markdown-para\">Since we added <code>config.on :action, \"view_submission\"</code> in <code>view_submission.rb</code>, this is how the <code>slack-ruby-bot-server-events</code> gem knows it should run our custom logic. The raw url-encoded form data received from Slack has been converted into a hash that's available as <code>action[:payload]</code>.</p>\n<h2 class=\"markdown-subtitle\" id=\"saving-feedback\" style=\"position:relative;\"><a href=\"#saving-feedback\" aria-label=\"saving feedback permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Saving Feedback</h2>\n<p class=\"markdown-para\">Now that the communication between Slack and Rails is working to receive the form submission, the next step is to parse out the contents of the payload to save the user's retrospective feedback.</p>\n<p class=\"markdown-para\">The payload contains all the field names and corresponding values submitted by the user for the <a href=\"../rails-slack-app-part3-slash-command-with-modal-response#respond-with-retro-feedback-modal\" class=\"markdown-link\">custom modal we built in Part 3</a>, along with additional information such as the Slack team, user, trigger ID, and API application ID. Here is a condensed version of the payload for the test we submitted earlier:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span><span class=\"mtk6\">&quot;type&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;view_submission&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;team&quot;</span><span class=\"mtk1\">=&gt;{</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;T0-your-team-id&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;domain&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;your-slack-domain&quot;</span><span class=\"mtk1\">},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">=&gt;{</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;U0-your-slack-user-id&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;username&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;your.slack.user.name&quot;</span><span class=\"mtk1\">},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;api_app_id&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;A0-your-slack-app-id&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;token&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;za...&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trigger_id&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;659...&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;view&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk6\">&quot;type&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;modal&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk6\">&quot;callback_id&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;feedback_form&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk6\">&quot;blocks&quot;</span><span class=\"mtk1\">=&gt;[... ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk6\">&quot;state&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      {</span><span class=\"mtk6\">&quot;category_block&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span><span class=\"mtk6\">&quot;category_select&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span><span class=\"mtk6\">&quot;type&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;static_select&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           </span><span class=\"mtk6\">&quot;selected_option&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            {</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\">=&gt;{</span><span class=\"mtk6\">&quot;type&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;plain_text&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;Something we should keep doing&quot;</span><span class=\"mtk1\">},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk6\">&quot;value&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;keep&quot;</span><span class=\"mtk1\">}}},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       </span><span class=\"mtk6\">&quot;comment_block&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span><span class=\"mtk6\">&quot;comment_input&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span><span class=\"mtk6\">&quot;type&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;plain_text_input&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;value&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;This is a test of the modal submission action handler in Rails&quot;</span><span class=\"mtk1\">}},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       </span><span class=\"mtk6\">&quot;anonymous_block&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span><span class=\"mtk6\">&quot;anonymous_checkbox&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span><span class=\"mtk6\">&quot;type&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;checkboxes&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           </span><span class=\"mtk6\">&quot;selected_options&quot;</span><span class=\"mtk1\">=&gt;[{</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\">=&gt;{</span><span class=\"mtk6\">&quot;type&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;plain_text&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;Yes&quot;</span><span class=\"mtk1\">}, </span><span class=\"mtk6\">&quot;value&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;true&quot;</span><span class=\"mtk1\">}]}}}},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The payload indicates that it is of type <code>view_submission</code> and contains some information about the Slack <code>team</code> and <code>user</code>.</p>\n<p class=\"markdown-para\">The <code>view</code> section contains a <code>blocks</code> section, which is a repetition of the blocks we defined earlier in Part 3 when creating the form, which follows the <a href=\"https://api.slack.com/block-kit/building\" class=\"markdown-link\">Slack Block Kit</a> format. We can disregard this section.</p>\n<p class=\"markdown-para\">The <code>view</code> section also contains a <code>state</code> section. Here is where we find the actual values the user filled in the modal form. For example, the category option the user selected is available in <code>payload[\"view\"][\"state\"][\"values\"][\"category_block\"][\"category_select\"][\"selected_option\"][\"value\"]</code>.</p>\n<p class=\"markdown-para\">The attributes of the payload need to be parsed out for instantiating and saving a <code>Comment</code> model in the Rails app. I find it helpful to create a mapping table before writing the code, to be confident that all the data is available:</p>\n<table class=\"markdown-table\">\n<thead>\n<tr>\n<th>Comment Model</th>\n<th>Slack Payload Attribute</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>category</td>\n<td>[\"view\"][\"state\"][\"values\"][\"category_block\"][\"category_select\"][\"selected_option\"][\"value\"]</td>\n</tr>\n<tr>\n<td>content</td>\n<td>[\"view\"][\"state\"][\"values\"][\"comment_block\"][\"comment_input\"][\"value\"]</td>\n</tr>\n<tr>\n<td>slack_user_id</td>\n<td>[\"user\"][\"id\"]</td>\n</tr>\n<tr>\n<td>slack_username</td>\n<td>[\"user\"][\"username\"]</td>\n</tr>\n<tr>\n<td>anonymous</td>\n<td>[\"view\"][\"state\"][\"values\"][\"anonymous_block\"][\"anonymous_checkbox\"][\"selected_options\"].present?</td>\n</tr>\n</tbody>\n</table>\n<p class=\"markdown-para\">To determine whether the user checked off the Anonymous option in the form, we have to check whether the <code>selected_options</code> of the checkbox portion of the payload exist. If yes, it means the user checked this option, otherwise, there will be no <code>selected_options</code> at all.</p>\n<p class=\"markdown-para\">Now that we know how to parse the Slack payload to extract what's needed to build a Comment model, we can come back to the <code>view_submission</code> action handler, and implement the logic to create a new Comment:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># bot/actions/view_submission.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">SlackRubyBotServer</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Events</span><span class=\"mtk1\">.</span><span class=\"mtk5\">configure</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.</span><span class=\"mtk5\">on</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:action</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;view_submission&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |action|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> action[</span><span class=\"mtk4\">:payload</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    action.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;=== ACTION: payload = </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    anonymous </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;view&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;state&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;anonymous_block&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;anonymous_checkbox&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;selected_options&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># This comment will be associated with the one and only open Retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Comment</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">retrospective:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">content:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;view&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;state&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;comment_block&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;comment_input&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;value&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">anonymous:</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">category:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;view&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;state&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;category_block&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;category_select&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;selected_option&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;value&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">slack_user_id:</span><span class=\"mtk1\"> anonymous </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\"> </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">slack_username:</span><span class=\"mtk1\"> anonymous </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\"> </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;username&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Return `nil`, otherwise the slack-ruby-bot-server-events gem</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># replies to the channel with a message &quot;true&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">To make a better user experience, the app should reply with a DM (direct message) to the user that submitted the feedback, confirming their feedback has been saved. The <a href=\"https://api.slack.com/methods/chat.postMessage\" class=\"markdown-link\">postMessage API</a> provided by Slack can be used for this. This was used in Part 2 of this series to send a message to the channel that a <a href=\"../rails-slack-app-part2-slash-command-with-text-response#implement-slash-command\" class=\"markdown-link\">retrospective was opened</a>. This time, instead of replying to the channel, the app should reply only to the user. This is accomplished by specifying the Slack user id as the <code>channel</code> argument.</p>\n<p class=\"markdown-para\">Here is the modified view_submission handler, with a DM back to the user:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">SlackRubyBotServer</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Events</span><span class=\"mtk1\">.</span><span class=\"mtk5\">configure</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.</span><span class=\"mtk5\">on</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:action</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;view_submission&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |action|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> action[</span><span class=\"mtk4\">:payload</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    action.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;=== ACTION: payload = </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    anonymous </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;view&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;state&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;anonymous_block&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;anonymous_checkbox&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;selected_options&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Comment</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">retrospective:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">content:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;view&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;state&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;comment_block&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;comment_input&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;value&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">anonymous:</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">category:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;view&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;state&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;category_block&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;category_select&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;selected_option&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;value&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">slack_user_id:</span><span class=\"mtk1\"> anonymous </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\"> </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">slack_username:</span><span class=\"mtk1\"> anonymous </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\"> </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;username&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Instantiate a slack_client for this team</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    team_id </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;team&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    team </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Team</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">team_id:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    slack_client </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Slack</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Web</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Client</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">token:</span><span class=\"mtk1\"> team.</span><span class=\"mtk5\">token</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Send DM to user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    slack_client.</span><span class=\"mtk5\">chat_postMessage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">channel:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Thank you, your feedback has been saved.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Return `nil`, otherwise the slack-ruby-bot-server-events gem</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># replies to the channel with a message &quot;true&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">After restarting the Rails server <code>bin/dev</code>, and submitting the form again from Slack <code>/retro-feedback</code>, you should see the following in the Rails server output, indicating that a new Comment has been saved with the payload values. I've added some annotations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== Log the action payload</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">INFO -- : === ACTION: payload = {&quot;type&quot;=&gt;&quot;view_submission&quot;, &quot;team&quot;=&gt;{&quot;id&quot;=&gt;&quot;T0...}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== Find the open retrospective to associate the new Comment with:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Retrospective Load (1.6ms)  SELECT &quot;retrospectives&quot;.*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            FROM &quot;retrospectives&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            WHERE &quot;retrospectives&quot;.&quot;status&quot; = $1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            ORDER BY &quot;retrospectives&quot;.&quot;id&quot; ASC LIMIT $2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            [[&quot;status&quot;, &quot;open&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">== Insert a new Comment record in the database</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">== Since Anonymous checkbox was selected, slack info fields are nil</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TRANSACTION (1.8ms)  BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Comment Create (5.6ms)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    INSERT INTO &quot;comments&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (&quot;content&quot;, &quot;anonymous&quot;, &quot;retrospective_id&quot;, &quot;created_at&quot;, &quot;updated_at&quot;, &quot;category&quot;, &quot;slack_user_id&quot;, &quot;slack_username&quot;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    VALUES ($1, $2, $3, $4, $5, $6, $7, $8)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    RETURNING &quot;id&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      [&quot;content&quot;, &quot;This is a test of the modal submission action handler in Rails&quot;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      [&quot;anonymous&quot;, true],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      [&quot;retrospective_id&quot;, 31],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      [&quot;created_at&quot;, &quot;2024-02-09 12:53:38.577358&quot;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      [&quot;updated_at&quot;, &quot;2024-02-09 12:53:38.577358&quot;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      [&quot;category&quot;, &quot;keep&quot;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      [&quot;slack_user_id&quot;, nil],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      [&quot;slack_username&quot;, nil]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TRANSACTION (2.1ms)  COMMIT</span></span></code></pre>\n<p class=\"markdown-para\">And in your Slack workspace, you should see a DM from the Retro Pulse app.</p>\n<h2 class=\"markdown-subtitle\" id=\"refactor\" style=\"position:relative;\"><a href=\"#refactor\" aria-label=\"refactor permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Refactor</h2>\n<p class=\"markdown-para\">While the current solution works, there are some problems with it:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">It's getting too long.</li>\n<li class=\"markdown-list-item\">There's no error handling. For example, the Comment may fail to be saved due to validation rules.</li>\n<li class=\"markdown-list-item\">Having all the business logic directly in the action handler makes it impossible to test.</li>\n<li class=\"markdown-list-item\">Having all the form parsing together with the business logic makes the code hard to read.</li>\n</ol>\n<p class=\"markdown-para\">These problems can be solved in the same way as was done in <a href=\"../rails-slack-app-part2-slash-command-with-text-response#openretrospective-interactor\" class=\"markdown-link\">Part2</a> of this series, by introducing an interactor named <code>SaveRetrospectiveFeedback</code>. To keep the interactor clean, we'll also introduce a <code>SlackFormParser</code> module for extracting the information needed from the Slack view_submission form.</p>\n<p class=\"markdown-para\">Here is the <code>SlackFormParser</code> module</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># lib/slack_form_parser.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SlackFormParser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">module_function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">parse_user_info</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">user_id:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">slack_user_id:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">slack_username:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;username&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">parse_feedback_info</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    view_state </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;view&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;state&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">category:</span><span class=\"mtk1\"> view_state[</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;category_block&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;category_select&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;selected_option&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;value&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">comment:</span><span class=\"mtk1\"> view_state[</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;comment_block&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;comment_input&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;value&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">anonymous:</span><span class=\"mtk1\"> view_state[</span><span class=\"mtk6\">&quot;values&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;anonymous_block&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;anonymous_checkbox&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;selected_options&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the <code>SaveRetrospectiveFeedback</code> interactor:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">It's provided the form <code>payload</code> and <code>slack_client</code> via <code>context</code>.</li>\n<li class=\"markdown-list-item\">It includes the <code>SlackFormParser</code> for extracting the attributes for the Comment model.</li>\n<li class=\"markdown-list-item\">It then attempts to create and save a new Comment from the parsed form information.</li>\n<li class=\"markdown-list-item\">If it succeeds, it DMs the user a success message, including the feedback category.</li>\n<li class=\"markdown-list-item\">Otherwise, it DMs the user a failure message, with the reason the Comment could not be saved.</li>\n<li class=\"markdown-list-item\">Finally if anything unexpected happens, it fails the context and logs the error.</li>\n</ul>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SaveRetrospectiveFeedback</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> Interactor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActionView</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Helpers</span><span class=\"mtk1\">::SanitizeHelper</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> SlackFormParser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parse_payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    save_comment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    send_feedback_confirmation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">log_error</span><span class=\"mtk1\">(e)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    context.</span><span class=\"mtk5\">fail!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">parse_payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @user_info </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">parse_user_info</span><span class=\"mtk1\">(context.</span><span class=\"mtk5\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @feedback_info </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">parse_feedback_info</span><span class=\"mtk1\">(context.</span><span class=\"mtk5\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">save_comment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retrospective </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    comment </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Comment</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">content:</span><span class=\"mtk1\"> @feedback_info[</span><span class=\"mtk4\">:comment</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">anonymous:</span><span class=\"mtk1\"> @feedback_info[</span><span class=\"mtk4\">:anonymous</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">category:</span><span class=\"mtk1\"> @feedback_info[</span><span class=\"mtk4\">:category</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">retrospective:</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">**</span><span class=\"mtk1\">slack_fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @save_message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> comment.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      </span><span class=\"mtk6\">&quot;Thank you, your `</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">@feedback_info[</span><span class=\"mtk4\">:category</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">` feedback has been submitted.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                   </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      </span><span class=\"mtk6\">&quot;Could not save your `</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">@feedback_info[</span><span class=\"mtk4\">:category</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">` feedback: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">comment.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                   </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">slack_fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @feedback_info[</span><span class=\"mtk4\">:anonymous</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      { </span><span class=\"mtk4\">slack_user_id:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">, </span><span class=\"mtk4\">slack_username:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      { </span><span class=\"mtk4\">slack_user_id:</span><span class=\"mtk1\"> @user_info[</span><span class=\"mtk4\">:slack_user_id</span><span class=\"mtk1\">], </span><span class=\"mtk4\">slack_username:</span><span class=\"mtk1\"> @user_info[</span><span class=\"mtk4\">:slack_username</span><span class=\"mtk1\">] }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">send_feedback_confirmation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    context.</span><span class=\"mtk5\">slack_client</span><span class=\"mtk1\">.</span><span class=\"mtk5\">chat_postMessage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">channel:</span><span class=\"mtk1\"> @user_info[</span><span class=\"mtk4\">:user_id</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> @save_message</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">log_error</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">error</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    error_message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Error in SaveRetrospectiveFeedback: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">error.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    backtrace </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> error.</span><span class=\"mtk5\">backtrace</span><span class=\"mtk1\">.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">error_message</span><span class=\"mtk7\">}</span><span class=\"mtk4\">\\n</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">backtrace</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The view_submission action handler can be simplified because most of the logic has moved to the interactor:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># bot/actions/view_submission.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">SlackRubyBotServer</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Events</span><span class=\"mtk1\">.</span><span class=\"mtk5\">configure</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.</span><span class=\"mtk5\">on</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:action</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;view_submission&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |action|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> action[</span><span class=\"mtk4\">:payload</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    team_id </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;team&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    team </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Team</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">team_id:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    slack_client </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Slack</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Web</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Client</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">token:</span><span class=\"mtk1\"> team.</span><span class=\"mtk5\">token</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># If app is receiving multiple different form submissions, check callback_id and handle accordingly</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    callback_id </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;view&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;callback_id&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    action.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;=== ACTION: Team: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">team.</span><span class=\"mtk5\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, callback_id: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">callback_id</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">SaveRetrospectiveFeedback</span><span class=\"mtk1\">.</span><span class=\"mtk5\">call</span><span class=\"mtk1\">(</span><span class=\"mtk4\">payload:</span><span class=\"mtk1\">, </span><span class=\"mtk4\">slack_client:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">About callback_id:</strong> The <code>callback_id</code> attribute in the payload was initially populated in Part 3 of this series when we <a href=\"../rails-slack-app-part3-slash-command-with-modal-response#respond-with-example-modal\" class=\"markdown-link\">specified the modal payload</a>. It's value was set to <code>feedback_form</code> as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">modal_payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trigger_id:</span><span class=\"mtk1\"> trigger_id,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">view:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;modal&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">callback_id:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;feedback_form&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Populating a <code>callback_id</code> is useful for an application that generates many different types of forms, in which case, it would set a unique <code>callback_id</code> per form. Slack will send all form submissions to the same URL, which we configured earlier in the <a href=\"../rails-slack-app-part4-action-modal-submission#configure-slack-interactivity\" class=\"markdown-link\">interactivity</a> section. Then the application would need the ability to distinguish which kind of form is being submitted, and delegate to an appropriate handler. In this case, Retro Pulse is a simple app with only one form so strictly speaking, <code>callback_id</code> isn't necessary, but it doesn't hurt to have it, then the app is ready for adding more forms in the future.</p>\n<h2 class=\"markdown-subtitle\" id=\"next-steps\" style=\"position:relative;\"><a href=\"#next-steps\" aria-label=\"next steps permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Next Steps</h2>\n<p class=\"markdown-para\">In this part of the series on building a Slack app with Rails, we've learned how to receive a form submission from Slack, parse it to extract the data the user filled in, save it to the database, and reply with a DM to the Slack user confirming their feedback was saved. At this point, we almost have a complete application working. Read on to the last part in this series, where we'll <a href=\"../rails-slack-app-part5-slash-block-kit-response\" class=\"markdown-link\">build a block kit response to a slash command</a>, to support the team in discussing all the retrospective feedback that has been submitted.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":16,"tableOfContents":"<ul>\n<li><a href=\"#comment-model\">Comment Model</a></li>\n<li><a href=\"#anonymous-enforcement\">Anonymous Enforcement</a></li>\n<li><a href=\"#configure-slack-interactivity\">Configure Slack Interactivity</a></li>\n<li><a href=\"#receive-form-submission-in-rails\">Receive Form Submission in Rails</a></li>\n<li><a href=\"#saving-feedback\">Saving Feedback</a></li>\n<li><a href=\"#refactor\">Refactor</a></li>\n<li><a href=\"#next-steps\">Next Steps</a></li>\n</ul>","frontmatter":{"title":"Build a Rails App with Slack Part 4: Receive Modal Submission","date":"04 Jul 2024","description":"Learn how to build a Slack application with Rails in this comprehensive multi-part series. Part 4 covers handling a modal submission action, saving the feedback to the database, and replying to the user with a private DM confirming their submission.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#787878","images":{"fallback":{"src":"/static/85525ec1dedb223c100a08a35c4775cb/205f5/slack-feat-img-4-david-trinks-vHTWOMrQs7k-unsplash.jpg","srcSet":"/static/85525ec1dedb223c100a08a35c4775cb/481f7/slack-feat-img-4-david-trinks-vHTWOMrQs7k-unsplash.jpg 225w,\n/static/85525ec1dedb223c100a08a35c4775cb/9caad/slack-feat-img-4-david-trinks-vHTWOMrQs7k-unsplash.jpg 450w,\n/static/85525ec1dedb223c100a08a35c4775cb/205f5/slack-feat-img-4-david-trinks-vHTWOMrQs7k-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/85525ec1dedb223c100a08a35c4775cb/5e6dd/slack-feat-img-4-david-trinks-vHTWOMrQs7k-unsplash.webp 225w,\n/static/85525ec1dedb223c100a08a35c4775cb/1c6ef/slack-feat-img-4-david-trinks-vHTWOMrQs7k-unsplash.webp 450w,\n/static/85525ec1dedb223c100a08a35c4775cb/c77c0/slack-feat-img-4-david-trinks-vHTWOMrQs7k-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":610}}}},"fields":{"slug":"/blog/rails-slack-app-part4-action-modal-submission/"}},"relatedP":{"edges":[{"node":{"id":"31e8cce4-5682-5c17-8f35-c677650c8622","frontmatter":{"title":"Capybara Webdriver Element not Clickable Resolved","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#c8c8c8","images":{"fallback":{"src":"/static/eca525b5ea56e9b81eb24b1a855a3cad/26528/capybara-jackson-simmer-Vqg809B-SrE-unsplash.jpg","srcSet":"/static/eca525b5ea56e9b81eb24b1a855a3cad/26528/capybara-jackson-simmer-Vqg809B-SrE-unsplash.jpg 300w,\n/static/eca525b5ea56e9b81eb24b1a855a3cad/43429/capybara-jackson-simmer-Vqg809B-SrE-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/eca525b5ea56e9b81eb24b1a855a3cad/5d6c3/capybara-jackson-simmer-Vqg809B-SrE-unsplash.webp 300w,\n/static/eca525b5ea56e9b81eb24b1a855a3cad/68dbc/capybara-jackson-simmer-Vqg809B-SrE-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/capybara-selenium-webdriver-element-not-clickable/"}}},{"node":{"id":"489497a9-2600-5b48-aa26-a2ea8b93b5d0","frontmatter":{"title":"Add Rubocop to an Existing Rails Project","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#181828","images":{"fallback":{"src":"/static/454ad22c79b1d6dca07caa36d2c057f3/26528/rubocop-mark-duffel-U5y077qrMdI-unsplash.jpg","srcSet":"/static/454ad22c79b1d6dca07caa36d2c057f3/26528/rubocop-mark-duffel-U5y077qrMdI-unsplash.jpg 300w,\n/static/454ad22c79b1d6dca07caa36d2c057f3/43429/rubocop-mark-duffel-U5y077qrMdI-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/454ad22c79b1d6dca07caa36d2c057f3/5d6c3/rubocop-mark-duffel-U5y077qrMdI-unsplash.webp 300w,\n/static/454ad22c79b1d6dca07caa36d2c057f3/68dbc/rubocop-mark-duffel-U5y077qrMdI-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/add-rubocop-to-legacy-project/"}}},{"node":{"id":"d84ac79f-d860-544a-8abb-63add1da9214","frontmatter":{"title":"Understanding ActiveRecord Dependent Options","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#282828","images":{"fallback":{"src":"/static/b7f7064c193fa4dc20f20d253e1928fa/26528/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg","srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/26528/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 300w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/43429/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/5d6c3/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 300w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/68dbc/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/activerecord-dependent-options/"}}}]}},"pageContext":{"slug":"/blog/rails-slack-app-part4-action-modal-submission/","relatedPosts":["Capybara Webdriver Element not Clickable Resolved","Understanding ActiveRecord Dependent Options","Add Rubocop to an Existing Rails Project"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}