{"componentChunkName":"component---src-templates-post-js","path":"/blog/model-audit-paper-trail/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">Model auditing plays an important role in tracking changes within a Rails application. While several gems are available to implement this functionality, today we'll take a closer look at <a href=\"https://github.com/paper-trail-gem/paper_trail\" class=\"markdown-link\">PaperTrail</a>. By default, PaperTrail consolidates all model audit records into a single <code>versions</code> table, which could lead to performance and scaling challenges when dealing with numerous audited models. Conceptually, it looks like this:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 631px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABdklEQVR42n1TXW+DMAzM//8tm/ba/7C9VZpK91C6qrBB+SwhQICbzjQorbZZCpDz+WwnRjVNg2EY0Pe9LK01xnEErW1bWfRba2GMQdd14iOnrmvBp2laY5UjFUUhgBOnEadgnue4Xq+yd4KMc1z6aSxOEaiqCqfTCZfLRUguiD4KHQ4HRNFZxF0yJuc3RcIwlIrJVXzM8yxLstyIrmUnvlRsBKMNg4XW7epj2zwCqZDll2WJNE0xWisE6jOrMR2ySwrTNui6XgJvuWGHAUmSSodMzO4UPCvzALvgCfHX64qNtsD+4wXH44a7BZx7fB43CIJnaJ35ElB+u+NQoCm3KLK9tLQEd/iO31Dl72uQMRp1sUNTbTGN5tbRoqOcmHs743nEcQw7TgjDM7K8lqMhxtZ88zXUIzDP07pPkkQuwhkvhIkW7nTHdW/1VyZ/DqMoEnEOsavur87uBP2zcBVxClgV5879LY+8fwUfK/T/Hu3N6G9iFPwBQMGpTbCE3AoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"paper trail same version\"\n        title=\"paper trail same version\"\n        src=\"/static/9fd4795b7e43381e8576e09aa6ad1a5d/4597d/papertrail-same-version.png\"\n        srcset=\"/static/9fd4795b7e43381e8576e09aa6ad1a5d/772e8/papertrail-same-version.png 200w,\n/static/9fd4795b7e43381e8576e09aa6ad1a5d/e17e5/papertrail-same-version.png 400w,\n/static/9fd4795b7e43381e8576e09aa6ad1a5d/4597d/papertrail-same-version.png 631w\"\n        sizes=\"(max-width: 631px) 100vw, 631px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Fortunately, there's a better approach. This post will walk through the steps to configure PaperTrail to create separate <code>{model}_versions</code> tables for each model, such as <code>product_versions</code>, <code>order_versions</code>, <code>customer_versions</code>, etc. This optimization can improve performance and organization in your application's auditing process. Conceptually, it will look like this:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 625px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABzElEQVR42mVTXYvbMBDU//8lfehboU+FvoVSUmhJQkNM7dC7OLnGjm3ZsmNb9pRZ3ZpcK5BY7cfs7mhl2rYFd13XqKoKwzCAa55n0Xddt2z6TNMk9r7vxZ/6+/0uNuccDB289wJAmSBc4ziiaRqRNYkGcyn4Yzx1hkccx0iSRJwVkCAETNMU2+0Wp9NJbP8C0h5FkRRAm0Fo8L+qmJUtBFvYBGSrXJTpo4vg0rJzLaztUJYNKL/l0KEfJjTNHV03CIhyqMnLspbYtg08Gz86XNIveH76innuFzCtuq1jJPFn1PYI7SbY6efxcv6Bp98rDH0lOuOHAsfkA37FHzGNNjQ3MyhUYotv2P18hyL//goy8UDIOSB9/oQoeo/WnQOgVOEaNLZa+NAKhBvvcX1J3+geZdfUsGW+3A37vt1uyPKbcKAckiu+JHk6Xy7CEUlXDulHTrM8x5/rdZkAw4NB3I9jo6/Me1WVkox3fWXKBFUf78MjmSzLsF6vsd/vxUHnjIC8Hw4HrFYrHI/H5efokNO+2Wyw2+3En3ZD5fW1ZC6dQx0L6kkJW338KayMIEVRgEVRL2PDAK3MWrsEKIfKlf515VD9aScNTM7B/gsBte9eUC3lTQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"paper trail different version\"\n        title=\"paper trail different version\"\n        src=\"/static/dab0159463de1f80883b3538e08d7882/80d71/papertrail-different-version.png\"\n        srcset=\"/static/dab0159463de1f80883b3538e08d7882/772e8/papertrail-different-version.png 200w,\n/static/dab0159463de1f80883b3538e08d7882/e17e5/papertrail-different-version.png 400w,\n/static/dab0159463de1f80883b3538e08d7882/80d71/papertrail-different-version.png 625w\"\n        sizes=\"(max-width: 625px) 100vw, 625px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 class=\"markdown-subtitle\" id=\"project-setup\" style=\"position:relative;\"><a href=\"#project-setup\" aria-label=\"project setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Project Setup</h2>\n<p class=\"markdown-para\">We'll start with a simple project that has a single <code>Products</code> model to demonstrate how to audit changes to products specifically, but the process will apply to any number of models in a real application. Assume this is a back office application for maintaining an e-commerce system. This project uses a Postgres database, which supports the json column type and is useful for representing model changes. We'll also add the <a href=\"https://github.com/heartcombo/devise\" class=\"markdown-link\">devise</a> gem so we can have different users log in and make changes to products.</p>\n<p class=\"markdown-para\">I'm using Ruby 3.2 and Rails 7.0.6 but you can check the <a href=\"https://github.com/paper-trail-gem/paper_trail#1a-compatibility\" class=\"markdown-link\">PaperTrail Compatibility</a> for older versions support. You can also check out the complete <a href=\"https://github.com/danielabar/audit_demo\" class=\"markdown-link\">project on Github</a>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a new Rails project using a Postgres database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails new audit_demo -d postgresql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> audit_demo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Initialize an empty database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Generate product model, database migration, controller, views, and routes,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails g scaffold Product name:string code:string price:decimal inventory:integer description:text</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create the `products` table</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:migrate</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nFor a real application, you would add constraints to the migration that creates the product table and corresponding validations in the Product model such as code and name are required, inventory and price must be greater than 0, etc. But for this demo, we'll leave it out so we can quickly focus on model auditing.\n</aside>\n<p class=\"markdown-para\">Add <a href=\"https://github.com/heartcombo/devise\" class=\"markdown-link\">devise</a> to the Gemfile so we can have user logins, to later demonstrate how PaperTrail can keep track of <em class=\"markdown-emphasis\">who</em> made a change. While you're here, also add the <a href=\"https://github.com/faker-ruby/faker\" class=\"markdown-link\">faker</a> gem to the development and test sections, we'll use this later to generate sample data:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Gemfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># User authentication</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem </span><span class=\"mtk6\">&quot;devise&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">group </span><span class=\"mtk4\">:development</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:test</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Generate realistic looking data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  gem </span><span class=\"mtk6\">&quot;faker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Run <code>bundle install</code> to add these new gems to the project.</p>\n<p class=\"markdown-para\">Run the Devise generators:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Installs config/initializer for devise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate devise:install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Generate user model, migration, modules, and routes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># for user registration and session management.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate devise User</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Migrate database so we now have a `users` table</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:migrate</span></span></span></code></pre>\n<p class=\"markdown-para\">Update the routes file to set the products listing view as the root route:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">routes</span><span class=\"mtk1\">.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># CRUD for products (generated from earlier scaffold command).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  resources </span><span class=\"mtk4\">:products</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Added by devise generator to expose login and registration routes.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  devise_for </span><span class=\"mtk4\">:users</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Set the default route: Devise needs to know where to redirect</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># users after successful login.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  root </span><span class=\"mtk6\">&quot;products#index&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nInterested in learning more about the Rails router? Checkout this awesome <a class=\"markdown-link\" href=\"https://www.akshaykhot.com/understanding-rails-router-why-what-how/\">post</a> that will demystify a lot of the syntax and concepts.\n</aside>\n<p class=\"markdown-para\">To ensure there's always a logged in user that's accessing the product views, specify the <code>authenticate_user!</code> method in the product controller's <code>before_action</code> callback (this is a helper method provided by devise):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/products_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductsController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_action </span><span class=\"mtk4\">:authenticate_user!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThis post is using the simplest possible configuration of Devise so we can quickly demo how PaperTrail will use it to record who made a change. There's a lot more complexity to integrating Devise into a real application for production. See the <a class=\"markdown-link\" href=\"https://github.com/heartcombo/devise/wiki\">docs</a> for more details.\n</aside>\n<p class=\"markdown-para\">Now let's seed the database with a few users and products. I'm using the <a href=\"https://github.com/faker-ruby/faker\" class=\"markdown-link\">faker</a> gem to quickly generate some realistic looking product data. To keep the <code>db/seeds.rb</code> file clean, I've split up the user and product seeds into separate files. For a small project like this, they could go all in the same file, but it quickly gets messy as the project grows, so I like to get in the habit of splitting up the seeds files right from the start:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/seeds.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">development?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">load</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">root</span><span class=\"mtk1\">.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;db/seeds/users.rb&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">load</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">root</span><span class=\"mtk1\">.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;db/seeds/products.rb&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Seeding completed!&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Seeding skipped. Not in development environment.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/seeds/users.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">User</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;test1@example.com&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">password:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Password1&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">User</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;test2@example.com&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">password:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Password1&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/seeds/products.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">20</span><span class=\"mtk1\">.</span><span class=\"mtk5\">times</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Commerce</span><span class=\"mtk1\">.</span><span class=\"mtk5\">product_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Alphanumeric</span><span class=\"mtk1\">.</span><span class=\"mtk5\">alpha</span><span class=\"mtk1\">(</span><span class=\"mtk4\">number:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">).</span><span class=\"mtk5\">upcase</span><span class=\"mtk7\">}#{</span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Number</span><span class=\"mtk1\">.</span><span class=\"mtk5\">number</span><span class=\"mtk1\">(</span><span class=\"mtk4\">digits:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">price:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Commerce</span><span class=\"mtk1\">.</span><span class=\"mtk5\">price</span><span class=\"mtk1\">(</span><span class=\"mtk4\">range:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk7\">..</span><span class=\"mtk4\">100.0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rand</span><span class=\"mtk1\">(</span><span class=\"mtk4\">0</span><span class=\"mtk7\">..</span><span class=\"mtk4\">50</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">description:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Lorem</span><span class=\"mtk1\">.</span><span class=\"mtk5\">sentence</span><span class=\"mtk1\">(</span><span class=\"mtk4\">word_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span><span class=\"mtk1\">, </span><span class=\"mtk4\">random_words_to_add:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Finally load the seeds into the database, I'm using the <code>replant</code> task which first truncates all the model tables. This makes it fast to re-run any time you want to reseed the database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:seed:replant</span></span></span></code></pre>\n<p class=\"markdown-para\">At this point, you should be able to start a Rails server with <code>bin/rails s</code>, navigate to <a href=\"http://localhost:3000\" class=\"markdown-link\">http://localhost:3000</a>, get redirected to <a href=\"http://localhost:3000/users/sign_in\" class=\"markdown-link\">http://localhost:3000/users/sign_in</a>, login as one of the example users from the seeds such as <code>test1@example.com/Password1</code>. You'll then be redirected to the product listing view which shows all products. You can click \"Show product\" on any product, then click \"Edit\" and make any changes.</p>\n<aside class=\"markdown-aside\">\nYou may have noticed we quickly got a working application up and running without writing a whole lot of code. The heavy lifting was done by the scaffold generator. This post goes more in depth on <a class=\"markdown-link\" href=\"https://www.rubyguides.com/2020/03/rails-scaffolding/\">scaffolding</a>, and there's some mention of it in the <a class=\"markdown-link\" href=\"https://guides.rubyonrails.org/command_line.html#bin-rails-generate\">Rails Command Line</a> guide.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"add-papertrail\" style=\"position:relative;\"><a href=\"#add-papertrail\" aria-label=\"add papertrail permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Add PaperTrail</h2>\n<p class=\"markdown-para\">Now that we have a functioning project with authenticated users that can edit products, it's time to add model auditing. To start, add PaperTrail to the Gemfile, then run <code>bundle install</code> to install it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Gemfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Model auditing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem </span><span class=\"mtk6\">&quot;paper_trail&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Next run the PaperTrail generator to generate the database migrations to add an audit table. I'm using the <code>--with-changes</code> column to ensure the model diffs will be persisted:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rails generate paper_trail:install --with-changes</span></span></span></code></pre>\n<p class=\"markdown-para\">This generates two migration files as shown below - do NOT run these yet, we're going to be making a number of changes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20230806120211_create_versions.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateVersions</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  TEXT_BYTES </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1_073_741_823</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:versions</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\">   </span><span class=\"mtk4\">:item_type</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">bigint</span><span class=\"mtk1\">   </span><span class=\"mtk4\">:item_id</span><span class=\"mtk1\">,   </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\">   </span><span class=\"mtk4\">:event</span><span class=\"mtk1\">,     </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\">   </span><span class=\"mtk4\">:whodunnit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">text</span><span class=\"mtk1\">     </span><span class=\"mtk4\">:object</span><span class=\"mtk1\">, </span><span class=\"mtk4\">limit:</span><span class=\"mtk1\"> TEXT_BYTES</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">datetime</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:created_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_index </span><span class=\"mtk4\">:versions</span><span class=\"mtk1\">, </span><span class=\"mtk4\">%i[item_type item_id]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20230806120212_add_object_changes_to_versions.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddObjectChangesToVersions</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  TEXT_BYTES </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1_073_741_823</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_column </span><span class=\"mtk4\">:versions</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:object_changes</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:text</span><span class=\"mtk1\">, </span><span class=\"mtk4\">limit:</span><span class=\"mtk1\"> TEXT_BYTES</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The PaperTrail instructions then say to update any model classes that require auditing with the <code>has_paper_trail</code> macro. This will populate the <code>versions</code> table with a change record any time a model is updated (also persists model creation and deletion). For example, the <code>Product</code> model would get updated as follows. Again, do NOT make these changes, we'll be doing things differently:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Product</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Don&#39;t add this - we&#39;ll do it differently soon</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_paper_trail</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SomeOtherWidget</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_paper_trail</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># etc. for all model classes that need to be audited</span></span></span></code></pre>\n<p class=\"markdown-para\">The above migrations and code change show that the default PaperTrail behavior is to generate a single <code>versions</code> table that will store <em class=\"markdown-emphasis\">all</em> model audit records. Now let's go through the changes required to have a <code>product_versions</code> table specifically for persisting changes to the <code>Product</code> model.</p>\n<h2 class=\"markdown-subtitle\" id=\"migration-changes\" style=\"position:relative;\"><a href=\"#migration-changes\" aria-label=\"migration changes permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Migration Changes</h2>\n<p class=\"markdown-para\">Make the following changes to the migration file:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Change the file name from <code>db/migrate/{timestamp}_create_versions.rb</code> to <code>db/migrate{timestamp}_create_product_versions.rb</code>.</li>\n<li class=\"markdown-list-item\">Modify the migration class name from <code>CreateVersions</code> to <code>CreateProductVersions</code>.</li>\n<li class=\"markdown-list-item\">Modify the table and index names from <code>versions</code> to <code>product_versions</code>.</li>\n<li class=\"markdown-list-item\">Add the <code>object_changes</code> column from the <code>..._add_object_changes_to_versions.rb</code> migration to <code>..._create_product_versions.rb</code> and delete the second generated migration (there's no need to maintain a second migration file just to add the column).</li>\n<li class=\"markdown-list-item\">Change the <code>object</code> and <code>object_changes</code> columns to be of type <code>json</code> (or <code>jsonb</code> if using Postgres) rather than <code>text</code>.</li>\n<li class=\"markdown-list-item\">Remove the <code>TEXT_BYTES</code> constant as we're using json rather than text columns.</li>\n</ul>\n<p class=\"markdown-para\">Here is the resulting migration file after making the above changes. I've added comments explaining what each column will store:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20230806120211_create_product_versions.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateProductVersions</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:product_versions</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Stores the model name, for model-specific version tables,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># will always be the same value per table, eg: &quot;Product&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\">   </span><span class=\"mtk4\">:item_type</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># The primary key of the model record being audited,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># for this case, will be a value from products.id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">bigint</span><span class=\"mtk1\">   </span><span class=\"mtk4\">:item_id</span><span class=\"mtk1\">,   </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># The type of change happening to this model, eg:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># create, update, delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\">   </span><span class=\"mtk4\">:event</span><span class=\"mtk1\">,     </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Optionally record who made the change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\">   </span><span class=\"mtk4\">:whodunnit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># JSON representation of the model BEFORE the change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">json</span><span class=\"mtk1\">     </span><span class=\"mtk4\">:object</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># JSON representation of the changes made to the model attributes.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Stores information about the attribute, its old value, and new value.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">json</span><span class=\"mtk1\">     </span><span class=\"mtk4\">:object_changes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Timestamp when the audit record was created</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">datetime</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:created_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Create compound index for efficient querying</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_index </span><span class=\"mtk4\">:product_versions</span><span class=\"mtk1\">, </span><span class=\"mtk4\">%i[item_type item_id]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nOpting for json or jsonb data types for the object and object_changes columns will  expand the capabilities of the PaperTrail <a class=\"markdown-link\" href=\"https://github.com/paper-trail-gem/paper_trail#3e-queries\">query API</a> in comparison to using text columns. Not sure whether to use json or jsonb? Checkout the Postgres docs on <a class=\"markdown-link\" href=\"https://www.postgresql.org/docs/current/datatype-json.html\">JSON Types</a> to learn the difference.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"model-changes\" style=\"position:relative;\"><a href=\"#model-changes\" aria-label=\"model changes permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Model Changes</h2>\n<p class=\"markdown-para\">By default, PaperTrail assumes all model changes are being persisted in a single <code>versions</code> table. We've updated the migration to create a product-specific versions table <code>product_versions</code>, but there are some code changes to be made as well to configure PaperTrail for <a href=\"https://github.com/paper-trail-gem/paper_trail#6a-custom-version-classes\" class=\"markdown-link\">custom version classes</a>.</p>\n<p class=\"markdown-para\">The first change is to specify the <code>versions</code> option on the <code>has_paper_trail</code> macro for the <code>Product</code> model, to indicate the class that represents the product versions (this class doesn't exist yet, we'll get to that next):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Product</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_paper_trail </span><span class=\"mtk4\">versions:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">class_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ProductVersion&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now add a new model class <code>ProductVersion</code> that inherits from <a href=\"https://github.com/paper-trail-gem/paper_trail/blob/master/lib/paper_trail/frameworks/active_record/models/paper_trail/version.rb\" class=\"markdown-link\">PaperTrail::Version</a> and specify the table name from the modified migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product_version.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductVersion</span><span class=\"mtk5 mtki mtku\"> &lt; PaperTrail::Version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">self</span><span class=\"mtk1\">.</span><span class=\"mtk5\">table_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:product_versions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Finally, since all the audited models will be persisted in custom versions tables and the default <code>versions</code> table will not exist in this app, we need to tell PaperTrail that the base <code>ApplicationVersion</code> class is abstract by specifying <code>self.abstract_class = true</code>. This is used in ActiveRecord models to indicate that a particular class should not be considered as a concrete table in the database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/application_version.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ApplicationVersion</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PaperTrail</span><span class=\"mtk1\">::VersionConcern</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">self</span><span class=\"mtk1\">.</span><span class=\"mtk5\">abstract_class</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"whodunnit\" style=\"position:relative;\"><a href=\"#whodunnit\" aria-label=\"whodunnit permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Whodunnit</h2>\n<p class=\"markdown-para\">PaperTrail can optionally populate a <code>whodunnit</code> column in the <code>{model}_versions</code> table to record the logged in user that made the change. If the controller has a <code>current_user</code> method available, a controller callback can be specified that will automatically populate <code>whodunnit</code> with <code>current_user.id</code>. Since this project is using devise, there is a <a href=\"https://github.com/heartcombo/devise#controller-filters-and-helpers\" class=\"markdown-link\">current_user</a> helper method available on the controller, so we can specify the callback on the base controller as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/application_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ApplicationController</span><span class=\"mtk5 mtki mtku\"> &lt; ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_action </span><span class=\"mtk4\">:set_paper_trail_whodunnit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">One final small change to make is if you want the user's email address (or some other attribute) populated in the <code>whodunnit</code> column instead of the user's <code>id</code>, you can define the <code>user_for_paper_trail</code> method in the base controller. Then PaperTrail will use whatever is returned from this method to populate <code>whodunnit</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/application_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ApplicationController</span><span class=\"mtk5 mtki mtku\"> &lt; ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_action </span><span class=\"mtk4\">:set_paper_trail_whodunnit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Use devise gem&#39;s controller helper methods to return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># the logged in user&#39;s email address, or Anonymous if</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># there is no logged in user.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The value returned from this method will be saved in</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># the {model}_versions.whodunnit column.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">user_for_paper_trail</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    user_signed_in? </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> current_user.</span><span class=\"mtk5\">email</span><span class=\"mtk1\"> </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Anonymous&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"demo\" style=\"position:relative;\"><a href=\"#demo\" aria-label=\"demo permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Demo</h2>\n<p class=\"markdown-para\">Now we're ready to try this out and see the product-specific audit table populated:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Start the Rails server with <code>bin/rails s</code></li>\n<li class=\"markdown-list-item\">Navigate to <a href=\"http://localhost:3000/\" class=\"markdown-link\">http://localhost:3000/</a>.</li>\n<li class=\"markdown-list-item\">When presented with the login prompt, enter <code>test1@example.com/Password1</code> (from <code>db/seeds/users.rb</code>).</li>\n<li class=\"markdown-list-item\">From the products listing page, click the <code>Show</code> link for any product.</li>\n<li class=\"markdown-list-item\">From the product view page, click <code>Edit</code>.</li>\n<li class=\"markdown-list-item\">Make a few edits to the product and click the Update button.</li>\n</ul>\n<p class=\"markdown-para\">For example, I've selected a product with code <code>SPNS6254</code>, and made some edits to increase the price (inflation!), decrease the inventory count, and make a small text change to the description:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABnElEQVR42nWSiW7jMAxE8///VmzRJMjpHD7qpL7i+JIsya+gFjHQPQgQlsjheDjQwhjD4XBgv9+TJInP0+lEXddITNM0p4Tg4zgmCALu9ztZlhFFEXme+/7CWsvxePSE8pWmnB+Px38Jpb9ardhsNn5muVxyuVx+E2qtCcOQ5/PpVcnAK15E7kUKWOf8FoJtmgal1A/8Qgrr9dqD2ral73ucc7OiP0M22m63XpFsIUKk9vq5V7jb7TzZOI7InWnCuolOW5JSEXz15I0ma0baQXM+nyiKYsaLgFmhFMRgMXUmBJRxZI1mf+t4D5/E5UBUKupOE4UhRVl6vGz4F+H1eiVNU6qq8r5YYxiN4zmYmTAqB87ZQNNr4igkSWL6vvMWie/eogkWcvlMPwmjkLzIcZPDOYtxE1VnqHtDoyytMuTNyKAtvz62vL1vCK4pnffc4tnwhJY0yUmjjK9bxaNoqcvO57/CuYlTkLLdXDmfb3Stpm8VXaOwxrIQqeNoGbWkQSuDGka0Gn+8wfkJOccgJI2koi5b6qqjKlo//w3TcwBLpExrDAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"paper trail edit product\"\n        title=\"paper trail edit product\"\n        src=\"/static/ee99a9d15ba828e0b057f3514547edc4/5a190/papertrail-edit-product.png\"\n        srcset=\"/static/ee99a9d15ba828e0b057f3514547edc4/772e8/papertrail-edit-product.png 200w,\n/static/ee99a9d15ba828e0b057f3514547edc4/e17e5/papertrail-edit-product.png 400w,\n/static/ee99a9d15ba828e0b057f3514547edc4/5a190/papertrail-edit-product.png 800w,\n/static/ee99a9d15ba828e0b057f3514547edc4/63ec5/papertrail-edit-product.png 812w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Now launch a Rails console with <code>bin/rails c</code> to see what PaperTrail has saved for this update. Notice the versions for the product are returned as an array of <code>ProductVersion</code> model instances, which is the custom version class we created earlier:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Find the product we just edited</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;SPNS6254&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Our edits have been saved to the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product:0x0000000111013df0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">id:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">103</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Small Aluminum Bag&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;SPNS6254&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">price:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0.2276e2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">description:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Deleniti quia aut edited.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">created_at:</span><span class=\"mtk1\"> Mon, </span><span class=\"mtk4\">07</span><span class=\"mtk1\"> Aug </span><span class=\"mtk4\">2023</span><span class=\"mtk1\"> </span><span class=\"mtk4\">13</span><span class=\"mtk1\">:</span><span class=\"mtk4\">35</span><span class=\"mtk1\">:</span><span class=\"mtk4\">45.442271000</span><span class=\"mtk1\"> UTC </span><span class=\"mtk7\">+</span><span class=\"mtk4\">00</span><span class=\"mtk1\">:</span><span class=\"mtk4\">00</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">updated_at:</span><span class=\"mtk1\"> Sat, </span><span class=\"mtk4\">12</span><span class=\"mtk1\"> Aug </span><span class=\"mtk4\">2023</span><span class=\"mtk1\"> </span><span class=\"mtk4\">13</span><span class=\"mtk1\">:</span><span class=\"mtk4\">14</span><span class=\"mtk1\">:</span><span class=\"mtk4\">18.913169000</span><span class=\"mtk1\"> UTC </span><span class=\"mtk7\">+</span><span class=\"mtk4\">00</span><span class=\"mtk1\">:</span><span class=\"mtk4\">00</span><span class=\"mtk7\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># PaperTrail adds the `versions` method to audited models</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product.</span><span class=\"mtk5\">versions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># It returns an array of records from `product_versions` table</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># `whodunnit` shows email address of logged in user that made the change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># `object` column persists how the product looked BEFORE the change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># `object_changes` shows every value we updated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#&lt;ProductVersion:0x000000010d5f2180</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">id:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">80</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">item_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Product&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">item_id:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">103</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">event:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;update&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">whodunnit:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;test1@example.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">object:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;name&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;Small Aluminum Bag&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;code&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;SPNS6254&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;price&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;21.68&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;inventory&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk4\">14</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;Deleniti quia aut.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk4\">103</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;created_at&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;2023-08-07T13:35:45.442Z&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;updated_at&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;2023-08-07T13:35:45.442Z&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">object_changes:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;price&quot;</span><span class=\"mtk1\">=&gt;[</span><span class=\"mtk6\">&quot;21.68&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;22.76&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;inventory&quot;</span><span class=\"mtk1\">=&gt;[</span><span class=\"mtk4\">14</span><span class=\"mtk1\">, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\">=&gt;[</span><span class=\"mtk6\">&quot;Deleniti quia aut.&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;Deleniti quia aut edited.&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;updated_at&quot;</span><span class=\"mtk1\">=&gt;[</span><span class=\"mtk6\">&quot;2023-08-07T13:35:45.442Z&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;2023-08-12T13:14:18.913Z&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">created_at:</span><span class=\"mtk1\"> Sat, </span><span class=\"mtk4\">12</span><span class=\"mtk1\"> Aug </span><span class=\"mtk4\">2023</span><span class=\"mtk1\"> </span><span class=\"mtk4\">13</span><span class=\"mtk1\">:</span><span class=\"mtk4\">14</span><span class=\"mtk1\">:</span><span class=\"mtk4\">18.913169000</span><span class=\"mtk1\"> UTC </span><span class=\"mtk7\">+</span><span class=\"mtk4\">00</span><span class=\"mtk1\">:</span><span class=\"mtk4\">00</span><span class=\"mtk7\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span></code></pre>\n<p class=\"markdown-para\">We can also connect directly to the database to verify the data is persisted in the <code>product_versions</code> table. Use the <a href=\"https://guides.rubyonrails.org/command_line.html#bin-rails-dbconsole\" class=\"markdown-link\">bin/rails dbconsole</a> command to launch a psql session. Then query the <code>product_versions</code> table for <code>item_id</code> of <code>103</code> (which is the primary key of the product record we edited earlier):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">audit_demo</span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">select</span><span class=\"mtk1\"> whodunnit, object_changes </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> product_versions </span><span class=\"mtk7\">where</span><span class=\"mtk1\"> item_id </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">103</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     whodunnit     |object_changes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> test1@example.com | {</span><span class=\"mtk6\">&quot;price&quot;</span><span class=\"mtk1\">:[&quot;21.68&quot;,&quot;22.76&quot;],</span><span class=\"mtk6\">&quot;inventory&quot;</span><span class=\"mtk1\">:[14,10],</span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\">:[&quot;Deleniti quia aut.&quot;,&quot;Deleniti quia aut edited.&quot;],</span><span class=\"mtk6\">&quot;updated_at&quot;</span><span class=\"mtk1\">:[&quot;2023-08-07T13:35:45.442Z&quot;,&quot;2023-08-12T13:14:18.913Z&quot;]}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk4\">1</span><span class=\"mtk1\"> </span><span class=\"mtk7\">row</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">As shown from both the Rails and database consoles, PaperTrail has successfully recorded the update to this product record in the <code>product_versions</code> table.</p>\n<h2 class=\"markdown-subtitle\" id=\"other-models\" style=\"position:relative;\"><a href=\"#other-models\" aria-label=\"other models permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other Models</h2>\n<p class=\"markdown-para\">A real application will have multiple models that need to be audited. For example, an e-commerce application could have orders, addresses, payments, etc. To get model-specific audit tables populated for these, the steps are:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Run the paper trail generator command: <code>bundle exec rails generate paper_trail:install --with-changes</code>.</li>\n<li class=\"markdown-list-item\">Repeat the steps in the <a href=\"../model-audit-paper-trail#migration-changes\" class=\"markdown-link\">Migration Changes</a> section of this post.</li>\n<li class=\"markdown-list-item\">Repeat the steps in the <a href=\"../model-audit-paper-trail/#model-changes\" class=\"markdown-link\">Model Changes</a> section of this post.</li>\n<li class=\"markdown-list-item\">Run <code>bin/rails db:migrate</code> to create the new <code>{model}_versions</code> table.</li>\n</ol>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has provided a step-by-step guide to optimizing model auditing within a Rails application using the PaperTrail gem. By configuring separate, model-specific audit tables, you've gained insights into efficiently tracking changes while avoiding potential performance issues tied to a centralized audit structure. There's a lot more you can do with PaperTrail such as limiting what events get audited and reverting to previous versions. Checkout the <a href=\"https://github.com/paper-trail-gem/paper_trail\" class=\"markdown-link\">docs</a> for more details.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":11,"tableOfContents":"<ul>\n<li><a href=\"#project-setup\">Project Setup</a></li>\n<li><a href=\"#add-papertrail\">Add PaperTrail</a></li>\n<li><a href=\"#migration-changes\">Migration Changes</a></li>\n<li><a href=\"#model-changes\">Model Changes</a></li>\n<li><a href=\"#whodunnit\">Whodunnit</a></li>\n<li><a href=\"#demo\">Demo</a></li>\n<li><a href=\"#other-models\">Other Models</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>","frontmatter":{"title":"Optimized Model Auditing with PaperTrail","date":"01 Apr 2024","description":"Learn how to optimize model auditing in your Rails application using the PaperTrail gem by setting up separate audit tables for each model, enhancing performance and organization in the auditing process","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#383838","images":{"fallback":{"src":"/static/8762c562de5c559b40a2562ebe2e7323/dcef6/papertrail-efficient-model-auditing.jpg","srcSet":"/static/8762c562de5c559b40a2562ebe2e7323/65923/papertrail-efficient-model-auditing.jpg 225w,\n/static/8762c562de5c559b40a2562ebe2e7323/ea69d/papertrail-efficient-model-auditing.jpg 450w,\n/static/8762c562de5c559b40a2562ebe2e7323/dcef6/papertrail-efficient-model-auditing.jpg 900w,\n/static/8762c562de5c559b40a2562ebe2e7323/743bd/papertrail-efficient-model-auditing.jpg 1800w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/8762c562de5c559b40a2562ebe2e7323/cdde7/papertrail-efficient-model-auditing.webp 225w,\n/static/8762c562de5c559b40a2562ebe2e7323/cab65/papertrail-efficient-model-auditing.webp 450w,\n/static/8762c562de5c559b40a2562ebe2e7323/7f6d1/papertrail-efficient-model-auditing.webp 900w,\n/static/8762c562de5c559b40a2562ebe2e7323/8b112/papertrail-efficient-model-auditing.webp 1800w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":590}}}},"fields":{"slug":"/blog/model-audit-paper-trail/"}},"relatedP":{"edges":[{"node":{"id":"40da9b16-4faf-592a-b9c0-49d94a2304f9","frontmatter":{"title":"Rails Enums with MySQL or Postgres","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/44e499371e6e83708de5e52b055c6d08/26528/enum-jake-hills-0hgiQQEi4ic-unsplash.jpg","srcSet":"/static/44e499371e6e83708de5e52b055c6d08/26528/enum-jake-hills-0hgiQQEi4ic-unsplash.jpg 300w,\n/static/44e499371e6e83708de5e52b055c6d08/43429/enum-jake-hills-0hgiQQEi4ic-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/44e499371e6e83708de5e52b055c6d08/5d6c3/enum-jake-hills-0hgiQQEi4ic-unsplash.webp 300w,\n/static/44e499371e6e83708de5e52b055c6d08/68dbc/enum-jake-hills-0hgiQQEi4ic-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-enum-mysql-postgres/"}}},{"node":{"id":"d84ac79f-d860-544a-8abb-63add1da9214","frontmatter":{"title":"Understanding ActiveRecord Dependent Options","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#282828","images":{"fallback":{"src":"/static/b7f7064c193fa4dc20f20d253e1928fa/26528/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg","srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/26528/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 300w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/43429/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/5d6c3/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 300w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/68dbc/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/activerecord-dependent-options/"}}},{"node":{"id":"96b087a4-28a9-51a7-ad22-48dc6787757b","frontmatter":{"title":"Efficient Database Queries in Rails: A Practical Approach","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#083858","images":{"fallback":{"src":"/static/456c5a98a74fd815a1cf5c800f73abc1/26528/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg","srcSet":"/static/456c5a98a74fd815a1cf5c800f73abc1/26528/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg 300w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/43429/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/456c5a98a74fd815a1cf5c800f73abc1/5d6c3/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.webp 300w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/68dbc/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-query-perf/"}}}]}},"pageContext":{"slug":"/blog/model-audit-paper-trail/","relatedPosts":["Understanding ActiveRecord Dependent Options","Rails Enums with MySQL or Postgres","Efficient Database Queries in Rails: A Practical Approach"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}