{"componentChunkName":"component---src-templates-post-js","path":"/blog/roll-your-own-search-service-for-gatsby-part3/","result":{"data":{"markdownRemark":{"html":"<p>This is the third in a multi-part series of posts detailing how I built the search feature for this blog. This post will provide an overview of the search engine, provided by PostgreSQL <a href=\"https://www.postgresql.org/docs/13/textsearch.html\">Full Text Search</a>, and introduce some concepts that will be needed in understanding how to integrate this with Rails.</p>\n<p>In case you missed it, <a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> of this series covers the existing options for adding search to a Gatsby site, and why I decided not to use any of them, and instead build a custom search service. <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> covers the design and population of the <code>documents</code> table that contains all the content to be searched.</p>\n<h2>PostgreSQL Full Text Search</h2>\n<p>A full discussion of how PostgreSQL full text search works is beyond the scope of this article, and I'm actually going to be using a gem that makes integrating it into Rails fairly easy. However, in order to make sense of what the gem is doing, it's worth taking a look \"under the hood\" into the search functions at the database level.</p>\n<p>Recall the <code>documents</code> table, covered in <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> of this series, looks like this, just showing a few rows, <code>body</code> column shortened for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hello=&gt; select title, category, slug, left(body, 40) as body from documents;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                               title                                |     category     |                          slug                           |                   body</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------------------------------------------------------------+------------------+---------------------------------------------------------+------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Add a Language to gatsby-remark-vscode                             | web development  | /blog/add-language-gatsby-remark-vscode/                |  This blog is built with [Gatsby](https:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> A VS Code Alternative to Postman                                   | Web Development  | /blog/postman-alternative-vscode/                       |  If youve been doing web development for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails CORS Middleware For Multiple Resources                       | rails            | /blog/rails-cors-middleware-multiple/                   |  A short post for today on a usage of [C</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                                       | javascript       | /blog/tdd-by-example-bugfix/                            |  This post will demonstrate an example o</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Saving on monthly expenses - A Cautionary Tale                     | personal finance | /blog/save-monthly-expense-caution/                     |  Today I want to share a cautionary tale</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails Blocked Host Solved by Docker Cleanup                        | rails            | /blog/rails-blocked-host-docker-clean/                  |  Today I want to share a debugging story</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ...</span></span></code></pre>\n<p>Now suppose you were interested in searching for posts about TDD by searching the <code>body</code> column. A naive approach would be something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents </span><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> body </span><span class=\"mtk7\">LIKE</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;%TDD%&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The performance of <code>LIKE</code> wildcarding may not be very good because the <code>body</code> column contains the entire post content so it could be very large. Also what if the post content refers to lowercase <code>tdd</code>? Then this query would miss some matches. Yes you could use <code>lower(body)</code> instead of <code>body</code> but what if you want to search for <code>expenses</code> but the body has <code>expense</code>? Now you also need to take pluralization and grammar into account. This reveals the limitations of <code>LIKE</code> wildcard searching.</p>\n<h3>to_tsvector</h3>\n<p>With full text search, Postgres provides the <code>to_tsvector</code> function. This function parses a text document into tokens, normalizes the tokens to <a href=\"https://en.wikipedia.org/wiki/Lexeme\">lexemes</a>, and returns a <code>tsvector</code> which lists the lexemes together with their positions in the document. It will not process stop words such as <code>a</code>, <code>the</code>, <code>but</code> etc. because these are words that occur in the English language too frequently to be useful for searching. It also eliminates pluralization and punctuation. This reduces the words to a common form which will be most useful for searching. It does all this by consulting a set of dictionaries for the specified language, which is the first argument to the <code>to_tsvector</code> function.</p>\n<p>Phew, that was a lot of words to explain the <code>to_tsvector</code> function. Let's see an example. Below I've taken just one paragraph from a blog post I wrote about <a href=\"../tdd-by-example-bugfix\">TDD</a>, and then run it through the <code>to_tsvector</code> function using the <code>english</code> language dictionaries (these are provided by PostgreSQL):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven&#39;&#39;t actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>And here is the result, it gets returned all in one line but I've broken it up into multiple lines for legibility. The result is a list of lexemes (normalized english words) and their position in the text that was given as the second argument passed to the <code>to_tsvector</code> function. If the same lexeme appears multiple times in the document text, each position is listed in a comma separated format:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;actual&#39;:54</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;alreadi&#39;:43</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;approach&#39;:5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;assert&#39;:38</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;assum&#39;:39</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;bug&#39;:41</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;buggi&#39;:31</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;code&#39;:14,35,65</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;differ&#39;:7</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;exercis&#39;:29</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;fail&#39;:22,49</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;figur&#39;:9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;first&#39;:19</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;fix&#39;:45,55,63</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;go&#39;:60</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;haven&#39;:52</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;lie&#39;:17</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;make&#39;:37</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;pass&#39;:75</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;portion&#39;:32</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;problem&#39;:16</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;run&#39;:66</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;tdd&#39;:3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;test&#39;:23,27,47,68</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;time&#39;:72</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;write&#39;:20</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;yet&#39;:57</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;</span></span></code></pre>\n<p>Notice how all the words have been lower cased, punctuation removed, and no stop words appear in the results.</p>\n<h3>to_tsquery</h3>\n<p>Looking at the results of <code>to_tsvector</code>, you can start to see how this approach overcomes the limitations of <code>LIKE</code> wildcard searching. But how do you actually use it in a search? This is where the <code>to_tsquery</code> function comes in. This function takes in a language parameter, and a string to search for, and converts it to the <code>tsquery</code> data type. Then the <code>@@</code> operator is used to check if a query (aka <code>tsquery</code>) is contained in a <code>tsvector</code>, which was the output of the <code>to_tsvector</code> function.</p>\n<p>Once again, an example will help to clarify this:</p>\n<p>Suppose you'd like to know whether the word <code>TDD</code> appears in the sample paragraph I extracted earlier from the TDD article. First run the paragraph through the <code>to_tsvector</code> function, then use the <code>@@</code> operator to determine whether the <code>tsquery</code> of <code>TDD</code> is contained in the <code>tsvector</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven&#39;&#39;t actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- true</span></span></span></code></pre>\n<p>The result is true, meaning the term was found. Note that even though I passed in upper case <code>TDD</code>, it matched on the lower case <code>tdd</code> from the list of lexemes returned by the <code>to_tsvector</code> function:</p>\n<p>Let's try searching for the word <code>fixed</code>. Notice the root of this word <code>fix</code> is in the list of lexemes, but not literally <code>fixed</code>. The list of <code>lexemes</code> shown earlier has the word <code>fix</code> appearing in 3 places in the paragraph text: <code>'fix':45,55,63</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven&#39;&#39;t actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;fixed&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- true</span></span></span></code></pre>\n<p>Again, a match is found, so the <code>@@ to_tsquery</code> operator returns true.</p>\n<h3>Searching a Table</h3>\n<p>The above examples were manually constructed by extracting some paragraph text from one article. This demonstrates the usefulness of the <code>to_tsvector</code> and <code>to_tsquery</code> functions.</p>\n<p>Now its time to use these against the <code>documents</code> table to show how a real search would work. For example, to search all documents for <code>TDD</code> in the <code>body</code> column, and return a list of title and slugs for the matching documents:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Results:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                    title                    |                   slug</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------------------------------------------+------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                | /blog/tdd-by-example-bugfix/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby | /blog/python-interview-question-in-ruby/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                              | /blog/tdd-by-example/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<p>The first and third results make sense, I've written two articles on TDD. But why is the second article on <a href=\"../python-interview-question-in-ruby\">Solving a Python Interview Question in Ruby</a> showing up in the results? Reviewing that article, indeed it does refer several times to TDD as that is used to solve the interview question. So it makes sense that it's included in the results, but why is it showing up before the <code>TDD by Example</code> article?</p>\n<h2>ts_rank</h2>\n<p>This brings up the question of rank. The <code>ts_rank</code> function takes a <code>tsvector</code> and <code>tsquery</code> and returns a number indicating how strong of a match the query is against the given list of lexemes. Let's include the rank in the previous query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Results:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                    title                    |                   slug                   |   ts_rank</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------------------------------------------+------------------------------------------+-------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                | /blog/tdd-by-example-bugfix/             |  0.09741346</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby | /blog/python-interview-question-in-ruby/ |  0.096883096</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                              | /blog/tdd-by-example/                    |  0.09793941</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<p>The above results show that the <code>Solving a Python Interview Question in Ruby</code> result is the lowest ranked in the list. In order to make search results useful, the most relevant results should be listed first. To make these results sorted by relevance, we can order by descending rank (i.e. highest first):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk7\">as</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ORDER BY</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span><span class=\"mtk1\"> </span><span class=\"mtk7\">DESC</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Now the results show the first article <code>TDD by Example</code> is the most relevant, followed by the next article using TDD to fix a bug, and finally in last place, the interview article where TDD is referred to, but as frequently as the other two articles:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                    title                    |                   slug                   |    rank</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------------------------------------------+------------------------------------------+-------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                              | /blog/tdd-by-example/                    |  0.09793941</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                | /blog/tdd-by-example-bugfix/             |  0.09741346</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby | /blog/python-interview-question-in-ruby/ |  0.096883096</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<h2>What's Next?</h2>\n<p>This post provided an introduction to PostgreSQL full text search with some examples of using the <code>ts_vector</code>, <code>ts_query</code> and <code>ts_rank</code> functions. Next up, see <a href=\"../roll-your-own-search-service-for-gatsby-part4\">Part 4: Search API</a> for how to integrate this into a Rails model and controller to provide a search API.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search Engine","date":"10 Jul 2021","description":"Learn how to build search service using Rails and Postgres Full Text Search for a Gatsby blog.","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMCBf/EABUBAQEAAAAAAAAAAAAAAAAAAAIB/9oADAMBAAIQAxAAAAFqsgruAU//xAAcEAACAgIDAAAAAAAAAAAAAAABAgASAwQREyH/2gAIAQEAAQUCLWTD5OwGYWuNgVXkmf/EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/AVf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAcEAADAAEFAAAAAAAAAAAAAAAAARECECEzYYH/2gAIAQEABj8CdTRtmmckLI+ixPzT/8QAHBAAAgICAwAAAAAAAAAAAAAAAAERITFRQWGh/9oACAEBAAE/IaprlbExURw7HYh0Z69MiprW6MkS2f/aAAwDAQACAAMAAAAQ2M//xAAYEQEBAAMAAAAAAAAAAAAAAAABABExUf/aAAgBAwEBPxBV3Ycv/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAFRIf/aAAgBAgEBPxBOG0//xAAcEAEAAwEAAwEAAAAAAAAAAAABABEhQTFhcYH/2gAIAQEAAT8QdvASm9z3TMY9rq+Mx3C02QK6u1o/R4ZSLUomz6RQSqz/2Q==","aspectRatio":1.5003750937734435,"src":"/static/86310660995a38a9254ece85739c237f/14b42/roll-search-3.jpg","srcSet":"/static/86310660995a38a9254ece85739c237f/f836f/roll-search-3.jpg 200w,\n/static/86310660995a38a9254ece85739c237f/2244e/roll-search-3.jpg 400w,\n/static/86310660995a38a9254ece85739c237f/14b42/roll-search-3.jpg 800w,\n/static/86310660995a38a9254ece85739c237f/47498/roll-search-3.jpg 1200w,\n/static/86310660995a38a9254ece85739c237f/0e329/roll-search-3.jpg 1600w,\n/static/86310660995a38a9254ece85739c237f/a41d1/roll-search-3.jpg 2000w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part3/"}}},"pageContext":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part3/","content":"<p>This is the third in a multi-part series of posts detailing how I built the search feature for this blog. This post will provide an overview of the search engine, provided by PostgreSQL <a href=\"https://www.postgresql.org/docs/13/textsearch.html\">Full Text Search</a>, and introduce some concepts that will be needed in understanding how to integrate this with Rails.</p>\n<p>In case you missed it, <a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> of this series covers the existing options for adding search to a Gatsby site, and why I decided not to use any of them, and instead build a custom search service. <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> covers the design and population of the <code>documents</code> table that contains all the content to be searched.</p>\n<h2>PostgreSQL Full Text Search</h2>\n<p>A full discussion of how PostgreSQL full text search works is beyond the scope of this article, and I'm actually going to be using a gem that makes integrating it into Rails fairly easy. However, in order to make sense of what the gem is doing, it's worth taking a look \"under the hood\" into the search functions at the database level.</p>\n<p>Recall the <code>documents</code> table, covered in <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> of this series, looks like this, just showing a few rows, <code>body</code> column shortened for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hello=&gt; select title, category, slug, left(body, 40) as body from documents;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                               title                                |     category     |                          slug                           |                   body</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------------------------------------------------------------+------------------+---------------------------------------------------------+------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Add a Language to gatsby-remark-vscode                             | web development  | /blog/add-language-gatsby-remark-vscode/                |  This blog is built with [Gatsby](https:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> A VS Code Alternative to Postman                                   | Web Development  | /blog/postman-alternative-vscode/                       |  If youve been doing web development for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails CORS Middleware For Multiple Resources                       | rails            | /blog/rails-cors-middleware-multiple/                   |  A short post for today on a usage of [C</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                                       | javascript       | /blog/tdd-by-example-bugfix/                            |  This post will demonstrate an example o</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Saving on monthly expenses - A Cautionary Tale                     | personal finance | /blog/save-monthly-expense-caution/                     |  Today I want to share a cautionary tale</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails Blocked Host Solved by Docker Cleanup                        | rails            | /blog/rails-blocked-host-docker-clean/                  |  Today I want to share a debugging story</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ...</span></span></code></pre>\n<p>Now suppose you were interested in searching for posts about TDD by searching the <code>body</code> column. A naive approach would be something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents </span><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> body </span><span class=\"mtk7\">LIKE</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;%TDD%&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The performance of <code>LIKE</code> wildcarding may not be very good because the <code>body</code> column contains the entire post content so it could be very large. Also what if the post content refers to lowercase <code>tdd</code>? Then this query would miss some matches. Yes you could use <code>lower(body)</code> instead of <code>body</code> but what if you want to search for <code>expenses</code> but the body has <code>expense</code>? Now you also need to take pluralization and grammar into account. This reveals the limitations of <code>LIKE</code> wildcard searching.</p>\n<h3>to_tsvector</h3>\n<p>With full text search, Postgres provides the <code>to_tsvector</code> function. This function parses a text document into tokens, normalizes the tokens to <a href=\"https://en.wikipedia.org/wiki/Lexeme\">lexemes</a>, and returns a <code>tsvector</code> which lists the lexemes together with their positions in the document. It will not process stop words such as <code>a</code>, <code>the</code>, <code>but</code> etc. because these are words that occur in the English language too frequently to be useful for searching. It also eliminates pluralization and punctuation. This reduces the words to a common form which will be most useful for searching. It does all this by consulting a set of dictionaries for the specified language, which is the first argument to the <code>to_tsvector</code> function.</p>\n<p>Phew, that was a lot of words to explain the <code>to_tsvector</code> function. Let's see an example. Below I've taken just one paragraph from a blog post I wrote about <a href=\"../tdd-by-example-bugfix\">TDD</a>, and then run it through the <code>to_tsvector</code> function using the <code>english</code> language dictionaries (these are provided by PostgreSQL):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven&#39;&#39;t actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>And here is the result, it gets returned all in one line but I've broken it up into multiple lines for legibility. The result is a list of lexemes (normalized english words) and their position in the text that was given as the second argument passed to the <code>to_tsvector</code> function. If the same lexeme appears multiple times in the document text, each position is listed in a comma separated format:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;actual&#39;:54</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;alreadi&#39;:43</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;approach&#39;:5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;assert&#39;:38</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;assum&#39;:39</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;bug&#39;:41</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;buggi&#39;:31</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;code&#39;:14,35,65</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;differ&#39;:7</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;exercis&#39;:29</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;fail&#39;:22,49</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;figur&#39;:9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;first&#39;:19</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;fix&#39;:45,55,63</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;go&#39;:60</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;haven&#39;:52</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;lie&#39;:17</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;make&#39;:37</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;pass&#39;:75</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;portion&#39;:32</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;problem&#39;:16</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;run&#39;:66</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;tdd&#39;:3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;test&#39;:23,27,47,68</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;time&#39;:72</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;write&#39;:20</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;yet&#39;:57</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;</span></span></code></pre>\n<p>Notice how all the words have been lower cased, punctuation removed, and no stop words appear in the results.</p>\n<h3>to_tsquery</h3>\n<p>Looking at the results of <code>to_tsvector</code>, you can start to see how this approach overcomes the limitations of <code>LIKE</code> wildcard searching. But how do you actually use it in a search? This is where the <code>to_tsquery</code> function comes in. This function takes in a language parameter, and a string to search for, and converts it to the <code>tsquery</code> data type. Then the <code>@@</code> operator is used to check if a query (aka <code>tsquery</code>) is contained in a <code>tsvector</code>, which was the output of the <code>to_tsvector</code> function.</p>\n<p>Once again, an example will help to clarify this:</p>\n<p>Suppose you'd like to know whether the word <code>TDD</code> appears in the sample paragraph I extracted earlier from the TDD article. First run the paragraph through the <code>to_tsvector</code> function, then use the <code>@@</code> operator to determine whether the <code>tsquery</code> of <code>TDD</code> is contained in the <code>tsvector</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven&#39;&#39;t actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- true</span></span></span></code></pre>\n<p>The result is true, meaning the term was found. Note that even though I passed in upper case <code>TDD</code>, it matched on the lower case <code>tdd</code> from the list of lexemes returned by the <code>to_tsvector</code> function:</p>\n<p>Let's try searching for the word <code>fixed</code>. Notice the root of this word <code>fix</code> is in the list of lexemes, but not literally <code>fixed</code>. The list of <code>lexemes</code> shown earlier has the word <code>fix</code> appearing in 3 places in the paragraph text: <code>'fix':45,55,63</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven&#39;&#39;t actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;fixed&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- true</span></span></span></code></pre>\n<p>Again, a match is found, so the <code>@@ to_tsquery</code> operator returns true.</p>\n<h3>Searching a Table</h3>\n<p>The above examples were manually constructed by extracting some paragraph text from one article. This demonstrates the usefulness of the <code>to_tsvector</code> and <code>to_tsquery</code> functions.</p>\n<p>Now its time to use these against the <code>documents</code> table to show how a real search would work. For example, to search all documents for <code>TDD</code> in the <code>body</code> column, and return a list of title and slugs for the matching documents:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Results:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                    title                    |                   slug</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------------------------------------------+------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                | /blog/tdd-by-example-bugfix/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby | /blog/python-interview-question-in-ruby/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                              | /blog/tdd-by-example/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<p>The first and third results make sense, I've written two articles on TDD. But why is the second article on <a href=\"../python-interview-question-in-ruby\">Solving a Python Interview Question in Ruby</a> showing up in the results? Reviewing that article, indeed it does refer several times to TDD as that is used to solve the interview question. So it makes sense that it's included in the results, but why is it showing up before the <code>TDD by Example</code> article?</p>\n<h2>ts_rank</h2>\n<p>This brings up the question of rank. The <code>ts_rank</code> function takes a <code>tsvector</code> and <code>tsquery</code> and returns a number indicating how strong of a match the query is against the given list of lexemes. Let's include the rank in the previous query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Results:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                    title                    |                   slug                   |   ts_rank</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------------------------------------------+------------------------------------------+-------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                | /blog/tdd-by-example-bugfix/             |  0.09741346</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby | /blog/python-interview-question-in-ruby/ |  0.096883096</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                              | /blog/tdd-by-example/                    |  0.09793941</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<p>The above results show that the <code>Solving a Python Interview Question in Ruby</code> result is the lowest ranked in the list. In order to make search results useful, the most relevant results should be listed first. To make these results sorted by relevance, we can order by descending rank (i.e. highest first):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk7\">as</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ORDER BY</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span><span class=\"mtk1\"> </span><span class=\"mtk7\">DESC</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Now the results show the first article <code>TDD by Example</code> is the most relevant, followed by the next article using TDD to fix a bug, and finally in last place, the interview article where TDD is referred to, but as frequently as the other two articles:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                    title                    |                   slug                   |    rank</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------------------------------------------+------------------------------------------+-------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                              | /blog/tdd-by-example/                    |  0.09793941</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                | /blog/tdd-by-example-bugfix/             |  0.09741346</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby | /blog/python-interview-question-in-ruby/ |  0.096883096</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<h2>What's Next?</h2>\n<p>This post provided an introduction to PostgreSQL full text search with some examples of using the <code>ts_vector</code>, <code>ts_query</code> and <code>ts_rank</code> functions. Next up, see <a href=\"../roll-your-own-search-service-for-gatsby-part4\">Part 4: Search API</a> for how to integrate this into a Rails model and controller to provide a search API.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","title":"Roll Your Own Search with Rails and Postgres: Search Engine","description":"Learn how to build search service using Rails and Postgres Full Text Search for a Gatsby blog."}},"staticQueryHashes":["163244226"]}