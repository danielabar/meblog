{"componentChunkName":"component---src-templates-post-js","path":"/blog/sqlite-varchar-surprise/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">I recently completed the <a href=\"https://app.pluralsight.com/library/courses/getting-started-ruby-rails/table-of-contents\" class=\"markdown-link\">Getting Started with Rails 6</a> course on Pluralsight and ran into a surprise with the use of SQLite and string column lengths. SQLite is a popular choice in Rails courses as its the default database when starting an app with the <code>rails new...</code> command and very easy to use. However, I was surprised by how it handles string column lengths as this post will explain.</p>\n<h2 class=\"markdown-subtitle\" id=\"setup\" style=\"position:relative;\"><a href=\"#setup\" aria-label=\"setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setup</h2>\n<p class=\"markdown-para\">The course uses Ruby 2.7.2 and Rails 6.1.4 to build a Wiki application where users can create, view, and edit posts. It also assumes that <a href=\"https://formulae.brew.sh/formula/sqlite\" class=\"markdown-link\">sqlite</a> is installed on the local machine. There's a single model <code>WikiPost</code> to persist the author, title, and description.</p>\n<p class=\"markdown-para\">To get started, the <code>scaffold</code> option of the <code>generate</code> command is used to generate not just a migration for the model, but also the model class, controller, views, view helpers, styles, routes and tests. For the purpose of this post, we will only be focusing on the migration and model.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate scaffold WikiPost title:string description:string author:string</span></span></code></pre>\n<p class=\"markdown-para\">Generates this migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateWikiPosts</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:wiki_posts</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">And this model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WikiPost</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">After running the migration with <code>bin/rails db:migrate</code>, we can use the <a href=\"https://www.sqlite.org/cli.html\" class=\"markdown-link\">sqlite3</a> command line tool that ships with SQLite to see what schema got created for this table. To work with any SQLite database from the terminal, run <code>sqlite3</code> passing in the path to the database file. In a Rails project, it will be in <code>db/{env}.sqlite3</code>. To open the development database, the command is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># cd to the project root</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">sqlite3 db/development.sqlite3</span></span></span></code></pre>\n<p class=\"markdown-para\">From the sqlite prompt, the <code>.schema table_name</code> command can be used to display the schema for the given table name. By default, the display is all on line line which is hard to read. Passing in the <code>--indent</code> option produces more human readable output:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">sqlite</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> .</span><span class=\"mtk7\">schema</span><span class=\"mtk1\"> wiki_posts </span><span class=\"mtk3\">--indent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CREATE</span><span class=\"mtk1\"> </span><span class=\"mtk7\">TABLE</span><span class=\"mtk1\"> </span><span class=\"mtk7\">IF</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">EXISTS</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;wiki_posts&quot;</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">integer</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\"> </span><span class=\"mtk7\">PRIMARY</span><span class=\"mtk1\"> </span><span class=\"mtk7\">KEY</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;created_at&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">datetime</span><span class=\"mtk1\">(</span><span class=\"mtk4\">6</span><span class=\"mtk1\">) </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;updated_at&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">datetime</span><span class=\"mtk1\">(</span><span class=\"mtk4\">6</span><span class=\"mtk1\">) </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;title&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">varchar</span><span class=\"mtk1\"> DEFAULT </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">varchar</span><span class=\"mtk1\"> DEFAULT </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;author&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">varchar</span><span class=\"mtk1\"> DEFAULT </span><span class=\"mtk7\">NULL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"limit-length\" style=\"position:relative;\"><a href=\"#limit-length\" aria-label=\"limit length permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Limit Length</h2>\n<p class=\"markdown-para\">After trying out the generated UI and adding some styles, it's determined that it would be better to limit the title length. In the course it gets set to 50 characters, but for easier demonstration purposes, I will use 10 here. To modify the table definition, we first need to generate a new migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate migration update_wiki_post_title</span></span></code></pre>\n<p class=\"markdown-para\">We use the <code>change_column</code> method in the migration file to change the <code>title</code> column in <code>wiki_posts</code> table to have a max length of 10 characters. Note the use of <code>up</code> and <code>down</code> methods rather than <code>change</code> because otherwise if running a rollback, Rails won't know what the previous state of the column was to undo this change:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">UpdateWikiPostTitle</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    change_column </span><span class=\"mtk4\">:wiki_posts</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:string</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:limit</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk4\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    change_column </span><span class=\"mtk4\">:wiki_posts</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">After running this migration with <code>bin/rails db:migrate</code>, run the <code>sqlite3</code> command line tool again to verify the <code>wiki_posts</code> table schema has been updated to limit the title length:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">sqlite</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> .</span><span class=\"mtk7\">schema</span><span class=\"mtk1\"> wiki_posts </span><span class=\"mtk3\">--indent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CREATE</span><span class=\"mtk1\"> </span><span class=\"mtk7\">TABLE</span><span class=\"mtk1\"> </span><span class=\"mtk7\">IF</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">EXISTS</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;wiki_posts&quot;</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">integer</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\"> </span><span class=\"mtk7\">PRIMARY</span><span class=\"mtk1\"> </span><span class=\"mtk7\">KEY</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;created_at&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">datetime</span><span class=\"mtk1\">(</span><span class=\"mtk4\">6</span><span class=\"mtk1\">) </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;updated_at&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">datetime</span><span class=\"mtk1\">(</span><span class=\"mtk4\">6</span><span class=\"mtk1\">) </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;title&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">varchar</span><span class=\"mtk1\">(</span><span class=\"mtk4\">10</span><span class=\"mtk1\">) DEFAULT </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">varchar</span><span class=\"mtk1\"> DEFAULT </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;author&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">varchar</span><span class=\"mtk1\"> DEFAULT </span><span class=\"mtk7\">NULL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p class=\"markdown-para\">Notice the <code>title</code> column now has a column type of <code>varchar(10)</code> whereas before it was simply <code>varchar</code>. It would be expected that now any rows saved to the table can have at most 10 characters for the title.</p>\n<h2 class=\"markdown-subtitle\" id=\"the-problem\" style=\"position:relative;\"><a href=\"#the-problem\" aria-label=\"the problem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Problem</h2>\n<p class=\"markdown-para\">Let's try this out using the <code>WikiPost</code> model in a Rails console <code>bin/rails console</code>, and try to save some invalid data, that is, a model instance with a title longer than 10 characters:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a new post with a title of 11 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_post </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">WikiPost</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;abcdefghijk&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Try to save it to the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_post.</span><span class=\"mtk5\">save</span></span></span></code></pre>\n<p class=\"markdown-para\">I was expecting an error at this point, however, the output from saving the model shows that it was successfully saved to the database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.1ms)  begin transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WikiPost Create (3.3ms)  INSERT INTO &quot;wiki_posts&quot; (&quot;created_at&quot;, &quot;updated_at&quot;, &quot;title&quot;) VALUES (?, ?, ?)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  [[&quot;created_at&quot;, &quot;2022-06-15 11:14:59.474262&quot;], [&quot;updated_at&quot;, &quot;2022-06-15 11:14:59.474262&quot;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  [&quot;title&quot;, &quot;abcdefghijk&quot;]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (1.4ms)  commit transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=&gt; true</span></span></code></pre>\n<p class=\"markdown-para\">Me:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 90.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAMEBQEG/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/9oADAMBAAIQAxAAAAG45Bl1kSKmeT6EYf/EABwQAQACAgMBAAAAAAAAAAAAAAEAAgMREiEiMf/aAAgBAQABBQI1F1MbyqJUlFrXH3fG+j5//8QAFxEAAwEAAAAAAAAAAAAAAAAAAQIQMf/aAAgBAwEBPwFRBk//xAAXEQEAAwAAAAAAAAAAAAAAAAABABAR/9oACAECAQE/AVm3/8QAHhAAAQMEAwAAAAAAAAAAAAAAAAERIQIDEDEyUaH/2gAIAQEABj8C1JGxx1I9OJU/SFzH/8QAHBAAAwACAwEAAAAAAAAAAAAAAAERMWEhQXFR/9oACAEBAAE/IbPbnRepawbnRvVL1S+GWr9oVUmFUJOZBkK+LNGHw//aAAwDAQACAAMAAAAQbDBC/8QAGBEBAAMBAAAAAAAAAAAAAAAAAQAQIRH/2gAIAQMBAT8QBOsTcu//xAAXEQEBAQEAAAAAAAAAAAAAAAAAAREx/9oACAECAQE/EKRleq//xAAeEAEAAwACAgMAAAAAAAAAAAABABEhMWFxsVGBkf/aAAgBAQABPxA7kqgTjGe4a0y6jzo36lehLBHa6/Ki62XppWNndPM34lE5z5meiCl0I3OLI1X24m1daep//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sqlite surprise huh\"\n        title=\"sqlite surprise huh\"\n        src=\"/static/637fc118fd985e597fcbf7c441b3cde2/066f9/sqlite-surprise-huh.jpg\"\n        srcset=\"/static/637fc118fd985e597fcbf7c441b3cde2/e07e9/sqlite-surprise-huh.jpg 200w,\n/static/637fc118fd985e597fcbf7c441b3cde2/066f9/sqlite-surprise-huh.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Well that was unexpected! What's the point of creating and running a migration to limit a column length if Rails ignores it and goes ahead and saves data that violates the limit?</p>\n<p class=\"markdown-para\">My first thought was maybe there was an issue with the combination of the Rails and SQLite versions used in the course. To investigate this, we can try bypassing Rails and use  <code>sqlite3</code> to try a direct insert into the database with the same too long title:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Try to save invalid data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INSERT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">INTO</span><span class=\"mtk1\"> wiki_posts(title, created_at, updated_at)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">VALUES</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;abcdefghijk&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk9\">CURRENT_TIMESTAMP</span><span class=\"mtk1\">, </span><span class=\"mtk9\">CURRENT_TIMESTAMP</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Returns control to the prompt with no error, this means it worked.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Verify</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span><span class=\"mtk1\"> title, created_at, updated_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> wiki_posts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ORDER BY</span><span class=\"mtk1\"> created_at </span><span class=\"mtk7\">DESC</span><span class=\"mtk1\"> </span><span class=\"mtk7\">LIMIT</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Outputs: abcdefghijk|2022-06-16 10:54:27|2022-06-16 10:54:27</span></span></span></code></pre>\n<p class=\"markdown-para\">Surprisingly, the database allows data that violates the length constraint to be inserted. So this isn't a Rails problem, it seems to be a problem with SQLite. I did a little digging, and it turns out SQLite doesn't enforce varchar length limits. From the <a href=\"https://www.hwaci.com/sw/sqlite/faq.html\" class=\"markdown-link\">FAQ</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">SQLite does not enforce the length of a VARCHAR. You can declare a VARCHAR(10) and SQLite will be happy to store a 500-million character string there. And it will keep all 500-million characters intact. Your content is never truncated. SQLite understands the column type of \"VARCHAR(N)\" to be the same as \"TEXT\", regardless of the value of N.</p>\n</blockquote>\n<p class=\"markdown-para\">Me:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD8klEQVR42iXMW29TBQDA8X4Ev4HPGN9M1Ae8PBkTYwxqTIhhJpJ4wcTwQOKFXWRzwJggkwGbA9xcx9oy2rJ2vdL7fafX0/ac9rSl3Xpb6Tq6G8Qo+Rvj7wP8VBeia1xKupnM+JkQw0xIAr8qaWarWZYaMrq2wlKrhLpdwfSkQbBfxb8ZJZA3IabVSMIMMf8UrsAclrge1VTKwXQ+wI1ClGvFONPlDLO1PH82C9x/XMbcq2Ha2cT4pIG5X8e5JeKTjETCUyi+YbZCZ9h4+C05+wiRyCKq66KDWTnAXGmd2UqS2UcZ5jayLLYKGLpl7P1NXPstnAdtbActnI0o4dBV4vovkPTH2XIdZ9s9QNU7SCqpQXVLcvGHEmT+0Trz1SQL9RzqTgltU2J1u4yjv4Fnv0Hwnx1cvSrurTTh7DJR73nW3UNkI8MUU5OkCxrCj3yo7tUiGFsJTB0R67aM/bHE0vIIa4ZLhPo1Ys+aiBziFx04PfdJ7FYJN30ESqsEFTPhkonopptAW8DdSqKydUXcuwX8u0UybGMKGbj5+UtYrn1ETHFRBB4677J4boCUIlA8LBNRFnHFLmOP3sAp3MGjrOHrpPB0c6hc/2UHJeLPW9iVAKc+fZsv338dy9lXkTUniK6MYRx9j3DMTJ0+hY6dlHCGgOkYNt3HONa+IZC8Ragt4O/JqDz7ZfwHFVJ0GR/7ipOvvcDQsRcxjxylf/MV0oMv47p+An/kAbn2OoXSNBvZrynHjpP2D5BJjZNt2BCeSAR3Cv+HgWc1ggdVLn7/AaffOsLEJ0fQDB0lOPYGzp/fRT38IV7zNfxZF6nMNNXiIOXSCJIyibxlIXdYYH2/gr+XR+XcVXDtKvj+anPLeJWT77zJ+KnPCM5/hnd2gEQzT363SbIqEKpEWa+uEa9pidW0rNfNJPoZ4k9rhPfKeLpZVPc6OVY6OYx7Ne4EtQyeP82Vq6NYl8exGSdJ/t1D5ClpnpJ8vkV4v4h3J4enm8Tby+DdK+Hfq+DbKWLvZFDNVAR+ryaY20wzIwe5ErMwaljktv0ObmGRyGMJz2ET814d014d894ma/0K1p6EdVvC2pNx9SR8XRFbI47qgujgF8nNZcnDhBxgohzlcjnM7UoEdzWAT3ZjrAno6kkM9RTaZobldgpDK4mpEWe1LmCrx/BuhlireFCdjWo4F19hRNDxY0zDdzENPwhaLiS0qEUDRtnMfPYBC7lV7kkW5mUrc4qDuxUPhoqPFcXN/aKT1aIVXd6EaiiqZjimZiim5qeEjlFRz1jWwEVRz5SoZyarZyav57ZsYKFgZDa/wm9ZHXPyA5YVJ8sFB0uylbuyhYWciX8BxHvEofa1zWYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sqlite surprise wow\"\n        title=\"sqlite surprise wow\"\n        src=\"/static/f68568ad8496dee23c19b793991992c4/5a190/sqlite-surprise-wow.png\"\n        srcset=\"/static/f68568ad8496dee23c19b793991992c4/772e8/sqlite-surprise-wow.png 200w,\n/static/f68568ad8496dee23c19b793991992c4/e17e5/sqlite-surprise-wow.png 400w,\n/static/f68568ad8496dee23c19b793991992c4/5a190/sqlite-surprise-wow.png 800w,\n/static/f68568ad8496dee23c19b793991992c4/f96df/sqlite-surprise-wow.png 849w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 class=\"markdown-subtitle\" id=\"a-solution\" style=\"position:relative;\"><a href=\"#a-solution\" aria-label=\"a solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A Solution</h2>\n<p class=\"markdown-para\">If the database won't enforce the column length limit, we could instead enhance the <code>WikiPost</code> model to use the <a href=\"https://guides.rubyonrails.org/active_record_validations.html#length\" class=\"markdown-link\">length</a> validator from ActiveRecord as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WikiPost</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">length:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">maximum:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's see how this behaves in the console (start with <code>bin/rails c</code>):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a new post with a title of 11 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_post </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">WikiPost</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;abcdefghijk&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Try to save it to the database - this time it fails!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_post.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Is the object valid? No!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_post.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Show the error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_post.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:title</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [&quot;is too long (maximum is 10 characters)&quot;]</span></span></span></code></pre>\n<p class=\"markdown-para\">However, this will only be enforced via the Rails app. There is no data integrity at database level. Invalid data could still be inserted by someone with access to the database.</p>\n<h2 class=\"markdown-subtitle\" id=\"postgres-comparison\" style=\"position:relative;\"><a href=\"#postgres-comparison\" aria-label=\"postgres comparison permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Postgres Comparison</h2>\n<p class=\"markdown-para\">I was curious to see how <a href=\"https://www.postgresql.org/\" class=\"markdown-link\">Postgres</a> compares in enforcing length limits on string columns. So I scaffolded another project using Postgres instead of SQLite by passing <code>-d=postgresql</code> to the <code>rails new...</code> and setup the same <code>WikiPost</code> model and migration.</p>\n<p class=\"markdown-para\">Quick reminder, here is the original migration that creates the <code>wiki_posts</code> table, and the simple model class with no ActiveRecord validations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateWikiPosts</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:wiki_posts</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WikiPost</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">First let's see the schema that got created for this table. Connect to the Postgres database using the <a href=\"https://www.postgresql.org/docs/current/app-psql.html\" class=\"markdown-link\">psql</a> command line tool. For example, if the database name is <code>wiki</code> and Postgres is running locally:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">psql -U wiki -d wiki</span></span></span></code></pre>\n<p class=\"markdown-para\">At the database prompt, Use the <code>\\d</code> command to view a table schema. The same initial migration to create the WikiPost model results in the following table in Postgres. Notice the <code>title</code> column is of type <code>character varying</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">wiki=&gt; \\d wiki_posts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                          Table &quot;public.wiki_posts&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   Column    |              Type              | Collation | Nullable |                Default</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-------------+--------------------------------+-----------+----------+----------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> id          | bigint                         |           | not null | nextval(&#39;wiki_posts_id_seq&#39;::regclass)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> title       | character varying              |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> description | character varying              |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> author      | character varying              |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> created_at  | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> updated_at  | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;wiki_posts_pkey&quot; PRIMARY KEY, btree (id)</span></span></code></pre>\n<p class=\"markdown-para\">Now apply the migration that limits the <code>title</code> length to 10 characters:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">UpdateWikiPostTitle</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    change_column </span><span class=\"mtk4\">:wiki_posts</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:string</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:limit</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk4\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    change_column </span><span class=\"mtk4\">:wiki_posts</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">And check the schema again using <code>psql</code>. Notice the <code>title</code> column now has a data type of <code>character varying(10)</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hello=&gt; \\d wiki_posts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                          Table &quot;public.wiki_posts&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   Column    |              Type              | Collation | Nullable |                Default</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-------------+--------------------------------+-----------+----------+----------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> id          | bigint                         |           | not null | nextval(&#39;wiki_posts_id_seq&#39;::regclass)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> title       | character varying(10)          |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> description | character varying              |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> author      | character varying              |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> created_at  | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> updated_at  | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;wiki_posts_pkey&quot; PRIMARY KEY, btree (id)</span></span></code></pre>\n<p class=\"markdown-para\">Let's exercise the model in a Rails console. Remember, there are no ActiveRecord validations defined on the model.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a new post with a title of 11 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_post </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">WikiPost</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;abcdefghijk&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Try to save it to the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_post.</span><span class=\"mtk5\">save</span></span></span></code></pre>\n<p class=\"markdown-para\">Unlike with SQLite, the save fails when using Postgres. As shown in the output below, the transaction gets rolled back because the string title length violates the specified limit of 10:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">   (4.4ms)  BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WikiPost Create (7.4ms)  INSERT INTO &quot;wiki_posts&quot; (&quot;title&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES ($1, $2, $3) RETURNING &quot;id&quot;  [[&quot;title&quot;, &quot;abcdefghijk&quot;], [&quot;created_at&quot;, &quot;2022-06-15 11:11:05.725757&quot;], [&quot;updated_at&quot;, &quot;2022-06-15 11:11:05.725757&quot;]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   (1.9ms)  ROLLBACK</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Traceback (most recent call last):</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        1: from (irb):4</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ActiveRecord::ValueTooLong (PG::StringDataRightTruncation: ERROR:  value too long for type character varying(10))</span></span></code></pre>\n<p class=\"markdown-para\">Much better (and less surprising!). This is the behaviour I would expect from a table column that has a length limit.</p>\n<h2 class=\"markdown-subtitle\" id=\"mysql-comparison\" style=\"position:relative;\"><a href=\"#mysql-comparison\" aria-label=\"mysql comparison permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MySQL Comparison</h2>\n<p class=\"markdown-para\">For completeness sake, I also did a quick check on how MySQL handles string column length limits. Just focusing on direct database access as we've already learned this is not an issue with Rails. I'm using the <a href=\"https://dev.mysql.com/doc/refman/8.0/en/mysql.html\" class=\"markdown-link\">MySQL Command-Line client</a>.</p>\n<p class=\"markdown-para\">Running the two migrations to create the <code>wiki_posts</code> table and modify the <code>title</code> column to have a length of 10 results in the following table schema created. Notice the <code>title</code> column has a data type of <code>varchar(10)</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">mysql -u root -D wiki</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mysql&gt; DESCRIBE wiki_posts;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-------------+--------------+------+-----+---------+----------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| Field       | Type         | Null | Key | Default | Extra          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-------------+--------------+------+-----+---------+----------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| id          | bigint(20)   | NO   | PRI | NULL    | auto_increment |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| title       | varchar(10)  | YES  |     | NULL    |                |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| description | varchar(255) | YES  |     | NULL    |                |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| author      | varchar(255) | YES  |     | NULL    |                |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| created_at  | datetime     | NO   |     | NULL    |                |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| updated_at  | datetime     | NO   |     | NULL    |                |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-------------+--------------+------+-----+---------+----------------+</span></span></code></pre>\n<p class=\"markdown-para\">And trying to insert a title that's greater than 10 characters long results in an error, which is what we would expect:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">mysql</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">INSERT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">INTO</span><span class=\"mtk1\"> wiki_posts(title, created_at, updated_at)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">VALUES</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;abcdefghijk&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk9\">CURRENT_TIMESTAMP</span><span class=\"mtk1\">(), </span><span class=\"mtk9\">CURRENT_TIMESTAMP</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- ERROR 1406 (22001): Data too long for column &#39;title&#39; at row 1</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThroughout this post, I've been using command line tools provided by the databases such as <a class=\"markdown-link\" href=\"https://www.sqlite.org/cli.html\">sqlite3</a>, <a class=\"markdown-link\" href=\"https://www.postgresql.org/docs/current/app-psql.html\">psql</a>, and <a class=\"markdown-link\" href=\"https://dev.mysql.com/doc/refman/8.0/en/mysql.html\">mysql</a>. This isn't usually part of Rails courses or tutorials as all access to the database is handled by ActiveRecord. However, I started my career before <a class=\"markdown-link\" href=\"https://stackoverflow.com/a/1279678/3991687\">ORMs</a> were a thing, and have developed the habit of always going one level deeper than the application to check what's going on directly in the database.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered some troubleshooting techniques you can use when getting an unexpected result from ActiveRecord by interacting directly with the database. SQLite may be an ok choice of database for a demo/learning app or for something where data integrity is not such a big concern. But otherwise consider something more robust such as Postgres or MySQL.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":8,"tableOfContents":"<ul>\n<li><a href=\"#setup\">Setup</a></li>\n<li><a href=\"#limit-length\">Limit Length</a></li>\n<li><a href=\"#the-problem\">The Problem</a></li>\n<li><a href=\"#a-solution\">A Solution</a></li>\n<li><a href=\"#postgres-comparison\">Postgres Comparison</a></li>\n<li><a href=\"#mysql-comparison\">MySQL Comparison</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>","frontmatter":{"title":"SQLite Varchar Surprise","date":"01 Sep 2022","description":"Avoid getting tripped up by this SQLite feature when it comes to enforcing string column lengths.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#285878","images":{"fallback":{"src":"/static/f2620b15ec30a44b44233b6e656f6fd8/fd980/sqllite-surprise-shubham-dhage-t0Bv0OBQuTg-unsplash.jpg","srcSet":"/static/f2620b15ec30a44b44233b6e656f6fd8/00be4/sqllite-surprise-shubham-dhage-t0Bv0OBQuTg-unsplash.jpg 225w,\n/static/f2620b15ec30a44b44233b6e656f6fd8/66ebe/sqllite-surprise-shubham-dhage-t0Bv0OBQuTg-unsplash.jpg 450w,\n/static/f2620b15ec30a44b44233b6e656f6fd8/fd980/sqllite-surprise-shubham-dhage-t0Bv0OBQuTg-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/f2620b15ec30a44b44233b6e656f6fd8/c5403/sqllite-surprise-shubham-dhage-t0Bv0OBQuTg-unsplash.webp 225w,\n/static/f2620b15ec30a44b44233b6e656f6fd8/edfe1/sqllite-surprise-shubham-dhage-t0Bv0OBQuTg-unsplash.webp 450w,\n/static/f2620b15ec30a44b44233b6e656f6fd8/b19f4/sqllite-surprise-shubham-dhage-t0Bv0OBQuTg-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":675}}}},"fields":{"slug":"/blog/sqlite-varchar-surprise/"}},"relatedP":{"edges":[{"node":{"id":"40da9b16-4faf-592a-b9c0-49d94a2304f9","frontmatter":{"title":"Rails Enums with MySQL or Postgres","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/44e499371e6e83708de5e52b055c6d08/26528/enum-jake-hills-0hgiQQEi4ic-unsplash.jpg","srcSet":"/static/44e499371e6e83708de5e52b055c6d08/26528/enum-jake-hills-0hgiQQEi4ic-unsplash.jpg 300w,\n/static/44e499371e6e83708de5e52b055c6d08/43429/enum-jake-hills-0hgiQQEi4ic-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/44e499371e6e83708de5e52b055c6d08/5d6c3/enum-jake-hills-0hgiQQEi4ic-unsplash.webp 300w,\n/static/44e499371e6e83708de5e52b055c6d08/68dbc/enum-jake-hills-0hgiQQEi4ic-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-enum-mysql-postgres/"}}},{"node":{"id":"d300ca38-a569-5f95-b2a5-0bf6c30486cc","frontmatter":{"title":"Use UUID for primary key with Rails and Postgres","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/30bb7a61cc87a3edc43f8af6d89fa013/26528/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg","srcSet":"/static/30bb7a61cc87a3edc43f8af6d89fa013/26528/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg 300w,\n/static/30bb7a61cc87a3edc43f8af6d89fa013/43429/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/30bb7a61cc87a3edc43f8af6d89fa013/5d6c3/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.webp 300w,\n/static/30bb7a61cc87a3edc43f8af6d89fa013/68dbc/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-uuid-primary-key-postgres/"}}},{"node":{"id":"bb0af7b8-9d5f-597f-90cb-a4da75c3c9a9","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search Engine","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#d8c8a8","images":{"fallback":{"src":"/static/86310660995a38a9254ece85739c237f/26528/roll-search-3.jpg","srcSet":"/static/86310660995a38a9254ece85739c237f/26528/roll-search-3.jpg 300w,\n/static/86310660995a38a9254ece85739c237f/43429/roll-search-3.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/86310660995a38a9254ece85739c237f/5d6c3/roll-search-3.webp 300w,\n/static/86310660995a38a9254ece85739c237f/68dbc/roll-search-3.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part3/"}}}]}},"pageContext":{"slug":"/blog/sqlite-varchar-surprise/","relatedPosts":["Use UUID for primary key with Rails and Postgres","Rails Enums with MySQL or Postgres","Roll Your Own Search with Rails and Postgres: Search Engine"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}