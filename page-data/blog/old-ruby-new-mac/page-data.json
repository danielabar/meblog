{"componentChunkName":"component---src-templates-post-js","path":"/blog/old-ruby-new-mac/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">Picture this scenario - you're a Rails developer that just got one of the new M1 or M2 Macs and are enjoying the performance boost and energy efficiency that comes from the ARM-based architecture. You've installed and configured all your dev tooling (oh-my-zsh, homebrew, rbenv, etc.) and are ready to get to work. Everything is great.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 97.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAFLElEQVR42iXReVPTBwLG8d/fnWkRNHfCWSAIigEliUlMQu4ECCHIYQhBAhEjIiUi2iq1q0Bb6oKoCIhmC17gUa1YsVXbIr1Hp9vtPa09pp3OdKYzO/sGvjvaN/CZ7zyPIFZkIJFnIJKlI5IqEUuVSOXpyOQZpKSu4qmnU0hJFSGWKFiRJuaZlDQUcgVVnipC/lqOJvqIBoPI05VI5CoEiSITqSITkVT1BJPIVE/glDQRLpefjtgu/N5qCvLUlBvNxDsSnEte5+sHv/HVx7/w4cLn3Dk1j2lDCamrpH+DMmUWElk6Ulk64sewTMW+3kO8e+sb/v3xnzxc+oH3F5Z5+MEj/vPgv3y2/Bf3bv/C4o0fOTVyjZFdvRg0JaSulCFIlZko03NQKLOQPy6VKMjIVjOYeIF4QzPx6B5eO/Qv7i4+4u7t31m6+ye3Fx6x+OZPLN74lfmpW0z09lKyuoiVIjnCSqkKkViOXJaOUpmFTJHB0ytW4bXY6G4IUm/R0xnezty5hyTH32Z06BzzM+9z9JU5xl6e485bP/PRpQU2FBSQ9hh0VFRS17AFq81B6ioJIqmciopKlJnZeModHI53cHJoiisXP2dHaButm1u4c/UTRl46TjzUzuzJm5wdv4BK+ff+gre2mnv3lzg8/Ar7D/azq6eb8cmT5K9ZjUguQ5WRwdDAeRaufMnp4UlODYzxYtdBRvoGmOofIHn8DZJHTqFWP4tUpUIoNG7g1ROjTJ5NMnf1EqdnkkTjbRSVFaPIUyHOFLNv3zGmxi7T3biZnaEIuVlq6j3VRH0ejiT2MPrCbtJUInLyMxHkRXkUGsvQ2I2Uesw4a/3klxSRvTYXWZ6K/FI1w8MTDB54Ffv6AjTPZlOYk48mJ5fKsmIujp3h0uwVstQZ5OQrEdLXqVGsyUVWlINYk4usOAdJQRY5hblIs6V0P5fguy/+x4XZZXY2R/Dp9FjWGfFqjexr72B0cJr7t7+nLdrCCnkqwvoaExs3WzDV2dAGLRjqLWhrDegDFsyuMqanXufT5T+YO/+A4YFx4k0RHFoLfmcFvTt62f/ci09enzw2SX5xNoKuwYQlXI4pbMXcZMO+1Y1nexWb2pz42/zcnH+Hq/Ofcja5zImxyyTi3VTb3LTUhemL97J3+x4mRuZZvH6fYL0Dwd3uZXNnDe6YF0uLDUerg6bdTVTEqzBGrCQnZpgcX2Bs5DKvT7/D6MvTHNo7SH/PARKxHhIdfZwcucjDpW9pj4cQquLV+Lb5cLQ5sbc5sUbLcbQ7sEUd6Jv1vHRsgqHBWQYGT3N+ZpmZ6fcYfW2OraE2NpbpaAhs4dCB49y5vkRTewChriuIO2rH02rF1WrFEy3H2GzAGrHgarXQ1d9DYs8wnZ39XJ3/gtnkB5wYu8H22PMoFSIC1SGOj17h2tw9Dg88jxCI+QjtqsEd3UTNNheReAWurQaqY2asTaXUd/rZ/48TuD1BBg6e4djIdUb/+QYXZj8h3t5HrKGBlpadNPqbOLh7J0Jjq4fYjiCBqAdXxE5N2IKrTo+rcSPesBl32MrQ8Bmc3iBOi5O9PUMcPXKNcF2cUCBEoMpAqS4Pq0GD3rAawdxopD7mo7bdh6vFhaPJgitspqrVhafZga6mlLauLjaaygk1tBIJRvA5PGgKstFp89Ga1rJpUwkmcwkGYwmCpkaHsd6AdYuVskAZ67ylaDzrWesuRW1dg9qkRuPUUmTQYvMGqHRasduKqfTp0RmL0OoL0esLsZevp8Ku4//pQhunNTWbUAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"happy dog yay\"\n        title=\"happy dog yay\"\n        src=\"/static/fbbe9341fa6e7f64a1d29dbf2f0dae62/0b533/happy-dog-yay-cropped.png\"\n        srcset=\"/static/fbbe9341fa6e7f64a1d29dbf2f0dae62/772e8/happy-dog-yay-cropped.png 200w,\n/static/fbbe9341fa6e7f64a1d29dbf2f0dae62/e17e5/happy-dog-yay-cropped.png 400w,\n/static/fbbe9341fa6e7f64a1d29dbf2f0dae62/0b533/happy-dog-yay-cropped.png 500w\"\n        sizes=\"(max-width: 500px) 100vw, 500px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Then you receive your next assignment, which is to perform some maintenance on an old Rails 4 project using Ruby 2.3.x (yes they still exist). So you get started by installing Ruby 2.3.3 and encounter the following error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ rbenv install 2.3.3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">To follow progress, use &#39;tail -f /var/folders/t7/6n5394/T/ruby-build.20230501063921.137.log&#39; or pass --verbose</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Downloading openssl-1.0.2u.tar.gz...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-&gt; https://dqw8nmjcqpjn7.cloudfront.net/ecd0c6ffb493dd06707d38b...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Installing openssl-1.0.2u...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BUILD FAILED (macOS 13.3.1 using ruby-build 20230330)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Inspect or clean up the working tree at /var/folders/t7/6n5394/T/ruby-build.20230501063921.137.TS6</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Results logged to /var/folders/t7/6n5394/T/ruby-build.20230501063921.137.log</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Last 10 log lines:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _dgram_write in libcrypto.a(bss_dgram.o)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _RAND_query_egd_bytes in libcrypto.a(rand_egd.o)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ld: symbol(s) not found for architecture i386</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make[4]: *** [link_a.darwin] Error 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make[3]: *** [do_darwin-shared] Error 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make[2]: *** [libcrypto.1.0.0.dylib] Error 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make[1]: *** [shared] Error 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make: *** [build_crypto] Error 1</span></span></code></pre>\n<p class=\"markdown-para\">That feeling...</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 143.49999999999997%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"uh oh dog\"\n        title=\"uh oh dog\"\n        src=\"/static/b64588996932e507183b781ea3c61c6d/e17e5/uh-oh-dog-text.png\"\n        srcset=\"/static/b64588996932e507183b781ea3c61c6d/772e8/uh-oh-dog-text.png 200w,\n/static/b64588996932e507183b781ea3c61c6d/e17e5/uh-oh-dog-text.png 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">The issue here is with OpenSSL linking against the i386 architecture, which is not compatible with the new Mac's ARM-based architecture, and so the build fails. There are some <a href=\"https://stackoverflow.com/questions/69012676/install-older-ruby-versions-on-a-m1-macbook\" class=\"markdown-link\">suggestions</a> related to uninstalling OpenSSL and re-installing with alternate compile flags. You can also attempt to uninstall all the dev tooling, setup for <a href=\"https://apple.stackexchange.com/questions/409746/run-everything-in-rosetta-2-on-silicon-mac\" class=\"markdown-link\">rosetta all the things</a>, then re-install.</p>\n<p class=\"markdown-para\">I tried a variety of these and was still getting errors. Keep in mind its not just Ruby that needs to be installed, its also all the older gems, some of which require native extensions and will run into compilation issues. I was also concerned that it would cause problems when switching to other projects that use newer Ruby versions (3.x and above are compiled for the newer Macs), as I frequently toggle between different projects. In this post I'll share an alternative solution using <a href=\"https://www.docker.com/\" class=\"markdown-link\">Docker</a> that I found easier to get working.</p>\n<p class=\"markdown-para\">The idea is to build a Docker image that comes with the older Ruby version needed for this project, mount the project code into this image, and install the project dependencies as part of the image. Then a container can be run from this image, and all the usual Rails commands such as starting a server, console, etc. can be run inside the container.</p>\n<aside class=\"markdown-aside\">\nThis post assumes familiarity with Docker concepts including images, containers, and use of Docker Compose to manage multi-container applications. If you need a refresher on Docker fundamentals, check out the <a class=\"markdown-link\" href=\"https://docs.docker.com/get-started/\">Getting Started</a> guide and <a class=\"markdown-link\" href=\"https://docs.docker.com/get-started/resources/\">Educational Resources</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"docker-image\" style=\"position:relative;\"><a href=\"#docker-image\" aria-label=\"docker image permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Image</h2>\n<p class=\"markdown-para\">The first thing that's needed is to build the Docker image. When doing so, we need to select a base image from which to get started. I'm using a <a href=\"https://hub.docker.com/r/circleci/ruby\" class=\"markdown-link\">CircleCI Ruby image</a> as it comes with common dev tooling and a non-root user named <code>circleci</code>. Here is the Dockerfile that uses the Ruby 2.3.3.</p>\n<p class=\"markdown-para\">To use it, place the following file named <code>Dockerfile</code> in the root of your project. Replace <code>2.3.3</code> with your Ruby version, and <code>myapp</code> with your app name:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"dockerfile\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> circleci/ruby:2.3.3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Set path to the app as an environment variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># so it can be referenced again in this file as `$app`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ENV</span><span class=\"mtk1\"> app /usr/share/myapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a directory for our app.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> sudo mkdir -p $app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Make the `circleci` user owner of our app dir.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> sudo chown circleci $app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Give `circleci` owner read/write/execute on app dir</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># and all dirs/files within it, and read/execute for other users.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> sudo chmod -R 0755 $app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Set the working directory to our app dir.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WORKDIR</span><span class=\"mtk1\"> $app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Copy files/dirs from build context to the current working directory in container,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># and sets the user/group ownership of copied files/dirs to circleci:circleci.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">COPY</span><span class=\"mtk1\"> --chown=circleci:circleci . .</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace with bundler version used by your old app.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> gem install bundler:1.17.3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install app dependencies</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle install</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe CMD instruction in the base Circle CI image is: CMD [\"bin/bash\"]. This means that when you run a container from this image, the container will start with a Bash shell prompt. We'll be making use of this to run all our Rails commands soon. You can see the full definition <a class=\"markdown-link\" href=\"https://hub.docker.com/layers/circleci/ruby/2.3.3/images/sha256-d4ee971ae3f1c1eac1301c79e7d1a9b994b2d8b0f0ed899ffa4f7f11dd21d1ff?context=explore\">here</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"docker-compose\" style=\"position:relative;\"><a href=\"#docker-compose\" aria-label=\"docker compose permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Compose</h2>\n<p class=\"markdown-para\">Add the following <code>docker-compose.yml</code> file to the root of the project. This will make it easy to run a container from the <code>Dockerfile</code> created in the previous step:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.9&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">myapp</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Use Dockerfile from current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Mount the current directory `.` into container at `/user/share/myapp`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/usr/share/myapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Map port 3000 on the container to 3000 on the host</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Allow container to respond to Ctrl+C and to view container&#39;s output in real-time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">tty</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span></span></span></code></pre>\n<p class=\"markdown-para\">To build the image, run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose build</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"docker-container\" style=\"position:relative;\"><a href=\"#docker-container\" aria-label=\"docker container permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Container</h2>\n<p class=\"markdown-para\">To run a container from the image, run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose up</span></span></code></pre>\n<p class=\"markdown-para\">This will run the container in the foreground, which attaches the terminal to the logs of the containers so that you can see its output. But then you can't use that terminal session for anything else, and have to open a new terminal tab to do other things.</p>\n<p class=\"markdown-para\">Alternatively, you can run the container in the background (aka detached mode), and the output will not be displayed in the terminal:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose up -d</span></span></code></pre>\n<p class=\"markdown-para\">If you run it in the background, you can always view the logs with the command below which will follow the logs in real time:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose logs -f</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"rails-server\" style=\"position:relative;\"><a href=\"#rails-server\" aria-label=\"rails server permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rails Server</h2>\n<p class=\"markdown-para\">Now that you have a running container, it's time to start a Rails server. To do this, first run a shell in the container, using <code>exec</code> which is used to execute a command inside a running container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash</span></span></code></pre>\n<p class=\"markdown-para\">Then from the shell prompt in the container, start the Rails server:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">pwd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Should be /usr/share/myapp because of WORKDIR setting in Dockerfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ls</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Should see contents of myapp such as models, views, controllers, lib, etc.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Start Rails server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Server should be listening on port 3000</span></span></span></code></pre>\n<p class=\"markdown-para\">At this point, you should be able to navigate to <code>http://localhost:3000</code> in a browser and view your app's home page.</p>\n<p class=\"markdown-para\">Note that if you shutdown your computer which will stop the container, or use <code>docker-compose stop</code> to stop the container, the Rails server process that's running in the container may not shut down cleanly because it's not running as PID 1 in the container. That means if you shell in again to run a Rails server, you may get the <a href=\"https://testsuite.io/a-server-is-already-running-pids\" class=\"markdown-link\">server is already running</a> error. We'll deal with this shortly.</p>\n<h2 class=\"markdown-subtitle\" id=\"other-commands\" style=\"position:relative;\"><a href=\"#other-commands\" aria-label=\"other commands permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other Commands</h2>\n<p class=\"markdown-para\">To run any other commands in the container such as database migrations or a Rails console, open a new terminal tab, shell into the container (you can have multiple shells) and run your command. For example, to run database migrations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rake db:migrate</span></span></code></pre>\n<p class=\"markdown-para\">To run a Rails console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rails console</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"combining-commands\" style=\"position:relative;\"><a href=\"#combining-commands\" aria-label=\"combining commands permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Combining Commands</h2>\n<p class=\"markdown-para\">One thing you may have noticed about running Rails dockerized is there's more typing to get things running. For example, to run a Rails console, requires three commands:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 1. Start container</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 2. Shell into container</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> myapp bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 3. Run Rails console from container shell</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails console</span></span></span></code></pre>\n<p class=\"markdown-para\">The last two can be combined as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp rails console</span></span></code></pre>\n<p class=\"markdown-para\">Starting a Rails server requires a little more effort to get it into one step, the following may not work:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp rails server</span></span></code></pre>\n<p class=\"markdown-para\">This is because if the <code>./tmp/server.pid</code> file still exists from last time you ran a Rails server in the container, you'll get a <code>server is already running</code> error. To solve this, let's introduce a script that first removes this file, then runs the Rails server, then use docker-compose to execute this script.</p>\n<p class=\"markdown-para\">Place the following in <code>scripts/run_dev.sh</code> (I'm assuming you have a directory <code>scripts</code> in the root of your project, if not, create it):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /usr/share/myapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rm -f ./tmp/pids/server.pid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails server</span></span></span></code></pre>\n<p class=\"markdown-para\">Make it executable with <code>chmod +x scripts/run_dev.sh</code>. Now you can start a Rails server by passing the <code>-c</code> flag to the <code>bash</code> command, which tells it to execute the script in the container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash -c &quot;./scripts/run_dev.sh&quot;</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"even-less-typing\" style=\"position:relative;\"><a href=\"#even-less-typing\" aria-label=\"even less typing permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Even Less Typing</h2>\n<p class=\"markdown-para\">Combining commands with <code>exec</code> and <code>-c</code> flag saves some typing, but we can do even better. Let's introduce a <a href=\"https://opensource.com/article/18/8/what-how-makefile\" class=\"markdown-link\">Makefile</a> into the project. A Makefile is a text file containing a set of instructions (rules) that specify how to build the project. The rules specify the dependencies and the commands needed to build or update them. Traditionally used for C/C++ projects, a Makefile can also make life more convenient by reducing the amount of typing needed to run commonly used commands on any project.</p>\n<p class=\"markdown-para\">For example, in the previous section, we saw that to run a Rails server within the Docker container required:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash -c &quot;./scripts/run_dev.sh&quot;</span></span></code></pre>\n<p class=\"markdown-para\">If you were to add the following <code>Makefile</code> in the project root:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"makefile\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">server</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp bash -c &quot;./run_dev.sh&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Then you could run this at the terminal to start the Rails server:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">make server</span></span></code></pre>\n<p class=\"markdown-para\">There's still a problem though, if you don't remember to first start the container, running <code>make server</code> will result in an error like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">service &quot;myapp&quot; is not running container #1</span></span></code></pre>\n<p class=\"markdown-para\">This can be solved with task dependencies. We can add a <code>start</code> task that will check if the container isn't already running, then start it, and then have the <code>server</code> task depend on the <code>start</code> task:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"makefile\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Start the container if it isn&#39;t already running</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">start</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ./scripts/start_dev_container.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run the `start` task before the `server` task</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">server</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp bash -c &quot;./run_dev.sh&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Where the <code>start_dev_container.sh</code> script attempts to run an echo statement in the container, and then inspects the return code. If the container is not started, this would error and the return code will be non-zero. If we get a non-zero return code, then we start the container in the background. Place the following in the <code>scripts</code> directory of your project and run <code>chmod +x scripts/start_dev_container.sh</code> to make it executable:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> myapp </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;dev container is running&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ret=$?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[[ $ret </span><span class=\"mtk7\">-ne</span><span class=\"mtk1\"> 0 ]] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> docker-compose up -d</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">exit</span><span class=\"mtk1\"> 0</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nMakefiles are primarily designed to work on *nix operating systems like Linux and macOS, which have a Unix-like shell environment that supports the make command. However, if you're using Windows, you can still use Makefiles by installing the <a class=\"markdown-link\" href=\"https://learn.microsoft.com/en-us/windows/wsl/install\">Windows Subsystem for Linux</a>, which allows you to run a Linux environment directly on top of Windows.\n</aside>\n<p class=\"markdown-para\">You can add the most common Rails commands to the Makefile, making each dependent on the <code>start</code> task. Here's what I use, feel free to add more as per your projects needs:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"makefile\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Start the dev container if it&#39;s not already running.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">start</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ./scripts/start_dev_container.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Stop the dev container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">stop</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose stop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Display dev container status.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">status</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose ps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Start a Rails server.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">server</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp bash -c &quot;./run_dev.sh&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Launch a shell in container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">shell</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Launch a Rails console.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">console</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp rails c</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Migrate database.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">migrate_db</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">docker-compose</span><span class=\"mtk1\"> </span><span class=\"mtk5\">exec</span><span class=\"mtk1\"> </span><span class=\"mtk5\">myapp</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rake</span><span class=\"mtk1\"> </span><span class=\"mtk5\">db</span><span class=\"mtk1\">:migrate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Rollback database.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">rollback_db</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">docker-compose</span><span class=\"mtk1\"> </span><span class=\"mtk5\">exec</span><span class=\"mtk1\"> </span><span class=\"mtk5\">myapp</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rake</span><span class=\"mtk1\"> </span><span class=\"mtk5\">db</span><span class=\"mtk1\">:rollback</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Drop db, create db, load schema, custom seeds.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">reset_db</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">docker-compose</span><span class=\"mtk1\"> </span><span class=\"mtk5\">exec</span><span class=\"mtk1\"> </span><span class=\"mtk5\">myapp</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rake</span><span class=\"mtk1\"> </span><span class=\"mtk5\">db</span><span class=\"mtk1\">:reset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run all the RSpec tests: make test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># To run a specific test: SPECS=&quot;path/to/the_spec.rb&quot; make test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">test</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp rspec </span><span class=\"mtk10\">$$</span><span class=\"mtk1\">SPECS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run the linter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">rubocop</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp rubocop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Display all available routes.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">routes</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp rake routes</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"drawbacks\" style=\"position:relative;\"><a href=\"#drawbacks\" aria-label=\"drawbacks permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Drawbacks</h2>\n<p class=\"markdown-para\">There are some drawbacks with this approach. There's some increased complexity in having to learn new tooling for those not already familiar with Docker and docker-compose. Also the commands are slower to run within the container as compared to running directly on the laptop.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered how to use Docker and docker-compose to run an old Ruby on Rails project that doesn't easily install on the newer ARM-based Macs. We've learned how to build an image, run a container from this image, and use <code>exec</code> to run commands in the container. Finally we covered how to use a Makefile with dependencies to save on some typing of lengthy commands.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":9,"tableOfContents":"<ul>\n<li><a href=\"#docker-image\">Docker Image</a></li>\n<li><a href=\"#docker-compose\">Docker Compose</a></li>\n<li><a href=\"#docker-container\">Docker Container</a></li>\n<li><a href=\"#rails-server\">Rails Server</a></li>\n<li><a href=\"#other-commands\">Other Commands</a></li>\n<li><a href=\"#combining-commands\">Combining Commands</a></li>\n<li><a href=\"#even-less-typing\">Even Less Typing</a></li>\n<li><a href=\"#drawbacks\">Drawbacks</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>","frontmatter":{"title":"Old Ruby and New Mac","date":"01 Jun 2023","description":"Run an old Ruby on Rails project on an ARM based Mac using Docker","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#a8b8a8","images":{"fallback":{"src":"/static/891a432040b9dec710096ad8bac91eed/0139d/ruby-in-box.png","srcSet":"/static/891a432040b9dec710096ad8bac91eed/19d75/ruby-in-box.png 225w,\n/static/891a432040b9dec710096ad8bac91eed/a5858/ruby-in-box.png 450w,\n/static/891a432040b9dec710096ad8bac91eed/0139d/ruby-in-box.png 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/891a432040b9dec710096ad8bac91eed/a90ad/ruby-in-box.webp 225w,\n/static/891a432040b9dec710096ad8bac91eed/f657c/ruby-in-box.webp 450w,\n/static/891a432040b9dec710096ad8bac91eed/c4412/ruby-in-box.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":506}}}},"fields":{"slug":"/blog/old-ruby-new-mac/"}},"relatedP":{"edges":[{"node":{"id":"46775b70-43f2-584d-8c65-327ac46ebbd7","frontmatter":{"title":"Dockerize a Rails Application for Development","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#d8c8d8","images":{"fallback":{"src":"/static/3281f20a27a3ba24dcc1ca78c639c25d/26528/docker-rails-shipping-containers.jpg","srcSet":"/static/3281f20a27a3ba24dcc1ca78c639c25d/26528/docker-rails-shipping-containers.jpg 300w,\n/static/3281f20a27a3ba24dcc1ca78c639c25d/43429/docker-rails-shipping-containers.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/3281f20a27a3ba24dcc1ca78c639c25d/5d6c3/docker-rails-shipping-containers.webp 300w,\n/static/3281f20a27a3ba24dcc1ca78c639c25d/68dbc/docker-rails-shipping-containers.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/dockerize-rails-app-for-dev-debug-and-testing/"}}},{"node":{"id":"848d2c81-d508-5776-ac83-fb1e50ef5848","frontmatter":{"title":"Fix Rails Blocked Host Error with Docker","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/648daf1a5b7bca42ff3729828586b2dc/26528/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.jpg","srcSet":"/static/648daf1a5b7bca42ff3729828586b2dc/26528/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.jpg 300w,\n/static/648daf1a5b7bca42ff3729828586b2dc/43429/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/648daf1a5b7bca42ff3729828586b2dc/5d6c3/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.webp 300w,\n/static/648daf1a5b7bca42ff3729828586b2dc/68dbc/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-blocked-host-docker-fix/"}}},{"node":{"id":"e033086f-0522-5adf-b26c-0299558696b4","frontmatter":{"title":"Private Gems and Docker for Development","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/14da36a04e01f39b6b23d267aba79030/26528/private-gem-ilze-lucero-jLWLxX6i3R8-unsplash.jpg","srcSet":"/static/14da36a04e01f39b6b23d267aba79030/26528/private-gem-ilze-lucero-jLWLxX6i3R8-unsplash.jpg 300w,\n/static/14da36a04e01f39b6b23d267aba79030/43429/private-gem-ilze-lucero-jLWLxX6i3R8-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/14da36a04e01f39b6b23d267aba79030/5d6c3/private-gem-ilze-lucero-jLWLxX6i3R8-unsplash.webp 300w,\n/static/14da36a04e01f39b6b23d267aba79030/68dbc/private-gem-ilze-lucero-jLWLxX6i3R8-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/private-gems-and-docker-dev/"}}}]}},"pageContext":{"slug":"/blog/old-ruby-new-mac/","relatedPosts":["Dockerize a Rails Application for Development","Fix Rails Blocked Host Error with Docker","Private Gems and Docker for Development"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}