{"componentChunkName":"component---src-templates-post-js","path":"/blog/roll-your-own-search-service-for-gatsby-part2/","result":{"data":{"markdownRemark":{"html":"<p>This is the second in a multi-part series of posts detailing how I built the search feature for this blog. In this post, I will explain how I built the search index.</p>\n<p>In case you missed it, <a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> covers the existing options for adding search to a Gatsby site, and why I decided not to use any of them, and instead build a custom search service using PostgreSQL <a href=\"https://www.postgresql.org/docs/13/textsearch.html\">Full Text Search</a>  and Rails.</p>\n<h2>Document Model</h2>\n<p>The first step in building the search service is to design a database table containing the content to be searched. Since the posts on this blog are written in markdown, this will be all the text in the markdown files. The table also needs to contain enough information for the search results page on the client (this blog) to render the results and make each result clickable to link to the original content.</p>\n<p>The search service is built as a Rails project. To get started, a new Rails project can be scaffolded with <code>rails new myapp -d=postgresql</code>. Or in my case, I already have a Rails project that provides some custom analytics for the blog, so I'm adding the search service to it.</p>\n<p>Here is the migration to add the <code>documents</code> table. The <code>text</code> type is used for columns whose contents could get very large such as the <code>body</code>, which will contain the markdown content of each blog post.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateDocuments</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:documents</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.text </span><span class=\"mtk4\">:description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.date </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.text </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.text </span><span class=\"mtk4\">:excerpt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_index </span><span class=\"mtk4\">:documents</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">unique:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Running this migration generates a table that looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                                           Table &quot;public.documents&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Column    |              Type              | Collation | Nullable |                Default</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------+--------------------------------+-----------+----------+---------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> id           | bigint                         |           | not null | nextval(&#39;documents_id_seq&#39;::regclass)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> title        | character varying              |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> description  | text                           |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> category     | character varying              |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> published_at | date                           |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> slug         | character varying              |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> body         | text                           |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> created_at   | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> updated_at   | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> excerpt      | text                           |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;documents_pkey&quot; PRIMARY KEY, btree (id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_documents_on_title&quot; UNIQUE, btree (title)</span></span></code></pre>\n<h2>Document Table Example Row</h2>\n<p>Next step in building the search index is to populate the table with content from this blog.</p>\n<p>The following illustrates how each field in the <code>documents</code> table should be mapped to content from the blog:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ef668c37a9ef5f809f9d2a4872136ce8/e8d6f/search-fields.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.46190102120974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABeklEQVQoz2VS2XarMAzM//9e05ZAaNobkrAZ450lZK5k0nR7mCNb4NGMpE1wA3qhoIWFES7C2wGDHyP4+3VasMy3B/g+j9c/4PxGtj2S7Q7Za47kKcVum2H3nGKf5Dhk7xFcUEn9ABda5uVe6AtMuvFuQlMpmN6h7wyk4EeWzjoqncJMKkkpnT/jSLl5uBLxDKMCtPSwenWyGfyE8tShPiq0hYY4GdSFQXnUaM+eEP6giXmP5mLxkTeoL4qKTSsh20lfU2TJHulLFsF2OX7kBS5HQQ971GeJsuAzFb54iDKgqxyKdwHVedyut7tlki0astpqVOeOCNoYK1JdnloikLD9CCPJWhcoDgS6U47zsnUY7upWQupJW3WQtaZeODgdYu+c5r54aOqtVZ5+piGMNOFxieeJerhifkw4EkqxTjnZpkie2XqOfPdGU99H62/ZAf8OR/A2cHs4GmUjwXc81sbZCT0p88ZHVasy3sXwY/dYSURY4+9d/Lz/B2Kyr21GuoleAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"search fields\"\n        title=\"search fields\"\n        src=\"/static/ef668c37a9ef5f809f9d2a4872136ce8/5a190/search-fields.png\"\n        srcset=\"/static/ef668c37a9ef5f809f9d2a4872136ce8/772e8/search-fields.png 200w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/e17e5/search-fields.png 400w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/5a190/search-fields.png 800w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/c1b63/search-fields.png 1200w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/e8d6f/search-fields.png 1273w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7af3d15a8b57b13b426a289377243954/6da96/search-fields-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.80477223427332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAAD3klEQVQ4y3WUi09TVxzH+eM2R6HUUgoFC1gpiLqZOYhbQkxGTIjIQPcI2QgyFh0PFUQdT1tGBQQqlPdroKUtffBsCxRoKfDZuZfBlLHkfvP7nd8993POuff+vjGBtSCuBTeLDg8L75w47S4c711yTcp97mV57BD33GLOTmiXg+gh+3sHsqKR/ZNcUkxwfYP1FT/rqwE2A1uENrbZCobY2gjJcXtrh9DmtnxPqkV292RINLx/AvsQGuMYnmPKbGW+14ZzYORI1hEc1mHs/cOiPsSsxcq0uZ+xjl6G/rDwptFEz/MuwjsR9qOngPb+cSZemvnLZGGus4t3li7e94jY3cW8yGfMnYy1djDY1MzA4+f0PGqgvbKell8b2A2F5eN/BHQPjzNn6sTR+xrXgAXPkAXvsKTXuEXutIoFek3MdLYy1vKCwcZn9PxeT3dNA+HtsNjhKeDSmDiepR2vtRPfoAnfkBmfzSxHjxi7rSZc/W3Yu18wa24U0Me8ffJQqI7ImUDbG5ymp7h7mvH0teCxtgtQx4nc1jacfS9Z6G5k/s9aJlqrsT4pp6+uQuxw979AZ3sT0w/KmBMT5hursLc8wv6qFrupDntnPXMdD5lpfsBkUzmDNaW0/VJIZXE+94oLxB+wLd4hHwPnn9ViK/uWkfJibD8XM1JVhu23e7ytLqWvuoTeqiJ6Km/z6qdbPL2bzw+FX3Dz61zyC/Lk3+lw/xRwprYGW1Ehzbe+oeSSnjtGPXevZlJ0JZ2C7DRuGlPJy9Jh1GtI0yaQKeYYrl8lN+9/gK0/VvB9RjYlWTnc0CZxLTmRG/oUvkzXcU2vJSdVgyFZTYoqDk28Ak1iIgmaFNINOWydBay4c5/0z85z/UIWeReNGLUpfJVzhc+zc7lsvEyWIQvDxUskqzVoE5NISkrl3CcK0lIzzgaW3i5GF6vGkKRHr05Fp9Ji0GWSocsgTZdOSvIFAUkjPk6FQpGAUqnm3KdxJGtT5VaUgHsftGFMadF3JMUlolNr0cQloI5TolaqUMerOB+fgEqMVYp4lLGxQgp5rFQoyUjLkL8yB+IS7XfwTwvGSI4yOTrF1Pg0E6OTjI9OyHFqfErECbkuaVLUxkRXTY4d1Wcn59lYCxMKRvCvSiYSkaExktN4F314XD7ZqnyLS3IuySvyJc8K60sBVr1+VpfWWfGusuwVteWg6OUokZ3oEXAzfARc9q0I71uUtSg80O30ygtI/ni8kH8tQGA9SNC/IUvy0M3A5smHONw//PfI/tUga8t++QFpt5Lv7e1GhTXtyd4naXc7IhSWJVnWcYxGjiDHkuB/A9Zon2LslsONAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"search fields 2\"\n        title=\"search fields 2\"\n        src=\"/static/7af3d15a8b57b13b426a289377243954/5a190/search-fields-2.png\"\n        srcset=\"/static/7af3d15a8b57b13b426a289377243954/772e8/search-fields-2.png 200w,\n/static/7af3d15a8b57b13b426a289377243954/e17e5/search-fields-2.png 400w,\n/static/7af3d15a8b57b13b426a289377243954/5a190/search-fields-2.png 800w,\n/static/7af3d15a8b57b13b426a289377243954/6da96/search-fields-2.png 922w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>For example, to populate a row in the <code>documents</code> table for the <a href=\"../postman-alternative-vscode\">VS Code Alternative to Postman</a> blog post illustrated above, the sql would be as follows (the <code>excerpt</code> and <code>body</code> columns are shortened for legibility):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INSERT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">INTO</span><span class=\"mtk1\"> documents(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title, </span><span class=\"mtk7\">description</span><span class=\"mtk1\">, category, published_at, slug, body, created_at, updated_at, excerpt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">VALUES</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;A VS Code Alternative to Postman&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;Looking for a Postman alternative? This VS Code REST Client extension could be the answer.&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;Web Development&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;2021-06-13&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;/blog/postman-alternative-vscode/&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;If youve been doing web development for any length of time, youve probably built or worked on an HTTP REST style API and needed a REST Client to test it.&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">now</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">now</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;If youve been doing web development for any length of time, youve probably built or worked on an HTTP REST style API and needed a REST…&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2>Generate INSERT Statements from Gatsby</h2>\n<p>Of course it wouldn't be practical or scale to manually write all the INSERT statements. These need to be automatically generated. The best place to do this is in the blog build step that processes all the markdown posts.</p>\n<p>Recall this is a Gatsby blog. The blog pages are created at build time. The build step runs a file named <code>gatsby-node.js</code> in the root of the blog project. This file exports a function called <code>createPages</code>, which executes a <code>graphql</code> query to get all the markdown content. The graphql query returns a list of nodes that contain the markdown content such as title, category, publish date etc. These are used to create each individual blog page using the Gatsby provided <code>createPage</code> function.</p>\n<p>So this is the perfect place to generate some sql <code>INSERT</code> statements, and write them out to a <code>search.sql</code> file. Here is the existing <code>createPages</code> function.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// gatsby-node.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\">.</span><span class=\"mtk5\">createPages</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">graphql</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">actions</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { createPage } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> actions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        allMarkdownRemark(sort: { fields: [frontmatter___date], order: DESC }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                date(formatString: &quot;YYYY-MM-DD&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              excerpt,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              html,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              rawMarkdownBody</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    `</span><span class=\"mtk1\">).</span><span class=\"mtk5\">then</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">result</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result.data.allMarkdownRemark.edges.</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(({ </span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// build individual blog pages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">createPage</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          path: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          component: path.</span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;./src/templates/post.js&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          context: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            slug: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            content: node.html,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            title: node.frontmatter.title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            description: node.frontmatter.description,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And here is the modified <code>createPages</code> function that also generates SQL <code>INSERT</code> statements to populate the <code>documents</code> table. The existing <code>createPages</code> function is already fairly lengthy, so the new logic is placed in a new search helper module. The generated insert statement is appended to a <code>search.sql</code> file in the project root. This file is git ignored because it is a generated file.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// gatsby-node.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> searchHelper </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./lib/search-helper&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\">.</span><span class=\"mtk5\">createPages</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">graphql</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">actions</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { createPage } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> actions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        allMarkdownRemark(sort: { fields: [frontmatter___date], order: DESC }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    `</span><span class=\"mtk1\">).</span><span class=\"mtk5\">then</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">result</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// NEW CODE HERE: wipe out old search file if it exists</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (fs.</span><span class=\"mtk5\">existsSync</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;search.sql&#39;</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fs.</span><span class=\"mtk5\">unlinkSync</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;search.sql&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result.data.allMarkdownRemark.edges.</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(({ </span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">createPage</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// NEW CODE HERE: generate search insert statements for search service</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        insertStatement </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> searchHelper.</span><span class=\"mtk5\">generateInsert</span><span class=\"mtk1\">(node)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fs.</span><span class=\"mtk5\">appendFileSync</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;search.sql&#39;</span><span class=\"mtk1\">, insertStatement </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The new <code>searchHelper</code> module exposes a <code>generateInsert</code> function that takes in a <code>node</code> result from the graphql query and uses the fields in <code>node</code> to generate an INSERT statement. Newlines and some markdown format characters are removed from the content since they're not necessary for being searched.</p>\n<p>As for knowing how to parse a <code>node</code> object into fields such as <code>title</code>, <code>description</code>, this comes from <a href=\"https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-transformer-remark\">gatsby-transformer-remark</a>. A Gatsby plugin I use on this blog to parse Markdown files.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/search-helper.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">generateInsert</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk6\">`INSERT INTO documents(title, description, category, published_at, slug, body, created_at, updated_at, excerpt)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    VALUES(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.frontmatter.title)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.frontmatter.description)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.frontmatter.category</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.frontmatter.date</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.fields.slug</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.rawMarkdownBody)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      now(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      now(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.excerpt)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  `</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">str</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> str</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/(?:</span><span class=\"mtk4\">\\r\\n</span><span class=\"mtk7\">|</span><span class=\"mtk4\">\\r</span><span class=\"mtk7\">|</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">)/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/&#39;/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/&quot;/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/#/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/`/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  generateInsert,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2>Ingest Documents</h2>\n<p>The final step in building the search index is to apply all the SQL <code>INSERT</code> statements generated in <code>search.sql</code> to the <code>documents</code> table in the Rails project. Here is the command to do it against the local PostgreSQL database. My database and user are named <code>hello</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">psql -h 127.0.0.1 -d hello -U hello -f /path/to/search.sql</span></span></code></pre>\n<p>To verify it worked, connect to to the database and run a query. <code>body</code> column is shortened for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hello=&gt; select title, category, slug, left(body, 20) as body from documents;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                               title                                |     category     |                          slug                           |         body</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------------------------------------------------------------+------------------+---------------------------------------------------------+----------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Roll Your Own Search Service with Rails and Postgres: Search Index | web development  | /blog/roll-your-own-search-service-for-gatsby-part2/    |  This is the second</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Roll Your Own Search Service with Rails and Postgres: Introduction | web development  | /blog/roll-your-own-search-service-for-gatsby-part1/    |  This is the first i</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Add a Language to gatsby-remark-vscode                             | web development  | /blog/add-language-gatsby-remark-vscode/                |  This blog is built</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> A VS Code Alternative to Postman                                   | Web Development  | /blog/postman-alternative-vscode/                       |  If youve been doing</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails CORS Middleware For Multiple Resources                       | rails            | /blog/rails-cors-middleware-multiple/                   |  A short post for to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                                       | javascript       | /blog/tdd-by-example-bugfix/                            |  This post will demo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Saving on monthly expenses - A Cautionary Tale                     | personal finance | /blog/save-monthly-expense-caution/                     |  Today I want to sha</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails Blocked Host Solved by Docker Cleanup                        | rails            | /blog/rails-blocked-host-docker-clean/                  |  Today I want to sha</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Hack Your RRSP Tax Refund                                          | personal finance | /blog/hack-your-rrsp-refund/                            |  Ah spring is in the</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Using Herokus pg:pull with Docker                                  | PostgreSQL       | /blog/heroku_pg_pull_and_docker/                        |  **TLDR:** Use PG_HO</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Build and Publish a Presentation with RevealJS and Github          | web development  | /blog/build-and-publish-presentation-with-html-and-css/ |  If youve ever given</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby                        | ruby             | /blog/python-interview-question-in-ruby/                |  A few months ago, I</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Automate Tabs &amp; Commands in iTerm2                                 | terminal         | /blog/iterm-automation/                                 |  Do you find yoursel</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Debug Github Actions                                               | rails            | /blog/debug-github-action/                              |  A few weeks ago I w</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                                                     | javascript       | /blog/tdd-by-example/                                   |  If youve been codin</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Promotional interest rates and the fine print                      | personal finance | /blog/emergency-fund-fine-print/                        |  Taking a break from</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Improve Productivity with VS Code Snippets                         | vscode           | /blog/improve-productivity-with-vs-code-snippets/       |  Have you ever found</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Construct a PATCH request for a JSON API                           | rails            | /blog/patch-request-with-json-api/                      |  Im currently buildi</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Use UUID for primary key with Rails and Postgres                   | rails            | /blog/rails-uuid-primary-key-postgres/                  |  When working with R</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Start a Rails 6 Project with RSpec                                 | rails            | /blog/start-rails-6-project-with-rspec/                 |  Currently at work I</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Find Jira Tickets Faster                                           | productivity     | /blog/find-jira-tickets-faster/                         |  A short blog post f</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> View Localhost on Your Phone                                       | web development  | /blog/phone-localhost/                                  |  A common occurrence</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Dockerize a Rails Application for Development                      | rails            | /blog/dockerize-rails-app-for-dev-debug-and-testing/    |  At work, I was rece</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> VS Code Shell Integration                                          | vscode           | /blog/vscode-shell-integration/                         |  Today Im going to s</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Is a Career in Software Development Right for You?                 | career           | /blog/is-career-in-software-development-right-for-you/  |  A career in softwar</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> What Makes a Good Podcast                                          | podcasts         | /blog/what-makes-a-good-podcast/                        |  I absolutely love p</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Off with the Digital Distractions!                                 | productivity     | /blog/off-with-the-digital-distractions/                |  As a programmer, it</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Access Chrome Bookmarks with Keyboard                              | productivity     | /blog/how-to-access-chrome-bookmarks-via-keyboard/      |  If you frequently u</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Crossword Solver with CentOS                                       | just for fun     | /blog/crossword-solver-with-centos/                     |  If you enjoy crossw</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Navigate Back &amp; Forth in VS Code                                   | vscode           | /blog/how-to-navigate-back-and-forth-in-vscode/         |  If you come from a</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> How to Learn New Things                                            | career           | /blog/how-to-learn-new-things/                          |  As a software devel</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> How I Setup my Terminal                                            | terminal         | /blog/how-i-setup-my-terminal/                          |  Have you ever seen</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(32 rows)</span></span></code></pre>\n<h2>Search Index Maintenance</h2>\n<p>One more thing to consider is how to maintain the search index going forward, as more documents are added to the blog. Recall the <code>title</code> field in the <code>documents</code> table is unique, so attempting to insert the same documents would cause an error. The solution is to use the <code>UPSERT</code> feature in PostgreSQL, which is a special syntax to specify what should happen in the case of a conflicting <code>INSERT</code>.</p>\n<p>In my case, I'm keeping it simple and doing nothing, which will basically only insert new records when the <code>search.sql</code> file is loaded. To specify this behavior, the generated <code>INSERT</code> statements need to be modified to specify the <code>ON CONFLICT</code> instructions. Recall these statements are generated in the search helper module in the Gatsby blog project.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/search-helper.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">generateInsert</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk6\">`INSERT INTO documents(title, description, category, published_at, slug, body, created_at, updated_at, excerpt)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    VALUES(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.frontmatter.title)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.frontmatter.description)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.frontmatter.category</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.frontmatter.date</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.fields.slug</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.rawMarkdownBody)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      now(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      now(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.excerpt)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    ON CONFLICT (title)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    DO NOTHING;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  `</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">str</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  generateInsert,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This way, every time I add a new article to my blog, I can safely reload the generated <code>search.sql</code> into the <code>documents</code> table.</p>\n<h2>What's Next?</h2>\n<p>So now the <code>documents</code> table is fully populated and ready to be used for search. Next up, see <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> for how to use the built-in PostgreSQL search functions to search the documents.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search Index","date":"04 Jul 2021","description":"Learn how to build search service using Rails and Postgres Full Text Search for a Gatsby blog.","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAC3UlEQVQozx3S7U8McADA8V9PN2TGEMuG2DxNXpArF3W6S1EpXVE7lPSkK487T8sxz8woD5lwksyoIZdud5yuUtwTurrraok0NjazeevF1/EPfLbv9hX2Wztw3NPSVqvFcGE7+gOJ+B7t48pOBePHhBAUGMA4STCH187m86lo6vIjqSzbhDYvhby0OAozk6lQZ3KodCulOemIOt0mLpUrOF4Yy6U9qxhtPUzn9R0smxmKEIKc6Lm8PpCM92gqn87k0qHN5kRRhh9SkKWUkRK3HOmShaTIZdQc1yIKEmZyOn8GupIJHCuUULZyMlHTJSwOn8jRgiR69bvxXVBjP5KFozILY5GC6i0JrJb6kXgpKnkMmvRkcpLkaNQqRO7CADbKQkiICUEZKWF/tpSGk8X8sFyEd3r+2K9jrS7BtCeRHl025pJ1GE4cZF9xCelrEohZsogV8yLIiI1i6/okROpswbRQyf88SbCEK7tVfqSO390N/Gyv5WvLeX9WJKql86lMkqHbmEKvycqwy4fnrRvzEyO1VTWUb1OTtlqKOLI9A/NNHRW5SiLnhKNRzGPk8Tm+WxsYtdTzrasAU9MkysrGIJOFkpYYhcf6kgGHG5/Tw3DfJ0YHvzPkHqar9RmiVD6f5iotg+Z6vK238Ty7yddXD3A8vEpRZhwHNdN4/mABNsssLA/zMNy5zPDbTj6+d9Pv6sHr7MXj7KfPOYDX9RERP1mQHiHYpYzg/rFiPjTrGel4yuf2JmyPaji7q4L89UpO792M09DMtw92vrjeMGRzMWDvx+cYxGPzo45+bAYjInpSIPKpQawLF2T74fJVYVzdmUlHQzVf7BZ+9XXhNT3GbWxmxGZlsLudoe43vDffxdK0AUO9f6WWRtyWTnRZsYiVU/6BgSjCglgzPfg/nDpDoF48llN5Sgw3ztPz4gm+ThOeNiPe9jbcLxvpborHoA/g2hlBY42GqiIVGbMEfwFgdOd/wvuNVAAAAABJRU5ErkJggg==","aspectRatio":1.9424778761061947,"src":"/static/e5f242a775f73c871cb77ac471f55e1a/ee604/roll-search-2.png","srcSet":"/static/e5f242a775f73c871cb77ac471f55e1a/69585/roll-search-2.png 200w,\n/static/e5f242a775f73c871cb77ac471f55e1a/497c6/roll-search-2.png 400w,\n/static/e5f242a775f73c871cb77ac471f55e1a/ee604/roll-search-2.png 800w,\n/static/e5f242a775f73c871cb77ac471f55e1a/f3583/roll-search-2.png 1200w,\n/static/e5f242a775f73c871cb77ac471f55e1a/5707d/roll-search-2.png 1600w,\n/static/e5f242a775f73c871cb77ac471f55e1a/7427d/roll-search-2.png 1756w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part2/"}}},"pageContext":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part2/","content":"<p>This is the second in a multi-part series of posts detailing how I built the search feature for this blog. In this post, I will explain how I built the search index.</p>\n<p>In case you missed it, <a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> covers the existing options for adding search to a Gatsby site, and why I decided not to use any of them, and instead build a custom search service using PostgreSQL <a href=\"https://www.postgresql.org/docs/13/textsearch.html\">Full Text Search</a>  and Rails.</p>\n<h2>Document Model</h2>\n<p>The first step in building the search service is to design a database table containing the content to be searched. Since the posts on this blog are written in markdown, this will be all the text in the markdown files. The table also needs to contain enough information for the search results page on the client (this blog) to render the results and make each result clickable to link to the original content.</p>\n<p>The search service is built as a Rails project. To get started, a new Rails project can be scaffolded with <code>rails new myapp -d=postgresql</code>. Or in my case, I already have a Rails project that provides some custom analytics for the blog, so I'm adding the search service to it.</p>\n<p>Here is the migration to add the <code>documents</code> table. The <code>text</code> type is used for columns whose contents could get very large such as the <code>body</code>, which will contain the markdown content of each blog post.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateDocuments</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:documents</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.text </span><span class=\"mtk4\">:description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.date </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.text </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.text </span><span class=\"mtk4\">:excerpt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_index </span><span class=\"mtk4\">:documents</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">unique:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Running this migration generates a table that looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                                           Table &quot;public.documents&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Column    |              Type              | Collation | Nullable |                Default</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------+--------------------------------+-----------+----------+---------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> id           | bigint                         |           | not null | nextval(&#39;documents_id_seq&#39;::regclass)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> title        | character varying              |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> description  | text                           |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> category     | character varying              |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> published_at | date                           |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> slug         | character varying              |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> body         | text                           |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> created_at   | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> updated_at   | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> excerpt      | text                           |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;documents_pkey&quot; PRIMARY KEY, btree (id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_documents_on_title&quot; UNIQUE, btree (title)</span></span></code></pre>\n<h2>Document Table Example Row</h2>\n<p>Next step in building the search index is to populate the table with content from this blog.</p>\n<p>The following illustrates how each field in the <code>documents</code> table should be mapped to content from the blog:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ef668c37a9ef5f809f9d2a4872136ce8/e8d6f/search-fields.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.46190102120974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABeklEQVQoz2VS2XarMAzM//9e05ZAaNobkrAZ450lZK5k0nR7mCNb4NGMpE1wA3qhoIWFES7C2wGDHyP4+3VasMy3B/g+j9c/4PxGtj2S7Q7Za47kKcVum2H3nGKf5Dhk7xFcUEn9ABda5uVe6AtMuvFuQlMpmN6h7wyk4EeWzjoqncJMKkkpnT/jSLl5uBLxDKMCtPSwenWyGfyE8tShPiq0hYY4GdSFQXnUaM+eEP6giXmP5mLxkTeoL4qKTSsh20lfU2TJHulLFsF2OX7kBS5HQQ971GeJsuAzFb54iDKgqxyKdwHVedyut7tlki0astpqVOeOCNoYK1JdnloikLD9CCPJWhcoDgS6U47zsnUY7upWQupJW3WQtaZeODgdYu+c5r54aOqtVZ5+piGMNOFxieeJerhifkw4EkqxTjnZpkie2XqOfPdGU99H62/ZAf8OR/A2cHs4GmUjwXc81sbZCT0p88ZHVasy3sXwY/dYSURY4+9d/Lz/B2Kyr21GuoleAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"search fields\"\n        title=\"search fields\"\n        src=\"/static/ef668c37a9ef5f809f9d2a4872136ce8/5a190/search-fields.png\"\n        srcset=\"/static/ef668c37a9ef5f809f9d2a4872136ce8/772e8/search-fields.png 200w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/e17e5/search-fields.png 400w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/5a190/search-fields.png 800w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/c1b63/search-fields.png 1200w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/e8d6f/search-fields.png 1273w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7af3d15a8b57b13b426a289377243954/6da96/search-fields-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.80477223427332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAAD3klEQVQ4y3WUi09TVxzH+eM2R6HUUgoFC1gpiLqZOYhbQkxGTIjIQPcI2QgyFh0PFUQdT1tGBQQqlPdroKUtffBsCxRoKfDZuZfBlLHkfvP7nd8993POuff+vjGBtSCuBTeLDg8L75w47S4c711yTcp97mV57BD33GLOTmiXg+gh+3sHsqKR/ZNcUkxwfYP1FT/rqwE2A1uENrbZCobY2gjJcXtrh9DmtnxPqkV292RINLx/AvsQGuMYnmPKbGW+14ZzYORI1hEc1mHs/cOiPsSsxcq0uZ+xjl6G/rDwptFEz/MuwjsR9qOngPb+cSZemvnLZGGus4t3li7e94jY3cW8yGfMnYy1djDY1MzA4+f0PGqgvbKell8b2A2F5eN/BHQPjzNn6sTR+xrXgAXPkAXvsKTXuEXutIoFek3MdLYy1vKCwcZn9PxeT3dNA+HtsNjhKeDSmDiepR2vtRPfoAnfkBmfzSxHjxi7rSZc/W3Yu18wa24U0Me8ffJQqI7ImUDbG5ymp7h7mvH0teCxtgtQx4nc1jacfS9Z6G5k/s9aJlqrsT4pp6+uQuxw979AZ3sT0w/KmBMT5hursLc8wv6qFrupDntnPXMdD5lpfsBkUzmDNaW0/VJIZXE+94oLxB+wLd4hHwPnn9ViK/uWkfJibD8XM1JVhu23e7ytLqWvuoTeqiJ6Km/z6qdbPL2bzw+FX3Dz61zyC/Lk3+lw/xRwprYGW1Ehzbe+oeSSnjtGPXevZlJ0JZ2C7DRuGlPJy9Jh1GtI0yaQKeYYrl8lN+9/gK0/VvB9RjYlWTnc0CZxLTmRG/oUvkzXcU2vJSdVgyFZTYoqDk28Ak1iIgmaFNINOWydBay4c5/0z85z/UIWeReNGLUpfJVzhc+zc7lsvEyWIQvDxUskqzVoE5NISkrl3CcK0lIzzgaW3i5GF6vGkKRHr05Fp9Ji0GWSocsgTZdOSvIFAUkjPk6FQpGAUqnm3KdxJGtT5VaUgHsftGFMadF3JMUlolNr0cQloI5TolaqUMerOB+fgEqMVYp4lLGxQgp5rFQoyUjLkL8yB+IS7XfwTwvGSI4yOTrF1Pg0E6OTjI9OyHFqfErECbkuaVLUxkRXTY4d1Wcn59lYCxMKRvCvSiYSkaExktN4F314XD7ZqnyLS3IuySvyJc8K60sBVr1+VpfWWfGusuwVteWg6OUokZ3oEXAzfARc9q0I71uUtSg80O30ygtI/ni8kH8tQGA9SNC/IUvy0M3A5smHONw//PfI/tUga8t++QFpt5Lv7e1GhTXtyd4naXc7IhSWJVnWcYxGjiDHkuB/A9Zon2LslsONAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"search fields 2\"\n        title=\"search fields 2\"\n        src=\"/static/7af3d15a8b57b13b426a289377243954/5a190/search-fields-2.png\"\n        srcset=\"/static/7af3d15a8b57b13b426a289377243954/772e8/search-fields-2.png 200w,\n/static/7af3d15a8b57b13b426a289377243954/e17e5/search-fields-2.png 400w,\n/static/7af3d15a8b57b13b426a289377243954/5a190/search-fields-2.png 800w,\n/static/7af3d15a8b57b13b426a289377243954/6da96/search-fields-2.png 922w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>For example, to populate a row in the <code>documents</code> table for the <a href=\"../postman-alternative-vscode\">VS Code Alternative to Postman</a> blog post illustrated above, the sql would be as follows (the <code>excerpt</code> and <code>body</code> columns are shortened for legibility):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INSERT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">INTO</span><span class=\"mtk1\"> documents(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title, </span><span class=\"mtk7\">description</span><span class=\"mtk1\">, category, published_at, slug, body, created_at, updated_at, excerpt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">VALUES</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;A VS Code Alternative to Postman&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;Looking for a Postman alternative? This VS Code REST Client extension could be the answer.&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;Web Development&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;2021-06-13&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;/blog/postman-alternative-vscode/&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;If youve been doing web development for any length of time, youve probably built or worked on an HTTP REST style API and needed a REST Client to test it.&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">now</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">now</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;If youve been doing web development for any length of time, youve probably built or worked on an HTTP REST style API and needed a REST…&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2>Generate INSERT Statements from Gatsby</h2>\n<p>Of course it wouldn't be practical or scale to manually write all the INSERT statements. These need to be automatically generated. The best place to do this is in the blog build step that processes all the markdown posts.</p>\n<p>Recall this is a Gatsby blog. The blog pages are created at build time. The build step runs a file named <code>gatsby-node.js</code> in the root of the blog project. This file exports a function called <code>createPages</code>, which executes a <code>graphql</code> query to get all the markdown content. The graphql query returns a list of nodes that contain the markdown content such as title, category, publish date etc. These are used to create each individual blog page using the Gatsby provided <code>createPage</code> function.</p>\n<p>So this is the perfect place to generate some sql <code>INSERT</code> statements, and write them out to a <code>search.sql</code> file. Here is the existing <code>createPages</code> function.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// gatsby-node.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\">.</span><span class=\"mtk5\">createPages</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">graphql</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">actions</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { createPage } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> actions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        allMarkdownRemark(sort: { fields: [frontmatter___date], order: DESC }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                date(formatString: &quot;YYYY-MM-DD&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              excerpt,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              html,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              rawMarkdownBody</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    `</span><span class=\"mtk1\">).</span><span class=\"mtk5\">then</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">result</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result.data.allMarkdownRemark.edges.</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(({ </span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// build individual blog pages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">createPage</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          path: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          component: path.</span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;./src/templates/post.js&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          context: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            slug: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            content: node.html,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            title: node.frontmatter.title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            description: node.frontmatter.description,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And here is the modified <code>createPages</code> function that also generates SQL <code>INSERT</code> statements to populate the <code>documents</code> table. The existing <code>createPages</code> function is already fairly lengthy, so the new logic is placed in a new search helper module. The generated insert statement is appended to a <code>search.sql</code> file in the project root. This file is git ignored because it is a generated file.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// gatsby-node.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> searchHelper </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./lib/search-helper&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\">.</span><span class=\"mtk5\">createPages</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">graphql</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">actions</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { createPage } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> actions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        allMarkdownRemark(sort: { fields: [frontmatter___date], order: DESC }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    `</span><span class=\"mtk1\">).</span><span class=\"mtk5\">then</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">result</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// NEW CODE HERE: wipe out old search file if it exists</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (fs.</span><span class=\"mtk5\">existsSync</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;search.sql&#39;</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fs.</span><span class=\"mtk5\">unlinkSync</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;search.sql&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result.data.allMarkdownRemark.edges.</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(({ </span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">createPage</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// NEW CODE HERE: generate search insert statements for search service</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        insertStatement </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> searchHelper.</span><span class=\"mtk5\">generateInsert</span><span class=\"mtk1\">(node)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fs.</span><span class=\"mtk5\">appendFileSync</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;search.sql&#39;</span><span class=\"mtk1\">, insertStatement </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The new <code>searchHelper</code> module exposes a <code>generateInsert</code> function that takes in a <code>node</code> result from the graphql query and uses the fields in <code>node</code> to generate an INSERT statement. Newlines and some markdown format characters are removed from the content since they're not necessary for being searched.</p>\n<p>As for knowing how to parse a <code>node</code> object into fields such as <code>title</code>, <code>description</code>, this comes from <a href=\"https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-transformer-remark\">gatsby-transformer-remark</a>. A Gatsby plugin I use on this blog to parse Markdown files.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/search-helper.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">generateInsert</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk6\">`INSERT INTO documents(title, description, category, published_at, slug, body, created_at, updated_at, excerpt)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    VALUES(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.frontmatter.title)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.frontmatter.description)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.frontmatter.category</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.frontmatter.date</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.fields.slug</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.rawMarkdownBody)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      now(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      now(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.excerpt)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  `</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">str</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> str</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/(?:</span><span class=\"mtk4\">\\r\\n</span><span class=\"mtk7\">|</span><span class=\"mtk4\">\\r</span><span class=\"mtk7\">|</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">)/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/&#39;/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/&quot;/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/#/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">replace</span><span class=\"mtk1\">(</span><span class=\"mtk6\">/`/</span><span class=\"mtk7\">g</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  generateInsert,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2>Ingest Documents</h2>\n<p>The final step in building the search index is to apply all the SQL <code>INSERT</code> statements generated in <code>search.sql</code> to the <code>documents</code> table in the Rails project. Here is the command to do it against the local PostgreSQL database. My database and user are named <code>hello</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">psql -h 127.0.0.1 -d hello -U hello -f /path/to/search.sql</span></span></code></pre>\n<p>To verify it worked, connect to to the database and run a query. <code>body</code> column is shortened for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hello=&gt; select title, category, slug, left(body, 20) as body from documents;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                               title                                |     category     |                          slug                           |         body</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------------------------------------------------------------+------------------+---------------------------------------------------------+----------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Roll Your Own Search Service with Rails and Postgres: Search Index | web development  | /blog/roll-your-own-search-service-for-gatsby-part2/    |  This is the second</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Roll Your Own Search Service with Rails and Postgres: Introduction | web development  | /blog/roll-your-own-search-service-for-gatsby-part1/    |  This is the first i</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Add a Language to gatsby-remark-vscode                             | web development  | /blog/add-language-gatsby-remark-vscode/                |  This blog is built</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> A VS Code Alternative to Postman                                   | Web Development  | /blog/postman-alternative-vscode/                       |  If youve been doing</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails CORS Middleware For Multiple Resources                       | rails            | /blog/rails-cors-middleware-multiple/                   |  A short post for to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                                       | javascript       | /blog/tdd-by-example-bugfix/                            |  This post will demo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Saving on monthly expenses - A Cautionary Tale                     | personal finance | /blog/save-monthly-expense-caution/                     |  Today I want to sha</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails Blocked Host Solved by Docker Cleanup                        | rails            | /blog/rails-blocked-host-docker-clean/                  |  Today I want to sha</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Hack Your RRSP Tax Refund                                          | personal finance | /blog/hack-your-rrsp-refund/                            |  Ah spring is in the</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Using Herokus pg:pull with Docker                                  | PostgreSQL       | /blog/heroku_pg_pull_and_docker/                        |  **TLDR:** Use PG_HO</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Build and Publish a Presentation with RevealJS and Github          | web development  | /blog/build-and-publish-presentation-with-html-and-css/ |  If youve ever given</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby                        | ruby             | /blog/python-interview-question-in-ruby/                |  A few months ago, I</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Automate Tabs &amp; Commands in iTerm2                                 | terminal         | /blog/iterm-automation/                                 |  Do you find yoursel</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Debug Github Actions                                               | rails            | /blog/debug-github-action/                              |  A few weeks ago I w</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                                                     | javascript       | /blog/tdd-by-example/                                   |  If youve been codin</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Promotional interest rates and the fine print                      | personal finance | /blog/emergency-fund-fine-print/                        |  Taking a break from</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Improve Productivity with VS Code Snippets                         | vscode           | /blog/improve-productivity-with-vs-code-snippets/       |  Have you ever found</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Construct a PATCH request for a JSON API                           | rails            | /blog/patch-request-with-json-api/                      |  Im currently buildi</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Use UUID for primary key with Rails and Postgres                   | rails            | /blog/rails-uuid-primary-key-postgres/                  |  When working with R</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Start a Rails 6 Project with RSpec                                 | rails            | /blog/start-rails-6-project-with-rspec/                 |  Currently at work I</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Find Jira Tickets Faster                                           | productivity     | /blog/find-jira-tickets-faster/                         |  A short blog post f</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> View Localhost on Your Phone                                       | web development  | /blog/phone-localhost/                                  |  A common occurrence</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Dockerize a Rails Application for Development                      | rails            | /blog/dockerize-rails-app-for-dev-debug-and-testing/    |  At work, I was rece</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> VS Code Shell Integration                                          | vscode           | /blog/vscode-shell-integration/                         |  Today Im going to s</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Is a Career in Software Development Right for You?                 | career           | /blog/is-career-in-software-development-right-for-you/  |  A career in softwar</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> What Makes a Good Podcast                                          | podcasts         | /blog/what-makes-a-good-podcast/                        |  I absolutely love p</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Off with the Digital Distractions!                                 | productivity     | /blog/off-with-the-digital-distractions/                |  As a programmer, it</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Access Chrome Bookmarks with Keyboard                              | productivity     | /blog/how-to-access-chrome-bookmarks-via-keyboard/      |  If you frequently u</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Crossword Solver with CentOS                                       | just for fun     | /blog/crossword-solver-with-centos/                     |  If you enjoy crossw</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Navigate Back &amp; Forth in VS Code                                   | vscode           | /blog/how-to-navigate-back-and-forth-in-vscode/         |  If you come from a</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> How to Learn New Things                                            | career           | /blog/how-to-learn-new-things/                          |  As a software devel</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> How I Setup my Terminal                                            | terminal         | /blog/how-i-setup-my-terminal/                          |  Have you ever seen</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(32 rows)</span></span></code></pre>\n<h2>Search Index Maintenance</h2>\n<p>One more thing to consider is how to maintain the search index going forward, as more documents are added to the blog. Recall the <code>title</code> field in the <code>documents</code> table is unique, so attempting to insert the same documents would cause an error. The solution is to use the <code>UPSERT</code> feature in PostgreSQL, which is a special syntax to specify what should happen in the case of a conflicting <code>INSERT</code>.</p>\n<p>In my case, I'm keeping it simple and doing nothing, which will basically only insert new records when the <code>search.sql</code> file is loaded. To specify this behavior, the generated <code>INSERT</code> statements need to be modified to specify the <code>ON CONFLICT</code> instructions. Recall these statements are generated in the search helper module in the Gatsby blog project.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/search-helper.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">generateInsert</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk6\">`INSERT INTO documents(title, description, category, published_at, slug, body, created_at, updated_at, excerpt)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    VALUES(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.frontmatter.title)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.frontmatter.description)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.frontmatter.category</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.frontmatter.date</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk1\">node.fields.slug</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.rawMarkdownBody)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      now(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      now(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      &#39;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(node.excerpt)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    ON CONFLICT (title)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    DO NOTHING;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  `</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">replaceMany</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">str</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  generateInsert,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This way, every time I add a new article to my blog, I can safely reload the generated <code>search.sql</code> into the <code>documents</code> table.</p>\n<h2>What's Next?</h2>\n<p>So now the <code>documents</code> table is fully populated and ready to be used for search. Next up, see <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> for how to use the built-in PostgreSQL search functions to search the documents.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","title":"Roll Your Own Search with Rails and Postgres: Search Index","description":"Learn how to build search service using Rails and Postgres Full Text Search for a Gatsby blog."}}}