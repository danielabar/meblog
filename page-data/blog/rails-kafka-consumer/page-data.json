{"componentChunkName":"component---src-templates-post-js","path":"/blog/rails-kafka-consumer/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">This post will walk through how to integrate a Kafka consumer into a Rails application in a maintainable and testable way. Why would you need to do this? Consider the following scenario: You're working on an e-commerce system that has been developed with Rails. The product details page needs to be enhanced to show whether the current product is in stock, out of stock, or only has small number of items left (eg: \"Only 3 left in stock!\"). This information comes from a legacy inventory management system that has been written in a different programming language. This legacy system is responsible for updating the inventory count based on events, such as product purchases, returns, or stock replenishments.</p>\n<p class=\"markdown-para\">In order to display this inventory information in the Rails e-commerce app, it needs the ability to communicate with the legacy inventory system. There are many <a href=\"https://en.wikipedia.org/wiki/Enterprise_Integration_Patterns\" class=\"markdown-link\">solutions</a> for enabling different systems to communicate, each with tradeoffs to consider. This post will demonstrate how <a href=\"https://kafka.apache.org/\" class=\"markdown-link\">Apache Kafka</a> can be used to solve this problem. Kafka is a distributed streaming platform that enables high-throughput, fault-tolerant, and real-time event data streaming for building scalable and event-driven applications.</p>\n<p class=\"markdown-para\">Given that the inventory information is updated based on business events, this makes it a good fit to integrate with Kafka, which is designed for event-driven systems. Using Kafka will make the integration between the legacy and e-commerce system more tolerant to large bursts of inventory events, whereas a REST/HTTP based integration might be prone to information loss in the case of temporary network or database outages.</p>\n<aside class=\"markdown-aside\">\nThis post assumes some basic knowledge of Rails (models and controllers), Kafka (producers, consumers, topics), and Docker (just enough to run a docker compose file). Looking to level up on any of these topics? Check out this guide on <a class=\"markdown-link\" href=\"https://www.akshaykhot.com/books-to-learn-ruby-and-rails/\">books for learning Rails</a>, an introductory Kafka <a class=\"markdown-link\" href=\"https://developer.confluent.io/what-is-apache-kafka/\">tutorial</a>, and Docker <a class=\"markdown-link\" href=\"https://docs.docker.com/get-started/\">getting started</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"big-picture\" style=\"position:relative;\"><a href=\"#big-picture\" aria-label=\"big picture permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Big Picture</h2>\n<p class=\"markdown-para\">Conceptually, here is what we'll be building:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTUlEQVR42m1Qy0rDQBSdT3MnIiJE8QP0K9y6cKH4aHEjKKjgQjeWglspFKVIE7NQxKIo2khjbKckadJ0HkdmkhT7OHC5J+eeM9xcwjmHlBK+H8BxHDDGIYSA0vMZpRSUdjXPdVVCSniehyiKNFc5ogYKkiWIe6Fi+luItGvwQVqpU4dzsCRW7iwjQJRho/SK+R0La8dPmNuu467RQRJSfLkUKwc2jIINo2hjqWDBaYeI/TZqjV/MbN5j9egRs1t1rF++6EeJlAKV5zYuat8oW67ub60A4Am6QYSzahPntw5OKh84rTZBg1jP3t0AhzefKJstrV/bP3p7otacBj6hD4Zs5BxjGZISOVL5jTphgsU9C8vFBxj7JhZ2TXh+P31USjCe+lmWy35ZYlqp9aOEoWS6uKq3hr3XZ3qmLNNyZHxtmW2XGibPobT/nnH8AWNkWdqcNOX4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"legacy kafka rails\"\n        title=\"legacy kafka rails\"\n        src=\"/static/468291585c9cbd21b4cb4ce7f593968b/5a190/legacy-kafka-rails-zoom.png\"\n        srcset=\"/static/468291585c9cbd21b4cb4ce7f593968b/772e8/legacy-kafka-rails-zoom.png 200w,\n/static/468291585c9cbd21b4cb4ce7f593968b/e17e5/legacy-kafka-rails-zoom.png 400w,\n/static/468291585c9cbd21b4cb4ce7f593968b/5a190/legacy-kafka-rails-zoom.png 800w,\n/static/468291585c9cbd21b4cb4ce7f593968b/c1b63/legacy-kafka-rails-zoom.png 1200w,\n/static/468291585c9cbd21b4cb4ce7f593968b/82f58/legacy-kafka-rails-zoom.png 1387w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">We'll be focusing on the Rails side of things. Assume that another team is maintaining the inventory management system and they've already modified it to produce JSON formatted messages every time there's an inventory change. Here's an example message showing that the product identified by product code <code>ABCD1234</code> has 23 units left in stock:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;product_code&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;ABCD1234&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;inventory_count&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">23</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">These messages will be produced to a Kafka topic named <code>inventory_management_product_updates</code>. When integrating Kafka, it's important for all the teams involved to agree on the topic name(s) and message formats, essentially agreeing on a \"contract\". This will ensure that the disparate systems can communicate with each other as expected.</p>\n<aside class=\"markdown-aside\">\nWhen it comes to Kafka topic naming conventions, there are many different <a class=\"markdown-link\" href=\"https://cnr.sh/essays/how-paint-bike-shed-kafka-topic-naming-conventions\">opinions</a> such as whether to include <a class=\"markdown-link\" href=\"https://www.kadeck.com/blog/kafka-topic-naming-conventions-5-recommendations-with-examples\">version numbers</a> or not. It's beyond the scope of this post to cover all of these. If your organization has already established a naming convention, use that.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"rails-product\" style=\"position:relative;\"><a href=\"#rails-product\" aria-label=\"rails product permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rails Product</h2>\n<p class=\"markdown-para\">For this demo, I used Ruby 3.1.2, Rails 7.x and the default options for a new project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ruby --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ruby 3.1.2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Rails 7.0.4.3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails new karafka_rails_consumer_demo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> karafka_rails_consumer_demo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate model product name:string code:string price:decimal inventory:integer</span></span></span></code></pre>\n<p class=\"markdown-para\">The Rails application has a <code>products</code> table to store the product name, product code, price, and inventory count. Here is the migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20230524104551_create_products.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateProducts</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:products</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">decimal</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:price</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">integer</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:inventory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the corresponding <code>Product</code> model with some validations added. I'm using the <a href=\"https://github.com/ctran/annotate_models\" class=\"markdown-link\">annotate</a> gem to automatically generate schema information as comments in the model class when migrations are run via <code>bin/rails db:migrate</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: products</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  code       :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  inventory  :integer          default(0), not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  name       :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  price      :decimal(, )      not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Product</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:price</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:inventory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">inspect</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;#&lt;Product id: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, name: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, code: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">code</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, price: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">formatted_price</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, inventory: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">inventory</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&gt;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">formatted_price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">format</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;%.2f&quot;</span><span class=\"mtk1\">, price)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nNot critical to this demo, but since the prices are stored as a decimal column in the database, a format method is added to the model, and the inspect method is overridden to use it. This is so when products are displayed in the console for debugging purposes, it will show a price like 47.53 rather than 0.4753e2. Also note that for a real application, the precision and scale would be defined such as decimal(10, 2) but this simple demo is using the default SQLite database which doesn't support specifying these.\n</aside>\n<p class=\"markdown-para\">In development, the <code>products</code> table is populated with seed data, using the <a href=\"https://github.com/faker-ruby/faker\" class=\"markdown-link\">faker</a> gem:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/seeds.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;faker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">development?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">destroy_all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">20</span><span class=\"mtk1\">.</span><span class=\"mtk5\">times</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Commerce</span><span class=\"mtk1\">.</span><span class=\"mtk5\">product_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Alphanumeric</span><span class=\"mtk1\">.</span><span class=\"mtk5\">alpha</span><span class=\"mtk1\">(</span><span class=\"mtk4\">number:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">).</span><span class=\"mtk5\">upcase</span><span class=\"mtk7\">}#{</span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Number</span><span class=\"mtk1\">.</span><span class=\"mtk5\">number</span><span class=\"mtk1\">(</span><span class=\"mtk4\">digits:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">price:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Commerce</span><span class=\"mtk1\">.</span><span class=\"mtk5\">price</span><span class=\"mtk1\">(</span><span class=\"mtk4\">range:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk7\">..</span><span class=\"mtk4\">100.0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rand</span><span class=\"mtk1\">(</span><span class=\"mtk4\">0</span><span class=\"mtk7\">..</span><span class=\"mtk4\">50</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Seeding skipped. Not in development environment.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The products can be viewed in a Rails console <code>bin/rails c</code></p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product id: 41, name: Awesome Wool Gloves, code: JANW7810, price: 47.53, inventory: 10&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product id: 42, name: Durable Steel Plate, code: BMJG7868, price: 96.25, inventory: 3&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product id: 43, name: Ergonomic Paper Bag, code: FLMA2165, price: 52.46, inventory: 6&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"install-kafka\" style=\"position:relative;\"><a href=\"#install-kafka\" aria-label=\"install kafka permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install Kafka</h2>\n<p class=\"markdown-para\">Even though we'll be focused on consuming messages in the Rails application, we're going to need to produce messages to try it out. This means we'll need access to a Kafka cluster, which includes one or more brokers, and <a href=\"https://zookeeper.apache.org/\" class=\"markdown-link\">Zookeeper</a> to manage the cluster. While you could point to a shared cluster if your organization manages their own or uses <a href=\"https://www.confluent.io/\" class=\"markdown-link\">Confluent</a> (Kafka as a service), I prefer to think of this similar to a database. In the same way that every developer working on a Rails application has their own local database installed, Kafka is also a kind of database (specifically, a raw, distributed database). It could get messy if all developers are pointing to a shared cluster, producing test messages that end up getting consumed by other developers running their own tests.</p>\n<p class=\"markdown-para\">The easiest way to set up a Kafka cluster locally is with Docker and docker-compose. Confluent provides these images in their <a href=\"https://github.com/confluentinc/cp-all-in-one\" class=\"markdown-link\">cp-all-in-one</a> repository. Just two containers are required for a minimal cluster - a broker, and a zookeeper instance. Add the following <code>docker-compose.yml</code> file to the root of the project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;2&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">zookeeper</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">confluentinc/cp-zookeeper:7.2.1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">hostname</span><span class=\"mtk1\">: </span><span class=\"mtk6\">zookeeper</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;2181:2181&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">ZOOKEEPER_CLIENT_PORT</span><span class=\"mtk1\">: </span><span class=\"mtk4\">2181</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">ZOOKEEPER_TICK_TIME</span><span class=\"mtk1\">: </span><span class=\"mtk4\">2000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">broker</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">confluentinc/cp-server:7.2.1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">hostname</span><span class=\"mtk1\">: </span><span class=\"mtk6\">broker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">zookeeper</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;9092:9092&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;9101:9101&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_BROKER_ID</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_ZOOKEEPER_CONNECT</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;zookeeper:2181&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class=\"mtk1\">: </span><span class=\"mtk6\">PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_ADVERTISED_LISTENERS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">PLAINTEXT://broker:29092,PLAINTEXT_HOST://localhost:9092</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_METRIC_REPORTERS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">io.confluent.metrics.reporter.ConfluentMetricsReporter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS</span><span class=\"mtk1\">: </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_CONFLUENT_LICENSE_TOPIC_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_CONFLUENT_BALANCER_TOPIC_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_TRANSACTION_STATE_LOG_MIN_ISR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_JMX_PORT</span><span class=\"mtk1\">: </span><span class=\"mtk4\">9101</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_JMX_HOSTNAME</span><span class=\"mtk1\">: </span><span class=\"mtk6\">localhost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">broker:29092</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_METRICS_ENABLE</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;true&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_SUPPORT_CUSTOMER_ID</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;anonymous&#39;</span></span></span></code></pre>\n<p class=\"markdown-para\">To start the containers, run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose up</span></span></code></pre>\n<p class=\"markdown-para\">Give it a few seconds to start, then check on the status in another terminal tab:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose ps</span></span></code></pre>\n<p class=\"markdown-para\">If all is well, the output should look something like this, showing that both zookeeper and a single broker are running, with the broker exposed on port 9092:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                 Name                              Command            State                       Ports</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">karafka_rails_consumer_demo_broker_1      /etc/confluent/docker/run   Up      0.0.0.0:9092-&gt;9092/tcp, 0.0.0.0:9101-&gt;9101/tcp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">karafka_rails_consumer_demo_zookeeper_1   /etc/confluent/docker/run   Up      0.0.0.0:2181-&gt;2181/tcp, 2888/tcp, 3888/tcp</span></span></code></pre>\n<aside class=\"markdown-aside\">\nThis tutorial is intentionally using just a single broker to keep the Kafka side simple. A real application would have multiple brokers with topics distributed and replicated across them for scalability and fault-tolerance. See this example <a class=\"markdown-link\" href=\"https://github.com/danielabar/kafka-getting-started-pluralsight/blob/main/docker-compose-multiple.yml\">docker-compose file</a> for a more advanced setup with multiple brokers and a <a class=\"markdown-link\" href=\"https://github.com/danielabar/kafka-getting-started-pluralsight#demo-fault-tolerance-and-resiliency\">demo</a> of how to use it.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"add-karafka-gem\" style=\"position:relative;\"><a href=\"#add-karafka-gem\" aria-label=\"add karafka gem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Add Karafka Gem</h2>\n<p class=\"markdown-para\">The Rails application needs to be enhanced so that it can consume messages from the <code>inventory_management_product_updates</code> Kafka topic. We're going to use the <a href=\"https://karafka.io/docs/\" class=\"markdown-link\">Karafka</a> gem to make the integration relatively easy. Some of the benefits of this gem include:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Abstracts complexities of working directly with the Kafka protocol.</li>\n<li class=\"markdown-list-item\">Leverages <a href=\"https://karafka.io/docs/Concurrency-and-multithreading/\" class=\"markdown-link\">multithreading</a> to achieve concurrency and high performance.</li>\n<li class=\"markdown-list-item\">Integrates easily with Rails, following <a href=\"https://karafka.io/docs/Routing/\" class=\"markdown-link\">routing</a> style conventions.</li>\n<li class=\"markdown-list-item\">Built in <a href=\"https://karafka.io/docs/Dead-Letter-Queue/\" class=\"markdown-link\">error handling</a> and retry logic.</li>\n<li class=\"markdown-list-item\">Testing utilities that make it easy to write <a href=\"https://karafka.io/docs/Testing/\" class=\"markdown-link\">automated tests</a> for consumers and producers.</li>\n<li class=\"markdown-list-item\">Provides both an open source and pro version with additional <a href=\"https://karafka.io/docs/Pro-Features-List/\" class=\"markdown-link\">advanced features</a>.</li>\n</ul>\n<p class=\"markdown-para\">To get started with Karafka, add the following to the project's <code>Gemfile</code> and then run <code>bundle install</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">gem &quot;karafka&quot;, &quot;&gt;= 2.0.34&quot;</span></span></code></pre>\n<p class=\"markdown-para\">Next run the karafka installation command which will setup some initial scaffolding:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec karafka install</span></span></code></pre>\n<p class=\"markdown-para\">This command will generate the main Karafka entrypoint file <code>karafka.rb</code> with some basic configuration, and an example topic and consumer:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># karafka.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  setup </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    config.</span><span class=\"mtk5\">kafka</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&quot;bootstrap.servers&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;127.0.0.1:9092&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    config.</span><span class=\"mtk5\">client_id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;example_app&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    config.</span><span class=\"mtk5\">consumer_persistence</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">development?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    topic </span><span class=\"mtk4\">:example</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      consumer ExampleConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Modify this file by replacing the <code>example</code> topic with the <code>inventory_management_product_updates</code> topic in the <code>routes.draw</code> block, and the example consumer with <code>ProductInventoryConsumer</code> (to be implemented shortly):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># config block...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    topic </span><span class=\"mtk4\">:inventory_management_product_updates</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      consumer ProductInventoryConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nFor this demo, there's no need to modify the default config block generated by Karafka. Recall the Kafka broker running in a docker container has exposed port 9092 so we'll be able to connect to it. In a real application, you would use environment variables to specify the location of the bootstrap servers and authentication information. There are also many more <a href=\"https://karafka.io/docs/Configuration/\" class=\"markdown-link\">configuration options</a>.\n</aside>\n<p class=\"markdown-para\">Now let's implement the <code>ProductInventoryConsumer</code> class. This is a class that inherits from <code>ApplicationConsumer</code>, which was also generated from the karafka installation command. The only method that's required to be implemented in a consumer class is the <code>consume</code> method, which will be invoked by Karafka with a batch of messages. For now, we will only log the message payload and <a href=\"https://github.com/danielabar/kafka-getting-started-pluralsight#consumer-offset-and-message-retention-policy\" class=\"markdown-link\">offset</a> to confirm messages are being received. The <code>consume</code> method also has access to the <code>topic</code> so let's log the topic name as well:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;ProductInventoryConsumer consuming Topic: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">topic.</span><span class=\"mtk5\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Message: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">,\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Offset: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">offset</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">To exercise this code, open a new terminal tab and run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec karafka server</span></span></code></pre>\n<p class=\"markdown-para\">This command initializes the Karafka application defined at <code>karafka.rb</code>, connects to the Kafka cluster specified by the <code>bootstrap.servers</code> config, starts consuming messages from the topics specified in the <code>routes.draw</code> block, and invokes the configured consumer classes to process those messages. The server will continuously listen for new messages until the process is terminated. The output of this command is as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running Karafka 2.1.0 server</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">See LICENSE and the LGPL-3.0 for licensing details</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polling messages...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polled 0 messages in 47.48299999954179ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polling messages...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polled 0 messages in 1000.3159999996424ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<p class=\"markdown-para\">In order to exercise the <code>ProductInventoryConsumer</code> code, messages need to be produced to the <code>inventory_management_product_updates</code> topic. In production, this will be done by the inventory management system. For local development, we don't have that system running on our laptops. Fortunately, Karafka can also be used to <a href=\"https://karafka.io/docs/Components/#producer\" class=\"markdown-link\">produce</a> messages. Let's try this out by launching a Rails console <code>bin/rails c</code> in another terminal tab and then enter the following code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Generate a message with the expected attributes in JSON format:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">code</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}.</span><span class=\"mtk5\">to_json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; &quot;{\\&quot;product_code\\&quot;:\\&quot;JANW7810\\&quot;,\\&quot;inventory_count\\&quot;:10}&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Produce and send a message to the `inventory_management_product_updates` topic:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">produce_async</span><span class=\"mtk1\">(</span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;inventory_management_product_updates&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">payload:</span><span class=\"mtk1\"> message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [ce1340a60c42] Async producing of a message to &#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   inventory_management_product_updates&#39; topic took 21.07400000002235 ms</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [ce1340a60c42] {:topic=&gt;&quot;inventory_management_product_updates&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   :payload=&gt;&quot;{\\&quot;product_code\\&quot;:\\&quot;JANW7810\\&quot;,\\&quot;inventory_count\\&quot;:10}&quot;}</span></span></span></code></pre>\n<p class=\"markdown-para\">After submitting the producer command, the terminal tab running the Karafka server will log output indicating the message has been consumed from topic <code>inventory_management_product_updates</code> and offset <code>0</code>. I've added some <code>=== EXPLANATIONS ===</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER STARTS PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[50b2762f16b2] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== CONSUMER INFO LEVEL LOGGING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ProductInventoryConsumer consuming: Topic: inventory_management_product_updates,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Message: {&quot;product_code&quot;=&gt;&quot;JANW7810&quot;, &quot;inventory_count&quot;=&gt;10}, Offset: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER FINISHES PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[50b2762f16b2] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 finished in 345.4149999995716ms</span></span></code></pre>\n<p class=\"markdown-para\">When there's a batch of messages ready to be processed, the <code>consume</code> method gets invoked with the <code>messages</code>, which can be iterated (in our simple case, there's only one message currently). Each of these is an instance of <a href=\"https://karafka.io/docs/code/karafka/Karafka/Messages/Message.html\" class=\"markdown-link\">Karafka::Messages::Message</a>. When the <code>payload</code> method is invoked on the <code>message</code> object, Karafka will deserialize it, which converts the raw Kafka message to a format you can work with in your Ruby code. By default, it uses JSON deserialization, which means it assumes the messages are in JSON format, and they will be deserialized into a Ruby hash. This is what's shown in the console output when we log <code>message.payload</code>. The Karafka docs have more details about <a href=\"https://karafka.io/docs/Deserialization/\" class=\"markdown-link\">deserialization</a>.</p>\n<aside class=\"markdown-aside\">\nFor those keeping count, that's three terminal tabs required to work with this application during development mode: First one to run the Kafka cluster in Docker containers, second one to run the Karafka server for consuming messages, and a third one to run a Rails console to produce messages. If you want to be able to view the output of these all at the same time, a simple way is to use the <a class=\"markdown-link\" href=\"https://iterm2.com/documentation-one-page.html\">Split Panes</a> feature of iTerm or <a class=\"markdown-link\" href=\"https://github.com/tmux/tmux/wiki\">tmux</a> for more advanced features.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"update-product\" style=\"position:relative;\"><a href=\"#update-product\" aria-label=\"update product permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Update Product</h2>\n<p class=\"markdown-para\">Now that we know we can produce and consume messages with Kafka, it's time to do the actual work of updating the product inventory. We saw from the previous exercise that a message like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;{\\&quot;product_code\\&quot;:\\&quot;JANW7810\\&quot;,\\&quot;inventory_count\\&quot;:10}&quot;</span></span></code></pre>\n<p class=\"markdown-para\">Gets deserialized to a Ruby hash when the <code>payload</code> method is invoked on it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&quot;JANW7810&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk4\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">This means the product code and inventory count can be accessed within the consumer as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Deserialize JSON message into a hash assigned to `payload`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Access payload attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Product code = </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;product_code&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># JANW7810</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Inventory count = </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;inventory_count&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># 10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">So updating the product inventory count could be done directly in the consumer like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">There are some problems with this approach as will be covered shortly, but first, let's exercise this version of the consumer to verify it works. Back in the Rails console, run the code shown below to check the inventory value of the first product, then produce a message to update it to a different value:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Check what the current inventory value is for the first product</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">inventory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 20</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Produce a message to update it to a different value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">code</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}.</span><span class=\"mtk5\">to_json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">produce_async</span><span class=\"mtk1\">(</span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;inventory_management_product_updates&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">payload:</span><span class=\"mtk1\"> message)</span></span></span></code></pre>\n<p class=\"markdown-para\">Now the tab running the Karafka server (consumer polling for messages), will show that the message has been received and the product inventory has been updated:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER STARTS PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d886a13043fd] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== RAILS DEV LOGGING FROM FINDING AND UPDATING PRODUCT ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.9ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;JANW7810&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.2ms)  begin transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Update (0.4ms)  UPDATE &quot;products&quot; SET &quot;inventory&quot; = ?, &quot;updated_at&quot; = ?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;id&quot; = ?  [[&quot;inventory&quot;, 123], [&quot;updated_at&quot;, &quot;2023-06-02 11:10:00.738034&quot;], [&quot;id&quot;, 41]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (2.1ms)  commit transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER FINISHES PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d886a13043fd] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 finished in 23.927999999839813ms</span></span></code></pre>\n<p class=\"markdown-para\">Back in the Rails console, fetch the product again and check its inventory count, it should be <code>123</code> from the Kafka message produced and consumed earlier:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">inventory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 123</span></span></span></code></pre>\n<p class=\"markdown-para\">Great it's working, ship it!</p>\n<p class=\"markdown-para\">Not so fast...</p>\n<h2 class=\"markdown-subtitle\" id=\"what-could-possibly-go-wrong\" style=\"position:relative;\"><a href=\"#what-could-possibly-go-wrong\" aria-label=\"what could possibly go wrong permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What Could Possibly Go Wrong?</h2>\n<p class=\"markdown-para\">In the previous section, we saw the happy path working. Now its time to think about things that could go wrong.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEA//EABYBAQEBAAAAAAAAAAAAAAAAAAIBA//aAAwDAQACEAMQAAABrylbNMIVf//EABoQAAICAwAAAAAAAAAAAAAAAAABAgMRE0H/2gAIAQEAAQUCkcJWtyVuDaf/xAAYEQACAwAAAAAAAAAAAAAAAAAAAQIiUf/aAAgBAwEBPwFxZbD/xAAXEQADAQAAAAAAAAAAAAAAAAAAAQIT/9oACAECAQE/AapNGx//xAAaEAACAgMAAAAAAAAAAAAAAAAAARAhIjJh/9oACAEBAAY/Ah1HDFUao//EAB0QAQABAwUAAAAAAAAAAAAAAAEAESFBEDFRYXH/2gAIAQEAAT8hilbpecaJHZ4Itpep2l//2gAMAwEAAgADAAAAEK/f/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAh8f/aAAgBAwEBPxBuEPa//8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAhUf/aAAgBAgEBPxDEMdl//8QAGhABAAMBAQEAAAAAAAAAAAAAAQARITFh4f/aAAgBAQABPxAUc267AgCdM08+xxpxMRi5wUyHCq83bLIWUzrP/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"what could possibly go wrong\"\n        title=\"what could possibly go wrong\"\n        src=\"/static/cb83bb05d8f118d8881b329eb784c7eb/4b190/what-could-go-wrong-fork-in-toaster.jpg\"\n        srcset=\"/static/cb83bb05d8f118d8881b329eb784c7eb/e07e9/what-could-go-wrong-fork-in-toaster.jpg 200w,\n/static/cb83bb05d8f118d8881b329eb784c7eb/066f9/what-could-go-wrong-fork-in-toaster.jpg 400w,\n/static/cb83bb05d8f118d8881b329eb784c7eb/4b190/what-could-go-wrong-fork-in-toaster.jpg 800w,\n/static/cb83bb05d8f118d8881b329eb784c7eb/72e01/what-could-go-wrong-fork-in-toaster.jpg 1024w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">For example, what if the inventory system sends a product code that the Rails e-commerce system doesn't have in its records? This could happen if the legacy system also manages in-store products that are not sold online, or maybe its buggy and no one quite understands how it works. Let's simulate this situation by producing a message in the Rails console for a non existing product code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;NO-SUCH-CODE&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}.</span><span class=\"mtk5\">to_json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">produce_async</span><span class=\"mtk1\">(</span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;inventory_management_product_updates&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">payload:</span><span class=\"mtk1\"> message)</span></span></span></code></pre>\n<p class=\"markdown-para\">Keep an eye on the terminal tab running the Karafka server, it will show a stack trace from attempting to consume this message:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[d886a13043fd] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.5ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO-SUCH-CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/gems/karafka-2.1.0/lib/karafka/messages/messages.rb:22:in `each&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/gems/karafka-2.1.0/lib/karafka/messages/messages.rb:22:in `each&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:3:in `consume&#39;</span></span></code></pre>\n<p class=\"markdown-para\">What's happening is that <code>nil</code> is returned from the <code>find_by</code> method, then it errors out attempting to call the <code>update!</code> method on the <code>nil</code> return:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This line returns `nil` when called with `code: &quot;NO-SUCH-CODE&quot;`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Which results in undefined method `update!` for nil:NilClass here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span></code></pre>\n<p class=\"markdown-para\">If you let the Karafka server keep running, you'll see the stack trace repeat several times, at increasing intervals of time. This is because Karafka's default behaviour is to keep retrying the failed message if an error is raised, according to a back-off strategy, up until a maximum value of 30,000 ms is reached (30 seconds), at which point, it will keep trying every 30 seconds:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d854346b76bf] Retrying of ProductInventoryConsumer after 2000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[8d4c56ce8e62] Retrying of ProductInventoryConsumer after 8000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[15a4dead41b2] Retrying of ProductInventoryConsumer after 16000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[8f894960f0ac] Retrying of ProductInventoryConsumer after 30000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># keeps retrying every 30000 ms</span></span></code></pre>\n<p class=\"markdown-para\">This behaviour is controlled by the following config settings, which get assigned default values. Here's a snippet from the Karafka source <a href=\"https://github.com/karafka/karafka/blob/master/lib/karafka/setup/config.rb\" class=\"markdown-link\">Karafka::Setup::Config</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># option [Boolean] should we use exponential backoff</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">setting </span><span class=\"mtk4\">:pause_with_exponential_backoff</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># option [Integer] what is the max timeout in case of an exponential backoff (milliseconds)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">setting </span><span class=\"mtk4\">:pause_max_timeout</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">30_000</span></span></span></code></pre>\n<p class=\"markdown-para\">Without error handling, it will keep trying to process this message, and not move on to other messages (because the offset of the bad message will not be committed). So clearly, some error handling is needed.</p>\n<h2 class=\"markdown-subtitle\" id=\"dead-letter-queue\" style=\"position:relative;\"><a href=\"#dead-letter-queue\" aria-label=\"dead letter queue permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dead Letter Queue</h2>\n<p class=\"markdown-para\">In terms of writing the least amount of application code, the easiest way to get error handling with Karafka is to configure a <a href=\"https://karafka.io/docs/Dead-Letter-Queue/\" class=\"markdown-link\">Dead Letter Queue</a> (DLQ) per each topic. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># karafka.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># config block...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    topic </span><span class=\"mtk4\">:inventory_management_product_updates</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      consumer ProductInventoryConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">dead_letter_queue</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># name this as per your organization&#39;s naming conventions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;dlq_inventory_management_product_updates&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">max_retries:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With this approach, if any error is raised during message processing, Karafka will automatically retry up to a configured number of <code>max_retries</code> (which can also be set to zero if you don't ever want it to retry). If message processing still fails after the retries are exhausted, a new message containing the same header and payload as the troublesome message will be produced to the topic specified in the <code>dead_letter_queue</code> method, in this case, <code>dlq_inventory_management_product_updates</code>.</p>\n<p class=\"markdown-para\">With the modified <code>karafka.rb</code> in place (remember to restart the karafka server <code>bundle exec karafka server</code> after making changes to <code>karafka.rb</code>), producing an inventory update message with a product code that does not exist will generate the following log messages in the Karafka server. I've annotated them with <code>=== EXPLANATION ===</code>, which shows that after consuming the bad message, Karafka will make two more attempts to process it. If those still fail, it writes the message the the topic <code>dlq_inventory_management_product_updates</code>, then moves on, waiting to consume new messages:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== START CONSUMING BAD MESSAGE ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d13504295353] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.2ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...stack trace...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== FIRST RETRY ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[fa875ec2db84] Retrying of ProductInventoryConsumer after 2000 ms on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d13504295353] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.1ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...stack trace...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== SECOND RETRY ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[76694e052832] Retrying of ProductInventoryConsumer after 4000 ms on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d13504295353] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.2ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...stack trace...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== WRITE BAD MESSAGE TO DLQ ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[23c9519eb294] Async producing of a message to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &#39;dlq_inventory_management_product_updates&#39; topic took 1.7790000000968575 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[23c9519eb294] {:topic=&gt;&quot;dlq_inventory_management_product_updates&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  :payload=&gt;&quot;{\\&quot;product_code\\&quot;:\\&quot;NO_SUCH_CODE\\&quot;,\\&quot;inventory_count\\&quot;:5}&quot;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d1e59c1bd1df] Dispatched message 1 from inventory_management_product_updates/0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  to DLQ topic: dlq_inventory_management_product_updates</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== OFFSET COMMITTED, READY TO PROCESS MORE MESSAGES ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[316f38a98a31] Pausing on topic inventory_management_product_updates/0 on offset 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[bc51bb551a3f] Polling messages...</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"error-monitoring\" style=\"position:relative;\"><a href=\"#error-monitoring\" aria-label=\"error monitoring permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Error Monitoring</h2>\n<p class=\"markdown-para\">It's also useful to capture the error messages and stack traces in your error tracking/monitoring tool of choice (Sentry, Rollback, etc.). Karafka provides a <a href=\"https://karafka.io/docs/Monitoring-and-logging/\" class=\"markdown-link\">monitoring API</a> that allows you to subscribe to instrumentation events, and deal with them as you wish.</p>\n<p class=\"markdown-para\">Add this block to the <code>karafka.rb</code> file in the project root, between the configuration block and the routes to extract the error object and stack trace from the <code>event</code> and log them. Additionally here is where you would log to whatever error monitoring service you use:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># frozen_string_literal: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  setup </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># config...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Common error handling example</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">monitor</span><span class=\"mtk1\">.</span><span class=\"mtk5\">subscribe</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;error.occurred&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |event|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    type </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> event[</span><span class=\"mtk4\">:type</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    error </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> event[</span><span class=\"mtk4\">:error</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    details </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> (error.</span><span class=\"mtk5\">backtrace</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> []).</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;An error: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">error</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of type: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">type</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> occurred, details: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">details</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Or whatever error monitoring service Airbrake, Rollbar, etc.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Sentry</span><span class=\"mtk1\">.</span><span class=\"mtk5\">capture_exception</span><span class=\"mtk1\">(error)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># topics and consumers...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now whenever an error occurs in the consumer, the message and stack trace will get logged, and additionally you can notify whatever error monitoring service you use such as Sentry, Rollbar, etc. The message that caused the error will still get produced to the DLQ as per the topic configuration.</p>\n<p class=\"markdown-para\">While we could use the DLQ, together with Karafka's built-in error monitoring and simply let Karafka deal with all errors, it will be cleaner to also have the business logic be more resilient, and ensure the system produces useful error messages. Otherwise some poor soul in production support is going to be dealing with a bunch of failed messages in the dead letter queue and have no idea what's gone wrong. That could be you if developers are also responsible for production support at your company!</p>\n<p class=\"markdown-para\">The other issue with this approach is there's some wasted processing with the retries. For example, if the product code does not exist in the e-commerce system, there's no point retrying the message because it still won't exist. While this can be mitigated by setting <code>max_retries: 0</code>, there could be other errors which should be retried such as if a network blip occurs and the database is temporarily unreachable.</p>\n<aside class=\"markdown-aside\">\nYou may have noticed that we never had to run any explicit commands to create the topics such as \"inventory_management_product_updates\" and \"dlq_inventory_management_product_updates\", they just appeared when we needed them. In development mode, Karafka will automatically create topics the first time a message is produced, if the topic does not already exist in the cluster. It will be created with default settings of one partition and a single replica, which is almost never what you would want in production. In production, you should ensure the topics have been created before deploying the consumer code.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"validation-in-consumer\" style=\"position:relative;\"><a href=\"#validation-in-consumer\" aria-label=\"validation in consumer permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Validation in Consumer</h2>\n<p class=\"markdown-para\">As a first attempt at making the code more resilient, the consumer could be modified to check if the product exists, before attempting an update, otherwise log an error and manually dispatch to the dead letter queue (Karafka will only automatically produce a message to the DLQ when an exception is raised):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> product.</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Product </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;product_code&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> does not exist&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With this in place, producing a message with an non-existing product code will result in logging an error, and the invalid message dispatched to the dead letter queue without any retries. Here's what this looks like in the Karafka server logs, again I've added <code>=== EXPLANATIONS ===</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== START CONSUMING MESSAGE ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ce8640c13bf0] Polled 1 messages in 1004.0149999996647ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ac5cf1c6d557] Consume job for ProductInventoryConsumer</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  on inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== CHECK IF PRODUCT EXISTS ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.4ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== RAILS LOGGER ERROR ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Product NO_SUCH_CODE does not exist</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== DISPATCH TO DQL ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[12cb723b4056] Async producing of a message to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &#39;dlq_inventory_management_product_updates&#39; topic took 0.9180000005289912 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[12cb723b4056] {:topic=&gt;&quot;dlq_inventory_management_product_updates&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  :payload=&gt;&quot;{\\&quot;product_code\\&quot;:\\&quot;NO_SUCH_CODE\\&quot;,\\&quot;inventory_count\\&quot;:5}&quot;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[89c41457fc4c] Dispatched message 2 from</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 to DLQ topic: dlq_inventory_management_product_updates</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ac5cf1c6d557] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 finished in 275.4199999999255ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== READY FOR MORE MESSAGES ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ce8640c13bf0] Polling messages...</span></span></code></pre>\n<p class=\"markdown-para\">While this works, the consumer is starting to get a little messy. And it will continue to get messier as more validation rules are enforced. For example, in the e-commerce system, there's a constraint that the inventory count must be greater than zero, recall the product model has:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Product</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other validations...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:inventory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Suppose the inventory management system could send negative inventory counts, or blank values. It might do this if the business rules in the legacy system are different than those in the e-commerce system, or again, it could be buggy and not enough time/people to deal with the legacy system quirks. The consumer could be modified to handle this case as well:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> product.</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Inventory count cannot be negative&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Product </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;product_code&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> does not exist&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">At this point, if the project is using <a href=\"https://rubocop.org/\" class=\"markdown-link\">Rubocop</a> with a default configuration, this code will light up with some offenses warning that the complexity of the <code>consume</code> method is too high and that the method is too long:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">app/consumers/product_inventory_consumer.rb:2:3:C: Metrics/AbcSize:Assignment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Branch Condition size for consume is too high. [&lt;3, 16, 6&gt; 17.35/17]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  def consume ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ^^^^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/consumers/product_inventory_consumer.rb:2:3: C: Metrics/MethodLength:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  def consume ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ^^^^^^^^^^^</span></span></code></pre>\n<p class=\"markdown-para\">While one could debate the max method length rule (default value is 10, perhaps 15 is reasonable), the complexity warning should not be ignored. The Rubocop <a href=\"https://docs.rubocop.org/rubocop/cops_metrics.html#metricsabcsize\" class=\"markdown-link\">Abc rule</a> calculates the complexity of a method by considering the number of assignments (A), branches (B), aka method calls, and conditions (C) and comparing it to a maximum threshold. In this case, it's calculated a score of <code>17.35</code> which exceeds the default threshold of <code>17</code>.</p>\n<p class=\"markdown-para\">One way to resolve this is to break up the <code>consume</code> method into smaller methods, for example, the validation and error handling could be extracted as separate methods. But this is just a simple example. A real application could be many more rules. For example, the e-commerce system could have a concept of active vs inactive products where only the active ones should have their inventory updated.</p>\n<aside class=\"markdown-aside\">\nAnother technique that can help with some validation issues when using Kafka is a <a class=\"markdown-link\" href=\"https://docs.confluent.io/platform/current/schema-registry/index.html\">schema registry</a>, although you will probably still want some business level validation in the application. This is an advanced topic that won't be covered in this post. You can also check out this <a class=\"markdown-link\" href=\"https://github.com/danielabar/karafka_avro_demo\">demo project</a> showing how to use the Avro schema format with a Confluent Schema Registry from a Ruby application with the Karafka gem.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"too-much-responsibility\" style=\"position:relative;\"><a href=\"#too-much-responsibility\" aria-label=\"too much responsibility permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Too Much Responsibility</h2>\n<p class=\"markdown-para\">The real issue here is that the Kafka consumer as currently written, is taking on too many responsibilities. These include:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Deserializing the message payloads received from the broker.</li>\n<li class=\"markdown-list-item\">Implementing business rules with validation on the message payload.</li>\n<li class=\"markdown-list-item\">Implementing business logic in updating the product inventory count.</li>\n<li class=\"markdown-list-item\">Producing new messages to the dead letter queue topic in case of validation errors.</li>\n</ol>\n<p class=\"markdown-para\">A useful way of thinking about this is to compare the consumer to a Rails controller. With a controller, its responsibilities should be limited to handling http requests and responses, while business logic should be delegated to services and/or models. This makes testing of business logic easier because its isolated from the complexity of http request and response handling.</p>\n<p class=\"markdown-para\">Applying this way of thinking to a Kafka consumer, we can say that it should only be concerned with Kafka-specific things such as communicating with the broker to consume and produce messages, and deserializing and serializing message payloads. To simplify the consumer, we will apply two concepts:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">A model, initialized with the message payload hash, to perform all business rule validations.</li>\n<li class=\"markdown-list-item\">A service to check if the model is valid, and only perform the business logic update if the model is valid.</li>\n</ol>\n<h2 class=\"markdown-subtitle\" id=\"model\" style=\"position:relative;\"><a href=\"#model\" aria-label=\"model permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Model</h2>\n<p class=\"markdown-para\">Typically in a Rails application, a model is a class that inherits from <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Base.html\" class=\"markdown-link\">ActiveRecord</a> and has an underlying database table. Then it has access to the <code>validates</code> and <code>validate</code> macros to perform validations such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SomeModel</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:some_attribute</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:my_custom_method?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">my_custom_method?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do some custom validation...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">These validation macros are very useful, and could help us clean up the consumer code by providing a model class whose sole responsibility is to indicate whether the message payload is valid, and if its not, list the error messages indicating what's wrong with it. But we don't have a database table specifically for the messages coming from Kafka and it would be overkill to create one. Fortunately, Rails has a solution for this. The <a href=\"https://guides.rubyonrails.org/active_model_basics.html\" class=\"markdown-link\">ActiveModel::Model</a> module can be included in any class. It provides a way to create model-like objects that have many of the same features as traditional Rails models, but are not backed by a database table.</p>\n<p class=\"markdown-para\">This new model will be named <code>ProductInventoryForm</code>. There's no naming convention on these, but the <code>Form</code> part of the name indicates that instances of this class are used to temporarily collect input data. Here is the model class, which includes <code>ActiveModel::Model</code>, defines attributes from the Kafka message <code>product_code</code> and <code>inventory_count</code>, and specifies validation using the <code>validates</code> and <code>validate</code> macros:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product_inventory_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:inventory_count</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:inventory_count</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Only invoke the `product_exists?` validation if there are no validation errors with product_code.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># For example, if product_code is blank, it doesn&#39;t make sense to try and check if it exists.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This is accomplished by specifying a &quot;stabby lamda&quot; (i.e. anonymous function) to the &quot;if&quot; hash key,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># i.e. the `validate` method accepts a hash of options, one of them being `if` to specify the conditions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># under which the given validation should run.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:product_exists?</span><span class=\"mtk1\">, </span><span class=\"mtk4\">if:</span><span class=\"mtk1\"> </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> { errors[</span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">].</span><span class=\"mtk5\">blank?</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">product_exists?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors.</span><span class=\"mtk5\">add</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">product_code</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> does not exist&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">exists?</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> product_code)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's launch a Rails console (<code>bin/rails c</code>) to experiment with this model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Instantiate an empty model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Including ActiveModel::Model exposes the `valid?` method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># We can also access the error messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#      &quot;Product code can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#      &quot;Inventory count can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#      &quot;Inventory count is not a number&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#    ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Instantiate a model with a hash to populate the attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This should be considered invalid because</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># product code does not exist and inventory is negative:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">({</span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;FOO&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">-</span><span class=\"mtk4\">5</span><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk3\">#&lt;ProductInventoryForm:0x000000010e7f93d8 @inventory_count=-5, @product_code=&quot;FOO&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run the validation rules. It runs a query against the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># products table due to the custom `product_exists?` validation.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Product Exists? (0.4ms)  SELECT 1 AS one FROM &quot;products&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;FOO&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Check the error messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     &quot;Inventory count must be greater than or equal to 0&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     &quot;Product code FOO does not exist&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Build a valid model: code exists and inventory count positive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">({</span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">15</span><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; #&lt;ProductInventoryForm:0x0000000110761540 @inventory_count=15, @product_code=&quot;JANW7810&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This time, the product code exists so the model is valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Product Exists? (0.3ms)  SELECT 1 AS one FROM &quot;products&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;JANW7810&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># And no error messages are populated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># []</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nI'm placing this in the \"app/models\" directory but if you prefer, these kind of models could go in a different directory such as \"app/form_objects\" if you want to keep them separate from the models backed by a database table. Just remember to update \"config.autoload_paths\" in \"config/application.rb\" to include the new directory.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"service\" style=\"position:relative;\"><a href=\"#service\" aria-label=\"service permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Service</h2>\n<p class=\"markdown-para\">With the <code>ProductInventoryForm</code> model in place, we have all the validation rules needed to replace the nested conditionals that are in the consumer. The next step is to introduce a service to make use of the model for validity checks, and to do the product updating.</p>\n<aside class=\"markdown-aside\">\nUnlike models, views, and controllers, a service is not a built-in Rails component, but it's very useful as a place for organizing business logic. Services are often used to encapsulate complex operations or interactions with external systems. See this RailsConf 2022 talk titled <a class=\"markdown-link\" href=\"https://youtu.be/CRboMkFdZfg\">Your Service Layer Needn't be Fancy, It Just Needs to Exist</a> to learn about the benefits of having a service layer and some practical examples how to implement it.\n</aside>\n<p class=\"markdown-para\">Create a new directory <code>app/services</code> in your project, and add the <code>UpdateProductInventoryService</code> class as shown below:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/services/update_product_inventory_service.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">UpdateProductInventoryService</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_reader</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:errors</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This will be initialized with the message payload from Kafka.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @errors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The `process` method returns true if update succeeded, false otherwise,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># with an array of error messages.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Instantiate the form object with the message payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    product_inventory_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(payload)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># If the &quot;form&quot; is valid, update product inventory, and return true.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Otherwise, populate `errors` from form validation messages, and return false.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> product_inventory_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">update_product</span><span class=\"mtk1\">(product_inventory_form)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Use the splat operator `*` to push each element of the form objects&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># validation messages to the service `errors` array.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk7\">*</span><span class=\"mtk1\">product_inventory_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Update product using `product_code` and `inventory_count` attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># from the form object.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">update_product</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">product_inventory_form</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> product_inventory_form.</span><span class=\"mtk5\">product_code</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> product_inventory_form.</span><span class=\"mtk5\">inventory_count</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This service is initialized with the message payload from Kafka, which recall, is just a hash, making it easy to test this class outside of having Kafka running. It also initializes an empty <code>errors</code> array. The <code>process</code> method instantiates a <code>ProductInventoryForm</code> with the payload, then checks if the inputs are valid by invoking the <code>valid?</code> method on the form object. Recall we saw in the previous section that the <code>valid?</code> method will run all the validation rules we defined on the form object.</p>\n<p class=\"markdown-para\">If the input is valid, it updates the product inventory by looking up the <code>product_code</code> from the form object, and updating it with the given <code>inventory_count</code> from the form object. If the input is invalid, the service <code>errors</code> array is populated with the error messages from the form object, which are available by calling <code>product_inventory_form.errors.full_messages</code>.</p>\n<p class=\"markdown-para\">Remember to tell Rails that this new directory should be auto loaded by adding the following to your configuration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/application.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">config.</span><span class=\"mtk5\">autoload_paths</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">root</span><span class=\"mtk1\">.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;services&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"refactor-consumer\" style=\"position:relative;\"><a href=\"#refactor-consumer\" aria-label=\"refactor consumer permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Refactor Consumer</h2>\n<p class=\"markdown-para\">Now that we have a model for validations, and a service for business logic, the consumer can be refactored to take on less responsibilities. This will eliminate the complexity warning from Rubocop and make the code more maintainable.</p>\n<p class=\"markdown-para\">In the version shown below, the consumer instantiates the <code>UpdateProductInventoryService</code> by passing it the message payload, and then invokes the <code>process</code> method on the service. If the <code>process</code> method does not return a truthy value, an error message is logged containing the original payload, and all the service error messages, then the message is moved to the dead letter queue:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;ProductInventoryConsumer consuming Topic: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">topic.</span><span class=\"mtk5\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Message: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">,\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Offset: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">offset</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      service </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">UpdateProductInventoryService</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(message.</span><span class=\"mtk5\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">handle_service_errors</span><span class=\"mtk1\">(message, service.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">) </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> service.</span><span class=\"mtk5\">process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">handle_service_errors</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">message</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">errors</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;ProductInventoryConsumer message invalid: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">errors.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;, &#39;</span><span class=\"mtk1\">)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered a technique for integrating Kafka into a Rails application using the <a href=\"https://karafka.io/docs/\" class=\"markdown-link\">Karafka</a> gem, including how to do error handling and use the dead letter queue. We also learned how to avoid complexity in the consumer by limiting its responsibilities to communicating with Kafka, while introducing a model for validations, and a service for business logic. This makes each component easier to maintain. This post got quite lengthy so I'm not including the tests here, but you can try out the <a href=\"https://github.com/danielabar/karafka_rails_consumer_demo\" class=\"markdown-link\">demo project</a> including tests in the <a href=\"https://github.com/danielabar/karafka_rails_consumer_demo/tree/main/spec\" class=\"markdown-link\">spec</a> directory on Github.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":28,"tableOfContents":"<ul>\n<li><a href=\"#big-picture\">Big Picture</a></li>\n<li><a href=\"#rails-product\">Rails Product</a></li>\n<li><a href=\"#install-kafka\">Install Kafka</a></li>\n<li><a href=\"#add-karafka-gem\">Add Karafka Gem</a></li>\n<li><a href=\"#update-product\">Update Product</a></li>\n<li><a href=\"#what-could-possibly-go-wrong\">What Could Possibly Go Wrong?</a></li>\n<li><a href=\"#dead-letter-queue\">Dead Letter Queue</a></li>\n<li><a href=\"#error-monitoring\">Error Monitoring</a></li>\n<li><a href=\"#validation-in-consumer\">Validation in Consumer</a></li>\n<li><a href=\"#too-much-responsibility\">Too Much Responsibility</a></li>\n<li><a href=\"#model\">Model</a></li>\n<li><a href=\"#service\">Service</a></li>\n<li><a href=\"#refactor-consumer\">Refactor Consumer</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>","frontmatter":{"title":"Add a Kafka Consumer to Rails","date":"01 Oct 2023","description":"Learn how to integrate a Kafka consumer into a Rails application","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/3a1242ce074a0db26ad4ff18f31116df/2ae8a/rails-kafka-consumer-multiple-trains-tracks.jpg","srcSet":"/static/3a1242ce074a0db26ad4ff18f31116df/8f691/rails-kafka-consumer-multiple-trains-tracks.jpg 174w,\n/static/3a1242ce074a0db26ad4ff18f31116df/8fb94/rails-kafka-consumer-multiple-trains-tracks.jpg 348w,\n/static/3a1242ce074a0db26ad4ff18f31116df/2ae8a/rails-kafka-consumer-multiple-trains-tracks.jpg 696w","sizes":"(min-width: 696px) 696px, 100vw"},"sources":[{"srcSet":"/static/3a1242ce074a0db26ad4ff18f31116df/699e9/rails-kafka-consumer-multiple-trains-tracks.webp 174w,\n/static/3a1242ce074a0db26ad4ff18f31116df/101f4/rails-kafka-consumer-multiple-trains-tracks.webp 348w,\n/static/3a1242ce074a0db26ad4ff18f31116df/79441/rails-kafka-consumer-multiple-trains-tracks.webp 696w","type":"image/webp","sizes":"(min-width: 696px) 696px, 100vw"}]},"width":900,"height":487.5}}}},"fields":{"slug":"/blog/rails-kafka-consumer/"}},"relatedP":{"edges":[{"node":{"id":"489497a9-2600-5b48-aa26-a2ea8b93b5d0","frontmatter":{"title":"Add Rubocop to an Existing Rails Project","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#181828","images":{"fallback":{"src":"/static/454ad22c79b1d6dca07caa36d2c057f3/26528/rubocop-mark-duffel-U5y077qrMdI-unsplash.jpg","srcSet":"/static/454ad22c79b1d6dca07caa36d2c057f3/26528/rubocop-mark-duffel-U5y077qrMdI-unsplash.jpg 300w,\n/static/454ad22c79b1d6dca07caa36d2c057f3/43429/rubocop-mark-duffel-U5y077qrMdI-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/454ad22c79b1d6dca07caa36d2c057f3/5d6c3/rubocop-mark-duffel-U5y077qrMdI-unsplash.webp 300w,\n/static/454ad22c79b1d6dca07caa36d2c057f3/68dbc/rubocop-mark-duffel-U5y077qrMdI-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/add-rubocop-to-legacy-project/"}}},{"node":{"id":"848d2c81-d508-5776-ac83-fb1e50ef5848","frontmatter":{"title":"Fix Rails Blocked Host Error with Docker","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/648daf1a5b7bca42ff3729828586b2dc/26528/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.jpg","srcSet":"/static/648daf1a5b7bca42ff3729828586b2dc/26528/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.jpg 300w,\n/static/648daf1a5b7bca42ff3729828586b2dc/43429/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/648daf1a5b7bca42ff3729828586b2dc/5d6c3/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.webp 300w,\n/static/648daf1a5b7bca42ff3729828586b2dc/68dbc/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-blocked-host-docker-fix/"}}},{"node":{"id":"31449f25-76f9-5e7d-b0d7-3ef436dcfd4d","frontmatter":{"title":"Rails CORS Middleware For Multiple Resources","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/5c6bfd7e0c120605610036c50102bba1/26528/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.jpg","srcSet":"/static/5c6bfd7e0c120605610036c50102bba1/26528/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.jpg 300w,\n/static/5c6bfd7e0c120605610036c50102bba1/43429/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/5c6bfd7e0c120605610036c50102bba1/5d6c3/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.webp 300w,\n/static/5c6bfd7e0c120605610036c50102bba1/68dbc/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-cors-middleware-multiple/"}}}]}},"pageContext":{"slug":"/blog/rails-kafka-consumer/","relatedPosts":["Rails CORS Middleware For Multiple Resources","Fix Rails Blocked Host Error with Docker","Add Rubocop to an Existing Rails Project"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}