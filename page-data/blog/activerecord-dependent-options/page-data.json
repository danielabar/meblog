{"componentChunkName":"component---src-templates-post-js","path":"/blog/activerecord-dependent-options/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">Rails makes defining relationships between models using Active Record associations super easy. Simply add a macro style declaration such as <code>has_one</code>, <code>has_many</code>, <code>belongs_to</code> etc. to your model and Rails will take care of maintaining the relationship. However, some thought is required when it comes to <em class=\"markdown-emphasis\">removing</em> data from the database, while maintaining data integrity such as foreign key constraints. All the Rails courses and tutorials I've done so far cover adding associations, but none have covered what happens when a record with associations needs to be removed.</p>\n<p class=\"markdown-para\">Many years ago, before the likes of GDPR and privacy concerns, the \"solution\" was to never remove any data or use <a href=\"https://stackoverflow.com/questions/378331/physical-vs-logical-hard-vs-soft-delete-of-database-record\" class=\"markdown-link\">soft delete</a>. But with increased privacy regulations and the <a href=\"https://en.wikipedia.org/wiki/Right_to_be_forgotten\" class=\"markdown-link\">right to be forgotten</a>, applications need the ability to safely remove certain data.</p>\n<p class=\"markdown-para\">The Rails Guide on <a href=\"https://guides.rubyonrails.org/association_basics.html\" class=\"markdown-link\">Active Record Associations</a> does cover deletion options. However, since there are so many options besides just for deletion, I found myself scrolling up and down through the docs and losing track of which side of the association was being referred to. Also, since different options can be specified on each side of an association, it can be tricky to reason about what would happen with various <em class=\"markdown-emphasis\">combinations</em> of options.</p>\n<p class=\"markdown-para\">A further complexity is that there are two different ways to remove an ActiveRecord model in rails: Delete and Destroy. They sound similar but do different things (more on this later). If you add that into the mix of removal options, the number of scenarios grows even further.</p>\n<p class=\"markdown-para\">In the vein of \"a picture is worth a thousand words\", I decided to build a sample Rails application and do a deep dive on all the removal options for some commonly used associations and how they behave when deleting or destroying a record. This post will walk through the results of this.</p>\n<p class=\"markdown-para\">For those in a hurry, you can skip ahead to the <a href=\"../activerecord-dependent-options/#which-should-you-use\" class=\"markdown-link\">Which Should You Use?</a> section.</p>\n<h2 class=\"markdown-subtitle\" id=\"project-setup\" style=\"position:relative;\"><a href=\"#project-setup\" aria-label=\"project setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Project Setup</h2>\n<p class=\"markdown-para\">I started by scaffolding a new Rails project with Ruby 3 and Rails 7, using the default SQLite database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">rbenv install 3.1.2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rbenv local 3.1.2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">gem install rails -v 7.0.4</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rails new learn-associations</span></span></code></pre>\n<p class=\"markdown-para\">I added the <a href=\"https://github.com/ctran/annotate_models\" class=\"markdown-link\">annotate</a> gem to add the corresponding table schema as code comments above each model class when migrations are run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Gemfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">group </span><span class=\"mtk4\">:development</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  gem </span><span class=\"mtk6\">&quot;annotate&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">I then generated several models to study the <code>belongs_to</code> and <code>has_many</code> associations. This is a very common use case. For example, in an e-commerce application a Customer has many Orders, and an Order belongs to a single Customer. Or a Product has many Sku variations, and a Sku belongs to a Product. For this sample application, I used the Book and Author models from the <a href=\"https://guides.rubyonrails.org/association_basics.html#the-belongs-to-association\" class=\"markdown-link\">Active Record Associations Guide</a>:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 771px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1UlEQVR42o2SW4/SUBSF+1ON86K+OM+++VPGqIP6KDEmmsEMGmHAUnoDuQy0lJYCvVFkuH/mNIFgxkRXss7JPjln7b3O3pKbKDSTl+h+jpvbFxiTHD9nl5hunvVqg8B+v88osNls6EYfaac5FOc15c5F9qYRvaI3kpHU4Ts+e2e8Nx/xpvKQgvOU0uycvPKMWTK/J7hYLLi2nvNl/JjLmwe8rZxRGJ5zPX1CQb5AsjwdpfuBaiOPf1dlhpFR7VyRxLOj4AHr9ZrbUZne9Ct6/xPBViHFJNjUUIxvSKOxQzR3SZcTkl8+fmARzz2MZo00TY9CorLVasV4PMaf2txtQxbrgHg+YhzahKmLqteQrL6F1beJwpgojFCUOuLMMEw8z2O5XDKZTLAsiziOabVaqKrGyPMJghDbsil9L+EMnOyt1Ol0uCpcoWoqw+GQYrFIuVymWq3iOA5JkmRCp7ZN00TTNLrdLs1mk3pdodFo0O/3kaIootfrZRXYtp3tg8EA13X5F06THCD97aIQFMLtdjurUtd1ZPlHVpUsy+iahu/79yZA7JJYdrvdkSIWloRtRVEyG4ZhUKlUCMMw67L41812+4fggdJpcBhcISK6eppI8H8s/wZBSuP/ffBHVAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"association book belongs to author\"\n        title=\"association book belongs to author\"\n        src=\"/static/e1b673483a9587c93f905077189a9903/5d030/association-book-belongs-to-author.png\"\n        srcset=\"/static/e1b673483a9587c93f905077189a9903/772e8/association-book-belongs-to-author.png 200w,\n/static/e1b673483a9587c93f905077189a9903/e17e5/association-book-belongs-to-author.png 400w,\n/static/e1b673483a9587c93f905077189a9903/5d030/association-book-belongs-to-author.png 771w\"\n        sizes=\"(max-width: 771px) 100vw, 771px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB3klEQVR42o2RXYvaYBCF83tLKXTr7d73g8IuW+i/KL0oLWXBNqBipSZN1GiiqRoTE6OJiZusipqnJIvill70wOGd92LOnDMjyMEVP+wbPjdfcqu+RvJvqE+usT2THFl2IMuy4s0RJhYN9woleM+t+oavv14h+e+oO28xrAZCPbqgbF3wUX3CN6uEnF4iTl+gaLVC4HDYPxJ0lxpl5xkVv8Qn7Sllq4SUXFKZP6emfEDoTspI+hf6rsg9OvcY2HGDvtnlHIfDg+AynvHbrzBwK4wWNdYYpOj4awlVayBEqUuUeESpxywY44cW1tSg2fzJZrNhtVqx2+1OwvFqibcYkm4XxEWPhbcY4cxMFFVGcOwpURQTLSO6WhddN5g6U0RRJIoiwjBkPB4TxzFpmuI4Dn1jQBgsubtLGI8tVLWF63pomoYgyRL9vsFgMEBRFNrtNlpXYz6fn1wlSUIQBIXoaDRCFL8jSVIh3uv1qFar9HpdVFVFOO7nuKOHy2an91gfsV6vabVaBXVdL5jX7U4Hz/MQzptyB7lt0zQLB5PJBNMc0JQkVEUpEuQu+obOerPlX3gkuN1ukWW5iJ9PHQ6HtNudYkieYL/fF8yPlP+PvecUziPmDm3b5n/x92pywT+55OH9P9j1hAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"association author has many books\"\n        title=\"association author has many books\"\n        src=\"/static/e5ba0409abfb813075ad0cefb45ceed4/e5715/association-author-has-many-books.png\"\n        srcset=\"/static/e5ba0409abfb813075ad0cefb45ceed4/772e8/association-author-has-many-books.png 200w,\n/static/e5ba0409abfb813075ad0cefb45ceed4/e17e5/association-author-has-many-books.png 400w,\n/static/e5ba0409abfb813075ad0cefb45ceed4/e5715/association-author-has-many-books.png 768w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">I also added a <code>title</code> attribute to the <code>Book</code> model to make it easier to look up individual books for removal.</p>\n<aside class=\"markdown-aside\">\nThere are many more <a href=\"https://guides.rubyonrails.org/association_basics.html#the-types-of-associations\" class=\"markdown-link\">association types</a> but this post will focus on the <code>belongs_to</code> and <code>has_many</code> as attempting to do more would make it too long. Perhaps a topic for a future blog post.\n</aside>\n<p class=\"markdown-para\">Here are the commands to generate the models, which also generate the migrations to create the tables. I also generated a <code>Post</code> model that is not associated with anything, to demonstrate the difference between <code>destroy</code> and <code>delete</code> in a simple case where there are no associated models.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># simple model with no associations to demonstrate difference between destroy and delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate model post title:string body:text</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># models with associations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate model author name:string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate model book title:string published_at:date author:references</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nPassing <code>-h</code> or <code>--help</code> to any generator command, eg: <code>bin/rails generate model -h</code> provides a complete guide to that generator. For example, if you want to know what are all the valid data types for model attributes.\n</aside>\n<p class=\"markdown-para\">Here are the migrations that are generated. Notice that the Book model has a foreign key reference to an Author since each Book belongs to one Author. The Post model is not related to anything:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreatePosts</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:posts</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">text</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateAuthors</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:authors</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">foreign_key:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">After running the migrations, here are the model classes showing that an Author has many Books and a Book belongs to an Author. The Post model has no associations. The schema information was added by the <a href=\"https://github.com/ctran/annotate_models\" class=\"markdown-link\">annotate</a> gem:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: posts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  body       :text</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  title      :string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Post</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: authors</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  name       :string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id           :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  published_at :date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  title        :string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at   :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at   :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  author_id    :integer          not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Indexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  index_books_on_author_id  (author_id)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Foreign Keys</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  author_id  (author_id =&gt; authors.id)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's seed some example Posts, Authors, and Books so that we can test what happens when trying to remove them:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/seeds.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Post is a simple model with no associations to demonstrate the difference between</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ActiveRecord methods destroy and delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Hello Post&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">body:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Learning about destroy and delete in Rails.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Another Post&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">body:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Lorem ipsum dolor sit amet, consectetur adipiscing elit.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author with multiple books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">author_ap </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Andrew Park&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author with a single book</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">author_jjk </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Julian James McKinnon&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author with no books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;John Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create 3 books for Andrew Park and just one book for Julian James McKinnon</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python Programming for Beginners&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;2022-07-20&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">author:</span><span class=\"mtk1\"> author_ap },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Machine Learning: 4 Books in 1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;2020-01-20&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">author:</span><span class=\"mtk1\"> author_ap },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python for Data Analysis&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;2021-01-20&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">author:</span><span class=\"mtk1\"> author_ap },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Computer Programming Crash Course: 7 Books in 1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;2021-01-20&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">author:</span><span class=\"mtk1\"> author_jjk }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">Run the seeds in both the development and test databases. We'll be using the development database to experiment a little, and later the test database to automate all the experiments:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails db:seed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RAILS_ENV=test bin/rails db:seed</span></span></code></pre>\n<p class=\"markdown-para\">If you want to follow along with the project, here is the <a href=\"https://github.com/danielabar/learn-associations\" class=\"markdown-link\">source</a> on Github.</p>\n<h2 class=\"markdown-subtitle\" id=\"delete-destroy\" style=\"position:relative;\"><a href=\"#delete-destroy\" aria-label=\"delete destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Delete Destroy</h2>\n<p class=\"markdown-para\">I wanted to understand what would happen when attempting to remove various Author or Book records from the database with respect to their associations. However, there's an additional complexity in that there's two different methods to remove a record, which sound similar, but do slightly different things. From the <a href=\"https://api.rubyonrails.org/\" class=\"markdown-link\">Rails API Documentation</a>:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-delete\" class=\"markdown-link\">delete</a>: Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they can't be persisted). Returns the frozen instance. The row is simply removed with an SQL <code>DELETE</code> statement on the record's primary key, and no callbacks are executed.</li>\n<li class=\"markdown-list-item\"><a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-destroy\" class=\"markdown-link\">destroy</a>: Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they can't be persisted). There's a series of callbacks associated with destroy. If the <code>before_destroy</code> callback throws <code>:abort</code> the action is cancelled and destroy returns <code>false</code>.</li>\n<li class=\"markdown-list-item\"><a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-destroy-21\" class=\"markdown-link\">destroy!</a>: Similar to <code>destroy</code>, except raises <code>ActiveRecord::RecordNotDestroyed</code> rather than returning false if the record is not destroyed.</li>\n</ul>\n<p class=\"markdown-para\">To summarize the difference, <code>delete</code> immediately invokes SQL to remove the record from the database, whereas <code>destroy/destroy!</code> first invokes the model's <code>before_destroy</code> callback which can potentially stop the deletion. I'm assuming this could be a place for cleanup code.</p>\n<p class=\"markdown-para\">To understand this with a simple case, let's modify the <code>Post</code> model, which has no associations, to add a <code>before_destroy</code> callback. This callback will simply output a message:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Post</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Post model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Launch a Rails console with <code>bin/rails c</code> and let's see how the removal methods behave:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">post </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Hello Post&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">post.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Post Destroy (3.8ms)  DELETE FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 5]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">post.</span><span class=\"mtk5\">frozen?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">another_post </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Another Post&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">another_post.</span><span class=\"mtk5\">destroy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Post model 6 will be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># TRANSACTION (0.1ms)  begin transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Post Destroy (0.5ms)  DELETE FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 6]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># TRANSACTION (1.1ms)  commit transaction</span></span></span></code></pre>\n<p class=\"markdown-para\">From the above, we can see that <code>delete</code> immediately invokes the SQL <code>DELETE</code> statement whereas <code>destroy</code> first invokes the <code>before_destroy</code> callback. Now with this understood, we can move on to removal of records with associations.</p>\n<aside class=\"markdown-aside\">\nThere is one more difference in the behaviour the delete and destroy that isn't documented. When specifying a dependent option on an ActiveRecord association, the logic for that option will only run when the destroy method is invoked, not the delete method. This will be demonstrated in the various test scenarios further in this post.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"options-matrix\" style=\"position:relative;\"><a href=\"#options-matrix\" aria-label=\"options matrix permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options Matrix</h2>\n<p class=\"markdown-para\">Recall we have Books that <code>belong_to</code> an Author, and Author's <code>have_many</code> books. Let's start by looking at the dependent options for <a href=\"https://guides.rubyonrails.org/association_basics.html#options-for-belongs-to-dependent\" class=\"markdown-link\">belongs_to</a>:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\"><code>:destroy</code> when the object is destroyed, destroy will be called on its associated objects.</li>\n<li class=\"markdown-list-item\"><code>:delete</code> when the object is destroyed, all its associated objects will be deleted directly from the database without calling their destroy method.</li>\n</ol>\n<p class=\"markdown-para\">For example, to use the <code>destroy</code> option, the Book model would look like this to indicate that whenever a Book is destroyed, its associated Author should also be destroyed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here are the dependent options for <a href=\"https://guides.rubyonrails.org/association_basics.html#dependent\" class=\"markdown-link\">has_many</a>:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\"><code>:destroy</code> causes all the associated objects to also be destroyed</li>\n<li class=\"markdown-list-item\"><code>:delete_all</code> causes all the associated objects to be deleted directly from the database (so callbacks will not execute)</li>\n<li class=\"markdown-list-item\"><code>:destroy_async</code> when the object is destroyed, an <code>ActiveRecord::DestroyAssociationAsyncJob</code> job is enqueued which will call destroy on its associated objects. Active Job must be set up for this to work.</li>\n<li class=\"markdown-list-item\"><code>:nullify</code> causes the foreign key to be set to NULL. Polymorphic type column is also nullified on polymorphic associations. Callbacks are not executed.</li>\n<li class=\"markdown-list-item\"><code>:restrict_with_exception</code> causes an ActiveRecord::DeleteRestrictionError exception to be raised if there are any associated records</li>\n<li class=\"markdown-list-item\"><code>:restrict_with_error</code> causes an error to be added to the owner if there are any associated objects</li>\n</ol>\n<p class=\"markdown-para\">For example, to use the <code>destroy</code> option, the Author model would look like this to indicate that whenever an Author is destroyed, its Books should also be destroyed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Summing up the options, there are 2 dependent options on the <code>belongs_to</code> association, plus the \"option\" to not specify anything which makes 3. There are 6 dependent options on the <code>has_many</code> association, plus the do nothing \"option\" which makes 7.</p>\n<p class=\"markdown-para\">On the <code>has_many</code> side, the <code>restrict_with_error</code> option behaves similarly to the <code>restrict_with_exception</code> except that it populates the <code>errors</code> property of the model instead of raising an exception. Similarly, the <code>destroy_async</code> option behaves similarly to the <code>destroy</code> except it does so via a job. To reduce the number of combinations and avoid the complexity of setting up ActiveJob in this analysis, will only consider <code>restrict_with_exception</code> and leave off <code>destroy_async</code>.</p>\n<p class=\"markdown-para\">This means there are 3 * 5 = 15 possible combinations of dependent options:</p>\n<table class=\"markdown-table\">\n<thead>\n<tr>\n<th>Scenario</th>\n<th>belongs_to</th>\n<th>has_many</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#1-no-options\" class=\"markdown-link\">1</a></td>\n<td>not specified</td>\n<td>not specified</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">2</a></td>\n<td>not specified</td>\n<td>:destroy</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#3-has-many-delete-all\" class=\"markdown-link\">3</a></td>\n<td>not specified</td>\n<td>:delete_all</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#4-has-many-nullify\" class=\"markdown-link\">4</a></td>\n<td>not specified</td>\n<td>:nullify</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#5-has-many-restrict-with-exception\" class=\"markdown-link\">5</a></td>\n<td>not specified</td>\n<td>:restrict_with_exception</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#6-belongs-to-destroy\" class=\"markdown-link\">6</a></td>\n<td>:destroy</td>\n<td>not specified</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#7-belongs-to-destroy-has-many-destroy\" class=\"markdown-link\">7</a></td>\n<td>:destroy</td>\n<td>:destroy</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#8-belongs-to-destroy-has-many-delete-all\" class=\"markdown-link\">8</a></td>\n<td>:destroy</td>\n<td>:delete_all</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#9-belongs-to-destroy-has-many-nullify\" class=\"markdown-link\">9</a></td>\n<td>:destroy</td>\n<td>:nullify</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#10-belongs-to-destroy-has-many-restrict-with-exception\" class=\"markdown-link\">10</a></td>\n<td>:destroy</td>\n<td>:restrict_with_exception</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#11-belongs-to-delete\" class=\"markdown-link\">11</a></td>\n<td>:delete</td>\n<td>not specified</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#12-belongs-to-delete-has-many-destroy\" class=\"markdown-link\">12</a></td>\n<td>:delete</td>\n<td>:destroy</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#13-belongs-to-delete-has-many-delete-all\" class=\"markdown-link\">13</a></td>\n<td>:delete</td>\n<td>:delete_all</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#14-belongs-to-delete-has-many-nullify\" class=\"markdown-link\">14</a></td>\n<td>:delete</td>\n<td>:nullify</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#15-belongs-to-delete-has-many-restrict-with-exception\" class=\"markdown-link\">15</a></td>\n<td>:delete</td>\n<td>:restrict_with_exception</td>\n</tr>\n</tbody>\n</table>\n<p class=\"markdown-para\">For each combination, I want to understand what happens given the following:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">An Author with no books is destroyed.</li>\n<li class=\"markdown-list-item\">An Author with a single book is destroyed.</li>\n<li class=\"markdown-list-item\">An Author with multiple books is destroyed.</li>\n<li class=\"markdown-list-item\">1 through 3 above but deleted instead of destroyed.</li>\n<li class=\"markdown-list-item\">A book belonging to an Author that only has that one book is destroyed.</li>\n<li class=\"markdown-list-item\">A book belonging to an Author that has multiple other books is destroyed.</li>\n<li class=\"markdown-list-item\">5 through 6 above but deleted instead of destroyed.</li>\n</ol>\n<p class=\"markdown-para\">So that's 7 actions * 15 scenarios = 105 actions. Definitely too much work to try out each one in the console, but easily handled by a test framework. I'll use <a href=\"https://rspec.info/\" class=\"markdown-link\">RSpec</a> as that's what I'm familiar with, and it automatically resets the database after each example.</p>\n<h2 class=\"markdown-subtitle\" id=\"test-setup\" style=\"position:relative;\"><a href=\"#test-setup\" aria-label=\"test setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test Setup</h2>\n<p class=\"markdown-para\">After <a href=\"../start-rails-6-project-with-rspec\" class=\"markdown-link\">adding RSpec to the project</a>, I added the following tests for the Author and Book models. These are exploratory tests, that is, they're being used to learn what will happen rather than declaring what should happen. That's why there are no expectations, and exceptions are caught and logged.</p>\n<p class=\"markdown-para\">The bang version <code>destroy!</code> is used since it raises an exception so its easier to see what went wrong. I'm also logging the beginning and ending of each test to make it clear in the log file what activity is coming from which test. Finally, a test helper is added to show the counts of how many authors and books were deleted at the end of each test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/helpers.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Add `require &quot;./spec/helpers&quot;` to rails_helper.rb after Rails is loaded</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Helpers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">show_model_counts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    original_author_count </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    original_book_count </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;  NUMBER AUTHORS DELETED: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">original_author_count </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">count</span><span class=\"mtk7\">}</span><span class=\"mtk6\">; NUMBER BOOKS DELETED: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">original_book_count </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">count</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/models/author_spec.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe Author, </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:model</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">before</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:each</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |example|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">=== BEGIN TEST </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">example.</span><span class=\"mtk5\">metadata</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:full_description</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> ===&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">after</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:each</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    show_model_counts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;=== END TEST ===</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#destroy!&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with no books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;John Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with a single book&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Julian James McKinnon&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with multiple books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Andrew Park&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#delete&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with no books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;John Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with a single book&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Julian James McKinnon&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with multiple books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Andrew Park&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/models/book_spec.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe Book, </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:model</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">before</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:each</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |example|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">=== BEGIN TEST </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">example.</span><span class=\"mtk5\">metadata</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:full_description</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> ===&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">after</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:each</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    show_model_counts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;=== END TEST ===</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#destroy!&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove a book from author that only has that book&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Computer Programming Crash Course: 7 Books in 1&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        book.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove a book from author that has multiple books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python Programming for Beginners&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        book.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#delete&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove a book from author that only has that book&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Computer Programming Crash Course: 7 Books in 1&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        book.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove a book from author that has multiple books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python Programming for Beginners&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        book.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<p class=\"markdown-para\">In this next section, each model class will be modified with respect to its dependent option, then the tests will be run and the log files analyzed to understand the behavior of each option.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"1-no-options\" style=\"position:relative;\"><a href=\"#1-no-options\" aria-label=\"1 no options permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1: No Options</h3>\n<p class=\"markdown-para\">In this scenario, we do not specify any <code>dependent</code> option on either side of the <code>belongs_to/has_many</code> relationship. So the models simply look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's run the tests with <code>bundle exec rspec</code> and then examine the <code>log/test.log</code> file:</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (7.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.4ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (3.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test Log Summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Author (i.e. model on the <code>has_many</code> side of the relationship) with one or more books cannot be removed. Both <code>destroy!</code> and <code>delete</code> methods raise <code>ActiveRecord::InvalidForeignKey</code>.</li>\n<li class=\"markdown-list-item\">Author with no books can be successfully removed with either <code>destroy!</code> or <code>delete</code> methods.</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">If your system never needs to delete any instance of the model on the <code>has_many</code> side, then not specifying any <code>dependent</code> options is ok, otherwise, consider one of the other scenarios.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"2-has-many-destroy\" style=\"position:relative;\"><a href=\"#2-has-many-destroy\" aria-label=\"2 has many destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2: Has Many Destroy</h3>\n<p class=\"markdown-para\">In this case, we leave the Book model with no dependent option, and specify <code>destroy</code> on the Author model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to also be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (1.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nBook model 2 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 2]]\nBook model 3 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 3]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy/destroy!</code> on Author model (<code>has_many</code> side of relationship) instance works to delete that author <em class=\"markdown-emphasis\">and</em> also destroys each of the author's books. That is, each associated book has its <code>before_destroy</code> callback invoked, and then is deleted from the database with a SQL DELETE statement. Note that in the case of an Author with multiple Books, the books are deleted one at a time with multiple SQL DELETE statements. This is because each book also must have its callbacks invoked.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on Author model fails on foreign key constraint for author instances that have one or more associated books. (<code>delete</code> on Author model with no books succeeds).</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">Use the <code>dependent: :destroy</code> option to support a cascade style delete where a parent model and all its associations can be removed, with the associated models <code>before_destroy</code> callbacks invoked for final cleanup.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"3-has-many-delete-all\" style=\"position:relative;\"><a href=\"#3-has-many-delete-all\" aria-label=\"3 has many delete all permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3: Has Many Delete All</h3>\n<p class=\"markdown-para\">In this case, we leave the Book model with no dependent option, and specify <code>delete_all</code> on the Author model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete_all</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container\">\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n</code>\n</pre>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy/destroy!</code> on Author model (<code>has_many</code> side of relationship) instance works to delete that author <em class=\"markdown-emphasis\">and</em> also directly deletes each of the author's books. That is, each associated book will be deleted via SQL DELETE statement but will <em class=\"markdown-emphasis\">not</em> have its <code>before_destroy</code> callback invoked. Unlike in <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a> where the books were deleted one at a time, in this case, all of an author's books are deleted in a single SQL DELETE statement.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on Author model fails on foreign key constraint for author instances that have one or more associated books.</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">Use the <code>dependent: :delete_all</code> option to support a cascade style delete where a parent model and all its associations can be removed, and where the associated models can be immediately deleted via SQL DELETE, with no need for their <code>before_destroy</code> callbacks invoked, i.e. no need for any final cleanup.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"4-has-many-nullify\" style=\"position:relative;\"><a href=\"#4-has-many-nullify\" aria-label=\"4 has many nullify permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4: Has Many Nullify</h3>\n<p class=\"markdown-para\">In this case, we leave the Book model with no dependent option, and specify <code>nullify</code> on the Author model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:nullify</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes the foreign key to be set to NULL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (1.2ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (1.2ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::NotNullViolation - SQLite3::ConstraintException: NOT NULL constraint failed: books.author_id\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::NotNullViolation - SQLite3::ConstraintException: NOT NULL constraint failed: books.author_id\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.0ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (1.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with no books invokes its <code>before_destroy</code> callback then removes the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with one or more books fails, but not on a foreign key constraint, rather, an <code>ActiveRecord::NotNullViolation</code>. This is because it's attempting to update <code>author_id</code> on the associated Book models to <code>null</code> which is not allowed due to how the Book migration was defined.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an Author with one or more books fails, raising <code>ActiveRecord::InvalidForeignKey</code>.</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">The <code>nullify</code> option could be useful if the system requirements were that an Author (parent model on the <code>has_many</code> side) could be removed from the database, but its associated Books could not be removed. In order for this to work, the Book model (child model on the <code>belongs_to</code>) side would need to allow its foreign key<code>author_id</code> to be null, i.e. the migration would have to look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Original column definition</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># t.references :author, null: false, foreign_key: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Modified column definition to support nullify option on Author model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With a null <code>author_id</code> allowed, the Author destroy tests succeed in removing the Author from the database, <em class=\"markdown-emphasis\">and</em> updating the Author's associated Books with a null <code>author_id</code> as shown in this test log below, focusing only on the Author tests:.</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nTest log for Author destroy with null FK allowed on Book\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (1.6ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\">In a real application, the code that handles or displays Books would have to be flexible enough to handle a null Author rather than assuming it will always be populated.</p>\n<p class=\"markdown-para\">One thing to watch out with the nullify option, is that calling <code>delete</code> on an author simply removes the author via SQL DELETE, but does not update the author's associated books to have a null <code>author_id</code>. This leaves the books as orphans, referencing an author that no longer exists, as shown in this snippet of the test log:</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nTest log for Author delete with null FK allowed on Book\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\">Lesson learned: When using the <code>dependent: :nullify</code>, remember to use the <code>destroy</code> method rather than <code>delete</code>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"5-has-many-restrict-with-exception\" style=\"position:relative;\"><a href=\"#5-has-many-restrict-with-exception\" aria-label=\"5 has many restrict with exception permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5: Has Many Restrict With Exception</h3>\n<p class=\"markdown-para\">In this case, we leave the Book model with no dependent option, and specify <code>restrict_with_exception</code> on the Author model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:restrict_with_exception</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># ActiveRecord::DeleteRestrictionError exception raised if there are any associated records</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 3], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (2.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.2ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with no books invokes its <code>before_destroy</code> callback then removes the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with one or more books fails, but not on a foreign key constraint, rather, an <code>ActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books</code>. This is the behaviour of <code>restrict_with_exception</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an Author with one or more books fails, raising <code>ActiveRecord::InvalidForeignKey</code>.</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">Use this option if you want to prevent models with dependent models from being removed, but with an explicit exception that can be handled rather than catching a foreign key constraint violation from the database. Note that you have to use the <code>destroy</code> method to raise <code>DeleteRestrictionError</code>. The <code>delete</code> method still raises <code>ActiveRecord::InvalidForeignKey</code>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"6-belongs-to-destroy\" style=\"position:relative;\"><a href=\"#6-belongs-to-destroy\" aria-label=\"6 belongs to destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6: Belongs to Destroy</h3>\n<p class=\"markdown-para\">In this case, we update the Book model to specify <code>destroy</code> and the Author model is unspecified:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (2.0ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.5ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (1.6ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (1.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (1.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Author tests behave the same as <a href=\"../activerecord-dependent-options/#1-no-options\" class=\"markdown-link\">Scenario 1</a>, where any author with an associated book cannot be removed due to foreign key constraint.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that only has that one book, destroys both the book and the author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that has other books as well fails. It attempts to delete the author but then runs into a foreign key constraint because there's still other books in the system that belong to that author. In this case, nothing is deleted.</li>\n<li class=\"markdown-list-item\">Calling delete on a book (whether the author has only that one book or others as well), deletes only that book and does not attempt to go up to the author for further deletion.</li>\n</ul>\n<p class=\"markdown-para\">Note that the Rails Guides warn not to use this <code>dependent: :destroy</code> option in this way:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">You should not specify this option on a belongs_to association that is connected with a has_many association on the other class. Doing so can lead to orphaned records in your database.</p>\n</blockquote>\n<p class=\"markdown-para\">The test that attempts to destroy a book belonging to an author that has other books is where this issue could happen. If the associated author had been removed, that would leave the other books \"orphaned\". With a non nullable foreign key constraint on the Book model, this was not allowed.</p>\n<p class=\"markdown-para\">However, if the Book migration allowed a nullable foreign key for author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Original column definition</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># t.references :author, null: false, foreign_key: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># For experimentation in allowing a nullable foreign key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Then calling destroy on a book whose author has other books will remove both the book and author from the system, leaving the other books from this author as \"orphans\" in that they still have their <code>author_id</code> property populated, but the referenced author has been removed.</p>\n<p class=\"markdown-para\">Let's see this in a Rails console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># book by author that has other books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python Programming for Beginners&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># removing book also removes associated author, even though that author has other books!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">book.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Book model 1 will be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># TRANSACTION (0.1ms)  begin transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Book Destroy (0.8ms)  DELETE FROM &quot;books&quot; WHERE &quot;books&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author Load (0.3ms)  SELECT &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = ? LIMIT ?  [[&quot;id&quot;, 1], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author model 1 will be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author Destroy (0.3ms)  DELETE FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># TRANSACTION (0.7ms)  commit transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># this leaves some books still pointing to the deleted author - these are orphans</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">orphaned_books </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk4\">author_id:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">orphaned_books.</span><span class=\"mtk5\">count</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 2</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>dependent: :destroy</code> option on the <code>belongs_to</code> side of a relationship could be useful in a 1-1 situation, for example, if an Author specified <code>has_one</code> book instead of <code>has_many</code>. But otherwise, it doesn't really make sense because either it will lead to orphan records or foreign key constraint errors in some cases.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"7-belongs-to-destroy-has-many-destroy\" style=\"position:relative;\"><a href=\"#7-belongs-to-destroy-has-many-destroy\" aria-label=\"7 belongs to destroy has many destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7: Belongs to Destroy Has Many Destroy</h3>\n<p class=\"markdown-para\">In this case, the <code>destroy</code> option is specified on both sides of the relationship:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to also be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This could be a strange situation as declaring destroy on each side says \"when this model is destroyed, also destroy its associated models\". This means destroying a book would attempt to destroy its author, but that in turn would attempt to destroy its book(s), could this cause an infinite destroy loop? Let's see what happens with the tests.</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (2.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (8.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::RecordNotDestroyed - Failed to destroy Book with id=4\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::RecordNotDestroyed - Failed to destroy Book with id=1\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.9ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (2.0ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nBook model 2 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::RecordNotDestroyed - Failed to destroy Book with id=1\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with no books invokes its <code>before_destroy</code> callback then removes the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with one or more books fails, but not on a foreign key constraint, rather, an <code>ActiveRecord::RecordNotDestroyed - Failed to destroy Book with id={author id}</code>. In this case it's attempting to destroy the Author's associated book(s) but failing to do so. Interesting that the error message doesn't say why it failed. Recall that in <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a> where the destroy on the has_many side was used by itself, destroying an author with one or more books was successful.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an Author with one or more books fails, raising <code>ActiveRecord::InvalidForeignKey</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on a book belonging to an Author that only has that one book works - both the book and its author are removed from the database, although it does run a query first to see if that author has any other books.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on a book belonging to an Author that has other books fails with <code>ActiveRecord::RecordNotDestroyed - Failed to destroy Book with id={book_id}</code>. In <a href=\"../activerecord-dependent-options/#6-belongs-to-destroy\" class=\"markdown-link\">Scenario 6</a>, where destroy was only specified on Book but not Author, this case also failed but with a more useful error indicating why the book could not be removed: <code>ActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book, regardless of its author having just that book or others, successfully removes that book and does not attempt to remove any authors.</li>\n</ul>\n<p class=\"markdown-para\">Even though Rails will not go into an infinite loop with <code>destroy</code> on both sides of the relationship, this seems like an invalid combination. In a simple application such as this one, it's easy to see the <code>destroy</code> on both sides and fix it (choose just one), but in a larger app with more models, it could be tricky to find.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"8-belongs-to-destroy-has-many-delete-all\" style=\"position:relative;\"><a href=\"#8-belongs-to-destroy-has-many-delete-all\" aria-label=\"8 belongs to destroy has many delete all permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>8: Belongs to Destroy Has Many Delete All</h3>\n<p class=\"markdown-para\">In this case, the <code>destroy</code> option is specified on Book and <code>delete_all</code> on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete_all</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all associated objects to be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (1.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.8ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Delete All (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.0ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Delete All (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> an author has the same effect as it did in <a href=\"../activerecord-dependent-options/#3-has-many-delete-all\" class=\"markdown-link\">Scenario 3</a>, in that it first directly removes all of the author's books via SQL DELETE, then calls the author's <code>before_destroy</code> callback, then removes the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author with books fails on a foreign key constraint.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that only has that one book removes both the book and its associated author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that has other books is the most interesting case - it removes the book from the database, then finds the author, then finds all the other books belonging to this author and removes those as well, then finally, it removes the author.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book removes just that book.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this combination as it can produce a surprising result when calling <code>book.destroy</code> on a book that belongs to an author that also has other books. It ends up removing not just that book but all the other books written by this author. It's a kind of cascade but starting from a child, going up to the parent, then back down to other children.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"9-belongs-to-destroy-has-many-nullify\" style=\"position:relative;\"><a href=\"#9-belongs-to-destroy-has-many-nullify\" aria-label=\"9 belongs to destroy has many nullify permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>9: Belongs to Destroy Has Many Nullify</h3>\n<p class=\"markdown-para\">In this case, the <code>destroy</code> option is specified on Book and <code>nullify</code> on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:nullify</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes the foreign key to be set to NULL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">In <a href=\"../activerecord-dependent-options/#4-has-many-nullify\" class=\"markdown-link\">Scenario 4</a>, we learned that in order for <code>nullify</code> to work, the model on the other side of the relationship (Book) needs to allow a nullable foreign key. So we'll run the tests with the database having this migration for the <code>books</code> table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># t.references :author, null: false, foreign_key: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># for experimentation in allowing a nullable foreign key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.5ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.6ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.7ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (16.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (1.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Update All (0.1ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.0ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Update All (0.1ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with one or more books is successful. It first finds the author's associated books, updates their <code>author_id</code> column to <code>nil</code>, then SQL DELETEs the author record.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author is also successful. However, it does not update its associated book models to have a null <code>author_id</code>. This will leave book records \"orphaned\" in that they're referencing an author that no longer exists.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that only has that one book successfully removes first the book, and then the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that has other books is interesting. The book and author are removed from the database, and also, any other books the author has are updated to have a null <code>author_id</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on any book executes SQL DELETE to remove just that book and doesn't affect any author or other books.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this combination because there's a surprising result when calling <code>destroy</code> on a book that belongs to an author that has other books. Not only does it remove that book and author, but also updates the author's other books, let's call them siblings to the deleted book, to have a null <code>author_id</code>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"10-belongs-to-destroy-has-many-restrict-with-exception\" style=\"position:relative;\"><a href=\"#10-belongs-to-destroy-has-many-restrict-with-exception\" aria-label=\"10 belongs to destroy has many restrict with exception permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10: Belongs to Destroy Has Many Restrict With Exception</h3>\n<p class=\"markdown-para\">In this case, the <code>destroy</code> option is specified on Book and <code>restrict_with_exception</code> on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:restrict_with_exception</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># ActiveRecord::DeleteRestrictionError exception raised if there are any associated records</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 3], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (1.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.9ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 2], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Exists? (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.2ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with one or more books fails due to <code>ActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books</code>. This is the same behaviour observed in <a href=\"../activerecord-dependent-options/#5-has-many-restrict-with-exception\" class=\"markdown-link\">Scenario 5</a>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author with one or more books also fails, but with a <code>ActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed</code> error raised. Again, the same as <a href=\"../activerecord-dependent-options/#5-has-many-restrict-with-exception\" class=\"markdown-link\">Scenario 5</a>.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that only has that one book removes both the book and author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that has other books is interesting - it starts a SQL DELETE to remove the book, then goes up to the author to remove it as well (due to <code>dependent: :destroy</code> being specified on Book model), but then the <code>dependent: :restrict_with_exception</code> option on Author model kicks in and raises <code>ActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books</code>. Since all this activity is wrapped in a transaction, it gets rolled back and nothing is removed.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on any book executes SQL DELETE to remove just that book and doesn't affect any author or other books.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this combination as it results in a conflict between the child model Book saying when I'm deleted, delete my parent, and the parent model Author saying, do not delete me if I have children.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"11-belongs-to-delete\" style=\"position:relative;\"><a href=\"#11-belongs-to-delete\" aria-label=\"11 belongs to delete permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>11: Belongs to Delete</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and the Author model does not specify any dependent option:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.4ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Similar to <a href=\"../activerecord-dependent-options/#6-belongs-to-destroy\" class=\"markdown-link\">Scenario 6</a>, when no dependent options are specified on the Author/has_many side of the relationship, trying to either <code>destroy</code> or <code>delete</code> an author with one or more books fails with <code>ActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a Book that belongs to an Author that only has that one book destroys the book (i.e. callbacks and SQL DELETE), and also deletes the Author (i.e. SQL DELETE, no callbacks). This is the effect of the <code>delete</code> option specified on Book.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a Book that belongs to an Author that has other books as well first destroys the book, then attempts to SQL DELETE the author. This fails on a foreign key constraint, since the other books belonging to this Author are still in the database referencing it, and so the entire transaction is rolled back and nothing is removed.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book invokes SQL DELETE on just that book, no other models are affected.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this option as the results seem inconsistent with respect to removing child models (on the belongs_to side of the relationship). That is, if removing a book that belongs to an author that only has that one book, then both the child and parent models are removed (with the child model having its destroy callback invoked but the parent model does not). But if a child model belongs to a parent with other children, then nothing is removed.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"12-belongs-to-delete-has-many-destroy\" style=\"position:relative;\"><a href=\"#12-belongs-to-delete-has-many-destroy\" aria-label=\"12 belongs to delete has many destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>12: Belongs to Delete Has Many Destroy</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and <code>destroy</code> option is specified on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to also be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Similar to <a href=\"../activerecord-dependent-options/#7-belongs-to-destroy-has-many-destroy\" class=\"markdown-link\">Scenario 7</a>, this seems like a situation that could lead to an infinite delete/destroy loop with each side of the relationship trying to remove the other. Let's see what happens:</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (1.8ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (6.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.3ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (2.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an Author with a single book invokes destroy callback on the book and removes it from the database, and then removes the author from the database. Interesting that according to the test log, the SQL DELETE statement to delete the author runs <em class=\"markdown-emphasis\">before</em> the author's <code>before_destroy</code> callback is invoked. This is different than in <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a> in which the <code>before_destroy</code> callback is invoked before the SQL DELETE.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an Author with multiple books, finds all books belonging to this Author, invokes the first book's callback, then executes SQL DELETE on the first book, then SQL DELETE on the author. At that point, it fails on a foreign key constraint because the author still has other books remaining that reference it. Normally the <code>dependent: :destroy</code> option on Author performs a cascading delete on all its Books but having <code>dependent: :delete</code> on the book prevents this.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an Author with one or more books fails on a foreign key constraint, because <code>delete</code> method does not attempt to remove any associated models, and it would be invalid to have a book model referencing an author that no longer exists.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a Book belonging to an Author that only has that one book successfully removes the book (first invoking its callback), then removes the author via SQL DELETE (no callbacks).</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a Book belonging to an Author that has other books fails on a foreign key constraint when attempting to SQL DELETE the author, because that would leave the other books referencing an author that no longer exists.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book works to remove just that book.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this combination of options as the desired cascading delete effect from an Author to its Books won't happen as expected. See <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a> for the expected cascade.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"13-belongs-to-delete-has-many-delete-all\" style=\"position:relative;\"><a href=\"#13-belongs-to-delete-has-many-delete-all\" aria-label=\"13 belongs to delete has many delete all permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>13: Belongs to Delete Has Many Delete All</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and <code>delete_all</code> option is specified on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete_all</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Again a potential loop of deletes in that when a book is removed, it should delete its author, but when an author is removed, it should delete all its books.</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (1.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.4ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (1.0ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (1.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with a single book first deletes the associated book, then invokes the author's callback, then deletes the author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with multiple books deletes all its associated books, then invokes the author's callback, then deletes the author.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author with one or more books attempts to delete just that author, then fails on a foreign key constraint because there still exist books that reference this author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that only has that one book invokes the book's callback, deletes the book, then finds the associated author and deletes that.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that has other books fails on a foreign key constraint, at the point when attempting to delete the associated author, because there are still other books referencing this author.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book works to delete just that book.</li>\n</ul>\n<p class=\"markdown-para\">It looks like these options don't interfere with each other and behave the same as if only one was specified. But having <code>dependent: :delete</code> on the belongs_to side of the relationship is still problematic, as was explained in <a href=\"../activerecord-dependent-options/#11-belongs-to-delete\" class=\"markdown-link\">Scenario 11</a>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"14-belongs-to-delete-has-many-nullify\" style=\"position:relative;\"><a href=\"#14-belongs-to-delete-has-many-nullify\" aria-label=\"14 belongs to delete has many nullify permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>14: Belongs to Delete Has Many Nullify</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and <code>nullify</code> option is specified on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:nullify</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes the foreign key to be set to NULL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Just like in <a href=\"../activerecord-dependent-options/#4-has-many-nullify\" class=\"markdown-link\">Scenario 4</a>, in order to observe the effects of <code>nullify</code>, the <code>books</code> migration needs to allow a nullable reference to <code>author_id</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Original column definition</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># t.references :author, null: false, foreign_key: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Modified column definition to support nullify option on Author model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.2ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with one or more books first updates its associated book's <code>author_id</code> to nil, then invokes the author's callback and deletes the author. So no books are removed from the database, but the book records are updated to have a nil author_id.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author, whether it has 0, 1, or more books deletes the author from the database, and does <em class=\"markdown-emphasis\">not</em> attempt to remove or update the associated book records. This creates an orphan situation where book records are left in the database referencing an author that no longer exists.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that only has that one book invokes the book's callback and deletes it. Then it finds the associated author and deletes that as well.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that has other books deletes both the book and author, leaving the author's other books as orphans, i.e. referencing an author that no longer exists. This is different behaviour than when nullify was used in <a href=\"../activerecord-dependent-options/#9-belongs-to-destroy-has-many-nullify\" class=\"markdown-link\">Scenario 9</a>, in which case the other books were updated to have a nil author_id.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book removes just that book.</li>\n</ul>\n<p class=\"markdown-para\">Most surprising: The nullify option on the has_many side of the relationship behaves differently depending on whether the belongs_to specifies dependent option destroy or delete.</p>\n<p class=\"markdown-para\">I wouldn't use this combination as there's some surprising results. Specifically calling <code>destroy</code> on a book will result in its sibling books being made orphans because their author_id will still be populated, pointing to an author that no longer exists. With the nullify option on the author, it's expected that some books will have a nil author_id, but not that author_id could be populated but invalid.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"15-belongs-to-delete-has-many-restrict-with-exception\" style=\"position:relative;\"><a href=\"#15-belongs-to-delete-has-many-restrict-with-exception\" aria-label=\"15 belongs to delete has many restrict with exception permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>15: Belongs to Delete Has Many Restrict With Exception</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and <code>restrict_with_exception</code> option is specified on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:restrict_with_exception</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># ActiveRecord::DeleteRestrictionError exception raised if there are any associated records</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 3], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (7.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (2.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (1.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (1.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with no books removes it (callback + SQL DELETE). But for an author with one or more books, an error is raised: <code>ActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author with one or more books fails on a foreign key constraint.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author with just that one book removes the book (callback + SQL DELETE), then deletes the author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author with other books fails to remove anything. This is because a foreign key constraint exception is raised when trying to delete the author, that would leave its other book records with invalid references.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book works and only removes that book.</li>\n</ul>\n<p class=\"markdown-para\">The combination of <code>dependent: :delete</code> on <code>belongs_to</code> and <code>dependent: :restrict_with_exception</code> on <code>has_many</code> behave the same as if each option was specified independently and the other side was not specified.</p>\n<h2 class=\"markdown-subtitle\" id=\"which-should-you-use\" style=\"position:relative;\"><a href=\"#which-should-you-use\" aria-label=\"which should you use permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Which Should You Use?</h2>\n<h3 class=\"markdown-sub-subtitle\" id=\"requirements\" style=\"position:relative;\"><a href=\"#requirements\" aria-label=\"requirements permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Requirements</h3>\n<p class=\"markdown-para\">The answer, as in nearly all things tech is... it depends. Firstly, it depends on the business and/or legal requirements of the application. Which models need to be removed? For example, should a customer be able to click a button to remove their account? If so, what should happen to all other models that may refer to this customer record? For an e-commerce or SaaS application, the customer's shipping addresses and payment methods should probably be removed which would be a good use case for <code>has_many :shipping_addresses, dependent: :destroy</code> option on the Customer model.</p>\n<p class=\"markdown-para\">But what about the customer's orders, would removing those affect reporting and financial systems? How about any product reviews the customer may have written? This might be a good use case for allowing nullable foreign keys and using <code>has_many: product_reviews, dependent: :nullify</code> if the review content is considered the company's content, not the customers. All these questions need to be answered.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"performance\" style=\"position:relative;\"><a href=\"#performance\" aria-label=\"performance permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Performance</h3>\n<p class=\"markdown-para\">Both <code>dependent: :destroy</code> and <code>dependent: :delete_all</code> on the has_many side will perform a cascade style delete. But the <code>:destroy</code> option will execute multiple SQL DELETE statements, one for each associated model to be removed because its callbacks are also being invoked. Whereas the <code>:delete_all</code> option will remove all associated models in a single SQL DELETE statement. If the parent model is expected to have a lot of children, using <code>:destroy</code> could be noticeably slower than <code>:delete_all</code>. If the callbacks absolutely have to be executed, consider the <code>:destroy_async</code> option.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"surprises\" style=\"position:relative;\"><a href=\"#surprises\" aria-label=\"surprises permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Surprises</h3>\n<p class=\"markdown-para\">Another factor to consider is the <a href=\"https://en.wikipedia.org/wiki/Principle_of_least_astonishment\" class=\"markdown-link\">principle of least surprise</a>. For example, the combination of <code>dependent: :destroy</code> on the belongs_to side and <code>dependent: :nullify</code> on the has_many side results in siblings having their foreign key references set to nil when one of them is destroyed. We saw this in <a href=\"activerecord-dependent-options/#9-belongs-to-destroy-has-many-nullify\" class=\"markdown-link\">Scenario 9</a> where having nullify on the has_many side causes the <code>belongs_to: :destroy</code> to go from a book, up to its author for removal, and then back to all the other books to nullify their author_id foreign keys.</p>\n<p class=\"markdown-para\">We also encountered surprising results in <a href=\"../activerecord-dependent-options/#8-belongs-to-destroy-has-many-delete-all\" class=\"markdown-link\">Scenario 8</a>, with the combination of <code>dependent: :destroy</code> on belongs_to and <code>dependent :delete_all</code> on has_many. In this case, removing a book that belongs to an author that has other books resulted in all of these books being removed. I would avoid combinations of options that produce surprising results.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"consistency\" style=\"position:relative;\"><a href=\"#consistency\" aria-label=\"consistency permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Consistency</h3>\n<p class=\"markdown-para\">Another thing to consider is consistency. It's one thing to allow nullable foreign keys, but in <a href=\"../activerecord-dependent-options/#14-belongs-to-delete-has-many-nullify\" class=\"markdown-link\">Scenario 14</a>, the combination of <code>dependent: :delete</code> on the belongs_to side, and <code>dependent: :nullify</code> on the has_many side can result in books referencing an author that no longer exists. That is, their foreign key is not null, but specifies an author_id that no longer exists. Although ActiveRecord can handle this by simply returning <code>nil</code> when referencing <code>book.author</code>, it could result in inconsistencies if using direct SQL statements for a reporting system.</p>\n<p class=\"markdown-para\">This inconsistency can also happen when using <code>dependent: :nullify</code> as we learned in <a href=\"../activerecord-dependent-options/#4-has-many-nullify\" class=\"markdown-link\">Scenario 4</a> when invoking the <code>delete</code> method on the model with the <code>has_many</code> rather than the <code>destroy</code> method.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"combinations\" style=\"position:relative;\"><a href=\"#combinations\" aria-label=\"combinations permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Combinations</h3>\n<p class=\"markdown-para\">Proceed with caution when <em class=\"markdown-emphasis\">combining</em> options. From this exercise, we've learned that the same option can behave differently depending on what option if any is specified on the other side of the relationship. For example, when <code>dependent: :destroy</code> is used on the has_many side by itself as in <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a>, an author with one or more books can be successfully destroyed and all its books are also destroyed. But when this option is combined with <code>dependent: :destroy</code> on the belongs_to side as in <a href=\"../activerecord-dependent-options/#7-belongs-to-destroy-has-many-destroy\" class=\"markdown-link\">Scenario 7</a>, then the destroy method on an Author with one or more books fails. Even stranger, when this option is combined with <code>dependent: :delete</code> on the belongs_to side as in <a href=\"../activerecord-dependent-options/#12-belongs-to-delete-has-many-destroy\" class=\"markdown-link\">Scenario 12</a>, then an Author with a single book can be destroyed, but its before_destroy callback gets invoked after the SQL DELETE statement to remove it. And trying to destroy an Author with multiple books fails.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"orphans\" style=\"position:relative;\"><a href=\"#orphans\" aria-label=\"orphans permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Orphans</h3>\n<p class=\"markdown-para\">Consider the advice in the Rails Guides, specifically the warning not to use <code>dependent: :destroy</code> on the <code>belongs_to</code> side of a one-to-many relationship due to possibility of orphan records. We tried this in a few scenarios, starting with <a href=\"../activerecord-dependent-options/#6-belongs-to-destroy\" class=\"markdown-link\">Scenario 6</a>. This case did not result in orphan records (as long as a nullable foreign key was not allowed) but trying to remove a book belonging to an author that had other books failed on a foreign key constraint. In this case ActiveRecord prevents orphan records, but will result in more complex code that needs to handle some entities can be removed and some cannot due to how many other entities their parent has. Scenarios <a href=\"../activerecord-dependent-options/#7-belongs-to-destroy-has-many-destroy\" class=\"markdown-link\">7</a>, <a href=\"../activerecord-dependent-options/#8-belongs-to-destroy-has-many-delete-all\" class=\"markdown-link\">8</a>, <a href=\"../activerecord-dependent-options/#9-belongs-to-destroy-has-many-nullify\" class=\"markdown-link\">9</a>, and <a href=\"../activerecord-dependent-options/#10-belongs-to-destroy-has-many-restrict-with-exception\" class=\"markdown-link\">10</a> are other variations on using <code>dependent: :destroy</code> on the <code>belongs_to</code> side and all had some problems or possibly unintended consequences.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"removal-method\" style=\"position:relative;\"><a href=\"#removal-method\" aria-label=\"removal method permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Removal Method</h3>\n<p class=\"markdown-para\">A final thing to be aware of is when using any of the dependent options to affect related entities: This behaviour only kicks in when invoking the <code>destroy</code> or <code>destroy!</code> methods on the model instance. The <code>delete</code> method only invokes direct SQL on the model on which it is called and does not attempt to affect any of its associations.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has used <a href=\"https://github.com/danielabar/learn-associations\" class=\"markdown-link\">exploratory tests</a> to understand how ActiveRecord dependent options function in a one to many relationship to remove (or fail to remove) records from the database when used only on one, or both sides of the relationship. It has also explored differences in the <code>delete</code> vs <code>destroy</code> methods. It then covered some factors to consider in choosing which dependent option(s) to use.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":83,"tableOfContents":"<ul>\n<li>\n<p><a href=\"#project-setup\">Project Setup</a></p>\n</li>\n<li>\n<p><a href=\"#delete-destroy\">Delete Destroy</a></p>\n</li>\n<li>\n<p><a href=\"#options-matrix\">Options Matrix</a></p>\n</li>\n<li>\n<p><a href=\"#test-setup\">Test Setup</a></p>\n</li>\n<li>\n<p><a href=\"#scenarios\">Scenarios</a></p>\n<ul>\n<li><a href=\"#1-no-options\">1: No Options</a></li>\n<li><a href=\"#2-has-many-destroy\">2: Has Many Destroy</a></li>\n<li><a href=\"#3-has-many-delete-all\">3: Has Many Delete All</a></li>\n<li><a href=\"#4-has-many-nullify\">4: Has Many Nullify</a></li>\n<li><a href=\"#5-has-many-restrict-with-exception\">5: Has Many Restrict With Exception</a></li>\n<li><a href=\"#6-belongs-to-destroy\">6: Belongs to Destroy</a></li>\n<li><a href=\"#7-belongs-to-destroy-has-many-destroy\">7: Belongs to Destroy Has Many Destroy</a></li>\n<li><a href=\"#8-belongs-to-destroy-has-many-delete-all\">8: Belongs to Destroy Has Many Delete All</a></li>\n<li><a href=\"#9-belongs-to-destroy-has-many-nullify\">9: Belongs to Destroy Has Many Nullify</a></li>\n<li><a href=\"#10-belongs-to-destroy-has-many-restrict-with-exception\">10: Belongs to Destroy Has Many Restrict With Exception</a></li>\n<li><a href=\"#11-belongs-to-delete\">11: Belongs to Delete</a></li>\n<li><a href=\"#12-belongs-to-delete-has-many-destroy\">12: Belongs to Delete Has Many Destroy</a></li>\n<li><a href=\"#13-belongs-to-delete-has-many-delete-all\">13: Belongs to Delete Has Many Delete All</a></li>\n<li><a href=\"#14-belongs-to-delete-has-many-nullify\">14: Belongs to Delete Has Many Nullify</a></li>\n<li><a href=\"#15-belongs-to-delete-has-many-restrict-with-exception\">15: Belongs to Delete Has Many Restrict With Exception</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#which-should-you-use\">Which Should You Use?</a></p>\n<ul>\n<li><a href=\"#requirements\">Requirements</a></li>\n<li><a href=\"#performance\">Performance</a></li>\n<li><a href=\"#surprises\">Surprises</a></li>\n<li><a href=\"#consistency\">Consistency</a></li>\n<li><a href=\"#combinations\">Combinations</a></li>\n<li><a href=\"#orphans\">Orphans</a></li>\n<li><a href=\"#removal-method\">Removal Method</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#conclusion\">Conclusion</a></p>\n</li>\n</ul>","frontmatter":{"title":"Understanding ActiveRecord Dependent Options","date":"01 Jul 2023","description":"A closer look at all the ways to remove ActiveRecord models from the database.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#282828","images":{"fallback":{"src":"/static/b7f7064c193fa4dc20f20d253e1928fa/fd980/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg","srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/00be4/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 225w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/66ebe/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 450w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/fd980/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/c5403/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 225w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/edfe1/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 450w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/b19f4/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":675}}}},"fields":{"slug":"/blog/activerecord-dependent-options/"}},"relatedP":{"edges":[{"node":{"id":"d300ca38-a569-5f95-b2a5-0bf6c30486cc","frontmatter":{"title":"Use UUID for primary key with Rails and Postgres","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/30bb7a61cc87a3edc43f8af6d89fa013/26528/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg","srcSet":"/static/30bb7a61cc87a3edc43f8af6d89fa013/26528/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg 300w,\n/static/30bb7a61cc87a3edc43f8af6d89fa013/43429/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/30bb7a61cc87a3edc43f8af6d89fa013/5d6c3/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.webp 300w,\n/static/30bb7a61cc87a3edc43f8af6d89fa013/68dbc/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-uuid-primary-key-postgres/"}}},{"node":{"id":"bb0af7b8-9d5f-597f-90cb-a4da75c3c9a9","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search Engine","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#d8c8a8","images":{"fallback":{"src":"/static/86310660995a38a9254ece85739c237f/26528/roll-search-3.jpg","srcSet":"/static/86310660995a38a9254ece85739c237f/26528/roll-search-3.jpg 300w,\n/static/86310660995a38a9254ece85739c237f/43429/roll-search-3.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/86310660995a38a9254ece85739c237f/5d6c3/roll-search-3.webp 300w,\n/static/86310660995a38a9254ece85739c237f/68dbc/roll-search-3.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part3/"}}},{"node":{"id":"848d2c81-d508-5776-ac83-fb1e50ef5848","frontmatter":{"title":"Fix Rails Blocked Host Error with Docker","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/648daf1a5b7bca42ff3729828586b2dc/26528/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.jpg","srcSet":"/static/648daf1a5b7bca42ff3729828586b2dc/26528/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.jpg 300w,\n/static/648daf1a5b7bca42ff3729828586b2dc/43429/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/648daf1a5b7bca42ff3729828586b2dc/5d6c3/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.webp 300w,\n/static/648daf1a5b7bca42ff3729828586b2dc/68dbc/blocked-host-fix-markus-spiske-KTuHfak_EEk-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-blocked-host-docker-fix/"}}}]}},"pageContext":{"slug":"/blog/activerecord-dependent-options/","relatedPosts":["Use UUID for primary key with Rails and Postgres","Fix Rails Blocked Host Error with Docker","Roll Your Own Search with Rails and Postgres: Search Engine"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}