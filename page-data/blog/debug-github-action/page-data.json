{"componentChunkName":"component---src-templates-post-js","path":"/blog/debug-github-action/","result":{"data":{"markdownRemark":{"html":"<p>A few weeks ago I was setting up CI (continuous integration) for a Rails project that uses Sidekiq, Redis, and Postgres. Pretty straightforward, just needed to run a build, install and configure the services (Postgres and Redis), initialize the database, then run linting and tests.</p>\n<p>Prior to the general release of Github Actions, I would have reached for Travis CI or Circle CI to set this up, which involves giving a 3rd party service access to your Github repo. But ever since <a href=\"https://github.com/features/actions\">Github Actions</a> has been available, its no longer necessary to integrate a 3rd party solution. Github Actions support running any workflow on any event such as push to a branch, merge a PR etc. The configuration is done via a yaml file in the <code>.github/workflows</code> directory in your project. No need to install anything, as soon as you push a branch with a workflow yaml in the directory Github looks for, it will start running the jobs and steps specified in the file. By default, the action will run on Github hosted machines but it's also possible to configure a self-hosted runner. For this post, we will be using the Github action runner.</p>\n<p>As great as Github Actions are, sometimes something will go wrong with the workflow, and the console output from the runner will not be sufficient to figure out what the issue is. This post will walk you through a debugging technique you can use to troubleshoot your workflow.</p>\n<h2>First Attempt</h2>\n<p>The <code>ci.yml</code> file shown below was my first attempt at getting a build going for my Rails project. This file specifies the services that are needed (Postgres and Redis) which are defined in the same syntax as a docker-compose file. The next section specifies all the steps that should be run in sequence. These include checking out the project, setting up the necessary Ruby and Node versions, installing the project dependencies with <code>bundle install</code> and <code>yarn install</code>, then initializing the database with <code>rake db:reset</code>, and finally running the linter (rubocop) and RSpec tests.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">push</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RACK_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">DATABASE_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ci</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">6379:6379</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup Ruby 2.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-ruby@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">ruby-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;2.7&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup Node</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-node@v2-beta</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">node-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;12&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">yarn install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">yarn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Initialize database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle exec rake db:reset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Run linter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">rubocop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Run tests</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle exec rspec</span></span></span></code></pre>\n<p>But after pushing this file and monitoring the Actions output (as soon as you push a valid workflow file, Github will run in and display the results in a new <code>Actions</code> tab displayed on your project page on github.com), the workflow failed with the following error displayed under the <code>Initialize database</code> step:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">PG::ConnectionBad: could not connect to server: Connection refused</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Is the server running on host &quot;127.0.0.1&quot; and accepting</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TCP/IP connections on port 5432?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/opt/hostedtoolcache/Ruby/2.7.2/x64/bin/bundle:23:in `load&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/opt/hostedtoolcache/Ruby/2.7.2/x64/bin/bundle:23:in `&lt;main&gt;&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Tasks: TOP =&gt; db:reset =&gt; db:drop =&gt; db:check_protected_environments</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(See full trace by running task with --trace)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Error: Process completed with exit code 2.</span></span></code></pre>\n<p>According to the error message, the rake task to initialize the database could not run because the database server wasn't running. This seemed strange as I had the same services configured locally via a <code>docker-compose.yml</code> file and it worked perfectly on my laptop. What I needed was a way to \"inspect\" the Github runner host machine where this flow was running, to investigate why the database failed to start up.</p>\n<h2>Add Tmate Debugger</h2>\n<p>Fortunately, there's a relatively easy way to do this via a community action named <a href=\"https://github.com/mxschmitt/action-tmate\">tmate</a>. This action can be added as a step anywhere in the workflow. It outputs a temporary hostname that you can ssh to and you will be connected to the runner machine. Here's the modified workflow with tmate added just after checking out sources:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">push</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RACK_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">DATABASE_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ci</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">6379:6379</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup tmate session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mxschmitt/action-tmate@v3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># rest of the steps...</span></span></span></code></pre>\n<p>After pushing this change and monitoring the action runner again, when it got to the <code>Setup tmate session</code> step, the following was displayed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">SSH: ssh HghSLAQZ6JqNEQjPEHTu5prMM@nyc1.tmate.io</span></span></code></pre>\n<h2>Debugging in Runner</h2>\n<p>To make use of this, open a terminal tab (I use iTerm) and enter:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ssh HghSLAQZ6JqNEQjPEHTu5prMM@nyc1.tmate.io</span></span></span></code></pre>\n<p>This opens a temporary ssh session on the Github action runner, that is now paused at the last step it was running. In this case, I put the tmate action just after checking out sources but before the setup Ruby step.</p>\n<p>Recall the error said that the rake task to initialize the database had been unable to connect to Postgres. Since Postgres is supposed to be running in a Docker container (that's what the <code>services</code> section of <code>ci.yml</code> specifies), I listed all the active docker processes with the <code>docker ps</code> command (reminder, I'm on the Github Action runner machine here):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az139-674:~/work/myapp/myapp$ docker ps</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4336ebfbbd89        redis:6             &quot;docker-entrypoint.s…&quot;   4 minutes ago       Up 4 minutes        0.0.0.0:6379-&gt;6379/tcp   d04eb80007624ff19d2b34cb344cf4fd_redis6_d9fced</span></span></code></pre>\n<p>Well that's clearly a problem, only the Redis container is running, so what happened to the Postgres container? To get the answer to this question, list the docker processes again but this time with the <code>-a</code> flag to list <em>all</em> processes, not just the running processes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az139-674:~/work/myapp/myapp$ docker ps -a</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS                    NAMES</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4336ebfbbd89        redis:6             &quot;docker-entrypoint.s…&quot;   5 minutes ago       Up 4 minutes               0.0.0.0:6379-&gt;6379/tcp   d04eb80007624ff19d2b34cb344cf4fd_redis6_d9fced</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3ce2dda6db40        postgres:13         &quot;docker-entrypoint.s…&quot;   5 minutes ago       Exited (1) 5 minutes ago                            d9f1a3d336094b2d8b26703081b78d99_postgres13_67885a</span></span></code></pre>\n<p>Ah, so a Postgres container was started, but something went wrong and it exited shortly after starting. In order to get a clue as to what went wrong, we can check the containers logs using the <code>docker logs</code> command, passing in the container name:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az139-674:~/work/myapp/myapp$ docker logs d9f1a3d336094b2d8b26703081b78d99_postgres13_67885a</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The files belonging to this database system will be owned by user &quot;postgres&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">This user must also own the server process.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The database cluster will be initialized with locale &quot;en_US.utf8&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The default database encoding has accordingly been set to &quot;UTF8&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The default text search configuration will be set to &quot;english&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Data page checksums are disabled.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fixing permissions on existing directory /var/lib/postgresql/data ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">creating subdirectories ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting dynamic shared memory implementation ... posix</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting default max_connections ... 100</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting default shared_buffers ... 128MB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting default time zone ... Etc/UTC</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">creating configuration files ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">running bootstrap script ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">performing post-bootstrap initialization ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">syncing data to disk ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Success. You can now start the database server using:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pg_ctl -D /var/lib/postgresql/data -l logfile start</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">initdb: warning: enabling &quot;trust&quot; authentication for local connections</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">You can change this by editing pg_hba.conf or using the option -A, or</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--auth-local and --auth-host, the next time you run initdb.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">waiting for server to start....2021-01-31 18:52:53.451 UTC [47] LOG:  starting PostgreSQL 13.1 (Debian 13.1-1.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-01-31 18:52:53.461 UTC [47] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-01-31 18:52:53.463 UTC [48] LOG:  database system was shut down at 2021-01-31 18:52:52 UTC</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-01-31 18:52:53.467 UTC [47] LOG:  database system is ready to accept connections</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> done</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">server started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/init.sql</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">psql:/docker-entrypoint-initdb.d/init.sql: error: could not read from input file: Is a directory</span></span></code></pre>\n<p>This reveals another clue, so the database fails to start because it tried to run <code>init.sql</code> but was unable to find it. Before moving on, to exit the debug session, enter <code>touch continue</code> in the runner ssh session, this will end it and the workflow on Github will continue to run after this point.</p>\n<p>Back to the investigation, what is this <code>init.sql</code> file that the Postgres container logs reported as not being able to read? The <code>postgres:13</code> Docker image has support for running one-time initialization sql files. The first time the database is being created, if any files are found in directory <code>/docker-entrypoint-initdb.d</code>, then they will be run.</p>\n<p>For this project, <code>init.sql</code> is located in the project root and is only intended to be used for development and CI where Postgres is run in a container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">create</span><span class=\"mtk1\"> </span><span class=\"mtk7\">role</span><span class=\"mtk1\"> myapp </span><span class=\"mtk7\">with</span><span class=\"mtk1\"> createdb </span><span class=\"mtk7\">login</span><span class=\"mtk1\"> </span><span class=\"mtk7\">password</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;thepasswordgoeshere&#39;</span></span></span></code></pre>\n<p>Looking back at the service definition, a <a href=\"https://docs.docker.com/storage/bind-mounts/\">bind mount</a> is used to mount <code>init.sql</code> from the project root into the Postgres container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span></code></pre>\n<h2>Second Attempt</h2>\n<p>So why couldn't it find <code>init.sql</code>? Doing some searching led me to a suggestion to try mounting to a folder rather than specific file like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp:/docker-entrypoint-initdb.d/</span></span></span></code></pre>\n<p>So I pushed this change, leaving the debug tmate action in place, triggering another run of the action runner. Then once again used the ssh command provided by tmate to connect to the runner (it provides a different address each time), then ran <code>docker ps</code> to see if this time the Postgres container was running. This time it did look like Postgres started successfully:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az121-980:~/work/myapp/myapp$ docker ps</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS         PORTS                    NAMES</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">42a987ae5e27   redis:6       &quot;docker-entrypoint.s…&quot;   3 minutes ago   Up 3 minutes   0.0.0.0:6379-&gt;6379/tcp   fe73cffdfe5a474cb4844f6018b151f8_redis6_db473b</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">f96addde3fe1   postgres:13   &quot;docker-entrypoint.s…&quot;   3 minutes ago   Up 3 minutes   0.0.0.0:5432-&gt;5432/tcp   aeaf1d3eae4b46948276077399135246_postgres13_3406a2</span></span></code></pre>\n<p>But it was too early to declare success. The question is - was it able to locate the <code>init.sql</code> file and run it to create the <code>myapp</code> role? A check of the logs revealed that did not happen (it would otherwise output <code>CREATE ROLE</code> in the logs). Also note the logs indicate its ignoring the docker entrypoint script:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az121-980:~/work/myapp/myapp$ docker logs aeaf1d3eae4b46948276077399135246_postgres13_3406a2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/usr/local/bin/docker-entrypoint.sh: ignoring /docker-entrypoint-initdb.d/*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[snip]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PostgreSQL init process complete; ready for start up.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.125 UTC [1] LOG:  starting PostgreSQL 13.2 (Debian 13.2-1.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.126 UTC [1] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.126 UTC [1] LOG:  listening on IPv6 address &quot;::&quot;, port 5432</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.129 UTC [1] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.135 UTC [1] LOG:  database system is ready to accept connections</span></span></code></pre>\n<p>Hmm... so the folder mount didn't work. So what is the containers view of the <code>/docker-entrypoint-initdb.d</code> directory? To answer this question, you can use <code>docker exec container_name command</code> to run a command in the container. Let's run bash so we can run further shell commands inside the Postgres container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az121-980:~/work/myapp/myapp$ docker exec -it aeaf1d3eae4b46948276077399135246_postgres13_3406a2 bash</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">root@f96addde3fe1:/# ls -al /docker-entrypoint-initdb.d</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[no output - empty dir]</span></span></code></pre>\n<p>So the <code>/docker-entrypoint-initdb.d</code> directory is empty, which is strange because in the workflow file <code>.github/workflows/ci.yml</code> it's mounted to the project root, so you would think all the project files would be listed.</p>\n<p>And here is where I had a big AHA! moment. Looking at the order in which Github processes the workflow file, the containers are started BEFORE the project source is checked out. This means a bind mount to any file in the project will never work because the project sources don't yet exist on the host (i.e. Github Action runner).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/07bf4b46f29724ffefd08baca207aaef/bc3ae/github-actions-order.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.76971608832807%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABSUlEQVQ4y5WT2W6DMBREkdqEsG9mpxCySFFTpVIeqv7/j009NzUvkSLzcGUD9vj4zuDs/ARekCLNGwRRDj/MpLwgg+vF4HfXS2T+GF+Xww1BXOB2/0Xd7VG1E9rhgLRo8Lbxsd2FuiLrcgxFUfZCGCZKysx5GNdw8YPydQlhqDddv3+gqgH9eNSEM8pm1PMTmn6WFlgLGsKqHYUmiAo5gIR83vnpImYjuvTw8nUXQtIZQvYyySq8bwN7QUPIzXFaLk6TkmOk3626shBqkdPlBlUPIlz/O113E4bprClrbNzQvofM4bB/bGQPSRUlpaZUEh0jZn1lP8wxnz6Rl524yixyzIp2WbjKZU/3aDpcJMyxNoFGcG7CulqQTZ/PV+Sq0+5+oKh6idEaoSdBVwKu5I/hVTPVatcrazOerswsMjbMH0XpOI1ZK/gHm4NEfzLMSvQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github action order\"\n        title=\"github action order\"\n        src=\"/static/07bf4b46f29724ffefd08baca207aaef/5a190/github-actions-order.png\"\n        srcset=\"/static/07bf4b46f29724ffefd08baca207aaef/772e8/github-actions-order.png 200w,\n/static/07bf4b46f29724ffefd08baca207aaef/e17e5/github-actions-order.png 400w,\n/static/07bf4b46f29724ffefd08baca207aaef/5a190/github-actions-order.png 800w,\n/static/07bf4b46f29724ffefd08baca207aaef/c1b63/github-actions-order.png 1200w,\n/static/07bf4b46f29724ffefd08baca207aaef/bc3ae/github-actions-order.png 1268w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Solution</h2>\n<p>So now that we know the root cause of the issue, the problem can be solved. The solution is to use <code>docker exec</code> to run a <code>psql</code> client inside the container to create the role rather than relying on a bind mount. However, in order to run <code>docker exec</code> the container name must be known. As can be seen from the earlier output, by default, the name is dynamically generated. This can be resolved by passing the <code>--name</code> flag in the service options which assigns the container a predictable name:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># volume for bind mount removed!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># assign the container a predictable name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">options</span><span class=\"mtk1\">: </span><span class=\"mtk6\">--name myapp_db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># same as before...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Create role</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">docker exec myapp_db bash -c &quot;PGPASSWORD=shhhhh psql -U postgres -c \\&quot;create role myapp with createdb login password &#39;myapp&#39;\\&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># remainder of the steps...</span></span></span></code></pre>\n<p>And this time the workflow did run successfully. The database was initialized with the role so <code>bundle exec rake:db_reset</code> could complete successfully.</p>\n<h2>Conclusion</h2>\n<p>If you get stuck on a Github Action workflow not running as you would expect, try adding the <a href=\"https://github.com/mxschmitt/action-tmate\">tmate</a> action to your workflow file, ssh to the runner machine, and see what you can find. Remember to remove the debug step when the issue has been resolved.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Debug Github Actions","date":"15 Feb 2021","description":"How to use tmate to debug a github action for running CI with Rails and Postgres","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIFAQT/xAAVAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAABn9EtpnBBr//EABkQAAMBAQEAAAAAAAAAAAAAAAABAgMQEf/aAAgBAQABBQLGZZrlEyxM95//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFREBAQAAAAAAAAAAAAAAAAAAEBL/2gAIAQIBAT8Bk//EABgQAAIDAAAAAAAAAAAAAAAAAAEhAAIg/9oACAEBAAY/AmYrjP8A/8QAGBABAQEBAQAAAAAAAAAAAAAAAQARUWH/2gAIAQEAAT8hVwD1tQjyBsnZXZv/2gAMAwEAAgADAAAAECgf/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAEDAQE/EFdj/8QAFhEBAQEAAAAAAAAAAAAAAAAAEQAB/9oACAECAQE/EN0rF//EABoQAQADAAMAAAAAAAAAAAAAAAEAESFhcaH/2gAIAQEAAT8QpSU4juLG9YHX2AdMIYiPKVUTc//Z","aspectRatio":1.775,"src":"/static/bc9cf9fe62735cdf137667e63704ac8c/14b42/computer-bug.jpg","srcSet":"/static/bc9cf9fe62735cdf137667e63704ac8c/f836f/computer-bug.jpg 200w,\n/static/bc9cf9fe62735cdf137667e63704ac8c/2244e/computer-bug.jpg 400w,\n/static/bc9cf9fe62735cdf137667e63704ac8c/14b42/computer-bug.jpg 800w,\n/static/bc9cf9fe62735cdf137667e63704ac8c/38bc6/computer-bug.jpg 852w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"fields":{"slug":"/blog/debug-github-action/"}}},"pageContext":{"slug":"/blog/debug-github-action/","content":"<p>A few weeks ago I was setting up CI (continuous integration) for a Rails project that uses Sidekiq, Redis, and Postgres. Pretty straightforward, just needed to run a build, install and configure the services (Postgres and Redis), initialize the database, then run linting and tests.</p>\n<p>Prior to the general release of Github Actions, I would have reached for Travis CI or Circle CI to set this up, which involves giving a 3rd party service access to your Github repo. But ever since <a href=\"https://github.com/features/actions\">Github Actions</a> has been available, its no longer necessary to integrate a 3rd party solution. Github Actions support running any workflow on any event such as push to a branch, merge a PR etc. The configuration is done via a yaml file in the <code>.github/workflows</code> directory in your project. No need to install anything, as soon as you push a branch with a workflow yaml in the directory Github looks for, it will start running the jobs and steps specified in the file. By default, the action will run on Github hosted machines but it's also possible to configure a self-hosted runner. For this post, we will be using the Github action runner.</p>\n<p>As great as Github Actions are, sometimes something will go wrong with the workflow, and the console output from the runner will not be sufficient to figure out what the issue is. This post will walk you through a debugging technique you can use to troubleshoot your workflow.</p>\n<h2>First Attempt</h2>\n<p>The <code>ci.yml</code> file shown below was my first attempt at getting a build going for my Rails project. This file specifies the services that are needed (Postgres and Redis) which are defined in the same syntax as a docker-compose file. The next section specifies all the steps that should be run in sequence. These include checking out the project, setting up the necessary Ruby and Node versions, installing the project dependencies with <code>bundle install</code> and <code>yarn install</code>, then initializing the database with <code>rake db:reset</code>, and finally running the linter (rubocop) and RSpec tests.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">push</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RACK_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">DATABASE_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ci</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">6379:6379</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup Ruby 2.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-ruby@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">ruby-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;2.7&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup Node</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-node@v2-beta</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">node-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;12&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">yarn install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">yarn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Initialize database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle exec rake db:reset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Run linter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">rubocop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Run tests</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle exec rspec</span></span></span></code></pre>\n<p>But after pushing this file and monitoring the Actions output (as soon as you push a valid workflow file, Github will run in and display the results in a new <code>Actions</code> tab displayed on your project page on github.com), the workflow failed with the following error displayed under the <code>Initialize database</code> step:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">PG::ConnectionBad: could not connect to server: Connection refused</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Is the server running on host &quot;127.0.0.1&quot; and accepting</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TCP/IP connections on port 5432?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/opt/hostedtoolcache/Ruby/2.7.2/x64/bin/bundle:23:in `load&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/opt/hostedtoolcache/Ruby/2.7.2/x64/bin/bundle:23:in `&lt;main&gt;&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Tasks: TOP =&gt; db:reset =&gt; db:drop =&gt; db:check_protected_environments</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(See full trace by running task with --trace)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Error: Process completed with exit code 2.</span></span></code></pre>\n<p>According to the error message, the rake task to initialize the database could not run because the database server wasn't running. This seemed strange as I had the same services configured locally via a <code>docker-compose.yml</code> file and it worked perfectly on my laptop. What I needed was a way to \"inspect\" the Github runner host machine where this flow was running, to investigate why the database failed to start up.</p>\n<h2>Add Tmate Debugger</h2>\n<p>Fortunately, there's a relatively easy way to do this via a community action named <a href=\"https://github.com/mxschmitt/action-tmate\">tmate</a>. This action can be added as a step anywhere in the workflow. It outputs a temporary hostname that you can ssh to and you will be connected to the runner machine. Here's the modified workflow with tmate added just after checking out sources:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">push</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RACK_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">DATABASE_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ci</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">6379:6379</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup tmate session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mxschmitt/action-tmate@v3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># rest of the steps...</span></span></span></code></pre>\n<p>After pushing this change and monitoring the action runner again, when it got to the <code>Setup tmate session</code> step, the following was displayed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">SSH: ssh HghSLAQZ6JqNEQjPEHTu5prMM@nyc1.tmate.io</span></span></code></pre>\n<h2>Debugging in Runner</h2>\n<p>To make use of this, open a terminal tab (I use iTerm) and enter:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ssh HghSLAQZ6JqNEQjPEHTu5prMM@nyc1.tmate.io</span></span></span></code></pre>\n<p>This opens a temporary ssh session on the Github action runner, that is now paused at the last step it was running. In this case, I put the tmate action just after checking out sources but before the setup Ruby step.</p>\n<p>Recall the error said that the rake task to initialize the database had been unable to connect to Postgres. Since Postgres is supposed to be running in a Docker container (that's what the <code>services</code> section of <code>ci.yml</code> specifies), I listed all the active docker processes with the <code>docker ps</code> command (reminder, I'm on the Github Action runner machine here):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az139-674:~/work/myapp/myapp$ docker ps</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4336ebfbbd89        redis:6             &quot;docker-entrypoint.s…&quot;   4 minutes ago       Up 4 minutes        0.0.0.0:6379-&gt;6379/tcp   d04eb80007624ff19d2b34cb344cf4fd_redis6_d9fced</span></span></code></pre>\n<p>Well that's clearly a problem, only the Redis container is running, so what happened to the Postgres container? To get the answer to this question, list the docker processes again but this time with the <code>-a</code> flag to list <em>all</em> processes, not just the running processes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az139-674:~/work/myapp/myapp$ docker ps -a</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS                    NAMES</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4336ebfbbd89        redis:6             &quot;docker-entrypoint.s…&quot;   5 minutes ago       Up 4 minutes               0.0.0.0:6379-&gt;6379/tcp   d04eb80007624ff19d2b34cb344cf4fd_redis6_d9fced</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3ce2dda6db40        postgres:13         &quot;docker-entrypoint.s…&quot;   5 minutes ago       Exited (1) 5 minutes ago                            d9f1a3d336094b2d8b26703081b78d99_postgres13_67885a</span></span></code></pre>\n<p>Ah, so a Postgres container was started, but something went wrong and it exited shortly after starting. In order to get a clue as to what went wrong, we can check the containers logs using the <code>docker logs</code> command, passing in the container name:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az139-674:~/work/myapp/myapp$ docker logs d9f1a3d336094b2d8b26703081b78d99_postgres13_67885a</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The files belonging to this database system will be owned by user &quot;postgres&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">This user must also own the server process.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The database cluster will be initialized with locale &quot;en_US.utf8&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The default database encoding has accordingly been set to &quot;UTF8&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The default text search configuration will be set to &quot;english&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Data page checksums are disabled.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fixing permissions on existing directory /var/lib/postgresql/data ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">creating subdirectories ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting dynamic shared memory implementation ... posix</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting default max_connections ... 100</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting default shared_buffers ... 128MB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting default time zone ... Etc/UTC</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">creating configuration files ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">running bootstrap script ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">performing post-bootstrap initialization ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">syncing data to disk ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Success. You can now start the database server using:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pg_ctl -D /var/lib/postgresql/data -l logfile start</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">initdb: warning: enabling &quot;trust&quot; authentication for local connections</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">You can change this by editing pg_hba.conf or using the option -A, or</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--auth-local and --auth-host, the next time you run initdb.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">waiting for server to start....2021-01-31 18:52:53.451 UTC [47] LOG:  starting PostgreSQL 13.1 (Debian 13.1-1.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-01-31 18:52:53.461 UTC [47] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-01-31 18:52:53.463 UTC [48] LOG:  database system was shut down at 2021-01-31 18:52:52 UTC</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-01-31 18:52:53.467 UTC [47] LOG:  database system is ready to accept connections</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> done</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">server started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/init.sql</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">psql:/docker-entrypoint-initdb.d/init.sql: error: could not read from input file: Is a directory</span></span></code></pre>\n<p>This reveals another clue, so the database fails to start because it tried to run <code>init.sql</code> but was unable to find it. Before moving on, to exit the debug session, enter <code>touch continue</code> in the runner ssh session, this will end it and the workflow on Github will continue to run after this point.</p>\n<p>Back to the investigation, what is this <code>init.sql</code> file that the Postgres container logs reported as not being able to read? The <code>postgres:13</code> Docker image has support for running one-time initialization sql files. The first time the database is being created, if any files are found in directory <code>/docker-entrypoint-initdb.d</code>, then they will be run.</p>\n<p>For this project, <code>init.sql</code> is located in the project root and is only intended to be used for development and CI where Postgres is run in a container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">create</span><span class=\"mtk1\"> </span><span class=\"mtk7\">role</span><span class=\"mtk1\"> myapp </span><span class=\"mtk7\">with</span><span class=\"mtk1\"> createdb </span><span class=\"mtk7\">login</span><span class=\"mtk1\"> </span><span class=\"mtk7\">password</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;thepasswordgoeshere&#39;</span></span></span></code></pre>\n<p>Looking back at the service definition, a <a href=\"https://docs.docker.com/storage/bind-mounts/\">bind mount</a> is used to mount <code>init.sql</code> from the project root into the Postgres container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span></code></pre>\n<h2>Second Attempt</h2>\n<p>So why couldn't it find <code>init.sql</code>? Doing some searching led me to a suggestion to try mounting to a folder rather than specific file like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp:/docker-entrypoint-initdb.d/</span></span></span></code></pre>\n<p>So I pushed this change, leaving the debug tmate action in place, triggering another run of the action runner. Then once again used the ssh command provided by tmate to connect to the runner (it provides a different address each time), then ran <code>docker ps</code> to see if this time the Postgres container was running. This time it did look like Postgres started successfully:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az121-980:~/work/myapp/myapp$ docker ps</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS         PORTS                    NAMES</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">42a987ae5e27   redis:6       &quot;docker-entrypoint.s…&quot;   3 minutes ago   Up 3 minutes   0.0.0.0:6379-&gt;6379/tcp   fe73cffdfe5a474cb4844f6018b151f8_redis6_db473b</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">f96addde3fe1   postgres:13   &quot;docker-entrypoint.s…&quot;   3 minutes ago   Up 3 minutes   0.0.0.0:5432-&gt;5432/tcp   aeaf1d3eae4b46948276077399135246_postgres13_3406a2</span></span></code></pre>\n<p>But it was too early to declare success. The question is - was it able to locate the <code>init.sql</code> file and run it to create the <code>myapp</code> role? A check of the logs revealed that did not happen (it would otherwise output <code>CREATE ROLE</code> in the logs). Also note the logs indicate its ignoring the docker entrypoint script:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az121-980:~/work/myapp/myapp$ docker logs aeaf1d3eae4b46948276077399135246_postgres13_3406a2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/usr/local/bin/docker-entrypoint.sh: ignoring /docker-entrypoint-initdb.d/*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[snip]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PostgreSQL init process complete; ready for start up.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.125 UTC [1] LOG:  starting PostgreSQL 13.2 (Debian 13.2-1.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.126 UTC [1] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.126 UTC [1] LOG:  listening on IPv6 address &quot;::&quot;, port 5432</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.129 UTC [1] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.135 UTC [1] LOG:  database system is ready to accept connections</span></span></code></pre>\n<p>Hmm... so the folder mount didn't work. So what is the containers view of the <code>/docker-entrypoint-initdb.d</code> directory? To answer this question, you can use <code>docker exec container_name command</code> to run a command in the container. Let's run bash so we can run further shell commands inside the Postgres container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az121-980:~/work/myapp/myapp$ docker exec -it aeaf1d3eae4b46948276077399135246_postgres13_3406a2 bash</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">root@f96addde3fe1:/# ls -al /docker-entrypoint-initdb.d</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[no output - empty dir]</span></span></code></pre>\n<p>So the <code>/docker-entrypoint-initdb.d</code> directory is empty, which is strange because in the workflow file <code>.github/workflows/ci.yml</code> it's mounted to the project root, so you would think all the project files would be listed.</p>\n<p>And here is where I had a big AHA! moment. Looking at the order in which Github processes the workflow file, the containers are started BEFORE the project source is checked out. This means a bind mount to any file in the project will never work because the project sources don't yet exist on the host (i.e. Github Action runner).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/07bf4b46f29724ffefd08baca207aaef/bc3ae/github-actions-order.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.76971608832807%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABSUlEQVQ4y5WT2W6DMBREkdqEsG9mpxCySFFTpVIeqv7/j009NzUvkSLzcGUD9vj4zuDs/ARekCLNGwRRDj/MpLwgg+vF4HfXS2T+GF+Xww1BXOB2/0Xd7VG1E9rhgLRo8Lbxsd2FuiLrcgxFUfZCGCZKysx5GNdw8YPydQlhqDddv3+gqgH9eNSEM8pm1PMTmn6WFlgLGsKqHYUmiAo5gIR83vnpImYjuvTw8nUXQtIZQvYyySq8bwN7QUPIzXFaLk6TkmOk3626shBqkdPlBlUPIlz/O113E4bprClrbNzQvofM4bB/bGQPSRUlpaZUEh0jZn1lP8wxnz6Rl524yixyzIp2WbjKZU/3aDpcJMyxNoFGcG7CulqQTZ/PV+Sq0+5+oKh6idEaoSdBVwKu5I/hVTPVatcrazOerswsMjbMH0XpOI1ZK/gHm4NEfzLMSvQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github action order\"\n        title=\"github action order\"\n        src=\"/static/07bf4b46f29724ffefd08baca207aaef/5a190/github-actions-order.png\"\n        srcset=\"/static/07bf4b46f29724ffefd08baca207aaef/772e8/github-actions-order.png 200w,\n/static/07bf4b46f29724ffefd08baca207aaef/e17e5/github-actions-order.png 400w,\n/static/07bf4b46f29724ffefd08baca207aaef/5a190/github-actions-order.png 800w,\n/static/07bf4b46f29724ffefd08baca207aaef/c1b63/github-actions-order.png 1200w,\n/static/07bf4b46f29724ffefd08baca207aaef/bc3ae/github-actions-order.png 1268w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Solution</h2>\n<p>So now that we know the root cause of the issue, the problem can be solved. The solution is to use <code>docker exec</code> to run a <code>psql</code> client inside the container to create the role rather than relying on a bind mount. However, in order to run <code>docker exec</code> the container name must be known. As can be seen from the earlier output, by default, the name is dynamically generated. This can be resolved by passing the <code>--name</code> flag in the service options which assigns the container a predictable name:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># volume for bind mount removed!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># assign the container a predictable name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">options</span><span class=\"mtk1\">: </span><span class=\"mtk6\">--name myapp_db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># same as before...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Create role</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">docker exec myapp_db bash -c &quot;PGPASSWORD=shhhhh psql -U postgres -c \\&quot;create role myapp with createdb login password &#39;myapp&#39;\\&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># remainder of the steps...</span></span></span></code></pre>\n<p>And this time the workflow did run successfully. The database was initialized with the role so <code>bundle exec rake:db_reset</code> could complete successfully.</p>\n<h2>Conclusion</h2>\n<p>If you get stuck on a Github Action workflow not running as you would expect, try adding the <a href=\"https://github.com/mxschmitt/action-tmate\">tmate</a> action to your workflow file, ssh to the runner machine, and see what you can find. Remember to remove the debug step when the issue has been resolved.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","title":"Debug Github Actions","description":"How to use tmate to debug a github action for running CI with Rails and Postgres"}}}