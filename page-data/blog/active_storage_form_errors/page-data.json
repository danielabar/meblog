{"componentChunkName":"component---src-templates-post-js","path":"/blog/active_storage_form_errors/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">Rails' Active Storage is a powerful, built-in solution for handling file uploads, providing integration with cloud storage and automatic attachment management. It works out of the box, making it easy to associate files with models. However, when a form includes an attachment and a validation errors occur, the uploaded file is lost when the form re-renders to display the validation errors, forcing users to select their file again. This happens because <a href=\"https://guides.rubyonrails.org/active_storage_overview.html\" class=\"markdown-link\">Active Storage</a> only associates a file with a model after a successful save. If the model fails validation, the attachment is not persisted, and the file selection is lost.</p>\n<p class=\"markdown-para\">This post will walk through a solution using direct uploads, hidden signed IDs, and a custom file input with Stimulus. By the end, you'll have a robust way to ensure users don't lose their file uploads due to form validation errors. The complete working solution is also available on <a href=\"https://github.com/danielabar/expense_tracker\" class=\"markdown-link\">GitHub</a>.</p>\n<h2 class=\"markdown-subtitle\" id=\"demo-project-setup\" style=\"position:relative;\"><a href=\"#demo-project-setup\" aria-label=\"demo project setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Demo Project Setup</h2>\n<p class=\"markdown-para\">To demonstrate the issue, we'll setup a new Rails project (as of this writing, I'm on Rails 8.0.2) for a simple expense tracker application. It will have one model, <code>ExpenseReport</code>, which represents an expense submission. This model will have a single file attachment named <code>receipt</code> for users to upload evidence of their expense.</p>\n<p class=\"markdown-para\">The commands to get started:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create new rails application (defaults to sqlite database)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails new expense_tracker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install dependencies and initialize database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/setup</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Initialize Active Storage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails active_storage:install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:migrate</span></span></span></code></pre>\n<p class=\"markdown-para\">The Active Storage installation generates a database migration to create two tables:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\"><code>active_storage_blobs</code> to store information about the uploaded file.</li>\n<li class=\"markdown-list-item\"><code>active_storage_attachments</code>, which associates the blob to a model. This can be any model in your application, which is accomplished via <a href=\"https://guides.rubyonrails.org/association_basics.html#polymorphic-associations\" class=\"markdown-link\">polymorphic association</a> under the hood.</li>\n</ol>\n<p class=\"markdown-para\">Next, the <code>scaffold</code> generator is used to generate a migration, model, controller, views, and routes for the <code>ExpenseReport</code> model. This model will have a dollar amount, description, date on which the expense was incurred, and a receipt, which is an attachment:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails g scaffold ExpenseReport \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  amount:decimal \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  description:text \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  incurred_on:date \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  receipt:attachment</span></span></span></code></pre>\n<p class=\"markdown-para\">The generated migration is modified to ensure amount, description, and incurred_on are always provided:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateExpenseReports</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">8.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:expense_reports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">decimal</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:amount</span><span class=\"mtk1\">, </span><span class=\"mtk4\">precision:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span><span class=\"mtk1\">, </span><span class=\"mtk4\">scale:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">text</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:description</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:incurred_on</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The corresponding <code>ExpenseReport</code> model is also updated to have validation rules matching the database constraints:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ExpenseReport</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_one_attached </span><span class=\"mtk4\">:receipt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:amount</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:description</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:incurred_on</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Finally, the generated form partial <code>app/views/expense_reports/_form.html.erb</code> (which is used for both new and edit actions as per Rails conventions) is modified to display a download link to the attachment, if one exists. This provides a nicer user experience if user needs to edit their expense report, they can see the receipt that is currently attached:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">form_with</span><span class=\"mtk1\">(</span><span class=\"mtk4\">model:</span><span class=\"mtk1\"> expense_report) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |form| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other form fields... --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">label</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">file_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;%# Display download link for current attachment if one exists %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attached?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;Current Receipt:&lt;/</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> link_to expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">filename</span><span class=\"mtk1\">, expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- submit --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe demo code uses <a class=\"markdown-link\" href=\"https://github.com/rails/tailwindcss-rails\">TailwindCSS</a> for styling, but most classes have been removed from the ERB snippets to keep the focus on file attachments and Active Storage behavior.\n</aside>\n<p class=\"markdown-para\">When the form is submitted for a new expense report, the <code>create</code> action in the controller will run. The only change I've made to the generated code is to add a <code>debugger</code> breakpoint after a successful save. This will allow us to inspect the <code>@expense_report</code> model when the model and attachment have been successfully saved:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ExpenseReportsController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @expense_report </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ExpenseReport</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(expense_report_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |format|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @expense_report.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        debugger </span><span class=\"mtk3\"># === ADDED BREAKPOINT HERE ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { redirect_to @expense_report, </span><span class=\"mtk4\">notice:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Expense report was successfully created.&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:new</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>debug</code> gem is included by default in modern Rails projects. If you’re using an older version or don’t have it installed, you can add it to your Gemfile. See the <a href=\"https://guides.rubyonrails.org/debugging_rails_applications.html#debugging-with-the-debug-gem\" class=\"markdown-link\">Rails Debugging Guide</a> for more information.</p>\n<aside class=\"markdown-aside\">\nIn a real-world application, authentication and authorization would be necessary to ensure users can only view and modify their own expense reports. However, this post focuses solely on Active Storage and file persistence, so auth concerns are omitted for simplicity.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"happy-path\" style=\"position:relative;\"><a href=\"#happy-path\" aria-label=\"happy path permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Happy Path</h2>\n<p class=\"markdown-para\">Let's explore how Active Storage works as part of the form submission when all is well.</p>\n<p class=\"markdown-para\">Since the scaffold generator also added the standard CRUD routes for the <code>ExpenseReport</code> model, we can start the Rails server, and navigate to <code>http://localhost:3000/expense_reports/new</code> to create a new expense report:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADZUlEQVR42qWVXWvbVhjH1UHpLrZvkCV+0UZftsVtB8Nb03aMQj9BfZF+gEEbCMli2WuX0e5yux6Mvgw61gwMpYW2Ke1FdtNMXcKgJQmsTWLLli1Ldmwr9Yukc47+48h24jpOSOg5/JCwfX56nvMcPRbw+4QQPiieOPa5OPzVR+K5s6dPR74+cyZyYmgocvToschgKBTx+f0RfyAQCYhB79rPGRjwPu8fGDgnfigOh0KhoeHz5wU+DnwsBv85/ImI8JHDOPnFlxg6eQrhcBjHj3+GTwcH4Q8E8EF/P/r6+rxr0OdDMCjC5/PD5/MhEAzi4KFD/wqC8A4XvndhZOTv7+KXIV265Hw7McEkSWJRKcqkmMSi0SiLxeNsbGyMjY6OsrHxcTYpSWzy+0kmxWL8t048HsfFiyNzgiC86wk1LSejOSgAd4/wNTAKxjzP1hMmk8lO4baDuQyUUbAWtIm3JqNmNoXZXFbWdR0LiwtUzapYXlnGyuoKVpOrUNIKXr56iXQmDUIJXLieuANPqGbVTaGW1+SUksL09EP6/MVzzMzM4OnsU8jPZMzNz+Hxk8dYXFzwImoL3dbsKUxn0jJ/erVW2zFlLiS0mSpp4VCyVaikFW8PCSXUIQ4s227i2LCd5j2/8od24xCHut3CjJqRq7UqUkqKVkxzY/N3A9kuQi5pWA0vwt3KdhS2jgV1sbfZsyidws102a7gEbq9qtywGsjrOuV7yYU8dYeQ3dD72PBKqtks1fJ51Or1prRHVTvhEfKjxk9ATsttFa6V1qhtW150nW/DTkWxbMvbpmwuuylU1YxcNtex9N8K1YsVlMwq1qsW1qt11OoNOIR2pEi72ZpySuFFYVgzMlRNL6NqGmCOiUq5hFLlNQhhcDiUwXYoGpazQb1hU+Z2CUsFRb4/D3zzC6WxW8D4DYYLv7qYXSIwywVoeY6BnKajXDHfaBDtbvOGsKgr8l+LwA9/EPrzHYqf7lBc/ZNi/pWNSrkI3Sgirxse5vrrjVa27TlMplKtfsi/7O6fvftiR5S9hMlZvtRyiG0TStvwTtJr8jTbEErsVoN9tvEXkNNyL/CWwygYS+0ID1y7fu1KIpGYvj11++7U1NS9vcDXJBKJRzd/u/mjIAj7hQcPHwjejSC8/5bsLxQL+/4Hr0Dy8I8wdqcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage new expense report\"\n        title=\"active storage new expense report\"\n        src=\"/static/781f881565028802e71dc471d43ecb93/5a190/active-storage-new-expense-report.png\"\n        srcset=\"/static/781f881565028802e71dc471d43ecb93/772e8/active-storage-new-expense-report.png 200w,\n/static/781f881565028802e71dc471d43ecb93/e17e5/active-storage-new-expense-report.png 400w,\n/static/781f881565028802e71dc471d43ecb93/5a190/active-storage-new-expense-report.png 800w,\n/static/781f881565028802e71dc471d43ecb93/1b1d5/active-storage-new-expense-report.png 876w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Here's the form filled in with valid values and an attachment selected for the receipt:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADfElEQVR42qWVTW8TRxzGt5UQPbTfIE38siCgLzFQqXJLKFWF1E+AD+EblEhRaLwxtFGrSr1U6rE9gOihEjm4Ul8kaBoOPgFLg6qCkqLSxN712rvetRPbsR3vzss+1Wyc2BibQpnRT2N7Zx49z8x/xxK+n5Xih+QTx96WJ98/KJ/58NSpxAenTydOTEwkjh49lhiPxRKhcDgRjkQSETkajKOCsbHg99GxsTPyAXkyFotNTJ49K4m2/3U5+vuRN2TEXzuCk++8i4mT7yEej+P48bfw5vg4wpEIXh0dxcjISDBGQyFEozJCoTBCoRAi0SgOHT78hyRJLwrBlz+amrp9IfUJlIsXycezs1xRFJ5UklyZU3gymeRzqRSfmZnh09PTfOb8eT6vKHz+03muzM2JuSSVSuHcuallSZJeCgQty1Sx0xgA/xkRa+CUnbsibSCYy+V6BYc27nMwzsA7sB2CNUbB6AoWzaJasktYWV1hhWIBa+trWM+uI5vLQs/rePjPQ+SNPCij8OEHwj0EgoVioStoWZaq6RoWf1tk9+7fQyaTwc1bN6HeUbF8dxlLN5awuroSONoV9Dt9oGDeyKseJajWqk+MLAQp24lKOxBGBwuKiVbJYm23Ddfz4HouXOLBI17wXYwicj+EEub3CxqGoba2W2JjWaPZCNyIOKy78UOhwxy2XRe6rjPTsoRTiEMSDv6XoJ7XVWFb2O+N4z9FH3gouq6rnZistywY/2+EQ39w5DZsx2bNVjOIQigBofRpGLyH4iQ1XWe2Y6PtuTtlMeBUexEOm60WExVgWmZfHRIPG5sVRjrl0X0TnnworucyMa9oFruChYKhVutbePD3OrMrNVTrTTRaLraa29huuyCU9URk/TweWcuLQ+EolwxmaGtoVB3Qdg2bmxuoN1oQ204oB2EcHmFou2SP7bbHuN8nuGFr6o0HgPID2JfXgc9+AS78CCxnGaobZVglgQPTslGt1fFoJQxwWC5p6u0s8NUiZ99mOL7J+Ph6ycefOkFtswLbqaBkOwH1rcbeVTa0DnOa1rkPxUOOLv7Qe7HH5SDB3C2x1CXU8yhjuxDGxJvzWBcxd6GMep0L9s7eX4BpmffxnM0pO3/tOtx/6fKlz9Pp9K9XF67+tLCw8POzINak0+nFK99d+UKSpH3StevXpOCDJL3ynOwrV8ov/AuBXPLN3dNlpgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage new expense report filled\"\n        title=\"active storage new expense report filled\"\n        src=\"/static/0b5ac300bc010d21dae33f721edff9bd/5a190/active-storage-new-expense-report-filled.png\"\n        srcset=\"/static/0b5ac300bc010d21dae33f721edff9bd/772e8/active-storage-new-expense-report-filled.png 200w,\n/static/0b5ac300bc010d21dae33f721edff9bd/e17e5/active-storage-new-expense-report-filled.png 400w,\n/static/0b5ac300bc010d21dae33f721edff9bd/5a190/active-storage-new-expense-report-filled.png 800w,\n/static/0b5ac300bc010d21dae33f721edff9bd/1b1d5/active-storage-new-expense-report-filled.png 876w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Submitting the form will pause on the <code>debugger</code> breakpoint in the <code>ExpenseReportsController#create</code> method, just after the model has been successfully saved. You should see something like the following in the terminal where the Rails server was started:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIklEQVR42m2R0W6CQBBFEQSRitootU36BWVR0F1YWVBTbfv/X3SaXTR96cPJzUwyN3dmvHGhCbcNy+bEsrkwKY/MZM+6vZKqE9O9GagMyb4j3Gq8D4mXK7xc3lF/Gu00QdEQV0cy88mi7p1xXLXD4AM3dMf11D9Ia3jEFzW+UGTm6tLZXlwZJmXrjKOyZSI0ca6ZCel4EpKpkKRCktw1EgovvCeMdpK5ap1J5Iw0ya4m3RqmpWKxV6SVYlYqwqJhLGoCUTPOa4J80JFNb+8zV2de+xvvlx8yc2PTf7Hpbry0n7x132y6q7txKjXzWrNqezJz5ln3rNqOtelZakOqJJ5d0Ro+HmBXXdRDnRw6pzaxZxMIhV9IfHFwjKwWB4LioZJfwGatGKa5nuQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage debug create success\"\n        title=\"active storage debug create success\"\n        src=\"/static/e5f7541a0fba95aaeb2d22e30f8c92f9/5a190/active-storage-debug-create-success.png\"\n        srcset=\"/static/e5f7541a0fba95aaeb2d22e30f8c92f9/772e8/active-storage-debug-create-success.png 200w,\n/static/e5f7541a0fba95aaeb2d22e30f8c92f9/e17e5/active-storage-debug-create-success.png 400w,\n/static/e5f7541a0fba95aaeb2d22e30f8c92f9/5a190/active-storage-debug-create-success.png 800w,\n/static/e5f7541a0fba95aaeb2d22e30f8c92f9/58213/active-storage-debug-create-success.png 902w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">In the debug session, we can inspect the <code>blob</code>, which contains the metadata and storage details for the file attached to the expense report's <code>receipt</code>. This includes attributes like <code>id</code>, <code>key</code>, and <code>filename</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">blob</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># &lt;ActiveStorage::Blob:0x000000012657eb18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id: 1,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  key: &quot;6081val5vwpz691v8ukv8tc4zma0&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  filename: &quot;receipt-1.pdf&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  content_type: &quot;application/pdf&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  metadata: {&quot;identified&quot; =&gt; true, &quot;analyzed&quot; =&gt; true},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  service_name: &quot;local&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  byte_size: 7171,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  checksum: &quot;PnVMB8Sc/us7Jy4wxuy07w==&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at: &quot;2025-03-21 12:46:13.604118000 +0000&quot;&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>signed_id</code> method can be called on the blob. This method returns a secure identifier that can be passed to the client. It encodes the blob’s ID along with a cryptographic signature to prevent manipulation. This is how Active Storage allows clients to reference uploaded files:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">blob</span><span class=\"mtk1\">.</span><span class=\"mtk5\">signed_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># &quot;eyJfcmFpbHMiOnsiZGF0YSI6MSwicHVyIjoiYmxvYl9pZCJ9fQ==--42eb19d188a21278e0c6add2449a511283e28afe&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">We can also check whether the <code>receipt</code>, which is an instance of <a href=\"https://api.rubyonrails.org/classes/ActiveStorage/Attached/One.html\" class=\"markdown-link\">ActiveStorage::Attached::One</a>, is <code>attached?</code> and <code>persisted?</code>. That latter method comes from <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html\" class=\"markdown-link\">ActiveRecord::Persistence</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attached?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">persisted?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># let the request continue to get out of debug session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">continue</span></span></span></code></pre>\n<p class=\"markdown-para\">Since the <code>@expense_report</code> model was saved successfully, the controller redirects to the show view for this expense report. The show view has a link to edit, which navigates to <code>http://localhost:3000/expense_reports/1/edit</code>. This renders the shared form partial <code>app/views/expense_reports/_form.html.erb</code>, which now renders a download link for the receipt we just attached:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADe0lEQVR42qWVzW8bRRjGLfVQIcF/EPyxcSUSKSFqFJBQ0tByQOoe+k8EUETb2I4a4ITElVuOxG4RUnPiWhTKgZAgtdmkSYAiippkv2yvl9bEjT9359190LtOUtux06LO6tHs7L7z22dm3pkNYfXr0MRb50bffjd+5cK5/svyxYvy5KUP5MnJ9+Xz50floaFhORqLBZLicVmSJDksxeRwNCJHY1E5HIlc7o/Hr4yMjIxubm2HuJwdjkv3B4bjeG9wEJfGJzBxYRLj4xMYG3sHQ0PDiEkSwuEI+vr68GY4DCkShSRJiEZjiET5vh8DA4P3mcXAN6Y+/mRtdvYGUjfmxLWZGS+RSARKplLeTCLhpVIp79r169709LT36dWr3meJpPf53FzwPplMilQqhampj9aYxcDXc/ncGpqFAPj/U9wHzGBWAFQ1VWkBnlo832sTeRT00XRNOQbmrbxSsAtY31inPXUP2VwWmqZyEFRN5a+DnxumwQD48E8HWgVL0Q0dd364Q6u/rmL5l+VAKysr4PbGgw3c/ekuNrc2A4jfRB6BA6Cu68+BhmkornCxXyq9cMjsUHgU1ME9iSbQ6AAKEshbeWo4DTiuA64bjhOo2W7WHNcqx3WJnbYBzayp1Go1mFmTDsoHgRMOohYnvdTVoWmaCjvSdI2sQgG5fB72P3bg4EVAtxuQG5xQruDXgusA5r/EdbwoncDDYVJ7SpwujuEhn5zDwyFbBYsq1Wqwiq4QL6tuc2govIqarlPBtoMVFUQnVrRT7LJcKRNPEWdKW9pwShT/LZLjNOD51Lm9eqreaBDHtDnMZk2lXKng78e79KS4j9JBGdV6A+VKDdVaHa6g09Q9sR1BePRYo+0/HkHV8yjul2HZRTwtllBvuD1Vqzvk+Z1zmM0qteoBbEsj29JBbrljw51IlRbRyb1s5Q0l99TBz5tFWvvrGf40CL9rHuwSQYijbece6/kB0eNwqJZ05btlYGzWJ/kr4MMvPYzNevhmycX+ExM7ewZ2dlXs7ukwzFyQAS1Ou502+r1KXWB9e8fZeqiKB7/tiPXtHaGZtvB9T7hCCPfwEiQEeXQsQcJhoKqp91oP2Id4xcKMI+DZ+fn5L259e+v7hXTmdjqTWczcvLmYzrAyi+n0wmI6ne6phfTCbe7LjOCvt/TjEkPPhEKh115RZ5j1H6bn6H7y8GJOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage edit expense report\"\n        title=\"active storage edit expense report\"\n        src=\"/static/598f8dd9f6707dd53ed4a6d53fcdc714/5a190/active-storage-edit-expense-report.png\"\n        srcset=\"/static/598f8dd9f6707dd53ed4a6d53fcdc714/772e8/active-storage-edit-expense-report.png 200w,\n/static/598f8dd9f6707dd53ed4a6d53fcdc714/e17e5/active-storage-edit-expense-report.png 400w,\n/static/598f8dd9f6707dd53ed4a6d53fcdc714/5a190/active-storage-edit-expense-report.png 800w,\n/static/598f8dd9f6707dd53ed4a6d53fcdc714/9c177/active-storage-edit-expense-report.png 880w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Recall we modified the form partial earlier to show the download link if one is attached with this code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">&lt;!-- app/views/expense_reports/_form.html.erb --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attached?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;Current Receipt:&lt;/</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> link_to expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">filename</span><span class=\"mtk1\">, expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Right-clicking the download link and selecting \"Copy Link Address\" reveals a long tokenized URL that begins with <code>eyJFcm...</code>. This is the same <code>signed_id</code> we saw earlier in the debug session, confirming that Active Storage uses this signed identifier to securely reference the file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">http://localhost:3000/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsiZGF0YSI6MSwicHVyIjoiYmxvYl9pZCJ9fQ==--42eb19d188a21278e0c6add2449a511283e28afe/receipt-1.pdf</span></span></code></pre>\n<p class=\"markdown-para\">Now let's start a database session with <code>bin/rails db</code> and see what got saved in the active storage database tables:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">sqlite&gt; select id, key, filename, content_type from active_storage_blobs;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">id  key                           filename       content_type</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  ----------------------------  -------------  ---------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   6081val5vwpz691v8ukv8tc4zma0  receipt-1.pdf  application/pdf</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">sqlite&gt; select * from active_storage_attachments;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">id  name     record_type    record_id  blob_id  created_at</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  -------  -------------  ---------  -------  --------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   receipt  ExpenseReport  1          1        2025-03-21 12:46:13.604834</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">sqlite&gt; select id, amount, description, incurred_on from expense_reports;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">id  amount  description                incurred_on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  ------  -------------------------  -----------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   123.45  Uber trip to the airport.  2025-03-21</span></span></code></pre>\n<p class=\"markdown-para\">That <code>id</code>, <code>key</code>, and <code>filename</code> in the <code>active_storage_blobs</code> table matches what we saw in the debug session when inspecting <code>@expense_report.receipt.blob</code>.</p>\n<p class=\"markdown-para\">The record in <code>active_storage_attachments</code> associates that blob to the expense report record with id of <code>1</code>, which we can see is the expense report we just created.</p>\n<p class=\"markdown-para\">Where is the actual file? The answer can be found in <code>config/storage.yml</code>. This file automatically got created earlier when running <code>rails new...</code> and defines storage services the app can use:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">test</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">service</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Disk</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">root</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= Rails.root.join(&quot;tmp/storage&quot;) %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">local</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">service</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Disk</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">root</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= Rails.root.join(&quot;storage&quot;) %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># amazon:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   service: S3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   access_key_id: &lt;%= Rails.application.credentials.dig(:aws, :access_key_id) %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   secret_access_key: &lt;%= Rails.application.credentials.dig(:aws, :secret_access_key) %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   region: us-east-1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   bucket: your_own_bucket-&lt;%= Rails.env %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># other cloud storage providers...</span></span></span></code></pre>\n<p class=\"markdown-para\">Then the <code>config/environments/development.rb</code> file got generated telling Rails to use the <code>local</code> service for development:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Store uploaded files on the local file system (see config/storage.yml for options).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">config.</span><span class=\"mtk5\">active_storage</span><span class=\"mtk1\">.</span><span class=\"mtk5\">service</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:local</span></span></span></code></pre>\n<p class=\"markdown-para\">Here are the contents of the <code>storage</code> directory in the project root:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">tree storage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">storage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── 60</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── 81</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        └── 6081val5vwpz691v8ukv8tc4zma0</span></span></code></pre>\n<p class=\"markdown-para\">The leaf entry <code>6081val5vwpz691v8ukv8tc4zma0</code> is the actual pdf file. Notice that the file name matches the <code>key</code> stored in <code>active_storage_blobs</code> table. It's also the <code>key</code> value we saw when inspecting <code>@expense_report.receipt.blob</code> earlier in the debug session.</p>\n<p class=\"markdown-para\">Going through this happy path has demonstrated that in order for an Active Storage attachment to be saved and associated to a model, the following must occur:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">File uploaded to storage service.</li>\n<li class=\"markdown-list-item\">New record inserted in database table <code>active_storage_blobs</code> with the <code>key</code> matching the file name uploaded to storage.</li>\n<li class=\"markdown-list-item\">New record inserted in database table <code>active_storage_attachments</code> that associates the model to the blob.</li>\n</ol>\n<h2 class=\"markdown-subtitle\" id=\"validation-errors\" style=\"position:relative;\"><a href=\"#validation-errors\" aria-label=\"validation errors permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Validation Errors</h2>\n<p class=\"markdown-para\">Now that we understand what Active Storage does in the success case, it's time to look at what happens when things go wrong. Specifically, what happens when the form is submitted with an attachment, but with one or more validation errors in the other form fields?</p>\n<p class=\"markdown-para\">For this demo, the <code>debugger</code> statement is moved to the <code>else</code> clause in the <code>ExpenseController#create</code> method, so we can inspect what the receipt blob looks like when the model fails to be saved:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ExpenseReportsController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @expense_report </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ExpenseReport</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(expense_report_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |format|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @expense_report.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { redirect_to @expense_report, </span><span class=\"mtk4\">notice:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Expense report was successfully created.&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        debugger </span><span class=\"mtk3\"># === ADDED BREAKPOINT HERE ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:new</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Since the <code>ExpenseReport</code> model requires the description field to be filled in, let's try to submit another expense report with another attachment <code>receipt-2.pdf</code>, leaving description blank:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADVElEQVR42qWVy28bVRSHLXVRIcF/kPgxdiUSqSZVixAJbQSs6Cz6J7AJhSqtEjtqgD0rWCCC2NBIYQMSEmIBEkpVIlEoajLCIQiQIh6dGY89fiR+P2fuuf6hM47dxI5pql7r0x1L93w+59w71z789IHv4rNnzj/3QuTKpTPhy6/Nzqqzr7yqzszMqFPnzqlno1E1GAqpobCihiMRVVEU1a+EVH8woAZDQdUfCFwORyJXpqamzm//uuPjcToaUTYnohFMT07i5ZmXcPHSLKZfnMaFC8/jbDSKUEjB2Pg4xsbGMO73QwkEoSgKgsEQAkF+DmNiYnKTXSx8Zu7qm1tLSzcRv7ksbiwsyMXFRY94PC4XDub5+Xl57dpbcv76dfn2Yky+s7wsY/G4jMViIh6PY27ujS12sfDptJ3eQncQgM5jwjFgB7s8oW7o2iHhyCE7cgiS5MUYpqH1hWk7re3t72F3d5fsjA1d16EbOi/iX8YD/QGslMXB6KDzaGE2m9XMpIn12+uU2E5gY2MDd3+8i3s/30MikcCd7+9g57cdT9DpKg9mT+4JTdN8KExaSc0VLoql0v+WzBkKSd7cQ5DoCpMDQsd1kcllyXEdMG2nS++ZZ0FiCMd1iTM9IrRSltZoNjhtKlfKvd6ciGMz5C8sabaaxKWfVMa4o4QHx4LQb/fJPv1NGSV8WK58JLyWSx7uoWVpbaeNTDZL9UajW4oQJ2U4Q8tKaryThmlSNpfzdlUQHburh+Esa/Wa13c+KQPHxkGhWCDHbUN2aPBtGEmr3fbadCTDVNrSKtU6/tz9hzL5IgqlGqr1Fiq1BhrNFlxxuAU0yHDJhsmbIlHcT1Ha+he1cg7SraBcLqJcbUCQhCukNzsuZ+X2abYckp0BYaVgat9tA69/SLS0Btz4VOLqJx388LtApZRHys7BzuRg21mUypWBm4eG3+VC3tQ2/wLe+1LQx98SPvqG8P7XhF/+dlGtFJDLF5DP7yGf30e1Vu8LR14OumEe3Ifdg32U4+/FQ9fYsNAw9fsc2naF4wgSPVwiIUgMQZL68FIW6oZ+vy+0M/YfeMLBjp7w9MrKyrtrn619dWv11uerq6tfPA4cw7Hs8P711m+vs/SUz+d76gk5xa7/ACP87dBOTAp9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage new expense report description empty\"\n        title=\"active storage new expense report description empty\"\n        src=\"/static/3250ca24b5ca2ff787f4cde386c93ef2/5a190/active-storage-new-expense-report-description-empty.png\"\n        srcset=\"/static/3250ca24b5ca2ff787f4cde386c93ef2/772e8/active-storage-new-expense-report-description-empty.png 200w,\n/static/3250ca24b5ca2ff787f4cde386c93ef2/e17e5/active-storage-new-expense-report-description-empty.png 400w,\n/static/3250ca24b5ca2ff787f4cde386c93ef2/5a190/active-storage-new-expense-report-description-empty.png 800w,\n/static/3250ca24b5ca2ff787f4cde386c93ef2/9c177/active-storage-new-expense-report-description-empty.png 880w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Once again submitting the form will launch us into a debug session. This time, <code>@expense_report.save</code> returned <code>false</code> due to a validation error (because <code>description</code> is required, but was not provided).</p>\n<p class=\"markdown-para\">The debug session shows that there is a blob with a <code>key</code> in memory, and it has a reference to the <code>filename</code> the user uploaded. However it's not persisted - notice the <code>id</code> and <code>created_at</code> attributes are <code>nil</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">blob</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;</span><span class=\"mtk9 mtki\">ActiveStorage</span><span class=\"mtk1\">::</span><span class=\"mtk4\">Blob:0x00000001247b3890</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">id:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;6pyvo9nv8tl81rh8wl3ykkcu6d5e&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">filename:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;receipt-2.pdf&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">content_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;application/pdf&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">metadata:</span><span class=\"mtk1\"> {</span><span class=\"mtk6\">&quot;identified&quot;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk4\">true</span><span class=\"mtk1\">},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">service_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;local&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">byte_size:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">42223</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">checksum:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;IO+1GEvBwGHnvuy0kYIpzw==&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">created_at:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk7\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Also notice if we try to invoke the <code>signed_id</code> method on the blob, an error is raised that it's not possible to have a signed_id on a new record. We'll see why this is important shortly when observing what happens on the page:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">blob</span><span class=\"mtk1\">.</span><span class=\"mtk5\">signed_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># eval error: Cannot get a signed_id for a new record</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># nil</span></span></span></code></pre>\n<p class=\"markdown-para\">Another interesting observation is that <code>@expense_report.receipt.attached?</code> returns <code>true</code> even though the blob isn't actually persisted. So this just means that the user is attempting to attach a file. <code>persisted?</code> however returns <code>false</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attached?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">persisted?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># false</span></span></span></code></pre>\n<p class=\"markdown-para\">Before turning our attention to what happens on the page, let's launch another database session <code>bin/rails db</code> and observe that there are no new entries in the active storage tables:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"># NO NEW BLOBS - THIS IS THE PREVIOUS HAPPY PATH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">sqlite&gt; select id, key, filename, content_type from active_storage_blobs;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">id  key                           filename       content_type</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  ----------------------------  -------------  ---------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   6081val5vwpz691v8ukv8tc4zma0  receipt-1.pdf  application/pdf</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># NO NEW EXPENSE REPORTS - THIS IS THE PREVIOUS HAPPY PATH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">sqlite&gt; select id, amount, description, incurred_on from expense_reports;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">id  amount  description                incurred_on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  ------  -------------------------  -----------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   123.45  Uber trip to the airport.  2025-03-21</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># NO NEW ATTACHMENTS - SINCE THERE&#39;S NO NEW BLOB OR EXPENSE REPORT TO ASSOCIATE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># THIS RECORD IS FROM THE PREVIOUS HAPPY PATH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">sqlite&gt; select * from active_storage_attachments;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">id  name     record_type    record_id  blob_id  created_at</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  -------  -------------  ---------  -------  --------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   receipt  ExpenseReport  1          1        2025-03-21 12:46:13.604834</span></span></code></pre>\n<p class=\"markdown-para\">We can also check the <code>storage</code> directory in the project root and observe that there are no new files uploaded, even though the user did attempt to upload a new file <code>receipt-2.pdf</code>. The only file is listed is from the previous happy path, which was <code>receipt-1.pdf</code> with a key of <code>6081val5vwpz691v8ukv8tc4zma0</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">storage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── 60</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── 81</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        └── 6081val5vwpz691v8ukv8tc4zma0</span></span></code></pre>\n<p class=\"markdown-para\">Now let's look at what happens on the page in the browser. Normally when there is a model validation error on <code>create</code>, the expected result is that the new view renders the form again, displaying the validation errors. Any data the user had entered into the form fields is preserved.</p>\n<p class=\"markdown-para\">However, in this case, an error page is displayed with error message: \"Cannot get a signed_id for a new record\":</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEBElEQVR42qWVS4/bVBiGLSqokIpg1ZGSTGwncXyJbyfHl9iOY+c2E8aIFFo2wAJVgqFQlQViKpD4OWWFBBs2iA0sYOJ2yZ+pepIXHXfSBDGiKkR69B6f6Dzx932WI+Cnb4VEalDbaSzTw/rJ3A+KNIqLLIqKxPcLQ1EKsVYrpHq9kBuNQqrXikatVjQODormwUHRuH79RK7Xl7aq0vLnXwT+uepa5nlvYCPxPYynM6RHxxgdLzCcz2GHIVq9Hg673YqmqqKt62ibJmTThNTroW3bMKh3zl1c+NqHlrX6jAa4E4RPPva89aeet/6EkCpPCVnf8bz1bcdZf2QY69uus75H6fpeEK5PLWt9appPTnsmPlC1FXdx4bUf33h99YgSnDsWW9H+ZmWZm/OWvFmZxqb0vc2KuJtHSbR56Dqbh5RsStrfnOva5jdB2PwqCOx3QcAPV15aCa+8fK0SRopSLuMYyzhmyyjCghC8SSmOXBcLz3u65nuehwWlFceEVN8fE8JyXYddq5XcVQnVXq+MswzxaMSGeQ7DcaBZFkxC0NE0SJ3OUxRlx26PiZ0O6qK4J+x2y2w0QpqmLB2myEYZ8jwHcQksy7oU27Jh2xXMsR0onc5O2K2EGU4Wb7J3ljdw692beLt4C0fTGY5n84qjC7bX88kMk3yMaT5mkyxHzzB2wraqlTdMC18YPfbNZIKz0Qj3JxN8lWW4Px7jLM9xdpF8/yzL8WWa4vM+xV3qsbthiEjTdkJF6ZbZMMX7t95jN5c3MB9PcDSZXs50VuXxlDPDYjpji9kclmnuCTtKGSdDTOdzluVj5JwxZ1JR7V3kds0ZT6bIxmM2TEfQdX1vKJpWekGAYDBg4WDAE2EUIeClxDGSJEESx4iiCIPBAHEUwfd9UEqrobRkGeL+lLVOpwx6PVDDYJ5pYmBbGNg2fMtCYNtwXReO41RT5cmnrOs6JEmCLMus1Wr9Xah3OmXqOEgJYbHrILZMDCwLCSHwDAPNZrNCFMVnyWVcdKlQ0/UyHg4RJwkbxDE4vGw/DGG7LlRVhaZpVfI7UxSFi7b8U9hV1TLgfQlDFoYBwjCsemRvH2LbrpIQ8qxk0zRhGMblwvbhYWk1m9AlkbXa7aoUTntvvX/Nc8ulQkOWy6nahddqsaYoVqXwHl00/V9ptVqXlKxp5fzkBMloxHhJuq5VpXGeJ+R3yLPZbO6/HNSSP2fDJGFxHFc9483XdaMaxHNgqqrxQe2EhPRLSj30+5T1+xQXa2zXz4F5ng/XJTuhZdl/XEge9/v0yQvymJ/ljmdCx3H/9P0A/Jf+C/wsd2yFV0VR/FqW5e8lSXogSfJ3L4b0gJ/ljupfT5JkLr0iCMKr/5Mr3PUX3jmZNv6BphgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage new expense report error\"\n        title=\"active storage new expense report error\"\n        src=\"/static/ca52e5bf306b517de81adafae3fee40d/5a190/active-storage-new-expense-report-error.png\"\n        srcset=\"/static/ca52e5bf306b517de81adafae3fee40d/772e8/active-storage-new-expense-report-error.png 200w,\n/static/ca52e5bf306b517de81adafae3fee40d/e17e5/active-storage-new-expense-report-error.png 400w,\n/static/ca52e5bf306b517de81adafae3fee40d/5a190/active-storage-new-expense-report-error.png 800w,\n/static/ca52e5bf306b517de81adafae3fee40d/9c177/active-storage-new-expense-report-error.png 880w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">The Rails server output also shows the error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ActionView::Template::Error (Cannot get a signed_id for a new record)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Caused by: ArgumentError (Cannot get a signed_id for a new record)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Information for: ActionView::Template::Error (Cannot get a signed_id for a new record):</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    40:     &lt;% if expense_report.receipt.attached? %&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    41:       &lt;div&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    42:         &lt;strong&gt;Current Receipt:&lt;/strong&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    43:         &lt;%= link_to expense_report.receipt.filename, expense_report.receipt %&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    44:       &lt;/div&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    45:     &lt;% end %&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    46:   &lt;/div&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/views/expense_reports/_form.html.erb:43</span></span></code></pre>\n<p class=\"markdown-para\">We saw in the debug session that <code>expense_report.receipt.attached?</code> returns <code>true</code>, even though the attachment didn't actually get associated to the model. This means the view code will attempt to generate a download link <code>&#x3C;%= link_to expense_report.receipt.filename, expense_report.receipt %></code>. But in order to do this, it needs a <code>signed_id</code> for the file, which isn't available because the file hasn't been uploaded to storage and is not associated to the model.</p>\n<p class=\"markdown-para\">The next section will walk through how to solve this.</p>\n<h2 class=\"markdown-subtitle\" id=\"1-check-persisted\" style=\"position:relative;\"><a href=\"#1-check-persisted\" aria-label=\"1 check persisted permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Check Persisted</h2>\n<p class=\"markdown-para\">The most immediate problem to be solved is to not render the 500 Server Error page, so at the very least, the user can continue to interact with the form. From our earlier debug session, we saw that while <code>expense_report.receipt.attached?</code> returned true when an attachment had been attempted but the form had not been saved, <code>expense_report.receipt.persisted?</code> returned false.</p>\n<p class=\"markdown-para\">Let's switch the portion of the form partial that attempts to render a download link to the receipt to check for <code>persisted?</code> rather than <code>attached?</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">form_with</span><span class=\"mtk1\">(</span><span class=\"mtk4\">model:</span><span class=\"mtk1\"> expense_report) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |form| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- form fields... --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- Receipt Attachment --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">label</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">file_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;%# Display current attachment if there is one %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;%# === CHANGE CHECK TO PERSISTED HERE === %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">persisted?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;Current Receipt:&lt;/</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> link_to expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">filename</span><span class=\"mtk1\">, expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- submit --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Now we can again try to create a new expense report, with a receipt, and blank description. This time when the form is submitted, it will render in an error state, showing that the Description must be provided, i.e. classic Rails CRUD behavior. And it will not attempt to render a download link to the receipt because there isn't one:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 119.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEGElEQVR42qWV3U/bVhiH3QxNQisEbaPZ0saJoQWEhIBO9GbFG532z5ChtWsADWm74WY3k3ZJxpYMwSSkXUy73VUlVHWbEIS2G4WGAG0gtvNB7MT58Pn4TXbc8LGu69RjPZJl6zx+z/u+51gQBOHc+/1XhoavXR77qL9P/nhsTP7wxg15ZGREHhoelnv7+uSQJMlXenocurq7ZelytxwIhWSpS5KDoZD9bGxwcHBIaIzXOga6ux71D3Tj+sAAPrg+itFRGSMj13D16nvo6emBKIp41++H3+/HpUAAYiCALkmCGAw6hCQJvb192+c8Hq/wptfrC09MJKenP0dkepp9dvs2j0QifHJykkdsIhGH8fFxHg6H+ac3b/LIrVv8y5kZHpmcst+xqakphMOfpFpbWy8IIUnyFY7yj9EYFAD/n9hzcFQ82uno6OgUJEnyHWYOk66Q4QWDMtqEHd87czJKJuUI/X6/L5vLJo2SgXt//M62ko+x8fAB1jYSeLj5Fza3t7CaWIf9nLkhMfATMEeoqEpDeOniRZ+a1ZK1WhUbv91j24l1JFZWkLh7F5urq9haW8PqnTvYvX8f3NDBdB2sXgcjFphlU28INTXV4fV2ClIw6MuoSmPJuTzDTgpI7QJPngLJHXstgK4D+TxYOg2WPgAvFsENA1w37A8wO25H2N7eKYii6FM1NWnnJK+prG4YoNUKSLUCapqgVh2EunnjrAElxxByvGQ7wqaQMzxJp1mpYoKCw2IUhDNHRig5A21iuUJVU1NeWxgMBn2KqiS5U/oiK5tlJ5rnTX4eFj0jFAMBJ0JKCdTDQ1bIZcEpeWkYsU4XJeRG6Pap85K5ffafNPLJ7GnNopwUcnD2rM9e9mJ2Y3PWWLItDIpiQ8gZyrrOamYZnBC7v9w+exH1U0t2chgQ3Rwyir39PXZweIBqrXqmMC7kNJRSmKbJ7Ej/UWX7K0VDZ/YW/Dch5dTeau5FnY1XqZ8RBtwqW4RgZ3ef6SUTlZqFap2gTpw+Q71uOS1S1qs4UkrQcyb0rAkjb+IoU2LUYlCzaqrtvFuUjNKIMK8dsFTyETTlKUhNR6GQg6YVUdgvwixUkNs3sLeuYjehYG9DxV5Cxf4D1UmjI3yjrVN4+52QL59TkkoR+Ooni339M+Hf/EL47DLlK39a3ChmeUbLcUXVeEbVuFEqccoYJ5RyyyL82fHVPG3e8oV8hbyynS4Ak3FizSxS+sWPlE58S+mvaxYtGzmaUXNUUTWqqFlaKpftA5VyMMrBKePMcoVJRxgK2W2jHuAVh5bVMu3t7ReElpaWtrno3OwPCwvLc/Oxxeh8fCk6H3P47vvYUiweW4rFThCPLcXj8SaxeGxxYWFhORqNzgqCcN798wkeQRBef0U8Ho9H+BsZbavgDCRpIwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage new expense report upload lost\"\n        title=\"active storage new expense report upload lost\"\n        src=\"/static/fe2438e89f30dd91d625d68d09928bd5/5a190/active-storage-new-expense-report-upload-lost.png\"\n        srcset=\"/static/fe2438e89f30dd91d625d68d09928bd5/772e8/active-storage-new-expense-report-upload-lost.png 200w,\n/static/fe2438e89f30dd91d625d68d09928bd5/e17e5/active-storage-new-expense-report-upload-lost.png 400w,\n/static/fe2438e89f30dd91d625d68d09928bd5/5a190/active-storage-new-expense-report-upload-lost.png 800w,\n/static/fe2438e89f30dd91d625d68d09928bd5/23266/active-storage-new-expense-report-upload-lost.png 923w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">But this exposes a new problem - the user's upload has been lost. This is unlike the other form fields that Rails was able to remember what user previously filled in (amount and incurred_on date). In order to proceed, the user needs to fill in the Description field <em class=\"markdown-emphasis\">and</em> select the receipt from their file system again. It would be nice if we could remember the file they were trying to upload, just like all the other form fields that were remembered.</p>\n<h2 class=\"markdown-subtitle\" id=\"2-direct-upload\" style=\"position:relative;\"><a href=\"#2-direct-upload\" aria-label=\"2 direct upload permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Direct Upload</h2>\n<p class=\"markdown-para\">This leads us to the next part of the solution. By default, when using Active Storage, file uploads and database record creation happen in a single request when the user submits the form. The server handles both tasks: uploading the file to the storage service, and creating the corresponding database record for the file in the <code>active_storage_blobs</code> table.</p>\n<p class=\"markdown-para\">An alternative approach is to enable <a href=\"https://guides.rubyonrails.org/active_storage_overview.html#direct-uploads\" class=\"markdown-link\">Direct Uploads</a>. With direct uploads, client-side JavaScript will first make a request to upload the file to the storage service, and once the upload is complete, it will send a request to the Rails server to create the corresponding record in the <code>active_storage_blobs</code> table. This happens separately from submitting the form to create the expense report. Having separate requests for file upload vs form submission provides flexibility to save the file, <em class=\"markdown-emphasis\">regardless</em> of the expense report being saved successfully or not.</p>\n<p class=\"markdown-para\">Since Direct Uploads is a JavaScript feature, the steps to enable it depend on what front-end build system your project is using. The demo project is using Rails 8 with Propshaft and import maps so the steps are to add an entry to the import maps and initialize Active Storage in the application's JavaScript:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/importmap.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">pin </span><span class=\"mtk6\">&quot;@rails/activestorage&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">to:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;activestorage.esm.js&quot;</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"javascript\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// app/javascript/application.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk4\">*</span><span class=\"mtk1\"> </span><span class=\"mtk7\">as</span><span class=\"mtk1\"> ActiveStorage </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@rails/activestorage&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ActiveStorage.</span><span class=\"mtk5\">start</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p class=\"markdown-para\">Instructions for other setups can be found in the <a href=\"https://guides.rubyonrails.org/active_storage_overview.html#direct-uploads\" class=\"markdown-link\">Rails Guide on Active Storage</a> and <a href=\"https://api.rubyonrails.org/files/activestorage/README_md.html\" class=\"markdown-link\">Direct upload installation</a>.</p>\n<p class=\"markdown-para\">With Direct Upload enabled, we can add the <code>direct_upload: true</code> option for the <code>file_field</code> helper in the form partial:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">form_with</span><span class=\"mtk1\">(</span><span class=\"mtk4\">model:</span><span class=\"mtk1\"> expense_report) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |form| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other fields... --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">label</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- === USE DIRECT UPLOAD HERE === --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">file_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\">, </span><span class=\"mtk4\">direct_upload:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- submit --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">After restarting the Rails server, we can once again attempt to submit an expense with <code>receipt-2.pdf</code> attachment and description field left blank:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADVElEQVR42qWVy28bVRSHLXVRIcF/kPgxdiUSqSZVixAJbQSs6Cz6J7AJhSqtEjtqgD0rWCCC2NBIYQMSEmIBEkpVIlEoajLCIQiQIh6dGY89fiR+P2fuuf6hM47dxI5pql7r0x1L93w+59w71z789IHv4rNnzj/3QuTKpTPhy6/Nzqqzr7yqzszMqFPnzqlno1E1GAqpobCihiMRVVEU1a+EVH8woAZDQdUfCFwORyJXpqamzm//uuPjcToaUTYnohFMT07i5ZmXcPHSLKZfnMaFC8/jbDSKUEjB2Pg4xsbGMO73QwkEoSgKgsEQAkF+DmNiYnKTXSx8Zu7qm1tLSzcRv7ksbiwsyMXFRY94PC4XDub5+Xl57dpbcv76dfn2Yky+s7wsY/G4jMViIh6PY27ujS12sfDptJ3eQncQgM5jwjFgB7s8oW7o2iHhyCE7cgiS5MUYpqH1hWk7re3t72F3d5fsjA1d16EbOi/iX8YD/QGslMXB6KDzaGE2m9XMpIn12+uU2E5gY2MDd3+8i3s/30MikcCd7+9g57cdT9DpKg9mT+4JTdN8KExaSc0VLoql0v+WzBkKSd7cQ5DoCpMDQsd1kcllyXEdMG2nS++ZZ0FiCMd1iTM9IrRSltZoNjhtKlfKvd6ciGMz5C8sabaaxKWfVMa4o4QHx4LQb/fJPv1NGSV8WK58JLyWSx7uoWVpbaeNTDZL9UajW4oQJ2U4Q8tKaryThmlSNpfzdlUQHburh+Esa/Wa13c+KQPHxkGhWCDHbUN2aPBtGEmr3fbadCTDVNrSKtU6/tz9hzL5IgqlGqr1Fiq1BhrNFlxxuAU0yHDJhsmbIlHcT1Ha+he1cg7SraBcLqJcbUCQhCukNzsuZ+X2abYckp0BYaVgat9tA69/SLS0Btz4VOLqJx388LtApZRHys7BzuRg21mUypWBm4eG3+VC3tQ2/wLe+1LQx98SPvqG8P7XhF/+dlGtFJDLF5DP7yGf30e1Vu8LR14OumEe3Ifdg32U4+/FQ9fYsNAw9fsc2naF4wgSPVwiIUgMQZL68FIW6oZ+vy+0M/YfeMLBjp7w9MrKyrtrn619dWv11uerq6tfPA4cw7Hs8P711m+vs/SUz+d76gk5xa7/ACP87dBOTAp9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage new expense report description empty\"\n        title=\"active storage new expense report description empty\"\n        src=\"/static/3250ca24b5ca2ff787f4cde386c93ef2/5a190/active-storage-new-expense-report-description-empty.png\"\n        srcset=\"/static/3250ca24b5ca2ff787f4cde386c93ef2/772e8/active-storage-new-expense-report-description-empty.png 200w,\n/static/3250ca24b5ca2ff787f4cde386c93ef2/e17e5/active-storage-new-expense-report-description-empty.png 400w,\n/static/3250ca24b5ca2ff787f4cde386c93ef2/5a190/active-storage-new-expense-report-description-empty.png 800w,\n/static/3250ca24b5ca2ff787f4cde386c93ef2/9c177/active-storage-new-expense-report-description-empty.png 880w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">The controller still has the <code>debugger</code> breakpoint in the failure case - which it will stop on because the model is invalid:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ExpenseReportsController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @expense_report </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ExpenseReport</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(expense_report_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |format|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @expense_report.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { redirect_to @expense_report, </span><span class=\"mtk4\">notice:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Expense report was successfully created.&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        debugger </span><span class=\"mtk3\"># === BREAKPOINT WHEN MODEL INVALID ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:new</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here we are in the debug session after submitting the form. This time when inspecting the receipt blob, there's a significant difference: The blob has an <code>id</code> and we can invoke the <code>signed_id</code> method on it successfully!</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === HAS AN ID! ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">blob</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;ActiveStorage::Blob:0x000000016341c800</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id: 2,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  key: &quot;8gxcs3hkovtiapbmrjx0f32ejqhy&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  filename: &quot;receipt-2.pdf&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  content_type: &quot;application/pdf&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  metadata: {&quot;identified&quot; =&gt; true},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  service_name: &quot;local&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  byte_size: 42223,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  checksum: &quot;IO+1GEvBwGHnvuy0kYIpzw==&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at: &quot;2025-03-25 13:01:01.188138000 +0000&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === SIGNED_ID WORKS! ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">blob</span><span class=\"mtk1\">.</span><span class=\"mtk5\">signed_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># &quot;eyJfcmFpbHMiOnsiZGF0YSI6MiwicHVyIjoiYmxvYl9pZCJ9fQ==--cb69cfd5043d24d8af9c289739183e40974271c6&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attached?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">persisted?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># false</span></span></span></code></pre>\n<p class=\"markdown-para\">Another significant difference can be observed in the database: <code>receipt-2.pdf</code> has been added to <code>active_storage_blobs</code> with <code>id</code> of <code>2</code>, which matches what was shown in the debug session for <code>@expense_report.receipt.blob</code>. There are no new records in <code>active_storage_attachments</code> or <code>expense_reports</code> because the model wasn't saved, but at least, the receipt blob did get saved:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== NEW BLOB GOT SAVED ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">sqlite&gt; select id, key, filename, content_type from active_storage_blobs;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">id  key                           filename       content_type</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  ----------------------------  -------------  ---------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   6081val5vwpz691v8ukv8tc4zma0  receipt-1.pdf  application/pdf</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2   8gxcs3hkovtiapbmrjx0f32ejqhy  receipt-2.pdf  application/pdf</span></span></code></pre>\n<p class=\"markdown-para\">Another important difference is in the <code>storage</code> directory, which shows a new file with the <code>receipt-2.pdf</code> key of <code>8gxcs3hkovtiapbmrjx0f32ejqhy</code> was uploaded:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">tree storage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">storage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── 60</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   └── 81</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│       └── 6081val5vwpz691v8ukv8tc4zma0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── 8g</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── xc</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        └── 8gxcs3hkovtiapbmrjx0f32ejqhy</span></span></code></pre>\n<p class=\"markdown-para\">If you want to see even more details of how this happened, keep the Network tab of your browser Developer Tools open while submitting the form. There will be three requests:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABDklEQVR42j2P7W6CQBBFeRYtoIAtFmFZ2AWWD4tIiTX6/o9yGrapP05m5t7czIxTlBrP37/wdwFh9E7b9mhdc0ozTNtbTemarhts/+b6uN7Osvb/s2NMRyYkslAoVREdPmyg68+cUvHyVq0xHefzSN0Yu6xUFbqq6frh74CqwSmVQukK07a0XY/IJZ7nW83f7YjjI/sgZLPZ2uBlulqmeeY8joyXidv9zuP5ZFkWnK6uaZSmVpqhMVRKEYQRzVqDkFOSUKQZrucz9gO36crPdWVm/hq5DAOP74W2MeSywFFZhsoE4jNBZ4IkjgmCCJEkhGFEEh+tH0UHtBAYWWCkpExT6jynEoJGSqL1i63LL/6Upk5EmvROAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage direct upload network requests\"\n        title=\"active storage direct upload network requests\"\n        src=\"/static/0c30fd0eac25c325d6e077161ac0689b/5a190/active-storage-direct-upload-network-requests.png\"\n        srcset=\"/static/0c30fd0eac25c325d6e077161ac0689b/772e8/active-storage-direct-upload-network-requests.png 200w,\n/static/0c30fd0eac25c325d6e077161ac0689b/e17e5/active-storage-direct-upload-network-requests.png 400w,\n/static/0c30fd0eac25c325d6e077161ac0689b/5a190/active-storage-direct-upload-network-requests.png 800w,\n/static/0c30fd0eac25c325d6e077161ac0689b/58fee/active-storage-direct-upload-network-requests.png 1051w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Direct Upload Request:</strong> The first request (<code>/rails/active_storage/direct_uploads</code>) is made from the client-side JavaScript to the Rails server to initiate the upload. This request contains metadata about the file (like its name, content type, checksum, etc.). The Rails server then responds with an upload URL and a <code>signed_id</code> to track the file.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">File Upload to Storage:</strong> The second request (<code>/rails/active_storage/disk/...</code>) is a PUT request that uploads the file (e.g., <code>receipt-1.pdf</code>) to the storage service, using the URL provided in the first request. The client sends the file's binary data in the body of this request.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Form Submission:</strong> The third request is a regular form submission to create the <code>ExpenseReport</code> (e.g., <code>POST /expense_reports</code>).</li>\n</ul>\n<aside class=\"markdown-aside\">\nThe form submission is of type `fetch` rather than `document` because <a class=\"markdown-link\" href=\"https://turbo.hotwired.dev/handbook/drive\">Turbo Drive</a> is enabled. This intercepts all link clicks and form submissions and turns them into background requests, which allows the page to update without a full reload.\n</aside>\n<p class=\"markdown-para\">Even though the form submission failed with a status of 422 due to the validation error, the file upload requests were able to proceed independently of the form submission.</p>\n<p class=\"markdown-para\">Recall earlier when walking through the <a href=\"../active_storage_form_errors#happy-path\" class=\"markdown-link\">Happy Path</a>, we learned that three things need to be true for an attachment to be successfully saved:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">File uploaded to storage service.</li>\n<li class=\"markdown-list-item\">New record inserted in database table <code>active_storage_blobs</code> with the <code>key</code> matching the file name uploaded to storage.</li>\n<li class=\"markdown-list-item\">New record inserted in database table <code>active_storage_attachments</code> to associate the model to the blob.</li>\n</ol>\n<p class=\"markdown-para\">By enabling Direct Uploads, the first two of these have completed, even when the model couldn't be saved due to validation errors. This is progress 🙏</p>\n<p class=\"markdown-para\"><em class=\"markdown-emphasis\"><strong class=\"markdown-strong\">Quick notes on direct uploads:</strong></em></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">It's worth implementing even if you don't encounter the validation issue, since it prevent slow clients from tying up application server threads during uploads.</li>\n<li class=\"markdown-list-item\">If you're uploading directly to a third-party storage service like S3 , make sure you've configured <a href=\"https://guides.rubyonrails.org/active_storage_overview.html#cross-origin-resource-sharing-cors-configuration\" class=\"markdown-link\">CORS</a> to allow direct uploads from your app.</li>\n<li class=\"markdown-list-item\">Be sure to schedule a job to <a href=\"https://guides.rubyonrails.org/active_storage_overview.html#purging-unattached-uploads\" class=\"markdown-link\">purge unattached uploads</a>, which can accumulate if users abandon the form after a validation error.</li>\n</ul>\n<p class=\"markdown-para\">Back on the page, it still displays the same validation error message as before about missing Description, and the user still needs to select their file again. Now we're in a good position to improve the user experience.</p>\n<h2 class=\"markdown-subtitle\" id=\"3-hidden-signed-id\" style=\"position:relative;\"><a href=\"#3-hidden-signed-id\" aria-label=\"3 hidden signed id permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Hidden Signed ID</h2>\n<p class=\"markdown-para\">When using Direct Uploads, the file is uploaded and a blob is created immediately, even before the form is successfully submitted. This gives us access to the blob’s <code>signed_id</code>, which we can use to re-attach the file later.</p>\n<p class=\"markdown-para\">To avoid forcing the user to re-select their file after a validation error, we can store the <code>signed_id</code> in a hidden field. On the next successful form submission, Rails will associate the already-uploaded file with the model using this ID.</p>\n<p class=\"markdown-para\">However, we only want to render the hidden field if the file was uploaded (<code>attached?</code>) but not yet saved with the record (<code>persisted?</code>). That’s how we know the user attached something, but the form failed validation.</p>\n<p class=\"markdown-para\">Here’s how to implement that in the form partial:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">form_with</span><span class=\"mtk1\">(</span><span class=\"mtk4\">model:</span><span class=\"mtk1\"> expense_report) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |form| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other fields... --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">label</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">file_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\">, </span><span class=\"mtk4\">direct_upload:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;%# === ADD HIDDEN SIGNED_ID HERE === %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attached?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk1\">expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">persisted?</span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">hidden_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\">, </span><span class=\"mtk4\">value:</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">signed_id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- submit --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Once again let's try the test case of submitting the form with an attachment, but description left blank. It will render with validation errors as expected, but this time, inspecting the DOM will show a hidden field is rendered containing the <code>signed_id</code> of the receipt upload:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"htm\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">form</span><span class=\"mtk1\"> </span><span class=\"mtk5\">action</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;/expense_reports&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">method</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;post&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other fields... --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- what the user sees --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;expense_report_receipt&quot;</span><span class=\"mtk1\">&gt;Receipt&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;file&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;expense_report[receipt]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;expense_report_receipt&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- === NEW: HIDDEN FIELD WITH ATTACHMENT SIGNED_ID --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">value</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;8gxcs3h...&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">autocomplete</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;off&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;hidden&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;expense_report[receipt]&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;expense_report_receipt&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- submit --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">form</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">As far as the user is concerned, the file upload still looks \"lost\" because the native file picker still displays \"No file chosen\". But things are different this time because we have a reference to the file upload via the hidden <code>signed_id</code> field:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 134%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEIklEQVR42qWV3W/bVBjGIw3EBX8Ca5tkrTY8urbSwi5W0VYim9pGDIkLJAQS4g8olUhFe79dDG7gBoTEFbcgQGKIFa2gdVq1sFUqndr0M7YTp86nk9iJa/scnwf5JGmcFbZOHOun8zrHfnTe1895E5gZHwsMh8OvRCIDgyMDfcLV1y8Jl8fGhNHRUeHC0JAwPDIinD13VgiFQ0IoFBKCoZDQE+wTevt6eRwKh4X+gYHBC0NDp6djsYA3Tr0aDC0NDZ/BpcFz9tTlUfLGxAQZHxsnkUiEXLwYIf39A6Snt5f09vVxgsEgCYZCPD7d02OHz5zB+fOv3QXABV+OXrnyVyz2Fq5de9udnp6GRywW40xNTXGi0SjGJyZwNRrFO9Mx71lMTk56a663/mY0uhoIBF7iguuP1x/U9BpK5RIpa2WmVTTmzWVN43Hn/jhaRSM1XcfG5sajI0ElqyTQHBTPP/g7ak7tCIqSyAUZcynAWs8xH3wN1KVwn4C6lAtmlExHcGsrmfh96Q4Wl+7QpeW7+PnWL7i1eBt/3FvGn/eW8f1PP2J55T4cMC7vchi/XL4JQMkqHUFJlhNOuQwjlaLG7i5KGxteDGNvD4YoopRMwsxk4KoqWC4Ht1YDsw7hmibcRoOCUij+HcqZdAK6DiS3KP5eB7Z3vBhYfwyoKlAqAYUCmKo2RTUNzDDAdN0Tp7DtbkFRFBNG3YBhNihrVdn1pdah9RtzOzWk5N9TLpaKyBfy1Cu8QxwQQprQp+MQwjeRzmT8glKi3mh4PqQOF6HPFPIL4knBVGo/UdXKyKZlajXqgJcOccBOgOvYzZS7PoqYOjI289XnhHDvZmTZlzIXZKDMpW1/nfRywZrG9gu2d+idFPZ8u4PrfWXmIiNLvhqKqUStWkHuIEsts8HrR2wb1Hk2xLZaNfTZRk7LiWqtBuUgS7VqBcTzFz+7T4Py2XYc2jDN7q8sShI3tlbR6KF1eNwebnNuirQhoIx7lnpzl7G9bpNV88gc5KleP4TRsGBaBJZDYDsE1qHt+Q0lpYbcnoZ8qoKCVOVxMV2l5bSB3c19Xz9U0glq17G/l6RSahumUYJtasgXiygUKijulqEXGkg9yiG1msP2fQU7K022VxQqPswjubbTEUzuSokfVoCvfnXot4sE39wm+Po3CilnQderqNR0aJUq1HQR+WwZRtlsopnQS3VKHYas6kt5bVNKfPod8N7nhH70JWUffkHYu5+5bHWnwfKqwiRZYaKUZmlFYYVSiXV3X3a8wWYy8oNWlyZdjeY/YGBHuIy/g+xB9qHvLKdWXcZg2bZnA47Vmm3HPobXjdp4996JkdPyWlvwxZmPZ96fX1i4+Uk8fj0+N3ejzdwJiMfj1+cX5m/Ozs5+EAgEXggQSgKtcep/EvD+6P8Boq1W9Hl/NuoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage new expense report upload hidden id\"\n        title=\"active storage new expense report upload hidden id\"\n        src=\"/static/439a9a5202e25d94744315732112905e/5a190/active-storage-new-expense-report-upload-hidden-id.png\"\n        srcset=\"/static/439a9a5202e25d94744315732112905e/772e8/active-storage-new-expense-report-upload-hidden-id.png 200w,\n/static/439a9a5202e25d94744315732112905e/e17e5/active-storage-new-expense-report-upload-hidden-id.png 400w,\n/static/439a9a5202e25d94744315732112905e/5a190/active-storage-new-expense-report-upload-hidden-id.png 800w,\n/static/439a9a5202e25d94744315732112905e/27b8e/active-storage-new-expense-report-upload-hidden-id.png 836w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">We'll address the user display in the next step. But for now, if we update the description field with some value and submit the form again, it will be saved successfully, including associating to the file the user previously uploaded:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 129%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAADXklEQVR42qWU3W/bVBiHjzQJgeBiXNM2cdoKsa5S3Q1pVMtAJCJFiwNjIKFdoKFxxxVj7bRKAy64ACT+BiSukRBCcD8kRtHSniSlNF27VYuTNB9OmthJY6ev/UPH+Vi6hqbVjvXoHNl+H/183iMzfPcxm3nZJ02fGz1zThqZCrw2I8/4/bL/wgVZnp6WT52akL2SJHslr+zxCjzySx6PPDQ8LA+PjMhDw0NTkk86c3py0ndRUZgYz02Nj/45KY/BP/GK9dbrb9CbwSAFAgE6f95PZ8++SmPj4zTi8ZDH63XxeSWSfD7ySpLAGh0bw8TE6UXG2AkhfDE0+3Y8ErmEdy+951wMhxGJRBAOK1AUMYehKAoCgQCCwSBCoRA+UBRcvvw+xLvhcNgWz0Oh2RXG2AuucGvrIbcdQsNskGmZTsNsPMZqzeJ+l6blmJbltN8lsgkpNRXvCtOZNEdrEI4/3JpcPpfoClVV5Xsg6M0aGXu7ENSpgda67tIgEyKJwHbsLmSTK8xuZx8LM+k0N2DhIQqkooQOKWguWyigjHo3khA57ct27INCNa3y9fvriEajFI/HsLKSQHI9iVgsBs451tbWkEwmsbS8hI3Nja60zUGh2EMhvPPHHeIxjnvRe4gn4lj8exHRpSgSKwms/ruKu3/dxaPUo8HClJriO5UdVKqVIzVl8CerKq9UKyhqRbKallvUU9BtRofO/UMT5nI5rK7+Q5lsBqVyCZpWhFbSUNWr+wSd9cCE9d06CsUC6YYOo2bAMHSIda1eOyDsvf43oUgWT8RJpDpsz44kFMdGpOo0pbVX9r4D/CQ9qfsfm2x2G5sbD0iv6u1cDmD3b3rvPvYXqio3AeRNi/INE0XTQtFqogGgVN9FoaghX9DcWSuV3fSHJsxUdnj519+R/PQz2lz4Ehs3b+PBwlcofPE11F9+Q7ZURlpNI5PdRi5fGCxM13S+98OP0GffodqVqzA+/AjGlavYCUXQ/Onn43+yqqbc35ct+tGaXZzO+ok/zMCmiC67Qtojt7iX/cXHFDo2DTgi/eh7sJfb56/Zlh4ZUdMWxjrCk5lsJomnHLl87j5j7HkhfPb659ev3Vq49f3c/Nw38zfnvz0OokbU3pi78Qlj7Bm2zDlrjxNPCQPA/gNjAxjC+fPj6QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage expense report saved with attachment after fix validation error\"\n        title=\"active storage expense report saved with attachment after fix validation error\"\n        src=\"/static/2fb02e36bebf6c51c04b4fa56e631aed/5a190/active-storage-expense-report-saved-with-attachment-after-fix-validation-error.png\"\n        srcset=\"/static/2fb02e36bebf6c51c04b4fa56e631aed/772e8/active-storage-expense-report-saved-with-attachment-after-fix-validation-error.png 200w,\n/static/2fb02e36bebf6c51c04b4fa56e631aed/e17e5/active-storage-expense-report-saved-with-attachment-after-fix-validation-error.png 400w,\n/static/2fb02e36bebf6c51c04b4fa56e631aed/5a190/active-storage-expense-report-saved-with-attachment-after-fix-validation-error.png 800w,\n/static/2fb02e36bebf6c51c04b4fa56e631aed/77800/active-storage-expense-report-saved-with-attachment-after-fix-validation-error.png 855w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Checking in the database shows that the second expense report was saved (because we fixed the validation error), and it used the hidden <code>signed_id</code> field to associate the expense report with the <code>receipt-2.pdf</code> attachment user previously uploaded:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">select * from active_storage_attachments;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">id  name     record_type    record_id  blob_id  created_at</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  -------  -------------  ---------  -------  --------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   receipt  ExpenseReport  1          1        2025-03-21 12:46:13.604834</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2   receipt  ExpenseReport  2          2        2025-03-21 12:50:14.151515</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-- Earlier we saw that active_storage_blob with id of 2 is for receipt-2.pdf</span></span></code></pre>\n<p class=\"markdown-para\">At this point, we have the ability to hold on to a user's previously uploaded file and ensure it gets saved on the next successful form submission. But there's a UX issue - the native file picker displays as if no file is selected. This would confuse the user into thinking they need to select it again. The next section will cover how to solve this.</p>\n<h2 class=\"markdown-subtitle\" id=\"4-custom-file-input\" style=\"position:relative;\"><a href=\"#4-custom-file-input\" aria-label=\"4 custom file input permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Custom File Input</h2>\n<p class=\"markdown-para\">The problem we need to solve now is that the form shows \"No file chosen\" beside the \"Choose File\" button, even when we do actually have the user's previous upload saved.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 696px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdUlEQVR42o3MywqDMABE0fz/9xWkUFOEBls18RFrXppb0lV3duAsBoYR2mhqWeO8oyST+U3pRz7+klJEbM5TXSWX6val2h49zrx6w7PTTMtKiDs+pFPOe0SICdV2yObBvVF0g2Gxb8bZMpgJu26UjQ/xVDn8AGDo6C+I/Uu7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage native file input no file chosen\"\n        title=\"active storage native file input no file chosen\"\n        src=\"/static/32c264932105bd7a9b93ef9cbcdad3a9/82158/active-storage-native-file-input-no-file-chosen.png\"\n        srcset=\"/static/32c264932105bd7a9b93ef9cbcdad3a9/772e8/active-storage-native-file-input-no-file-chosen.png 200w,\n/static/32c264932105bd7a9b93ef9cbcdad3a9/e17e5/active-storage-native-file-input-no-file-chosen.png 400w,\n/static/32c264932105bd7a9b93ef9cbcdad3a9/82158/active-storage-native-file-input-no-file-chosen.png 696w\"\n        sizes=\"(max-width: 696px) 100vw, 696px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Earlier in a debug session, we saw that we do have access to the filename via the <code>@expense_report</code> model, even if it the model itself wasn't saved due to the validation error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === FILE NAME IS POPULATED ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">blob</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;ActiveStorage::Blob:0x000000016341c800</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id: 2,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  key: &quot;8gxcs3hkovtiapbmrjx0f32ejqhy&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  filename: &quot;receipt-2.pdf&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  content_type: &quot;application/pdf&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ...</span></span></span></code></pre>\n<p class=\"markdown-para\">It would be nice if we could programmatically set the file selector's value in the form, since it's available via <code>@expense_report.receipt.blob.filename</code>. However, this won't work, because this is the native file picker.</p>\n<p class=\"markdown-para\">Earlier, when we generated the scaffold and included <code>receipt:attachment</code> as a model field, Rails recognized <code>receipt</code> as an attachment. As a result, it used the <a href=\"https://api.rubyonrails.org/classes/ActionView/Helpers/FormBuilder.html#method-i-file_field\" class=\"markdown-link\">file_field</a> helper inside the <a href=\"https://api.rubyonrails.org/classes/ActionView/Helpers/FormHelper.html#method-i-form_with\" class=\"markdown-link\">form_with</a> block to create a file input in the form partial:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">form_with</span><span class=\"mtk1\">(</span><span class=\"mtk4\">model:</span><span class=\"mtk1\"> expense_report) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |form| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other fields... --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">label</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">file_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\">, </span><span class=\"mtk4\">direct_upload:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- submit --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">This renders markup:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"htm\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">form</span><span class=\"mtk1\"> </span><span class=\"mtk5\">enctype</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;multipart/form-data&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">action</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;/expense_reports&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">method</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;post&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other fields... --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;expense_report_receipt&quot;</span><span class=\"mtk1\">&gt;Receipt&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;file&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;expense_report[receipt]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;expense_report_receipt&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- submit --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">form</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\"><code>&#x3C;input type=\"file\" ...></code> is the browser's native file picker. The <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file\" class=\"markdown-link\">Mozilla Developer Network (MDN)</a> has a reference on how file inputs behave. With regards to populating the selected file name, here are the key things to understand:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">The file input’s <code>value</code> attribute defaults to an empty string.</li>\n<li class=\"markdown-list-item\">When <code>value</code> is empty, the browser displays “No file chosen.”</li>\n<li class=\"markdown-list-item\">After a user selects a file, the browser updates the file input to display the file name.</li>\n<li class=\"markdown-list-item\">The actual file data is stored in the <code>files</code> attribute, which is a <code>FileList</code> object.</li>\n<li class=\"markdown-list-item\">The <code>value</code> cannot be set programmatically to anything other than an empty string. Setting it in HTML or JavaScript has no effect and can throw an error.</li>\n</ul>\n<p class=\"markdown-para\">For example, trying to programmatically populate the file input's value won't work:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"javascript\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> input </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;input[type=file]&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">input.value </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;receipt-2.pdf&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Uncaught InvalidStateError:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//  Failed to set the &#39;value&#39; property on &#39;HTMLInputElement&#39;:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//    This input element accepts a filename, which may only be</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//    programmatically set to the empty string.</span></span></span></code></pre>\n<p class=\"markdown-para\">If user clicks the Choose File button and selects a file from their file system, then the input is populated:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"javascript\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// From the browser page, select a file, then run in Console tab of browser dev tools:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> input </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;input[type=file]&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Value always preceded with `fakepath` rather than actual file system path for security</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">input.value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//  &#39;C:\\\\fakepath\\\\receipt-2.pdf&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// FileList is array-like object with a single entry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// containing the file user just selected</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">input.files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// FileList {0: File, length: 1}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// That FileList expanded looks something like this:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">0</span><span class=\"mtk1\">: File {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    name: </span><span class=\"mtk6\">&quot;receipt-2.pdf&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    type: </span><span class=\"mtk6\">&quot;application/pdf&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  length: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Since the browser does not allow programmatically setting the file input’s value, we can’t use the filename from <code>@expense_report.receipt.blob.filename</code> to populate the input. This means that even if a file is already uploaded to storage, the input will still display \"No file chosen\" on page load.</p>\n<p class=\"markdown-para\">To provide a better user experience, and accurately reflect the file's presence, we'll need to hide the native file input (while keeping it functional) and replace it with a custom button and label. These custom controls will let us display the actual file name when available, and mimic the native behavior in other scenarios.</p>\n<p class=\"markdown-para\">The custom label should display:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">\"No file chosen\" if the user has not selected a file.</li>\n<li class=\"markdown-list-item\">The selected file name if the user clicks the custom \"Choose file\" button and picks a file from their file system (mimicking native behavior).</li>\n<li class=\"markdown-list-item\">The filename from the model (<code>expense_report.receipt.blob.filename</code>) if the form renders with an attached, but not yet persisted, receipt.</li>\n</ol>\n<p class=\"markdown-para\">Let's modify the form partial for the additional markup needed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">form_with</span><span class=\"mtk1\">(</span><span class=\"mtk4\">model:</span><span class=\"mtk1\"> expense_report, </span><span class=\"mtk4\">class:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;contents&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |form| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other fields... --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- receipt attachment--&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">label</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- logic we added earlier to preserve file if necessary --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attached?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk1\">expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">persisted?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">hidden_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\">, </span><span class=\"mtk4\">value:</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">signed_id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- wrapper div for native file input and custom controls --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">class</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;relative w-full&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;!-- hide the native file input from display with css --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;!-- make it take up full width of container so it receives clicks --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">file_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">direct_upload:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">class:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;opacity-0 absolute w-full&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;!-- add a placeholder div to display &quot;No file chosen&quot; or selected file --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">&lt;!-- will be filled in by JavaScript --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;!-- button to display instead of hidden file input --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">button</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;button&quot;</span><span class=\"mtk1\">&gt;Choose File&lt;/</span><span class=\"mtk7\">button</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- submit --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Explanation:</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">The native file picker is still present in the DOM but hidden from display with css</li>\n<li class=\"markdown-list-item\">A placeholder div has been added to display the file picker selection (\"No file chosen\" or filename user has selected or has saved from previous form submission with validation errors). This isn't functional at the moment, we'll get there soon.</li>\n<li class=\"markdown-list-item\">A button has been added with text \"Choose File\" to mimic the native file picker.</li>\n<li class=\"markdown-list-item\">A wrapper div is introduced with some css to allow the native file input to take up the full width of the container - this means even though it's hidden, it will receive the click event when the custom button is clicked.</li>\n</ul>\n<p class=\"markdown-para\">At this point, the form looks like this:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 124%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD6klEQVR42qVUS09bRxidoBgwSF1UuquCn2QBJFSVQiSueLT5Be2aQlRKcJRG3TVqs26VCtkKu2QTqatGqtQdYhW6TNJFIkKaGgJOwY/7srHB7zvzzXzVjDExrzRVZnQ0c8czx+d7EkIIGRs4N3B+ODw60RceuTw2po+Oj+vDly7pF4aG9P6BAT0QDOqhcFgP9/XpwVBI94dCeq/fr859fv9IKBwevTA0NHjzh+8lHfngk3Ohlf6Pwzg+OAifjY2L8YlPxciILi5eHBaDg+eFPxAQPT294qOeHtHr84mAzydCwZDw+f3C7w9AIBjE/v6BvwghXaSz3aN9OX1l7VrkOkauf8O/np3Fubk5hUgkgrNXr6r91NQUTk5O4lczM3htZga/vXED5d1IJMLl79PTVzYIIR8Sr9ermabxNyIiAAMuuAAOxyDPBQq18v1VfgMHkG+drLOuCLu7u7WMkYljY3B8yxAnzybhK0XY1tam2bYdzxfyuJnY5E7WwXQmjclUEg3TQNMycTu5rfZS21E0FdqO3SAkhGjZXDYuSRYXF/nTZ09x+Y9lfLj8EJ/8+QQfPX6ES0tLuPJ8pWGCNLhlcsEbCp19hR0dHZppmXEGDMuV8ltNZgBS0SEwYIdN7uz0aoZpxBsPGKeMYd11FVzaQHMv//QoKKMgWgk9Ho9m2Va8WqtKX/HCbqHpm3fCCQo7lUJJUq3VOGX0nclOJJR52DRZoOCnJsdpcz8oB1FuJeSC8/9jbkMhgCQ+UNje3q6iXHfraNkWL5ZK6qIMDlVO/08cNrlJKCNmmAa3bEumDwLnJ0b1ILpqBSyWSiD9ns1ljyikLpq2zSvVKtbqdXVZPjzNVOkaVf/8mEKPInTdGu4VHN4oZwmQdYAuk+a3QirjuFcsY8qwJMBl7I3Csx6vZllGvOwirmc4X09TlFhLM0y/3kPqUnQpoEuZQt1t+K5UqWBiYxtfbyaBAmC2qZAQr1beM+K/P0a8fIvyL35i+PmPFCducfzlNwfNZAI3NrdxM/EPvtpIoO3kDkqRFl10d+uH0+Zs+xuFCRP4lsMxVUDcziPmnBoKBOTIm2XW8B/nSF2Gld0qlnJlEALRtvcJu7q8WsYw9vuhTEKG5qqF2fUsGi8dTL/IohHPIQBXqS9HvUoxteqo861nFuRTpVbCLtlgX6rmwIG6LoOdTBHyZgkKZgl2rRLkkrtQr7rAkSvUKy4kn9uQeuFActWmtMpklNcO0sZ27C18z7GT30k3G2z37Z9vf7ewsHA/GovejcVi96LR6HHEYvdiLWh+R6PRu3cW7tyfn5+/KSMsu40kPUMI8bwnzvz64AH5F+I/5JGWVX3UAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage markup for custom file input\"\n        title=\"active storage markup for custom file input\"\n        src=\"/static/4ec77be7288a39dad4b143a7740aeb49/5a190/active-storage-markup-for-custom-file-input.png\"\n        srcset=\"/static/4ec77be7288a39dad4b143a7740aeb49/772e8/active-storage-markup-for-custom-file-input.png 200w,\n/static/4ec77be7288a39dad4b143a7740aeb49/e17e5/active-storage-markup-for-custom-file-input.png 400w,\n/static/4ec77be7288a39dad4b143a7740aeb49/5a190/active-storage-markup-for-custom-file-input.png 800w,\n/static/4ec77be7288a39dad4b143a7740aeb49/38af3/active-storage-markup-for-custom-file-input.png 894w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Clicking the custom \"Choose File\" button launches the system file selector because it's rendered on top of the hidden native file input. To make the custom file name display functional, we'll need to add some JavaScript. <a href=\"https://stimulus.hotwired.dev/handbook/introduction\" class=\"markdown-link\">Stimulus</a> is a minimal JavaScript framework that works with Rails that to enhance server-rendered pages. To get started, run the following command to generate a new Stimulus controller:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate stimulus file_upload</span></span></span></code></pre>\n<p class=\"markdown-para\">This generates the following JavaScript file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"javascript\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// app/javascript/controllers/file_upload_controller.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Controller } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@hotwired/stimulus&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Connects to data-controller=&quot;file-upload&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">class</span><span class=\"mtk1\"> </span><span class=\"mtk7\">extends</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">Controller</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">connect</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Then update it to display the correct filename (either from the saved upload value or new user selection), by setting up Stimulus targets for the hidden file input and display div, and wiring up a <code>handleNewFileSelection</code> method to react to user changes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"javascript\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Controller } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@hotwired/stimulus&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Connects to: data-controller=&quot;file-upload&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">class</span><span class=\"mtk1\"> </span><span class=\"mtk7\">extends</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">Controller</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Targets are the DOM elements that this controller will interact with</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// `input` is the native file input so we can inspect it&#39;s `files` property</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// `fileNameContainer` is the custom div to display a previously selected file name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> targets </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;input&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;fileNameContainer&quot;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Values are inputs the DOM can provide to the controller.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// `fileSelectionText` will have the file name of a previously selected file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// or if it&#39;s not provided, we&#39;ll use a default of &quot;No file chosen&quot;.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> values </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fileSelectionText: { type: </span><span class=\"mtk9 mtki\">String</span><span class=\"mtk1\">, default: </span><span class=\"mtk6\">&quot;No file chosen&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">connect</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">this</span><span class=\"mtk1\">.</span><span class=\"mtk5\">updateFileName</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Updates the custom div with a file name or &quot;No file chosen&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">updateFileName</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">this</span><span class=\"mtk1\">.fileNameContainerTarget.textContent </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">this</span><span class=\"mtk1\">.fileSelectionTextValue;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// When user selects a new file, update the display based on the native file input selection</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">handleNewFileSelection</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">this</span><span class=\"mtk1\">.inputTarget.files.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">this</span><span class=\"mtk1\">.fileNameContainerTarget.textContent </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">this</span><span class=\"mtk1\">.inputTarget.files[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">].name;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">this</span><span class=\"mtk1\">.</span><span class=\"mtk5\">updateFileName</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// Reset display if no file selected</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIt's beyond the scope of this post to go in depth on Stimulus. If you're not familiar with it, or want a refresher on concepts like targets and values, check out my earlier guide <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/stimulus-copy-to-clipboard/\">on building a Stimulus controller</a>.\n</aside>\n<p class=\"markdown-para\">To make use of the Stimulus controller, we add some data-dash attributes to the form partial. These connect the markup to the Stimulus targets and values:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">form_with</span><span class=\"mtk1\">(</span><span class=\"mtk4\">model:</span><span class=\"mtk1\"> expense_report, </span><span class=\"mtk4\">class:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;contents&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |form| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other fields... --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;%# === data-controller ON WRAPPER DIV CONNECTS TO STIMULUS CONTROLLER === %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;%# === data-file-upload-file-selection-text-value PROVIDES FILE NAME DISPLAY VALUE === %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">data-controller</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;file-upload&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">data-file-upload-file-selection-text-value</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attached?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk1\">expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">persisted?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">blob</span><span class=\"mtk1\">.</span><span class=\"mtk5\">filename</span><span class=\"mtk1\"> </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;No file chosen&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">label</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attached?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk1\">expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">persisted?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">hidden_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\">, </span><span class=\"mtk4\">value:</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">signed_id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">&lt;%# === data-file-upload-target PROVIDES REFERENCE TO NATIVE FILE INPUT TO STIMULUS CONTROLLER === %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">file_field</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\">, </span><span class=\"mtk4\">direct_upload:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">data:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">file_upload_target:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;input&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">action:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;change-&gt;file-upload#handleNewFileSelection&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">class:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;absolute w-full opacity-0&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">&lt;%# === data-file-upload-target PROVIDES REFERENCE TO CUSTOM LABEL TO STIMULUS CONTROLLER === %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-file-upload-target</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;fileNameContainer&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">button</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;button&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        Choose File</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">button</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">persisted?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;Current Receipt:&lt;/</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> link_to expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk5\">filename</span><span class=\"mtk1\">, expense_report.</span><span class=\"mtk5\">receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- submit --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">The key to this solution is that we're able to tell the Stimulus controller to display the previously selected filename from memory: <code>expense_report.receipt.blob.filename</code>, by passing it in as a <code>value</code>.</p>\n<p class=\"markdown-para\">Now if we try to submit a new expense report with an attachment and form validation errors, the form will re-render with the validation errors <em class=\"markdown-emphasis\">and</em> the file name is preserved!</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 129.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEHElEQVR42qWV/U8cRRjHt4n2J/0PCnfHkZhCi14kVYiWxpAQQcKBb0T5zZjoH8FPPVJeUq6J1fBv2MZaU63UtClrEzWxCJHC7e7tHdz7vtze3s7OzNfMHnAc0FDiJJ/MzM7ud5555nmele5/MSz1vxYNv/l2tLevIxQb7OuPXb5yJdbX3x8739UVu3DxYiwcicTaQ6GgD4XDsXPhcKytvS14dq6tLRbp6Ojt6emJfD41JYl29vXO6PKFN6J4p+s8GXz3MntvcJANDAywS5feYr29vSza2cnC4QhrD4VYKBRmHeEwi3R0sHAkIiDRaCe6u7uXJUl6WQi++v7IB08mJj7Chx9/wsbicYyPjyM+Po6JiQnE4/GA0dFRDA0NYWRkBJPxOD6dnMTY2JhYY+Ld4eGRJ5IkvRIIplJbMsBBiEeJT7hHvH3EfA+f+gFktxd4xPMBIKWk5H1BVVNlNBrFKRsHD77R0trvLYJ21YZhGrRatWFZJkzTQDC2LZiWKdbAGAXjrAXKaCCoampTUM/o8oq8gnv3f6EPVx7j9p07+Onne3jw6CGWf3uA72/fwmN5BZQzcACM80CMC9HjBJW0JsN1QTeeUba+Drq2Dr65Bba2DqaqYIoC6HpjvJUCK5fBHAesWgWzLArqQ9UOHFkRPiQEPJOhXFVF30CMjQp4tQpu203E3HECmG1TUNpqofCh8FOuWKBMHKkFfpSTfKilNdmpOdjZ2aGUURCfHMJ/Lh4hlINDUZVWC2t1F/lCntbc2t7OL4RP/aMWqqoi150qirkd6lZtCCdzn7wQjHhURKN60EIlyJRmYB+OtRNoWKikDgqmgtQTi6cU2xXkhwRVRYa4DLdGGfFwGqhXp+Cs9ch7YaOoChWpJkKj4XR2IsdfiqbKda+OTDZDc/kcPOKJF0Gex27IiE2dmkNrrgvtYKZomiqXKga2cwVKKEPNJQGeR0AIAfFa8WkQLqh7Htx6/TgLNZn5VZglnVJiwC8UgXIFTsGCsW3D3GlSyZgwshZM28Hq2jP89fc6LZQqSOvppmAmo8i/PgVu3PLp0o8ES3cpvvmBYSNL4DiidNkwLFHeLNhVB9a2FVgpLKzXvaMWbmcVeeku8NmCT7/+jvKvvvX51HXKH626vJBLcy2b5aqe5pqu82K5xF3D5UFtbbAn2FKxVxpxzQhEDOwDVjMJK26ZzMhUWUm1WGHLZLmNMiukDJbfrLDKtk12K/ZK85+ipP4QW3mkWQg8cYucwsjbSD/NYWezBH0tj+y/Rej/5KGv5pFZKwRjp1KHmlb/3BM8Oz09/eXs3OzNq4nEYmJmJpmYSSSDPpFIXpu/lly4MZecX5xNLiTnkvPJuWAekJxLzi3OLi5cn78pNISWtLm1KUTPSJL00v/kTKlQlv4DJzoYfxARNxwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage new expense report validation error and remembers filename\"\n        title=\"active storage new expense report validation error and remembers filename\"\n        src=\"/static/df76d63a77019fc86ec62d1e02920a34/5a190/active-storage-new-expense-report-validation-error-and-remembers-filename.png\"\n        srcset=\"/static/df76d63a77019fc86ec62d1e02920a34/772e8/active-storage-new-expense-report-validation-error-and-remembers-filename.png 200w,\n/static/df76d63a77019fc86ec62d1e02920a34/e17e5/active-storage-new-expense-report-validation-error-and-remembers-filename.png 400w,\n/static/df76d63a77019fc86ec62d1e02920a34/5a190/active-storage-new-expense-report-validation-error-and-remembers-filename.png 800w,\n/static/df76d63a77019fc86ec62d1e02920a34/39a20/active-storage-new-expense-report-validation-error-and-remembers-filename.png 859w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Now all the user has to do is correct the validation error(s) and submit the form again. And they can see that the file name they previously selected is still there.</p>\n<h2 class=\"markdown-subtitle\" id=\"5-reusable-file-field-partial\" style=\"position:relative;\"><a href=\"#5-reusable-file-field-partial\" aria-label=\"5 reusable file field partial permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Reusable File Field Partial</h2>\n<p class=\"markdown-para\">While our file attachment now persists through validation errors, the solution adds a lot of boilerplate to the form. If we need to support more attachments, whether on the same model or others, this code will become hard to maintain. To avoid duplication and keep our forms clean, let’s extract a reusable file field partial.</p>\n<p class=\"markdown-para\">For example, suppose submitting an expense report also requires attaching an approval document to prove that the user was previously approved for this kind of expense. The model is updated:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ExpenseReport</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_one_attached </span><span class=\"mtk4\">:receipt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># === ADD ANOTHER ATTACHMENT HERE ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_one_attached </span><span class=\"mtk4\">:approval_document</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The server side controller is updated to permit this additional parameter:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ExpenseReportsController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">expense_report_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.</span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk4\">expense_report:</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">:amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">:description</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">:incurred_on</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># === ADD APPROVAL DOCUMENT TO LIST OF ALLOWED PARAMS ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">:approval_document</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now we introduce a new partial <code>app/views/shared/_file_field.html.erb</code> to handle the display of any attachment, including displaying the file name from the previous selection if necessary. It uses <a href=\"https://api.rubyonrails.org/classes/ActionView/Template.html#method-i-strict_locals-21\" class=\"markdown-link\">strict locals</a> to ensure it's provided with a form builder, a model instance, and an attachment attribute. It still makes use of the Stimulus controller via the data-dash attributes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">&lt;%# locals: (form:, object:, attribute:) %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">&lt;%#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  Render a file input field with enhanced behavior using Stimulus.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  Ensure that selected files persist across form validation errors,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  preventing users from having to reselect them.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  Locals:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  - form: The form builder object, used to generate form fields.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  - object: The model instance being edited, providing access to attached files.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  - attribute: The attribute representing the file attachment (e.g., :receipt, :approval_document).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-controller</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;file-upload&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">data-file-upload-file-selection-text-value</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> object.</span><span class=\"mtk5\">send</span><span class=\"mtk1\">(attribute).</span><span class=\"mtk5\">attached?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk1\">object.</span><span class=\"mtk5\">send</span><span class=\"mtk1\">(attribute).</span><span class=\"mtk5\">persisted?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> object.</span><span class=\"mtk5\">send</span><span class=\"mtk1\">(attribute).</span><span class=\"mtk5\">blob</span><span class=\"mtk1\">.</span><span class=\"mtk5\">filename</span><span class=\"mtk1\"> </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;No file chosen&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">label</span><span class=\"mtk1\"> attribute </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;%# Preserve previously uploaded file if it was %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;%# submitted along with form validation errors %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> object.</span><span class=\"mtk5\">send</span><span class=\"mtk1\">(attribute).</span><span class=\"mtk5\">attached?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk1\">object.</span><span class=\"mtk5\">send</span><span class=\"mtk1\">(attribute).</span><span class=\"mtk5\">persisted?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">hidden_field</span><span class=\"mtk1\"> attribute, </span><span class=\"mtk4\">value:</span><span class=\"mtk1\"> object.</span><span class=\"mtk5\">send</span><span class=\"mtk1\">(attribute).</span><span class=\"mtk5\">signed_id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;%# Hidden (but still functional) native file input %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> form.</span><span class=\"mtk5\">file_field</span><span class=\"mtk1\"> attribute, </span><span class=\"mtk4\">direct_upload:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">data:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">file_upload_target:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;input&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">action:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;change-&gt;file-upload#handleNewFileSelection&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">class:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;absolute inset-0 w-full opacity-0 cursor-pointer&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;%# Custom file name display - populated by Stimulus controller %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-file-upload-target</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;fileNameContainer&quot;</span><span class=\"mtk1\">&gt;&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">&lt;%# Custom button to select a file - renders on top of hidden file input %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">button</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;button&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-file-upload-target</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;button&quot;</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      Choose File</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">button</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;%# Only display download link if file is actually associated with the model %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> object.</span><span class=\"mtk5\">send</span><span class=\"mtk1\">(attribute).</span><span class=\"mtk5\">persisted?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;Current </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> attribute.</span><span class=\"mtk5\">to_s</span><span class=\"mtk1\">.</span><span class=\"mtk5\">humanize</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span><span class=\"mtk1\">:&lt;/</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> link_to object.</span><span class=\"mtk5\">send</span><span class=\"mtk1\">(attribute).</span><span class=\"mtk5\">filename</span><span class=\"mtk1\">, object.</span><span class=\"mtk5\">send</span><span class=\"mtk1\">(attribute) </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Finally, we can add the new approval attachment in the form <code>app/views/expense_reports/_form.html.erb</code>, and replace the existing receipt attachment, using the new file field partial:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">form_with</span><span class=\"mtk1\">(</span><span class=\"mtk4\">model:</span><span class=\"mtk1\"> expense_report, </span><span class=\"mtk4\">class:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;contents&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |form| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;%# Other fields... %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;%# Use file_field partial for attachment fields %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> render </span><span class=\"mtk6\">&quot;shared/file_field&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">form:</span><span class=\"mtk1\"> form, </span><span class=\"mtk4\">object:</span><span class=\"mtk1\"> expense_report, </span><span class=\"mtk4\">attribute:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:receipt</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> render </span><span class=\"mtk6\">&quot;shared/file_field&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">form:</span><span class=\"mtk1\"> form, </span><span class=\"mtk4\">object:</span><span class=\"mtk1\"> expense_report, </span><span class=\"mtk4\">attribute:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:approval_document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;%# Submit %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Now the form looks like this with the two attachments, suppose user has selected both their receipt and approval document, but again forgets to fill in the description:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAADSUlEQVR42p2VTW/TSBjHB/bMCgSutIEoiZ20paQJqGqW5QoLx34BxIUT0i4HcuBaPgWVAGlPS8WBoiZx4xStVMphE8qlERIVlduE5m2cNmn6knjeHjQ2EBqV8DKjn56xNfOf/zx+NEYIoV8uDAWvj13Q7l4bG7tz5erV+OXLV+IXL/4RHx+PxVVNiwdUNR4MhRycZ02N+wKBuN/ljqppdyPR6A2E0BGE0NGT54YGy9HIEFyKnodY7HeIxWIQjZ6HcHgUNE0Dr9cLv3k84PF44IzXCwGfH4ZDIQiGBsHv94OqqjA8fBYjhI6hgVMnB/6dnl7V5wyYTaVIMplkKT3F9DndiWkjzRLJBHs685TNzMyw2cQsSyUTzNB1ps/NyXkkbRjwePrxGkLoBDrj9Sq7e7smuI0DgPhB5BrYb+8XEELHUTAYVIrviyZlFBh3OjgwN8r3NrGd+BW4AAE1XCs4DicmJpSl10tmZj4Diy8XedpIgxy/WHwBRsYAXdcBY+zaFxzkYhm/wHFo1S1XcGRkRCkUi6ZVt4BQwgl1d5buCCXOuEegV/ig4OBgSCmVS2Z9cxMIpfzTMV3YR7pHlJv0FRw55zrEFoZGs9kjeAic9R77oKCmqUqpXDZtQmTyuZzEOAcmeuCugHTc16Hf71Mq1YpTNgKE88X69e8Q9DuC7mTaLZuv8M0chsNhZb1QMKu1GjSajb45JB9j3xzKwpY5lGWDMeYd24bDROXijt2B1k7rc00eKhiJRJS19TUTWxbYhPBuqXSRztqdDuy12yA37OswFNIchzVrE6q4znf32mATBjahX8CguFGBN29XoYbr33I4qqytr5uVGoaNUplXqjVhEyooY4JQ+pn9dkfstduiY9tCgBC82w8K+gJBpVopre60tqCxZVHOOgwEYYRKOKNMIlhxo8qW36ywchUzAYIxzj5BpSC2sHt9Td70DaT+36rcfgTw1wOAW1MAfz8EeFci0NpuQH2rCfXNBjS3d6Bf225tY0fwz/Ffj//z5L9nk1OvVibvZ5cn72fz96Zy+aTxMv98PpNPG5l8Om3k5+ef57O5XD736iDZXHZ56fXSysLCQsK5seU/wFFG6DRCyPOTyLUnfD7f0Q8C9f3aKYVu2gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage new expense report with approval doc\"\n        title=\"active storage new expense report with approval doc\"\n        src=\"/static/22ee9dccff1ad27f6d9e7b67b06c1b0b/5a190/active-storage-new-expense-report-with-approval-doc.png\"\n        srcset=\"/static/22ee9dccff1ad27f6d9e7b67b06c1b0b/772e8/active-storage-new-expense-report-with-approval-doc.png 200w,\n/static/22ee9dccff1ad27f6d9e7b67b06c1b0b/e17e5/active-storage-new-expense-report-with-approval-doc.png 400w,\n/static/22ee9dccff1ad27f6d9e7b67b06c1b0b/5a190/active-storage-new-expense-report-with-approval-doc.png 800w,\n/static/22ee9dccff1ad27f6d9e7b67b06c1b0b/5bf79/active-storage-new-expense-report-with-approval-doc.png 966w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">With no additional effort on our part, both attachment names are preserved when the form is submitted, and rendered with validation errors:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 118.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEAklEQVR42p2U208cVRzH5wETq08+YClQZNkLq5aljQVKjcSu+D8YhBdjWxbtGwSlArvhxaovtjU++CDuLukm+j8YtSleqC3EAm0Wuuyyt9m57mVmd2bO+ZqZ2VqgUNHf5JPfyeTM9/xuZxjmuaMNfa96znSdcg6+3d3tf2tw0P/muXP+3r4+/2unT/vdnR6/0+Xyezo7LVxut9/pdvnbHA6/o6PD3+F0+jtczkFfd3e/0+VqYJ55/gVHl9tReOVEBwa6fDh79nX0n+nHyZOn0NXlQ3u7A80tLWhqakJT0zEca25Ga0srHO3taGt7Ca2trTh+vA0eT6fQ2NjYxvT19nonP57iQ6E5zIRCZGZ2hgaDQRoMhejs7Ky1np6epuPj43RiYoJOTU3RTy5fpp/OzVl7gsEgCYVCmJz8SPL5fG7mw0uXvJVKmYNtBAD9j5jfQFEVcWRkxM0ExgJenuf5HYIHmkGMfyCP16YoBFGQhoaG3MyFixe8kizxalXFTzd/IXdWlrF0508s/v6b5f9aW8XNxVu4d3/dOs2G7sQSFCVRGnp3yM2Mjo56RUnkCSV4uHqPpB88wObyMjaWl5FcW0MuHsf60hLy8TiIJIHIMkhVBalVQaoWjwXNCMfGAl5BFOyUWZZgdQ1YWwfiG7ZPpgBBAPIs6HYaNJ0BLRZBSyULUiruFgwEAlaEFBRsgSWqqtj1MXQbSursSLNew/q+3Smbgo8iTGcypKxULAFN16EZuu33Ytjoho6apj0Z4SNBXhCIXJR3dfPf0J+M0G4KpQQCmyeSwIPq2uEwdBCt9pSmUGLNIa3X6jAP0bWDBamuETNSYp58GMy0rbGhe2ooibz5siiJpFIu2akcnqd3ObmdglJVYRAC3Sr6PhAbs9PFcmmfORTtOczmskSSJWiGBoNaHbT8XszRMW+WadWqevBgpzM5IshFFIUKlKKKmmagLKsWJanuRcWKnhMkbCZSSGfZg+ewwIkkx3LIpFkUEjzycR6bt7PY+CODh7ez2FrJI3E3h8KWBJ6TwXI8OEHcKzjqFUS7KWx+mxQKaVpIpaia56nCl+nWXZZm7vM0FxeomCtTVdFoSVQpx0k0lcnRbJ4jdUHRErw4aqYsFDQC3LpX0X9eKRmLK4rx66pmJDnd0IyaodZslGrVqNZqhkGJIcpFI5XOGTmW0+uCvCX43vkPXlYqklIoAee/At6/bvt3vgCiPxrg2AwSW2lsJbeRSCRRLJX3/fnKRbk2PDzsYd4YGDg6P//ttXB04YfPr4VvXLkajn12NRy78mU49vU3kdjCQjQWiUZj0TqRSMQiHAnHwmGLG9GF6Pfz381f7+npeZGpWwPDMEcYhnn2f3KkrsH8DTJf2gx4HPcWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"active storage file field partial\"\n        title=\"active storage file field partial\"\n        src=\"/static/238f25a14bb212923f9a525ece8d937d/5a190/active-storage-file-field-partial.png\"\n        srcset=\"/static/238f25a14bb212923f9a525ece8d937d/772e8/active-storage-file-field-partial.png 200w,\n/static/238f25a14bb212923f9a525ece8d937d/e17e5/active-storage-file-field-partial.png 400w,\n/static/238f25a14bb212923f9a525ece8d937d/5a190/active-storage-file-field-partial.png 800w,\n/static/238f25a14bb212923f9a525ece8d937d/ecf19/active-storage-file-field-partial.png 948w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 class=\"markdown-subtitle\" id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p class=\"markdown-para\">In this post, we explored how Rails' Active Storage handles file attachments, and what goes wrong when a form submission fails validation. Along the way, we:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Learned that Active Storage only attaches files after a successful save</strong>, which means uploaded files can be lost when validations fail.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Walked through the \"happy path\"</strong>, demonstrating how attachments are persisted when everything goes smoothly.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Used the debugger to inspect attachment state in memory</strong>, distinguishing between <code>attached?</code> and <code>persisted?</code>.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Enabled Direct Uploads</strong>, allowing files to be uploaded and blob records created via client-side JavaScript, in parallel as the form is submitted, making it possible to preserve uploads through validation errors.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Used the signed ID of the blob</strong> to reattach the uploaded file via a hidden field on subsequent submissions.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Built a custom file input using Stimulus</strong>, giving users visual feedback about their selected file, even when the native file picker resets.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Created a reusable partial for file inputs</strong> that combines the hidden field and Stimulus enhancements, making it easy to apply this pattern across an application.</li>\n</ul>\n<p class=\"markdown-para\">With these techniques, you now have a robust, user-friendly way to preserve file uploads through validation cycles. With all that said, this took more effort than the usual \"it just works\" Rails experience. Maybe a future version will handle file inputs like it does other fields on validation errors. Until then, it was a good excuse to peek under the hood of Active Storage and learn how attachments are handled.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":28,"tableOfContents":"<ul>\n<li><a href=\"#demo-project-setup\">Demo Project Setup</a></li>\n<li><a href=\"#happy-path\">Happy Path</a></li>\n<li><a href=\"#validation-errors\">Validation Errors</a></li>\n<li><a href=\"#1-check-persisted\">1. Check Persisted</a></li>\n<li><a href=\"#2-direct-upload\">2. Direct Upload</a></li>\n<li><a href=\"#3-hidden-signed-id\">3. Hidden Signed ID</a></li>\n<li><a href=\"#4-custom-file-input\">4. Custom File Input</a></li>\n<li><a href=\"#5-reusable-file-field-partial\">5. Reusable File Field Partial</a></li>\n<li><a href=\"#summary\">Summary</a></li>\n</ul>","frontmatter":{"title":"Active Storage & Form Errors: Preventing Lost File Uploads in Rails","date":"01 May 2025","description":"Rails' Active Storage makes file uploads easy, but validation errors can cause attachments to be lost when forms re-render. This guide explains why and walks through a step-by-step solution using direct uploads, signed IDs, and Stimulus for an improved user experience.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#d8d8e8","images":{"fallback":{"src":"/static/2e9e85d16c674888e97f9dcd8b1bcd52/d730f/rails-active-storage-form-validation-errorssteve-johnson-Kr8Tc8Rugdk-unsplash.jpg","srcSet":"/static/2e9e85d16c674888e97f9dcd8b1bcd52/b834a/rails-active-storage-form-validation-errorssteve-johnson-Kr8Tc8Rugdk-unsplash.jpg 225w,\n/static/2e9e85d16c674888e97f9dcd8b1bcd52/21c52/rails-active-storage-form-validation-errorssteve-johnson-Kr8Tc8Rugdk-unsplash.jpg 450w,\n/static/2e9e85d16c674888e97f9dcd8b1bcd52/d730f/rails-active-storage-form-validation-errorssteve-johnson-Kr8Tc8Rugdk-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/2e9e85d16c674888e97f9dcd8b1bcd52/71a10/rails-active-storage-form-validation-errorssteve-johnson-Kr8Tc8Rugdk-unsplash.webp 225w,\n/static/2e9e85d16c674888e97f9dcd8b1bcd52/901f1/rails-active-storage-form-validation-errorssteve-johnson-Kr8Tc8Rugdk-unsplash.webp 450w,\n/static/2e9e85d16c674888e97f9dcd8b1bcd52/5acd1/rails-active-storage-form-validation-errorssteve-johnson-Kr8Tc8Rugdk-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":599}}}},"fields":{"slug":"/blog/active_storage_form_errors/"}},"relatedP":{"edges":[{"node":{"id":"b2b20b63-68df-5c57-9e52-a280150be20f","frontmatter":{"title":"Some Elegance with Rails Caching","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/841a5221ee299471977ce391a607c5f0/26528/rails-cache-elegance-frankie-lopez-hKSJiRZ-ngk-unsplash.jpg","srcSet":"/static/841a5221ee299471977ce391a607c5f0/26528/rails-cache-elegance-frankie-lopez-hKSJiRZ-ngk-unsplash.jpg 300w,\n/static/841a5221ee299471977ce391a607c5f0/43429/rails-cache-elegance-frankie-lopez-hKSJiRZ-ngk-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/841a5221ee299471977ce391a607c5f0/5d6c3/rails-cache-elegance-frankie-lopez-hKSJiRZ-ngk-unsplash.webp 300w,\n/static/841a5221ee299471977ce391a607c5f0/68dbc/rails-cache-elegance-frankie-lopez-hKSJiRZ-ngk-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-cache-elegance/"}}},{"node":{"id":"552137ae-0570-5f64-9e79-bbb48ce750eb","frontmatter":{"title":"Build a Rails App with Slack Part 1: OAuth","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/6ae9893d9aefcafb60524b97d9b441ed/26528/slack-feat-img-1-mitchell-luo-H3htK85wwnU-unsplash.jpg","srcSet":"/static/6ae9893d9aefcafb60524b97d9b441ed/26528/slack-feat-img-1-mitchell-luo-H3htK85wwnU-unsplash.jpg 300w,\n/static/6ae9893d9aefcafb60524b97d9b441ed/43429/slack-feat-img-1-mitchell-luo-H3htK85wwnU-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/6ae9893d9aefcafb60524b97d9b441ed/5d6c3/slack-feat-img-1-mitchell-luo-H3htK85wwnU-unsplash.webp 300w,\n/static/6ae9893d9aefcafb60524b97d9b441ed/68dbc/slack-feat-img-1-mitchell-luo-H3htK85wwnU-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-slack-app-part1-oauth/"}}},{"node":{"id":"d84ac79f-d860-544a-8abb-63add1da9214","frontmatter":{"title":"Understanding ActiveRecord Dependent Options","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#282828","images":{"fallback":{"src":"/static/b7f7064c193fa4dc20f20d253e1928fa/26528/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg","srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/26528/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 300w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/43429/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/5d6c3/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 300w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/68dbc/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/activerecord-dependent-options/"}}}]}},"pageContext":{"slug":"/blog/active_storage_form_errors/","relatedPosts":["Understanding ActiveRecord Dependent Options","Build a Rails App with Slack Part 1: OAuth","Some Elegance with Rails Caching"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}