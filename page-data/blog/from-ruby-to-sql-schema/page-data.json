{"componentChunkName":"component---src-templates-post-js","path":"/blog/from-ruby-to-sql-schema/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">Rails maintains a file called <code>schema.rb</code> to represent the projects' database schema. This file is automatically updated every time a database migration is run. It reflects the current structure of the database using Ruby syntax, based on the <a href=\"https://api.rubyonrails.org/v8.0.2/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html\" class=\"markdown-link\">Rails migration DSL</a>. It's used to recreate the database schema quickly when running tasks like <code>db:setup</code>, <code>db:prepare</code>, or <code>db:reset</code>, without replaying the entire migration history (which may not be possible in any case on older projects).</p>\n<p class=\"markdown-para\">But sometimes you hit a limitation - like needing to use raw SQL to define database triggers, custom indexes, or other advanced database features that can't be expressed with the Rails migration DSL. That’s where SQL schema dumps come in. When using the sql schema format, instead of a <code>schema.rb</code> file being generated when migrations are run, you'll have a <code>structure.sql</code> file.</p>\n<p class=\"markdown-para\">It’s easy to set up SQL schema format on day one of a Rails project - just set a config flag and you’re good. I've written about this in my <a href=\"../kickstart-a-new-rails-project\" class=\"markdown-link\">Kickstart a New Rails Rails</a> post. But what if you're already well into a project that uses the default Ruby format? You have dozens of migrations, a <code>schema.rb</code>, and now you need to add something the DSL can't express. Switching to SQL format mid-project isn’t hard, but it’s not immediately obvious how to do it. That’s what this post will walk you through.</p>\n<h2 class=\"markdown-subtitle\" id=\"why-i-switched\" style=\"position:relative;\"><a href=\"#why-i-switched\" aria-label=\"why i switched permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why I Switched</h2>\n<p class=\"markdown-para\">On a recent project, I introduced the <a href=\"https://github.com/Casecommons/pg_search\" class=\"markdown-link\">pg_search</a> gem to implement PostgreSQL full-text search. For performance, this approach requires creating a database <code>TRIGGER</code> to automatically update a <code>tsvector</code> column whenever the associated data to be searched changes. This trigger logic had to be written in SQL, not Ruby.</p>\n<aside class=\"markdown-aside\">\nIf you need to define triggers in a Rails project, you may come across the <a class=\"markdown-link\" href=\"https://github.com/jenseng/hair_trigger\">hairtrigger</a> gem, which lets you declare triggers in your models using Ruby and then generates the underlying SQL with a rake task. While this is a neat concept, I decided not to use it because it introduces a departure from Rails conventions in regards to database schema maintenance. Rails migrations have conditioned us to look in the db/migrate directory to understand how the database schema evolves. Moving trigger definitions to model files breaks that mental model. It also felt like a potential future maintenance headache if the gem ever fell out of sync with newer versions of Rails or ActiveRecord.\n</aside>\n<p class=\"markdown-para\">Rails migrations allow you to run raw SQL with <code>execute</code>, but <code>schema.rb</code> won’t capture these changes. This requires switching to <code>structure.sql</code>, which is a full SQL dump of the database schema.</p>\n<p class=\"markdown-para\">The following steps will walk through making the switch:</p>\n<h2 class=\"markdown-subtitle\" id=\"1-configure-sql-schema-dumps\" style=\"position:relative;\"><a href=\"#1-configure-sql-schema-dumps\" aria-label=\"1 configure sql schema dumps permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1: Configure SQL Schema Dumps</h2>\n<p class=\"markdown-para\"><em class=\"markdown-emphasis\">Before</em> adding a new migration that has raw sql, in <code>config/application.rb</code>, add:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Use SQL format for schema dumps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">config.</span><span class=\"mtk5\">active_record</span><span class=\"mtk1\">.</span><span class=\"mtk5\">schema_format</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:sql</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"2-generate-sql-schema\" style=\"position:relative;\"><a href=\"#2-generate-sql-schema\" aria-label=\"2 generate sql schema permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2: Generate SQL Schema</h2>\n<p class=\"markdown-para\">Run the following to generate a <code>db/structure.sql</code> file based on your current database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sh\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:schema:dump</span></span></span></code></pre>\n<p class=\"markdown-para\">This creates a full SQL dump of your schema using <code>pg_dump</code> (if you're using PostgreSQL).</p>\n<h2 class=\"markdown-subtitle\" id=\"3-delete-ruby-schema\" style=\"position:relative;\"><a href=\"#3-delete-ruby-schema\" aria-label=\"3 delete ruby schema permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3: Delete Ruby Schema</h2>\n<p class=\"markdown-para\">You no longer need <code>db/schema.rb</code>, and it may cause confusion if left around:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sh\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rm db/schema.rb</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"4-run-sql-migration\" style=\"position:relative;\"><a href=\"#4-run-sql-migration\" aria-label=\"4 run sql migration permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4: Run SQL Migration</h2>\n<p class=\"markdown-para\">Now you can safely write a migration using raw SQL, for example, adding a trigger:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreatePgSearchDocuments</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:pg_search_documents</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">text</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:content</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:searchable</span><span class=\"mtk1\">, </span><span class=\"mtk4\">polymorphic:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">index:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">tsvector</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:content_vector</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;~SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">CREATE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TRIGGER</span><span class=\"mtk6\"> </span><span class=\"mtk5\">pg_search_documents_content_vector_update</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">BEFORE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">INSERT</span><span class=\"mtk6\"> </span><span class=\"mtk7\">OR</span><span class=\"mtk6\"> </span><span class=\"mtk7\">UPDATE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">ON</span><span class=\"mtk6\"> pg_search_documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      FOR EACH </span><span class=\"mtk7\">ROW</span><span class=\"mtk6\"> </span><span class=\"mtk7\">EXECUTE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">FUNCTION</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        tsvector_update_trigger(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          content_vector, &#39;pg_catalog.english&#39;, content</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    drop_table </span><span class=\"mtk4\">:pg_search_documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Run the migration with <code>bin/rails db:migrate</code>, then check <code>structure.sql</code> - it should include any raw SQL statements from your migration, such as the <code>TRIGGER</code> in this example.</p>\n<h2 class=\"markdown-subtitle\" id=\"5-verify-schema-loading\" style=\"position:relative;\"><a href=\"#5-verify-schema-loading\" aria-label=\"5 verify schema loading permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5: Verify Schema Loading</h2>\n<p class=\"markdown-para\">Run this command to reset your database from the schema:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sh\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:reset</span></span></span></code></pre>\n<p class=\"markdown-para\">This drops and recreates the database and loads the schema, which will now use the the SQL dump, followed by seeding. It should run without errors.</p>\n<p class=\"markdown-para\">Also, connect to the database with <code>bin/rails db</code> and verify that changes made via raw sql were preserved. For example, to verify that a trigger was created on the <code>pg_search_documents</code> table if using PostgreSQL, the <code>\\d+</code> meta command outputs additional table details:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\\d+ pg_search_documents</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">usual table details...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Triggers:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pg_search_documents_content_vector_update</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        BEFORE INSERT OR UPDATE ON pg_search_documents</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        FOR EACH ROW EXECUTE FUNCTION</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        tsvector_update_trigger(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &#39;content_vector&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &#39;pg_catalog.english&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &#39;content&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        )</span></span></code></pre>\n<p class=\"markdown-para\">Commit the removal of <code>schema.rb</code> and the new <code>structure.sql</code> to source control. From now on, the database schema will be expressed in SQL.</p>\n<h2 class=\"markdown-subtitle\" id=\"pg-extensions-and-heroku-review-apps\" style=\"position:relative;\"><a href=\"#pg-extensions-and-heroku-review-apps\" aria-label=\"pg extensions and heroku review apps permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PG Extensions and Heroku Review Apps</h2>\n<p class=\"markdown-para\">If any migrations enable PostgreSQL extensions, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enable_extension </span><span class=\"mtk6\">&#39;pgcrypto&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> </span><span class=\"mtk5\">extension_enabled?</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;pgcrypto&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">When working with Heroku Review Apps or any ephemeral environments, you might set up the DB with <code>rails db:setup</code> to ensure a fresh start each time. This runs <code>structure.sql</code> to load the schema, then runs seeds. i.e. normally you'd only be loading the schema when setting up a local development environment, but for ephemeral environments, the schema could also get loaded into a deployed/hosted environment.</p>\n<p class=\"markdown-para\">But by default, when the schema gets dumped for PostgreSQL, it includes <code>COMMENT</code> statements like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CREATE</span><span class=\"mtk1\"> EXTENSION </span><span class=\"mtk7\">IF</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">EXISTS</span><span class=\"mtk1\"> pgcrypto </span><span class=\"mtk7\">WITH</span><span class=\"mtk1\"> </span><span class=\"mtk7\">SCHEMA</span><span class=\"mtk1\"> public;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">COMMENT </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> EXTENSION pgcrypto </span><span class=\"mtk7\">IS</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;cryptographic functions&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p class=\"markdown-para\">The problem? Heroku pre-installs common extensions like <code>pgcrypto</code>, but your Heroku user doesn’t <em class=\"markdown-emphasis\">own</em> the extension. So when the SQL tries to run <code>COMMENT ON EXTENSION</code>, you’ll get an error like:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">psql:/app/db/structure.sql:23: ERROR:  must be owner of extension pgcrypto...</span></span></code></pre>\n<p class=\"markdown-para\">This fails the schema load and breaks setup on Heroku.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Why This Happens</strong></p>\n<p class=\"markdown-para\">PostgreSQL restricts operations like <code>COMMENT ON EXTENSION</code> to the <em class=\"markdown-emphasis\">owner</em> of the extension. But on Heroku, your app's database user is not the owner, Heroku is. So the SQL dump contains statements that the app user doesn't have permission to execute.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Solution: Strip Comments from Schema Dump</strong></p>\n<p class=\"markdown-para\">Rails lets you customize the flags passed when <a href=\"https://guides.rubyonrails.org/active_record_postgresql.html#structure-dumps\" class=\"markdown-link\">generating the structure dump</a>. To avoid these issues, configure Rails to exclude comments when dumping the structure. Create <code>config/initializers/structure_dump.rb</code> as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">ActiveRecord</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Tasks</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">DatabaseTasks</span><span class=\"mtk1\">.</span><span class=\"mtk5\">structure_dump_flags</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;--no-comments&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span></code></pre>\n<p class=\"markdown-para\">Then regenerate the schema:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sh\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:schema:dump</span></span></span></code></pre>\n<p class=\"markdown-para\">Open <code>structure.sql</code> and confirm that the <code>COMMENT ON EXTENSION</code> lines are gone.</p>\n<p class=\"markdown-para\">Now, deploying to a Heroku review app or other ephemeral environment should work.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Final Tip: Leave Yourself Breadcrumbs</strong></p>\n<p class=\"markdown-para\">If you're adding an initializer config like <code>structure_dump.rb</code>, add inline comments to explain why. It’s easy to forget six months later <em class=\"markdown-emphasis\">why</em> a flag was added, especially in rarely-touched config files. So your final version may look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Prevent pg_dump from including COMMENT ON EXTENSION lines,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># which can cause permission errors on Heroku or other hosted environments.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># See: https://guides.rubyonrails.org/active_record_postgresql.html#structure-dumps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">ActiveRecord</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Tasks</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">DatabaseTasks</span><span class=\"mtk1\">.</span><span class=\"mtk5\">structure_dump_flags</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;--no-comments&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"wrapping-up\" style=\"position:relative;\"><a href=\"#wrapping-up\" aria-label=\"wrapping up permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wrapping Up</h2>\n<p class=\"markdown-para\">Switching to SQL schema format in the middle of a Rails project is essential when you need to capture raw SQL in your migrations. It provides full control over the database schema and avoids limitations of the Ruby-based DSL. With a few tweaks, it can be made Heroku-friendly as well.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":5,"tableOfContents":"<ul>\n<li><a href=\"#why-i-switched\">Why I Switched</a></li>\n<li><a href=\"#1-configure-sql-schema-dumps\">1: Configure SQL Schema Dumps</a></li>\n<li><a href=\"#2-generate-sql-schema\">2: Generate SQL Schema</a></li>\n<li><a href=\"#3-delete-ruby-schema\">3: Delete Ruby Schema</a></li>\n<li><a href=\"#4-run-sql-migration\">4: Run SQL Migration</a></li>\n<li><a href=\"#5-verify-schema-loading\">5: Verify Schema Loading</a></li>\n<li><a href=\"#pg-extensions-and-heroku-review-apps\">PG Extensions and Heroku Review Apps</a></li>\n<li><a href=\"#wrapping-up\">Wrapping Up</a></li>\n</ul>","frontmatter":{"title":"Switching From Ruby to SQL Schema in Rails","date":"01 Oct 2025","description":"How to switch from Rails default schema.rb to a SQL-based structure.sql schema dump mid-project without breaking your existing setup.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/9d190206675d13a69a6a413d56068642/fc2d4/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.jpg","srcSet":"/static/9d190206675d13a69a6a413d56068642/b834a/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.jpg 225w,\n/static/9d190206675d13a69a6a413d56068642/21c52/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.jpg 450w,\n/static/9d190206675d13a69a6a413d56068642/fc2d4/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/9d190206675d13a69a6a413d56068642/71a10/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.webp 225w,\n/static/9d190206675d13a69a6a413d56068642/901f1/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.webp 450w,\n/static/9d190206675d13a69a6a413d56068642/4ffff/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":600}}}},"fields":{"slug":"/blog/from-ruby-to-sql-schema/"}},"relatedP":{"edges":[{"node":{"id":"96b087a4-28a9-51a7-ad22-48dc6787757b","frontmatter":{"title":"Efficient Database Queries in Rails: A Practical Approach","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#083858","images":{"fallback":{"src":"/static/456c5a98a74fd815a1cf5c800f73abc1/26528/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg","srcSet":"/static/456c5a98a74fd815a1cf5c800f73abc1/26528/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg 300w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/43429/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/456c5a98a74fd815a1cf5c800f73abc1/5d6c3/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.webp 300w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/68dbc/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-query-perf/"}}},{"node":{"id":"c7b23da1-58aa-5f7e-8d61-8c308e6ef0ac","frontmatter":{"title":"Setup a Rails Project with Postgres and Docker","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#583838","images":{"fallback":{"src":"/static/03714b36bbd86fee510f6b5b6ed12b0b/26528/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.jpg","srcSet":"/static/03714b36bbd86fee510f6b5b6ed12b0b/26528/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.jpg 300w,\n/static/03714b36bbd86fee510f6b5b6ed12b0b/43429/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/03714b36bbd86fee510f6b5b6ed12b0b/5d6c3/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.webp 300w,\n/static/03714b36bbd86fee510f6b5b6ed12b0b/68dbc/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-postgres-docker/"}}},{"node":{"id":"d84ac79f-d860-544a-8abb-63add1da9214","frontmatter":{"title":"Understanding ActiveRecord Dependent Options","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#282828","images":{"fallback":{"src":"/static/b7f7064c193fa4dc20f20d253e1928fa/26528/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg","srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/26528/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 300w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/43429/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/b7f7064c193fa4dc20f20d253e1928fa/5d6c3/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 300w,\n/static/b7f7064c193fa4dc20f20d253e1928fa/68dbc/activerecord-dep-gary-chan-YzSZN3qvHeo-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/activerecord-dependent-options/"}}}]}},"pageContext":{"slug":"/blog/from-ruby-to-sql-schema/","relatedPosts":["Setup a Rails Project with Postgres and Docker","Efficient Database Queries in Rails: A Practical Approach","Understanding ActiveRecord Dependent Options"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}