{"componentChunkName":"component---src-templates-post-js","path":"/blog/roll-your-own-search-service-for-gatsby-part4/","result":{"data":{"markdownRemark":{"html":"<p>This is the fourth in a multi-part series of posts detailing how I built the search feature for this blog. This post will explain how to build a search API with Rails, using the <a href=\"https://github.com/Casecommons/pg_search\">pg-search</a> gem and how to deploy it to production.</p>\n<p>In case you missed it, <a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> of this series covers the existing options for adding search to a Gatsby site, and why I decided not to use any of them, and instead build a custom search service. <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> covers the design and population of the <code>documents</code> table that contains all the content to be searched. <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> provides an introduction to PostgreSQL Full Text Search, showing some examples of using it to write queries to search against a documents table.</p>\n<h2>Install</h2>\n<p>First step is to add the <code>pg-search</code> gem to the <code>Gemfile</code> and run <code>bundle install</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Postgres Full Text Search</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem </span><span class=\"mtk6\">&#39;pg_search&#39;</span></span></span></code></pre>\n<h2>Model</h2>\n<p>Next step is to add a search scope to the <code>Document</code> model. This model and the population of the underlying <code>documents</code> table was covered in <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a>. As a quick reminder, here are a few rows from this table, <code>body</code> column shortened for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hello=&gt; select title, category, slug, left(body, 40) as body from documents;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                               title                                |     category     |                          slug                           |                   body</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------------------------------------------------------------+------------------+---------------------------------------------------------+------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Add a Language to gatsby-remark-vscode                             | web development  | /blog/add-language-gatsby-remark-vscode/                |  This blog is built with [Gatsby](https:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> A VS Code Alternative to Postman                                   | Web Development  | /blog/postman-alternative-vscode/                       |  If youve been doing web development for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails CORS Middleware For Multiple Resources                       | rails            | /blog/rails-cors-middleware-multiple/                   |  A short post for today on a usage of [C</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                                       | javascript       | /blog/tdd-by-example-bugfix/                            |  This post will demonstrate an example o</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Saving on monthly expenses - A Cautionary Tale                     | personal finance | /blog/save-monthly-expense-caution/                     |  Today I want to share a cautionary tale</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails Blocked Host Solved by Docker Cleanup                        | rails            | /blog/rails-blocked-host-docker-clean/                  |  Today I want to share a debugging story</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ...</span></span></code></pre>\n<p>And here is the current model class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p><code>pg_search_scope</code> from the <code>pg_search</code> gem is used to define a method on the model class that will execute a full text search against the <code>documents</code> table. It accepts a hash of options, of which the <code>against</code> property is required, to specify an array of fields to be searched. The <code>PgSearch::Model</code> module must also be included in the model. For example, to search the  <code>body</code> field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  pg_search_scope </span><span class=\"mtk4\">:search_doc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[body]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>To see this in action, open a Rails console with <code>bin/rails c</code> and run the <code>search_doc</code> method on the <code>Documents</code> model for search term <code>tdd</code>.</p>\n<p>I've inserted some line breaks in the query that the gem generated and the results for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">003</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search_doc(</span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Document Load (</span><span class=\"mtk4\">138</span><span class=\"mtk1\">.8ms)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  INNER JOIN (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> AS pg_search_id,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (ts_rank((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))), (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)), </span><span class=\"mtk4\">0</span><span class=\"mtk1\">)) AS rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    WHERE ((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))) @@ (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)))) AS pg_search_9b16b44d0e0a5cac4f968b</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ON </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> pg_search_9b16b44d0e0a5cac4f968b.pg_search_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ORDER BY pg_search_9b16b44d0e0a5cac4f968b.rank DESC, </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> ASC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  LIMIT $1  [[</span><span class=\"mtk6\">&quot;LIMIT&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">11</span><span class=\"mtk1\">]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk3\">#&lt;ActiveRecord::Relation [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#&lt;Document id: 15, title: &quot;TDD by Example&quot;, description: &quot;A practical example of using TDD to add a new feat...&quot;, category: &quot;javascript&quot;, published_at: &quot;2021-01-02&quot;, slug: &quot;/blog/tdd-by-example/&quot;, body: &quot; If youve been coding for any length of time, youv...&quot;, created_at: &quot;2021-06-26 19:18:51&quot;, updated_at: &quot;2021-06-26 19:18:51&quot;, excerpt: &quot;If youve been coding for any length of time, youve...&quot;&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#&lt;Document id: 6, title: &quot;TDD by Example: Fixing a Bug&quot;, description: &quot;A practical example of using TDD to fix a bug and ...&quot;, category: &quot;javascript&quot;, published_at: &quot;2021-05-16&quot;, slug: &quot;/blog/tdd-by-example-bugfix/&quot;, body: &quot; This post will demonstrate an example of using TD...&quot;, created_at: &quot;2021-06-26 19:18:51&quot;, updated_at: &quot;2021-06-26 19:18:51&quot;, excerpt: &quot;This post will demonstrate an example of using TDD...&quot;&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#&lt;Document id: 12, title: &quot;Solving a Python Interview Question in Ruby&quot;, description: &quot;Learn how to model tuples in Ruby and solve a Pyth...&quot;, category: &quot;ruby&quot;, published_at: &quot;2021-03-01&quot;, slug: &quot;/blog/python-interview-question-in-ruby/&quot;, body: &quot; A few months ago, I came across a tweet posing a ...&quot;, created_at: &quot;2021-06-26 19:18:51&quot;, updated_at: &quot;2021-06-26 19:18:51&quot;, excerpt: &quot;A few months ago, I came across a tweet posing a t...&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span><span class=\"mtk7\">&gt;</span></span></span></code></pre>\n<p>The <code>ts_vector</code>, <code>ts_query</code>, and <code>ts_rank</code> Postgres functions were covered in <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> of this series. As a reminder, here was the query to search the documents <code>body</code> field for the search term <code>tdd</code> and order results by descending rank:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk7\">as</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ORDER BY</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span><span class=\"mtk1\"> </span><span class=\"mtk7\">DESC</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Adding the <code>pg_search_scope</code> to the model enabled executing a full text search against PostgreSQL, without having to write this query in the model. The generated query also uses the PostgreSQL <code>coalesce</code> function which returns the first non null value from its given list of arguments. This is to ensure that a null value will not get passed to the ts_vector function. For example <code>coalesce(\"documents\".\"body\"::text, '')</code> will return an empty string if it encounters a null <code>body</code> field in the <code>documents</code> table.</p>\n<p>Also note the generated query returns a max of 11 results, as set by the <code>LIMIT</code> option.</p>\n<p>The result of the generated <code>search_doc</code> function is an <code>ActiveRecord::Relation</code>, representing the list of <code>Document</code> model results that match the query. In this example, the first two are articles explicitly on TDD, and the last is an article about solving an interview question, in which the TDD approach is used. These are the same results we saw when running the simpler version of the query against using the <code>psql</code> client in <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> of this series.</p>\n<p>The gem also supports searching by multiple fields. For example, to search by <code>body</code>, and <code>title</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  pg_search_scope </span><span class=\"mtk4\">:search_doc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[body title]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now the generated query includes both <code>documents.body</code> and <code>documents.title</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">007</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search_doc(</span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Document Load (</span><span class=\"mtk4\">131</span><span class=\"mtk1\">.1ms)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">INNER JOIN (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> AS pg_search_id,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (ts_rank((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;title&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)) </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))), (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)), </span><span class=\"mtk4\">0</span><span class=\"mtk1\">)) AS rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  WHERE ((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;title&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)) </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))) @@ (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)))) AS pg_search_9b16b44d0e0a5cac4f968b</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ON </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> pg_search_9b16b44d0e0a5cac4f968b.pg_search_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ORDER BY pg_search_9b16b44d0e0a5cac4f968b.rank DESC, </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> ASC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">LIMIT $1  [[</span><span class=\"mtk6\">&quot;LIMIT&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">11</span><span class=\"mtk1\">]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Results are the same as before for this example</span></span></span></code></pre>\n<p>For my blog search, this is all I need from the <code>pg-search</code> gem. However, I've barely scratched the surface of all the available features, see the <a href=\"https://github.com/Casecommons/pg_search\">docs</a> if you need more features.</p>\n<h2>Route and Controller</h2>\n<p>It's great that there's an easy way to search the <code>Document</code> model, but recall the goal of this exercise is to build a search API accessible over HTTP so that the Gatsby blog can make use of it. This will require exposing a route such as <code>GET /search?q=foo</code> and a controller to handle this route, delegating the heavy lifting of search to the <code>Document</code> model.</p>\n<p>Starting with the route. This will be read only so only exposing the <code>index</code> method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/routes.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.routes.draw </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  resources </span><span class=\"mtk4\">:search</span><span class=\"mtk1\">, </span><span class=\"mtk4\">only:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[index]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Since the resource is named <code>search</code>, Rails will expect a search controller with an <code>index</code> method. This will only be used for an HTTP API so it only returns json:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/search_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SearchController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    q </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> params[</span><span class=\"mtk4\">:q</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |</span><span class=\"mtk9\">format</span><span class=\"mtk1\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.json { render </span><span class=\"mtk4\">json:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search(q) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>What is this method <code>Document.search</code>? Recall earlier when hooking up the <code>pg_search</code> gem to the <code>Document</code> model, we defined a search scope of <code>search_doc</code>. However, this won't be suitable for calling directly from the API because that would expose <em>all</em> fields from the Document model including the <code>body</code> field, primary id and auto generated timestamps. These aren't necessary for the API results.</p>\n<p>The <code>body</code> field specifically is huge and unnecessary because the blog contains the actual article content. It only needs the slug returned in API results to generate a link to the article.</p>\n<p>So I've added a new <code>search</code> method on the <code>Document</code> model to wrap the call to <code>search_doc</code> and convert the results to an api format that limits the returned fields:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  pg_search_scope </span><span class=\"mtk4\">:search_doc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[title body]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># NEW METHOD:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#   1. Wrap call to search_doc generated by pg_search gem.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#   2. Convert results to limit which fields are returned.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.search</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">query</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    docs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search_doc(query)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    docs.map(</span><span class=\"mtk7\">&amp;</span><span class=\"mtk4\">:to_api</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to_api</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">description:</span><span class=\"mtk1\"> description,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">category:</span><span class=\"mtk1\"> category,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> published_at,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">slug:</span><span class=\"mtk1\"> slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">excerpt:</span><span class=\"mtk1\"> excerpt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now that the route and controller are in place, run <code>bin/rails routes</code> to verify the route is available:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ bin/rails routes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Prefix        Verb   URI Pattern                   Controller#Action</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">search_index  GET    /search(.:format)             search#index</span></span></code></pre>\n<h2>API</h2>\n<p>To see the search route in action, we'll create a <code>search.http</code> file and use a VS Code REST client extension to execute some search requests. I've written about this <a href=\"../postman-alternative-vscode\">useful extension</a> before.</p>\n<p>Start by defining the <code>host</code> variable as a rest-client environment variable in a project-specific <code>settings.json</code> file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// .vscode/settings.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;rest-client.environmentVariables&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;local&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;host&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;http://localhost:3000&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;production&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;host&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;https://prod-host.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Then create an http file to contain all the search requests, let's start with just one request to search for <code>tdd</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># http/search.http</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=tdd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span></code></pre>\n<p>Hit <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>E</kbd> to select the <code>local</code> environment from the environment selector that pops up.</p>\n<p>Then hit <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>R</kbd> while the cursor is anywhere on the <code>GET</code> request line to run it.</p>\n<p>A new editor tab will open up in a side-by-side view with the results of executing the search request against the local Rails server. Here are the results. These are the same three articles we saw before when invoking the <code>search_doc</code> method on the <code>Document</code> model, but this time, only the API fields are returned.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">HTTP/1.1 200 OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Content-Type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json; charset=utf-8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;TDD by Example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A practical example of using TDD to add a new feature to an existing project.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;javascript&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-01-02&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/tdd-by-example/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;If youve been coding for any length of time, youve probably heard that you should test your code, and by that I mean writing automated…&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;TDD by Example: Fixing a Bug&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A practical example of using TDD to fix a bug and do some refactoring on an existing project.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;javascript&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-05-16&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/tdd-by-example-bugfix/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This post will demonstrate an example of using TDD (test driven development) to fix a bug on an existing project. If youre not familiar…&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Solving a Python Interview Question in Ruby&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Learn how to model tuples in Ruby and solve a Python data science interview question in Ruby.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;ruby&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-03-01&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/python-interview-question-in-ruby/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A few months ago, I came across a tweet posing a technical interview question for a data science position using Python:  Lets set aside for…&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span></code></pre>\n<p>To add more search examples to the http file, separate them with <code>###</code>. For example, to see how it behaves when no results are found:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">```http</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># http/search.http</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Example request that returns results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=tdd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Example request when no results found</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=zzzzzzzzz</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span></code></pre>\n<p>Running the search for <code>zzzzzzzzz</code> returns an empty array because no documents match this search term:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">HTTP/1.1 200 OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Content-Type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json; charset=utf-8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[]</span></span></span></code></pre>\n<h2>Automated Tests</h2>\n<p>This article is getting quite lengthy, so rather than going over the document and search request tests in detail, here are the links to the RSpec test files for these:</p>\n<ul>\n<li><a href=\"https://github.com/danielabar/hello-visitor/blob/main/spec/models/document_spec.rb\">Document Model Tests</a></li>\n<li><a href=\"https://github.com/danielabar/hello-visitor/blob/main/spec/requests/search_spec.rb\">Search Request Tests</a></li>\n</ul>\n<h2>CORS</h2>\n<p>The last thing that is needed for the search feature is to enable <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS\">CORS</a> because the blog that needs to make requests to the search service is hosted on a different server (Github Pages) than the Rails search service (Heroku). In Rails, this can be configured using the <code>rack-cors</code> middleware. See an earlier <a href=\"../rails-cors-middleware-multiple\">article</a> I wrote about this for more details.</p>\n<p>Here is the configuration. <code>ALLOWED_ORIGIN</code> gets set to the blog url in production. For example, if the blog (or any web site really) that needs to access the search service is hosted at <code>https://my-awesome-blog.com</code>, then the <code>ALLOWED_ORIGIN</code> environment variable would be set to <code>https://my-awesome-blog.com</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/search&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[get]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Deployment</h2>\n<p>Now that the search service is working locally, it's time to deploy it. I'm using Heroku with the PostgreSQL add-on so these instructions will be specific to that platform.</p>\n<p>The <code>search.sql</code> file mentioned in instructions below was covered in <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> of this series.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install the Heroku CLI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">brew tap heroku/brew </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> brew install heroku</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create an app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /path/to/project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Given that all changes are merged to main branch, deploy to Heroku</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git push heroku main</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run migrations (this will create the documents table)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku run rake db:migrate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Configure environment variable used by CORS initializer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set ALLOWED_ORIGIN=https://your.blog.com</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Ingest search documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cat </span><span class=\"mtk7\">~</span><span class=\"mtk1\">/path/to/search.sql </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> heroku pg:psql --app app-name</span></span></span></code></pre>\n<p>To test that it's working on Heroku:</p>\n<ul>\n<li>Update the <code>.vscode/settings.json</code> file, <code>production</code> section with the Heroku host. This will be something like <code>https://your-app-name.herokuapp.com</code>.</li>\n<li>Hit <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>E</kbd> to select the <code>production</code> environment from the environment selector that pops up.</li>\n<li>Run the <code>GET {{host}}/search?q=tdd</code> search request, this time it should return the same results but from the production server.</li>\n</ul>\n<p>If the production request doesn't succeed, check the Heroku logs with <code>heroku logs --tail</code> for further investigation.</p>\n<h2>What's Next?</h2>\n<p>This post explained how to build a search service API using Rails and PostgreSQL with the help of the <a href=\"https://github.com/Casecommons/pg_search\">pg-search</a> gem and how to deploy it. Next up, see <a href=\"../roll-your-own-search-service-for-gatsby-part5\">Part 5: Search GUI</a> for how to build the search UI components of the Gatsby blog, which will tie everything in this series together.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search API","date":"11 Jul 2021","description":"Learn how to build search service using Rails and Postgres Full Text Search for a Gatsby blog.","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIFBP/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAF9s6kLDDP/xAAZEAACAwEAAAAAAAAAAAAAAAABAwACEhD/2gAIAQEAAQUCWyyyHTYMzuUXUc//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPwFn/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhABAQACAwAAAAAAAAAAAAAAEQABEDFhgf/aAAgBAQAGPwIfJXqZzca//8QAGxAAAgMAAwAAAAAAAAAAAAAAACEBEVExscH/2gAIAQEAAT8hUS9T0WJRrw1oG2sgrhyeUf/aAAwDAQACAAMAAAAQN/8A/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAR/9oACAEDAQE/ECq//8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQIBAT8QBn//xAAcEAEBAAMBAAMAAAAAAAAAAAABEQAhMXFRkbH/2gAIAQEAAT8QWq7uo+uXDE6KKbvj8xCVQ5OZothpNTGRFdvPrCECHwZ//9k=","aspectRatio":1.5010309278350515,"src":"/static/ecacb98b5280820da4e1504d9c745ee9/14b42/roll-search-4.jpg","srcSet":"/static/ecacb98b5280820da4e1504d9c745ee9/f836f/roll-search-4.jpg 200w,\n/static/ecacb98b5280820da4e1504d9c745ee9/2244e/roll-search-4.jpg 400w,\n/static/ecacb98b5280820da4e1504d9c745ee9/14b42/roll-search-4.jpg 800w,\n/static/ecacb98b5280820da4e1504d9c745ee9/47498/roll-search-4.jpg 1200w,\n/static/ecacb98b5280820da4e1504d9c745ee9/694fe/roll-search-4.jpg 1456w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part4/"}}},"pageContext":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part4/","content":"<p>This is the fourth in a multi-part series of posts detailing how I built the search feature for this blog. This post will explain how to build a search API with Rails, using the <a href=\"https://github.com/Casecommons/pg_search\">pg-search</a> gem and how to deploy it to production.</p>\n<p>In case you missed it, <a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> of this series covers the existing options for adding search to a Gatsby site, and why I decided not to use any of them, and instead build a custom search service. <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> covers the design and population of the <code>documents</code> table that contains all the content to be searched. <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> provides an introduction to PostgreSQL Full Text Search, showing some examples of using it to write queries to search against a documents table.</p>\n<h2>Install</h2>\n<p>First step is to add the <code>pg-search</code> gem to the <code>Gemfile</code> and run <code>bundle install</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Postgres Full Text Search</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem </span><span class=\"mtk6\">&#39;pg_search&#39;</span></span></span></code></pre>\n<h2>Model</h2>\n<p>Next step is to add a search scope to the <code>Document</code> model. This model and the population of the underlying <code>documents</code> table was covered in <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a>. As a quick reminder, here are a few rows from this table, <code>body</code> column shortened for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hello=&gt; select title, category, slug, left(body, 40) as body from documents;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                               title                                |     category     |                          slug                           |                   body</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------------------------------------------------------------+------------------+---------------------------------------------------------+------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Add a Language to gatsby-remark-vscode                             | web development  | /blog/add-language-gatsby-remark-vscode/                |  This blog is built with [Gatsby](https:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> A VS Code Alternative to Postman                                   | Web Development  | /blog/postman-alternative-vscode/                       |  If youve been doing web development for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails CORS Middleware For Multiple Resources                       | rails            | /blog/rails-cors-middleware-multiple/                   |  A short post for today on a usage of [C</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                                       | javascript       | /blog/tdd-by-example-bugfix/                            |  This post will demonstrate an example o</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Saving on monthly expenses - A Cautionary Tale                     | personal finance | /blog/save-monthly-expense-caution/                     |  Today I want to share a cautionary tale</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails Blocked Host Solved by Docker Cleanup                        | rails            | /blog/rails-blocked-host-docker-clean/                  |  Today I want to share a debugging story</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ...</span></span></code></pre>\n<p>And here is the current model class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p><code>pg_search_scope</code> from the <code>pg_search</code> gem is used to define a method on the model class that will execute a full text search against the <code>documents</code> table. It accepts a hash of options, of which the <code>against</code> property is required, to specify an array of fields to be searched. The <code>PgSearch::Model</code> module must also be included in the model. For example, to search the  <code>body</code> field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  pg_search_scope </span><span class=\"mtk4\">:search_doc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[body]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>To see this in action, open a Rails console with <code>bin/rails c</code> and run the <code>search_doc</code> method on the <code>Documents</code> model for search term <code>tdd</code>.</p>\n<p>I've inserted some line breaks in the query that the gem generated and the results for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">003</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search_doc(</span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Document Load (</span><span class=\"mtk4\">138</span><span class=\"mtk1\">.8ms)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  INNER JOIN (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> AS pg_search_id,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (ts_rank((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))), (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)), </span><span class=\"mtk4\">0</span><span class=\"mtk1\">)) AS rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    WHERE ((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))) @@ (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)))) AS pg_search_9b16b44d0e0a5cac4f968b</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ON </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> pg_search_9b16b44d0e0a5cac4f968b.pg_search_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ORDER BY pg_search_9b16b44d0e0a5cac4f968b.rank DESC, </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> ASC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  LIMIT $1  [[</span><span class=\"mtk6\">&quot;LIMIT&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">11</span><span class=\"mtk1\">]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk3\">#&lt;ActiveRecord::Relation [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#&lt;Document id: 15, title: &quot;TDD by Example&quot;, description: &quot;A practical example of using TDD to add a new feat...&quot;, category: &quot;javascript&quot;, published_at: &quot;2021-01-02&quot;, slug: &quot;/blog/tdd-by-example/&quot;, body: &quot; If youve been coding for any length of time, youv...&quot;, created_at: &quot;2021-06-26 19:18:51&quot;, updated_at: &quot;2021-06-26 19:18:51&quot;, excerpt: &quot;If youve been coding for any length of time, youve...&quot;&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#&lt;Document id: 6, title: &quot;TDD by Example: Fixing a Bug&quot;, description: &quot;A practical example of using TDD to fix a bug and ...&quot;, category: &quot;javascript&quot;, published_at: &quot;2021-05-16&quot;, slug: &quot;/blog/tdd-by-example-bugfix/&quot;, body: &quot; This post will demonstrate an example of using TD...&quot;, created_at: &quot;2021-06-26 19:18:51&quot;, updated_at: &quot;2021-06-26 19:18:51&quot;, excerpt: &quot;This post will demonstrate an example of using TDD...&quot;&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#&lt;Document id: 12, title: &quot;Solving a Python Interview Question in Ruby&quot;, description: &quot;Learn how to model tuples in Ruby and solve a Pyth...&quot;, category: &quot;ruby&quot;, published_at: &quot;2021-03-01&quot;, slug: &quot;/blog/python-interview-question-in-ruby/&quot;, body: &quot; A few months ago, I came across a tweet posing a ...&quot;, created_at: &quot;2021-06-26 19:18:51&quot;, updated_at: &quot;2021-06-26 19:18:51&quot;, excerpt: &quot;A few months ago, I came across a tweet posing a t...&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span><span class=\"mtk7\">&gt;</span></span></span></code></pre>\n<p>The <code>ts_vector</code>, <code>ts_query</code>, and <code>ts_rank</code> Postgres functions were covered in <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> of this series. As a reminder, here was the query to search the documents <code>body</code> field for the search term <code>tdd</code> and order results by descending rank:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk7\">as</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ORDER BY</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span><span class=\"mtk1\"> </span><span class=\"mtk7\">DESC</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Adding the <code>pg_search_scope</code> to the model enabled executing a full text search against PostgreSQL, without having to write this query in the model. The generated query also uses the PostgreSQL <code>coalesce</code> function which returns the first non null value from its given list of arguments. This is to ensure that a null value will not get passed to the ts_vector function. For example <code>coalesce(\"documents\".\"body\"::text, '')</code> will return an empty string if it encounters a null <code>body</code> field in the <code>documents</code> table.</p>\n<p>Also note the generated query returns a max of 11 results, as set by the <code>LIMIT</code> option.</p>\n<p>The result of the generated <code>search_doc</code> function is an <code>ActiveRecord::Relation</code>, representing the list of <code>Document</code> model results that match the query. In this example, the first two are articles explicitly on TDD, and the last is an article about solving an interview question, in which the TDD approach is used. These are the same results we saw when running the simpler version of the query against using the <code>psql</code> client in <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> of this series.</p>\n<p>The gem also supports searching by multiple fields. For example, to search by <code>body</code>, and <code>title</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  pg_search_scope </span><span class=\"mtk4\">:search_doc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[body title]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now the generated query includes both <code>documents.body</code> and <code>documents.title</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">007</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search_doc(</span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Document Load (</span><span class=\"mtk4\">131</span><span class=\"mtk1\">.1ms)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">INNER JOIN (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> AS pg_search_id,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (ts_rank((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;title&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)) </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))), (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)), </span><span class=\"mtk4\">0</span><span class=\"mtk1\">)) AS rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  WHERE ((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;title&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)) </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))) @@ (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)))) AS pg_search_9b16b44d0e0a5cac4f968b</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ON </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> pg_search_9b16b44d0e0a5cac4f968b.pg_search_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ORDER BY pg_search_9b16b44d0e0a5cac4f968b.rank DESC, </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> ASC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">LIMIT $1  [[</span><span class=\"mtk6\">&quot;LIMIT&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">11</span><span class=\"mtk1\">]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Results are the same as before for this example</span></span></span></code></pre>\n<p>For my blog search, this is all I need from the <code>pg-search</code> gem. However, I've barely scratched the surface of all the available features, see the <a href=\"https://github.com/Casecommons/pg_search\">docs</a> if you need more features.</p>\n<h2>Route and Controller</h2>\n<p>It's great that there's an easy way to search the <code>Document</code> model, but recall the goal of this exercise is to build a search API accessible over HTTP so that the Gatsby blog can make use of it. This will require exposing a route such as <code>GET /search?q=foo</code> and a controller to handle this route, delegating the heavy lifting of search to the <code>Document</code> model.</p>\n<p>Starting with the route. This will be read only so only exposing the <code>index</code> method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/routes.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.routes.draw </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  resources </span><span class=\"mtk4\">:search</span><span class=\"mtk1\">, </span><span class=\"mtk4\">only:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[index]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Since the resource is named <code>search</code>, Rails will expect a search controller with an <code>index</code> method. This will only be used for an HTTP API so it only returns json:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/search_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SearchController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    q </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> params[</span><span class=\"mtk4\">:q</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |</span><span class=\"mtk9\">format</span><span class=\"mtk1\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.json { render </span><span class=\"mtk4\">json:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search(q) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>What is this method <code>Document.search</code>? Recall earlier when hooking up the <code>pg_search</code> gem to the <code>Document</code> model, we defined a search scope of <code>search_doc</code>. However, this won't be suitable for calling directly from the API because that would expose <em>all</em> fields from the Document model including the <code>body</code> field, primary id and auto generated timestamps. These aren't necessary for the API results.</p>\n<p>The <code>body</code> field specifically is huge and unnecessary because the blog contains the actual article content. It only needs the slug returned in API results to generate a link to the article.</p>\n<p>So I've added a new <code>search</code> method on the <code>Document</code> model to wrap the call to <code>search_doc</code> and convert the results to an api format that limits the returned fields:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  pg_search_scope </span><span class=\"mtk4\">:search_doc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[title body]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># NEW METHOD:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#   1. Wrap call to search_doc generated by pg_search gem.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#   2. Convert results to limit which fields are returned.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.search</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">query</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    docs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search_doc(query)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    docs.map(</span><span class=\"mtk7\">&amp;</span><span class=\"mtk4\">:to_api</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to_api</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">description:</span><span class=\"mtk1\"> description,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">category:</span><span class=\"mtk1\"> category,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> published_at,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">slug:</span><span class=\"mtk1\"> slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">excerpt:</span><span class=\"mtk1\"> excerpt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now that the route and controller are in place, run <code>bin/rails routes</code> to verify the route is available:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ bin/rails routes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Prefix        Verb   URI Pattern                   Controller#Action</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">search_index  GET    /search(.:format)             search#index</span></span></code></pre>\n<h2>API</h2>\n<p>To see the search route in action, we'll create a <code>search.http</code> file and use a VS Code REST client extension to execute some search requests. I've written about this <a href=\"../postman-alternative-vscode\">useful extension</a> before.</p>\n<p>Start by defining the <code>host</code> variable as a rest-client environment variable in a project-specific <code>settings.json</code> file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// .vscode/settings.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;rest-client.environmentVariables&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;local&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;host&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;http://localhost:3000&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;production&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;host&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;https://prod-host.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Then create an http file to contain all the search requests, let's start with just one request to search for <code>tdd</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># http/search.http</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=tdd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span></code></pre>\n<p>Hit <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>E</kbd> to select the <code>local</code> environment from the environment selector that pops up.</p>\n<p>Then hit <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>R</kbd> while the cursor is anywhere on the <code>GET</code> request line to run it.</p>\n<p>A new editor tab will open up in a side-by-side view with the results of executing the search request against the local Rails server. Here are the results. These are the same three articles we saw before when invoking the <code>search_doc</code> method on the <code>Document</code> model, but this time, only the API fields are returned.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">HTTP/1.1 200 OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Content-Type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json; charset=utf-8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;TDD by Example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A practical example of using TDD to add a new feature to an existing project.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;javascript&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-01-02&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/tdd-by-example/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;If youve been coding for any length of time, youve probably heard that you should test your code, and by that I mean writing automated…&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;TDD by Example: Fixing a Bug&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A practical example of using TDD to fix a bug and do some refactoring on an existing project.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;javascript&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-05-16&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/tdd-by-example-bugfix/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This post will demonstrate an example of using TDD (test driven development) to fix a bug on an existing project. If youre not familiar…&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Solving a Python Interview Question in Ruby&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Learn how to model tuples in Ruby and solve a Python data science interview question in Ruby.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;ruby&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-03-01&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/python-interview-question-in-ruby/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A few months ago, I came across a tweet posing a technical interview question for a data science position using Python:  Lets set aside for…&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span></code></pre>\n<p>To add more search examples to the http file, separate them with <code>###</code>. For example, to see how it behaves when no results are found:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">```http</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># http/search.http</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Example request that returns results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=tdd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Example request when no results found</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=zzzzzzzzz</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span></code></pre>\n<p>Running the search for <code>zzzzzzzzz</code> returns an empty array because no documents match this search term:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">HTTP/1.1 200 OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Content-Type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json; charset=utf-8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[]</span></span></span></code></pre>\n<h2>Automated Tests</h2>\n<p>This article is getting quite lengthy, so rather than going over the document and search request tests in detail, here are the links to the RSpec test files for these:</p>\n<ul>\n<li><a href=\"https://github.com/danielabar/hello-visitor/blob/main/spec/models/document_spec.rb\">Document Model Tests</a></li>\n<li><a href=\"https://github.com/danielabar/hello-visitor/blob/main/spec/requests/search_spec.rb\">Search Request Tests</a></li>\n</ul>\n<h2>CORS</h2>\n<p>The last thing that is needed for the search feature is to enable <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS\">CORS</a> because the blog that needs to make requests to the search service is hosted on a different server (Github Pages) than the Rails search service (Heroku). In Rails, this can be configured using the <code>rack-cors</code> middleware. See an earlier <a href=\"../rails-cors-middleware-multiple\">article</a> I wrote about this for more details.</p>\n<p>Here is the configuration. <code>ALLOWED_ORIGIN</code> gets set to the blog url in production. For example, if the blog (or any web site really) that needs to access the search service is hosted at <code>https://my-awesome-blog.com</code>, then the <code>ALLOWED_ORIGIN</code> environment variable would be set to <code>https://my-awesome-blog.com</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/search&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[get]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Deployment</h2>\n<p>Now that the search service is working locally, it's time to deploy it. I'm using Heroku with the PostgreSQL add-on so these instructions will be specific to that platform.</p>\n<p>The <code>search.sql</code> file mentioned in instructions below was covered in <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> of this series.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install the Heroku CLI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">brew tap heroku/brew </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> brew install heroku</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create an app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /path/to/project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Given that all changes are merged to main branch, deploy to Heroku</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git push heroku main</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run migrations (this will create the documents table)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku run rake db:migrate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Configure environment variable used by CORS initializer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set ALLOWED_ORIGIN=https://your.blog.com</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Ingest search documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cat </span><span class=\"mtk7\">~</span><span class=\"mtk1\">/path/to/search.sql </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> heroku pg:psql --app app-name</span></span></span></code></pre>\n<p>To test that it's working on Heroku:</p>\n<ul>\n<li>Update the <code>.vscode/settings.json</code> file, <code>production</code> section with the Heroku host. This will be something like <code>https://your-app-name.herokuapp.com</code>.</li>\n<li>Hit <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>E</kbd> to select the <code>production</code> environment from the environment selector that pops up.</li>\n<li>Run the <code>GET {{host}}/search?q=tdd</code> search request, this time it should return the same results but from the production server.</li>\n</ul>\n<p>If the production request doesn't succeed, check the Heroku logs with <code>heroku logs --tail</code> for further investigation.</p>\n<h2>What's Next?</h2>\n<p>This post explained how to build a search service API using Rails and PostgreSQL with the help of the <a href=\"https://github.com/Casecommons/pg_search\">pg-search</a> gem and how to deploy it. Next up, see <a href=\"../roll-your-own-search-service-for-gatsby-part5\">Part 5: Search GUI</a> for how to build the search UI components of the Gatsby blog, which will tie everything in this series together.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","title":"Roll Your Own Search with Rails and Postgres: Search API","description":"Learn how to build search service using Rails and Postgres Full Text Search for a Gatsby blog."}},"staticQueryHashes":["163244226"]}