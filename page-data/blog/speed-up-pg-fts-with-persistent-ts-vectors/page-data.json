{"componentChunkName":"component---src-templates-post-js","path":"/blog/speed-up-pg-fts-with-persistent-ts-vectors/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">A while back, I built a site-wide search bar for a Rails app, one of those \"type anything and get relevant results instantly\" features. We implemented it using PostgreSQL full-text search via the excellent <a href=\"https://github.com/Casecommons/pg_search\" class=\"markdown-link\">pg_search</a> gem.</p>\n<p class=\"markdown-para\">At first, everything felt effortless. Following the README, search worked instantly in development and even with a moderate dataset. But once the application reached production scale, performance issues started to appear. Not because <code>pg_search</code> is slow necessarily, but because some default choices that are perfectly reasonable for small datasets become problematic at scale.</p>\n<p class=\"markdown-para\">This post focuses on one of those choices: Computing PostgreSQL tsvectors at query time. It's an easy trap to fall into, because it works so well, until it doesn't. We'll look at the SQL that <code>pg_search</code> generates by default, why it forces PostgreSQL into expensive sequential scans, and how persisting and indexing tsvectors fundamentally changes the query plan and performance characteristics.</p>\n<p class=\"markdown-para\">Before diving in, I'll also mention what we <em class=\"markdown-emphasis\">didn't</em> do:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">We'd already tried an AI/RAG-style approach (retrieval-augmented generation) earlier, embedding records into a vector store and letting a model generate search-like responses. The results were unpredictable and hard to explain. So we decided on traditional full-text search where we could reason about ranking and performance.</li>\n<li class=\"markdown-list-item\">Elasticsearch or managed solutions like Algolia would've worked too, but for our volumes (low millions) and a small engineering team without full-time ops, they would have been overkill. We wanted something native to PostgreSQL, easy to deploy, easy to back up, and zero external dependencies.</li>\n</ul>\n<p class=\"markdown-para\">With that context, let's look at a simplified demo app and what I learned along the way.</p>\n<h2 class=\"markdown-subtitle\" id=\"a-simplified-example\" style=\"position:relative;\"><a href=\"#a-simplified-example\" aria-label=\"a simplified example permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A Simplified Example</h2>\n<p class=\"markdown-para\">To keep the example concrete and reproducible, I'll use a deliberately simplified Recipe app and focus only on searching recipe titles. The real application was more complex, but the performance issue discussed here shows up even in the simplest possible setup. To keep things focused, I'm looking strictly at the backend search and database performance, not UI or frontend code.</p>\n<p class=\"markdown-para\">In a real application, recipes would have many searchable attribute such as ingredients, descriptions, tags, categories, and so on. But for this post, those details would only add noise. The performance issue we're exploring shows up even in the simplest possible case.</p>\n<p class=\"markdown-para\">The search needs to handle queries like \"chicken soup\" and return recipes whose titles match all query terms, including support for prefix matches (for example, \"chick\" â†’ \"chicken\", \"chickpeas\", etc).</p>\n<p class=\"markdown-para\">Imagine the app has a <code>Recipe</code> model like:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Recipe</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">To make the performance characteristics visible, the database is seeded with 100,000 recipes rather than the tiny datasets typical of development environments. This volume is large enough to trigger the query planner behavior and latency issues discussed later. The data is generated using Faker and written to CSV, then bulk-loaded into PostgreSQL. This avoids the overhead of creating records one-by-one with Active Record, which would be too slow. If interested, see the demo <a href=\"https://github.com/danielabar/recipe_search_demo/blob/main/db/seeds/recipes.rb\" class=\"markdown-link\">recipe seeds</a> and <a href=\"https://github.com/danielabar/recipe_search_demo/blob/main/db/seeds/shared/utilities.rb\" class=\"markdown-link\">utilities</a> for more details on this technique.</p>\n<h2 class=\"markdown-subtitle\" id=\"setup-search\" style=\"position:relative;\"><a href=\"#setup-search\" aria-label=\"setup search permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setup Search</h2>\n<p class=\"markdown-para\">Getting started with <a href=\"https://github.com/Casecommons/pg_search\" class=\"markdown-link\">pg_search</a> is straightforward. After adding it to the <code>Gemfile</code> and installing it, generate and run the migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails g pg_search:migration:multisearch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:migrate</span></span></span></code></pre>\n<p class=\"markdown-para\">This creates the <code>pg_search_documents</code> table, which uses a polymorphic association (<code>searchable_type</code> / <code>searchable_id</code>), allowing many different models to share a single search index table. Think of <code>pg_search_documents</code> as a denormalized table that exists purely for search, not as a primary data table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\\d pg_search_documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                                            </span><span class=\"mtk7\">Table</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;public.pg_search_documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     Column      |              </span><span class=\"mtk7\">Type</span><span class=\"mtk1\">              | Collation | Nullable |                     Default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-----------------+--------------------------------+-----------+----------+-------------------------------------------------</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> id              | </span><span class=\"mtk7\">bigint</span><span class=\"mtk1\">                         |           | </span><span class=\"mtk7\">not</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\"> | nextval(</span><span class=\"mtk6\">&#39;pg_search_documents_id_seq&#39;</span><span class=\"mtk1\">::regclass)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> content         | </span><span class=\"mtk7\">text</span><span class=\"mtk1\">                           |           |          |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> searchable_type | </span><span class=\"mtk7\">character</span><span class=\"mtk1\"> varying              |           |          |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> searchable_id   | </span><span class=\"mtk7\">bigint</span><span class=\"mtk1\">                         |           |          |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> created_at      | </span><span class=\"mtk7\">timestamp</span><span class=\"mtk1\">(</span><span class=\"mtk4\">6</span><span class=\"mtk1\">) </span><span class=\"mtk7\">without</span><span class=\"mtk1\"> </span><span class=\"mtk7\">time</span><span class=\"mtk1\"> </span><span class=\"mtk7\">zone</span><span class=\"mtk1\"> |           | </span><span class=\"mtk7\">not</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> updated_at      | </span><span class=\"mtk7\">timestamp</span><span class=\"mtk1\">(</span><span class=\"mtk4\">6</span><span class=\"mtk1\">) </span><span class=\"mtk7\">without</span><span class=\"mtk1\"> </span><span class=\"mtk7\">time</span><span class=\"mtk1\"> </span><span class=\"mtk7\">zone</span><span class=\"mtk1\"> |           | </span><span class=\"mtk7\">not</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Indexes:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;pg_search_documents_pkey&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">PRIMARY</span><span class=\"mtk1\"> </span><span class=\"mtk7\">KEY</span><span class=\"mtk1\">, btree (id)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;index_pg_search_documents_on_searchable&quot;</span><span class=\"mtk1\"> btree (searchable_type, searchable_id)</span></span></span></code></pre>\n<p class=\"markdown-para\">Next, configure <code>pg_search</code> to use the English text search dictionary (for stemming and stopwords) and enable prefix matching so partial terms like \"chi\" will match \"chicken\" or \"chickpeas\":</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/pg_search.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">.</span><span class=\"mtk5\">multisearch_options</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">using:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">tsearch:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">dictionary:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;english&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">prefix:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Include the <code>PgSearch::Model</code> module in any Active Record model, and add the <code>multisearchable</code> macro specifying which attribute(s) to index:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Recipe</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  multisearchable </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>multisearchable</code> macro adds an Active Record <code>after_save</code> callback that extracts the configured attributes and writes (or updates) the corresponding row in <code>pg_search_documents</code>.</p>\n<p class=\"markdown-para\">Because this callback only runs on future saves, you need to explicitly backfill existing records to generate their initial search documents. The gem provides a command you can run at the Rails console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Multisearch</span><span class=\"mtk1\">.</span><span class=\"mtk5\">rebuild</span><span class=\"mtk1\">(Recipe)</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>rebuild</code> step creates one search document for every recipe in the database. Each <code>pg_search_documents</code> row corresponds to a single <code>Recipe</code> record: the <code>searchable_type</code> column identifies the model (<code>\"Recipe\"</code>) and the <code>searchable_id</code> column points to the recipe's <code>id</code>. The <code>content</code> column is populated from the attributes declared in the <code>against:</code> option of <code>multisearchable</code>, which in this example, is just <code>:title</code>.</p>\n<p class=\"markdown-para\">You can verify this in a Rails database console (<code>bin/rails db</code>):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Confirm there is one search document per recipe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> </span><span class=\"mtk9\">count</span><span class=\"mtk1\">(</span><span class=\"mtk7\">*</span><span class=\"mtk1\">) </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> pg_search_documents;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">--  count</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- --------</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- 100000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Inspect a sample row</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\\x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> pg_search_documents </span><span class=\"mtk7\">limit</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- -[ RECORD 1 ]---+-----------------------------------------------</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- id              | 100001</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- content         | Caprese Salad with Bay Leaves #9b1f</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- searchable_type | Recipe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- searchable_id   | 120001</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- created_at      | 2025-12-20 14:45:27.409956</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- updated_at      | 2025-12-20 14:45:27.409956</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIn the full production app, we had several different types of searchable content, which is why we used <code>PgSearch.multisearch</code> instead of <code>pg_search_scope</code>, which is to only search a single model. Multisearch lets you query across multiple models in a single query. While this gave us flexibility, the performance issue discussed here is independent of multisearch, it can affect any large dataset, even a single model.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"usage\" style=\"position:relative;\"><a href=\"#usage\" aria-label=\"usage permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Usage</h2>\n<p class=\"markdown-para\">Now that the search table is populated, we can query it. Here's an example in a Rails console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">.</span><span class=\"mtk5\">multisearch</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;chicken soup&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">limit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">10</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">Example output (the slightly odd recipe titles are an artifact of synthetic seed data designed to guarantee uniqueness at scale):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[#&lt;PgSearch::Document:0x00000001224e4260</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  id: 29879,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  content: &quot;Vegetable Soup with Chicken with Chervil #e926&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  searchable_type: &quot;Recipe&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  searchable_id: 149850,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  created_at: &quot;2025-12-20 14:00:01.752899000 +0000&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  updated_at: &quot;2025-12-20 14:00:01.752899000 +0000&quot;&gt;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> #&lt;PgSearch::Document:0x00000001224e4120</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  id: 39849,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  content: &quot;Homemade Vegetable Soup with Chicken #227b&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  searchable_type: &quot;Recipe&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  searchable_id: 159815,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  created_at: &quot;2025-12-20 14:00:01.752899000 +0000&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  updated_at: &quot;2025-12-20 14:00:01.752899000 +0000&quot;&gt;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ...]</span></span></code></pre>\n<p class=\"markdown-para\">On small datasets, this feels instantaneous. But in production, with millions of searchable rows and many concurrent users, the same query routinely took tens of seconds, and sometimes over a minute to return. To understand why, we need to examine the actual SQL that <code>pg_search</code> generates and how PostgreSQL executes it.</p>\n<h2 class=\"markdown-subtitle\" id=\"on-the-fly-tsvectors\" style=\"position:relative;\"><a href=\"#on-the-fly-tsvectors\" aria-label=\"on the fly tsvectors permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>On-The-Fly TSVectors</h2>\n<p class=\"markdown-para\">Let's take a closer look at the query that was generated by <code>PgSearch.multisearch(\"chicken soup\")</code>. This is displayed in the Rails console when you run <code>multisearch</code>.</p>\n<aside class=\"markdown-aside\">\nThis section assumes some familiarity with PostgreSQL full-text search concepts like <code>tsvector</code>, <code>to_tsvector()</code>, <code>tsquery</code>, and how stemming and lexemes work. I walk through this in more detail in an earlier post: <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/roll-your-own-search-service-for-gatsby-part3/\">Roll Your Own Search with Rails and PostgreSQL Full Text Search</a>.\n</aside>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> pg_search_id,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">COALESCE</span><span class=\"mtk1\">((</span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;content&quot;</span><span class=\"mtk1\">)::</span><span class=\"mtk7\">text</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;chicken&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;:*&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;soup&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;:*&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">FROM</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">COALESCE</span><span class=\"mtk1\">((</span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;content&quot;</span><span class=\"mtk1\">)::</span><span class=\"mtk7\">text</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) @@ (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;chicken&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;:*&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;soup&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;:*&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> pg_search_ce9b9dd18c5c0023f2116f</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk4\">pg_search_ce9b9dd18c5c0023f2116f</span><span class=\"mtk1\">.</span><span class=\"mtk4\">pg_search_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ORDER BY</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">pg_search_ce9b9dd18c5c0023f2116f</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rank</span><span class=\"mtk1\"> </span><span class=\"mtk7\">DESC</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">ASC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">LIMIT</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p class=\"markdown-para\">By default, <code>pg_search</code> computes PostgreSQL tsvectors on the fly using <code>to_tsvector()</code> function in each query. For a few hundred rows, this is fine. But at larger scales, Postgres has to reprocess every row's text at query time, causing significant latency.</p>\n<p class=\"markdown-para\">Let's use PostgreSQL's <code>EXPLAIN ANALYZE</code> to see what's going on under the hood when this query runs:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> Limit  (cost=18087.10..18087.13 rows=10 width=105) (actual time=281.914..283.388 rows=10.00 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   Buffers: shared hit=1738</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   -&gt;  Sort  (cost=18087.10..18087.20 rows=40 width=105) (actual time=281.912..283.385 rows=10.00 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         Sort Key: (ts_rank(to_tsvector(&#39;english&#39;::regconfig, COALESCE(pg_search_documents.content, &#39;&#39;::text)), &#39;&#39;&#39;chicken&#39;&#39;:* &amp; &#39;&#39;soup&#39;&#39;:*&#39;::tsquery, 0)) DESC, pg_search_documents.id</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         Sort Method: top-N heapsort  Memory: 28kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         Buffers: shared hit=1738</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         -&gt;  Gather  (cost=1000.00..18086.24 rows=40 width=105) (actual time=8.348..283.359 rows=39.00 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               Workers Planned: 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               Workers Launched: 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               Buffers: shared hit=1738</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               -&gt;  Parallel Seq Scan on pg_search_documents  (cost=0.00..17082.24 rows=24 width=105) (actual time=15.422..278.848 rows=19.50 loops=2)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Filter: (to_tsvector(&#39;english&#39;::regconfig, COALESCE(content, &#39;&#39;::text)) @@ &#39;&#39;&#39;chicken&#39;&#39;:* &amp; &#39;&#39;soup&#39;&#39;:*&#39;::tsquery)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Rows Removed by Filter: 49980</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Buffers: shared hit=1738</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Planning Time: 0.326 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Execution Time: 283.426 ms</span></span></code></pre>\n<p class=\"markdown-para\">At ~283ms for a single search over 100k rows, this is already slow on a single-user machine. In production with thousands of simultaneous users, searches were taking upwards of a minute!</p>\n<aside class=\"markdown-aside\">\nIf you're unfamiliar with reading PostgreSQL <code>EXPLAIN ANALYZE</code> output, I wrote a more in-depth walkthrough in an earlier post: <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/rails-query-perf/\">Rails Query Performance: A Practical Guide</a>.\n</aside>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Why so slow?</strong></p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-&gt;  Parallel Seq Scan on pg_search_documents</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Filter: (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        to_tsvector(&#39;english&#39;::regconfig, COALESCE(content, &#39;&#39;::text))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        @@ &#39;&#39;&#39;chicken&#39;&#39;:* &amp; &#39;&#39;soup&#39;&#39;:*&#39;::tsquery</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Rows Removed by Filter: 49980</span></span></code></pre>\n<p class=\"markdown-para\">PostgreSQL is forced into a parallel sequential scan and must evaluate <code>to_tsvector('english', COALESCE(content, ''))</code> for every row at query time. Because the tsvector is not precomputed or indexed, Postgres cannot use a GIN index and instead re-parses and tokenizes all text on each search, discarding ~50k rows after doing the work. The <code>Filter:</code> shown above is the bottleneck. This cost grows linearly with table size and concurrent users.</p>\n<h2 class=\"markdown-subtitle\" id=\"persist-tsvectors\" style=\"position:relative;\"><a href=\"#persist-tsvectors\" aria-label=\"persist tsvectors permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Persist TSVectors</h2>\n<p class=\"markdown-para\">The solution is to move tsvector generation out of the query path entirely. Instead of calling <code>to_tsvector(...)</code> on every search, we need to persist the result in a dedicated tsvector column and index it with a GIN index. PostgreSQL can then evaluate the tsquery directly against an indexed vector, turning a full table scan into an index lookup.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">What we'll build:</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">A new column of type <code>tsvector</code> that stores a precomputed search vector.</li>\n<li class=\"markdown-list-item\">A <code>GIN</code> index on that column for fast full-text lookups.</li>\n<li class=\"markdown-list-item\">A database trigger that keeps the vector in sync whenever the source text changes.</li>\n<li class=\"markdown-list-item\">A small configuration change so <code>pg_search</code> uses this column instead of recomputing vectors.</li>\n</ul>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Why a GIN Index?</strong></p>\n<p class=\"markdown-para\">A <a href=\"https://www.postgresql.org/docs/current/gin.html\" class=\"markdown-link\">GIN</a> (Generalized Inverted Index) is designed for multi-value data types, things like arrays, JSONB, and <code>tsvector</code>.\nInstead of indexing an entire row value, it indexes <em class=\"markdown-emphasis\">individual tokens</em> and maps them back to the rows that contain them. This is exactly what we want for full-text search: \"find all rows that contain these lexemes\".</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Migration</strong></p>\n<p class=\"markdown-para\">Here is the migration to creating the new column. We also need a trigger so PostgreSQL automatically updates the <code>tsvector</code> whenever the underlying text changes.</p>\n<p class=\"markdown-para\">Because this table may already be large, we'll follow <a href=\"https://github.com/ankane/strong_migrations\" class=\"markdown-link\">strong_migrations</a> best practices to avoid blocking writes, by creating the index concurrently.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddTsvectorColumnAndIndexToPgSearchDocuments</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">8.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Required for CREATE INDEX CONCURRENTLY</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  disable_ddl_transaction!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># 1. Add the column</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_column </span><span class=\"mtk4\">:pg_search_documents</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:content_vector</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:tsvector</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># 2. Create trigger function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;~SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">CREATE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TRIGGER</span><span class=\"mtk6\"> </span><span class=\"mtk5\">pg_search_documents_content_vector_update</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">BEFORE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">INSERT</span><span class=\"mtk6\"> </span><span class=\"mtk7\">OR</span><span class=\"mtk6\"> </span><span class=\"mtk7\">UPDATE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">ON</span><span class=\"mtk6\"> pg_search_documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      FOR EACH </span><span class=\"mtk7\">ROW</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">EXECUTE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">FUNCTION</span><span class=\"mtk6\"> tsvector_update_trigger(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        content_vector,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        &#39;pg_catalog.english&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        content</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># 3. Create GIN index concurrently to avoid table locking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;~SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">CREATE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">INDEX</span><span class=\"mtk6\"> </span><span class=\"mtk5\">CONCURRENTLY</span><span class=\"mtk6\"> index_pg_search_documents_on_content_vector</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">ON</span><span class=\"mtk6\"> pg_search_documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">USING</span><span class=\"mtk6\"> GIN (content_vector);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Index must be dropped concurrently as well</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;~SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">DROP</span><span class=\"mtk6\"> </span><span class=\"mtk7\">INDEX</span><span class=\"mtk6\"> CONCURRENTLY </span><span class=\"mtk7\">IF</span><span class=\"mtk6\"> </span><span class=\"mtk7\">EXISTS</span><span class=\"mtk6\"> index_pg_search_documents_on_content_vector;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;~SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">DROP</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TRIGGER</span><span class=\"mtk6\"> </span><span class=\"mtk7\">IF</span><span class=\"mtk6\"> </span><span class=\"mtk7\">EXISTS</span><span class=\"mtk6\"> pg_search_documents_content_vector_update</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">ON</span><span class=\"mtk6\"> pg_search_documents;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    remove_column </span><span class=\"mtk4\">:pg_search_documents</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:content_vector</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nRails migrations don't have a DSL for defining database triggers, so this migration uses a small amount of raw SQL. If you're curious about managing SQL-backed schemas in Rails, I've written more about that <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/from-ruby-to-sql-schema/\">here</a>.\n</aside>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Update Configuration</strong></p>\n<p class=\"markdown-para\">By default, <code>pg_search</code> generates a <code>to_tsvector(...)</code> expression inline. We now want it to query our persisted column instead.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/pg_search.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">.</span><span class=\"mtk5\">multisearch_options</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">using:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">tsearch:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">dictionary:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;english&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">tsvector_column:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;content_vector&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk3\"># === NEW ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">prefix:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Then we can rebuild to ensure the new column is populated: <code>PgSearch::Multisearch.rebuild(Recipe)</code></p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Verify Search Table Schema and Contents</strong></p>\n<p class=\"markdown-para\">Let's inspect the table schema now. Adding <code>+</code> to the <code>\\d</code> PostgreSQL meta-command will also display the trigger:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\\d+ pg_search_documents</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                                                       Table &quot;public.pg_search_documents&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     Column      |              Type              | Collation | Nullable |                     Default                     | Storage  | Compression | Stats target | Description</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-----------------+--------------------------------+-----------+----------+-------------------------------------------------+----------+-------------+--------------+-------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> id              | bigint                         |           | not null | nextval(&#39;pg_search_documents_id_seq&#39;::regclass) | plain    |             |              |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> content         | text                           |           |          |                                                 | extended |             |              |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> searchable_type | character varying              |           |          |                                                 | extended |             |              |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> searchable_id   | bigint                         |           |          |                                                 | plain    |             |              |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> created_at      | timestamp(6) without time zone |           | not null |                                                 | plain    |             |              |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> updated_at      | timestamp(6) without time zone |           | not null |                                                 | plain    |             |              |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> content_vector  | tsvector                       |           |          |                                                 | extended |             |              |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;pg_search_documents_pkey&quot; PRIMARY KEY, btree (id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_pg_search_documents_on_content_vector&quot; gin (content_vector)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_pg_search_documents_on_searchable&quot; btree (searchable_type, searchable_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Not-null constraints:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;pg_search_documents_id_not_null&quot; NOT NULL &quot;id&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;pg_search_documents_created_at_not_null&quot; NOT NULL &quot;created_at&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;pg_search_documents_updated_at_not_null&quot; NOT NULL &quot;updated_at&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Triggers:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pg_search_documents_content_vector_update BEFORE INSERT OR UPDATE ON pg_search_documents FOR EACH ROW EXECUTE FUNCTION tsvector_update_trigger(&#39;content_vector&#39;, &#39;pg_catalog.english&#39;, &#39;content&#39;)</span></span></code></pre>\n<p class=\"markdown-para\">Notice the important pieces:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Original <code>content</code> text column still present</li>\n<li class=\"markdown-list-item\">New <code>content_vector</code> column of type <code>tsvector</code></li>\n<li class=\"markdown-list-item\"><code>GIN</code> index on <code>content_vector</code></li>\n<li class=\"markdown-list-item\">Trigger that keeps the vector up to date</li>\n</ul>\n<p class=\"markdown-para\">Let's look at a row in the table to compare <code>content</code> vs <code>content_vector</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\\x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> content, content_vector </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> pg_search_documents </span><span class=\"mtk7\">limit</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- -[ RECORD 1 ]--+-----------------------------------------------</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- content        | Caprese Salad with Bay Leaves #9b1f</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- content_vector | &#39;9b1f&#39;:6 &#39;bay&#39;:4 &#39;capres&#39;:1 &#39;leav&#39;:5 &#39;salad&#39;:2</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>content_vector</code> column contains the tokenized, normalized, and stemmed form of <code>content</code>. This is what PostgreSQL can now search directly, without recomputing it on every query.</p>\n<h2 class=\"markdown-subtitle\" id=\"performance-after-the-fix\" style=\"position:relative;\"><a href=\"#performance-after-the-fix\" aria-label=\"performance after the fix permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Performance After the Fix</h2>\n<p class=\"markdown-para\">With these changes, running <code>PgSearch.multisearch(\"chicken soup\").limit(10)</code> now generates the following query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> pg_search_id,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;content_vector&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;chicken&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;:*&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;soup&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;:*&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">FROM</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;content_vector&quot;</span><span class=\"mtk1\"> @@ (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;chicken&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;:*&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;soup&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;:*&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> pg_search_ce9b9dd18c5c0023f2116f</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk4\">pg_search_ce9b9dd18c5c0023f2116f</span><span class=\"mtk1\">.</span><span class=\"mtk4\">pg_search_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ORDER BY</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">pg_search_ce9b9dd18c5c0023f2116f</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rank</span><span class=\"mtk1\"> </span><span class=\"mtk7\">DESC</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;pg_search_documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">ASC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">LIMIT</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p class=\"markdown-para\">Notice how this time, it's querying the new <code>content_vector</code> column rather than invoking the <code>to_tsvector</code> function to compute it on the fly from the <code>content</code> column.</p>\n<p class=\"markdown-para\">Running this query through EXPLAIN ANALYZE shows performance has improved significantly:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> Limit  (cost=734.10..734.13 rows=10 width=214) (actual time=2.253..2.257 rows=10.00 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   Buffers: shared hit=52</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   -&gt;  Sort  (cost=734.10..734.62 rows=209 width=214) (actual time=2.250..2.252 rows=10.00 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         Sort Key: (ts_rank(pg_search_documents.content_vector, &#39;&#39;&#39;chicken&#39;&#39;:* &amp; &#39;&#39;soup&#39;&#39;:*&#39;::tsquery, 0)) DESC, pg_search_documents.id</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         Sort Method: top-N heapsort  Memory: 31kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         Buffers: shared hit=52</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         -&gt;  Bitmap Heap Scan on pg_search_documents  (cost=35.26..729.59 rows=209 width=214) (actual time=2.067..2.213 rows=39.00 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               Recheck Cond: (content_vector @@ &#39;&#39;&#39;chicken&#39;&#39;:* &amp; &#39;&#39;soup&#39;&#39;:*&#39;::tsquery)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               Heap Blocks: exact=39</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               Buffers: shared hit=52</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               -&gt;  Bitmap Index Scan on index_pg_search_documents_on_content_vector  (cost=0.00..35.21 rows=209 width=0) (actual time=2.022..2.022 rows=39.00 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Index Cond: (content_vector @@ &#39;&#39;&#39;chicken&#39;&#39;:* &amp; &#39;&#39;soup&#39;&#39;:*&#39;::tsquery)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Index Searches: 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Buffers: shared hit=13</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Planning:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   Buffers: shared hit=1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Planning Time: 0.542 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Execution Time: 2.409 ms</span></span></code></pre>\n<p class=\"markdown-para\">The query went from ~283ms to ~2.4ms, which is a ~118Ã— speedup (~99% reduction in runtime). This improvement is a fundamental change in how PostgreSQL can execute the query.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Before the fix</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">PostgreSQL had to run <code>to_tsvector('english', content)</code> for every row at query time.</li>\n<li class=\"markdown-list-item\">Because the expression was computed on the fly, PostgreSQL could not use an index.</li>\n<li class=\"markdown-list-item\">The planner was forced into a parallel sequential scan over ~100k rows.</li>\n<li class=\"markdown-list-item\">Full-text ranking (<code>ts_rank</code>) was evaluated for many rows that would ultimately be discarded.</li>\n<li class=\"markdown-list-item\">Total work scaled linearly with table size.</li>\n</ul>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">After the fix</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">PostgreSQL can use the GIN index on <code>content_vector</code> instead of computing <code>to_tsvector</code> at query time.</li>\n<li class=\"markdown-list-item\">The planner performs a bitmap index scan rather than a sequential scan.</li>\n<li class=\"markdown-list-item\">Only rows matching the tsquery are visited (39 heap rows).</li>\n<li class=\"markdown-list-item\"><code>ts_rank</code> is computed only for rows that already matched the query.</li>\n<li class=\"markdown-list-item\">Sorting is limited to a top-N heapsort for the requested limit.</li>\n<li class=\"markdown-list-item\">Total work now scales with the number of matches, not the total table size.</li>\n</ul>\n<h2 class=\"markdown-subtitle\" id=\"lesson-learned\" style=\"position:relative;\"><a href=\"#lesson-learned\" aria-label=\"lesson learned permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lesson Learned</h2>\n<p class=\"markdown-para\">For significant volumes, don't compute tsvectors at query time. Persist them in a dedicated column, index with a GIN index, and configure <code>pg_search</code> to use it. The speedup can be dramatic, even on relatively modest datasets.</p>\n<p class=\"markdown-para\">The Rails ecosystem and its gems makes it incredibly easy to unlock complex functionality with just a few lines of code, and that ease can feel like a superpower. But it also makes it tempting to stop reading once things \"work\". Performance-critical details could be mentioned later in the README, and they tend to matter only once you hit real data.</p>\n<p class=\"markdown-para\">When integrating gems into a project, taking the time to read beyond the quick start pays off. The nuances are usually there, clearly explained, just not always at the top. Understanding these early can save you from surprises as your application scales.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":12,"tableOfContents":"<ul>\n<li><a href=\"#a-simplified-example\">A Simplified Example</a></li>\n<li><a href=\"#setup-search\">Setup Search</a></li>\n<li><a href=\"#usage\">Usage</a></li>\n<li><a href=\"#on-the-fly-tsvectors\">On-The-Fly TSVectors</a></li>\n<li><a href=\"#persist-tsvectors\">Persist TSVectors</a></li>\n<li><a href=\"#performance-after-the-fix\">Performance After the Fix</a></li>\n<li><a href=\"#lesson-learned\">Lesson Learned</a></li>\n</ul>","frontmatter":{"title":"Speeding Up PostgreSQL Full-Text Search with Persistent TSVectors","date":"03 Feb 2026","description":"Learn how to dramatically speed up PostgreSQL full-text search by persisting TSVectors and using GIN indexes in Rails apps.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/bdcbd21ee90d7ba29746eefac5c8a9e3/fd980/speed-up-pg-fts-ts-vectpr-charles-etoroma-jC5blC1BZ0U-unsplash.jpg","srcSet":"/static/bdcbd21ee90d7ba29746eefac5c8a9e3/00be4/speed-up-pg-fts-ts-vectpr-charles-etoroma-jC5blC1BZ0U-unsplash.jpg 225w,\n/static/bdcbd21ee90d7ba29746eefac5c8a9e3/66ebe/speed-up-pg-fts-ts-vectpr-charles-etoroma-jC5blC1BZ0U-unsplash.jpg 450w,\n/static/bdcbd21ee90d7ba29746eefac5c8a9e3/fd980/speed-up-pg-fts-ts-vectpr-charles-etoroma-jC5blC1BZ0U-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/bdcbd21ee90d7ba29746eefac5c8a9e3/c5403/speed-up-pg-fts-ts-vectpr-charles-etoroma-jC5blC1BZ0U-unsplash.webp 225w,\n/static/bdcbd21ee90d7ba29746eefac5c8a9e3/edfe1/speed-up-pg-fts-ts-vectpr-charles-etoroma-jC5blC1BZ0U-unsplash.webp 450w,\n/static/bdcbd21ee90d7ba29746eefac5c8a9e3/b19f4/speed-up-pg-fts-ts-vectpr-charles-etoroma-jC5blC1BZ0U-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":675}}}},"fields":{"slug":"/blog/speed-up-pg-fts-with-persistent-ts-vectors/"}},"relatedP":{"edges":[{"node":{"id":"3f4b8a80-3987-568c-8ec3-fa02309415ce","frontmatter":{"title":"Switching From Ruby to SQL Schema in Rails","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/9d190206675d13a69a6a413d56068642/26528/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.jpg","srcSet":"/static/9d190206675d13a69a6a413d56068642/26528/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.jpg 300w,\n/static/9d190206675d13a69a6a413d56068642/43429/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/9d190206675d13a69a6a413d56068642/5d6c3/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.webp 300w,\n/static/9d190206675d13a69a6a413d56068642/68dbc/from-ruby-to-sql-schema-marek-studzinski--RDBDQuGF9k-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/from-ruby-to-sql-schema/"}}},{"node":{"id":"96b087a4-28a9-51a7-ad22-48dc6787757b","frontmatter":{"title":"Efficient Database Queries in Rails: A Practical Approach","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#083858","images":{"fallback":{"src":"/static/456c5a98a74fd815a1cf5c800f73abc1/26528/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg","srcSet":"/static/456c5a98a74fd815a1cf5c800f73abc1/26528/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg 300w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/43429/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/456c5a98a74fd815a1cf5c800f73abc1/5d6c3/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.webp 300w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/68dbc/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-query-perf/"}}},{"node":{"id":"bb0af7b8-9d5f-597f-90cb-a4da75c3c9a9","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search Engine","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#d8c8a8","images":{"fallback":{"src":"/static/86310660995a38a9254ece85739c237f/26528/roll-search-3.jpg","srcSet":"/static/86310660995a38a9254ece85739c237f/26528/roll-search-3.jpg 300w,\n/static/86310660995a38a9254ece85739c237f/43429/roll-search-3.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/86310660995a38a9254ece85739c237f/5d6c3/roll-search-3.webp 300w,\n/static/86310660995a38a9254ece85739c237f/68dbc/roll-search-3.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part3/"}}}]}},"pageContext":{"slug":"/blog/speed-up-pg-fts-with-persistent-ts-vectors/","relatedPosts":["Efficient Database Queries in Rails: A Practical Approach","Roll Your Own Search with Rails and Postgres: Search Engine","Switching From Ruby to SQL Schema in Rails"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}