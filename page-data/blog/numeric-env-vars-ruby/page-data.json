{"componentChunkName":"component---src-templates-post-js","path":"/blog/numeric-env-vars-ruby/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">This post will explain how to avoid a common pitfall with numeric environment variable handling in Ruby.</p>\n<p class=\"markdown-para\">I recently encountered an error when running some code that calls a third party API to fetch data. This code uses the Quickbooks Ruby gem to fetch accounting data for a financial services application. According to the gem <a href=\"https://github.com/ruckus/quickbooks-ruby?tab=readme-ov-file#querying-in-batches\" class=\"markdown-link\">documentation</a>, usage is as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># or specify a custom query</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">query_in_batches</span><span class=\"mtk1\">(query, </span><span class=\"mtk4\">per_page:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1000</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |batch|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  batch.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |customer|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with customer...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The idea with splitting up the result in batches is similar to <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Batches.html\" class=\"markdown-link\">Active Record Batches</a> in Rails, to avoid loading a very large collection into memory all at once. With this API, the <code>per_page</code> option is used to control the batch size.</p>\n<h2 class=\"markdown-subtitle\" id=\"the-bug\" style=\"position:relative;\"><a href=\"#the-bug\" aria-label=\"the bug permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Bug</h2>\n<p class=\"markdown-para\">When I was attempting to run the application code that calls this API from my laptop, it was returning this error message:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"xml\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">------ QUICKBOOKS-RUBY RESPONSE ------</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">RESPONSE CODE = 400</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">RESPONSE BODY:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;?</span><span class=\"mtk7\">xml</span><span class=\"mtk5\"> version</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;1.0&quot;</span><span class=\"mtk5\"> encoding</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;UTF-8&quot;</span><span class=\"mtk5\"> standalone</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;yes&quot;</span><span class=\"mtk1\">?&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">IntuitResponse</span><span class=\"mtk1\"> </span><span class=\"mtk5\">xmlns</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;http://schema.intuit.com/finance/v3&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">time</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;2024-07-22T12:17:49&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">Fault</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;ValidationFault&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">Error</span><span class=\"mtk1\"> </span><span class=\"mtk5\">code</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;4001&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">Message</span><span class=\"mtk1\">&gt;Invalid query&lt;/</span><span class=\"mtk7\">Message</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">Detail</span><span class=\"mtk1\">&gt;QueryValidationError: value 0 is too small. Min allowed value is 1&lt;/</span><span class=\"mtk7\">Detail</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">Error</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">Fault</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">IntuitResponse</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Which was surprising as this code had been running in production for many years without errors. The stack trace pointed to this part of the application code that calls the API:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">query_in_batches</span><span class=\"mtk1\">(query, </span><span class=\"mtk4\">per_page:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Settings</span><span class=\"mtk1\">.</span><span class=\"mtk5\">batch_size</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |batch|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">So rather than a hard-coded default value of <code>1000</code> as per the example in the gem documentation, some custom configuration code <code>Settings.batch_size</code> was being called. Here is the relevant snippet of the <code>Settings</code> class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Settings</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.batch_size</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ENV[</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">to_i</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other settings...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">A cursory glance at the implementation of <code>Settings.batch_size</code> suggests the intention is to use the value of the <code>BATCH_SIZE</code> environment variable if it's set, otherwise, use the fallback value of <code>1000</code> with the following logic:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Read in the <code>BATCH_SIZE</code> environment variable.</li>\n<li class=\"markdown-list-item\">Convert the <code>BATCH_SIZE</code> environment variable to an integer (because <em class=\"markdown-emphasis\">all</em> environment variables read in are strings).</li>\n<li class=\"markdown-list-item\">If <code>BATCH_SIZE</code> is defined in the environment, use it, otherwise, use a default batch size of <code>1000</code>.</li>\n</ul>\n<p class=\"markdown-para\">However, the error message was indicating that a <code>0</code> batch size had been specified, which is invalid:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"xml\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">Detail</span><span class=\"mtk1\">&gt;QueryValidationError: value 0 is too small. Min allowed value is 1&lt;/</span><span class=\"mtk7\">Detail</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">How could this have happened?</p>\n<h2 class=\"markdown-subtitle\" id=\"investigation\" style=\"position:relative;\"><a href=\"#investigation\" aria-label=\"investigation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Investigation</h2>\n<p class=\"markdown-para\">When code is working in production but not locally, different configuration could be the culprit. I started by checking the value of the <code>BATCH_SIZE</code> environment variable in the production environment where this code was working:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># in a production shell</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">echo</span><span class=\"mtk1\"> $BATCH_SIZE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 300</span></span></span></code></pre>\n<p class=\"markdown-para\">When this project runs locally, it uses the <a href=\"https://github.com/bkeepers/dotenv\" class=\"markdown-link\">dotenv</a> gem to load environment variables from a <code>.env</code> file in the project root. Inspecting this file revealed that <code>BATCH_SIZE</code> was nowhere to be found in this file, i.e. it was not set. According to the <code>Settings.batch_size</code> implementation, it should have been fine for <code>BATCH_SIZE</code> to not be specified, in which case, it should have defaulted to a batch size of 1000. But instead, the <code>batch_size</code> method was returning 0.</p>\n<p class=\"markdown-para\">To understand why this was the case, I launched a local <a href=\"https://rubyreferences.github.io/rubyref/intro/irb.html\" class=\"markdown-link\">irb console</a> with the <code>BATCH_SIZE</code> environment variable set to <code>300</code> as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">BATCH_SIZE=300 irb</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nAlthough this bug arose within a Rails project, the cause has to do solely with Ruby methods, so an irb console rather than a Rails console can be used to demonstrate it.\n</aside>\n<p class=\"markdown-para\">Then ran some experimental code to break down each part of the expression <code>ENV[\"BATCH_SIZE\"].to_i || 1000</code> to understand the behaviour:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Fetch `BATCH_SIZE` environment variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; &quot;300&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Notice it gets read in as a String even though</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># the value is numeric</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; String</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Convert batch size env var to an integer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">to_i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 300</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This returns the env var value because its</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># populated (truthy), rather than the default of 1000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">to_i</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 300</span></span></span></code></pre>\n<p class=\"markdown-para\">So far so good, when the <code>BATCH_SIZE</code> environment variable is populated, then this code <code>ENV[\"BATCH_SIZE\"].to_i || 1000</code> behaves as per the intention.</p>\n<p class=\"markdown-para\">Next, I ran another irb console, this time just <code>irb</code>, i.e. to simulate an environment where <code>BATCH_SIZE</code> is not set:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Fetch `BATCH_SIZE` environment variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This time it returns nil because its not set</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># When not set, the env var is of type NilClass</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; NilClass</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># What happens when `nil` is converted to an integer?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># It returns 0!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">to_i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># What happens when evaluating 0 OR something?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># It returns 0!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">to_i</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 0</span></span></span></code></pre>\n<p class=\"markdown-para\">The code in the above irb session demonstrates the problem. Despite the intention of the <code>Settings</code> method to return <code>1000</code> when the <code>BATCH_SIZE</code> environment variable isn't set, what actually happens is that it returns <code>0</code>. This then gets passed on to the third party API as the value of batch size, which raises an error because <code>0</code> is an invalid value for batching the response.</p>\n<h2 class=\"markdown-subtitle\" id=\"root-cause\" style=\"position:relative;\"><a href=\"#root-cause\" aria-label=\"root cause permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Root Cause</h2>\n<p class=\"markdown-para\">There are several points to understand about why a <code>0</code> is being returned when the requested environment variable isn't set:</p>\n<p class=\"markdown-para\">Running <code>to_i</code> on <code>nil</code> always returns <code>0</code> in Ruby. This means the result of <code>ENV[\"ANYTHING_THATS_NOT_SET\"].to_i</code> will be <code>0</code>. See the Ruby docs on <a href=\"https://docs.ruby-lang.org/en/3.2/NilClass.html#method-i-to_i\" class=\"markdown-link\">NilClass#to_i</a>.</p>\n<p class=\"markdown-para\">The result of <code>0 || 1000</code> is <code>0</code>, not <code>1000</code> as some might expect coming from other languages. The first part of this is to understand that <a href=\"https://docs.ruby-lang.org/en/master/syntax/operators_rdoc.html#label-7C-7C-2C+or\" class=\"markdown-link\">||</a> is a short circuit operator that returns the result of the first expression that is truthy.</p>\n<p class=\"markdown-para\">Since the <code>||</code> OR operator is returning 0, this must mean that <code>0</code> is truthy in Ruby! This might be surprising to those coming to Ruby from other languages such as Python or JavaScript where <code>0</code> is considered falsey. According to the Ruby docs on <a href=\"https://ruby-doc.org/core-2.2.3/doc/syntax/literals_rdoc.html#label-Booleans+and+nil\" class=\"markdown-link\">booleans and nil</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">nil and false are both false values. nil is sometimes used to indicate “no value” or “unknown” but evaluates to false in conditional expressions. true is a true value. All objects except nil and false evaluate to a true value in conditional expressions.</p>\n</blockquote>\n<p class=\"markdown-para\">The key phrase is \"<strong class=\"markdown-strong\">All objects except nil and false evaluate to a true value in conditional expressions</strong>\". Since <code>0</code> is not <code>nil</code> or <code>false</code>, it evaluates to <code>true</code> in conditional expressions such as <code>||</code>. Further, since it occurs on the left hand side of the short circuit OR in the <code>Settings</code> code, as in <code>0 || 1000</code>, it means <code>0</code> is the first truthy value and returned.</p>\n<aside class=\"markdown-aside\">\nThis Stack Overflow post contains further discussion on <a class=\"markdown-link\" href=\"https://stackoverflow.com/questions/10387515/why-treat-0-as-true-in-ruby\">why 0 is treated as truthy in Ruby</a>.\n</aside>\n<p class=\"markdown-para\">To summarize, the problem is caused by a combination of the following factors:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Calling <code>to_i</code> on <code>nil</code> returns <code>0</code>.</li>\n<li class=\"markdown-list-item\"><code>0</code> is considered a truthy value and evaluates to <code>true</code> when used in conditional expressions.</li>\n</ol>\n<h2 class=\"markdown-subtitle\" id=\"solution\" style=\"position:relative;\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h2>\n<p class=\"markdown-para\">The solution is to use the <a href=\"https://docs.ruby-lang.org/en/3.2/ENV.html#method-c-fetch\" class=\"markdown-link\">ENV.fetch</a> method when accessing an environment variable that might not be set, rather than accessing <code>ENV</code> with <code>[]</code>. The <code>fetch</code> method accepts an optional default value, which will be returned if the requested environment variable isn't set. Since the original intent of the code is to use a fallback value of <code>1000</code> when the <code>BATCH_SIZE</code> environment variable isn't set, the <code>fetch</code> method is exactly what's needed here.</p>\n<p class=\"markdown-para\">It still requires the use of <code>to_i</code> because if the environment variable is set, then it will still be retrieved as a string. If it's not set, then the numeric default of <code>1000</code> will be returned, but there's no harm in calling <code>to_i</code> on it as that will still return an integer:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Settings</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.batch_size</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">ENV</span><span class=\"mtk1\">.</span><span class=\"mtk5\">fetch</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;BATCH_SIZE&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1000</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to_i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With the above code in place, if the <code>BATCH_SIZE</code> environment variable is set, it will be returned as an integer, otherwise <code>1000</code>  will be returned.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post highlighted a potential bug that can result when working with numeric environment variables in Ruby, and how use of the <code>ENV.fetch</code> method can be used to more accurately express the intention of using a fallback value.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":5,"tableOfContents":"<ul>\n<li><a href=\"#the-bug\">The Bug</a></li>\n<li><a href=\"#investigation\">Investigation</a></li>\n<li><a href=\"#root-cause\">Root Cause</a></li>\n<li><a href=\"#solution\">Solution</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>","frontmatter":{"title":"Avoid this Bug with Numeric Environment Variables in Ruby","date":"01 Sep 2024","description":"Learn how to avoid a common pitfall when handling numeric environment variables in Ruby, safeguarding against unexpected behavior even when values are unset or unexpected.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#081808","images":{"fallback":{"src":"/static/a5030576f366ed3047c5a888d74cd1af/d730f/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.jpg","srcSet":"/static/a5030576f366ed3047c5a888d74cd1af/b834a/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.jpg 225w,\n/static/a5030576f366ed3047c5a888d74cd1af/21c52/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.jpg 450w,\n/static/a5030576f366ed3047c5a888d74cd1af/d730f/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/a5030576f366ed3047c5a888d74cd1af/71a10/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.webp 225w,\n/static/a5030576f366ed3047c5a888d74cd1af/901f1/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.webp 450w,\n/static/a5030576f366ed3047c5a888d74cd1af/5acd1/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":599}}}},"fields":{"slug":"/blog/numeric-env-vars-ruby/"}},"relatedP":{"edges":[{"node":{"id":"df308377-3f0e-5aae-8cce-4e9377304daa","frontmatter":{"title":"Solving a Python Interview Question in Ruby","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/41cac534f5048f26531ee516516637b1/26528/python-interview-question.jpg","srcSet":"/static/41cac534f5048f26531ee516516637b1/26528/python-interview-question.jpg 300w,\n/static/41cac534f5048f26531ee516516637b1/43429/python-interview-question.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/41cac534f5048f26531ee516516637b1/5d6c3/python-interview-question.webp 300w,\n/static/41cac534f5048f26531ee516516637b1/68dbc/python-interview-question.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/python-interview-question-in-ruby/"}}},{"node":{"id":"4d925f9d-dbf8-54d9-a7d8-139976793723","frontmatter":{"title":"Use Ruby to Parse Command Line Output","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/cfc1759ec375fe9d6af3555b984aae72/26528/chain-ruby-one-liners-karine-avetisyan-ipuiM-36tAg-unsplash.jpg","srcSet":"/static/cfc1759ec375fe9d6af3555b984aae72/26528/chain-ruby-one-liners-karine-avetisyan-ipuiM-36tAg-unsplash.jpg 300w,\n/static/cfc1759ec375fe9d6af3555b984aae72/43429/chain-ruby-one-liners-karine-avetisyan-ipuiM-36tAg-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/cfc1759ec375fe9d6af3555b984aae72/5d6c3/chain-ruby-one-liners-karine-avetisyan-ipuiM-36tAg-unsplash.webp 300w,\n/static/cfc1759ec375fe9d6af3555b984aae72/68dbc/chain-ruby-one-liners-karine-avetisyan-ipuiM-36tAg-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/ruby-parse-cli-output/"}}},{"node":{"id":"0e7236cf-2fc2-557b-a4f8-2c70b70c12c9","frontmatter":{"title":"Configurable Retry with Ruby","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/1505a386aa3e6bf13bf5d66c2acb57e5/26528/ruby-retry-mod-brett-jordan--dChkgNLmp4-unsplash.jpg","srcSet":"/static/1505a386aa3e6bf13bf5d66c2acb57e5/26528/ruby-retry-mod-brett-jordan--dChkgNLmp4-unsplash.jpg 300w,\n/static/1505a386aa3e6bf13bf5d66c2acb57e5/43429/ruby-retry-mod-brett-jordan--dChkgNLmp4-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/1505a386aa3e6bf13bf5d66c2acb57e5/5d6c3/ruby-retry-mod-brett-jordan--dChkgNLmp4-unsplash.webp 300w,\n/static/1505a386aa3e6bf13bf5d66c2acb57e5/68dbc/ruby-retry-mod-brett-jordan--dChkgNLmp4-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/ruby-configurable-retry/"}}}]}},"pageContext":{"slug":"/blog/numeric-env-vars-ruby/","relatedPosts":["Configurable Retry with Ruby","Use Ruby to Parse Command Line Output","Solving a Python Interview Question in Ruby"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}