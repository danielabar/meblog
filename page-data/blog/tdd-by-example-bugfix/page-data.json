{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/tdd-by-example-bugfix/",
    "result": {"data":{"markdownRemark":{"html":"<p>This post will demonstrate an example of using TDD (test driven development) to fix a bug on an existing project. If you're not familiar with TDD, see an <a href=\"/blog/tdd-by-example/\">earlier post</a> I wrote on this topic.</p>\n<h2>Discovering the Problem</h2>\n<p>Last month when running my monthly expense report with <a href=\"https://github.com/danielabar/tidysum\">Tidysum</a> (a Node.js command line program I wrote that processes a csv list of daily expenses and outputs a summary json with year and month breakdowns of expenses by category, and makes savings/spending recommendations and calculates a personal rate of inflation), it seemed to be under-reporting April's spending by roughly $200. Although my spending has been lower during Covid times because, you know, there's nothing to do, nevertheless the total amount for April seemed unusually low.</p>\n<p>Digging into the input <code>expenses.csv</code> file, I found the issue - notice the second line in this snip from the file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-11,131.32,Groceries,Metro</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04,24,194.87,Groceries,Metro &lt;-- BUG HANDLING THIS LINE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-25,20.00,Gas,Shell</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<p>The expected format for the input csv is: <code>date in YYYY-MM-DD format,numeric spending amount,category,store</code>. However, the second line has a typo in the date, there's a <code>,</code> where the second <code>-</code> should be. But, <code>2021-04</code> is a valid date. So what the program did is take the first field <code>2021-04</code> as the date, then the second \"field\", which was really the date portion of <code>24</code> as the amount field, then the amount field of <code>194.87</code> which was now the third field got tracked as a category, and the actual category <code>Groceries</code> was now the fourth field and got tracked as the store. The final field <code>Metro</code> which is the actual store ended up in the fifth position and was ignored entirely. This is how the spending of <code>$194.87</code> got incorrectly recorded as <code>$24.00</code> and that's how total spending for April was under-reported.</p>\n<p>Normally when a developer discovers a bug in their code, there's an instinct to dive in, figure out what's wrong and fix it as quickly as possible. But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven't actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass.</p>\n<p>The benefit of this approach is it forces you to first think about how the code should behave under the bug circumstances by documenting it in a test. Then having the test ensures that this bug will never creep into your code again.</p>\n<p>So first things first, let's figure out where in the code this problem with processing potentially invalid data occurs.</p>\n<p><strong>Aside:</strong> Some of you may be wondering why write a custom program for expense tracking when there's Excel and countless free apps out there, a <a href=\"https://github.com/danielabar/tidysum#why-not-use-excel\">short explanation here</a>.</p>\n<h2>Analysis</h2>\n<p>Looking at the code, I realized there was no validation of the input file. It's read in via a csv stream library and processed one line at a time, assuming each line is in the expected format. Here's the relevant code starting from the command line entrypoint:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// index.js (entrypoint)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expense </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./lib/expense&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Left out some code for brevity - that grabs the command line arguments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// including `argv.e` which is path to expense file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk7\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> expense.</span><span class=\"mtk5\">process</span><span class=\"mtk1\">(argv.e);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  fs.</span><span class=\"mtk5\">writeFileSync</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;expenses.json&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9\">JSON</span><span class=\"mtk1\">.</span><span class=\"mtk9\">stringify</span><span class=\"mtk1\">(result, </span><span class=\"mtk4\">null</span><span class=\"mtk1\">, </span><span class=\"mtk4\">2</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})();</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/expense.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// No validation, inputFile is passed as is to processFile function.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// csv-streamify exposes the data as an array of values from csv line</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// eg: 2020-04-29,194.23,Groceries,Metro turns into:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// [&#39;2020-04-29&#39;, &#39;194.23&#39;, &#39;Groceries&#39;, &#39;Metro&#39;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">processLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use destructuring assignment to unpack values out of array that csv-streamify generated from line in csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> [dateStr, amountStr, category, merchant] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> line;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">processEntry</span><span class=\"mtk1\">({ dateStr, amountStr, category, merchant }, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processEntry</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">data</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Begin calculations...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The critical part is this line that uses <code>csv-streamify</code> to stream in the csv file one line at a time:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>At this point, <code>line</code> is an array of values from the line in the csv file that was just read. There will be one entry in the array for each value in the csv line. Then this array <code>line</code> gets passed to the <code>processLine</code> function which uses <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment\">destructuring assignment</a> to unpack the values in the <code>line</code> array into individual values:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use destructuring assignment to unpack values out of array that csv-streamify generated from line in csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> [dateStr, amountStr, category, merchant] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> line;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This is where the bug occurs because if the csv line had a comma instead of an expected dash in date such as <code>2021-04,24,194.87,Groceries,Metro</code>, then the variables will be assigned as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;24&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;194.87&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dateStr </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2021-04&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">amountStr </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;24&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">category </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;194.87&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">merchant </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Groceries&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Metro is ignored</span></span></span></code></pre>\n<h2>Define Expectations</h2>\n<p>Now that the analysis has revealed how the bug occurs, the next step is to determine how the program <em>should</em> behave when given invalid data. This \"should\" behaviour will then get encoded into a test.</p>\n<p>If this was a work project, the decision as to how the program should behave usually goes to the product manager/owner. But in this case, it's a side project which makes me the product owner so I need to decide. Given that this is a financial application, it doesn't make sense to perform <em>any</em> calculation if even a single record is invalid. This is because all the numbers get added, averaged, and compared. So even one number being off could throw off all the results.</p>\n<p>What this means is that there should be a validation step <em>before</em> the file is processed for calculation. This validation should read in all lines of the file and for each line, check that it has exactly 4 fields. Any more or less is a sign that the data is probably incorrect. There's other things that could be validated like the date format and numeric spending amount, but will get to that later. It's easier to start with just a single validation and then add in more.</p>\n<p>As the program finds invalid lines, it should accumulate these. For each invalid line it should record all the things that are wrong with it. For now there will only be one thing its checking (number of values), but there could be more.</p>\n<p>Then before the program goes into the calculation step, it should check if any validation errors occurred, stop and return these instead of going into the calculation step.</p>\n<h2>Write a Failing Test</h2>\n<p>Since the bug can be observed from the results of the <code>process</code> function in <code>lib/expense.js</code>, I will start with writing a test for this function. The test will provide an invalid input file to the <code>process</code> function, and expects some validation errors returned instead of the usual calculations that <code>process</code> would return.</p>\n<p>It's very likely that the validation implementation won't go in the <code>process</code> function itself because the <code>lib/expense.js</code> module is about calculating expenses. Keeping with the <a href=\"https://en.wikipedia.org/wiki/Single-responsibility_principle\">single responsibility principle</a>, the actual validation will be performed by another module, and <code>process</code> will just call out to it before proceeding with calculation. However, I don't want to get into any implementation details before having at least one failing test in place, and since I can see the buggy behaviour from <code>process</code>, this is where I'm starting with a (failing) test.</p>\n<p>This project uses the <a href=\"https://mochajs.org/\">Mocha</a> testing library with <a href=\"https://www.chaijs.com/\">Chai</a> expect-style assertions, but the same TDD principles would apply to any test framework/library.</p>\n<p>The <code>process</code> function is asynchronous because it reads in a file, so the test will also be asynchronous. As for the input file for the test, this project already has a <code>test/fixtures</code> directory, so will first write an <code>invalid-data.csv</code> test file and place it in the fixtures directory:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// test/fixtures/invalid-data.csv</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04,29,194.32,Groceries,Metro</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-30,45.87,Electronics</span></span></code></pre>\n<p>This input file has two invalid lines. The first one has 5 fields and the second one has 3 fields. Recall the expectation is each line should have exactly 4 fields. The first line has an additional problem that the date format is incorrect, but for now we're only interested in the \"number of fields\" validation.</p>\n<p>The test will pass the invalid file from the <code>test/fixtures</code> directory to the <code>process</code> function, then define an expected result object containing the line errors, then use chai's <code>deep.equal</code> assertion to verify that the actual result returned from <code>process</code> matches the expected result.</p>\n<p>Where does the expected result object come from? That's my requirements that I decided on what would be a nice easy way to show the errors to the user. Remember, this isn't implemented yet, the test is how you can express the thought - \"I wish the program worked like this\"...</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/expense.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expense </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/expense&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;processExpenses&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;process&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Contains validation errors&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> expense.</span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">process.</span><span class=\"mtk9\">cwd</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span><span class=\"mtk6\">/test/fixtures/invalid-data.csv`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        hasErrors: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04,29,194.32,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 5.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-30,45.87,Electronics&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedResult);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Doesn&#39;t process year results from file due to validation errors</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).not.to.have.any.</span><span class=\"mtk5\">keys</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;2021&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Run <code>npm test</code> in a terminal to run the tests, and as expected, this new test fails because validation has not yet been implemented.</p>\n<p>You can see the bug in action here because the code is attempting to run calculations on invalid data. There's a category of <code>194.32</code> due to the date parsing error on the first invalid line. Also there's a Merchant of <code>undefined</code> which comes from the second invalid line that only has 3 fields (missing Merchant field). And the total spending is incorrect, it should be <code>194.32</code> + <code>45.87</code> = <code>240.19</code> (the intended amounts from input data if it were valid), but instead the total is <code>29</code> (from incorrectly parsed date in ine 1) + <code>45.87</code> = <code>74.87</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6b0b734a2ffb50eac107906c4cb08ac4/ef6b9/tdd-bug-fail-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 117.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAACEUlEQVQ4y51VW3LbMAz0LRpbFAmAIClaDztN049Op/e/1XZIWrHTJhPZH2sQsrRcPAjufI5wUUGisCToHb/BWHrnb8FumRa8fP+BaTmD2KMzFl3vrmR3kJZvdhISfv3+g/n0jDyfkMYZx3kB+YDOEozjaj+DubFVITvCoIqsikkUsyhyAQuSY6hjJGIMxNVfkan9HxzjSAK/KrTiYY4JRj2SJZQNSpi2wPGncB+sGyEJJieIlrC/kf8IashFjTjGK3u8sNTQ6LLjvRVuCi9OycOZGmHJh3+0bVbCMwt+sq+E8Z8+vId4Zy3D9oTRMk6leq4R2kcVGmJ0SwY9j+hzAgdtSV5VurY2lyY3XxKyoEsB+yWjGyK6m9NRFd7AbDg5lbB2+zTgcD7CxIDumCq58f6NaLtCElivOKSAQ1QcxoQuR3Q5NeLijwOM+G2EvWV4ktqHMwm4FGRt1EdCXqt5uiGdSGqzXwtzR8jlx1Frl2TbwfeW4W6O01aylkMRlMLYaYAZB1gW9N6jPK8v9dvDvVaZBN+mAU9LxlOxc8Z+HHAoxYmhbrhdYZl5ohi8RxaPFAKiKlQVEhQUFB3dEXJ5MRLXEVbyeHQMtg1k6V0ut9w3bcCyYN+7NxwsNfTuOub7/2ef+WCznWMPHxLEB2ixGuu6WH/x+eKXm/FrhSTQmOrHGocKH2IlWJ+vaOTtyv2M8C/j1JRuPQSd4wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 1\"\n        title=\"tdd bug fail 1\"\n        src=\"/static/6b0b734a2ffb50eac107906c4cb08ac4/5a190/tdd-bug-fail-1.png\"\n        srcset=\"/static/6b0b734a2ffb50eac107906c4cb08ac4/772e8/tdd-bug-fail-1.png 200w,\n/static/6b0b734a2ffb50eac107906c4cb08ac4/e17e5/tdd-bug-fail-1.png 400w,\n/static/6b0b734a2ffb50eac107906c4cb08ac4/5a190/tdd-bug-fail-1.png 800w,\n/static/6b0b734a2ffb50eac107906c4cb08ac4/ef6b9/tdd-bug-fail-1.png 832w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Make the Test Pass</h2>\n<p>Finally, it's time to implement some validation!</p>\n<p>Looking again at the <code>process</code> function, it needs to read the entire file for validation purposes <em>before</em> going into the calculations, and if any validation errors are found, return them instead of going on to perform calculations. Since I know the actual validation logic doesn't belong here, I will introduce a new <code>validator</code> module and call out to it. Will get to writing this shortly. Since reading a file is an asynchronous operation in Node.js, the function to be exposed by the validator module must also be asynchronous.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/expense.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// NEW MODULE (not written yet)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEW CODE ADDED HERE: Call validator module to process file, if any errors, return immediately</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validationResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> validator.</span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (validationResult.hasErrors) </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> validationResult;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Since some implementation code has been added, <code>npm test</code> to run tests again. Not surprisingly, the expense test fails because the new <code>validator</code> module cannot be found:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 542px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/419af29638021620f798a0348fff7898/c0388/tdd-bug-fail-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.500000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABDUlEQVQY01WQ6XLCMAyE8xwtN5QCIeFqyOH4dgLv/0Lb0ZbpDD92ZNnSJ62zY3nGZruDxH1eIC9Knm/Vnflqs0V5vuJy/UFRnjFbrDCZLajpfPkmucuGxxN120Fpg15bQr73OY7FCdvdgcDd4Yi8ODHOl+v/ZtHndP4Gz1ql4XyEjwkhDmi6Hk2rOORW1VDa8q6qW0bjPJpO4XKrsFx/UYvVhuCPyQxZdW/gQkRIA2IaefZxgA8JXa8Rh5GDRNo4WBdYN4xPOhJnIvkWcZbVTUcIG9MIYz2MC2xsVU+4OJCB5gWT3IXEeoFJb6c0v4kbSiE3C4lAgYm1+2uYFYD/i9zUOlgfCO2NZZ28yZa/ITzDCvdjpYQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 2\"\n        title=\"tdd bug fail 2\"\n        src=\"/static/419af29638021620f798a0348fff7898/c0388/tdd-bug-fail-2.png\"\n        srcset=\"/static/419af29638021620f798a0348fff7898/772e8/tdd-bug-fail-2.png 200w,\n/static/419af29638021620f798a0348fff7898/e17e5/tdd-bug-fail-2.png 400w,\n/static/419af29638021620f798a0348fff7898/c0388/tdd-bug-fail-2.png 542w\"\n        sizes=\"(max-width: 542px) 100vw, 542px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>To fix this, need to add the validator module and expose a <code>processFile</code> function:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// TODO: Stream in csv file and validate each line</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This time when running the tests, get a failure about being unable to read property <code>hasErrors</code> of undefined, which makes sense since the <code>processFile</code> function of the <code>validator</code> module doesn't return anything yet:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 558px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c46b4eda546cf6ed38975ce6d2e1898c/42a8d/tdd-bug-fail-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGklEQVQoz5WR60oDMRCF9zW2l1wnM0m6pe12exGpov0hvv8DHUlMoWBB/fFxJnM5GZJulhh9FvSJYYnhibHUFgtlqv6XjiUgrwQxC5TzMI6w0I/N/nJJJ8RgR2BL8CTwQaCtfzz8i2GZ6WQ14OX9iuvHJy6vbxgPJ5BE9AuF2VKjb5TmubaYK1Pjer7jtkA3my8hFHB5esb5eEaOGdM41Xjcjph2exz3B3hHsMrAaQvTKLFvWjcshqWwd4QjR2wlYccRU2wqCaeYcEoZ0RG2njD6gGQcSBmstcXGWAzaQrUtu+LsJYHzgBAzJA8VzxHlOfJ6g5BW4EbJFS11GwSGGMaH+vblQ6uhKhj3Q3Wj9phWKznrv7nrudW+AL6A4fVugvZ7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 3\"\n        title=\"tdd bug fail 3\"\n        src=\"/static/c46b4eda546cf6ed38975ce6d2e1898c/42a8d/tdd-bug-fail-3.png\"\n        srcset=\"/static/c46b4eda546cf6ed38975ce6d2e1898c/772e8/tdd-bug-fail-3.png 200w,\n/static/c46b4eda546cf6ed38975ce6d2e1898c/e17e5/tdd-bug-fail-3.png 400w,\n/static/c46b4eda546cf6ed38975ce6d2e1898c/42a8d/tdd-bug-fail-3.png 558w\"\n        sizes=\"(max-width: 558px) 100vw, 558px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Next step, need to fill in that <code>processFile</code> function for validation. I'm using the same <a href=\"https://github.com/klaemo/csv-stream\">csv-streamify</a> library already used in the project to process the file for calculations. The basic skeleton for reading in a file via streams with this library is like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `data` event for every line read from csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// `line` is an array of values from the current line in csv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Validate `line` array size</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Return validation results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;finished&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>Aside:</strong> Why use a streaming approach to read in the expense file? While certainly the code would be easier to read by reading the entire file into memory in a single operation, this won't scale. If the user has been diligently tracking their every single expense for many years, the expense file could grow too large to fit into memory and then the program would crash. A full discussion of Node.js streams is outside the scope of this article, but if you'd like to learn more about this topic, see the <a href=\"https://nodejs.dev/learn/nodejs-streams\">Streams</a> documentation.</p>\n<p>Back to implementation. Since the csv input file is being read one line at a time, an object is needed to accumulate the results of validation. What should this object look like? This is the expected result specified in the test (that is currently failing), recall the expected object to be returned from this function looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  hasErrors: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      line: </span><span class=\"mtk6\">&#39;2021-04,29,194.32,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 5.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      line: </span><span class=\"mtk6\">&#39;2021-04-30,45.87,Electronics&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>There's two levels of accumulation that can be happening with this object. First is the <code>lineErrors</code> array, which should contain an entry for each line that has a problem. Then each line could potentially have more than one thing wrong with it, so the <code>errors</code> property within each <code>lineErrors</code> entry is an array to record <em>all</em> the issues with this line.</p>\n<p>To build up this object, will initialize an <code>output</code> object with <code>false</code> for <code>hasErrors</code> property (being optimistic, start with assumption that nothing is wrong unless proven otherwise), and an empty array for <code>lineErrors</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Accumulator object to record all validation errors and be returned to caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `data` event for every line read from csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// `line` is an array of values from the current line in csv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Validate `line` array size and record results in `output` object</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Return validation results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;finished&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Next need to populate the <code>output</code> object <code>lineErrors</code> array for each line that doesn't have exactly 4 fields. This logic will go on the <code>.on('data')</code> event since this is where the line value is available. The line will be collapsed back to a comma separated string to make it easier to read, and a helpful error message is set stating the expected number of fields, and how many were actually in this line:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Accumulator object to record all validation errors and be returned to caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// collapse the array back into a comma separated string to make the result easy to read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          errors: [</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Return validation results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;finished&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>But this still won't make the test pass because the <code>output</code> object isn't yet being returned. Since this is an asynchronous function, to \"return\" a value is to pass it to the <code>resolve</code> function of the <code>Promise</code>. This means some logic needs to be added to the <code>.on('end')</code> event which is called when the entire file has been read. Currently its resolving with a string <code>finished</code>. This needs to be modified to first set <code>hasErrors</code> property of object if there's at least one entry in its <code>lineErrors</code> array, and then resolve it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Accumulator object to record all validation errors and be returned to caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// collapse the array back into a comma separated string to make the result easy to read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          errors: [</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (output.lineErrors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.hasErrors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And finally, the test passes!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 543px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b2527dd634069a64835746c9cd031e7/29579/tdd-bug-pass-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdUlEQVQI142OSw6DMAxEuUZVkhAnfFRBgK76YVep3P9EDzlSK7FAYjGekWU/u3A+kKaZPo2k6c4wzvhQczWO0lY7Gef/fqRCy+O98PmuPF8Ltz4hscFWgh77+RlYBurQxTqMBLzEvKwfxqYj1C0SNbe5fwa4AfXVVA7x6HSvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug pass 1\"\n        title=\"tdd bug pass 1\"\n        src=\"/static/3b2527dd634069a64835746c9cd031e7/29579/tdd-bug-pass-1.png\"\n        srcset=\"/static/3b2527dd634069a64835746c9cd031e7/772e8/tdd-bug-pass-1.png 200w,\n/static/3b2527dd634069a64835746c9cd031e7/e17e5/tdd-bug-pass-1.png 400w,\n/static/3b2527dd634069a64835746c9cd031e7/29579/tdd-bug-pass-1.png 543w\"\n        sizes=\"(max-width: 543px) 100vw, 543px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Refactoring: Extract Method</h2>\n<p>There's still more work to be done though. Remember the number of fields is not the only thing that could be wrong with a line in the input file. The program should also validate that the date is in expected <code>YYYY-MM-DD</code> format and that the amount field is numeric.</p>\n<p>However, looking at the <code>processFile</code> function in the <code>validator</code> module currently, it's getting messy. There's the complexity of streaming the csv file to read it, which needs to respond to the <code>data</code> and <code>end</code> events, and the validation is implemented inside the <code>data</code> event handling. Adding more validation rules here will only make the code messier.</p>\n<p>It would be cleaner to extract a <code>validateLine</code> function that will perform all the validation rules on a given line, accumulating the <code>errors</code> array for this line, and have the <code>.on('data')</code> event handler call out to this new <code>validateLine</code> function to perform the validation. Let's get this refactoring done before adding any further validation rules.</p>\n<p>Often when refactoring, new bugs can be introduced, which can make developers hesitant to try and improve existing code. This is where TDD really shines. A test has already been written to verify the expected behaviour. If the test fails after refactoring, then it will be obvious that the refactor broke something and needs to be fixed. In other words, TDD allows you to refactor with confidence.</p>\n<p>Here is the refactored <code>validator</code> module with a new <code>validateLine</code> function. This function receives as arguments the <code>line</code> array from the csv file, and the <code>output</code> object for accumulating <code>lineError</code> entries. It then builds up a <code>lineErrorEntry</code> object with an <code>errors</code> array. For now only one message can be pushed to the <code>errors</code> array about the number of fields.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Rather than doing validation right here in event handler,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// call out to validateLine function to do the work.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (output.lineErrors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.hasErrors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate number of fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// If found at least one thing wrong with this line, add it to the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (lineErrorEntry.errors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And the tests still pass. Good, this refactor didn't break anything, and the code is cleaner.</p>\n<h2>More Validation: Date Format</h2>\n<p>Now we're in a good position to add more validation. Recall that the <code>invalid-data.csv</code> being passed to the test had one line with two things wrong with it. The number of fields, and invalid date format of <code>YYYY-MM</code> whereas the program is expecting <code>YYYY-MM-DD</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04,29,194.32,Groceries,Metro  &lt;-- 5 fields should be 4, AND date is YYYY-MM</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-30,45.87,Electronics</span></span></code></pre>\n<p>According to the TDD process, before modifying the validation code to add date format validation, first the test should be updated to expect a new error message for date format. Notice the first <code>lineErrors</code> entry now expects 2 error messages in the <code>errors</code> array. The first one is for number of fields, the second message is for the date format.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/expense.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expense </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/expense&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;processExpenses&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;process&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Contains validation errors&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> expense.</span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">process.</span><span class=\"mtk9\">cwd</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span><span class=\"mtk6\">/test/fixtures/invalid-data.csv`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        hasErrors: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04,29,194.32,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// NEW ERROR MESSAGE EXPECTATION ADDED HERE:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 5.&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Date format must be YYYY-MM-DD.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-30,45.87,Electronics&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedResult);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Doesn&#39;t process year results from file due to validation errors</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).not.to.have.any.</span><span class=\"mtk5\">keys</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;2021&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>This time the test will fail because the date format validation has not yet been implemented:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/74b2086624adfa8ddb40558c923f4421/eb3fa/tdd-bug-fail-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5UlEQVQoz51S0W7DIAzMfzQEsDGB0KRVo3X//2U3mSYdq6pu3cPhw+DDxu4sMSgGGE/oB4eDsdUa69+GxnWOAi7rB9brJyRlOBao76DiDfqH/bNzFe2UlDRhKTNyTJWPMoKsh9+g3G229VHDhz1DXXwUjCVjcgQyFs7Ye0AbyM3+kf8QHDxjPl9QlnMt2ZL+Kf+v5NtnWkgpyNcVvMyQ0wx3OsJIqC+/1ZRdOcQEYkFME+KYq83lWG2/ZbDffTUFNUPtKoVY4bcuUxB4DpV7ChgcVfw2UndBFWL5Fm0f0Myt5z8JfgGtl/kIHcIiWwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 4\"\n        title=\"tdd bug fail 4\"\n        src=\"/static/74b2086624adfa8ddb40558c923f4421/5a190/tdd-bug-fail-4.png\"\n        srcset=\"/static/74b2086624adfa8ddb40558c923f4421/772e8/tdd-bug-fail-4.png 200w,\n/static/74b2086624adfa8ddb40558c923f4421/e17e5/tdd-bug-fail-4.png 400w,\n/static/74b2086624adfa8ddb40558c923f4421/5a190/tdd-bug-fail-4.png 800w,\n/static/74b2086624adfa8ddb40558c923f4421/eb3fa/tdd-bug-fail-4.png 1026w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now let's go back to the <code>validateLine</code> function of the <code>validate</code> module to add date format validation. The technique used here is to <a href=\"https://momentjs.com/docs/#/parsing/string-format/\">parse</a> the date using moment.js in strict mode (passing boolean <code>true</code> as the third argument), then checking the resulting moment.js object's <code>isValid()</code> function to determine if parsing worked as expected.</p>\n<p><strong>Aside:</strong> This program is from a few years ago and already using moment.js for date handling so will continue using that for the validation. However, if starting a new project, there are more lightweight and modern <a href=\"https://momentjs.com/docs/#/-project-status/\">alternatives</a> available.</p>\n<p>Here is the updated <code>validateLine</code> function with additional date validation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> moment </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;moment&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// same code as before...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate number of fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate date format</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk5\">moment</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">], DATE_FORMAT, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk5\">isValid</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Date format must be </span><span class=\"mtk7\">${</span><span class=\"mtk1\">DATE_FORMAT</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// If found at least one thing wrong with this line, add it to the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (lineErrorEntry.errors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Now the updated test passes.</p>\n<h2>From Integration to Unit Test</h2>\n<p>Up until this point the validation code has been test driven from the <code>process</code> function test of the <code>expense</code> module. This is an integration test because it's using file I/O and testing the result of multiple modules working together. It was a good place to start with testing because that's where the buggy behaviour was observed. But now that the program is taking shape and we see that the actual validation logic is in a validation module, it's time to move one level lower and unit test just the validation module. While it's great to have higher level integration tests to ensure all the modules work together, these can be slower than unit tests.</p>\n<p>I'd like to just test the <code>validateLine</code> function of the <code>validator</code> module because it doesn't require a file input, allowing the tests to focus on passing it just one invalid line at a time. Here is a skeleton of the <code>validator</code> module test and a few tests that cover the existing validation rules for number of fields and date format. A <code>beforeEach</code> block is used to reset the <code>output</code> accumulator object to an empty state before each test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/validator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validateLine&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> output;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">beforeEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets errors when number of fields is greater than 4 and date field is invalid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;05&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;78.34&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;foo&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04,05,78.34,Groceries,Metro,foo&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 6.&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Date format must be YYYY-MM-DD.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when number of fields is less than 4&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04-05&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;78.34&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-05,78.34,Groceries&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>These tests cover functionality we've already seen working from the <code>expense</code> module integration test, so these <em>should</em> pass as well. However, they fail with the error <code>validator.validateLine is not a function</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a04a78af118c9a50e87c37af8fbd9a49/8bd7c/tdd-bug-fail-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUElEQVQoz4VS2W6DQAzkOxpg73tZAjkapU3V//+pqXYhiKDSPozGxt7R2Lg6Xa5IwwmUS9QtRU3YxBs0hC1oV3Ez9z/jqrMe95gwKoNEGQbG0VOOSDm6mY+Uw1IGSRgMZdCEQZGJxVawpgyUMgjKS1HOTWxmPjPZuNp1KKwCMRJEKDSU45AbdvCX4LNeBRcxHEcwoXBoCN5WWPK6LfEemtXeK6kMPj8euN3uSF2PGLoCZz2cC/A+IsVUYm09fK75COMCrI/Q1r2OnHeWlEbQFicfMWQ4j8EFdC4guVBiry2EMmBclot4gjDxKsiVgTQOVKiyx5YLkNyc8/lRu3q0d1LLyC50eHx9YxjPkwOhiovCWZSJhbf3+OtfVpTjvetxOY649QOuGanHOSYMMaEPXcmDccXpVmCLKrtReWxloLWFlLpA6elbhpAalPHi8j/BH1MvNX+yZlfLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 5\"\n        title=\"tdd bug fail 5\"\n        src=\"/static/a04a78af118c9a50e87c37af8fbd9a49/5a190/tdd-bug-fail-5.png\"\n        srcset=\"/static/a04a78af118c9a50e87c37af8fbd9a49/772e8/tdd-bug-fail-5.png 200w,\n/static/a04a78af118c9a50e87c37af8fbd9a49/e17e5/tdd-bug-fail-5.png 400w,\n/static/a04a78af118c9a50e87c37af8fbd9a49/5a190/tdd-bug-fail-5.png 800w,\n/static/a04a78af118c9a50e87c37af8fbd9a49/8bd7c/tdd-bug-fail-5.png 845w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The reason for this is the <code>validator</code> module currently only exposes the <code>processFile</code> method in its exports. Strictly speaking that's the only \"public\" method needed for the module because it's only used by the <code>expense</code> module, which only calls <code>processFile</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Only one function is public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, in order to unit test the <code>validateLine</code> method of the <code>validator</code> module, it must also be exposed in the <code>module.exports</code> section, effectively making it public. This is one of the few times that I miss Java, where the <code>default</code> and <code>protected</code> <a href=\"https://www.programiz.com/java-programming/access-modifiers\">access modifiers</a> are perfect for this purpose. A method can be marked <code>default</code> or <code>protected</code> to give it package level visibility, which makes it available to the test which lives in the same package, but doesn't make it <code>public</code> to the entire program.</p>\n<p>One way around this in JavaScript is to extract out the method to be tested into yet another module, say <code>validator-details.js</code>, expose that method publicly in the new module, then have the <code>validator</code> module call out to <code>validator-details</code> module. However, this feels like way too much overhead for this purpose so I'm simply going to add <code>validateLine</code> to the list of public methods in the <code>validator</code> module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NOW validateLine can be unit tested</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validateLine,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And this makes the tests pass, including the new tests in <code>test/lib/validator.test.js</code></p>\n<h2>More Validation: Numeric Amount</h2>\n<p>The last validation to add is to ensure the spending amount provided in each csv line is numeric. Now that we have lower level unit testing set up for the <code>validator</code> module, let's add this test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/validator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validateLine&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> output;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">beforeEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets errors when number of fields is greater than 4 and date field is invalid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when number of fields is less than 4&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NEW TEST HERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when amount is not numeric&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04-27&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;1o7.e8&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-27,1o7.e8,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Amount must be numeric.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>At this point, the test will fail because numeric amount validation has not yet been implemented. So the <code>lineErrors</code> property of the <code>output</code> object will be an empty array rather than the expected error:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2f1badec3504d40fc0b3fa0932cdaef8/2b2c6/tdd-bug-fail-6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGElEQVQoz42TW3LDMAhFvY5YsgRCDz/SdjL960z3v6vbAcdu2iapP65AeHxACHWeGEPLGEoGscAH+iM3xLvxe+oiJbxMM5b5jCEynA/ofTCI+qojoC1pp0udFnx8fOLt8o46L2jTAinN4nWcV/g/2qCdLhwJY6uYc8FrylhSRmVZbRJIIIyRUQOh3Ehj/LtCdYYkcCVjCAR5kP3wkdUJmj1n1CwgYnj9aDCCCzc6dGR1mNHXjNNlNuuI4TgZxOul+GsC3T+o2G23bEAFEON0HlctzWw/VUtgSVLaoc/asFeoP6yVXX21kuBE0GdZ91uVT6BrDynB2wzGvX8/ZPFjg27AyILSJpQ22tzpDJY6Iu9qoPT9kp4BvwBNtS8xkKvS9QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 6\"\n        title=\"tdd bug fail 6\"\n        src=\"/static/2f1badec3504d40fc0b3fa0932cdaef8/5a190/tdd-bug-fail-6.png\"\n        srcset=\"/static/2f1badec3504d40fc0b3fa0932cdaef8/772e8/tdd-bug-fail-6.png 200w,\n/static/2f1badec3504d40fc0b3fa0932cdaef8/e17e5/tdd-bug-fail-6.png 400w,\n/static/2f1badec3504d40fc0b3fa0932cdaef8/5a190/tdd-bug-fail-6.png 800w,\n/static/2f1badec3504d40fc0b3fa0932cdaef8/2b2c6/tdd-bug-fail-6.png 869w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>For implementation, there's plenty of JavaScript <a href=\"https://www.wikitechy.com/tutorials/javascript/validate-decimal-numbers\">solutions</a> to verify if a given input is a decimal number. Since the Tidysum app is already using <a href=\"https://github.com/MikeMcl/decimal.js/\">decimal.js</a>, I decided to make use of that library's parsing, which throws an error if the input cannot be parsed to a numeric. Note that all values come in as strings from csv parsing, so the solution needs to consider <code>'123.45'</code> to be valid, but <code>'123abc'</code> is not.</p>\n<p>Here is the updated validator module with numeric amount validation added:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> moment </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;moment&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> Decimal </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimal.js&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate number of fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate date format</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk5\">moment</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">], </span><span class=\"mtk6\">&#39;YYYY-MM-DD&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk5\">isValid</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Date format must be YYYY-MM-DD.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEWLY ADDED: Validate numeric amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">catch</span><span class=\"mtk1\"> (_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Amount must be numeric.&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validateLine,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And now the tests pass.</p>\n<p>One last test that should be added is to pass in a valid line, and ensure that no errors are reported. This is to make sure there's no false negative in the validation code - i.e. flagging a valid line as invalid:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/validator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validateLine&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> output;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">beforeEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets errors when number of fields is greater than 4 and date field is invalid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when number of fields is less than 4&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when amount is not numeric&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NEW TEST HERE: Valid scenario</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;does not report any errors when input line is valid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04-05&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;78.34&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>And this test passes as well.</p>\n<p>Good, all validation is now implemented. But not quite ready to call it a day.</p>\n<h2>Refactoring: Extract Validation Methods</h2>\n<p>It's time to do just a little more refactoring. Looking at the validator module, there's a few things bothering me:</p>\n<ol>\n<li>The <code>validateLine</code> function has gotten too long, it has the details of 3 different validations, and each one has a comment describing what it does. It would be cleaner to extract each of these to a separate method, and name the method to match the comment, then the comments can be removed.</li>\n<li>There are several hard-coded values: <code>4</code> for number of fields, and <code>YYYY-MM-DD</code> for date format. It would be cleaner to extract these as constants.</li>\n</ol>\n<p>Again we can rely on the tests here. It's safe to re-arrange the code to make any internal improvements, and as long as the tests are still passing, can be confident that the code is still working as expected.</p>\n<p>Here is the refactored validation module with individual methods to implement each validation rule, and hard-coded values extracted as constants:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> NUM_FIELDS </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> DATE_FORMAT </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;YYYY-MM-DD&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Call out to individual validation methods for each rule</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">validateNumFields</span><span class=\"mtk1\">(line, lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">validateDateFormat</span><span class=\"mtk1\">(line, lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">validateNumeric</span><span class=\"mtk1\">(line, lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// If found at least one thing wrong with this line, add it to the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (lineErrorEntry.errors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateNumFields</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">lineErrorEntry</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> NUM_FIELDS) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected </span><span class=\"mtk7\">${</span><span class=\"mtk1\">NUM_FIELDS</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateDateFormat</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">lineErrorEntry</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk5\">moment</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">], DATE_FORMAT, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk5\">isValid</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Date format must be </span><span class=\"mtk7\">${</span><span class=\"mtk1\">DATE_FORMAT</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateNumeric</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">lineErrorEntry</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">catch</span><span class=\"mtk1\"> (_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Amount must be numeric.&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validateLine,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And all the tests are still passing, hurray!</p>\n<h2>Summary</h2>\n<p>This post has walked you through a practical example of using TDD to fix a bug, and apply refactoring to improve the design of the code, while relying on the tests to confirm the code still works as expected. In general the process is as follows:</p>\n<ol>\n<li>Analyze the code to find where/how/why the bug is occurring.</li>\n<li>Define expectations about how the code should behave.</li>\n<li>Write a test that fails because of the bug.</li>\n<li>Write some code to make the test pass.</li>\n<li>Refactor and re-run tests as needed.</li>\n</ol>\n<p>I hope this has inspired you to try out TDD next time you're faced with a bug. Good luck and happy coding!</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>You've seen a few simple examples of refactoring in this blog post. Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is the go-to book to learn all about this topic.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"TDD by Example: Fixing a Bug","date":"16 May 2021","description":"A practical example of using TDD to fix a bug and do some refactoring on an existing project.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#889868","images":{"fallback":{"src":"/static/09e6767737efce3dd20e0089bdf1bf06/554d7/tdd-bug-charlotte-descamps-1sbVyhfdoQM-unsplash.jpg","srcSet":"/static/09e6767737efce3dd20e0089bdf1bf06/95981/tdd-bug-charlotte-descamps-1sbVyhfdoQM-unsplash.jpg 200w,\n/static/09e6767737efce3dd20e0089bdf1bf06/96c5f/tdd-bug-charlotte-descamps-1sbVyhfdoQM-unsplash.jpg 400w,\n/static/09e6767737efce3dd20e0089bdf1bf06/554d7/tdd-bug-charlotte-descamps-1sbVyhfdoQM-unsplash.jpg 800w","sizes":"(min-width: 800px) 800px, 100vw"},"sources":[{"srcSet":"/static/09e6767737efce3dd20e0089bdf1bf06/dd916/tdd-bug-charlotte-descamps-1sbVyhfdoQM-unsplash.webp 200w,\n/static/09e6767737efce3dd20e0089bdf1bf06/d5438/tdd-bug-charlotte-descamps-1sbVyhfdoQM-unsplash.webp 400w,\n/static/09e6767737efce3dd20e0089bdf1bf06/fa1ba/tdd-bug-charlotte-descamps-1sbVyhfdoQM-unsplash.webp 800w","type":"image/webp","sizes":"(min-width: 800px) 800px, 100vw"}]},"width":800,"height":530}}}},"fields":{"slug":"/blog/tdd-by-example-bugfix/"}}},"pageContext":{"slug":"/blog/tdd-by-example-bugfix/","content":"<p>This post will demonstrate an example of using TDD (test driven development) to fix a bug on an existing project. If you're not familiar with TDD, see an <a href=\"/blog/tdd-by-example/\">earlier post</a> I wrote on this topic.</p>\n<h2>Discovering the Problem</h2>\n<p>Last month when running my monthly expense report with <a href=\"https://github.com/danielabar/tidysum\">Tidysum</a> (a Node.js command line program I wrote that processes a csv list of daily expenses and outputs a summary json with year and month breakdowns of expenses by category, and makes savings/spending recommendations and calculates a personal rate of inflation), it seemed to be under-reporting April's spending by roughly $200. Although my spending has been lower during Covid times because, you know, there's nothing to do, nevertheless the total amount for April seemed unusually low.</p>\n<p>Digging into the input <code>expenses.csv</code> file, I found the issue - notice the second line in this snip from the file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-11,131.32,Groceries,Metro</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04,24,194.87,Groceries,Metro &lt;-- BUG HANDLING THIS LINE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-25,20.00,Gas,Shell</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<p>The expected format for the input csv is: <code>date in YYYY-MM-DD format,numeric spending amount,category,store</code>. However, the second line has a typo in the date, there's a <code>,</code> where the second <code>-</code> should be. But, <code>2021-04</code> is a valid date. So what the program did is take the first field <code>2021-04</code> as the date, then the second \"field\", which was really the date portion of <code>24</code> as the amount field, then the amount field of <code>194.87</code> which was now the third field got tracked as a category, and the actual category <code>Groceries</code> was now the fourth field and got tracked as the store. The final field <code>Metro</code> which is the actual store ended up in the fifth position and was ignored entirely. This is how the spending of <code>$194.87</code> got incorrectly recorded as <code>$24.00</code> and that's how total spending for April was under-reported.</p>\n<p>Normally when a developer discovers a bug in their code, there's an instinct to dive in, figure out what's wrong and fix it as quickly as possible. But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven't actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass.</p>\n<p>The benefit of this approach is it forces you to first think about how the code should behave under the bug circumstances by documenting it in a test. Then having the test ensures that this bug will never creep into your code again.</p>\n<p>So first things first, let's figure out where in the code this problem with processing potentially invalid data occurs.</p>\n<p><strong>Aside:</strong> Some of you may be wondering why write a custom program for expense tracking when there's Excel and countless free apps out there, a <a href=\"https://github.com/danielabar/tidysum#why-not-use-excel\">short explanation here</a>.</p>\n<h2>Analysis</h2>\n<p>Looking at the code, I realized there was no validation of the input file. It's read in via a csv stream library and processed one line at a time, assuming each line is in the expected format. Here's the relevant code starting from the command line entrypoint:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// index.js (entrypoint)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expense </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./lib/expense&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Left out some code for brevity - that grabs the command line arguments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// including `argv.e` which is path to expense file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk7\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> expense.</span><span class=\"mtk5\">process</span><span class=\"mtk1\">(argv.e);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  fs.</span><span class=\"mtk5\">writeFileSync</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;expenses.json&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9\">JSON</span><span class=\"mtk1\">.</span><span class=\"mtk9\">stringify</span><span class=\"mtk1\">(result, </span><span class=\"mtk4\">null</span><span class=\"mtk1\">, </span><span class=\"mtk4\">2</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})();</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/expense.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// No validation, inputFile is passed as is to processFile function.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// csv-streamify exposes the data as an array of values from csv line</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// eg: 2020-04-29,194.23,Groceries,Metro turns into:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// [&#39;2020-04-29&#39;, &#39;194.23&#39;, &#39;Groceries&#39;, &#39;Metro&#39;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">processLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use destructuring assignment to unpack values out of array that csv-streamify generated from line in csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> [dateStr, amountStr, category, merchant] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> line;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">processEntry</span><span class=\"mtk1\">({ dateStr, amountStr, category, merchant }, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processEntry</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">data</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Begin calculations...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The critical part is this line that uses <code>csv-streamify</code> to stream in the csv file one line at a time:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>At this point, <code>line</code> is an array of values from the line in the csv file that was just read. There will be one entry in the array for each value in the csv line. Then this array <code>line</code> gets passed to the <code>processLine</code> function which uses <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment\">destructuring assignment</a> to unpack the values in the <code>line</code> array into individual values:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use destructuring assignment to unpack values out of array that csv-streamify generated from line in csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> [dateStr, amountStr, category, merchant] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> line;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This is where the bug occurs because if the csv line had a comma instead of an expected dash in date such as <code>2021-04,24,194.87,Groceries,Metro</code>, then the variables will be assigned as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;24&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;194.87&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dateStr </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2021-04&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">amountStr </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;24&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">category </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;194.87&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">merchant </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Groceries&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Metro is ignored</span></span></span></code></pre>\n<h2>Define Expectations</h2>\n<p>Now that the analysis has revealed how the bug occurs, the next step is to determine how the program <em>should</em> behave when given invalid data. This \"should\" behaviour will then get encoded into a test.</p>\n<p>If this was a work project, the decision as to how the program should behave usually goes to the product manager/owner. But in this case, it's a side project which makes me the product owner so I need to decide. Given that this is a financial application, it doesn't make sense to perform <em>any</em> calculation if even a single record is invalid. This is because all the numbers get added, averaged, and compared. So even one number being off could throw off all the results.</p>\n<p>What this means is that there should be a validation step <em>before</em> the file is processed for calculation. This validation should read in all lines of the file and for each line, check that it has exactly 4 fields. Any more or less is a sign that the data is probably incorrect. There's other things that could be validated like the date format and numeric spending amount, but will get to that later. It's easier to start with just a single validation and then add in more.</p>\n<p>As the program finds invalid lines, it should accumulate these. For each invalid line it should record all the things that are wrong with it. For now there will only be one thing its checking (number of values), but there could be more.</p>\n<p>Then before the program goes into the calculation step, it should check if any validation errors occurred, stop and return these instead of going into the calculation step.</p>\n<h2>Write a Failing Test</h2>\n<p>Since the bug can be observed from the results of the <code>process</code> function in <code>lib/expense.js</code>, I will start with writing a test for this function. The test will provide an invalid input file to the <code>process</code> function, and expects some validation errors returned instead of the usual calculations that <code>process</code> would return.</p>\n<p>It's very likely that the validation implementation won't go in the <code>process</code> function itself because the <code>lib/expense.js</code> module is about calculating expenses. Keeping with the <a href=\"https://en.wikipedia.org/wiki/Single-responsibility_principle\">single responsibility principle</a>, the actual validation will be performed by another module, and <code>process</code> will just call out to it before proceeding with calculation. However, I don't want to get into any implementation details before having at least one failing test in place, and since I can see the buggy behaviour from <code>process</code>, this is where I'm starting with a (failing) test.</p>\n<p>This project uses the <a href=\"https://mochajs.org/\">Mocha</a> testing library with <a href=\"https://www.chaijs.com/\">Chai</a> expect-style assertions, but the same TDD principles would apply to any test framework/library.</p>\n<p>The <code>process</code> function is asynchronous because it reads in a file, so the test will also be asynchronous. As for the input file for the test, this project already has a <code>test/fixtures</code> directory, so will first write an <code>invalid-data.csv</code> test file and place it in the fixtures directory:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// test/fixtures/invalid-data.csv</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04,29,194.32,Groceries,Metro</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-30,45.87,Electronics</span></span></code></pre>\n<p>This input file has two invalid lines. The first one has 5 fields and the second one has 3 fields. Recall the expectation is each line should have exactly 4 fields. The first line has an additional problem that the date format is incorrect, but for now we're only interested in the \"number of fields\" validation.</p>\n<p>The test will pass the invalid file from the <code>test/fixtures</code> directory to the <code>process</code> function, then define an expected result object containing the line errors, then use chai's <code>deep.equal</code> assertion to verify that the actual result returned from <code>process</code> matches the expected result.</p>\n<p>Where does the expected result object come from? That's my requirements that I decided on what would be a nice easy way to show the errors to the user. Remember, this isn't implemented yet, the test is how you can express the thought - \"I wish the program worked like this\"...</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/expense.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expense </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/expense&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;processExpenses&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;process&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Contains validation errors&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> expense.</span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">process.</span><span class=\"mtk9\">cwd</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span><span class=\"mtk6\">/test/fixtures/invalid-data.csv`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        hasErrors: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04,29,194.32,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 5.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-30,45.87,Electronics&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedResult);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Doesn&#39;t process year results from file due to validation errors</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).not.to.have.any.</span><span class=\"mtk5\">keys</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;2021&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Run <code>npm test</code> in a terminal to run the tests, and as expected, this new test fails because validation has not yet been implemented.</p>\n<p>You can see the bug in action here because the code is attempting to run calculations on invalid data. There's a category of <code>194.32</code> due to the date parsing error on the first invalid line. Also there's a Merchant of <code>undefined</code> which comes from the second invalid line that only has 3 fields (missing Merchant field). And the total spending is incorrect, it should be <code>194.32</code> + <code>45.87</code> = <code>240.19</code> (the intended amounts from input data if it were valid), but instead the total is <code>29</code> (from incorrectly parsed date in ine 1) + <code>45.87</code> = <code>74.87</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6b0b734a2ffb50eac107906c4cb08ac4/ef6b9/tdd-bug-fail-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 117.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAACEUlEQVQ4y51VW3LbMAz0LRpbFAmAIClaDztN049Op/e/1XZIWrHTJhPZH2sQsrRcPAjufI5wUUGisCToHb/BWHrnb8FumRa8fP+BaTmD2KMzFl3vrmR3kJZvdhISfv3+g/n0jDyfkMYZx3kB+YDOEozjaj+DubFVITvCoIqsikkUsyhyAQuSY6hjJGIMxNVfkan9HxzjSAK/KrTiYY4JRj2SJZQNSpi2wPGncB+sGyEJJieIlrC/kf8IashFjTjGK3u8sNTQ6LLjvRVuCi9OycOZGmHJh3+0bVbCMwt+sq+E8Z8+vId4Zy3D9oTRMk6leq4R2kcVGmJ0SwY9j+hzAgdtSV5VurY2lyY3XxKyoEsB+yWjGyK6m9NRFd7AbDg5lbB2+zTgcD7CxIDumCq58f6NaLtCElivOKSAQ1QcxoQuR3Q5NeLijwOM+G2EvWV4ktqHMwm4FGRt1EdCXqt5uiGdSGqzXwtzR8jlx1Frl2TbwfeW4W6O01aylkMRlMLYaYAZB1gW9N6jPK8v9dvDvVaZBN+mAU9LxlOxc8Z+HHAoxYmhbrhdYZl5ohi8RxaPFAKiKlQVEhQUFB3dEXJ5MRLXEVbyeHQMtg1k6V0ut9w3bcCyYN+7NxwsNfTuOub7/2ef+WCznWMPHxLEB2ixGuu6WH/x+eKXm/FrhSTQmOrHGocKH2IlWJ+vaOTtyv2M8C/j1JRuPQSd4wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 1\"\n        title=\"tdd bug fail 1\"\n        src=\"/static/6b0b734a2ffb50eac107906c4cb08ac4/5a190/tdd-bug-fail-1.png\"\n        srcset=\"/static/6b0b734a2ffb50eac107906c4cb08ac4/772e8/tdd-bug-fail-1.png 200w,\n/static/6b0b734a2ffb50eac107906c4cb08ac4/e17e5/tdd-bug-fail-1.png 400w,\n/static/6b0b734a2ffb50eac107906c4cb08ac4/5a190/tdd-bug-fail-1.png 800w,\n/static/6b0b734a2ffb50eac107906c4cb08ac4/ef6b9/tdd-bug-fail-1.png 832w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Make the Test Pass</h2>\n<p>Finally, it's time to implement some validation!</p>\n<p>Looking again at the <code>process</code> function, it needs to read the entire file for validation purposes <em>before</em> going into the calculations, and if any validation errors are found, return them instead of going on to perform calculations. Since I know the actual validation logic doesn't belong here, I will introduce a new <code>validator</code> module and call out to it. Will get to writing this shortly. Since reading a file is an asynchronous operation in Node.js, the function to be exposed by the validator module must also be asynchronous.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/expense.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// NEW MODULE (not written yet)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEW CODE ADDED HERE: Call validator module to process file, if any errors, return immediately</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validationResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> validator.</span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (validationResult.hasErrors) </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> validationResult;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Since some implementation code has been added, <code>npm test</code> to run tests again. Not surprisingly, the expense test fails because the new <code>validator</code> module cannot be found:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 542px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/419af29638021620f798a0348fff7898/c0388/tdd-bug-fail-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.500000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABDUlEQVQY01WQ6XLCMAyE8xwtN5QCIeFqyOH4dgLv/0Lb0ZbpDD92ZNnSJ62zY3nGZruDxH1eIC9Knm/Vnflqs0V5vuJy/UFRnjFbrDCZLajpfPkmucuGxxN120Fpg15bQr73OY7FCdvdgcDd4Yi8ODHOl+v/ZtHndP4Gz1ql4XyEjwkhDmi6Hk2rOORW1VDa8q6qW0bjPJpO4XKrsFx/UYvVhuCPyQxZdW/gQkRIA2IaefZxgA8JXa8Rh5GDRNo4WBdYN4xPOhJnIvkWcZbVTUcIG9MIYz2MC2xsVU+4OJCB5gWT3IXEeoFJb6c0v4kbSiE3C4lAgYm1+2uYFYD/i9zUOlgfCO2NZZ28yZa/ITzDCvdjpYQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 2\"\n        title=\"tdd bug fail 2\"\n        src=\"/static/419af29638021620f798a0348fff7898/c0388/tdd-bug-fail-2.png\"\n        srcset=\"/static/419af29638021620f798a0348fff7898/772e8/tdd-bug-fail-2.png 200w,\n/static/419af29638021620f798a0348fff7898/e17e5/tdd-bug-fail-2.png 400w,\n/static/419af29638021620f798a0348fff7898/c0388/tdd-bug-fail-2.png 542w\"\n        sizes=\"(max-width: 542px) 100vw, 542px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>To fix this, need to add the validator module and expose a <code>processFile</code> function:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// TODO: Stream in csv file and validate each line</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This time when running the tests, get a failure about being unable to read property <code>hasErrors</code> of undefined, which makes sense since the <code>processFile</code> function of the <code>validator</code> module doesn't return anything yet:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 558px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c46b4eda546cf6ed38975ce6d2e1898c/42a8d/tdd-bug-fail-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGklEQVQoz5WR60oDMRCF9zW2l1wnM0m6pe12exGpov0hvv8DHUlMoWBB/fFxJnM5GZJulhh9FvSJYYnhibHUFgtlqv6XjiUgrwQxC5TzMI6w0I/N/nJJJ8RgR2BL8CTwQaCtfzz8i2GZ6WQ14OX9iuvHJy6vbxgPJ5BE9AuF2VKjb5TmubaYK1Pjer7jtkA3my8hFHB5esb5eEaOGdM41Xjcjph2exz3B3hHsMrAaQvTKLFvWjcshqWwd4QjR2wlYccRU2wqCaeYcEoZ0RG2njD6gGQcSBmstcXGWAzaQrUtu+LsJYHzgBAzJA8VzxHlOfJ6g5BW4EbJFS11GwSGGMaH+vblQ6uhKhj3Q3Wj9phWKznrv7nrudW+AL6A4fVugvZ7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 3\"\n        title=\"tdd bug fail 3\"\n        src=\"/static/c46b4eda546cf6ed38975ce6d2e1898c/42a8d/tdd-bug-fail-3.png\"\n        srcset=\"/static/c46b4eda546cf6ed38975ce6d2e1898c/772e8/tdd-bug-fail-3.png 200w,\n/static/c46b4eda546cf6ed38975ce6d2e1898c/e17e5/tdd-bug-fail-3.png 400w,\n/static/c46b4eda546cf6ed38975ce6d2e1898c/42a8d/tdd-bug-fail-3.png 558w\"\n        sizes=\"(max-width: 558px) 100vw, 558px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Next step, need to fill in that <code>processFile</code> function for validation. I'm using the same <a href=\"https://github.com/klaemo/csv-stream\">csv-streamify</a> library already used in the project to process the file for calculations. The basic skeleton for reading in a file via streams with this library is like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `data` event for every line read from csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// `line` is an array of values from the current line in csv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Validate `line` array size</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Return validation results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;finished&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>Aside:</strong> Why use a streaming approach to read in the expense file? While certainly the code would be easier to read by reading the entire file into memory in a single operation, this won't scale. If the user has been diligently tracking their every single expense for many years, the expense file could grow too large to fit into memory and then the program would crash. A full discussion of Node.js streams is outside the scope of this article, but if you'd like to learn more about this topic, see the <a href=\"https://nodejs.dev/learn/nodejs-streams\">Streams</a> documentation.</p>\n<p>Back to implementation. Since the csv input file is being read one line at a time, an object is needed to accumulate the results of validation. What should this object look like? This is the expected result specified in the test (that is currently failing), recall the expected object to be returned from this function looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  hasErrors: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      line: </span><span class=\"mtk6\">&#39;2021-04,29,194.32,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 5.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      line: </span><span class=\"mtk6\">&#39;2021-04-30,45.87,Electronics&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>There's two levels of accumulation that can be happening with this object. First is the <code>lineErrors</code> array, which should contain an entry for each line that has a problem. Then each line could potentially have more than one thing wrong with it, so the <code>errors</code> property within each <code>lineErrors</code> entry is an array to record <em>all</em> the issues with this line.</p>\n<p>To build up this object, will initialize an <code>output</code> object with <code>false</code> for <code>hasErrors</code> property (being optimistic, start with assumption that nothing is wrong unless proven otherwise), and an empty array for <code>lineErrors</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Accumulator object to record all validation errors and be returned to caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `data` event for every line read from csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// `line` is an array of values from the current line in csv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Validate `line` array size and record results in `output` object</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Return validation results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;finished&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Next need to populate the <code>output</code> object <code>lineErrors</code> array for each line that doesn't have exactly 4 fields. This logic will go on the <code>.on('data')</code> event since this is where the line value is available. The line will be collapsed back to a comma separated string to make it easier to read, and a helpful error message is set stating the expected number of fields, and how many were actually in this line:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Accumulator object to record all validation errors and be returned to caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// collapse the array back into a comma separated string to make the result easy to read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          errors: [</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Return validation results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;finished&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>But this still won't make the test pass because the <code>output</code> object isn't yet being returned. Since this is an asynchronous function, to \"return\" a value is to pass it to the <code>resolve</code> function of the <code>Promise</code>. This means some logic needs to be added to the <code>.on('end')</code> event which is called when the entire file has been read. Currently its resolving with a string <code>finished</code>. This needs to be modified to first set <code>hasErrors</code> property of object if there's at least one entry in its <code>lineErrors</code> array, and then resolve it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Accumulator object to record all validation errors and be returned to caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// collapse the array back into a comma separated string to make the result easy to read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          errors: [</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (output.lineErrors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.hasErrors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And finally, the test passes!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 543px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b2527dd634069a64835746c9cd031e7/29579/tdd-bug-pass-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdUlEQVQI142OSw6DMAxEuUZVkhAnfFRBgK76YVep3P9EDzlSK7FAYjGekWU/u3A+kKaZPo2k6c4wzvhQczWO0lY7Gef/fqRCy+O98PmuPF8Ltz4hscFWgh77+RlYBurQxTqMBLzEvKwfxqYj1C0SNbe5fwa4AfXVVA7x6HSvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug pass 1\"\n        title=\"tdd bug pass 1\"\n        src=\"/static/3b2527dd634069a64835746c9cd031e7/29579/tdd-bug-pass-1.png\"\n        srcset=\"/static/3b2527dd634069a64835746c9cd031e7/772e8/tdd-bug-pass-1.png 200w,\n/static/3b2527dd634069a64835746c9cd031e7/e17e5/tdd-bug-pass-1.png 400w,\n/static/3b2527dd634069a64835746c9cd031e7/29579/tdd-bug-pass-1.png 543w\"\n        sizes=\"(max-width: 543px) 100vw, 543px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Refactoring: Extract Method</h2>\n<p>There's still more work to be done though. Remember the number of fields is not the only thing that could be wrong with a line in the input file. The program should also validate that the date is in expected <code>YYYY-MM-DD</code> format and that the amount field is numeric.</p>\n<p>However, looking at the <code>processFile</code> function in the <code>validator</code> module currently, it's getting messy. There's the complexity of streaming the csv file to read it, which needs to respond to the <code>data</code> and <code>end</code> events, and the validation is implemented inside the <code>data</code> event handling. Adding more validation rules here will only make the code messier.</p>\n<p>It would be cleaner to extract a <code>validateLine</code> function that will perform all the validation rules on a given line, accumulating the <code>errors</code> array for this line, and have the <code>.on('data')</code> event handler call out to this new <code>validateLine</code> function to perform the validation. Let's get this refactoring done before adding any further validation rules.</p>\n<p>Often when refactoring, new bugs can be introduced, which can make developers hesitant to try and improve existing code. This is where TDD really shines. A test has already been written to verify the expected behaviour. If the test fails after refactoring, then it will be obvious that the refactor broke something and needs to be fixed. In other words, TDD allows you to refactor with confidence.</p>\n<p>Here is the refactored <code>validator</code> module with a new <code>validateLine</code> function. This function receives as arguments the <code>line</code> array from the csv file, and the <code>output</code> object for accumulating <code>lineError</code> entries. It then builds up a <code>lineErrorEntry</code> object with an <code>errors</code> array. For now only one message can be pushed to the <code>errors</code> array about the number of fields.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Rather than doing validation right here in event handler,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// call out to validateLine function to do the work.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (output.lineErrors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.hasErrors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate number of fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// If found at least one thing wrong with this line, add it to the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (lineErrorEntry.errors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And the tests still pass. Good, this refactor didn't break anything, and the code is cleaner.</p>\n<h2>More Validation: Date Format</h2>\n<p>Now we're in a good position to add more validation. Recall that the <code>invalid-data.csv</code> being passed to the test had one line with two things wrong with it. The number of fields, and invalid date format of <code>YYYY-MM</code> whereas the program is expecting <code>YYYY-MM-DD</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04,29,194.32,Groceries,Metro  &lt;-- 5 fields should be 4, AND date is YYYY-MM</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-30,45.87,Electronics</span></span></code></pre>\n<p>According to the TDD process, before modifying the validation code to add date format validation, first the test should be updated to expect a new error message for date format. Notice the first <code>lineErrors</code> entry now expects 2 error messages in the <code>errors</code> array. The first one is for number of fields, the second message is for the date format.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/expense.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expense </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/expense&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;processExpenses&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;process&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Contains validation errors&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> expense.</span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">process.</span><span class=\"mtk9\">cwd</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span><span class=\"mtk6\">/test/fixtures/invalid-data.csv`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        hasErrors: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04,29,194.32,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// NEW ERROR MESSAGE EXPECTATION ADDED HERE:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 5.&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Date format must be YYYY-MM-DD.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-30,45.87,Electronics&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedResult);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Doesn&#39;t process year results from file due to validation errors</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).not.to.have.any.</span><span class=\"mtk5\">keys</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;2021&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>This time the test will fail because the date format validation has not yet been implemented:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/74b2086624adfa8ddb40558c923f4421/eb3fa/tdd-bug-fail-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5UlEQVQoz51S0W7DIAzMfzQEsDGB0KRVo3X//2U3mSYdq6pu3cPhw+DDxu4sMSgGGE/oB4eDsdUa69+GxnWOAi7rB9brJyRlOBao76DiDfqH/bNzFe2UlDRhKTNyTJWPMoKsh9+g3G229VHDhz1DXXwUjCVjcgQyFs7Ye0AbyM3+kf8QHDxjPl9QlnMt2ZL+Kf+v5NtnWkgpyNcVvMyQ0wx3OsJIqC+/1ZRdOcQEYkFME+KYq83lWG2/ZbDffTUFNUPtKoVY4bcuUxB4DpV7ChgcVfw2UndBFWL5Fm0f0Myt5z8JfgGtl/kIHcIiWwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 4\"\n        title=\"tdd bug fail 4\"\n        src=\"/static/74b2086624adfa8ddb40558c923f4421/5a190/tdd-bug-fail-4.png\"\n        srcset=\"/static/74b2086624adfa8ddb40558c923f4421/772e8/tdd-bug-fail-4.png 200w,\n/static/74b2086624adfa8ddb40558c923f4421/e17e5/tdd-bug-fail-4.png 400w,\n/static/74b2086624adfa8ddb40558c923f4421/5a190/tdd-bug-fail-4.png 800w,\n/static/74b2086624adfa8ddb40558c923f4421/eb3fa/tdd-bug-fail-4.png 1026w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now let's go back to the <code>validateLine</code> function of the <code>validate</code> module to add date format validation. The technique used here is to <a href=\"https://momentjs.com/docs/#/parsing/string-format/\">parse</a> the date using moment.js in strict mode (passing boolean <code>true</code> as the third argument), then checking the resulting moment.js object's <code>isValid()</code> function to determine if parsing worked as expected.</p>\n<p><strong>Aside:</strong> This program is from a few years ago and already using moment.js for date handling so will continue using that for the validation. However, if starting a new project, there are more lightweight and modern <a href=\"https://momentjs.com/docs/#/-project-status/\">alternatives</a> available.</p>\n<p>Here is the updated <code>validateLine</code> function with additional date validation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> moment </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;moment&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// same code as before...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate number of fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate date format</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk5\">moment</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">], DATE_FORMAT, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk5\">isValid</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Date format must be </span><span class=\"mtk7\">${</span><span class=\"mtk1\">DATE_FORMAT</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// If found at least one thing wrong with this line, add it to the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (lineErrorEntry.errors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Now the updated test passes.</p>\n<h2>From Integration to Unit Test</h2>\n<p>Up until this point the validation code has been test driven from the <code>process</code> function test of the <code>expense</code> module. This is an integration test because it's using file I/O and testing the result of multiple modules working together. It was a good place to start with testing because that's where the buggy behaviour was observed. But now that the program is taking shape and we see that the actual validation logic is in a validation module, it's time to move one level lower and unit test just the validation module. While it's great to have higher level integration tests to ensure all the modules work together, these can be slower than unit tests.</p>\n<p>I'd like to just test the <code>validateLine</code> function of the <code>validator</code> module because it doesn't require a file input, allowing the tests to focus on passing it just one invalid line at a time. Here is a skeleton of the <code>validator</code> module test and a few tests that cover the existing validation rules for number of fields and date format. A <code>beforeEach</code> block is used to reset the <code>output</code> accumulator object to an empty state before each test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/validator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validateLine&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> output;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">beforeEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets errors when number of fields is greater than 4 and date field is invalid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;05&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;78.34&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;foo&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04,05,78.34,Groceries,Metro,foo&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 6.&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Date format must be YYYY-MM-DD.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when number of fields is less than 4&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04-05&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;78.34&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-05,78.34,Groceries&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>These tests cover functionality we've already seen working from the <code>expense</code> module integration test, so these <em>should</em> pass as well. However, they fail with the error <code>validator.validateLine is not a function</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a04a78af118c9a50e87c37af8fbd9a49/8bd7c/tdd-bug-fail-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUElEQVQoz4VS2W6DQAzkOxpg73tZAjkapU3V//+pqXYhiKDSPozGxt7R2Lg6Xa5IwwmUS9QtRU3YxBs0hC1oV3Ez9z/jqrMe95gwKoNEGQbG0VOOSDm6mY+Uw1IGSRgMZdCEQZGJxVawpgyUMgjKS1HOTWxmPjPZuNp1KKwCMRJEKDSU45AbdvCX4LNeBRcxHEcwoXBoCN5WWPK6LfEemtXeK6kMPj8euN3uSF2PGLoCZz2cC/A+IsVUYm09fK75COMCrI/Q1r2OnHeWlEbQFicfMWQ4j8EFdC4guVBiry2EMmBclot4gjDxKsiVgTQOVKiyx5YLkNyc8/lRu3q0d1LLyC50eHx9YxjPkwOhiovCWZSJhbf3+OtfVpTjvetxOY649QOuGanHOSYMMaEPXcmDccXpVmCLKrtReWxloLWFlLpA6elbhpAalPHi8j/BH1MvNX+yZlfLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 5\"\n        title=\"tdd bug fail 5\"\n        src=\"/static/a04a78af118c9a50e87c37af8fbd9a49/5a190/tdd-bug-fail-5.png\"\n        srcset=\"/static/a04a78af118c9a50e87c37af8fbd9a49/772e8/tdd-bug-fail-5.png 200w,\n/static/a04a78af118c9a50e87c37af8fbd9a49/e17e5/tdd-bug-fail-5.png 400w,\n/static/a04a78af118c9a50e87c37af8fbd9a49/5a190/tdd-bug-fail-5.png 800w,\n/static/a04a78af118c9a50e87c37af8fbd9a49/8bd7c/tdd-bug-fail-5.png 845w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The reason for this is the <code>validator</code> module currently only exposes the <code>processFile</code> method in its exports. Strictly speaking that's the only \"public\" method needed for the module because it's only used by the <code>expense</code> module, which only calls <code>processFile</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Only one function is public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, in order to unit test the <code>validateLine</code> method of the <code>validator</code> module, it must also be exposed in the <code>module.exports</code> section, effectively making it public. This is one of the few times that I miss Java, where the <code>default</code> and <code>protected</code> <a href=\"https://www.programiz.com/java-programming/access-modifiers\">access modifiers</a> are perfect for this purpose. A method can be marked <code>default</code> or <code>protected</code> to give it package level visibility, which makes it available to the test which lives in the same package, but doesn't make it <code>public</code> to the entire program.</p>\n<p>One way around this in JavaScript is to extract out the method to be tested into yet another module, say <code>validator-details.js</code>, expose that method publicly in the new module, then have the <code>validator</code> module call out to <code>validator-details</code> module. However, this feels like way too much overhead for this purpose so I'm simply going to add <code>validateLine</code> to the list of public methods in the <code>validator</code> module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NOW validateLine can be unit tested</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validateLine,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And this makes the tests pass, including the new tests in <code>test/lib/validator.test.js</code></p>\n<h2>More Validation: Numeric Amount</h2>\n<p>The last validation to add is to ensure the spending amount provided in each csv line is numeric. Now that we have lower level unit testing set up for the <code>validator</code> module, let's add this test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/validator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validateLine&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> output;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">beforeEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets errors when number of fields is greater than 4 and date field is invalid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when number of fields is less than 4&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NEW TEST HERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when amount is not numeric&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04-27&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;1o7.e8&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-27,1o7.e8,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Amount must be numeric.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>At this point, the test will fail because numeric amount validation has not yet been implemented. So the <code>lineErrors</code> property of the <code>output</code> object will be an empty array rather than the expected error:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2f1badec3504d40fc0b3fa0932cdaef8/2b2c6/tdd-bug-fail-6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGElEQVQoz42TW3LDMAhFvY5YsgRCDz/SdjL960z3v6vbAcdu2iapP65AeHxACHWeGEPLGEoGscAH+iM3xLvxe+oiJbxMM5b5jCEynA/ofTCI+qojoC1pp0udFnx8fOLt8o46L2jTAinN4nWcV/g/2qCdLhwJY6uYc8FrylhSRmVZbRJIIIyRUQOh3Ehj/LtCdYYkcCVjCAR5kP3wkdUJmj1n1CwgYnj9aDCCCzc6dGR1mNHXjNNlNuuI4TgZxOul+GsC3T+o2G23bEAFEON0HlctzWw/VUtgSVLaoc/asFeoP6yVXX21kuBE0GdZ91uVT6BrDynB2wzGvX8/ZPFjg27AyILSJpQ22tzpDJY6Iu9qoPT9kp4BvwBNtS8xkKvS9QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 6\"\n        title=\"tdd bug fail 6\"\n        src=\"/static/2f1badec3504d40fc0b3fa0932cdaef8/5a190/tdd-bug-fail-6.png\"\n        srcset=\"/static/2f1badec3504d40fc0b3fa0932cdaef8/772e8/tdd-bug-fail-6.png 200w,\n/static/2f1badec3504d40fc0b3fa0932cdaef8/e17e5/tdd-bug-fail-6.png 400w,\n/static/2f1badec3504d40fc0b3fa0932cdaef8/5a190/tdd-bug-fail-6.png 800w,\n/static/2f1badec3504d40fc0b3fa0932cdaef8/2b2c6/tdd-bug-fail-6.png 869w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>For implementation, there's plenty of JavaScript <a href=\"https://www.wikitechy.com/tutorials/javascript/validate-decimal-numbers\">solutions</a> to verify if a given input is a decimal number. Since the Tidysum app is already using <a href=\"https://github.com/MikeMcl/decimal.js/\">decimal.js</a>, I decided to make use of that library's parsing, which throws an error if the input cannot be parsed to a numeric. Note that all values come in as strings from csv parsing, so the solution needs to consider <code>'123.45'</code> to be valid, but <code>'123abc'</code> is not.</p>\n<p>Here is the updated validator module with numeric amount validation added:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> moment </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;moment&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> Decimal </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimal.js&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate number of fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate date format</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk5\">moment</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">], </span><span class=\"mtk6\">&#39;YYYY-MM-DD&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk5\">isValid</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Date format must be YYYY-MM-DD.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEWLY ADDED: Validate numeric amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">catch</span><span class=\"mtk1\"> (_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Amount must be numeric.&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validateLine,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And now the tests pass.</p>\n<p>One last test that should be added is to pass in a valid line, and ensure that no errors are reported. This is to make sure there's no false negative in the validation code - i.e. flagging a valid line as invalid:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/validator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validateLine&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> output;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">beforeEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets errors when number of fields is greater than 4 and date field is invalid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when number of fields is less than 4&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when amount is not numeric&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NEW TEST HERE: Valid scenario</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;does not report any errors when input line is valid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04-05&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;78.34&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>And this test passes as well.</p>\n<p>Good, all validation is now implemented. But not quite ready to call it a day.</p>\n<h2>Refactoring: Extract Validation Methods</h2>\n<p>It's time to do just a little more refactoring. Looking at the validator module, there's a few things bothering me:</p>\n<ol>\n<li>The <code>validateLine</code> function has gotten too long, it has the details of 3 different validations, and each one has a comment describing what it does. It would be cleaner to extract each of these to a separate method, and name the method to match the comment, then the comments can be removed.</li>\n<li>There are several hard-coded values: <code>4</code> for number of fields, and <code>YYYY-MM-DD</code> for date format. It would be cleaner to extract these as constants.</li>\n</ol>\n<p>Again we can rely on the tests here. It's safe to re-arrange the code to make any internal improvements, and as long as the tests are still passing, can be confident that the code is still working as expected.</p>\n<p>Here is the refactored validation module with individual methods to implement each validation rule, and hard-coded values extracted as constants:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> NUM_FIELDS </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> DATE_FORMAT </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;YYYY-MM-DD&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Call out to individual validation methods for each rule</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">validateNumFields</span><span class=\"mtk1\">(line, lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">validateDateFormat</span><span class=\"mtk1\">(line, lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">validateNumeric</span><span class=\"mtk1\">(line, lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// If found at least one thing wrong with this line, add it to the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (lineErrorEntry.errors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateNumFields</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">lineErrorEntry</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> NUM_FIELDS) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected </span><span class=\"mtk7\">${</span><span class=\"mtk1\">NUM_FIELDS</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateDateFormat</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">lineErrorEntry</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk5\">moment</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">], DATE_FORMAT, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk5\">isValid</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Date format must be </span><span class=\"mtk7\">${</span><span class=\"mtk1\">DATE_FORMAT</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateNumeric</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">lineErrorEntry</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">catch</span><span class=\"mtk1\"> (_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Amount must be numeric.&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validateLine,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And all the tests are still passing, hurray!</p>\n<h2>Summary</h2>\n<p>This post has walked you through a practical example of using TDD to fix a bug, and apply refactoring to improve the design of the code, while relying on the tests to confirm the code still works as expected. In general the process is as follows:</p>\n<ol>\n<li>Analyze the code to find where/how/why the bug is occurring.</li>\n<li>Define expectations about how the code should behave.</li>\n<li>Write a test that fails because of the bug.</li>\n<li>Write some code to make the test pass.</li>\n<li>Refactor and re-run tests as needed.</li>\n</ol>\n<p>I hope this has inspired you to try out TDD next time you're faced with a bug. Good luck and happy coding!</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>You've seen a few simple examples of refactoring in this blog post. Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is the go-to book to learn all about this topic.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","title":"TDD by Example: Fixing a Bug","description":"A practical example of using TDD to fix a bug and do some refactoring on an existing project."}},
    "staticQueryHashes": ["163244226"]}