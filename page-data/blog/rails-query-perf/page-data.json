{"componentChunkName":"component---src-templates-post-js","path":"/blog/rails-query-perf/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">This post will walk through a step-by-step approach to PostgreSQL query enhancement in Rails applications. From indexing strategies to running migrations without downtime, to efficient column selection, you'll learn some techniques to ensure optimal query performance.</p>\n<h2 class=\"markdown-subtitle\" id=\"getting-started\" style=\"position:relative;\"><a href=\"#getting-started\" aria-label=\"getting started permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Getting Started</h2>\n<p class=\"markdown-para\">To get started quicker with a Rails application, schema design, and data, I've forked the <a href=\"https://github.com/andyatkinson/rideshare\" class=\"markdown-link\">Rideshare Rails application</a> on GitHub. This is used for exercises in the book <em class=\"markdown-emphasis\">High Performance PostgreSQL for Rails</em>. I had the opportunity to provide a technical review for the beta version of this book. Many insights shared in this post are derived from the lessons learned during that review process. If you're interested in the book, it can be <a href=\"https://pragprog.com/titles/aapsql/high-performance-postgresql-for-rails/\" class=\"markdown-link\">purchased here</a>.</p>\n<h2 class=\"markdown-subtitle\" id=\"introducing-rideshare\" style=\"position:relative;\"><a href=\"#introducing-rideshare\" aria-label=\"introducing rideshare permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introducing Rideshare</h2>\n<p class=\"markdown-para\">Rideshare is an API-only Rails application that implements a portion of a fictional rideshare service. Think of Uber or Lyft. The core Rideshare models are Drivers, Riders, Trips, Trip Requests. The database is PostgreSQL. The schema is shown below and was generated with the <a href=\"https://github.com/voormedia/rails-erd\" class=\"markdown-link\">rails-erd</a> gem:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABk0lEQVR42o2Uh27CQAyG8/4PR1ERFaWMEvbKuiQXpqvPkk+FFkSQFcdn//49jugqj38858tZsjyTqq7+nNnz2x5drhc5nU83gg0g9MPxIPPFXCbxRMqqFN94qX2tOm8SeV+rjn9kDkhzaNQRgN1+FwAAJYElh8lsPpPx91iKogh2MCLvvRrWm7UaCGy9tWS5Wmog34UrAts8z7XM4Wgo7XZb46wFCggraCNaQlVKHMeSZamyw44POm9jC7vuR1eBt7utJiU2At16hjPfBOZ5FkpxpQstOJ6OYUjo+EKEhGDoUAyEg812I0maSF7kMp1NZbFcKAPOASABuk33ftoB0EoCYJ/slS0ldTrv2ifnCmUKM2IeSQCELiUBiqRZqmUCQH9gybn5379v9tBKtqZTGsGshjWcNlDFM7AbQLsJBAMMY0ruf/UlSfbau/8YPgSEmU2raRpxzslgOJDVehV6Z1tg/XoKCCPbN1tgJm6tQOyWvARo93I0HuktAbj32dPVseXG52VAu4vGBp0Fplz7I3iF4Q/KHY+rKqpDMQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rideshare erd\"\n        title=\"rideshare erd\"\n        src=\"/static/5504ed1250c163eb70262b0565cd925f/5a190/rideshare-erd.png\"\n        srcset=\"/static/5504ed1250c163eb70262b0565cd925f/772e8/rideshare-erd.png 200w,\n/static/5504ed1250c163eb70262b0565cd925f/e17e5/rideshare-erd.png 400w,\n/static/5504ed1250c163eb70262b0565cd925f/5a190/rideshare-erd.png 800w,\n/static/5504ed1250c163eb70262b0565cd925f/c1b63/rideshare-erd.png 1200w,\n/static/5504ed1250c163eb70262b0565cd925f/71e8d/rideshare-erd.png 1304w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Single Table Inheritance (<a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Inheritance.html\" class=\"markdown-link\">STI</a>) is used to represent both Drivers and Riders in the Users table. This means that rows where <code>users.type = 'Driver'</code> are Drivers, and can be joined to Trips on <code>driver_id</code>. Rows where <code>users.type = 'Rider'</code> are Riders, and can be joined to TripRequests on <code>rider_id</code>.</p>\n<p class=\"markdown-para\">Here are the corresponding model classes, only focusing on the associations between them:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">User</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:trip_request</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:driver</span><span class=\"mtk1\">, </span><span class=\"mtk4\">class_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;User&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:trip_positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  delegate </span><span class=\"mtk4\">:rider</span><span class=\"mtk1\">, </span><span class=\"mtk4\">to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:trip_request</span><span class=\"mtk1\">, </span><span class=\"mtk4\">allow_nil:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Location</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">TripRequest</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:rider</span><span class=\"mtk1\">, </span><span class=\"mtk4\">class_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;User&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:start_location</span><span class=\"mtk1\">, </span><span class=\"mtk4\">class_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Location&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:end_location</span><span class=\"mtk1\">, </span><span class=\"mtk4\">class_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Location&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_one </span><span class=\"mtk4\">:trip</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Generating Data</strong></p>\n<p class=\"markdown-para\">Rideshare comes with a task to generate sample data <code>bin/rails data_generators:generate_all</code>. I've modified it to generate 1000 Drivers and Riders, and 50,000 Trips and Trip Requests. I've also modified it to generate random variability in the <code>trips.completed_at</code> date from anywhere between 1 and 90 days ago. The data generator can be re-run at any time, but first run the truncate task <code>bin/rails db:truncate_all</code> to quickly remove all data.</p>\n<p class=\"markdown-para\">While generating fake data for testing purposes can provide a valuable simulation of a sizeable database, seeded data tends to be very efficiently laid out, sequentially. This results in an unrealistically high number of rows in fewer pages. When the data is packed so efficiently, performance can be good for sequential scans. An equivalent range of data that grew and churned organically in production over time via <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code>, statements will result in a more dispersed distribution of data across pages.</p>\n<p class=\"markdown-para\">Therefore, when addressing a specific performance issues encountered in a production database, it might be necessary to replicate the environment in a test setup, by copying relevant portions of production data to a separate testing environment. This may also require anonymizing sensitive data during the copy process. The <a class=\"markdown-link\" href=\"((https://pragprog.com/titles/aapsql/high-performance-postgresql-for-rails/))\">High Performance PostgreSQL for Rails</a> book goes through this exercise with an example <code>users</code> table.</p>\n<p class=\"markdown-para\">However, for the purpose of this blog post, we'll be focused on optimizing a query to meet a new business requirement, so we don't need to worry about the complexities of a live environment.</p>\n<h2 class=\"markdown-subtitle\" id=\"building-an-admin-report\" style=\"position:relative;\"><a href=\"#building-an-admin-report\" aria-label=\"building an admin report permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Building an Admin Report</h2>\n<p class=\"markdown-para\">We have a business requirement to create a dashboard type view for the admin team that manages Rideshare. They would like to have a view that shows recently completed trips. Each trip should display:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Trip completed date</li>\n<li class=\"markdown-list-item\">Rating given by the rider</li>\n<li class=\"markdown-list-item\">Driver that provided the trip</li>\n<li class=\"markdown-list-item\">Rider that took the trip</li>\n<li class=\"markdown-list-item\">Location where the trip started</li>\n</ul>\n<p class=\"markdown-para\">Being an API-only application, we will only focus on the query part of this logic, and assume a separate front end application will take care of rendering the report.</p>\n<h2 class=\"markdown-subtitle\" id=\"first-attempt\" style=\"position:relative;\"><a href=\"#first-attempt\" aria-label=\"first attempt permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First Attempt</h2>\n<p class=\"markdown-para\">Before getting into the complexity of joins to get all the data, let's first focus on the main requirement, which is to show recently completed trips. We can use the <code>completed_at</code> timestamp column on the <code>Trip</code> model in a scope as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:recently_completed</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;completed_at &gt;= ?&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">.</span><span class=\"mtk5\">week</span><span class=\"mtk1\">.</span><span class=\"mtk5\">ago</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's try this out in a Rails console <code>bin/rails c</code></p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Trip</span><span class=\"mtk1\">.</span><span class=\"mtk5\">recently_completed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SELECT &quot;trips&quot;.&quot;id&quot;, &quot;trips&quot;.&quot;trip_request_id&quot;, &quot;trips&quot;.&quot;driver_id&quot;, &quot;trips&quot;.&quot;completed_at&quot;, &quot;trips&quot;.&quot;rating&quot;, &quot;trips&quot;.&quot;created_at&quot;, &quot;trips&quot;.&quot;updated_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># FROM &quot;trips&quot; WHERE (completed_at &gt;= &#39;2024-01-10 12:29:18.260820&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 559</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># {&quot;id&quot;=&gt;6011,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;trip_request_id&quot;=&gt;6031,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;driver_id&quot;=&gt;61038,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;completed_at&quot;=&gt;Wed, 10 Jan 2024 07:12:42.960652000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;rating&quot;=&gt;nil,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;created_at&quot;=&gt;Wed, 10 Jan 2024 02:12:42.960652000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;updated_at&quot;=&gt;Wed, 10 Jan 2024 07:12:42.960652000 CST -06:00}</span></span></span></code></pre>\n<p class=\"markdown-para\">In development mode, the console output displays the SQL query that ActiveRecord generated when the scope was executed. To understand the efficiency of this query, we need to view the query execution plan. To do this, launch a database console with <code>bin/rails dbconsole</code> and then enter the SQL query that was generated by ActiveRecord, preceded by the <code>EXPLAIN (ANALYZE)</code> command at the psql prompt:</p>\n<aside class=\"markdown-aside\">\n`bin/rails dbconsole` uses the database connection information specified in `config/database.yml` to make a connection to the database your project is using. Since this project uses PostgreSQL, it's equivalent to running `psql postgresql://role:password@host:port/database_name`. If `password` isn't specified in the database url, then Postgres will prompt for it or you can save the password in `~/.pgpass`. For even less typing, the alias `bin/rails db` can be used.\n</aside>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;trip_request_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;driver_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;completed_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;rating&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;created_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;updated_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (completed_at </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 12:29:18.260820&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">--                               QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-- ------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Seq Scan on trips  (cost=0.00..1106.00 rows=3521 width=48) (actual time=0.013..11.413 rows=3863 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Filter: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Rows Removed by Filter: 46137</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Planning Time: 1.193 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Execution Time: 11.880 ms</span></span></code></pre>\n<p class=\"markdown-para\">In PostgreSQL, the <code>EXPLAIN</code> statement is used to analyze and show the execution plan of a SQL query. It shows how the database engine is planning to execute the query, such as which indexes will be used and estimated costs. The cost is a unit-less value representing the estimated computational effort required for the operation. Lower values are generally better.</p>\n<p class=\"markdown-para\">While <code>EXPLAIN</code> can be run on its own, its typically used together with the <code>ANALYZE</code> option. This option tells PostgreSQL to actually execute the query, so the output will include statistics such as the number of rows processed, and execution time.</p>\n<p class=\"markdown-para\">From the output above we can see that a sequential scan was performed to retrieve rows from the <code>trips</code> table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Seq Scan on trips  (cost=0.00..1106.00 rows=3521 width=48) (actual time=0.013..11.413 rows=3863 loops=1)</span></span></code></pre>\n<p class=\"markdown-para\">It also shows that the query took nearly 12 ms to execute, which is relatively slow for such a simple query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 11.880 ms</span></span></code></pre>\n<p class=\"markdown-para\">A sequential scan means that PostgreSQL reads the entire table, and <em class=\"markdown-emphasis\">then</em> filters the rows out that match the query conditions. The number of rows removed by filtering are shown in the execution plan:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Filter: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Rows Removed by Filter: 46137</span></span></code></pre>\n<aside class=\"markdown-aside\">\nThere's more nuance here in that this particular query doesn't have a `LIMIT` clause. When that's present, PostgreSQL will \"short circuit\" and stop processing when it finds enough matches. See this post that digs deeper into <a class=\"markdown-link\" href=\"https://andyatkinson.com/blog/2024/01/25/PostgreSQL-rows-removed-by-filter-meaning\">Rows Removed By Filter</a>.\n</aside>\n<p class=\"markdown-para\">To understand why a slow sequential scan is being used to filter <code>trips</code> rows based on <code>completed_at</code>, we can take a look at the <code>trips</code> table schema. Still in the database console, the <code>\\d table_name</code> meta-command can be used to display any table schema:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=&gt; \\d trips</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                           Table &quot;rideshare.trips&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     Column      |              Type              | Collation | Nullable |              Default</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-----------------+--------------------------------+-----------+----------+-----------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> id              | bigint                         |           | not null | nextval(&#39;trips_id_seq&#39;::regclass)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> trip_request_id | bigint                         |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> driver_id       | integer                        |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> completed_at    | timestamp without time zone    |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> rating          | integer                        |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> created_at      | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> updated_at      | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;trips_pkey&quot; PRIMARY KEY, btree (id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_trips_on_driver_id&quot; btree (driver_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_trips_on_rating&quot; btree (rating)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_trips_on_trip_request_id&quot; btree (trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Check constraints:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;chk_rails_4743ddc2d2&quot; CHECK (completed_at &gt; created_at) NOT VALID</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;rating_check&quot; CHECK (rating &gt;= 1 AND rating &lt;= 5)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Foreign-key constraints:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;fk_rails_6d92acb430&quot; FOREIGN KEY (trip_request_id) REFERENCES trip_requests(id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;fk_rails_e7560abc33&quot; FOREIGN KEY (driver_id) REFERENCES users(id)</span></span></code></pre>\n<p class=\"markdown-para\">The <code>Indexes</code> section of the output above lists all the indexes that are available on the <code>trips</code> table. Notice there is no index on <code>completed_at</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;trips_pkey&quot; PRIMARY KEY, btree (id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;index_trips_on_driver_id&quot; btree (driver_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;index_trips_on_rating&quot; btree (rating)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;index_trips_on_trip_request_id&quot; btree (trip_request_id)</span></span></code></pre>\n<p class=\"markdown-para\">While the existing query may be sufficient for the current scale, this operation will become progressively slower as the number of trips increases. This means that the overall efficiency and performance of the application may be negatively impacted over time.</p>\n<p class=\"markdown-para\">Improving the scalability of the application involves optimizing queries to be less resource-intensive, and adding an index to the <code>completed_at</code> column, is a step towards achieving this goal. Scaling, in this context, refers to the ability of the database system to handle a growing workload efficiently. By addressing the performance bottlenecks, such as slow sequential scans, the application can better leverage the capabilities of the PostgreSQL instance as the workload increases.</p>\n<p class=\"markdown-para\">So the next step in improving this query is to add an index, which can help with accessing the data at a lower cost.</p>\n<h2 class=\"markdown-subtitle\" id=\"second-attempt-add-index\" style=\"position:relative;\"><a href=\"#second-attempt-add-index\" aria-label=\"second attempt add index permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Second Attempt: Add Index</h2>\n<p class=\"markdown-para\">To add an index to an existing table in a Rails application, start by generating a database migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate migration AddIndexToTripsCompletedAt</span></span></span></code></pre>\n<p class=\"markdown-para\">Fill in the <code>change</code> method, specifying what table the index should be added to, and on what column:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20240111132403_add_index_to_trips_completed_at.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddIndexToTripsCompletedAt</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_index </span><span class=\"mtk4\">:trips</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:completed_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Run the migration with <code>bin/rails db:migrate</code>. However, in the Rideshare application, the migration is not applied due to the following error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Migrating to AddIndexToTripsCompletedAt (20240111132403)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">== 20240111132403 AddIndexToTripsCompletedAt: migrating =======================</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.7ms)  BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   (1.6ms)  SHOW server_version_num</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   (0.7ms)  SET statement_timeout TO 3600000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   (0.7ms)  SET lock_timeout TO 10000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.7ms)  ROLLBACK</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   (0.8ms)  SELECT pg_advisory_unlock(5537362570877065845)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails aborted!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">StandardError: An error has occurred, this and all later migrations canceled: (StandardError)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== Dangerous operation detected #strong_migrations ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Adding an index non-concurrently blocks writes. Instead, use:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">class AddIndexToTripsCompletedAt &lt; ActiveRecord::Migration[7.1]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  disable_ddl_transaction!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  def change</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    add_index :trips, :completed_at, algorithm: :concurrently</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  end</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">end</span></span></code></pre>\n<p class=\"markdown-para\">This error is coming from the <a href=\"https://github.com/ankane/strong_migrations\" class=\"markdown-link\">Strong Migrations</a> gem that is included in Rideshare. This gem prevents \"dangerous\" migrations from being added to the project.</p>\n<p class=\"markdown-para\">What makes this particular migration risky is that adding an index will lock the table that it's being added to, which means the application won't be able to read or write from/to the <code>trips</code> table while this migration is in progress. Since adding an index can take a long time on large tables, this will result in application errors.</p>\n<p class=\"markdown-para\">Since access to the <code>trips</code> table is critical to the functioning of the application, we can avoid potential downtime, by following the advice generated by the <a href=\"https://github.com/ankane/strong_migrations\" class=\"markdown-link\">Strong Migrations</a> gem. Notice the error message included how the migration should be written. Here is the corrected version:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddIndexToTripsCompletedAt</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  disable_ddl_transaction!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_index </span><span class=\"mtk4\">:trips</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:completed_at</span><span class=\"mtk1\">, </span><span class=\"mtk4\">algorithm:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:concurrently</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Specifying <code>algorithm: :concurrently</code> tells PostgreSQL to add the index without locking the table. This means the <code>trips</code> table can continue to be queried while the index is being added, which keeps the application responsive. The trade-off with <code>:concurrently</code> is that it makes the operation take about twice as long.</p>\n<p class=\"markdown-para\"><code>disable_ddl_transaction!</code> disables the transaction for DDL (Data Definition Language) statements, because the concurrent approach can't be executed inside a transaction.</p>\n<p class=\"markdown-para\">With this change in place, <code>bin/rails db:migrate</code> completes successfully and the index is now added.</p>\n<aside class=\"markdown-aside\">\nFor a small and less busy table, creating the index in the standard way (i.e., without using `:concurrently`) may be fine. The `strong_migrations` gem issues warnings for potentially risky database operations, prompting developers to assess the situation and decide whether additional precautions, like `:concurrently`, are necessary.\n</aside>\n<p class=\"markdown-para\">Now we can, once again, examine the execution plan for the completed trips query after adding the index:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;trip_request_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;driver_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;completed_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;rating&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;created_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;updated_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (completed_at </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 12:29:18.260820&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                                            QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-------------------------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Bitmap Heap Scan on trips  (cost=67.58..592.59 rows=3521 width=48) (actual time=0.724..3.849 rows=3863 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Recheck Cond: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Heap Blocks: exact=481</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..66.70 rows=3521 width=0) (actual time=0.603..0.604 --rows=3863 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          Index Cond: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Planning Time: 0.242 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Execution Time: 4.229 ms</span></span></code></pre>\n<p class=\"markdown-para\">This time the query planner is using the index on <code>completed_at</code> instead of a sequential scan. This is shown with the <code>Bitmap Index Scan</code> which indicates that the <code>index_trips_on_completed_at</code> index is being used:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-&gt;  Bitmap Index Scan on index_trips_on_completed_at...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Index Cond: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span></code></pre>\n<p class=\"markdown-para\">And the overall time to complete this query is just over 4ms, a significant improvement over the previous ~12ms when using a sequential scan:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 4.229 ms</span></span></code></pre>\n<p class=\"markdown-para\">This is because the index allows PostgreSQL to quickly locate and retrieve the relevant rows. Specifically, the index supports a faster filtering operation based on the query conditions. Note that since this isn't an <a href=\"https://www.postgresql.org/docs/current/indexes-index-only-scans.html\" class=\"markdown-link\">index-only scan</a>, a <code>Bitmap Heap Scan</code> was still required to access data from the table, which is shown in the first line of the query plan:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Bitmap Heap Scan on trips  (cost=67.58..592.59 rows=3521 width=48) (actual time=0.724..3.849 rows=3863 loops=1)</span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe query plan output can list many different operations, only a small number of which are covered in this post. PgMustard, a paid tool that helps to review query plans hosts a very useful <a class=\"markdown-link\" href=\"https://www.pgmustard.com/docs/explain\">EXPLAIN Glossary</a> with definitions of many of the terms shown in PostgreSQL plans.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"third-attempt-joins\" style=\"position:relative;\"><a href=\"#third-attempt-joins\" aria-label=\"third attempt joins permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Third Attempt: Joins</h2>\n<p class=\"markdown-para\">Now that use of <code>completed_at</code> is optimized, we can continue development of the admin dashboard query. Recall we also need to show driver and rider information, as well as the trip location. To do this, we'll use the ActiveRecord <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-joins\" class=\"markdown-link\">joins</a> method.</p>\n<p class=\"markdown-para\">To get location information, the Trip model must be joined to <code>trip_request</code>, which must then be joined to <code>start_location</code> via a nested join.</p>\n<p class=\"markdown-para\">Getting rider and driver information requires joining the <code>users</code> table twice, once for Riders (which are joined on <code>trip_request.rider_id</code>), and another time for Drivers (which are joined on <code>trips.driver_id</code>), due to use of Single Table Inheritance that models Drivers and Riders with the same underlying <code>users</code> table. This requires the use of a string join rather than just specifying the model.</p>\n<p class=\"markdown-para\">The same <code>where</code> clause as before is used to filter on recent trips.</p>\n<p class=\"markdown-para\">By default, the result of the ActiveRecord <code>joins</code> method will only select the columns from the model class on which its invoked, <code>Trip</code> in this case. But since the report needs to also show Driver, Rider, and Location information, this scope adds a <code>SELECT</code> clause to get all fields from all tables using the ActiveRecord <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-select\" class=\"markdown-link\">select</a> method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:recently_completed</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk4\">trip_request:</span><span class=\"mtk1\"> [</span><span class=\"mtk4\">:start_location</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;INNER JOIN users AS riders ON riders.id = trip_requests.rider_id&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;INNER JOIN users AS drivers ON drivers.id = trips.driver_id&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.completed_at &gt; ?&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">.</span><span class=\"mtk5\">week</span><span class=\"mtk1\">.</span><span class=\"mtk5\">ago</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.*, locations.*, drivers.*, riders.*&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is what it looks like in a Rails console. Note that even though <code>results</code> is a relation of Trip models, each instance contains attributes from trips, locations, and users tables. However, since both drivers and riders are actually from the same <code>users</code> table, the last one pulled in (<code>riders</code> in this case) \"wins\" and so the result only has the rider attributes. This is due to the order in which the attributes are selected in the SQL query and will be addressed in the next section.</p>\n<p class=\"markdown-para\">I've added <code>===</code> comments to highlight which model each set of attributes comes from:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Trip</span><span class=\"mtk1\">.</span><span class=\"mtk5\">recently_completed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Trip Load (2.5ms)  SELECT trips.*, locations.*, drivers.*, riders.*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># FROM &quot;trips&quot; INNER JOIN &quot;trip_requests&quot; ON &quot;trip_requests&quot;.&quot;id&quot; = &quot;trips&quot;.&quot;trip_request_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># INNER JOIN &quot;locations&quot; ON &quot;locations&quot;.&quot;id&quot; = &quot;trip_requests&quot;.&quot;start_location_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># INNER JOIN users AS riders ON riders.id = trip_requests.rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># INNER JOIN users AS drivers ON drivers.id = trips.driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># WHERE (trips.completed_at &gt; &#39;2024-01-10 12:20:01.192132&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 559</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   === TRIP ATTRIBUTES ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;id&quot;=&gt;61943,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;trip_request_id&quot;=&gt;56017,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;driver_id&quot;=&gt;60456,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;completed_at&quot;=&gt;Wed, 10 Jan 2024 07:21:26.462838000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rating&quot;=&gt;5,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   === LOCATION ATTRIBUTES ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;address&quot;=&gt;&quot;New York, NY&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;city&quot;=&gt;nil,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;state&quot;=&gt;&quot;NY&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;position&quot;=&gt;#&lt;struct ActiveRecord::Point x=40.7143528, y=-74.0059731&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   === USER AS RIDER ATTRIBUTES ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;first_name&quot;=&gt;&quot;Shantelle&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;last_name&quot;=&gt;&quot;Kris&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;email&quot;=&gt;&quot;Shantelle-Kris-522@email.com&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;type&quot;=&gt;&quot;Rider&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;password_digest&quot;=&gt;&quot;$2a$12...&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;trips_count&quot;=&gt;nil,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;drivers_license_number&quot;=&gt;nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># }</span></span></span></code></pre>\n<p class=\"markdown-para\">Now this query can be analyzed in a database console session <code>bin/rails dbconsole</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    trips.</span><span class=\"mtk7\">*</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    locations.</span><span class=\"mtk7\">*</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    drivers.</span><span class=\"mtk7\">*</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    riders.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trip_requests&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trip_requests&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;trip_request_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;locations&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;locations&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trip_requests&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;start_location_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> riders </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> drivers </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 12:05:39.639423&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                       QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Hash Join  (cost=1399.44..2692.88 rows=524 width=453) (actual time=11.736..24.510 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Hash Cond: (trips.driver_id = drivers.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Nested Loop  (cost=529.22..1821.28 rows=524 width=294) (actual time=1.109..13.507 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Hash Join  (cost=528.93..1643.10 rows=524 width=139) (actual time=1.085..12.227 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                Hash Cond: (trip_requests.start_location_id = locations.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                -&gt;  Hash Join  (cost=527.89..1637.76 rows=524 width=56) (actual time=1.054..11.992 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      Hash Cond: (trip_requests.id = trips.trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Seq Scan on trip_requests  (cost=0.00..917.10 rows=50010 width=16) (actual time=0.004..4.868 rows=50010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Hash  (cost=521.34..521.34 rows=524 width=48) (actual time=1.028..1.032 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                            Buckets: 1024  Batches: 1  Memory Usage: 53kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                            -&gt;  Bitmap Heap Scan on trips  (cost=12.35..521.34 rows=524 width=48) (actual time=0.116..0.896 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  Recheck Cond: (completed_at &gt; &#39;2024-01-10 12:05:39.639423&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  Heap Blocks: exact=328</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..12.22 rows=524 width=0) (actual time=0.060..0.060 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                        Index Cond: (completed_at &gt; &#39;2024-01-10 12:05:39.639423&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                -&gt;  Hash  (cost=1.02..1.02 rows=2 width=87) (actual time=0.019..0.021 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      Buckets: 1024  Batches: 1  Memory Usage: 9kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Seq Scan on locations  (cost=0.00..1.02 rows=2 width=87) (actual time=0.011..0.013 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Index Scan using users_pkey on users riders  (cost=0.29..0.34 rows=1 width=159) (actual time=0.002..0.002 rows=1 loops=559)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                Index Cond: (id = trip_requests.rider_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Hash  (cost=595.10..595.10 rows=22010 width=159) (actual time=10.601..10.601 rows=22010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          Buckets: 32768  Batches: 1  Memory Usage: 3221kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Seq Scan on users drivers  (cost=0.00..595.10 rows=22010 width=159) (actual time=0.021..4.849 rows=22010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Planning Time: 1.046 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Execution Time: 24.936 ms</span></span></code></pre>\n<p class=\"markdown-para\">The SQL explain plan above shows this is a more complex query than the previous attempts. It includes many more operations than can be covered in this post, so we'll only be focusing on the join operations.</p>\n<p class=\"markdown-para\">Execution time has gone up, even though the query is still using the index on <code>trips.completed_at</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 24.936 ms</span></span></code></pre>\n<p class=\"markdown-para\">This is in part due to the multiple joins. Joins between tables are expressed in the plan as a combination of a <code>Hash</code> node, a <code>Hash Join</code> which implements the join details, and a <code>Hash Cond</code>, which shows the conditions that were used to perform the join, using the <code>Hash</code> node.</p>\n<p class=\"markdown-para\">For example, the join from the <code>trips</code> table to the <code>trip_requests</code> table is shown in the plan as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-&gt;  Hash Join  (cost=527.89..1637.76 rows=524 width=56) (actual time=1.054..11.992 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Hash Cond: (trip_requests.id = trips.trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      -&gt;  Hash  (cost=521.34..521.34 rows=524 width=48) (actual time=1.028..1.032 rows=559 loops=1)</span></span></code></pre>\n<p class=\"markdown-para\">Here's a definition of the Hash Join operation from the <a href=\"https://www.pgmustard.com/docs/explain/hash-join\" class=\"markdown-link\">pgMustard glossary</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">An implementation of join in which one of the collections of rows to be joined is hashed on the join keys using a separate 'Hash' node. PostgreSQL then iterates over the other collection of rows, for each one looking it up in the hash table to see if there are any rows it should be joined to.</p>\n</blockquote>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">CAUTION:</strong> When using joins, there should be an index on each foreign key column. In the example above, these are: <code>trips.trip_request_id</code>, <code>trip_requests.start_location_id</code>, <code>trip_requests.rider_id</code>, and <code>trips.driver_id</code>. If you used <code>references</code> when generating the migration with Rails, or specified <code>t.references :some_model, foreign_key: true</code> in the Rails migration file, then Rails (as of 5.2) will automatically generate an index on that column in addition to the foreign key constraint. In the Rideshare schema, all foreign keys are indexed.</p>\n<p class=\"markdown-para\">This version of the query is also fetching more data due to the <code>SELECT</code> clause specifying all columns on all tables in the joins:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">.</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.*, locations.*, drivers.*, riders.*&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">Another way to improve performance is to reduce the \"width\" of the results.</p>\n<h2 class=\"markdown-subtitle\" id=\"fourth-attempt-reduce-columns\" style=\"position:relative;\"><a href=\"#fourth-attempt-reduce-columns\" aria-label=\"fourth attempt reduce columns permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fourth Attempt: Reduce Columns</h2>\n<p class=\"markdown-para\">The previous query selected all columns from all of the joined tables. For example, each result was including user details such as password digest and drivers license number. But recall the business requirements were that we only need to display a subset of user and trip information.</p>\n<p class=\"markdown-para\">Let's \"narrow\" the amount of data by restricting the columns in the <code>SELECT</code> clause to only what we need. This also supports string concatenation to distinguish between driver and rider names:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:recently_completed</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk4\">trip_request:</span><span class=\"mtk1\"> [</span><span class=\"mtk4\">:start_location</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;INNER JOIN users AS riders ON riders.id = trip_requests.rider_id&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;INNER JOIN users AS drivers ON drivers.id = trips.driver_id&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;trips.completed_at &gt; ?&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">.</span><span class=\"mtk5\">week</span><span class=\"mtk1\">.</span><span class=\"mtk5\">ago</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.completed_at, trips.rating, locations.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">               CONCAT(drivers.first_name, &#39; &#39;, drivers.last_name) driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">               CONCAT(riders.first_name, &#39; &#39;, riders.last_name) rider_name&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nAs of Rails 7.1, the `select` method can <a class=\"markdown-link\" href=\"https://blog.kiprosh.com/rails-7-1-allows-activerecord-querymethods-select-and-reselect-to-receive-hash-values/\">accept a hash of columns and aliases</a> rather than raw SQL when specifying columns from the join tables. However, if the `select` uses SQL functions as in this case where concatenation is used to generate the driver and rider names, then raw SQL is still required.\n</aside>\n<p class=\"markdown-para\">Running this query in the Rails console shows the attributes contain exactly what's needed to display in the view, with no extraneous data.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Trip</span><span class=\"mtk1\">.</span><span class=\"mtk5\">recently_completed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;completed_at&quot; =&gt; Wed, 10 Jan 2024 07:12:42.960652000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rating&quot; =&gt; nil,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;address&quot; =&gt; &quot;New York, NY&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;driver_name&quot; =&gt; &quot;Rasheeda Brakus&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rider_name&quot; =&gt; &quot;Corina Gorczany&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;id&quot; =&gt; nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># }</span></span></span></code></pre>\n<p class=\"markdown-para\">Again we can view the query execution plan:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">CONCAT</span><span class=\"mtk1\">(</span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\">) driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">CONCAT</span><span class=\"mtk1\">(</span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\">) rider_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> trips</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> trip_requests </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">trip_request_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> locations </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">start_location_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> riders </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> drivers </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 12:27:19.062944&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                         QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Hash Join  (cost=1398.27..2693.98 rows=516 width=88) (actual time=8.572..20.188 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Hash Cond: (trips.driver_id = drivers.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Nested Loop  (cost=528.05..1817.24 rows=516 width=41) (actual time=1.246..12.363 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Hash Join  (cost=527.76..1641.78 rows=516 width=32) (actual time=1.224..11.156 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                Hash Cond: (trip_requests.start_location_id = locations.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                -&gt;  Hash Join  (cost=526.71..1636.51 rows=516 width=24) (actual time=1.191..10.985 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      Hash Cond: (trip_requests.id = trips.trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Seq Scan on trip_requests  (cost=0.00..917.10 rows=50010 width=16) (actual time=0.005..4.199 rows=50010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Hash  (cost=520.26..520.26 rows=516 width=24) (actual time=1.167..1.174 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                            Buckets: 1024  Batches: 1  Memory Usage: 38kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                            -&gt;  Bitmap Heap Scan on trips  (cost=12.29..520.26 rows=516 width=24) (actual time=0.138..1.060 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  Recheck Cond: (completed_at &gt; &#39;2024-01-10 12:27:19.062944&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  Heap Blocks: exact=328</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..12.16 rows=516 width=0) (actual time=0.081..0.081 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                        Index Cond: (completed_at &gt; &#39;2024-01-10 12:27:19.062944&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                -&gt;  Hash  (cost=1.02..1.02 rows=2 width=20) (actual time=0.020..0.021 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      Buckets: 1024  Batches: 1  Memory Usage: 9kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Seq Scan on locations  (cost=0.00..1.02 rows=2 width=20) (actual time=0.012..0.013 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Index Scan using users_pkey on users riders  (cost=0.29..0.34 rows=1 width=21) (actual time=0.002..0.002 rows=1 loops=559)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                Index Cond: (id = trip_requests.rider_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Hash  (cost=595.10..595.10 rows=22010 width=21) (actual time=7.296..7.296 rows=22010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          Buckets: 32768  Batches: 1  Memory Usage: 1492kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Seq Scan on users drivers  (cost=0.00..595.10 rows=22010 width=21) (actual time=0.007..3.716 rows=22010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Planning Time: 1.649 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Execution Time: 20.553 ms</span></span></code></pre>\n<p class=\"markdown-para\">This time the performance is slightly improved:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 20.553 ms</span></span></code></pre>\n<p class=\"markdown-para\">It still needs to perform all the joins, but less overall data is being fetched from the database. This can be observed by the smaller <code>width</code> attribute in the <code>Hash Join</code> operations. The <code>width</code> refers to the total number of bytes required to store the output of the join operation, and is proportional to the number of columns in the <code>SELECT</code> clause.</p>\n<p class=\"markdown-para\">For example, focusing on the top level Hash Join operation, this query has a width of 88:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Hash Join  (cost=1398.27..2693.98 rows=516 width=88) (actual time=8.572..20.188 rows=559 loops=1)</span></span></code></pre>\n<p class=\"markdown-para\">Whereas the <a href=\"../rails-query-perf#third-attempt-joins\" class=\"markdown-link\">previous version of the query</a> where all columns from all tables were being retrieved shows an overall width of 453:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Hash Join  (cost=1399.44..2692.88 rows=524 width=453) (actual time=11.736..24.510 rows=559 loops=1)</span></span></code></pre>\n<p class=\"markdown-para\">Selecting only the necessary columns can lead to performance improvements including reduced disk I/O and smaller memory requirements.</p>\n<h2 class=\"markdown-subtitle\" id=\"fifth-attempt-reduce-rows\" style=\"position:relative;\"><a href=\"#fifth-attempt-reduce-rows\" aria-label=\"fifth attempt reduce rows permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fifth Attempt: Reduce Rows</h2>\n<p class=\"markdown-para\">Another way to improve performance is to reduce the total number of rows returned by the query with additional filters (i.e. SQL <code>WHERE</code> clauses). This could require some discussion between engineering and product teams to make sure everyone understands the business problem that is being solved.</p>\n<p class=\"markdown-para\">In this case, it turns out the Rideshare admins want to focus only on recent trips with <em class=\"markdown-emphasis\">low ratings</em>, so they can investigate what happened on some of those trips to improve customer experience. They've defined a \"low\" rating as 3 or fewer stars, based on a 5 star rating system. Up until now, they've been sorting the results client side by rating, and investigating those.</p>\n<p class=\"markdown-para\">Given this better understanding of the requirements, another <code>WHERE</code> condition can be added to the scope, to only retrieve trips where the rating is less than or equal to 3.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">CAUTION:</strong> When adding further <code>WHERE</code> clauses to reduce the amount of data being returned, always check whether there's an index on the column you're planning to filter by. Otherwise, you could inadvertently make performance worse while trying to improve it! In this case, there already is an index on <code>trips.rating</code>. We saw this <a href=\"../rails-query-perf#first-attempt\" class=\"markdown-link\">earlier</a> when inspecting the table schema with <code>\\d trips</code> in the database console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=&gt; \\d trips</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;index_trips_on_rating&quot; btree (rating)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ...</span></span></code></pre>\n<p class=\"markdown-para\">Here is the modified scope adding an additional <code>WHERE</code> clause on <code>trip.rating</code> to only retrieve low ratings</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:recently_completed</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk4\">trip_request:</span><span class=\"mtk1\"> [</span><span class=\"mtk4\">:start_location</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;INNER JOIN users AS riders ON riders.id = trip_requests.rider_id&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;INNER JOIN users AS drivers ON drivers.id = trips.driver_id&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;trips.completed_at &gt; ?&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">.</span><span class=\"mtk5\">week</span><span class=\"mtk1\">.</span><span class=\"mtk5\">ago</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;trips.rating &lt;= ?&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.completed_at, trips.rating, locations.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        CONCAT(drivers.first_name, &#39; &#39;, drivers.last_name) driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        CONCAT(riders.first_name, &#39; &#39;, riders.last_name) rider_name&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This time, the results are \"shaped\" the same as before because the <code>SELECT</code> columns are the same, but the total number of results is smaller. This also ensures the query only returns trips with ratings, as before, we were also getting results with <code>nil</code> ratings, i.e. where the customer didn't leave to leave a rating.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Trip</span><span class=\"mtk1\">.</span><span class=\"mtk5\">recently_completed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 78</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;completed_at&quot;=&gt;Mon, 22 Jan 2024 07:07:11.312416000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rating&quot;=&gt;2,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;address&quot;=&gt;&quot;New York, NY&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;driver_name&quot;=&gt;&quot;Bobbi Cronin&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rider_name&quot;=&gt;&quot;Anibal Hammes&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;id&quot;=&gt;nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># }</span></span></span></code></pre>\n<p class=\"markdown-para\">Explain/analyze the query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> rider_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> trips</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> trip_requests </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">trip_request_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> locations </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">start_location_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> riders </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> drivers </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 13:08:58.257990&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">AND</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                                QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Nested Loop  (cost=97.88..1340.17 rows=75 width=88) (actual time=0.514..1.937 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   Join Filter: (trip_requests.start_location_id = locations.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   Rows Removed by Join Filter: 78</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   -&gt;  Seq Scan on locations  (cost=0.00..1.02 rows=2 width=20) (actual time=0.012..0.015 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   -&gt;  Materialize  (cost=97.88..1336.34 rows=75 width=42) (actual time=0.247..0.937 rows=78 loops=2)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         -&gt;  Nested Loop  (cost=97.88..1335.96 rows=75 width=42) (actual time=0.488..1.819 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               -&gt;  Nested Loop  (cost=97.59..862.59 rows=75 width=33) (actual time=0.463..1.492 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     -&gt;  Nested Loop  (cost=97.30..837.09 rows=75 width=24) (actual time=0.449..1.240 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                           -&gt;  Bitmap Heap Scan on trips  (cost=97.01..298.02 rows=75 width=24) (actual time=0.436..0.645 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                 Recheck Cond: ((completed_at &gt; &#39;2024-01-10 13:08:58.25799&#39;::timestamp without time zone) AND (rating &lt;= 3))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                 Heap Blocks: exact=72</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                 -&gt;  BitmapAnd  (cost=97.01..97.01 rows=75 width=0) (actual time=0.419..0.421 rows=0 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                       -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..12.05 rows=501 width=0) (actual time=0.083..0.083 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                             Index Cond: (completed_at &gt; &#39;2024-01-10 13:08:58.25799&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                       -&gt;  Bitmap Index Scan on index_trips_on_rating  (cost=0.00..84.67 rows=7518 width=0) (actual time=0.314..0.314 rows=7531 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                             Index Cond: (rating &lt;= 3)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                           -&gt;  Index Scan using trip_requests_pkey on trip_requests  (cost=0.29..7.19 rows=1 width=16) (actual time=0.007..0.007 rows=1 loops=78)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                 Index Cond: (id = trips.trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     -&gt;  Index Scan using users_pkey on users riders  (cost=0.29..0.34 rows=1 width=21) (actual time=0.003..0.003 rows=1 loops=78)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                           Index Cond: (id = trip_requests.rider_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               -&gt;  Memoize  (cost=0.30..6.55 rows=1 width=21) (actual time=0.004..0.004 rows=1 loops=78)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Cache Key: trips.driver_id</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Cache Mode: logical</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Hits: 8  Misses: 70  Evictions: 0  Overflows: 0  Memory Usage: 9kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     -&gt;  Index Scan using users_pkey on users drivers  (cost=0.29..6.54 rows=1 width=21) (actual time=0.003..0.003 rows=1 loops=70)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                           Index Cond: (id = trips.driver_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Planning Time: 1.168 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Execution Time: 2.360 ms</span></span></code></pre>\n<p class=\"markdown-para\">This time the query execution time is just over 2ms, a significant improvement over the previous ~20ms. This is due to the additional filter condition <code>(rating &#x3C;= 3)</code> that reduces the number of rows that need to be processed in join operations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 2.360 ms</span></span></code></pre>\n<p class=\"markdown-para\">The <a href=\"https://www.pgmustard.com/docs/explain/bitmap-and\" class=\"markdown-link\">BitmapAnd</a> operation shows that both the indexes on <code>completed_at</code> and <code>rating</code> are being used. This operation combines bitmaps generated by Bitmap Index Scans, allowing information from more than one index to be quickly aggregated together.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-&gt;  BitmapAnd  (cost=97.01..97.01 rows=75 width=0) (actual time=0.419..0.421 rows=0 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..12.05 rows=501 width=0) (actual time=0.083..0.083 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Index Cond: (completed_at &gt; &#39;2024-01-10 13:08:58.25799&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  -&gt;  Bitmap Index Scan on index_trips_on_rating  (cost=0.00..84.67 rows=7518 width=0) (actual time=0.314..0.314 rows=7531 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Index Cond: (rating &lt;= 3)</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"visualize-query-plan\" style=\"position:relative;\"><a href=\"#visualize-query-plan\" aria-label=\"visualize query plan permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Visualize Query Plan</h2>\n<p class=\"markdown-para\">Understanding query plans can be challenging, especially when dealing with complex queries. However, there's a free web-based tool that can help make sense of them: <a href=\"https://explain.dalibo.com/\" class=\"markdown-link\">explain.dalibo.com</a>. Here's how to use it.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Prepare Your Query</strong>: Start by putting your query into a file. For instance, you can create a directory called <code>queries</code> and save your SQL query in a file within it. In addition to the <code>ANALYZE</code> argument that we've been using, also pass in <code>COSTS, VERBOSE, BUFFERS, FORMAT JSON</code> to <code>EXPLAIN</code> as shown below. This will include additional information in the query plan output, such as the amount of disk data that was fetched, and format the results as JSON:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- queries/recently_completed_trips.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE, COSTS, </span><span class=\"mtk7\">VERBOSE</span><span class=\"mtk1\">, BUFFERS, </span><span class=\"mtk9\">FORMAT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">JSON</span><span class=\"mtk1\">) </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> rider_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> trips</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> trip_requests </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">trip_request_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> locations </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">start_location_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> riders </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> drivers </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 13:08:58.257990&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">AND</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Run the Query</strong>: Execute the query from your terminal using <a href=\"https://www.postgresql.org/docs/current/app-psql.html\" class=\"markdown-link\">psql</a>, ensuring to redirect the output to a file. The <code>-XqAt</code> flags make the output machine-readable:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">psql -h 127.0.0.1 \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  -p 5432 -U owner \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  -d rideshare_development \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  -XqAt -f queries/recently_completed_trips.sql </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> queries/fifth.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># copy the contents of `queries/recently_completed_trips.json`</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Visualize Your Plan</strong>: Visit <a href=\"https://explain.dalibo.com/\" class=\"markdown-link\">explain.dalibo.com</a> and paste the generated plan text and query. Then, hit Submit. The tool will generate a visualization of your query plan. Here's an example of the visualization for the fifth attempt version of the query from this post. It shows the different types of scans that were used and how the data gets combined. The duration of each operation is also shown:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 92%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACMElEQVR42o1Uy27bQAz0//9TD0XRiw89pU5aoBBiy4keq31wX5JqZQpSlWzHDpADsVotd5bkDLkhInxkzrl1ZfPeQ2sDbQymacLbGxBCvPLbfAaMgdgcEYw3sM4hhCCgOafVl23zERC55dtDqQ5KKViroXWDTmsURYGnp194ePiJl5dXeHIwprsGvIxqAaVAqJoK1hKmacSQHch7Obe2hap/w7sX9DnAe/NxhMtqnEZnO9lzmjGmtaazH+FQHuHJIPiLlBcndiCanau6lqKPw4CYe9R1g8OhRN/3SLmH94Ry/wedqkD6GeTUDPieTf72wUv9+PI4juiHHtorYZj/DeOIGByMKuFNhZwjYkrY3NRNimtgnIW1dk2VH7DuvI8hyIPkeQ2S2SqbRRpKa9Rti378C2drAbZ2fqhtWwEYhgEp5RXgnJU7y2YBjNaC2hZRG0wpIsW4ngWJiJBzFhNdXuhv1aFcEAkYFLtH/Pj6DYfdDqlp4LQWEfNlJqRpGsQYEWIWkdM9QH65aRXKY4Xt9ju22y+oWiXp576XaEJMAsz6Y4K4Q/ieuw/ooZoCWhWYThnASdqJa5JiwjCehD36X6uUkkR5TSRdt55zRowdWbjGWJTHV6iug6keYfVMCAMszN+q46KGM2MkztIdWqF6PSCQxhAa5DgPhoXJm75/H+HZ5mHgrQJ1JXSzR/DhZkR9IsLrQ0deUt4fjvAi6ng3mnt2d9rwhOFxxXtmmYn4LOA/TQhe4txZOiIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fifth attempt visualized\"\n        title=\"fifth attempt visualized\"\n        src=\"/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/5a190/fifth-attempt-visualized.png\"\n        srcset=\"/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/772e8/fifth-attempt-visualized.png 200w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/e17e5/fifth-attempt-visualized.png 400w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/5a190/fifth-attempt-visualized.png 800w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/c1b63/fifth-attempt-visualized.png 1200w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/29007/fifth-attempt-visualized.png 1600w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/25e83/fifth-attempt-visualized.png 2302w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">You can also click on the down caret icon beside any node to get more details about that operation. For example, focusing on the <code>Bitmap Index Scan</code> for use of the rating index on the <code>trips</code> table:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 634px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIElEQVR42oWTeW/TQBDF8/3/AAHqdwJKm4AQqE3iI06dw3Ziey/fP7STplIBgVfPs3prv5mdY6aVRmuNqhXWOqyxGGOE83tnHdkxI8sy2Rtt5PwPaCMas6ZpqJXi7n7Ox0+fWXz9xny+4O7+niAM8c8wDkxMjNMo9rpG4SZgpDBQKcvMOYcXVVqxOxw4ZhnF6ST7rCgoq4osz7GNE/HfRa+ORsBYy6w0Z5blg4Rc1TX5qRBx1zRY57DOvsA1Dh/AKwhnabsG6wWtNTiraJ1B1xVF7nOlgQmmgcl7/wuGK8aL9ZzP5WxTKm7WFTfrknerkg9BxdvlmTePJ96vztwmB46HPcsg5GG1ZhkErKOIJE1fwadHBCutmUcJX5Yht89YhAm3q4hFlPAYbwiiiCCKCeOYx/WaeLslShLCzYbNdivWi/rizpRS7NIngmBNGAYE/oc4ZLuJGfqGfujphp6278T24yC2Gzr6oRNeMHR4rZlPfnE+sdkmKF1zdiPxaWCdDxxVR61rnnY7lDHyXbrfC5eeW7an5lKMpsF1zUXQ3zsrcuIkkQqXSpMeC7JSU2kjEXqnXd/RdK1Uvu1aXNdj2/7lBr5XJYf+tT8c+P7jp3h/2qWku5SqLlGqpmkbaYtrzyH1ny5dcGWnCy9t43uprCseliuOeU5eFNJztaoFXtBHMf1nvQj6e/t5rqqKuq4lDzLbSgnM80zLDP8L5jLLvwDAbuChRqYPNAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rails-postgres-perf-node-visualized\"\n        title=\"rails-postgres-perf-node-visualized\"\n        src=\"/static/53afa741576a3d1c859e34b508f1ba73/374ac/rails-postgres-perf-node-visualized.png\"\n        srcset=\"/static/53afa741576a3d1c859e34b508f1ba73/772e8/rails-postgres-perf-node-visualized.png 200w,\n/static/53afa741576a3d1c859e34b508f1ba73/e17e5/rails-postgres-perf-node-visualized.png 400w,\n/static/53afa741576a3d1c859e34b508f1ba73/374ac/rails-postgres-perf-node-visualized.png 634w\"\n        sizes=\"(max-width: 634px) 100vw, 634px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">With this tool, deciphering the details of PostgreSQL query plans becomes a little more approachable. Just be mindful that using it involves sharing your query and its plan publicly. If privacy is a concern regarding sharing your query and its plan publicly, consider using <a href=\"https://www.pgadmin.org/\" class=\"markdown-link\">pgAdmin</a>, an open-source administrative tool for PostgreSQL that you can install on your local machine, which also offers a visualization feature for query plans.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered techniques to enhance PostgreSQL query performance in Rails applications. We began by examining a query execution plan using the <code>EXPLAIN (ANALYZE)</code> feature to understand how PostgreSQL processes queries. We then explored indexing, covering the addition of an index for performance improvements and how to do so without causing downtime or table locking.</p>\n<p class=\"markdown-para\">Further into query optimization, we discussed the importance of careful column selection in the <code>SELECT</code> statement, demonstrating how narrowing down the retrieved data can improve performance. We then covered aligning database queries with business needs, illustrating how additional filters can reduce the number of processed rows and enhance scalability. Finally we learned how to visualize query plans with a free web-based tool. These strategies provide developers with the tools to create efficient and resilient Rails applications with PostgreSQL.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":26,"tableOfContents":"<ul>\n<li><a href=\"#getting-started\">Getting Started</a></li>\n<li><a href=\"#introducing-rideshare\">Introducing Rideshare</a></li>\n<li><a href=\"#building-an-admin-report\">Building an Admin Report</a></li>\n<li><a href=\"#first-attempt\">First Attempt</a></li>\n<li><a href=\"#second-attempt-add-index\">Second Attempt: Add Index</a></li>\n<li><a href=\"#third-attempt-joins\">Third Attempt: Joins</a></li>\n<li><a href=\"#fourth-attempt-reduce-columns\">Fourth Attempt: Reduce Columns</a></li>\n<li><a href=\"#fifth-attempt-reduce-rows\">Fifth Attempt: Reduce Rows</a></li>\n<li><a href=\"#visualize-query-plan\">Visualize Query Plan</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>","frontmatter":{"title":"Efficient Database Queries in Rails: A Practical Approach","date":"01 Mar 2024","description":"Explore a practical guide to optimizing database queries in Rails applications. Learn step-by-step enhancements, from indexing strategies to column selection.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#083858","images":{"fallback":{"src":"/static/456c5a98a74fd815a1cf5c800f73abc1/d730f/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg","srcSet":"/static/456c5a98a74fd815a1cf5c800f73abc1/b834a/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg 225w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/21c52/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg 450w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/d730f/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/456c5a98a74fd815a1cf5c800f73abc1/71a10/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.webp 225w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/901f1/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.webp 450w,\n/static/456c5a98a74fd815a1cf5c800f73abc1/5acd1/rails-query-perf-torsten-dederichs-p_c4k2pXkkk-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":599}}}},"fields":{"slug":"/blog/rails-query-perf/"}},"relatedP":{"edges":[{"node":{"id":"dd0209de-ae67-5936-afc4-ef653de147a6","frontmatter":{"title":"Homebrew Postgresql Service not Starting Resolved","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#987858","images":{"fallback":{"src":"/static/09c9f0e696bef656672d612a338e22c6/26528/postgresql-homebrew-nam-anh-QJbyG6O0ick-unsplash.jpg","srcSet":"/static/09c9f0e696bef656672d612a338e22c6/26528/postgresql-homebrew-nam-anh-QJbyG6O0ick-unsplash.jpg 300w,\n/static/09c9f0e696bef656672d612a338e22c6/43429/postgresql-homebrew-nam-anh-QJbyG6O0ick-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/09c9f0e696bef656672d612a338e22c6/5d6c3/postgresql-homebrew-nam-anh-QJbyG6O0ick-unsplash.webp 300w,\n/static/09c9f0e696bef656672d612a338e22c6/68dbc/postgresql-homebrew-nam-anh-QJbyG6O0ick-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/homebrew-postgresql-service-not-starting-resolved/"}}},{"node":{"id":"d300ca38-a569-5f95-b2a5-0bf6c30486cc","frontmatter":{"title":"Use UUID for primary key with Rails and Postgres","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/30bb7a61cc87a3edc43f8af6d89fa013/26528/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg","srcSet":"/static/30bb7a61cc87a3edc43f8af6d89fa013/26528/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg 300w,\n/static/30bb7a61cc87a3edc43f8af6d89fa013/43429/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/30bb7a61cc87a3edc43f8af6d89fa013/5d6c3/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.webp 300w,\n/static/30bb7a61cc87a3edc43f8af6d89fa013/68dbc/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-uuid-primary-key-postgres/"}}},{"node":{"id":"bb0af7b8-9d5f-597f-90cb-a4da75c3c9a9","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search Engine","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#d8c8a8","images":{"fallback":{"src":"/static/86310660995a38a9254ece85739c237f/26528/roll-search-3.jpg","srcSet":"/static/86310660995a38a9254ece85739c237f/26528/roll-search-3.jpg 300w,\n/static/86310660995a38a9254ece85739c237f/43429/roll-search-3.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/86310660995a38a9254ece85739c237f/5d6c3/roll-search-3.webp 300w,\n/static/86310660995a38a9254ece85739c237f/68dbc/roll-search-3.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part3/"}}}]}},"pageContext":{"slug":"/blog/rails-query-perf/","relatedPosts":["Roll Your Own Search with Rails and Postgres: Search Engine","Use UUID for primary key with Rails and Postgres","Homebrew Postgresql Service not Starting Resolved"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}