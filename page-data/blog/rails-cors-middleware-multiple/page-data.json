{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/rails-cors-middleware-multiple/",
    "result": {"data":{"markdownRemark":{"html":"<p>A short post for today on a usage of <a href=\"https://github.com/cyu/rack-cors\">CORS Middleware</a> for Rails (well any Rack application) that wasn't obvious from the docs - how to specify multiple endpoints, or resources?</p>\n<p>If you want Javascript from a web page that is hosted on a different domain than your Rails app (or any app actually) to make HTTP API calls to the Rails app, it will require adding CORS support (Cross-Origin Resource Sharing) on the app server. Otherwise the request will fail due to the <a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\">Same-origin policy</a>.</p>\n<p>In my case, I have a Rails server that provides some back end services for this blog (which is statically hosted on Github Pages). So the blog and Rails server live on different domains. One of the services is privacy focused analytics. Visits to blog pages are recorded via a <code>POST {{my-rails-server}}/visits</code> with some information about the page being visited and user agent (but no cookie is used for further tracking, hence the privacy focus).</p>\n<p>In order for the POST from the blog hosted on Github Pages to be allowed through to the Rails server, the Rails server needs to have CORS middleware configured as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Gemfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem </span><span class=\"mtk6\">&#39;rack-cors&#39;</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins </span><span class=\"mtk6\">&#39;https://danielabaron.me&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/visits&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[post]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>This allows the <code>POST</code> HTTP method on the <code>/visits</code> resource, only from the origin <code>https://danielabaron.me</code>.</p>\n<h2>Multiple Resources</h2>\n<p>This has been working well, but recently I added a second service to the Rails server which also needed to be accessible to the blog with CORS. This is a search service, backed by Postgres full-text search. The API is available via a <code>GET {{my-rails-server}}/search?q=whatever</code>.</p>\n<p>Looking at the <a href=\"https://github.com/cyu/rack-cors#configuration-reference\">Configuration Reference</a> for the Rails/Rack CORS middleware gem, I couldn't determine how to add a second <code>resource</code> to the cors middleware configuration. It says:</p>\n<blockquote>\n<p>A Resource path can be specified as exact string match (/path/to/file.txt) or with a * wildcard (/all/files/in/*)</p>\n</blockquote>\n<p>I already had an exact string match <code>/visits</code>, and only wanted to allow exactly one more <code>/search</code>. A wildcard wouldn't work for this.</p>\n<h2>Solution</h2>\n<p>Turns out, this middleware supports multiple blocks. To allow CORS for two different, exactly specified resources, the following works:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins </span><span class=\"mtk6\">&#39;https://danielabaron.me&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/visits&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[post]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins </span><span class=\"mtk6\">&#39;https://danielabaron.me&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/search&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[get]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Local Development</h2>\n<p>One final tweak to support local development. When developing on this blog (or whatever web app you're working on), it will be running on localhost, for example <code>http://localhost:8000</code>, and the Rails server also runs locally at <code>http://localhost:3000</code>. In this case, the Rails server should accept CORS requests from <code>http://localhost:8000</code>. To get this flexibility, use an environment variable <code>ALLOWED_ORIGIN</code> as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/visits&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[post]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/search&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[get]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.logger.info(</span><span class=\"mtk6\">&quot;Cors Configured to allow origin: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>When the Rails server runs locally, don't specify any environment variable and it defaults to allowing <code>localhost</code> requests. For production (or any other environment), run the server with the <code>ALLOWED_ORIGIN</code> environment variable set to the origin that requires access.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Rails CORS Middleware For Multiple Resources","date":"04 Jun 2021","description":"Add multiple blocks to Rails CORS middleware to support multiple endpoints.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/5c6bfd7e0c120605610036c50102bba1/94ca7/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.jpg","srcSet":"/static/5c6bfd7e0c120605610036c50102bba1/8315c/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.jpg 200w,\n/static/5c6bfd7e0c120605610036c50102bba1/b46c6/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.jpg 400w,\n/static/5c6bfd7e0c120605610036c50102bba1/94ca7/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.jpg 800w","sizes":"(min-width: 800px) 800px, 100vw"},"sources":[{"srcSet":"/static/5c6bfd7e0c120605610036c50102bba1/a1bbf/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.webp 200w,\n/static/5c6bfd7e0c120605610036c50102bba1/e0122/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.webp 400w,\n/static/5c6bfd7e0c120605610036c50102bba1/80be4/rails-middleware-erik-witsoe-bluVshKGwKQ-unsplash.webp 800w","type":"image/webp","sizes":"(min-width: 800px) 800px, 100vw"}]},"width":800,"height":535}}}},"fields":{"slug":"/blog/rails-cors-middleware-multiple/"}}},"pageContext":{"slug":"/blog/rails-cors-middleware-multiple/","content":"<p>A short post for today on a usage of <a href=\"https://github.com/cyu/rack-cors\">CORS Middleware</a> for Rails (well any Rack application) that wasn't obvious from the docs - how to specify multiple endpoints, or resources?</p>\n<p>If you want Javascript from a web page that is hosted on a different domain than your Rails app (or any app actually) to make HTTP API calls to the Rails app, it will require adding CORS support (Cross-Origin Resource Sharing) on the app server. Otherwise the request will fail due to the <a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\">Same-origin policy</a>.</p>\n<p>In my case, I have a Rails server that provides some back end services for this blog (which is statically hosted on Github Pages). So the blog and Rails server live on different domains. One of the services is privacy focused analytics. Visits to blog pages are recorded via a <code>POST {{my-rails-server}}/visits</code> with some information about the page being visited and user agent (but no cookie is used for further tracking, hence the privacy focus).</p>\n<p>In order for the POST from the blog hosted on Github Pages to be allowed through to the Rails server, the Rails server needs to have CORS middleware configured as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Gemfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem </span><span class=\"mtk6\">&#39;rack-cors&#39;</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins </span><span class=\"mtk6\">&#39;https://danielabaron.me&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/visits&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[post]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>This allows the <code>POST</code> HTTP method on the <code>/visits</code> resource, only from the origin <code>https://danielabaron.me</code>.</p>\n<h2>Multiple Resources</h2>\n<p>This has been working well, but recently I added a second service to the Rails server which also needed to be accessible to the blog with CORS. This is a search service, backed by Postgres full-text search. The API is available via a <code>GET {{my-rails-server}}/search?q=whatever</code>.</p>\n<p>Looking at the <a href=\"https://github.com/cyu/rack-cors#configuration-reference\">Configuration Reference</a> for the Rails/Rack CORS middleware gem, I couldn't determine how to add a second <code>resource</code> to the cors middleware configuration. It says:</p>\n<blockquote>\n<p>A Resource path can be specified as exact string match (/path/to/file.txt) or with a * wildcard (/all/files/in/*)</p>\n</blockquote>\n<p>I already had an exact string match <code>/visits</code>, and only wanted to allow exactly one more <code>/search</code>. A wildcard wouldn't work for this.</p>\n<h2>Solution</h2>\n<p>Turns out, this middleware supports multiple blocks. To allow CORS for two different, exactly specified resources, the following works:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins </span><span class=\"mtk6\">&#39;https://danielabaron.me&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/visits&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[post]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins </span><span class=\"mtk6\">&#39;https://danielabaron.me&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/search&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[get]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Local Development</h2>\n<p>One final tweak to support local development. When developing on this blog (or whatever web app you're working on), it will be running on localhost, for example <code>http://localhost:8000</code>, and the Rails server also runs locally at <code>http://localhost:3000</code>. In this case, the Rails server should accept CORS requests from <code>http://localhost:8000</code>. To get this flexibility, use an environment variable <code>ALLOWED_ORIGIN</code> as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/visits&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[post]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/search&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[get]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.logger.info(</span><span class=\"mtk6\">&quot;Cors Configured to allow origin: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>When the Rails server runs locally, don't specify any environment variable and it defaults to allowing <code>localhost</code> requests. For production (or any other environment), run the server with the <code>ALLOWED_ORIGIN</code> environment variable set to the origin that requires access.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","title":"Rails CORS Middleware For Multiple Resources","description":"Add multiple blocks to Rails CORS middleware to support multiple endpoints."}},
    "staticQueryHashes": ["163244226"]}