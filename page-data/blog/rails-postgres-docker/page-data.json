{"componentChunkName":"component---src-templates-post-js","path":"/blog/rails-postgres-docker/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\"><strong class=\"markdown-strong\">Update (May 2025):</strong> Added instructions for customizing the PostgreSQL configuration file <code>postgresql.conf</code> used by the Docker container. See <a href=\"../rails-postgres-docker#modify-config-file\" class=\"markdown-link\">modify config file</a> section for more details.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Update (September 2023):</strong> Rails projects using fixtures will need one additional permission for the Postgres role. See <a href=\"../rails-postgres-docker#initialization\" class=\"markdown-link\">initialization</a> section for more details.</p>\n<p class=\"markdown-para\">When scaffolding a new Rails project, the database flag can be used to specify a database other than the default SQLite, such as Postgres. However, the generated configuration will assume that the database is running on localhost, i.e. installed directly on your laptop or development machine. If instead you'd like the database running in a Docker container, a few more steps are necessary. This post will walk you through how to setup a new Rails project with a Postgres database running in a Docker container rather than the default SQLite running on localhost. It will be demonstrated using the <a href=\"https://guides.rubyonrails.org/getting_started.html\" class=\"markdown-link\">Rails Getting Started Guide</a> which builds an example blog application. All the code explained in this post can be found in this <a href=\"https://github.com/danielabar/blogpg\" class=\"markdown-link\">blogpg project</a> on Github.</p>\n<aside class=\"markdown-aside\">\nThis post assumes some familiarity with Docker and Docker Compose. If you're new to these, checkout this <a class=\"markdown-link\" href=\"https://www.pluralsight.com/paths/docker-fundamentals-for-developers\">learning path</a> from Pluralsight (paid service). There's also a number of <a class=\"markdown-link\" href=\"https://docs.docker.com/get-started/resources/\">educational resources</a> listed on the Docker website.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"why\" style=\"position:relative;\"><a href=\"#why\" aria-label=\"why permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why?</h2>\n<p class=\"markdown-para\">But first, why would you want to use Docker to run your development database rather than simply installing it on your machine? There are a few benefits including:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Version consistency:</strong> Ideally, everyone on the team is running the same version locally as what's used in production. Suppose the production version gets upgraded, then every developer needs to remember to also upgrade their local installation. When the service is dockerized and run with Docker Compose, an upgrade just involves updating the image tag in the <code>docker-compose.yml</code> file and pushing to version control. Next time everyone pulls that change and runs <code>docker-compose up</code>, they'll automatically get the upgraded version. Version consistency also eliminates a source of <a href=\"https://dzone.com/articles/works-on-my-machine\" class=\"markdown-link\">works on my machine</a> problems.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Configuration consistency:</strong> If your project requires some custom database configuration, it can be committed into the project and set in the container with a host mount. This leads to faster local setup as compared to adding an instruction in the <code>README.md</code> telling each developer to configure their database manually.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Multiple versions and services:</strong>: For a developer that works on multiple projects, they could be using different database versions and it would be tedious to have to constantly uninstall/re-install versions every time you switch projects. Also as you work on multiple projects, each may have different service requirements such as Postgres, MySQL, Elasticsearch, Redis, etc. I'd rather not have all of those always running on my laptop when not needed, or have to remember to start/stop them for each project. Using Docker, with Docker Compose simplifies this.</p>\n<aside class=\"markdown-aside\">\nAll the benefits discussed above are for development, not production. The issue of whether a production database should be run in a container or not is outside the scope of this post. See some discussion <a class=\"markdown-link\" href=\"https://stackoverflow.com/questions/48515460/is-it-recommended-to-use-database-as-a-container-in-production-environment\">here</a> and follow the links to referenced blog posts if you want to learn more about this.\n</aside>\n<p class=\"markdown-para\">Now that we've covered some benefits of using Docker locally for services, let's see how to setup Postgres in a container for a new Rails project.</p>\n<h2 class=\"markdown-subtitle\" id=\"getting-started\" style=\"position:relative;\"><a href=\"#getting-started\" aria-label=\"getting started permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Getting Started</h2>\n<p class=\"markdown-para\">Install Postgres locally. Even though the Postgres database server will be run inside a Docker container, we still need the client installed on our laptop to connect to it. For a Mac, the easiest way is to use Homebrew. Note that you need to select your version. It's not necessary to start the service, so ignore the instruction at the end of the installation about starting Postgres.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">brew install postgresql@14</span></span></code></pre>\n<p class=\"markdown-para\">Scaffold a new Rails app, but specify that you want the database to be Postgres. Otherwise, the default option will use a SQLite database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">rails new blogpg --database=postgresql</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"docker-compose\" style=\"position:relative;\"><a href=\"#docker-compose\" aria-label=\"docker compose permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Compose</h2>\n<p class=\"markdown-para\">We'll use <a href=\"https://docs.docker.com/compose/\" class=\"markdown-link\">Docker Compose</a> to manage starting and stopping containers. Typically Docker Compose is used to manage multiple services, but there's still benefits to using it even if you only have one service as in this case. It's more convenient to start a container with a simple command <code>docker-compose up</code> than to use the equivalent <code>docker run...</code> because the compose file handles passing in all arguments such as volumes, port mapping and environment variables. Also as the project grows, more services such as Redis, Sidekiq, etc may be added that will each require their own container. Using Docker Compose means they can all be started with a single command.</p>\n<p class=\"markdown-para\">Add the following <code>docker-compose.yml</code> file to the root of the project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.8&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:14</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Named volume to persist database data outside of container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Format is &quot;named_volume:path/in/container&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">db_pg_data:/var/lib/postgresql/data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Host mount for one-time initialization.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Format is &quot;./path/on/host:/path/in/container&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">./init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Map to something other than default 5432 on host in case Postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># is also running natively on host.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Format is &quot;host:container&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;5434:5432&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Sets the superuser password for PostgreSQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">shhhhItsASecret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db_pg_data</span><span class=\"mtk1\">:</span></span></span></code></pre>\n<p class=\"markdown-para\">A few things to note here:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">image:</strong> This specifies what image to use. By default, it will pull from the <a href=\"https://index.docker.io/search?q=\" class=\"markdown-link\">Docker Hub</a> public registry. The <code>postgres</code> image refers to the <a href=\"https://hub.docker.com/_/postgres\" class=\"markdown-link\">Official Postgres Image</a>. Notice that the version tag <code>14</code> is specified. If you don't specify a tag, <code>latest</code> will be pulled which may not be what you want. Optionally you can use the <code>14-alpine</code> tag for a more minimal image.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">ports:</strong> By default, Postgres listens on port 5432. When the database is running in a container rather than directly on the local machine, this port must be mapped to a port on the host, in order for the Rails application to be able to connect to it. Typically, you'll see the container port mapped to same port number on the host such as <code>\"5432:5432\"</code>. I prefer to choose a different port to map to on the host in case anyone on the team happens to be running Postgres locally on the default port, maybe from an earlier tutorial, or even just installing the client via homebrew, they may have chosen to start the service. The idea here is to avoid a port conflict where Docker is trying to use a port that's already in use by the host. Learn more about <a href=\"https://docs.docker.com/compose/compose-file/#ports\" class=\"markdown-link\">ports</a>.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">volumes:</strong> There are two entries in the services - volumes section. The first is a named volume <code>db_pg_data:/var/lib/postgresql/data</code>. This maps the directory inside the container where Postgres stores all the data to a Docker volume named <code>db_pg_data</code>, which is defined at the end of the file in the <code>volumes</code> section. This will save all data outside of the container (you can list your volumes with the <code>docker volume ls</code> command). This means even if the container is removed, your data is still available.</p>\n<p class=\"markdown-para\">The second is a host mount <code>./init.sql:/docker-entrypoint-initdb.d/init.sql</code>. It maps a file <code>./init.sql</code> from the project root (we'll create it in the next section) to a special directory in the container <code>docker-entrypoint-initdb.d</code>. This is a property of the official Postgres Docker image. Any sql files located in this directory can be used for one-time initialization. That is, when the container starts, it checks if the default <code>postgres</code> database already exists, if not, it runs all sql scripts found in the initdb directory. If a database does exist, then the files are ignored. Learn more about <a href=\"https://docs.docker.com/compose/compose-file/#volumes\" class=\"markdown-link\">volumes</a>.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">environment:</strong> This section is used to set environment variables that will be available within the container. <code>POSTGRES_PASSWORD</code> sets the superuser password for the <code>postgres</code> user. Remember this is only a development image so this password isn't being used to protect production data. Optionally, you can set the <code>POSTGRES_HOST_AUTH_METHOD</code> to <code>trust</code>, and then the <code>POSTGRES_PASSWORD</code> environment variable is not required. Learn more about setting <a href=\"https://docs.docker.com/compose/compose-file/#environment\" class=\"markdown-link\">environment variables</a> in Docker Compose.</p>\n<h2 class=\"markdown-subtitle\" id=\"initialization\" style=\"position:relative;\"><a href=\"#initialization\" aria-label=\"initialization permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Initialization</h2>\n<p class=\"markdown-para\">The <code>docker-compose.yml</code> file explained in the previous section specifies a host mount for <code>init.sql</code>. When the Postgres container is run for the first time, it will detect that there is no default <code>postgres</code> database created yet, when this is the case, it will run all sql scripts located in the <code>docker-entrypoint-initdb.d</code> directory. Otherwise, if a default database does exist, this directory is ignored. This makes it perfect for performing one-time initialization.</p>\n<p class=\"markdown-para\">We'll use this feature of the Postgres image to <a href=\"https://www.postgresql.org/docs/current/sql-createrole.html\" class=\"markdown-link\">create a role</a> having the same name as the Rails database, in this case <code>blogpg</code> for our sample blog application. Create a file <code>init.sql</code> in the root of the Rails project with the following content:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Only used for development where Postgres is run in Docker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">create</span><span class=\"mtk1\"> </span><span class=\"mtk7\">role</span><span class=\"mtk1\"> blogpg </span><span class=\"mtk7\">with</span><span class=\"mtk1\"> CREATEDB </span><span class=\"mtk7\">login</span><span class=\"mtk1\"> </span><span class=\"mtk7\">password</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;blogpg&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p class=\"markdown-para\">If your project uses <a href=\"https://guides.rubyonrails.org/testing.html#the-low-down-on-fixtures\" class=\"markdown-link\">fixtures</a> for loading sample data, you may encounter the following error when running <code>bin/rails db:seed</code> or when running tests, both of which attempt to load the fixtures via <code>db:fixtures:load</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">WARNING: Rails was not able to disable referential integrity.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">This is most likely caused due to missing permissions.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Rails needs superuser privileges to disable referential integrity.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">cause: PG::InsufficientPrivilege: ERROR:  permission denied: &quot;RI_ConstraintTrigger_c_24650&quot; is a system trigger</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Tasks: TOP =&gt; db:fixtures:load</span></span></code></pre>\n<p class=\"markdown-para\">This is because when loading fixtures, Rails first deletes all the existing data in the database, and the fastest way to do that is to first disable referential integrity (i.e. foreign keys and check constraints). However, Postgres requires that the user doing this must have a role with <code>SUPERUSER</code> privileges. The role created in the example above only has <code>CREATEDB</code> privilege which is insufficient. To resolve this, include <code>SUPERUSER</code> privilege when creating the role as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Only used for development where Postgres is run in Docker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">create</span><span class=\"mtk1\"> </span><span class=\"mtk7\">role</span><span class=\"mtk1\"> blogpg </span><span class=\"mtk7\">with</span><span class=\"mtk1\"> CREATEDB SUPERUSER </span><span class=\"mtk7\">login</span><span class=\"mtk1\"> </span><span class=\"mtk7\">password</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;blogpg&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p class=\"markdown-para\">According to the Postgres docs on creating roles:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Superuser status is dangerous and should be used only when really needed.</p>\n</blockquote>\n<p class=\"markdown-para\">In this case, it is <em class=\"markdown-emphasis\">only</em> being used for development purposes. Your production role should not have this.</p>\n<aside class=\"markdown-aside\">\nRoles and users are similar concepts in Postgres, although there are some differences. A full discussion of this topic is outside the scope of this post, see this <a class=\"markdown-link\" href=\"https://dba.stackexchange.com/questions/82271/postgresql-roles-versus-users-grant-permissions\">question on DBA Stack Exchange</a> for more details.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"rails-database-config\" style=\"position:relative;\"><a href=\"#rails-database-config\" aria-label=\"rails database config permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rails Database Config</h2>\n<p class=\"markdown-para\">The next step is to modify <code>config/database.yml</code> in the Rails project so that it can connect to the database running in the Docker container for <code>development</code> and <code>test</code>. It also needs the flexibility to connect to a different database for <code>production</code>.</p>\n<p class=\"markdown-para\">Before making changes to this file, let's take a look at what gets generated from running the <code>rails new blogpg --database=postgresql</code> command:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/database.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">default</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&amp;</span><span class=\"mtk5 mtku\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">adapter</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgresql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">encoding</span><span class=\"mtk1\">: </span><span class=\"mtk6\">unicode</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">pool</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 } %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">development</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">test</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">production</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">username</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">password</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;BLOGPG_DATABASE_PASSWORD&#39;] %&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Notice that there's no <code>host</code> or <code>port</code> specified in the default database configuration. This is because it's assumed that the database is running on <code>localhost</code>, i.e. the same machine as the Rails app is running on, and listening on the default Postgres port of <code>5432</code>. In our case, the database is running on the same machine, but inside a Docker container therefore <code>localhost</code> will not resolve. Instead we'll need to specify a host of <code>127.0.0.1</code>. As for the port, recall we mapped the default Postgres port of <code>5432</code> in the container to <code>5434</code> on the host so we'll also need to tell Rails about this.</p>\n<p class=\"markdown-para\">We also need to make sure that different values can be specified in production. We'll make use of environment variables for this, together with the logical or operator <code>||</code> to use a default when the environment variable is not specified.</p>\n<p class=\"markdown-para\">Here is the modified config file to support connecting to Postgres in a Docker container for development and test, and flexibility to specify a different database host, password, etc with environment variables for production:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">default</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&amp;</span><span class=\"mtk5 mtku\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">adapter</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgresql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">encoding</span><span class=\"mtk1\">: </span><span class=\"mtk6\">unicode</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">pool</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 } %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_NAME&#39;] || &quot;blogpg&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">username</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_USER&#39;] || &quot;blogpg&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">password</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_PASSWORD&#39;] || &quot;blogpg&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">port</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_PORT&#39;] || &quot;5432&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">host</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_HOST&#39;] || &quot;127.0.0.1&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">development</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">port</span><span class=\"mtk1\">: </span><span class=\"mtk4\">5434</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">test</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">port</span><span class=\"mtk1\">: </span><span class=\"mtk4\">5434</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">production</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">username</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">password</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;BLOGPG_DATABASE_PASSWORD&#39;] %&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Note that there's nothing Docker-specific in the <code>config/database.yml</code> file. All we've done is make it more flexible than what the Rails scaffold generated so that development and test can connect to databases other than that running on localhost and the default port.</p>\n<h2 class=\"markdown-subtitle\" id=\"start-container\" style=\"position:relative;\"><a href=\"#start-container\" aria-label=\"start container permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Start Container</h2>\n<p class=\"markdown-para\">Now it's time to try all this out and make sure everything's connected. Start the container(s) with docker compose:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose up</span></span></code></pre>\n<p class=\"markdown-para\">Since this is the first time this container is running, the default <code>postgres</code> database doesn't yet exist, so the console output should show that the <code>init.sql</code> script was run to create the <code>blogpg</code> role:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">database_1  | /usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/init.sql</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">database_1  | CREATE ROLE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">database_1  | 2022-09-06 10:33:56.184 UTC [1] LOG:  database system is ready to accept connections</span></span></code></pre>\n<p class=\"markdown-para\">Note that you can stop the database at any time with <code>docker-compose stop</code> and then use the <code>up</code> command to restart it. The <code>CREATE ROLE</code> from <code>init.sql</code> will not run again because the default <code>postgres</code> database already exists. Next time you start the database, the following message will be displayed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">PostgreSQL Database directory appears to contain a database; Skipping initialization</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"force-init\" style=\"position:relative;\"><a href=\"#force-init\" aria-label=\"force init permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Force Init</h3>\n<p class=\"markdown-para\">This section is optional. If you made a typo in <code>init.sql</code> or for whatever reason want to force it to run again, this can be accomplished by removing the named volume that contains the Postgres data (make sure there's nothing important saved there or back it up first!). Since a container exists that is using the volume, it must be stopped and removed first, here are the steps to force init to run again:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># stop the running Postgres container</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose stop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># remove the container (otherwise the volume cannot be removed)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose rm -f</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># list all volumes - should see blogpg_db_pg_data in the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker volume ls</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># remove the named volume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker volume rm blogpg_db_pg_data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># start database container again - should show its running CREATE ROLE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose up</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"create-database\" style=\"position:relative;\"><a href=\"#create-database\" aria-label=\"create database permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create Database</h2>\n<p class=\"markdown-para\">Next step is to create the Rails application database. Run the usual Rails command to do so:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails db:create</span></span></code></pre>\n<p class=\"markdown-para\">Use the <code>psql</code> command line tool (this got installed with homebrew earlier) to connect to Postgres running in the Docker container to verify the application database got created. Notice this command specifies <code>127.0.0.1</code> as the host and <code>5434</code> as the port because we need to connect to the Docker container rather than a database running directly on the laptop:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">psql -h 127.0.0.1 -p 5434 -U blogpg</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># enter password from init.sql</span></span></span></code></pre>\n<p class=\"markdown-para\">Use the <code>\\l</code> command to list all databases - you should see <code>blogpg</code> and <code>blogpg_test</code> in the listing, which were created from running the <code>bin/rails db:create</code> command:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">blogpg=&gt; \\l</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                  List of databases</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Name     |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-------------+----------+----------+------------+------------+-----------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> blogpg      | blogpg   | UTF8     | en_US.utf8 | en_US.utf8 |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> blogpg_test | blogpg   | UTF8     | en_US.utf8 | en_US.utf8 |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> postgres    | postgres | UTF8     | en_US.utf8 | en_US.utf8 |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> template0   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             |          |          |            |            | postgres=CTc/postgres</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> template1   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             |          |          |            |            | postgres=CTc/postgres</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(5 rows)</span></span></code></pre>\n<p class=\"markdown-para\">Keep this tab open, we'll come back to it to verify tables after creating and populating some models.</p>\n<h2 class=\"markdown-subtitle\" id=\"create-and-populate-table\" style=\"position:relative;\"><a href=\"#create-and-populate-table\" aria-label=\"create and populate table permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create and Populate Table</h2>\n<p class=\"markdown-para\">Now let's follow along with the Getting Started Rails Guide so we can get to the point of creating a table and populating it. Add the following to <code>config/routes.rb</code> to expose a route that will list all articles in the application:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">routes</span><span class=\"mtk1\">.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  root </span><span class=\"mtk6\">&quot;articles#index&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  get </span><span class=\"mtk6\">&quot;/articles&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">to:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;articles#index&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Use the Rails generator to scaffold an Articles controller and model, then run the migration (migration file got generated by the model generator) to create the <code>articles</code> table in the database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate controller Articles index --skip-routes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate model Article title:string body:text</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails db:migrate</span></span></code></pre>\n<p class=\"markdown-para\">Go back to the tab where <code>psql</code> is running and verify the <code>articles</code> table got created in the Postgres database running within Docker container. The <code>\\dt</code> command lists all tables in the database you're connected to:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">blogpg=&gt; \\dt</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               List of relations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Schema |         Name         | Type  | Owner</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------+----------------------+-------+--------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> public | ar_internal_metadata | table | blogpg</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> public | articles             | table | blogpg</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> public | schema_migrations    | table | blogpg</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<p class=\"markdown-para\">We can see the <code>articles</code> table got created as well as the <code>schema_migrations</code> table Rails uses to keep track of migrations.</p>\n<p class=\"markdown-para\">Now launch a Rails console with <code>bin/rails console</code> and create a new article:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Article</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Hello Postgres Docker&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">body:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;I&#39;m being created in Postgres running in a Docker container&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">Go back to the tab where <code>psql</code> is running and verify the new article record has been created:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">blogpg=&gt; select * from articles;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> id |         title         |                            body                             |         created_at         |         updated_at</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----+-----------------------+-------------------------------------------------------------+----------------------------+----------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  1 | Hello Postgres Docker | I&#39;m being created in Postgres running in a Docker container | 2022-09-09 10:31:13.032458 | 2022-09-09 10:31:13.032458</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(1 row)</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"verify-full-stack\" style=\"position:relative;\"><a href=\"#verify-full-stack\" aria-label=\"verify full stack permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verify Full Stack</h2>\n<p class=\"markdown-para\">To tie this all together, let's update the Articles controller <code>index</code> method and the Articles index view to display the articles so we can verify the full stack is working with the Dockerized database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/articles_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ArticlesController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @articles </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Article</span><span class=\"mtk1\">.</span><span class=\"mtk5\">all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">&lt;!-- app/views/articles/index.html.erb --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;Articles&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">table</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">tr</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">th</span><span class=\"mtk1\">&gt;Title&lt;/</span><span class=\"mtk7\">th</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">th</span><span class=\"mtk1\">&gt;Body&lt;/</span><span class=\"mtk7\">th</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">tr</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> @articles.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |article| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">tr</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">td</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> article.</span><span class=\"mtk5\">title</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">td</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">td</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> article.</span><span class=\"mtk5\">body</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">td</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">tr</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">table</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Start the server with <code>bin/rails s</code>, navigate to <code>http://localhost:3000</code> and you should see an unstyled HTML table listing the one article created earlier:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 615px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8klEQVR42q2QSUvEQBCF+xe54UHGGUVxGUVH8Y+Ox/yBnBNyySWQdPYNEgjZJOk3VDEnx4OgDz76VdXjHVqsn15wd7/G5u0Dy9UNLhZLXF3f4nXzjofHZywuVzg5PcfR8dmvEIZhwjAM2LYNKX14nmR839/PHlyXcL/h/YgwTROapuFzu4Wu6/irxDh+YRxHVFWFuq4PAkoBau+naULbtlBKHWRI8zxDdF3HhY7jIAxD9rTr+x7DMPBMniiKApZloWka3lM5ZQi6c2Ge54iiiMuyLOM3TVMkScI+jmP2lAmCAGVZ8h9SlnJ0J6SUXCzwz9oBZg3rcvfRqKwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rails postgres docker articles index\"\n        title=\"rails postgres docker articles index\"\n        src=\"/static/eb17de220eaacd6fefa9ae491727fe15/f6b72/rails-postgres-docker-articles-index.png\"\n        srcset=\"/static/eb17de220eaacd6fefa9ae491727fe15/772e8/rails-postgres-docker-articles-index.png 200w,\n/static/eb17de220eaacd6fefa9ae491727fe15/e17e5/rails-postgres-docker-articles-index.png 400w,\n/static/eb17de220eaacd6fefa9ae491727fe15/f6b72/rails-postgres-docker-articles-index.png 615w\"\n        sizes=\"(max-width: 615px) 100vw, 615px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Congratulations! You now have a running Rails application that is using a Dockerized Postgres database.</p>\n<aside class=\"markdown-aside\">\nSince the test database is also running in a Docker container, this will require Docker-specific setup to work on whatever CI (continuous integration) system your project is using. If using <a class=\"markdown-link\" href=\"https://github.com/features/actions\">Github Actions</a>, the host mount to the project source for initializing the database role doesn't work due to the order of how services and source checkout works. See my post on <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/debug-github-action/\">Debugging Github Actions</a> for more details.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"modify-config-file\" style=\"position:relative;\"><a href=\"#modify-config-file\" aria-label=\"modify config file permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Modify Config File</h2>\n<p class=\"markdown-para\">Optionally, you may want to tweak the default PostgreSQL configuration. Common reasons for doing this include:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Enabling extensions like <code>pg_stat_statements</code> for query performance analysis.</li>\n<li class=\"markdown-list-item\">Adjusting logging settings for better visibility of slow queries or autovacuum operations.</li>\n<li class=\"markdown-list-item\">Customizing memory or connection settings to better suit your local development environment.</li>\n</ul>\n<p class=\"markdown-para\">By default, the <code>postgresql.conf</code> file lives inside the Docker container as part of the official PostgreSQL image. Any changes made directly in the container will be lost if the container is removed. To make persistent changes, you need to:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Locate and copy the config file out of the container.</li>\n<li class=\"markdown-list-item\">Make your desired changes locally.</li>\n<li class=\"markdown-list-item\">Bind mount the updated file back into the container.</li>\n</ol>\n<p class=\"markdown-para\">Here's how to do that step by step:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Step 1: Locate and Copy Config File</strong></p>\n<p class=\"markdown-para\">Connect to your running database using a superuser account:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># If your custom role has SUPERUSER privileges:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Or using the default postgres superuser:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">psql -h 127.0.0.1 -p 5434 -U postgres</span></span></span></code></pre>\n<p class=\"markdown-para\">From the psql prompt, check where the config file is located:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">SHOW config_file;</span></span></span></code></pre>\n<p class=\"markdown-para\">The output should look something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">               config_file</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> /var/lib/postgresql/data/postgresql.conf</span></span></code></pre>\n<p class=\"markdown-para\">Since the file is inside the container, extract a copy for local modification:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a directory in your project root to hold PostgreSQL configuration files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">mkdir postgres_conf</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Pull the sample config file from the official PostgreSQL image</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker run -i --rm postgres:16 cat /usr/share/postgresql/postgresql.conf.sample </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> postgres_conf/postgresql.conf</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Step 2: Modify Config File</strong></p>\n<p class=\"markdown-para\">Now you have a local copy at <code>postgres_conf/postgresql.conf</code>. Open the file using your editor of choice and modify the settings as needed. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"># Enable pg_stat_statements for analyzing query performance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># and auto_explain for slow query logging</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># https://www.postgresql.org/docs/current/auto-explain.html</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">shared_preload_libraries = &#39;pg_stat_statements,auto_explain&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Collect query performance data</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pg_stat_statements.max = 10000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pg_stat_statements.track = all</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Log queries with execution duration &gt;= 1ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">auto_explain.log_min_duration = &#39;1ms&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">auto_explain.log_analyze = on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">auto_explain.log_format = json</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># General logging tweaks</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">log_min_duration_statement = 1    # log queries taking longer than 1ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">log_duration = on                # always log duration of each completed statement</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Log all autovacuum operations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">log_autovacuum_min_duration = 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Enable CSV logging for easier analysis</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">log_destination = &#39;stderr,csvlog&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">logging_collector = on</span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Step 3: Update docker-compose.yml to use the custom config</strong></p>\n<p class=\"markdown-para\">To ensure your container uses the modified configuration file, update your <code>docker-compose.yml</code> with a <a href=\"https://docs.docker.com/engine/storage/bind-mounts/\" class=\"markdown-link\">bind mount</a> in the <code>volumes</code> section:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.8&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:16</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">db_pg_data:/var/lib/postgresql/data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># === ADD THIS LINE HERE ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">./postgres_conf/postgresql.conf:/var/lib/postgresql/data/postgresql.conf</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;5434:5432&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">shhhhItsASecret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db_pg_data</span><span class=\"mtk1\">:</span></span></span></code></pre>\n<p class=\"markdown-para\">Then recreate the container for changes to take effect:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose up</span></span></span></code></pre>\n<p class=\"markdown-para\">PostgreSQL running in the container will now use your customized configuration.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has walked through the steps required to setup a Rails application with a Postgres database running in a Docker container. It requires adding a <code>docker-compose.yml</code> file to the project. This file defines the database service including what Docker image to use, port mapping, volumes, and environment variables. Then the Rails project file <code>config/database.yml</code> must be modified so that the development and test databases are configured to point to the Dockerized database rather than assuming they're available on localhost. Finally the <code>psql</code> command line tool can be used to connect to the database in the container to verify the Rails application is populating it as expected.</p>\n<h2 class=\"markdown-subtitle\" id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h2>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://github.com/danielabar/blogpg\" class=\"markdown-link\">Example Rails Project with Postgres in Docker</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://brew.sh/\" class=\"markdown-link\">Homebrew Package Manager for Mac</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://formulae.brew.sh/formula/postgresql@14\" class=\"markdown-link\">Postgresql on Homebrew</a> - notice they're all versioned now!</li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/getting_started.html\" class=\"markdown-link\">Rails Getting Started Building Blog App</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/command_line.html#rails-with-databases-and-scm\" class=\"markdown-link\">Rails Command Line Option for Database</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://hub.docker.com/_/postgres\" class=\"markdown-link\">Postgres Official Image on Docker Hub</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://github.com/docker-library/docs/blob/master/postgres/README.md\" class=\"markdown-link\">Postgres Docker Image Full Readme</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://stackoverflow.com/questions/27709456/what-is-the-difference-between-a-user-and-a-role\" class=\"markdown-link\">Postgres user vs role</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":15,"tableOfContents":"<ul>\n<li>\n<p><a href=\"#why\">Why?</a></p>\n</li>\n<li>\n<p><a href=\"#getting-started\">Getting Started</a></p>\n</li>\n<li>\n<p><a href=\"#docker-compose\">Docker Compose</a></p>\n</li>\n<li>\n<p><a href=\"#initialization\">Initialization</a></p>\n</li>\n<li>\n<p><a href=\"#rails-database-config\">Rails Database Config</a></p>\n</li>\n<li>\n<p><a href=\"#start-container\">Start Container</a></p>\n<ul>\n<li><a href=\"#force-init\">Force Init</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#create-database\">Create Database</a></p>\n</li>\n<li>\n<p><a href=\"#create-and-populate-table\">Create and Populate Table</a></p>\n</li>\n<li>\n<p><a href=\"#verify-full-stack\">Verify Full Stack</a></p>\n</li>\n<li>\n<p><a href=\"#modify-config-file\">Modify Config File</a></p>\n</li>\n<li>\n<p><a href=\"#conclusion\">Conclusion</a></p>\n</li>\n<li>\n<p><a href=\"#references\">References</a></p>\n</li>\n</ul>","frontmatter":{"title":"Setup a Rails Project with Postgres and Docker","date":"01 Aug 2023","description":"Learn how to scaffold a new Rails project with Postgres running in a Docker container for development.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#583838","images":{"fallback":{"src":"/static/03714b36bbd86fee510f6b5b6ed12b0b/c0556/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.jpg","srcSet":"/static/03714b36bbd86fee510f6b5b6ed12b0b/da77e/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.jpg 225w,\n/static/03714b36bbd86fee510f6b5b6ed12b0b/b5809/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.jpg 450w,\n/static/03714b36bbd86fee510f6b5b6ed12b0b/c0556/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/03714b36bbd86fee510f6b5b6ed12b0b/388bf/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.webp 225w,\n/static/03714b36bbd86fee510f6b5b6ed12b0b/bc548/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.webp 450w,\n/static/03714b36bbd86fee510f6b5b6ed12b0b/7a3db/rails-postgres-docker-guillaume-bolduc-uBe2mknURG4-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":651}}}},"fields":{"slug":"/blog/rails-postgres-docker/"}},"relatedP":{"edges":[{"node":{"id":"18a6d127-ce72-5612-bd26-5b4b9e5c0892","frontmatter":{"title":"Using Heroku's pg:pull with Docker","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#383848","images":{"fallback":{"src":"/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/26528/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.jpg","srcSet":"/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/26528/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.jpg 300w,\n/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/43429/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/5d6c3/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.webp 300w,\n/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/68dbc/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/heroku_pg_pull_and_docker/"}}},{"node":{"id":"46775b70-43f2-584d-8c65-327ac46ebbd7","frontmatter":{"title":"Dockerize a Rails Application for Development","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#d8c8d8","images":{"fallback":{"src":"/static/3281f20a27a3ba24dcc1ca78c639c25d/26528/docker-rails-shipping-containers.jpg","srcSet":"/static/3281f20a27a3ba24dcc1ca78c639c25d/26528/docker-rails-shipping-containers.jpg 300w,\n/static/3281f20a27a3ba24dcc1ca78c639c25d/43429/docker-rails-shipping-containers.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/3281f20a27a3ba24dcc1ca78c639c25d/5d6c3/docker-rails-shipping-containers.webp 300w,\n/static/3281f20a27a3ba24dcc1ca78c639c25d/68dbc/docker-rails-shipping-containers.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/dockerize-rails-app-for-dev-debug-and-testing/"}}},{"node":{"id":"d300ca38-a569-5f95-b2a5-0bf6c30486cc","frontmatter":{"title":"Use UUID for primary key with Rails and Postgres","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/30bb7a61cc87a3edc43f8af6d89fa013/26528/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg","srcSet":"/static/30bb7a61cc87a3edc43f8af6d89fa013/26528/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg 300w,\n/static/30bb7a61cc87a3edc43f8af6d89fa013/43429/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/30bb7a61cc87a3edc43f8af6d89fa013/5d6c3/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.webp 300w,\n/static/30bb7a61cc87a3edc43f8af6d89fa013/68dbc/primary-keyflorian-berger-SzG0ncGBOeo-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/rails-uuid-primary-key-postgres/"}}}]}},"pageContext":{"slug":"/blog/rails-postgres-docker/","relatedPosts":["Dockerize a Rails Application for Development","Using Heroku's pg:pull with Docker","Use UUID for primary key with Rails and Postgres"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}