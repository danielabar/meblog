{"componentChunkName":"component---src-templates-post-js","path":"/blog/datadog-heroku-rails/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">Application performance monitoring (APM) is critical for understanding how a web application behaves in production. While Heroku provides basic metrics such as memory usage and CPU load, this is not enough for in-depth analysis of what's happening inside a Rails controller or background job. Such as what database queries are running, Redis access, how much time is spent waiting for external services, etc. This is why an APM tool is needed.</p>\n<p class=\"markdown-para\">Heroku makes it easy to add some APMs such as NewRelic or Scout APM with a one-click add-on, but sometimes, your company may already be using Datadog on other projects or teams. Integrating everything into the same observability tool keeps things consistent, simplifies cross-project monitoring, and leverages existing Datadog dashboards.</p>\n<p class=\"markdown-para\">This post will walk through setting up Datadog APM on a Heroku-hosted Rails application. From my experience in going through this setup, I found Datadog's documentation occasionally lacking visibility on specific options. However, their customer support team was very helpful in answering my questions, usually within the same day or the next.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Assumptions:</strong> This guide assumes familiarity with deploying and managing a Rails on Heroku, along with having the Heroku CLI installed and authenticated.</p>\n<h2 class=\"markdown-subtitle\" id=\"high-level\" style=\"position:relative;\"><a href=\"#high-level\" aria-label=\"high level permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Level</h2>\n<p class=\"markdown-para\">Before getting into the step-by-step installation details, let's take a look at the overall picture:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACVklEQVR42nVU207cMBDN/39AXxFvhZeKB9SKlwJqF0G1BaQWCgVtYbuXxInjXDaJr6caJ9kbW0cjO+OZ47kcO7i7nGP2IgBYWOtgrF2KdW/XG7Nr53UJfg5CDAf3iDIO6QBjzAZoL9rYN4dtDweHgBaiKvDn6wCv19comqZ1MitHMiTzPjoCd87ixyzHjBeoqgpltYDSGoFS2qPXFxeIv10hzgRUXXmddc7PWhvUC9lFQfo2oo+/YjwzhqJIEEYMi7pC4E/UGoaMjUJ6uI/46BBCpOBpCsYYbs7HGByNMBszZLlAwjk4T1HXAs83DF8OJpiPSn9IsKqJg6xKTI8/IDo9gdIKiiJrKjzeTjD8PEKelTDWQEoFqRQcDB6uGE72HzB/FStA3TWiURJhzMAz4R0pMwLmIkHEIlR15XXGOl9XSt1Cg2exByMMD7jsUlcz19WP9tqGrMZ6l2mvbiRSIbqDbNvl6XSGacJRSIWyKH0X14VSV8os/9dpIxUBpl0TLQJrLQqlMDk+xvjsDKxc+JR28Y0i2o6QAEUmVoBEZBrq6QnZ70ck4xfUcdga+HI4lFmD6G/uSd+CumUpqMYbEfoTtYZ31RLJ3juw93vgPEGSpgjDEJefRjg9eMZ0zCDytKVNyj0QNYvWm4CUgrWQTY3JxTmi2yG0NV5HEYxHIe6+v6AoFj6ynhX9/XXdLfJXb4OHSiHJMmRl6Z1IR4B5kSEvBRpZeyb09v23DhpsXvgVRfqXZ502bgdttqMM+nTtjufKi7U7n7TtVPsv2PVUbYvdpfsP4D/SFygCd/fHCQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"datadog heroku rails architecture diagram\"\n        title=\"datadog heroku rails architecture diagram\"\n        src=\"/static/1974552ebedb3bea7904e9d9f3ef3c17/5a190/datadog-heroku-rails-architecture-diagram.png\"\n        srcset=\"/static/1974552ebedb3bea7904e9d9f3ef3c17/772e8/datadog-heroku-rails-architecture-diagram.png 200w,\n/static/1974552ebedb3bea7904e9d9f3ef3c17/e17e5/datadog-heroku-rails-architecture-diagram.png 400w,\n/static/1974552ebedb3bea7904e9d9f3ef3c17/5a190/datadog-heroku-rails-architecture-diagram.png 800w,\n/static/1974552ebedb3bea7904e9d9f3ef3c17/5caea/datadog-heroku-rails-architecture-diagram.png 996w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Heroku provides both web and worker dynos, where your Rails app runs. For Datadog to capture trace data and metrics, you’ll need both the Datadog gem (integrated directly into the Rails app) and the Datadog Agent, which runs as a separate process on each dyno. The trace data flow is:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">The Rails app, instrumented by the <code>datadog</code> gem, generates trace data as it processes web requests and background jobs.</li>\n<li class=\"markdown-list-item\">The <code>datadog</code> gem sends this trace data to the Datadog Agent running on your Heroku dynos, and typically listening on port 8126.</li>\n<li class=\"markdown-list-item\">The Datadog Agent then aggregates and forwards the traces it receives from the gem to Datadog’s backend.</li>\n</ol>\n<h2 class=\"markdown-subtitle\" id=\"install-buildpack\" style=\"position:relative;\"><a href=\"#install-buildpack\" aria-label=\"install buildpack permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install Buildpack</h2>\n<p class=\"markdown-para\">Since Heroku doesn't offer a one-click Datadog integration, we need to use the <a href=\"https://docs.datadoghq.com/agent/basic_agent_usage/heroku/\" class=\"markdown-link\">Datadog Heroku Buildpack</a>. Heroku dynos are ephemeral, meaning they don’t retain installed services or agents after a restart. The Datadog buildpack ensures that the Datadog Agent is installed and automatically started each time a dyno is restarted for scaling, deployment, or routine cycling.</p>\n<p class=\"markdown-para\">To install it, run the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku buildpacks:add \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  --index 1 https://github.com/DataDog/heroku-buildpack-datadog.git \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  -a your-app-name</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Buildpack order matters:</strong> If you're running a Rails application, you likely already have the <code>heroku/ruby</code> buildpack. The Datadog buildpack needs to be listed <em class=\"markdown-emphasis\">before</em> the Ruby buildpack. Setting <code>--index 1</code> will make it first in the list. The <code>--index</code> flag is 1-based, not 0-based.</p>\n<p class=\"markdown-para\">You can confirm the buildpack is installed by running the following, your output may look a little different depending on what other buildpacks are already installed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku buildpacks -a my-app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === my-app Buildpack URLs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 1. https://github.com/DataDog/heroku-buildpack-datadog.git</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 2. heroku/ruby</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nEven if you've never explicitly added a buildpack to your Heroku app, you'll still have at least one. This is because when you push code to Heroku and it starts building, it will automatically look for an appropriate buildpack for the project's language (Ruby, Python, PHP, etc.) and add it. Read more about working with <a class=\"markdown-link\" href=\"https://devcenter.heroku.com/articles/buildpacks\">buildpacks</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"enable-dyno-metadata\" style=\"position:relative;\"><a href=\"#enable-dyno-metadata\" aria-label=\"enable dyno metadata permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enable Dyno Metadata</h2>\n<p class=\"markdown-para\">Heroku dyno names are ephemeral, so their identifiers can change frequently. To maintain continuity of metrics, we need to enable <a href=\"https://devcenter.heroku.com/articles/dyno-metadata\" class=\"markdown-link\">Heroku Dyno Metadata</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku labs:enable runtime-dyno-metadata -a your-app-name</span></span></span></code></pre>\n<p class=\"markdown-para\">This allows information about the dyno to be used in Datadog for better tracking of metrics and traces. You can verify this feature is now enabled by checking your Heroku environment variables, there should now be several new ones starting with <code>HEROKU...</code>, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config -a my-app </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> grep </span><span class=\"mtk6\">&quot;^HEROKU&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># HEROKU_APP_ID:                   abc123...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># HEROKU_APP_NAME:                 my-app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># HEROKU_RELEASE_CREATED_AT:       2025-03-25-07T19:55:21Z</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># HEROKU_RELEASE_VERSION:          v1234</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># HEROKU_SLUG_COMMIT:              5c8d2...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># HEROKU_SLUG_DESCRIPTION:         Deploy 5c8...</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe Heroku docs for dyno metadata include a warning: \"Features added through Heroku Labs are experimental and subject to change.\" It’s a bit concerning that something as critical as APM relies on an experimental feature. When I reached out to Heroku support for assistance with setting up Datadog, their response was something like: <em class=\"markdown-emphasis\">Just use NewRelic.</em> (My reaction: ¯\\_(ツ)_/¯)\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"configure-agent\" style=\"position:relative;\"><a href=\"#configure-agent\" aria-label=\"configure agent permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configure Agent</h2>\n<p class=\"markdown-para\">The next step is to configure the Datadog agent. This requires setting several environment variables, as explained below:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Set this if your app uses a Heroku Redis add-on</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Assumes `REDIS_URL` env var is set</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set DD_ENABLE_HEROKU_REDIS=true -a your-app-name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Set the Datadog hostname to include app name, dyno type, and dyno number.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Improves metrics continuity by providing detailed info about dynos.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This is why we enabled dyno metadata in the previous step!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set DD_DYNO_HOST=true -a your-app-name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Ensures metrics are sent to the correct Datadog site.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set DD_SITE=</span><span class=\"mtk6\">&quot;datadoghq.com&quot;</span><span class=\"mtk1\"> -a your-app-name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Set Datadog agent log level to error to avoid littering Heroku CLI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># and Rails server output with Datadog trace messages.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set DD_LOG_LEVEL=</span><span class=\"mtk6\">&quot;error&quot;</span><span class=\"mtk1\"> -a your-app-name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Add your Datadog API key to Heroku&#39;s config.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Keys are at: https://app.datadoghq.com/organization-settings/api-keys</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set DD_API_KEY=</span><span class=\"mtk6\">&quot;abc123...&quot;</span><span class=\"mtk1\"> -a your-app-name</span></span></span></code></pre>\n<p class=\"markdown-para\">Heroku restarts the application every time an environment variable is set. To avoid numerous restarts, you can set multiple environment variables in a single command as shown below:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  DD_ENABLE_HEROKU_REDIS=true \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  DD_DYNO_HOST=true \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  DD_SITE=</span><span class=\"mtk6\">&quot;datadoghq.com&quot;</span><span class=\"mtk1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  DD_LOG_LEVEL=</span><span class=\"mtk6\">&quot;error&quot;</span><span class=\"mtk1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  DD_API_KEY=</span><span class=\"mtk6\">&quot;abc123...&quot;</span><span class=\"mtk1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  -a your-app-name</span></span></span></code></pre>\n<p class=\"markdown-para\">This way the app will only be restarted once.</p>\n<aside class=\"markdown-aside\">\nThe above mentioned environment variables are a minimum to get started. Datadog provides many more <a class=\"markdown-link\" href=\"https://docs.datadoghq.com/agent/basic_agent_usage/heroku/#configuration\">configuration</a> options.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"apply-buildpack\" style=\"position:relative;\"><a href=\"#apply-buildpack\" aria-label=\"apply buildpack permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Apply Buildpack</h2>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">UPDATE:</strong> At the time of writing this guide, the <code>heroku ps:exec</code> command was functioning correctly and allowed me to verify the Datadog agent status as described below. However, sometime between then and publishing, this feature became broken in the latest Heroku CLI v10.0.0. Attempting to connect to a running dyno now results in the following error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Establishing credentials... error</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ▸    Could not connect to dyno!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ▸    Check if the dyno is running with `heroku ps`</span></span></code></pre>\n<p class=\"markdown-para\">This issue is being tracked in <a href=\"https://github.com/heroku/cli/issues/3147\" class=\"markdown-link\">this GitHub issue</a>. Until it’s resolved, you won’t be able to shell into your dynos for verification.</p>\n<p class=\"markdown-para\">At this point, the agent isn't running yet. This is because it requires the Heroku <a href=\"https://devcenter.heroku.com/articles/slug-compiler\" class=\"markdown-link\">slug</a> to be re-built. To do this, add an empty commit and push to your <code>heroku</code> remote:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git commit --allow-empty -m </span><span class=\"mtk6\">&quot;Rebuild slug to apply Datadog setup&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git push heroku main</span></span></span></code></pre>\n<p class=\"markdown-para\">From this point onwards, the Datadog Agent will be started automatically when each dyno starts.</p>\n<p class=\"markdown-para\">You can verify the agent was started successfully by shelling into a Heroku web or worker dyno, and using the <code>agent-wrapper</code> command provided by the Datadog buildpack:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku ps:exec --dyno=web.1 -a your-app-name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">agent-wrapper status</span></span></span></code></pre>\n<p class=\"markdown-para\">Ignore the warnings about <code>DD_API_KEY</code> not being set. Heroku doesn't set configuration variables for the SSH session, but the Datadog Agent process is able to access them.</p>\n<p class=\"markdown-para\">Check the output of the status command to verify the API key you configured earlier is valid, and that the APM agent is running:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">API key ending with xxxxx: API Key valid</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[...]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=========</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">APM Agent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=========</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Status: Running</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[...]</span></span></code></pre>\n<aside class=\"markdown-aside\">\nDid you know you can shell into a Heroku dyno? I always thought lack of shell access was a tradeoff of using Heroku and other PaaS (Platform as a Service) in general, so discovering this feature was a pleasant surprise. Check out the <a class=\"markdown-link\" href=\"https://devcenter.heroku.com/articles/exec\">Heroku Exec</a> docs to learn more, it even supports remote debugging!\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"enable-application-tracing\" style=\"position:relative;\"><a href=\"#enable-application-tracing\" aria-label=\"enable application tracing permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enable Application Tracing</h2>\n<p class=\"markdown-para\">The next step is to install and configure the <a href=\"https://github.com/DataDog/dd-trace-rb\" class=\"markdown-link\">datadog</a> gem for the Rails project. Add it to your Gemfile's <code>production</code> group, and optionally <code>staging</code> if you have another environment setup, as shown below:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">group </span><span class=\"mtk4\">:staging</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:production</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  gem </span><span class=\"mtk6\">&quot;datadog&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">require:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;datadog/auto_instrument&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">I intentionally do not install it in <code>development</code> and <code>test</code> groups because the agent isn't running in those environments, which would result in seeing connection errors every time you run a local Rails server or console. This is because the  code in the datadog gem attempts to connect to the agent running on port 8126 to send traces.</p>\n<p class=\"markdown-para\">Run <code>bundle install</code> to apply the changes.</p>\n<aside class=\"markdown-aside\">\nEven though the gem repository on GitHub is named `dd-trace-rb`, the name of the gem is `datadog` and that's what goes in the `Gemfile`. If you were expecting it to be `ddtrace`, that's from the old 1.x version of the gem and has since been renamed as of 2.x, which is what's being used here. See the <a class=\"markdown-link\" href=\"https://github.com/DataDog/dd-trace-rb/blob/release/docs/UpgradeGuide2.md#rename-to-datadog-gem\">Upgrade Guide</a> for more details.\n</aside>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Auto Instrumentation</strong></p>\n<p class=\"markdown-para\">The <code>require: \"datadog/auto_instrument\"</code> in the Gemfile works for supported Ruby frameworks and libraries. This means that the gem will automatically detect calls to controllers, background jobs, ActiveRecord queries, Action Mailer, etc. and send the traces to Datadog. It also instruments every gem in your Rails app that it can. Learn more about <a href=\"https://docs.datadoghq.com/tracing/trace_collection/automatic_instrumentation/?tab=datadoglibraries\" class=\"markdown-link\">Automatic Instrumentation</a>.</p>\n<p class=\"markdown-para\">Without <code>auto_instrument</code>, you would have to manually instrument your code, which means wrapping every section of code you wanted sent to datadog in trace blocks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Datadog</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Tracing</span><span class=\"mtk1\">.</span><span class=\"mtk5\">trace</span><span class=\"mtk1\">(name, </span><span class=\"mtk7\">**</span><span class=\"mtk1\">options) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |span, trace|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Wrap this block around the code you want to instrument</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Additionally, you can modify the span here.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># e.g. Change the resource name, set tags, etc...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">You can also combine auto and manual instrumentation. For example, if there's a particular section of code that you want further details sent to Datadog that the auto instrumentation isn't capturing, you can still wrap your code as shown above. See <a href=\"https://docs.datadoghq.com/tracing/trace_collection/automatic_instrumentation/dd_libraries/ruby/#manual-instrumentation\" class=\"markdown-link\">Manual Instrumentation</a> for further details.</p>\n<p class=\"markdown-para\">Once the <code>datadog</code> gem is installed, add a config initializer for further customization. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/datadog.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">staging?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">production?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Datadog</span><span class=\"mtk1\">.</span><span class=\"mtk5\">configure</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |c|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># set DD logger level to ERROR to reduce log noise.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    c.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">level</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Logger</span><span class=\"mtk1\">::ERROR</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># set environment tag based on the Rails environment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    c.</span><span class=\"mtk5\">env</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">production?</span><span class=\"mtk1\"> </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;prod-my-app-name&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;staging-my-app-name&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># set version tag, eg: `version:v123`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    c.</span><span class=\"mtk5\">version</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&quot;HEROKU_RELEASE_VERSION&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&quot;HEROKU_RELEASE_VERSION&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># optionally capture Sidekiq arguments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    c.</span><span class=\"mtk5\">tracing</span><span class=\"mtk1\">.</span><span class=\"mtk5\">instrument</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:sidekiq</span><span class=\"mtk1\">, </span><span class=\"mtk4\">enabled:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">quantize:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">args:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">show:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:all</span><span class=\"mtk1\"> } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Explanation:</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Rails Environment Check:</strong> By wrapping the initializer in a <code>Rails.env.staging? || Rails.env.production?</code> check, we ensure Datadog configuration only runs in environments where the Datadog agent is running.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Log Level:</strong> Even though earlier we ran <code>heroku config:set DD_LOG_LEVEL=\"error\"</code>, I found it necessary to also set the log level in the initializer to fully quiet all the Datadog logs noise.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Environment Tagging:</strong> Datadog uses the <code>env</code> tag to segment and filter application data by environment, like \"staging\" or \"production\". Setting <code>c.env</code> to <code>prod-my-app-name</code> or <code>staging-my-app-name</code> ensures that traces, are grouped by environment.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Version Tagging:</strong> The <code>version</code> tag tracks specific app versions, which is useful for tracing changes across deployments. Here, we pull <code>HEROKU_RELEASE_VERSION</code> directly from the environment. This allows us to see how a particular deployment performs, compare releases, and track down any regressions or improvements made in recent updates.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Sidekiq:</strong> Although Sidekiq instrumentation is enabled by default as a result of specifying <code>auto_instrument</code> in the <code>Gemfile</code>, the arguments passed to the <code>perform</code> method will show up in Datadog spans as <code>?</code>. If you want to see the actual values the job is being called with, use the <code>quantize</code> option.</li>\n</ul>\n<aside class=\"markdown-aside\">\nYou could simply populate the `env` tag with the value of `Rails.env` if your project is the only one using Datadog at your company. In my case, there were several different teams sharing the same Datadog instance, and we wanted to keep the env tags distinct across project teams.\n</aside>\n<p class=\"markdown-para\">There's a lot more that can be done in the config block, including optionally disabling/enabling integrations. See <a href=\"https://docs.datadoghq.com/tracing/trace_collection/automatic_instrumentation/dd_libraries/ruby/\" class=\"markdown-link\">Tracing Ruby Applications</a> for further details.</p>\n<p class=\"markdown-para\">At this point, we're nearly done with the APM setup. There's just one last step required to tie everything together.</p>\n<h2 class=\"markdown-subtitle\" id=\"unified-service-tagging\" style=\"position:relative;\"><a href=\"#unified-service-tagging\" aria-label=\"unified service tagging permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unified Service Tagging</h2>\n<p class=\"markdown-para\">When the Datadog agent runs on the web and worker dyno's, in addition to sending instrumentation data from the Rails application and background jobs to Datadog, it also sends metrics about the web and worker dynos such as memory and CPU utilization. We need to ensure this information is correctly tagged with the service, environment, and release versions so that the host metrics can be filtered on, and correlated to the APM data. For example, when investigating a particular Rails controller action, it would be interesting to see if there's a memory spike every time it runs.</p>\n<p class=\"markdown-para\">This requires setting up <a href=\"https://docs.datadoghq.com/getting_started/tagging/unified_service_tagging/\" class=\"markdown-link\">Unified Service Tagging</a>. The documentation mentions several different ways to set this up, but on Heroku, our team found this easiest to accomplish with a <a href=\"https://docs.datadoghq.com/agent/basic_agent_usage/heroku/#prerun-script\" class=\"markdown-link\">Prerun script</a>.</p>\n<p class=\"markdown-para\">A Prerun script runs after all of the standard configuration, but immediately before starting the Datadog Agent. Get started by adding the following environment variable:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set DD_HEROKU_CONF_FOLDER=</span><span class=\"mtk6\">&quot;/app/.datadog&quot;</span><span class=\"mtk1\"> -a your-app-name</span></span></span></code></pre>\n<p class=\"markdown-para\">In this case, Datadog will expect to find a folder named <code>.datadog</code> in your project root (not in the Rails <code>app</code> dir, this will be explained shortly), with an executable file named <code>prerun.sh</code>. In this script, the <code>env</code>, <code>service</code>, and <code>version</code> tags are populated. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .datadog/prerun.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$RAILS_ENV</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">==</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;production&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">export</span><span class=\"mtk1\"> DD_ENV=</span><span class=\"mtk6\">&quot;prod-my-app-name&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">elif</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$RAILS_ENV</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">==</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;staging&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">export</span><span class=\"mtk1\"> DD_ENV=</span><span class=\"mtk6\">&quot;staging-my-app-name&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> DD_SERVICE=</span><span class=\"mtk6\">&quot;my-app-name&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk7\">-n</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$HEROKU_RELEASE_VERSION</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">export</span><span class=\"mtk1\"> DD_VERSION=</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">${HEROKU_RELEASE_VERSION}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk7\">-n</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$DD_ENV</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> [ </span><span class=\"mtk7\">-n</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$DD_VERSION</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> [ </span><span class=\"mtk7\">-n</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$DD_SERVICE</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">export</span><span class=\"mtk1\"> DD_TAGS=</span><span class=\"mtk6\">&quot;env:</span><span class=\"mtk1\">${DD_ENV}</span><span class=\"mtk6\">,version:</span><span class=\"mtk1\">${DD_VERSION}</span><span class=\"mtk6\">,service:</span><span class=\"mtk1\">${DD_SERVICE}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">fi</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Why the <code>.datadog</code> directory goes in the project root:</strong></p>\n<p class=\"markdown-para\">On Heroku, your app is deployed within a top-level <code>/app</code> directory, so your project's root directory in the Heroku environment is actually <code>/app</code>. This means that when we specify <code>DD_HEROKU_CONF_FOLDER=\"/app/.datadog\"</code>, the <code>.datadog</code> directory should be created in the root of your project repository, not inside the <code>app</code> directory where Rails controllers, models, and views are located.</p>\n<p class=\"markdown-para\">In other words, your project structure on your laptop will look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── .datadog</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   └── prerun.sh</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── Gemfile</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── Gemfile.lock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── Procfile</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── controllers</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── models</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── views</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── ...</span></span></code></pre>\n<p class=\"markdown-para\">But when it runs on Heroku, it looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── app                   === HEROKU LEVEL APP DIR ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── .datadog</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    │   └── prerun.sh</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── Gemfile</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── Gemfile.lock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── Procfile</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── app               === YOUR RAILS APP DIR ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ├── controllers</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ├── models</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ├── views</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        └── ...</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"deploy\" style=\"position:relative;\"><a href=\"#deploy\" aria-label=\"deploy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy</h2>\n<p class=\"markdown-para\">Once you've merged all the changes to the main branch, you can deploy with <code>git push heroku main</code>. Here’s a quick recap of the changes:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Updated <code>Gemfile</code> and <code>Gemfile.lock</code> to include the <code>datadog</code> gem.</li>\n<li class=\"markdown-list-item\">Created <code>config/initializers/datadog.rb</code> for Datadog configuration within Rails.</li>\n<li class=\"markdown-list-item\">Added <code>.datadog/prerun.sh</code> to consistently tag host metrics with the app's environment, service, and version information.</li>\n</ul>\n<p class=\"markdown-para\">After deployment, give it a few minutes, then open Datadog’s Infrastructure section in the web UI. Use filters like <code>env:...</code>, <code>service:...</code>, or <code>version:...</code> (as configured in <code>prerun.sh</code>) to verify your host metrics and confirm they are tagged correctly.</p>\n<p class=\"markdown-para\">Next, go to APM -> Service Catalog -> Select your service, then from the list of resources (which are your Rails controllers and actions), select any Resource Page. This should also display the host metrics, now correlated with specific resource executions. You should also see telemetry data for the Rails app, with each <code>Controller#action</code> instrumented by Datadog appearing as a Resource.</p>\n<aside class=\"markdown-aside\">\nTelemetry data from Datadog will also include the database queries executed by your Rails app, but if you want deeper insights into PostgreSQL performance, you’ll need to set up Datadog’s PostgreSQL monitoring service, which comes at an additional cost. For more details on configuring PostgreSQL monitoring with Datadog, check out <a class=\"markdown-link\" href=\"https://www.datadoghq.com/monitoring/postgresql-monitoring/\">PostgreSQL Monitoring</a>. My team isn't using this feature at the time of this writing.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"memory-usage\" style=\"position:relative;\"><a href=\"#memory-usage\" aria-label=\"memory usage permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Memory Usage</h2>\n<p class=\"markdown-para\">Since the Datadog agent is another process that will always be running on your dyno's, be aware that it does consume additional memory. Our staging environment was using the Basic dyno type, which only has 512MB of memory, and it started crashing frequently after adding the Datadog agent. To resolve this we had to upgrade to the Standard dyno type. To be fair, it was the Rails app was consuming most of this memory, and adding the Datadog agent just pushed it over the edge.</p>\n<p class=\"markdown-para\">Although the Heroku web dashboard shows memory consumption, it doesn't break this down by process. To view memory consumption for both the Datadog agent, and the Rails app on either the web or worker dyno's, you can shell in as we did before to check the agent status, then run the <code>ps</code> command, to display processes by descending memory:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku ps:exec --dyno=web.1 -a your-app-name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ps auxww --sort=-%mem</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe Heroku docs have the complete list of <a class=\"markdown-link\" href=\"https://www.heroku.com/dynos\">Dyno Types</a>. Notice the steep price increase from Basic to Standard. This is the cost of the convenience of a PaaS. Although with consistent improvements in deployment tooling such as <a class=\"markdown-link\" href=\"https://kamal-deploy.org/\">Kamal</a>, it may be possible to get this convenience at a lower price.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"terminal-visual-cues\" style=\"position:relative;\"><a href=\"#terminal-visual-cues\" aria-label=\"terminal visual cues permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Terminal Visual Cues</h2>\n<p class=\"markdown-para\">A few times during this post, we had to shell into Heroku to check on things. To <a href=\"https://np.reddit.com/r/cscareerquestions/comments/6ez8ag/accidentally_destroyed_production_database_on/\" class=\"markdown-link\">avoid disasters</a>, I like to change my terminal tab colors to make it obvious that I'm no longer in my own laptop's shell. You can change the terminal tab colors by adding a function to your shell profile (<code>~/.bash_profile</code> or <code>~/.zshrc</code>), which will adjust the red, green, and blue values of the tab background.</p>\n<p class=\"markdown-para\">Add the following to your profile:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Define a function to set the tab color in your terminal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">tab-color</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> -ne </span><span class=\"mtk6\">&quot;\\033]6;1;bg;red;brightness;</span><span class=\"mtk1\">$1</span><span class=\"mtk6\">\\a&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> -ne </span><span class=\"mtk6\">&quot;\\033]6;1;bg;green;brightness;</span><span class=\"mtk1\">$2</span><span class=\"mtk6\">\\a&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> -ne </span><span class=\"mtk6\">&quot;\\033]6;1;bg;blue;brightness;</span><span class=\"mtk1\">$3</span><span class=\"mtk6\">\\a&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Functions to quickly set a specific color.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Adjust as per your preference.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">tab-green</span><span class=\"mtk1\">() { tab-color 0 255 0</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> }   </span><span class=\"mtk3\"># For staging</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">tab-red</span><span class=\"mtk1\">() { tab-color 255 0 0</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> }     </span><span class=\"mtk3\"># For production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Function to reset the color back to the default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">tab-reset</span><span class=\"mtk1\">() { </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> -ne </span><span class=\"mtk6\">&quot;\\033]6;1;bg;*;default\\a&quot;</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> }</span></span></span></code></pre>\n<p class=\"markdown-para\">To demonstrate, here is what my regular terminal tabs look like:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 532px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABF0lEQVR42q2Q207CQBCGZ4sSHwAqQqDAHtru9kDpSQwX3njjA3ihMTyMXhnf+ddugWiESIwX3878M7Ozf5buM4PbOx+TVIHPOKacg0sFoRS4UpgLibKuUVRVW/d9zISwufR9q5tcmwjcxCBvMsVYzNEfe5iJAKHWcAcD9NxL9FwXY8+zF4NQg0tpH7pZr5EuMsybxUIi0AZFWaE/HIF6jy+4en7DcPOO0dMrrh826JocpFIwfwEnzMCCBZwgQydcWi6SGuemsL1Gn+kc3ahERyUglqywg+IVWFyDTPWF8ie6aNnrFkfnIGqObxS/Yw7VSjjhEnTQwc7Fsd6R2XbhKY5OYu+wAkX/g/1DplKQTEDq77BtdD7jBzCd+6jkNxnkAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"iterm tab regular\"\n        title=\"iterm tab regular\"\n        src=\"/static/10f98946d6a30bd5b52090cfc5db4e37/89a37/iterm-tab-regular.png\"\n        srcset=\"/static/10f98946d6a30bd5b52090cfc5db4e37/772e8/iterm-tab-regular.png 200w,\n/static/10f98946d6a30bd5b52090cfc5db4e37/e17e5/iterm-tab-regular.png 400w,\n/static/10f98946d6a30bd5b52090cfc5db4e37/89a37/iterm-tab-regular.png 532w\"\n        sizes=\"(max-width: 532px) 100vw, 532px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">After running the <code>tab-green</code> function:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 535px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABRUlEQVR42qXOO0vDUBjG8bctuFSjYq+klzRtk9ScRtO0qdZBvG/ODjp1E7r4GQRHwV0EBT+Ao4i7n+ovbaq2ghd0+PGe53B4zisHfpOtXYdSYGOaNSp1C9OyqVr2aA5zsL5GsNHFXLaoKoeq50TTjZiujRt4VNwmUtZ1CkaBlK5TLBuUDIN0NstSOkMql6GYKqGfFdFeFkg+asw+aSTvNZIPGsnncX6aY/5mkXytjBT6VxiDOyqDW8zTayrbhyy1eyy0eiQaPvH6KhJ6yL6L7KnIlkJ21Ece2mySsD0kf3JOrn9Jvn9J+viC4KjPjN8jprqIChG3gzghUguR+pg1cX6/6xJvBIhYHlNsH1luT3PbiBrPr6gO8UYLiQ83cMMJnWmjws73xm+iws/b/NVbYeyn339LhVFhwvGJDdn/sTrqSNgrvAIUmAMIY6WCPgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"iterm tab green\"\n        title=\"iterm tab green\"\n        src=\"/static/577555d6fc88ee385754c2e515465691/b5245/iterm-tab-green.png\"\n        srcset=\"/static/577555d6fc88ee385754c2e515465691/772e8/iterm-tab-green.png 200w,\n/static/577555d6fc88ee385754c2e515465691/e17e5/iterm-tab-green.png 400w,\n/static/577555d6fc88ee385754c2e515465691/b5245/iterm-tab-green.png 535w\"\n        sizes=\"(max-width: 535px) 100vw, 535px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">After running <code>tab-red</code>:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 533px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABU0lEQVR42q2PvUrDYBSGv9bFpZoSG6021bT5EvNjm5jUVkSpKOogCK6CICKCg+Do4CZ4CU5ugjfg6qRIcPd6Hi2xrZU6CA4P7/nhvLxH7EUu7S0boyaRRgXTNLGkHGCt2aQdx9RNk9CShJUKoVlNaykJpKTl+9iej5ieKVGc1VGnS5QNk7lqFVWbRNU0CgUNRS9zVdJ5V1VeFYUknydxPRK9TDI2TqIovE0UeJIW5lQRUTq7Y/b8HuPiAeP0lvFoFW25Tb6xStZZRDiLjNoBilVH6WiHWhPFjfv9fMiYGzNiBwjn+hn7+gXn5g378pH6/gH51jqj4QrCa3xjqV+7McL9MfMaZNwIkds6Ird9TG7nhNzmIfrGLqKzcKKvwyF4w2aN9CMhfVI8hLWAsILBJAMpf6FnGCHS2EsIP9VM76W/0k3YNfsHMh3jjFVHWLV/IfupH0mgB5EM6xMnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"iterm tab red\"\n        title=\"iterm tab red\"\n        src=\"/static/63d48dafd6472dde24a159beee20b7e7/a1aa0/iterm-tab-red.png\"\n        srcset=\"/static/63d48dafd6472dde24a159beee20b7e7/772e8/iterm-tab-red.png 200w,\n/static/63d48dafd6472dde24a159beee20b7e7/e17e5/iterm-tab-red.png 400w,\n/static/63d48dafd6472dde24a159beee20b7e7/a1aa0/iterm-tab-red.png 533w\"\n        sizes=\"(max-width: 533px) 100vw, 533px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">And resetting:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 538px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABXklEQVR42qWRu0oDQRhGZ9WorcaESLKauDsz7rqabJLdNSZaGC28PIMvYEAQBEGsBMFnsBAbLQULG0sb3+rIbKJ4R7A4zJyZj4+fGbFZDdjoauYihVt2cFwXV0qkVEilUo/imDhJUldav2XM3mCyQbCAChYRxdIMxfIMUyUbu+LiKk2uME02lyebz1O0bVyt0b6PIxVzUtLqdKjW61QcN3XleTSiiHzRRkzvXTB7cMNs75pK74pCZ5upeJVsvMaQV8eaN4Qpxg1jSwmZIMIa+LDfYMS4riGcw1v0+TPq7Al5+shEe4dce53JlS5WECMWoq94TYTf/HjmGxqI8v4lzskDzvE9ztEd7b0e47VlxsN2v9BvfiUt+ebMayBGmxtkWruMLu+QSbaYaHX7AXP5Gvw8zWfeF1q6ipivId7W8GPwr7wWDhkJkgFxn9+m+Yn0eUyhrmHpMP2h/xFiul4AKawF6uihHggAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"iterm tab reset\"\n        title=\"iterm tab reset\"\n        src=\"/static/a62530685f3d9a324ecc93b382f68294/9516f/iterm-tab-reset.png\"\n        srcset=\"/static/a62530685f3d9a324ecc93b382f68294/772e8/iterm-tab-reset.png 200w,\n/static/a62530685f3d9a324ecc93b382f68294/e17e5/iterm-tab-reset.png 400w,\n/static/a62530685f3d9a324ecc93b382f68294/9516f/iterm-tab-reset.png 538w\"\n        sizes=\"(max-width: 538px) 100vw, 538px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Next, define aliases for shelling into your Heroku environments (for example: staging and production) that will use the tab color functions. My aliases are as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SSH into Heroku staging dyno and turn tab green</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">alias</span><span class=\"mtk1\"> hss=</span><span class=\"mtk6\">&#39;tab-green &amp;&amp; heroku ps:exec --dyno=web.1 -a your-staging-app&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SSH into Heroku production dyno and turn tab red</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">alias</span><span class=\"mtk1\"> hsp=</span><span class=\"mtk6\">&#39;tab-red &amp;&amp; heroku ps:exec --dyno=web.1 -a your-production-app&#39;</span></span></span></code></pre>\n<p class=\"markdown-para\">If using <a href=\"https://github.com/ohmyzsh/ohmyzsh\" class=\"markdown-link\">ohmyzsh</a>, add the above aliases to <code>~/.oh-my-zsh/custom/aliases.zsh</code>. Otherwise add them wherever you usually add aliases.</p>\n<p class=\"markdown-para\">Customize the aliases for whatever you'll remember. For me I think of:</p>\n<p class=\"markdown-para\"><kbd class=\"markdown-kbd\">h</kbd>eroku <kbd class=\"markdown-kbd\">s</kbd>hell <kbd class=\"markdown-kbd\">s</kbd>taging</p>\n<p class=\"markdown-para\"><kbd class=\"markdown-kbd\">h</kbd>eroku <kbd class=\"markdown-kbd\">s</kbd>hell <kbd class=\"markdown-kbd\">p</kbd>roduction</p>\n<p class=\"markdown-para\">Now whenever you shell into either staging or production, you'll have a strong visual cue that you're in a deployed environment.</p>\n<aside class=\"markdown-aside\">\nI use <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/how-i-setup-my-terminal/\">iTerm with ohmyzsh</a>, so the above technique has only been tested on this particular setup. Further details can be found on this superuser question <a class=\"markdown-link\" href=\"https://superuser.com/questions/403650/programmatically-set-the-color-of-a-tab-in-iterm2\">Programmatically set the color of a tab in iTerm2</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p class=\"markdown-para\">In this guide, we walked through integrating Datadog APM for a Rails application hosted on Heroku. Key steps included adding the Datadog buildpack, enabling Heroku dyno metadata, configuring environment variables for the Datadog agent, setting up unified service tagging, and setting up auto instrumentation in the Rails application with the <code>datadog</code> gem. We also learned that you can shell into a Heroku dyno, and useful tips for terminal tab management.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">References:</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://docs.datadoghq.com/agent/basic_agent_usage/heroku/\" class=\"markdown-link\">Datadog Heroku Buildpack</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://devcenter.heroku.com/articles/dyno-metadata\" class=\"markdown-link\">Heroku Labs Dyno Metadata</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://docs.datadoghq.com/tracing/trace_collection/automatic_instrumentation/dd_libraries/ruby/\" class=\"markdown-link\">Tracing Ruby Applications</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://docs.datadoghq.com/tracing/glossary/\" class=\"markdown-link\">APM Terms and Concepts</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":13,"tableOfContents":"<ul>\n<li><a href=\"#high-level\">High Level</a></li>\n<li><a href=\"#install-buildpack\">Install Buildpack</a></li>\n<li><a href=\"#enable-dyno-metadata\">Enable Dyno Metadata</a></li>\n<li><a href=\"#configure-agent\">Configure Agent</a></li>\n<li><a href=\"#apply-buildpack\">Apply Buildpack</a></li>\n<li><a href=\"#enable-application-tracing\">Enable Application Tracing</a></li>\n<li><a href=\"#unified-service-tagging\">Unified Service Tagging</a></li>\n<li><a href=\"#deploy\">Deploy</a></li>\n<li><a href=\"#memory-usage\">Memory Usage</a></li>\n<li><a href=\"#terminal-visual-cues\">Terminal Visual Cues</a></li>\n<li><a href=\"#summary\">Summary</a></li>\n</ul>","frontmatter":{"title":"Datadog APM for Rails on Heroku","date":"05 Jan 2025","description":"Learn how to set up Datadog APM for a Rails application on Heroku, including installation, configuration, and tips for optimizing performance monitoring.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#788878","images":{"fallback":{"src":"/static/fc31ba5a8579d623b268d0270180a635/fc2d4/datadog-heroku-rails-chewy-EV9_vVMZTcg-unsplash.jpg","srcSet":"/static/fc31ba5a8579d623b268d0270180a635/b834a/datadog-heroku-rails-chewy-EV9_vVMZTcg-unsplash.jpg 225w,\n/static/fc31ba5a8579d623b268d0270180a635/21c52/datadog-heroku-rails-chewy-EV9_vVMZTcg-unsplash.jpg 450w,\n/static/fc31ba5a8579d623b268d0270180a635/fc2d4/datadog-heroku-rails-chewy-EV9_vVMZTcg-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/fc31ba5a8579d623b268d0270180a635/71a10/datadog-heroku-rails-chewy-EV9_vVMZTcg-unsplash.webp 225w,\n/static/fc31ba5a8579d623b268d0270180a635/901f1/datadog-heroku-rails-chewy-EV9_vVMZTcg-unsplash.webp 450w,\n/static/fc31ba5a8579d623b268d0270180a635/4ffff/datadog-heroku-rails-chewy-EV9_vVMZTcg-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":600}}}},"fields":{"slug":"/blog/datadog-heroku-rails/"}},"relatedP":{"edges":[{"node":{"id":"18a6d127-ce72-5612-bd26-5b4b9e5c0892","frontmatter":{"title":"Using Heroku's pg:pull with Docker","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#383848","images":{"fallback":{"src":"/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/26528/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.jpg","srcSet":"/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/26528/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.jpg 300w,\n/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/43429/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/5d6c3/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.webp 300w,\n/static/9ce87e400f8dc9c374f9c9bc7d9a7aa0/68dbc/pull-rebecca-campbell-81UDWsR6Ehw-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/heroku_pg_pull_and_docker/"}}},{"node":{"id":"d28e59ce-a5a4-5fb8-806f-c6d46d07ca4f","frontmatter":{"title":"How I Setup my Terminal","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#d8d8d8","images":{"fallback":{"src":"/static/c2e1140c0912270d2a20800e2b8aa88b/26528/terminal-cookie-the-pom-gySMaocSdqs-unsplash.jpg","srcSet":"/static/c2e1140c0912270d2a20800e2b8aa88b/26528/terminal-cookie-the-pom-gySMaocSdqs-unsplash.jpg 300w,\n/static/c2e1140c0912270d2a20800e2b8aa88b/43429/terminal-cookie-the-pom-gySMaocSdqs-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/c2e1140c0912270d2a20800e2b8aa88b/5d6c3/terminal-cookie-the-pom-gySMaocSdqs-unsplash.webp 300w,\n/static/c2e1140c0912270d2a20800e2b8aa88b/68dbc/terminal-cookie-the-pom-gySMaocSdqs-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/how-i-setup-my-terminal/"}}},{"node":{"id":"3e795729-0818-5a18-97e1-fc7e0d67a176","frontmatter":{"title":"Automate Tabs & Commands in iTerm2","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#d8c8b8","images":{"fallback":{"src":"/static/fb78290dc10d789b9a100d0d2c95c04f/26528/automation-2-jan-jakub-nanista-UHyrjKPsshk-unsplash.jpg","srcSet":"/static/fb78290dc10d789b9a100d0d2c95c04f/26528/automation-2-jan-jakub-nanista-UHyrjKPsshk-unsplash.jpg 300w,\n/static/fb78290dc10d789b9a100d0d2c95c04f/43429/automation-2-jan-jakub-nanista-UHyrjKPsshk-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/fb78290dc10d789b9a100d0d2c95c04f/5d6c3/automation-2-jan-jakub-nanista-UHyrjKPsshk-unsplash.webp 300w,\n/static/fb78290dc10d789b9a100d0d2c95c04f/68dbc/automation-2-jan-jakub-nanista-UHyrjKPsshk-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/iterm-automation/"}}}]}},"pageContext":{"slug":"/blog/datadog-heroku-rails/","relatedPosts":["Using Heroku's pg:pull with Docker","How I Setup my Terminal","Automate Tabs & Commands in iTerm2"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}