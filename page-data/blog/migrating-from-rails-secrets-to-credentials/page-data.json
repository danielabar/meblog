{"componentChunkName":"component---src-templates-post-js","path":"/blog/migrating-from-rails-secrets-to-credentials/","result":{"data":{"markdownRemark":{"html":"<p class=\"markdown-para\">I've been maintaining a 10+ year old legacy Rails application, upgrading it from Rails 6.1 to 7.0, and then 7.0 to 7.1. We'll eventually get to Rails 7.2, and then 8, but as per the Rails guide on <a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#the-upgrade-process\" class=\"markdown-link\">upgrading</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">It's best to move slowly, one minor version at a time, in order to make good use of the deprecation warnings.</p>\n</blockquote>\n<p class=\"markdown-para\">After a successful release of the 6.1 to 7.0 upgrade, I was working on the 7.1 upgrade, and found myself facing this deprecation warning:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">DEPRECATION WARNING:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">`Rails.application.secrets` is deprecated in favor of `Rails.application.credentials`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and will be removed in Rails 7.2.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(called from &lt;main&gt; at my-app/config/environment.rb:5)</span></span></code></pre>\n<p class=\"markdown-para\">This was surprising because:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">There hadn't been any mention of this in the upgrade guide from 7.0 to 7.1.</li>\n<li class=\"markdown-list-item\">This project uses environment variables (provided via Heroku Config) for secrets, so as far as I knew, there weren't any secrets in the code.</li>\n</ol>\n<p class=\"markdown-para\">It turns out, what used to be called \"secrets\", now referred to as \"credentials\" is a non-obvious aspect of Rails with a long history. Unless you've been the first developer to setup and deploy a Rails project, you may never have encountered this feature. This post will explain what secrets and credentials are, and cover a few options for resolving this deprecation warning.</p>\n<p class=\"markdown-para\">In a hurry? Jump straight to the <a href=\"../migrating-from-rails-secrets-to-credentials#solution-a-replace-secrets-with-environment-variable\" class=\"markdown-link\">solutions</a>. Otherwise read on for the investigation and history on this topic.</p>\n<h2 class=\"markdown-subtitle\" id=\"investigation\" style=\"position:relative;\"><a href=\"#investigation\" aria-label=\"investigation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Investigation</h2>\n<p class=\"markdown-para\">Here is the file that was referred to in the deprecation warning <code>config/environment.rb</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Load the Rails application.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require_relative</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;application&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Initialize the Rails application.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">initialize!</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># === DEPRECATION WARNING FROM THIS LINE ===</span></span></span></code></pre>\n<p class=\"markdown-para\">A search through the entire project for <code>Rails.application.secrets</code> didn't yield any matches. This must have been something in library code or deeper in Rails internals.</p>\n<p class=\"markdown-para\">Up until this point, I had been following the guide for upgrading from 7.0 to 7.1. Aside from a section about the development and test <a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#development-and-test-environments-secret-key-base-file-changed\" class=\"markdown-link\">secret key base file having been renamed</a>, I couldn't find anything related to a migration from secrets to credentials.</p>\n<p class=\"markdown-para\">I then wondered if I had missed a step in the previous upgrade related to secrets and credentials, or if the previous maintainer had missed a step in earlier upgrades? To answer this question I went through all the upgrade guides back to the first version of this project, which was 4.1, and couldn't find anything about migrating secrets to credentials:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-7-0-to-rails-7-1\" class=\"markdown-link\">7.0 to 7.1</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-6-1-to-rails-7-0\" class=\"markdown-link\">6.1 to 7.0</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-6-0-to-rails-6-1\" class=\"markdown-link\">6.0 to 6.1</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-5-2-to-rails-6-0\" class=\"markdown-link\">5.2 to 6.0</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-5-1-to-rails-5-2\" class=\"markdown-link\">5.1 to 5.2</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-5-0-to-rails-5-1\" class=\"markdown-link\">5.0 to 5.1</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-4-2-to-rails-5-0\" class=\"markdown-link\">4.2 to 5.0</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-4-1-to-rails-4-2\" class=\"markdown-link\">4.1 to 4.2</a></li>\n</ul>\n<p class=\"markdown-para\">In order to resolve the deprecation warning, I would first have to understand what is this \"secrets\" feature?</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Quick Tip</strong></p>\n<p class=\"markdown-para\">By default, in development mode, deprecation warnings are logged to <code>log/development.log</code>, which can be easy to miss. To raise their visibility, update your <code>config/environments/development.rb</code> file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Print deprecation notices to the Rails logger (default behavior).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config.active_support.deprecation = :log</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Print deprecation notices to stderr for better visibility in the console.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">config.</span><span class=\"mtk5\">active_support</span><span class=\"mtk1\">.</span><span class=\"mtk5\">deprecation</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:stderr</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Optional: Temporarily raise an error for deprecations during debugging.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config.active_support.deprecation = :raise</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"what-is-railsapplicationsecrets\" style=\"position:relative;\"><a href=\"#what-is-railsapplicationsecrets\" aria-label=\"what is railsapplicationsecrets permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is Rails.application.secrets</h2>\n<p class=\"markdown-para\">A new file named <code>config/secrets.yml</code> was introduced back in Rails 4.1 (which was the initial version of Rails this project started on).</p>\n<p class=\"markdown-para\">The <a href=\"https://guides.rubyonrails.org/4_1_release_notes.html#config-secrets-yml\" class=\"markdown-link\">4.1 Release Notes</a> explain that it's primarily used to store the application's <code>secret_key_base</code>.</p>\n<p class=\"markdown-para\">From the Rails API docs on <a href=\"https://api.rubyonrails.org/classes/Rails/Application.html#method-i-secret_key_base\" class=\"markdown-link\">secret_key_base</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">The secret_key_base is used as the input secret to the application’s key generator, which in turn is used to create all ActiveSupport::MessageVerifier and ActiveSupport::MessageEncryptor instances, including the ones that sign and encrypt cookies.</p>\n</blockquote>\n<p class=\"markdown-para\">This means <code>secret_key_base</code> needs to be:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">A closely guarded secret:</strong> It's critical for the security of the application because it's used to generate encryption and signing keys for sensitive operations.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Consistent across Rails upgrades and deployments:</strong> Changing the <code>secret_key_base</code> would invalidate all existing cookies and encrypted data (e.g., session cookies), effectively signing out all users and potentially causing issues with any other data encrypted or signed with it.</li>\n</ol>\n<p class=\"markdown-para\">I then opened the <code>config/secrets.yml</code> on the project I was upgrading and found this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Be sure to restart your server when you modify this file.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Your secret key is used for verifying the integrity of signed cookies.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># If you change this key, all old signed cookies will become invalid!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Make sure the secret is at least 30 characters and all random,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># no regular words or you&#39;ll be exposed to dictionary attacks.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># You can use `rake secret` to generate a secure secret key.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Make sure the secrets in this file are kept private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># if you&#39;re sharing your code publicly.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">development</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">d9d6241...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">test</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">638095d...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">staging</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Do not keep production secrets in the repository,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># instead read values from the environment.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">production</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">This file is used to persist environment-specific values of <code>secret_key_base</code>. It also supports erb interpolation, so you can commit plain text values, or reference an environment variable via <code>ENV</code>. The <code>secret_key_base</code> can then be accessed by Rails and application code as <code>Rails.application.secret_key_base</code>.</p>\n<p class=\"markdown-para\">This file also supports storage of <em class=\"markdown-emphasis\">all</em> the application's secrets. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">development</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">d9d6241...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">stripe_secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">devstripe...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">another_secret</span><span class=\"mtk1\">: </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">test</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">638095d...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">stripe_secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">testtripe...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">another_secret</span><span class=\"mtk1\">: </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">staging</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">stripe_secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&quot;STRIPE_SECRET_KEY&quot;] %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">another_secret</span><span class=\"mtk1\">: </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Do not keep production secrets in the repository,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># instead read values from the environment.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">production</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">stripe_secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&quot;STRIPE_SECRET_KEY&quot;] %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">another_secret</span><span class=\"mtk1\">: </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span></code></pre>\n<p class=\"markdown-para\">The other secrets could then be accessed in application code, for example: <code>Rails.application.secrets.stripe_secret_key</code>.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Potential security issues:</strong></p>\n<p class=\"markdown-para\">Although the comments in this file warn to use environment variables for production, there is nothing to enforce it. So if a team didn't have a way to easily manage environment variables, it's possible that some teams may have started committing their plain text secrets in this file. This may explain why this feature had to change.</p>\n<h2 class=\"markdown-subtitle\" id=\"history\" style=\"position:relative;\"><a href=\"#history\" aria-label=\"history permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>History</h2>\n<p class=\"markdown-para\">I dug through the history of release notes from 4.1 to 7.2 to understand how this feature has changed over time:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">4.1 Plain Text Secrets</strong></p>\n<p class=\"markdown-para\">This release introduced <code>config/secrets.yml</code>, which is a plain text yaml file. It supports erb interpolation so that secrets can optionally be read from an environment variable rather than hard-coded in the file. Rails accesses the secret key base from this file via <code>Rails.application.secrets.secret_key_base</code>.</p>\n<p class=\"markdown-para\"><a href=\"https://guides.rubyonrails.org/4_1_release_notes.html#config-secrets-yml\" class=\"markdown-link\">Release Notes</a></p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">5.0</strong></p>\n<p class=\"markdown-para\">No changes to the secrets feature.</p>\n<p class=\"markdown-para\"><a href=\"https://guides.rubyonrails.org/5_0_release_notes.html\" class=\"markdown-link\">Release Notes</a></p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">5.1 Encrypted Secrets</strong></p>\n<p class=\"markdown-para\">This release was a first attempt at encrypting the secrets. A rake task was introduced which would generate a new file <code>config/secrets.yml.enc</code>, along with a master key that could be used to encrypt and decrypt the file. The master key had to be maintained outside of the source. Rails could read it either from a git ignored file <code>config/secrets.yml.key</code> or from a new environment variable <code>RAILS_MASTER_KEY</code>.</p>\n<p class=\"markdown-para\">The idea was you would move all the plain text secrets previously in <code>config/secrets.yml</code> to the new encrypted <code>config/secrets.yml.enc</code>. Note that there's no instructions on exactly how to do this - for example, can you copy the entire contents of the plain text <code>config/secrets.yml</code>, including nesting for each environment and erb interpolation, and dump that into the new encrypted file?</p>\n<p class=\"markdown-para\"><a href=\"https://guides.rubyonrails.org/5_1_release_notes.html#encrypted-secrets\" class=\"markdown-link\">Release Notes</a></p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">5.2 Encrypted Credentials</strong></p>\n<p class=\"markdown-para\">This release refined the encryption concept, referring to it as <a href=\"https://guides.rubyonrails.org/v5.2/security.html#custom-credentials\" class=\"markdown-link\">custom credentials</a> rather than \"secrets\". Another new file was introduced <code>config/credentials.yml.enc</code>, along with a <code>config/master.key</code> containing the key to encrypt and decrypt the credentials file.</p>\n<p class=\"markdown-para\">If you had previously migrated from <code>config/secrets.yml</code> to <code>config/secrets.yml.enc</code>, you would now migrate to <code>config/credentials.yml.enc</code>. However, there are no instructions on how to take the previous environment-specific plain text or erb interpolated values from the old file to the new encrypted file.</p>\n<p class=\"markdown-para\">There's a single <code>config/master.key</code> intended to be used across all environments. For example, you might have multiple deployed environments like staging and production, and having a shared master key across both of them is not ideal.</p>\n<p class=\"markdown-para\">At this time, the previous plain text secrets were still supported. The 5.1 release notes have an important message:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">This will eventually replace Rails.application.secrets and the encrypted secrets introduced in Rails 5.1</p>\n</blockquote>\n<p class=\"markdown-para\">Here is where it would have been useful to start having deprecation warnings.</p>\n<p class=\"markdown-para\"><a href=\"https://guides.rubyonrails.org/5_2_release_notes.html#credentials\" class=\"markdown-link\">Release Notes</a></p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">6.0 Multi Environment Credentials</strong></p>\n<p class=\"markdown-para\">This release maintained the previous encrypted credentials, but added support for multi-environment credentials. This is only mentioned as a bullet point in the release notes under \"Notable changes\". The associated <a href=\"https://github.com/rails/rails/pull/33521\" class=\"markdown-link\">PR</a> has some lively discussion. But once again, there's no instructions for how to convert from old plain text secrets to environment-specific encrypted credentials.</p>\n<p class=\"markdown-para\">The <a href=\"https://guides.rubyonrails.org/v6.0/security.html#environmental-security\" class=\"markdown-link\">securing rails application guide for 6.0</a> has the same explanation as the previous 5.2 guide for how to use encrypted credentials, but it doesn't mention the new environment-specific options introduced in the PR.</p>\n<p class=\"markdown-para\"><a href=\"https://guides.rubyonrails.org/6_0_release_notes.html\" class=\"markdown-link\">Release Notes</a></p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">7.0</strong></p>\n<p class=\"markdown-para\">This release maintained the previous encrypted credentials with no notable changes.</p>\n<p class=\"markdown-para\"><a href=\"https://guides.rubyonrails.org/7_0_release_notes.html\" class=\"markdown-link\">Release Notes</a></p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">7.1 Secrets Deprecation</strong></p>\n<p class=\"markdown-para\">This release maintains the previous encrypted credentials and adds a <a href=\"https://guides.rubyonrails.org/7_1_release_notes.html#railties-deprecations\" class=\"markdown-link\">deprecation notice</a> for favouring credentials over secrets. This explains why I only started seeing the deprecation message during the 7.0 to 7.1 upgrade.</p>\n<p class=\"markdown-para\"><a href=\"https://guides.rubyonrails.org/7_1_release_notes.html\" class=\"markdown-link\">Release Notes</a></p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">7.2 Secrets Dropped</strong></p>\n<p class=\"markdown-para\">This release drops support for <code>Rails.application.secrets</code>. Trying to reference it will result in an error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">secrets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># undefined method `secrets&#39; for an instance of SomeApp::Application (NoMethodError)</span></span></span></code></pre>\n<p class=\"markdown-para\"><a href=\"https://guides.rubyonrails.org/7_2_release_notes.html\" class=\"markdown-link\">Release Notes</a></p>\n<p class=\"markdown-para\">Now that we've covered the history from secrets and secret key base, to credentials and master key, we're finally ready to resolve the deprecation. There's a few different ways to solve this. The next sections will provide some guidance to help you choose what's most appropriate for your project.</p>\n<h2 class=\"markdown-subtitle\" id=\"solution-a-replace-secrets-with-environment-variable\" style=\"position:relative;\"><a href=\"#solution-a-replace-secrets-with-environment-variable\" aria-label=\"solution a replace secrets with environment variable permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution A: Replace Secrets with Environment Variable</h2>\n<p class=\"markdown-para\">On our team, we found the easiest way to resolve this was to remove the secrets file, and not introduce the replacement credentials file, in favour of an environment variable <code>SECRET_KEY_BASE</code>.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Consider this solution if:</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">The only secret in <code>config/secrets.yml</code> is the <code>secret_key_base</code>.</li>\n<li class=\"markdown-list-item\">The project has access to a tool for converting secrets to environment variables in deployed environments (eg: AWS Parameter Store, Hashicorp Vault, Heroku Config, etc.)</li>\n</ul>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Steps:</strong></p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Make sure <code>SECRET_KEY_BASE</code> is defined in every deployed environments' configuration (eg: staging, production).</li>\n<li class=\"markdown-list-item\">Make a backup of the original <code>config/secrets.yml</code> outside of source control and remove it from the project.</li>\n<li class=\"markdown-list-item\">In development and test environments, do nothing, Rails will automatically generate a git ignored file <code>tmp/local_secret.txt</code> containing a randomly generated value of <code>secret_key_base</code>, if it can't find a <code>SECRET_KEY_BASE</code> environment variable and there is no encrypted credentials yaml.</li>\n<li class=\"markdown-list-item\">Commit the changes to source control (which is just the removal of <code>config/secrets.yml</code>).</li>\n</ol>\n<aside class=\"markdown-aside\">\nContinuity of the `secret_key_base` value doesn't matter for development and test so it should be fine to let Rails generate a new one in those environments. These environments are normally reset frequently and there's no need to ensure a dev/test user that was logged in on your localhost needs to remain so after a Rails upgrade.\n</aside>\n<p class=\"markdown-para\"><em class=\"markdown-emphasis\"><strong class=\"markdown-strong\">Optionally</strong></em>, if you want development and test environments to be consistent with the technique used in deployed environments, the <code>SECRET_KEY_BASE</code> environment variable can be added to <code>.env.development</code> and <code>.env.test</code>, with the value being whatever it was in the old <code>config/secrets.yml</code>, development and test sections. Then Rails will read from the environment variable rather than generating a <code>tmp/local_secret.txt</code>. This will work given that the project is using the <a href=\"https://rubygems.org/gems/dotenv-rails\" class=\"markdown-link\">dotenv-rails</a> gem.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Verify:</strong></p>\n<p class=\"markdown-para\">Run a Rails console on your laptop (i.e. development mode) to check the value of the secret key base:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">secret_key_base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#=&gt; should be value from `tmp/local_secret.txt`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># OR</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .env.development SECRET_KEY_BASE</span></span></span></code></pre>\n<p class=\"markdown-para\">After deploying the changes to production (or staging first if you have another deployed environment), connect to a Rails console on the deployed environment and check the value of the secret key base:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">secret_key_base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#=&gt; should be value from SECRET_KEY_BASE env var defined in deployed environment</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Why this works:</strong></p>\n<p class=\"markdown-para\">Rails first searches for the <code>secret_key_base</code> value in <code>ENV[\"SECRET_KEY_BASE\"]</code>. If this environment variable is not found, then Rails will search for it in the new encrypted credentials yaml file. If your old <code>config/secrets.yml</code> already contained <code>&#x3C;%= ENV[\"SECRET_KEY_BASE\"] %></code>, then effectively it was already reading an environment variable, and the yaml file was just serving as a pass-through.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Benefits:</strong></p>\n<p class=\"markdown-para\">Switching to an environment variable for managing <code>SECRET_KEY_BASE</code> simplifies and standardizes secret management across all environments. This consistency ensures future developers don’t spend time deciphering why some secrets are managed in a yaml file and some with environment variables. This also aligns with standard practices for managing environment variables securely in deployment pipelines.</p>\n<h2 class=\"markdown-subtitle\" id=\"solution-b-convert-secrets-to-credentials\" style=\"position:relative;\"><a href=\"#solution-b-convert-secrets-to-credentials\" aria-label=\"solution b convert secrets to credentials permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution B: Convert Secrets to Credentials</h2>\n<p class=\"markdown-para\">In this solution, all the secrets in <code>config/secrets.yml</code> will be converted to the new encrypted credentials format. We'll use the environment-specific support introduced as of Rails 6.0 to isolate both the secrets and the master key needed to decrypt/encrypt them on a per-environment basis.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Consider this solution if:</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">There are multiple secrets stored in <code>config/secrets.yml</code> in addition to <code>secret_key_base</code>. i.e. the application code has references to <code>Rails.application.secrets.some_secret</code>, <code>Rails.application.secrets.another_secret</code>, etc.</li>\n<li class=\"markdown-list-item\">Your project is not configured with a tool to convert secrets to environment variables. Keep in mind you'll still need to manage one new secret <code>RAILS_MASTER_KEY</code>.</li>\n</ul>\n<p class=\"markdown-para\">For example, suppose the <code>config/secrets.yml</code> contains plain-text values from all environments (assuming it was a private source repository and if the team didn't have a secrets manager, then this would have been the easiest option, albeit not that secure should the source code get leaked).</p>\n<p class=\"markdown-para\">The actual secret values would be long random alpha-numeric strings such as <code>b9efa92ff...</code>, but I'm putting in simple legible values for demonstration purposes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/secrets.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">development</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">dev-secret-key-base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">stripe_secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">dev-stripe-secret-key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">another_secret</span><span class=\"mtk1\">: </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">test</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test-secret-key-base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">stripe_secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test-stripe-secret-key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">another_secret</span><span class=\"mtk1\">: </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">staging</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">staging-secret-key-base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">stripe_secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">staging-stripe-secret-key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">another_secret</span><span class=\"mtk1\">: </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">production</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">production-secret-key-base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">stripe_secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">production-stripe-secret-key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">another_secret</span><span class=\"mtk1\">: </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"step-1-convert-development-secrets-to-credentials\" style=\"position:relative;\"><a href=\"#step-1-convert-development-secrets-to-credentials\" aria-label=\"step 1 convert development secrets to credentials permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 1: Convert Development Secrets to Credentials</h3>\n<p class=\"markdown-para\">Assuming git version control is being used on the project, start by creating a branch for this work:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Follow your project&#39;s branch naming conventions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git checkout -b chore-migrate-secrets-to-credentials</span></span></span></code></pre>\n<p class=\"markdown-para\">Make a backup of <code>config/secrets.yml</code> to somewhere secure and remove it from the project. This is to ensure that if the application is still trying to access it, it won't work correctly.</p>\n<p class=\"markdown-para\">Next, run the following in a terminal at the project root:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails credentials:edit --environment development</span></span></span></code></pre>\n<p class=\"markdown-para\">The output from this command will be something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Adding config/credentials/development.key to store the encryption key: a44c8fd8b05cd46af35b34f778b56f37</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Save this in a password manager your team can access.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">If you lose the key, no one, including you, can access anything encrypted with it.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      create  config/credentials/development.key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Ignoring config/credentials/development.key so it won&#39;t end up in Git history:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      append  .gitignore</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Configured Git diff driver for credentials.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Editing config/credentials/development.yml.enc...</span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Explanation:</strong></p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">A new directory <code>credentials</code> was created in the existing <code>config</code> directory.</li>\n<li class=\"markdown-list-item\">A new encrypted file was generated to persist the development secrets: <code>config/credentials/development.yml.enc</code></li>\n<li class=\"markdown-list-item\">A new master key was generated to encrypt and decrypt the development secrets: <code>a44c8f...</code></li>\n<li class=\"markdown-list-item\">The value of the development master key is saved in a new file: <code>config/credentials/development.key</code></li>\n<li class=\"markdown-list-item\">The file containing the development master key is gitignored. You can verify this by checking the <code>.gitignore</code> file - it has a new entry: <code>/config/credentials/development.key</code></li>\n</ol>\n<p class=\"markdown-para\">At this point, your editor will be open with a temporary file that displays the decrypted contents of newly generated <code>config/credentials/development.yml.enc</code>. Rails generates some example content like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># aws:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   access_key_id: 123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   secret_access_key: 345</span></span></span></code></pre>\n<p class=\"markdown-para\">Edit the file, porting over the values that were previously in <code>config/secrets.yml</code> development section as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">dev-secret-key-base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">stripe_secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">dev-stripe-secret-key</span></span></span></code></pre>\n<p class=\"markdown-para\">Save the file, and then close it. When closed, Rails will encrypt the contents, saving the results to <code>config/credentials/development.yml.enc</code>.</p>\n<p class=\"markdown-para\">Opening the encrypted file <code>config/credentials/development.yml.enc</code> directly in an editor will only show the encrypted contents and not be human readable. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">akdhz8ZaV6MpFpavkrPtQkHUOkFJprED4Sr2y6Zihpww75KA7mPoGQnthu/SPBeQPPKMFNwji8bSjy7gaY+nfllG+q1QMEKM1ntJyn/o+l3hr/AnKdjOa0QEqog+zGLpC8mf66dCEllnAdx84K7WA6pt+2awrdFkZpossOkg27p1j3MFXJSzZ1PXEPces4/5rxTaOCAobwPEeJhizmDAmPOcvnlNfq3POMl/hb4ydqgMpnxweultayA/--sepv1Y5SB+QFU/cp--DuDkAeCIggKo0nj5N8xTxQ==</span></span></code></pre>\n<aside class=\"markdown-aside\">\nTo use the `credentials:edit` command, Rails needs to know which editor to open. By default, it uses the system's default editor, which is often vim. If you prefer another editor, you can set the `EDITOR` environment variable. For example, to use VS Code: `export EDITOR=\"code --wait\"`.\n</aside>\n<p class=\"markdown-para\">If you need to view the contents of this file or open it for editing, you would again run <code>bin/rails credentials:edit --environment development</code>. This time, rather than generating a new development key, Rails will use the existing key saved at <code>config/credentials/development.key</code> to decrypt the file and display the plain text contents in a temporary file in your editor.</p>\n<p class=\"markdown-para\">Launch a Rails console <code>bin/rails c</code> and verify the credentials are accessible from application code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">credentials</span><span class=\"mtk1\">.</span><span class=\"mtk5\">secret_key_base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;dev-secret-key-base&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Also available directly on Rails.application</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">secret_key_base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;dev-secret-key-base&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Should be able to access all other secrets via `credentials`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">credentials</span><span class=\"mtk1\">.</span><span class=\"mtk5\">stripe_secret_key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;dev-stripe-secret-key&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Rails uses the <code>development.key</code> to decrypt the contents of <code>development.yml.enc</code> so you have access to all the secrets defined in the file at run-time.</p>\n<p class=\"markdown-para\">The credentials yaml file also supports nesting for the application secrets. For example, the Stripe secrets could be organized as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">dev-secret-key-base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">stripe</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">secret_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">dev-stripe-secret-key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">publishable_key</span><span class=\"mtk1\">: </span><span class=\"mtk6\">dev-stripe-publishable-key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">webhook_secret</span><span class=\"mtk1\">: </span><span class=\"mtk6\">dev-stripe-webhook-secret</span></span></span></code></pre>\n<p class=\"markdown-para\">In this case, the stripe secrets are accessible in application code like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">credentials</span><span class=\"mtk1\">.</span><span class=\"mtk5\">stripe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">:secret_key</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;dev-stripe-secret-key&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">:publishable_key</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;dev-stripe-publishable-key&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">:webhook_secret</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;dev-stripe-webhook-secret&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">credentials</span><span class=\"mtk1\">.</span><span class=\"mtk5\">stripe</span><span class=\"mtk1\">.</span><span class=\"mtk5\">secret_key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;dev-stripe-secret-key&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">credentials</span><span class=\"mtk1\">.</span><span class=\"mtk5\">stripe</span><span class=\"mtk1\">.</span><span class=\"mtk5\">publishable_key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;dev-stripe-publishable-key&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">ERB Interpolation Not Supported</strong></p>\n<p class=\"markdown-para\">When using encrypted credentials, you must enter the plain text values when editing the decrypted file. Unlike the old <code>config/secrets.yml</code>, erb interpolation does not work. For example, if you were to run <code>bin/rails credentials:edit --environment development</code> and save the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">secret_key_base</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Then attempt to access the <code>secret_key_base</code> in a Rails console, the value will be a literal string of the above, even if <code>SECRET_KEY_BASE</code> is set:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">secret_key_base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;&lt;%= ENV[</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk6\">SECRET_KEY_BASE</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk6\">] %&gt;&quot;</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"step-2-convert-all-other-environment-secrets\" style=\"position:relative;\"><a href=\"#step-2-convert-all-other-environment-secrets\" aria-label=\"step 2 convert all other environment secrets permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 2: Convert All Other Environment Secrets</h3>\n<p class=\"markdown-para\">Repeat the above procedure, for every other environment your application supports. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails credentials:edit --environment test</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails credentials:edit --environment staging</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails credentials:edit --environment production</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"step-3-update-application-code\" style=\"position:relative;\"><a href=\"#step-3-update-application-code\" aria-label=\"step 3 update application code permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 3: Update Application Code</h3>\n<p class=\"markdown-para\">Find all references to <code>Rails.application.secrets.something</code> in your application code and change it to <code>Rails.application.credentials.something</code>.</p>\n<p class=\"markdown-para\">At this point, you should be able to run your Rails server locally <code>bin/rails s</code> without seeing the secrets/credentials deprecation warning. Exercise all the workflows that depend on secrets to ensure your development secrets are being read correctly from the new encrypted credentials yaml file.</p>\n<p class=\"markdown-para\">Also run your test suite locally. It should pass and should not output any secrets/credentials deprecation warning. This assumes that there is test coverage for the areas of the app that use the secrets!</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"step-4-commit-changes-to-source-control\" style=\"position:relative;\"><a href=\"#step-4-commit-changes-to-source-control\" aria-label=\"step 4 commit changes to source control permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 4: Commit Changes to Source Control</h3>\n<p class=\"markdown-para\">At this point, the <code>config/credentials</code> directory should contain the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">config</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── credentials</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── development.key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── development.yml.enc</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── production.key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── production.yml.enc</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── staging.key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── staging.yml.enc</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── test.key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   └── test.yml.enc</span></span></code></pre>\n<p class=\"markdown-para\">The <code>.gitignore</code> file will have the following new entries added to ignore the <code>*.key</code> files:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">/config/credentials/development.key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/config/credentials/test.key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/config/credentials/staging.key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/config/credentials/production.key</span></span></code></pre>\n<p class=\"markdown-para\">The <code>*.yml.enc</code> files are encrypted and contain all the secrets ported over from <code>config/secrets.yml</code>. These should be committed into source control.</p>\n<p class=\"markdown-para\">The <code>*.key</code> files contain the master key(s) to encrypt/decrypt the corresponding yaml files. These are git ignored and should NOT be committed into source control.</p>\n<p class=\"markdown-para\">Commit the changes to the branch, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git add .gitignore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git add config/credentials/development.yml.enc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># add rest of the encrypted yaml files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git commit -m </span><span class=\"mtk6\">&quot;convert deprecated secrets to encrypted credentials&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git push</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>config/secrets.yml</code> removal you did earlier in <a href=\"../migrating-from-rails-secrets-to-credentials#step-1-convert-development-secrets-to-credentials\" class=\"markdown-link\">Step 1</a> should also be included in this commit.</p>\n<p class=\"markdown-para\">At this point, since the key files only exist on your laptop, yours is the only machine capable of decrypting the credentials yaml file. The next steps are about ensuring others can as well.</p>\n<p class=\"markdown-para\">If Rails can't find a key file at <code>config/credentials/{env}.key</code>, it will read it from <code>RAILS_MASTER_KEY</code> environment variable. Since the key files are not committed, the solution in all other environments is to ensure the <code>RAILS_MASTER_KEY</code> environment variable is populated.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"step-5-update-continuous-integration\" style=\"position:relative;\"><a href=\"#step-5-update-continuous-integration\" aria-label=\"step 5 update continuous integration permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 5: Update Continuous Integration</h3>\n<p class=\"markdown-para\">If you have a continuous integration system that runs tests, such as GitHub Actions, Circle CI, Travis CI, etc. That system will need access to the test master key to decrypt the test credentials file. Recall that currently the test credentials file <code>config/credentials/test.yml.enc</code> has been committed, but the key to decrypt it is at <code>config/credentials/test.key</code>, which only exists on your laptop. This means if the CI system were to run on the branch where you just committed, it will fail because it won't have access to the secrets.</p>\n<p class=\"markdown-para\">Most CI systems have a way to populate a secret via their web dashboards, and make it available to the workflow as an environment variable. Go ahead and do this, creating a new secret/environment variable <code>RAILS_MASTER_KEY</code>, and populate it with the value from the file on your laptop: <code>config/credentials/test.key</code></p>\n<p class=\"markdown-para\">Details of how to do this are CI-specific, for example here's how to <a href=\"https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions\" class=\"markdown-link\">use secrets in GitHub actions</a>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"step-6-update-deployed-environments\" style=\"position:relative;\"><a href=\"#step-6-update-deployed-environments\" aria-label=\"step 6 update deployed environments permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 6: Update Deployed Environments</h3>\n<p class=\"markdown-para\">To ensure the application deployed in production (or other environments like staging) can decrypt the credentials, the corresponding master key needs to be available in the deployment environment. Currently it's at  <code>config/credentials/staging.key</code> and <code>config/credentials/production.key</code> on your laptop.</p>\n<p class=\"markdown-para\">This step will vary depending on how you deploy your Rails application. In general, this requires a new environment variable <code>RAILS_MASTER_KEY</code> to be set and populated. Refer to your hosting provider’s documentation (eg: Hetzner, Linode, DigitalOcean, etc.) for the exact steps.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"step-7-team-sharing\" style=\"position:relative;\"><a href=\"#step-7-team-sharing\" aria-label=\"step 7 team sharing permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 7: Team Sharing</h3>\n<p class=\"markdown-para\">Recall all the key files are gitignored. If working with a team, they'll also need access to the key files, especially dev and test so they can run their servers and tests locally. The team should also have access to the deployment master keys (staging, production) in case someone needs to setup a new server. Save these somewhere secure that the rest of the team can access the keys. For example a password manager that supports team sharing such as 1Password, Bitwarden, etc.</p>\n<p class=\"markdown-para\">Also update your project's <code>README.md</code> setup instructions, informing developers of where to find the keys, and to create files <code>config/credentials/development.key</code> and <code>config/credentials/test.key</code> in their local project directories containing the key values.</p>\n<aside class=\"markdown-aside\">Keeping your development setup instructions up to date is essential for helping new developers get started quickly and ensuring the whole team stays on the same page, especially for changes like this that aren't immediately obvious from the code. This is a great example of why clear, detailed engineering documentation matters. For more tips on writing effective docs, check out my blog post <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/about-those-docs/\">About Those Docs</a>.</aside>\n<h2 class=\"markdown-subtitle\" id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p class=\"markdown-para\">Here are the key terms covered in this post:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">secret_key_base:</strong> A secret key used to sign cookies, session data, and other sensitive information.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Secrets:</strong> The old technique for managing <code>secret_key_base</code> and other sensitive application data in a plain text yaml file.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Credentials:</strong> The new technique for storing secrets, in an encrypted yaml file, protected by a master key.</li>\n<li class=\"markdown-list-item\"><strong class=\"markdown-strong\">Master Key:</strong> The key used to encrypt and decrypt credentials. By default, Rails looks for this key in <code>config/master.key</code>, but it can also be set per environment (eg: <code>config/credentials/production.key</code>) or via the <code>RAILS_MASTER_KEY</code> environment variable.</li>\n</ul>\n<p class=\"markdown-para\">If you’ve found the process of migrating Rails secrets to credentials confusing, you’re not alone. This area has a long, evolving history, and a clear migration path is difficult to find. Personally, I prefer managing secrets through environment variables, as it’s a widely adopted and straightforward approach. Whatever path you choose, the key is to prioritize security and a workflow that fits your team's needs.</p>\n<p class=\"markdown-para\">Here are some other blog posts and references that helped me during this investigation:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://www.codewithjason.com/understanding-rails-secrets-credentials/\" class=\"markdown-link\">Understanding Rails secrets/credentials</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://blog.saeloun.com/2019/10/10/rails-6-adds-support-for-multi-environment-credentials\" class=\"markdown-link\">Rails 6 adds support for multi environment credentials</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://github.com/rails/rails/pull/30067\" class=\"markdown-link\">Rails PR introducing credentials</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://discuss.rubyonrails.org/t/erb-in-credentials-yml/82405\" class=\"markdown-link\">Discussion on ERB in credentials</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://discuss.rubyonrails.org/t/the-status-of-simultaneous-support-for-secrets-encrypted-credentials-and-multi-environment-encrypted-credentials-is-confusing/75177/4\" class=\"markdown-link\">Discussion on secrets vs credentials</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","timeToRead":17,"tableOfContents":"<ul>\n<li>\n<p><a href=\"#investigation\">Investigation</a></p>\n</li>\n<li>\n<p><a href=\"#what-is-railsapplicationsecrets\">What is Rails.application.secrets</a></p>\n</li>\n<li>\n<p><a href=\"#history\">History</a></p>\n</li>\n<li>\n<p><a href=\"#solution-a-replace-secrets-with-environment-variable\">Solution A: Replace Secrets with Environment Variable</a></p>\n</li>\n<li>\n<p><a href=\"#solution-b-convert-secrets-to-credentials\">Solution B: Convert Secrets to Credentials</a></p>\n<ul>\n<li><a href=\"#step-1-convert-development-secrets-to-credentials\">Step 1: Convert Development Secrets to Credentials</a></li>\n<li><a href=\"#step-2-convert-all-other-environment-secrets\">Step 2: Convert All Other Environment Secrets</a></li>\n<li><a href=\"#step-3-update-application-code\">Step 3: Update Application Code</a></li>\n<li><a href=\"#step-4-commit-changes-to-source-control\">Step 4: Commit Changes to Source Control</a></li>\n<li><a href=\"#step-5-update-continuous-integration\">Step 5: Update Continuous Integration</a></li>\n<li><a href=\"#step-6-update-deployed-environments\">Step 6: Update Deployed Environments</a></li>\n<li><a href=\"#step-7-team-sharing\">Step 7: Team Sharing</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#summary\">Summary</a></p>\n</li>\n</ul>","frontmatter":{"title":"Migrating From Rails Secrets to Credentials","date":"04 Mar 2025","description":"Exploring the evolution of Rails secrets to credentials, this post investigates the deprecation of Rails.application.secrets, explains its history, and provides step-by-step solutions to address the change in legacy Rails applications.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#985818","images":{"fallback":{"src":"/static/cecc99403871f3dd27a235ca600d24d1/d730f/migrating-rails-secrets-to-credentials-silas-kohler-C1P4wHhQbjM-unsplash.jpg","srcSet":"/static/cecc99403871f3dd27a235ca600d24d1/b834a/migrating-rails-secrets-to-credentials-silas-kohler-C1P4wHhQbjM-unsplash.jpg 225w,\n/static/cecc99403871f3dd27a235ca600d24d1/21c52/migrating-rails-secrets-to-credentials-silas-kohler-C1P4wHhQbjM-unsplash.jpg 450w,\n/static/cecc99403871f3dd27a235ca600d24d1/d730f/migrating-rails-secrets-to-credentials-silas-kohler-C1P4wHhQbjM-unsplash.jpg 900w","sizes":"(min-width: 900px) 900px, 100vw"},"sources":[{"srcSet":"/static/cecc99403871f3dd27a235ca600d24d1/71a10/migrating-rails-secrets-to-credentials-silas-kohler-C1P4wHhQbjM-unsplash.webp 225w,\n/static/cecc99403871f3dd27a235ca600d24d1/901f1/migrating-rails-secrets-to-credentials-silas-kohler-C1P4wHhQbjM-unsplash.webp 450w,\n/static/cecc99403871f3dd27a235ca600d24d1/5acd1/migrating-rails-secrets-to-credentials-silas-kohler-C1P4wHhQbjM-unsplash.webp 900w","type":"image/webp","sizes":"(min-width: 900px) 900px, 100vw"}]},"width":900,"height":599}}}},"fields":{"slug":"/blog/migrating-from-rails-secrets-to-credentials/"}},"relatedP":{"edges":[{"node":{"id":"738ce27d-07cc-569b-bdf2-d81ee42b7a72","frontmatter":{"title":"Avoid this Bug with Numeric Environment Variables in Ruby","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#081808","images":{"fallback":{"src":"/static/a5030576f366ed3047c5a888d74cd1af/26528/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.jpg","srcSet":"/static/a5030576f366ed3047c5a888d74cd1af/26528/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.jpg 300w,\n/static/a5030576f366ed3047c5a888d74cd1af/43429/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/a5030576f366ed3047c5a888d74cd1af/5d6c3/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.webp 300w,\n/static/a5030576f366ed3047c5a888d74cd1af/68dbc/bug-numeric-env-var-james-wainscoat-GGewLGcQD-I-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/numeric-env-vars-ruby/"}}},{"node":{"id":"f173b5c7-e7ec-527a-917e-85c12f384e84","frontmatter":{"title":"Dependabot PRs Need Their Secrets","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#081818","images":{"fallback":{"src":"/static/531f78a10b24ce41d4cd17ae99f41f8f/26528/depbot-secrets-30daysreplay-social-media-marketing-ZEDvSzgS4FA-unsplash.jpg","srcSet":"/static/531f78a10b24ce41d4cd17ae99f41f8f/26528/depbot-secrets-30daysreplay-social-media-marketing-ZEDvSzgS4FA-unsplash.jpg 300w,\n/static/531f78a10b24ce41d4cd17ae99f41f8f/43429/depbot-secrets-30daysreplay-social-media-marketing-ZEDvSzgS4FA-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/531f78a10b24ce41d4cd17ae99f41f8f/5d6c3/depbot-secrets-30daysreplay-social-media-marketing-ZEDvSzgS4FA-unsplash.webp 300w,\n/static/531f78a10b24ce41d4cd17ae99f41f8f/68dbc/depbot-secrets-30daysreplay-social-media-marketing-ZEDvSzgS4FA-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/dependabot-secrets/"}}},{"node":{"id":"489497a9-2600-5b48-aa26-a2ea8b93b5d0","frontmatter":{"title":"Add Rubocop to an Existing Rails Project","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#181828","images":{"fallback":{"src":"/static/454ad22c79b1d6dca07caa36d2c057f3/26528/rubocop-mark-duffel-U5y077qrMdI-unsplash.jpg","srcSet":"/static/454ad22c79b1d6dca07caa36d2c057f3/26528/rubocop-mark-duffel-U5y077qrMdI-unsplash.jpg 300w,\n/static/454ad22c79b1d6dca07caa36d2c057f3/43429/rubocop-mark-duffel-U5y077qrMdI-unsplash.jpg 600w","sizes":"300px"},"sources":[{"srcSet":"/static/454ad22c79b1d6dca07caa36d2c057f3/5d6c3/rubocop-mark-duffel-U5y077qrMdI-unsplash.webp 300w,\n/static/454ad22c79b1d6dca07caa36d2c057f3/68dbc/rubocop-mark-duffel-U5y077qrMdI-unsplash.webp 600w","type":"image/webp","sizes":"300px"}]},"width":300,"height":170}}}},"fields":{"slug":"/blog/add-rubocop-to-legacy-project/"}}}]}},"pageContext":{"slug":"/blog/migrating-from-rails-secrets-to-credentials/","relatedPosts":["Dependabot PRs Need Their Secrets","Add Rubocop to an Existing Rails Project","Avoid this Bug with Numeric Environment Variables in Ruby"]}},"staticQueryHashes":["163244226"],"slicesMap":{}}