{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":60,"edges":[{"node":{"id":"1415cf2c-484a-5280-88b9-5e30b7c3fb5a","frontmatter":{"title":"ActiveRecord JSON Column with MySQL and MariaDB","date":"April 2023","category":"rails"},"excerpt":"When using a relational database, it can be convenient to occasionally store some data as JSON in a table column. As of MySQL 5.7.8, the…","html":"<p class=\"markdown-para\">When using a relational database, it can be convenient to occasionally store some data as JSON in a table column. As of <a href=\"https://dev.mysql.com/doc/refman/5.7/en/json.html\" class=\"markdown-link\">MySQL 5.7.8</a>, the JSON column type is supported. It's also supported in <a href=\"https://mariadb.org/documentation/\" class=\"markdown-link\">MariaDB</a>. In theory, MySQL and MariaDB are 100% compatible, but it turns out, there's an important difference to be aware of when using the JSON column type in a Rails project with ActiveRecord.</p>\n<h2 class=\"markdown-subtitle\" id=\"background\" style=\"position:relative;\"><a href=\"#background\" aria-label=\"background permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Background</h2>\n<p class=\"markdown-para\">The Rails project I'm working on has developers using MySQL on their laptops. As part of a <a href=\"../nomad-tips-and-tricks\" class=\"markdown-link\">platform migration</a>, the database in all deployed environments was changed to MariaDB. There are a number of <a href=\"https://mariadb.com/resources/blog/why-should-you-migrate-from-mysql-to-mariadb/\" class=\"markdown-link\">benefits</a> to running MariaDB in production over MySQL. Given that it's fully compatible with MySQL, there didn't seem to be any need to change the local environment so our laptops remain using MySQL. That is, until I ran into a surprise dealing with a JSON column.</p>\n<h2 class=\"markdown-subtitle\" id=\"json-column\" style=\"position:relative;\"><a href=\"#json-column\" aria-label=\"json column permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JSON Column</h2>\n<p class=\"markdown-para\">Here's a migration that creates a table with a JSON column type. Just for an example, imagine we want to store a list of the user's favorite fruits as a JSON array in the <code>users</code> table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateUsers</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:users</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:username</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.json </span><span class=\"mtk4\">:fav_fruits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">We can also validate that only arrays will be stored in the <code>fav_fruits</code> column with JSON schema as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// app/models/user/fav_fruits_schema.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;type&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;array&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;The root schema&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;default&quot;</span><span class=\"mtk1\">: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;examples&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;additionalItems&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;items&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;$id&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;#/items&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;anyOf&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;$id&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;#/items/anyOf/0&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;type&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;integer&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;The first anyOf schema&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;default&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;examples&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">And use it in the User model with a custom validate method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">User</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:validate_fav_fruits_against_json_schema</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validate_fav_fruits_against_json_schema</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @schema </span><span class=\"mtk7\">||=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.read(</span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.root.join(</span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.root, </span><span class=\"mtk6\">&quot;app&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;models&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;user&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;fav_fruits_schema.json&quot;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fav_fruits_errors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Validator</span><span class=\"mtk1\">.fully_validate(@schema, fav_fruits, </span><span class=\"mtk4\">strict:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">validate_schema:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fav_fruits_errors.each </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |error|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors.add(</span><span class=\"mtk4\">:fav_fruits</span><span class=\"mtk1\">, error)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"the-problem\" style=\"position:relative;\"><a href=\"#the-problem\" aria-label=\"the problem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Problem</h2>\n<p class=\"markdown-para\">Consider the code below that seeds a user with some data, then iterates over each of their favorite fruits:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">user </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">User</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">username:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;alice&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">fav_fruits:</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;apple&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;orange&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">user.fav_fruits.each </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |fruit|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> fruit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># process fruit...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">When this code is run in a Rails project using MySQL, the code behaves as expected, outputting:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">apple</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">orange</span></span></code></pre>\n<p class=\"markdown-para\">But when the same code runs in a deployed environment that is using MariaDB, an error results:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">undefined method `each&#39; for &quot;[\\&quot;apple\\&quot;, \\&quot;orange\\&quot;]&quot;:String (NoMethodError)</span></span></code></pre>\n<p class=\"markdown-para\">If you would like to see the problem in action, clone this <a href=\"https://github.com/danielabar/maria\" class=\"markdown-link\">demo repo</a>, which runs a Rails 7 project using a MariaDB instance running in a Docker container, and try out the steps to reproduce.</p>\n<h2 class=\"markdown-subtitle\" id=\"table-contents\" style=\"position:relative;\"><a href=\"#table-contents\" aria-label=\"table contents permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table Contents</h2>\n<p class=\"markdown-para\">It looks like the problem is that in MariaDB, despite having defined the column as JSON, and having inserted an array, the value that got stored in the database is a String. We can see this by invoking the <code>class</code> method of the <code>fav_fruits</code> attribute in a project using MySQL, and then in a project using MariaDB:</p>\n<p class=\"markdown-para\">First, MySQL:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">user.fav_fruits.class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Array</span></span></span></code></pre>\n<p class=\"markdown-para\">Then MariaDB:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">user.fav_fruits.class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># String</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"table-schema\" style=\"position:relative;\"><a href=\"#table-schema\" aria-label=\"table schema permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table Schema</h2>\n<p class=\"markdown-para\">Looking at the schema that Rails generated when the migration was run confirms the <code>fav_fruits</code> column is indeed json:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- db/structure.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CREATE</span><span class=\"mtk1\"> </span><span class=\"mtk7\">TABLE</span><span class=\"mtk1\"> </span><span class=\"mtk6\">`users`</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">`id`</span><span class=\"mtk1\"> </span><span class=\"mtk7\">bigint</span><span class=\"mtk1\">(</span><span class=\"mtk4\">20</span><span class=\"mtk1\">) </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\"> AUTO_INCREMENT,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">`username`</span><span class=\"mtk1\"> </span><span class=\"mtk7\">varchar</span><span class=\"mtk1\">(</span><span class=\"mtk4\">255</span><span class=\"mtk1\">) </span><span class=\"mtk7\">NOT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">`fav_fruits`</span><span class=\"mtk1\"> </span><span class=\"mtk7\">json</span><span class=\"mtk1\"> DEFAULT </span><span class=\"mtk7\">NULL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThis project is using the SQL format of the schema dump rather than the default Ruby format. This is useful if you ever need to use raw SQL in a migration to execute something that isn't supported by the migration DSL. See the Rails guide on <a class=\"markdown-link\" href=\"https://guides.rubyonrails.org/active_record_migrations.html#types-of-schema-dumps\">migrations</a> for more details.\n</aside>\n<p class=\"markdown-para\">But how does the schema look within each database? To check this, I'm using <a href=\"https://www.jetbrains.com/datagrip/\" class=\"markdown-link\">DataGrip</a>, which is a licensed tool but you could do the same with a command line tool or any database GUI that has a feature to show a table's schema.</p>\n<p class=\"markdown-para\">Here is the schema from MySQL, focusing only on the <code>fav_fruits</code> column:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">create</span><span class=\"mtk1\"> </span><span class=\"mtk7\">table</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk7\">not</span><span class=\"mtk1\"> </span><span class=\"mtk7\">exists</span><span class=\"mtk1\"> users</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">fav_fruits </span><span class=\"mtk7\">json</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- other columns...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p class=\"markdown-para\">So far so good, this is what we expect. But look at the schema from MariaDB:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">create</span><span class=\"mtk1\"> </span><span class=\"mtk7\">or</span><span class=\"mtk1\"> </span><span class=\"mtk9\">replace</span><span class=\"mtk1\"> </span><span class=\"mtk7\">table</span><span class=\"mtk1\"> users</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">fav_fruits longtext collate utf8mb4_bin </span><span class=\"mtk7\">null</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- other columns...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">constraint</span><span class=\"mtk1\"> fav_fruits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">check</span><span class=\"mtk1\"> (json_valid(</span><span class=\"mtk6\">`fav_fruits`</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">With MariaDB, the <code>fav_fruits</code> column is not defined as json, rather it's defined as <code>longtext</code> with a check constraint to ensure that only valid json can be stored. This explains why a String is returned from ActiveRecord <code>user.fav_fruits</code>.</p>\n<p class=\"markdown-para\">According to the MariaDB docs for the <a href=\"https://mariadb.com/kb/en/json-data-type/\" class=\"markdown-link\">JSON Data Type</a>, this is a feature, not a bug:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">JSON is an alias for LONGTEXT introduced for compatibility reasons with MySQL's JSON data type. MariaDB implements this as a LONGTEXT rather, as the JSON data type contradicts the SQL standard... In order to ensure that a valid json document is inserted, the JSON_VALID function can be used as a CHECK constraint. This constraint is automatically included for types using the JSON alias from MariaDB 10.4.3.</p>\n</blockquote>\n<h2 class=\"markdown-subtitle\" id=\"solution\" style=\"position:relative;\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h2>\n<p class=\"markdown-para\">In the short term, we have a situation where developer's laptops are using MySQL which will return an Array from the JSON column (given that we're only inserting array values and an appropriate JSON validator is in place). But when the same code runs in production against a MariaDB database, a String is returned.</p>\n<p class=\"markdown-para\">Without changing any setup, a solution to this is to override the ActiveRecord attribute method for the JSON field <code>fav_fruits</code>, and  use the <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/AttributeMethods/Read.html#method-i-read_attribute\" class=\"markdown-link\">read_attribute</a> method from the <code>ActiveRecord::AttributeMethods::Read</code> module to retrieve the value, and convert as needed.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">User</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fav_fruits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Retrieve the typecast value of fav_fruits from the database, which could be:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#   1. nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#   2. String</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#   3. Array</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    days </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> read_attribute(</span><span class=\"mtk4\">:fav_fruits</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># 1. Not allowed to have default not null value on json column, return empty array in this case.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> [] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> days.blank?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># 2. MariaDB: If a String is found, convert to JSON.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">.parse(days) </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> days.is_a?(String)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># 3. MySQL: Otherwise, return the original value.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    days</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now, anywhere in the code that <code>user.fav_fruits</code> is used, it's guaranteed to always return an Array, whether the underlying database is MySQL or MariaDB.</p>\n<p class=\"markdown-para\">In the long term, a better approach is to update the local setup to use MariaDB instead of MySQL. This will avoid any future surprises of differences in implementation. With this in place, the solution is to modify the model to use ActiveRecord's <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/AttributeMethods/Serialization/ClassMethods.html#method-i-serialize\" class=\"markdown-link\">serialize</a> class method. This tells Rails that you want this column retrieved from the database as JSON:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">User</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  serialize </span><span class=\"mtk4\">:fav_fruits</span><span class=\"mtk1\">, JSON</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With this change in place, we can again run a Rails console in the project that's using MariaDB and check the value of fav_fruits, this time its retrieved from the database as an Array rather than a String:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">u </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">User</span><span class=\"mtk1\">.find_by(</span><span class=\"mtk4\">username:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;alice&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">u.fav_fruits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [&quot;apple&quot;, &quot;orange&quot;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">u.fav_fruits.class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; Array</span></span></span></code></pre>\n<p class=\"markdown-para\">Overriding the <code>fav_fruits</code> method is no longer needed, unless you want to maintain the behaviour of having an empty array returned instead of nil, in which case, the User model would look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">User</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># solution to guarantee JSON when retrieving fav_fruits from MariaDB</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  serialize </span><span class=\"mtk4\">:fav_fruits</span><span class=\"mtk1\">, JSON</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># if want [] returned instead of nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fav_fruits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    days </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> read_attribute(</span><span class=\"mtk4\">:fav_fruits</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> [] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> days.blank?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">super</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">WARNING:</strong> Do not use the <code>serialize</code> class method when running against a database that natively supports JSON such as MySQL or Postgres. Otherwise the following error will result when inserting data:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">User</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">username:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;alice&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">fav_fruits:</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;apple&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;orange&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># activerecord-7.0.4/lib/active_record/attribute_methods/serialization.rb:117:in `block in serialize&#39;:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Column `fav_fruits` of type ActiveRecord::Type::Json does not support `serialize` feature.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># (ActiveRecord::AttributeMethods::Serialization::ColumnNotSerializableError)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Usually it means that you are trying to use `serialize`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># on a column that already implements serialization natively.</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered an important difference in JSON handling between MySQL and MariaDB. It showed a solution if both databases must be supported and another solution if all environments can be modified to use MariaDB. In general, it's better to have the local development environment mirror production as closely as possible to avoid surprising differences in behaviour.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/activerecord-json-mysql-mariadb/"}}},{"node":{"id":"e43646a1-6a97-5a2d-8028-55f3716966d4","frontmatter":{"title":"When the Password Field Says No to Paste","date":"March 2023","category":"javascript"},"excerpt":"If you were affected by the LastPass breach at the end of 2022, you've probably found yourself on various websites changing passwords. You…","html":"<p class=\"markdown-para\">If you were affected by the <a href=\"https://blog.lastpass.com/2022/12/notice-of-recent-security-incident/\" class=\"markdown-link\">LastPass breach</a> at the end of 2022, you've probably found yourself on various websites changing passwords. You may have also noticed that some websites block pasting in a password field. For some reason, the companies behind these seem to think that being able to paste in a password field is insecure. But it's actually the opposite, forcing users to manually type in a password one character at a time encourages the use of weak passwords - shorter and easier to type in. It can also interfere with password managers, although some of them may be able to work around it.</p>\n<p class=\"markdown-para\">My first reaction when encountering this behaviour was irritation at being blocked from performing a basic function. My second reaction was curiosity - how does this work and is there anything that can be done about it? The good news is yes! This post will show how to work around this frustrating user experience.</p>\n<h2 class=\"markdown-subtitle\" id=\"solution\" style=\"position:relative;\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h2>\n<p class=\"markdown-para\">Next time you encounter a website that won't let you paste into a password (or any other) field, open Developer Tools (<kbd class=\"markdown-kbd\">Cmd</kbd> + <kbd class=\"markdown-kbd\">Option</kbd> + <kbd class=\"markdown-kbd\">I</kbd> on a Mac if using Chrome), make sure you're in the Console tab, and paste in the following lines:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">var</span><span class=\"mtk1\"> </span><span class=\"mtk5\">allowPaste</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">e</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  e.</span><span class=\"mtk5\">stopImmediatePropagation</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">console</span><span class=\"mtk1\">.</span><span class=\"mtk9\">log</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Free the paste!&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">document.</span><span class=\"mtk5\">addEventListener</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;paste&#39;</span><span class=\"mtk1\">, allowPaste, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p class=\"markdown-para\">Now, without refreshing the page, try to paste again in the field that wouldn't allow it before - you should now be able to paste, hurray!</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"snippet\" style=\"position:relative;\"><a href=\"#snippet\" aria-label=\"snippet permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Snippet</h3>\n<p class=\"markdown-para\">To avoid having to remember those lines and paste them in the console each time, they can be saved in a <a href=\"https://developer.chrome.com/docs/devtools/javascript/snippets/\" class=\"markdown-link\">Snippet</a> as follows:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">With Developer Tools open, click on the Sources tab.</li>\n<li class=\"markdown-list-item\">There should be another panel open on the left hand side with tabs like Page, Filesystem, Snippets. Click on Snippets.</li>\n<li class=\"markdown-list-item\">Click on \"+ New Snippet\" at the top of the Snippets tab.</li>\n<li class=\"markdown-list-item\">This will open up an editor in the middle panel - paste in the lines of JavaScript from above, and press <kbd class=\"markdown-kbd\">Cmd</kbd> + <kbd class=\"markdown-kbd\">S</kbd> to save it.</li>\n<li class=\"markdown-list-item\">Chrome will automatically assign the snippet a name, shown in the snippet listing in the left panel such as \"Script snippet #1\". Right-click on it, select Rename, and name it whatever you like. I name mine \"free_the_paste\".</li>\n</ol>\n<p class=\"markdown-para\">When you're finished, it should look something like this:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABAklEQVR42j2Q3W6EIBCFfY+Nq6uAgCCCqOnPTdM22/T93+drYDe9OJm5Od+cM41fIkJO2Hmh7H5JxLRjZ8+kZ4Q0rOlATZa2vTJpyxozaTvqXEJiWTecXwlrosl5Z8sHxjq0mSuomKUypHMjpoVzS+x7ZpSa2yCrpNQc5yspnxjrn8CN5v51cv/55ePzmzVuhBCRShPCzsvbOzkvRGeIziKFQkjNIBT9IIjpqOnLcecjs1tpLm3Hpe3pekHXj1y7gf4mMMZjzIw2CjUpJqmQorwmoLRlVLpCSroCLLV9SDSzC/VX7fX2L/GsVsC3QT00KrT1aOMw8/KY1td9GCVC6er7A5rzld4nNFptAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"chrome snippet free paste\"\n        title=\"chrome snippet free paste\"\n        src=\"/static/58949b2489682591827b005f9a903cda/5a190/chrome-snippet-free-paste.png\"\n        srcset=\"/static/58949b2489682591827b005f9a903cda/772e8/chrome-snippet-free-paste.png 200w,\n/static/58949b2489682591827b005f9a903cda/e17e5/chrome-snippet-free-paste.png 400w,\n/static/58949b2489682591827b005f9a903cda/5a190/chrome-snippet-free-paste.png 800w,\n/static/58949b2489682591827b005f9a903cda/c1b63/chrome-snippet-free-paste.png 1200w,\n/static/58949b2489682591827b005f9a903cda/ffaa5/chrome-snippet-free-paste.png 1299w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">To use the snippet, next time you land on a page that is preventing pasting into a field, open dev tools, click on the snippet, then hit <kbd class=\"markdown-kbd\">Cmd</kbd> + <kbd class=\"markdown-kbd\">Enter</kbd> to run it. Then go ahead and paste to your hearts content.</p>\n<p class=\"markdown-para\">If you'd like to test this out, I've created an <a href=\"https://danielabar.github.io/messing_with_paste/\" class=\"markdown-link\">example page</a> with some input fields that block paste.</p>\n<aside class=\"markdown-aside\">\nThere are a number of browser extensions that solve this, saving the effort of maintaining and running a custom snippet of JavaScript. However, each extension you add increases the <a class=\"markdown-link\" href=\"https://krebsonsecurity.com/2018/09/browser-extensions-are-they-worth-the-risk/\">attack surface</a>, so I wouldn't recommend adding an extensions for something small like this.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"how-does-it-work\" style=\"position:relative;\"><a href=\"#how-does-it-work\" aria-label=\"how does it work permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How Does it Work?</h2>\n<p class=\"markdown-para\">In order to understand why the snippet works, we first need to understand how paste is blocked in the first place. If you inspect any input field that has paste blocked, it will most likely look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;password&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;some_field&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;some_field&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">onpaste</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">return</span><span class=\"mtk6\"> </span><span class=\"mtk4\">false</span><span class=\"mtk6\">;&quot;</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">This makes use of the <code>paste</code> event. According to <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Element/paste_event\" class=\"markdown-link\">MDN</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">The paste event fires when the user initiates a paste action through the browser's user interface.</p>\n</blockquote>\n<p class=\"markdown-para\">That bit in the markup <code>onpaste=\"return false;\"</code> overrides the default action, which is to insert the contents of the clipboard into the field at the cursor position. It's equivalent to the following, which adds an event handler to the field using the <code>onpaste</code> property of the field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> some_field </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;#some_field&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_field.</span><span class=\"mtk5\">onpaste</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> (</span><span class=\"mtk10 mtki\">event</span><span class=\"mtk1\">) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Alternatively, it could be implemented using the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener\" class=\"markdown-link\">addEventListener</a> method of the text field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> some_field </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;#some_field&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_field.</span><span class=\"mtk5\">addEventListener</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;paste&quot;</span><span class=\"mtk1\">, (</span><span class=\"mtk10 mtki\">event</span><span class=\"mtk1\">) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  event.</span><span class=\"mtk5\">preventDefault</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p class=\"markdown-para\">The end result of returning false from a <code>paste</code> event handler (or invoking <code>preventDefault()</code> on the event with <code>addEventListener</code>) is that nothing happens when the user attempts to pastes in content.</p>\n<p class=\"markdown-para\">Now let's take a closer look at the solution, which adds another event listener for the <code>paste</code> event on the document:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">var</span><span class=\"mtk1\"> </span><span class=\"mtk5\">allowPaste</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">e</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  e.</span><span class=\"mtk5\">stopImmediatePropagation</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">console</span><span class=\"mtk1\">.</span><span class=\"mtk9\">log</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Free the paste!&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">document.</span><span class=\"mtk5\">addEventListener</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;paste&#39;</span><span class=\"mtk1\">, allowPaste, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p class=\"markdown-para\">There's two concepts to understand for why the above code has the effect of undoing the paste blocking code.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"element-nesting\" style=\"position:relative;\"><a href=\"#element-nesting\" aria-label=\"element nesting permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Element Nesting</h3>\n<p class=\"markdown-para\">The first concept is that when an event is fired on a DOM element (eg: by user clicking, pasting, etc), that element could be nested within other elements, which in turn are contained in the body tag, which is contained in the html tag, which is contained in the document. And all of these elements receive the event in turn. For example, given the following markup:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;!</span><span class=\"mtk7\">DOCTYPE</span><span class=\"mtk1\"> </span><span class=\"mtk5\">html</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">html</span><span class=\"mtk1\"> </span><span class=\"mtk5\">lang</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;en&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">head</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">title</span><span class=\"mtk1\">&gt;Messing with Paste&lt;/</span><span class=\"mtk7\">title</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">head</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">body</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">class</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;container&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;password&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;some_field&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;some_field&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">onpaste</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">return</span><span class=\"mtk6\"> </span><span class=\"mtk4\">false</span><span class=\"mtk6\">;&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">body</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">html</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">When a user pastes into <code>some_field</code>, the paste event is first fired on the input element (which has a handler that prevents the actual paste from happening). But the execution doesn't end there, the <code>paste</code> event is then also fired in turn on:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">The <code>&#x3C;div class=\"container\"></code> element that the input field is contained in.</li>\n<li class=\"markdown-list-item\">The <code>&#x3C;body></code> element, which the container div is directly contained in.</li>\n<li class=\"markdown-list-item\">The <code>&#x3C;html></code> element that wraps the <code>body</code> and is the root of the DOM tree.</li>\n<li class=\"markdown-list-item\">The <code>document</code> object which represents the DOM for the current page.</li>\n<li class=\"markdown-list-item\">The <code>window</code> object which contains the entire DOM tree and all other browser-related objects.</li>\n</ol>\n<p class=\"markdown-para\">This is referred to as event bubbling, the event is first handled by the element that received the event, and then bubbles all the way up the DOM tree. This means the order matters. If you were to attempt to add an event listener via dev tools to a page with the above markup like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">document.</span><span class=\"mtk5\">addEventListener</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;paste&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk10 mtki\">e</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">console</span><span class=\"mtk1\">.</span><span class=\"mtk9\">log</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Document pasted!&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Try to do something to unblock paste?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p class=\"markdown-para\">It would be too late. Because the <code>input</code> element receives the <code>paste</code> event first, and has already returned false to block it. Your code would still run and would still see <code>Document pasted!</code> in the console, but it would be too late to do anything to undo the paste blocking.</p>\n<p class=\"markdown-para\">What's needed is a way to reverse the order of event handling so that the event listener being added to the <code>document</code> via our \"free the paste\" snippet can run <em class=\"markdown-emphasis\">before</em> the event is received by the input element. This leads to the second concept that's needed to understand the solution.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"bubbling-vs-capture\" style=\"position:relative;\"><a href=\"#bubbling-vs-capture\" aria-label=\"bubbling vs capture permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bubbling vs Capture</h3>\n<p class=\"markdown-para\">Let's take a closer look at the last line of the solution snippet that adds an event listener for the <code>paste</code> event. Specifically, notice the third argument <code>true</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">document.</span><span class=\"mtk5\">addEventListener</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;paste&#39;</span><span class=\"mtk1\">, allowPaste, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p class=\"markdown-para\">If you've done any web development, you've probably used the version of the <code>addEventListener</code> method that accepts two parameters as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Listen for `someEvent` on document and perform</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// `someFunction` when the event is fired.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">document.</span><span class=\"mtk5\">addEventListener</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;someEvent&#39;</span><span class=\"mtk1\">, someFunction)</span></span></span></code></pre>\n<p class=\"markdown-para\">However, there's another version of this method that accepts three parameters:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">document.</span><span class=\"mtk5\">addEventListener</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;someEvent&#39;</span><span class=\"mtk1\">, someFunction, useCapture)</span></span></span></code></pre>\n<p class=\"markdown-para\">The third parameter is a boolean indicating whether the event should be handled in the capture or bubbling phase. It defaults to false which means if not specified, it will be handled during the bubbling phase. The bubbling phase is probably the most familiar to web developers. This is where the event bubbles up the DOM tree, starting from the element that received the event (for example, an input field with a listener for the paste event), then the form or whatever dom element the field is contained in, and so on up to the body, html, document, and window. This is also known as event propagation.</p>\n<p class=\"markdown-para\">But it turns out, <em class=\"markdown-emphasis\">before</em> the bubbling phase runs, there is a capturing phase for event handling that goes in the opposite direction. This is also event propagation, but it goes down the DOM tree. For our simple example, the order of event handling in the capture phase is:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">The <code>window</code> object which contains the entire DOM tree and all other browser-related objects.</li>\n<li class=\"markdown-list-item\">The <code>document</code> object which represents the DOM for the current page.</li>\n<li class=\"markdown-list-item\">The <code>html</code> element that wraps the <code>body</code> and is the root of the DOM tree.</li>\n<li class=\"markdown-list-item\">The <code>body</code> element, which the container div is directly contained in.</li>\n<li class=\"markdown-list-item\">The <code>container</code> div that the input field is contained in.</li>\n<li class=\"markdown-list-item\">The <code>input</code> field.</li>\n</ol>\n<p class=\"markdown-para\">Now we can see the usefulness of setting <code>useCapture</code> to <code>true</code> in an event handler. It gives you a chance to run some code <em class=\"markdown-emphasis\">before</em> other event handlers that are part of the website you're visiting.</p>\n<p class=\"markdown-para\">The last bit of this solution is to know that there's a method <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Event/stopImmediatePropagation\" class=\"markdown-link\">stopImmediatePropagation</a> available on the event that prevents other listeners of the same event from being called. So for example, if you've plugged into the capture phase (event going down from window to element) and were to call <code>stopImmediatePropagation</code>, any elements lower in the DOM tree would never receive the event.</p>\n<p class=\"markdown-para\">This is exactly what's needed to undo the paste blocking. Here's the solution snippet again with comments explaining what we've just learned:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">var</span><span class=\"mtk1\"> </span><span class=\"mtk5\">allowPaste</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">e</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Prevent any further event listeners from receiving event `e`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  e.</span><span class=\"mtk5\">stopImmediatePropagation</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">console</span><span class=\"mtk1\">.</span><span class=\"mtk9\">log</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Free the paste!&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Listen for the `paste` event during the capture phase,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// i.e. as the event propagates down the DOM tree rather than up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">document.</span><span class=\"mtk5\">addEventListener</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;paste&#39;</span><span class=\"mtk1\">, allowPaste, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nNote that <a class=\"markdown-link\" href=\"https://developer.mozilla.org/en-US/docs/Web/API/Event/stopImmediatePropagation\">stopImmediatePropagation</a> is different from <a class=\"markdown-link\" href=\"https://developer.mozilla.org/en-US/docs/Web/API/Event/preventDefault\">preventDefault</a>, which stops the default action from occurring on the element that received the event, but does allow the event to bubble up or capture down the DOM tree as it normally would. Read this excellent post from Wes Bos for a <a class=\"markdown-link\" href=\"https://wesbos.com/javascript/05-events/targets-bubbling-propagation-and-capture\">deeper explanation</a> of event phases.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has demonstrated how to work around web sites that prevent pasting into input fields with a few lines of JavaScript. It also covered an explanation of bubbling vs capturing phases in event handling and how this can be used to run custom code from the dev tools before the existing web site code runs. Finally, if you're building web sites and have any say in how they're built, please try to avoid interfering with standard behaviour like this as it can frustrate users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/password-field-no-paste/"}}},{"node":{"id":"0ea593a7-d033-5622-87b1-8aae9dc5b34f","frontmatter":{"title":"Reflections on Effective Teams","date":"February 2023","category":"career"},"excerpt":"I was inspired to write this post after listening to a Software Engineering Radio podcast with guest Jon Smart on the subject of Patterns…","html":"<p class=\"markdown-para\">I was inspired to write this post after listening to a Software Engineering Radio podcast with guest Jon Smart on the subject of <a href=\"https://www.se-radio.net/2022/12/episode-543-jon-smart-on-patterns-and-anti-patterns-for-successful-software-delivery-in-enterprises/\" class=\"markdown-link\">Patterns and Anti-Patterns for Successful Software Delivery</a>. Topics covered included why \"Agile Transformation\" is an anti-pattern, and avoiding one-size-fits-all solutions.</p>\n<p class=\"markdown-para\">Listening to this podcast made me reflect on my many years experience of software development on various project and product teams across different sized companies and industries in terms of what practices have made some teams more effective than others. In this post, I'll share practices I've experienced that have made teams effective, keeping in mind the majority of my experience has been in web development.</p>\n<h2 class=\"markdown-subtitle\" id=\"definition\" style=\"position:relative;\"><a href=\"#definition\" aria-label=\"definition permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Definition</h2>\n<p class=\"markdown-para\">But first, what do I mean by an effective team? My definition of this term is a team that can continuously deliver working software that solves their customers problems, and the customers are happy to keep on paying for the service. The delivery of each release introduces little to no <a href=\"https://en.wikipedia.org/wiki/Software_regression\" class=\"markdown-link\">regressions</a>. Equally important, an effective team consists of team members who communicate well with each other, feel satisfied and fulfilled in their work, and reasonably look forward to starting work each day.</p>\n<aside class=\"markdown-aside\">\nThere are of course, many more projects and teams in this world that I haven't worked on than those I have, so all the practices suggested in this post are based only on my experience. There could be other practices I've missed that are also effective, and some of my suggestions may not work for all teams. Your mileage may vary.\n</aside>\n<p class=\"markdown-para\">Now that the definition is out of the way, let's get into the practices.</p>\n<h2 class=\"markdown-subtitle\" id=\"product\" style=\"position:relative;\"><a href=\"#product\" aria-label=\"product permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Product</h2>\n<p class=\"markdown-para\">An effective team starts with good product direction. The role of the person(s) that define this has changed names over the years, from Business Analyst, to Product Manager or Product Owner. I'll just refer to it as PM.</p>\n<p class=\"markdown-para\">An effective team will have a PM that can express clearly how different areas of the product should work and why. These features should be driven by what will solve the customers problems, ultimately generating revenue. The PM should also expect clarifying questions from engineers and consistently update written requirements to reflect those clarifications (more on <a href=\"../reflections-on-effective-teams#culture-of-writing\" class=\"markdown-link\">writing</a> later in this post). This way all team members current <em class=\"markdown-emphasis\">and</em> future can gain an understanding of why the product works the way it does.</p>\n<p class=\"markdown-para\">Sometimes the product direction is not entirely clear. The company could be dealing with unknowns and engaging in research and experiments to determine market fit. A team can still be effective in this case if it's communicated clearly to all team members that they're dealing with unknowns. In this environment, people are encouraged to think creatively of potential solutions and to try things out, with the understanding that many features may not stick and have to be rolled back. i.e. no one is blamed if something doesn't work out because it all contributes to increased understanding.</p>\n<p class=\"markdown-para\">The only style of product I've seen be ineffective is when there are a lot of unknowns, but the PM (or key business decision makers) doesn't seem to be aware that they don't know. In this case, when developers ask clarifying questions, the answers are still vague. Then developers will make their best guess. When the feature is delivered, its not what anyone expected, but no one can exactly explain why. This leads to finger pointing where product blames developers for not meeting requirements and developers in turn saying the requirements weren't clear. This results in stress and frustration.</p>\n<h2 class=\"markdown-subtitle\" id=\"minimal-process\" style=\"position:relative;\"><a href=\"#minimal-process\" aria-label=\"minimal process permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Minimal Process</h2>\n<p class=\"markdown-para\">An effective team keeps the spirit of <a href=\"https://agilemanifesto.org/principles.html\" class=\"markdown-link\">agile</a> alive, while not burying themselves under needless ceremonies and process. This means keeping a focus on getting things done using a flow approach rather than a <s class=\"markdown-strikethrough\">religious</s> rigid methodology like <a href=\"https://en.wikipedia.org/wiki/Scrum_(software_development)\" class=\"markdown-link\">Scrum</a>.</p>\n<p class=\"markdown-para\">A small team (more on <a href=\"../reflections-on-effective-teams#small-ish-team-size\" class=\"markdown-link\">team size</a> later in this post) of intrinsically motivated people with solid written communication skills and autonomy over the entire stack can get a lot done with a minimum of process and meetings. There does need to be some process to avoid chaos, every day should not feel like a hack-a-thon. A lightweight process could include:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Breaking up large requirements into smaller items and entering these into a ticketing system to keep track of the work to be done, in priority order.</li>\n<li class=\"markdown-list-item\">Developers pick up tickets by assigning the next most important item in the list to themselves and starting a feature branch. Major change are discussed with <a href=\"../about-those-docs#architecture-decision-records\" class=\"markdown-link\">ADRs</a>.</li>\n<li class=\"markdown-list-item\">All code has automated tests at the appropriate level (from unit to end-to-end).</li>\n<li class=\"markdown-list-item\"><a href=\"../about-those-docs\" class=\"markdown-link\">Engineering documentation</a> is maintained as part of development.</li>\n<li class=\"markdown-list-item\">CI (Continuous Integration) runs on each commit to verify the build, lint rules, and tests.</li>\n<li class=\"markdown-list-item\">Developers submit PRs when their feature is ready for review, with <a href=\"../working-towards-asynchronous-future#pull-requests\" class=\"markdown-link\">instructions to reviewer</a> how to exercise the code.</li>\n<li class=\"markdown-list-item\">Developers address feedback on their PRs, and when approved merge.</li>\n<li class=\"markdown-list-item\">If CI passes on the merge commit, CD (Continuous Deployment) kicks in and automatically deploys the code to production.</li>\n<li class=\"markdown-list-item\">Developers pick up next most important item, rinse and repeat.</li>\n</ul>\n<aside class=\"markdown-aside\">\nThere's been a lot said about ticketing systems being four letter words and all that. It doesn't need to be this way. The ticketing system is simply a communication tool to keep track of what needs to be done and what's most important. Ideally it will be integrated with version control so that ticket status changes such as In Progress, In Review, and Done are applied automatically as developers start pushing to branches, submit PRs, and merge.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"traceability\" style=\"position:relative;\"><a href=\"#traceability\" aria-label=\"traceability permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Traceability</h2>\n<p class=\"markdown-para\">How often has it happened that you're looking at a particular section of code and wondering \"What does this even do?\" or \"How did this ever work?\". Since developers spend more of their time reading code others wrote rather than writing new code, traceability is needed for effectiveness. This is the ability to follow a path from every line of code, to the business requirements that necessitated it, <em class=\"markdown-emphasis\">and</em> to the pull request where this code got merged into the main branch for more technical context.</p>\n<p class=\"markdown-para\">In order to achieve this, the majority of changes to the code should be associated with a ticket number. The ticket should contain the business requirements in the case of a new feature, or for a bug, it should contain the steps to reproduce with actual vs expected results.</p>\n<p class=\"markdown-para\">When developers commit their code, the commit message includes the ticket number (eg: <code>git commit -m \"[ACME-1234] description of change\"</code>). Furthermore, the ticketing system should be integrated with the system where the code is hosted (eg: Github, Gitlab, etc.). This means that when a PR is created for this ticket, the ticketing system automatically updates the ticket with a link to the PR.</p>\n<p class=\"markdown-para\">When a developer is looking at any line of code, they can run <a href=\"https://www.git-scm.com/docs/git-blame\" class=\"markdown-link\">git blame</a> to see the commit message and associated ticket number. Then they can <a href=\"../find-jira-tickets-faster\" class=\"markdown-link\">open the ticket</a> to understand the business context around this code. From the ticket, they can follow through to the PR, and read the technical context in the PR description, and also the step by step instructions how to exercise the code (which is part of the PR description).</p>\n<h2 class=\"markdown-subtitle\" id=\"culture-of-writing\" style=\"position:relative;\"><a href=\"#culture-of-writing\" aria-label=\"culture of writing permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Culture of Writing</h2>\n<p class=\"markdown-para\">An effective team develops a culture of writing, both on the business and technical side.</p>\n<p class=\"markdown-para\">On the business side, writing is used to capture the requirements and business rules, and also the <em class=\"markdown-emphasis\">why</em> behind these. This could be tied to improved revenue generation or user experience. Its helpful for developers that are implementing the requirements to understand why a feature is being built a certain way. A team of genius developers that can solve every <a href=\"https://en.wikipedia.org/wiki/Competitive_programming\" class=\"markdown-link\">leetcode</a> interview question ever written could still be ineffective if they don't understand the requirements, or recognize when there’s additional clarifications to go to PM with.</p>\n<p class=\"markdown-para\">On the technical side, writing is used to share knowledge and expertise. This includes architectural proposals and decisions, project setup, common workflows through the application, troubleshooting tips, third party integrations, configuration, how to do deployments, how to exercise new code being added in a pull request, and anything else that helps developers understand how the project works.</p>\n<aside class=\"markdown-aside\">\nThe kind of documents I'm referring to are internal, that is, written by engineers for engineers working together on the same project. Not to be confused with external customer-facing documentation. That is best written by a specialist, especially if the customers are non-technical.\n</aside>\n<p class=\"markdown-para\">These written documents are not intended as <em class=\"markdown-emphasis\">contracts</em> where people can finger point later if something is not working. Rather, they are <em class=\"markdown-emphasis\">living</em> documents owned by the entire team. They support collaboration and team continuity, and are updated as questions and new information arises. Here is where I differ from one of the Agile Manifesto principles which states:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">The most efficient and effective method of conveying information to and within a development team is face-to-face conversation.</p>\n</blockquote>\n<p class=\"markdown-para\">The original manifesto was developed in <a href=\"https://agilemanifesto.org/history.html\" class=\"markdown-link\">2001</a>. Changes in team work since then include the prevalence of remote work, recognition of the importance of mental health and preventing burnout, DEI, neurodiversity, and psychology research on <a href=\"https://en.wikipedia.org/wiki/Flow_(psychology)\" class=\"markdown-link\">flow state</a>. Relying primarily on face-to-face conversations:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Results in a lot of scheduled or impromptu meetings that interrupt flow state.</li>\n<li class=\"markdown-list-item\">Requires co-incidence that everyone required to make a decision happens to be online at the same time. What if someone's out sick, vacation, appointment, has another commitment, works in a different timezone etc.</li>\n<li class=\"markdown-list-item\">Relies on people having perfect memories of what was discussed.</li>\n<li class=\"markdown-list-item\">Assumes that the best way to get people's input into decisions is via realtime conversation - this can result in \"off the cuff\" remarks that upon deeper technical analysis, may not turn out to be optimal.</li>\n<li class=\"markdown-list-item\">Can be prone to <a href=\"https://www.linkedin.com/pulse/loudest-voice-room-hisako-esaki/\" class=\"markdown-link\">loudest voice in the room</a> effect where the more dominant personalities assert their opinions, and the quieter types that may have differing opinions don't feel comfortable challenging it or can't get a word in.</li>\n<li class=\"markdown-list-item\">Results in a lot of knowledge that only lives in people's heads, and gets lost as people leave.</li>\n</ul>\n<p class=\"markdown-para\">Using written communication can improve team effectiveness by:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Minimizing interruptions - developers can review proposals or questions others may have when its an optimal time for them.</li>\n<li class=\"markdown-list-item\">Asynchronous nature of responding to written communication means the team can be distributed and can still function even when people have different schedules or personal matters to attend to. i.e. work can revolve around life rather than life needing to revolve around work.</li>\n<li class=\"markdown-list-item\">Leaves a written artifact of discussions and decisions. No more \"What was that we decided in the meeting last month?\" or \"Why was tool X over Y chosen?\".</li>\n<li class=\"markdown-list-item\">Captures everyone's feedback because everyone has an opportunity to contribute to shared documents with the results of deep, thoughtful analysis.</li>\n<li class=\"markdown-list-item\">Contributes to a shared understanding of business and technical decisions. Not only for the current team members, but future team members. i.e. as the usual churn of tech workers coming and going happens, the project can still continue smoothly because important information has been captured in writing.</li>\n</ul>\n<h2 class=\"markdown-subtitle\" id=\"meetings\" style=\"position:relative;\"><a href=\"#meetings\" aria-label=\"meetings permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Meetings</h2>\n<p class=\"markdown-para\">The previous section on writing is not to suggest that face-to-face conversations are never needed. There could be a tricky issue that's gone back and forth in comments in a document or PR and isn't getting resolved. Or some people think better \"out loud\" and sometimes need to bounce ideas off a few other people. An effective team will support all types of thinkers.</p>\n<p class=\"markdown-para\">If a meeting is needed, here's how to get the most out of the precious time:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Keep it brief:</strong> Set the default meeting time to 30 minutes. If you think you'll need longer, bump it up to 45 minutes, but try not to go over an hour. People lose their focus beyond this, and if the issue hasn't been resolved in an hour, dragging it on any longer doesn't help.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Limit attendees:</strong> The entire team is not needed at every meeting. For example, if two people are having a strong difference of opinion over a technical proposal, only those two, plus maybe the team lead or manager should be required. Other team members can be marked as optional. It's not always the case that every team member has a strong opinion, for these folks, not interrupting them and letting them get on with their work may be best.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Have a goal:</strong> Include a goal in the meeting description. This is different from an agenda, which is just a list of items to be discussed. A goal on the other hand is very specific. For example: \"At the end of this meeting, we will have a decision on whether to use RabbitMQ or Kafka for messaging\". Or \"The purpose of this meeting is to finalize the design for the search results page\".</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Come prepared:</strong> The meeting description should include pointers to documents/discussion that has happened prior, so all attendees can be fully up to speed before the meeting starts. In the case of a technical decision, this could be a link to an <a href=\"../about-those-docs/#architecture-decision-records\" class=\"markdown-link\">ADR</a> and related PR comments. In the case of a UI/UX decision, it could be pointers to the current designs.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Update docs:</strong> Update the referenced documents during the meeting as decision(s) are being made. This way there's no issue of forgetting what was decided or someone having to be a secretary later transcribing what people said. At the conclusion of the meeting, share/publish the decision to make it visible to the entire team.</p>\n<aside class=\"markdown-aside\">\nShopify has gone as far as <a class=\"markdown-link\" href=\"https://www.forbes.com/sites/jenamcgregor/2023/01/03/shopify-is-canceling-all-meetings-with-more-than-two-people-from-workers-calendars-and-urging-few-to-be-added-back/?sh=61950fd6fe8a\">cancelling all recurring meetings involving two or more people</a>. Perhaps once a company gets to a large enough size, a top-down edict like this is needed. My suggestion is to consider what problem you're trying to solve by booking a meeting, and then see if there's an asynchronous/written approach that could solve it. If that's been tried and didn't work, then book the meeting, keeping the above guidelines in mind to maximize the time investment.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"small-ish-team-size\" style=\"position:relative;\"><a href=\"#small-ish-team-size\" aria-label=\"small ish team size permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Small-ish Team Size</h2>\n<p class=\"markdown-para\">Over the years, I have found the optimal team size to be on the small end, ranging from 2 - 4 developers, plus a PM and designer. Keeping the team size small limits the number of <a href=\"https://www.leadingagile.com/2018/02/lines-of-communication-team-size-applying-brooks-law/\" class=\"markdown-link\">lines of communication</a>. Here is a useful diagram from that blog post to illustrate the issue:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 93%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACYUlEQVR42k2UiYpqQQxE+/8/SRgdREXUN4rivu/7jPuueZyCiA2h7XRSqVT6GszMns+nHQ4H87Xf7+16vdrj8dDOmfV6vWy32yneF+fL5WLb7dbu97sFnPw4nU7vwPP5LCDOBGPEsAPg9yyAsL+/P7vdbhaoSjALhzPGvIgzw4ihm81mI8N3PB4Vu1wuLVCV1pwplfF9tsyZBRDJSEAR7h0YhjAPrheGgzNGRdg4AExXq5Xi1uv1u8jv768KcaeWSZhOp7pYLBZvlvgIchAAJpOJmOBzIvhgSD578Gm5yL6ohrm+tPips5/ZfWgsaUgLs9lM03IQGI5GI/kdBDa9Xk9+9ANsOBxatVq1VqsleaQhrTKt+XwuMOh7y+Px+P00SAK03WrrDu1qtZpAm82mCgXAYIg2sCEIQIB4BgShDYU7nY4Au92u4vGVy2Wd6/W6gPUOAcUIcl0AI5mdRYsUpGWKuQz4Go2G/MxBU/ZJkYwTH+1zZvd36T6MZ4WP1iHDjmyBSlzCwAfCDgg7Sfj88/R7jBzert+To2eDhlD2PwEWVdGFyr6QhInC9NNXLBaVr2eDBvl8XuKyUwWQdDpthUJBu3+ziURC53g8rraRJhqNWjKZtEgkouGEdrttlUrF+v2+AEgeDAaWy+X0FLLZrJ4QBhADSKVSmjhdfH19iSF3EApUBqhUKgmYb5bWf/79WCaTUZB/19lMVmxgSR4aUjAWi9l37FvSBcTkB28IdgRh+GCNRsRQiPeJVrRLAXw8eNj6FxX8n4ILQJga2tAOPkBgjLYMg98U8X9qcl1j/hz+A902oR1U+w67AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lines of communication and team size\"\n        title=\"lines of communication and team size\"\n        src=\"/static/ce812dfb09d0601a9688d1e0638b35aa/5a190/lines-of-communication-teams-size.png\"\n        srcset=\"/static/ce812dfb09d0601a9688d1e0638b35aa/772e8/lines-of-communication-teams-size.png 200w,\n/static/ce812dfb09d0601a9688d1e0638b35aa/e17e5/lines-of-communication-teams-size.png 400w,\n/static/ce812dfb09d0601a9688d1e0638b35aa/5a190/lines-of-communication-teams-size.png 800w,\n/static/ce812dfb09d0601a9688d1e0638b35aa/0f246/lines-of-communication-teams-size.png 1118w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">If the team has 2 developers, a PM, and a designer, that's a total size of 4, resulting in 6 lines of communication, which is manageable. Bumping this up to 4 developers results in a total team size of 6, which leads to 15 lines of communication. That's pushing at the maximum of what a team can manage and still be effective.</p>\n<p class=\"markdown-para\">It can be tempting to add more developers to a project thinking that productivity will improve linearly. For example if one developer can complete one feature per week, then adding 9 more developers will result in 9 features completed per week. However, 9 developers plus a PM and designer makes 11 team members, which results in 55 lines of communication! What's more likely is people end up stepping on each other's toes attempting to modify the same area of the code for different reasons, or spending the majority of their time in meetings trying to co-ordinate rather than hands-on building software. This is explained by <a href=\"https://en.wikipedia.org/wiki/Brooks%27s_law\" class=\"markdown-link\">Brook's Law</a> which observes that adding people to a software project that is behind schedule delays it even longer.</p>\n<p class=\"markdown-para\">There's a little more nuance here in that it varies with the surface area of the project. A large project could potentially support a few more developers, if the areas that need to be developed are independent of each other, and there's up-to-date engineering documentation that allows developers to <a href=\"../about-those-docs#readmemd-project-setup\" class=\"markdown-link\">onboard</a> independently.</p>\n<h2 class=\"markdown-subtitle\" id=\"do-the-simplest-thing-that-works\" style=\"position:relative;\"><a href=\"#do-the-simplest-thing-that-works\" aria-label=\"do the simplest thing that works permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do the Simplest Thing That Works</h2>\n<p class=\"markdown-para\">I learned this motto from a company I worked at earlier in my career and the advice has served me well.</p>\n<p class=\"markdown-para\">An effective team chooses relatively simple solutions that get the job done, while not painting themselves into a corner. The idea here is to value maintainability and ease of deployment over cleverness or attempting a \"big tech\" architecture from day one of the project. While its nice to think that in the future, the project will be so popular it needs to support millions, or even billions of simultaneous users, the reality is, most projects don't get to Meta/Alphabet/Amazon scale.</p>\n<p class=\"markdown-para\">This often means <a href=\"https://www.martinfowler.com/bliki/MonolithFirst.html\" class=\"markdown-link\">starting with a monolith</a> rather than microservices. It can be split up later if transaction volumes and revenue generated from these justifies that. Even then, it's beneficial to measure and identify where the performance bottlenecks are, and come up with solutions to address those directly. For example, if incoming requests are receiving errors due to running out of database connections, splitting up into microservices may not resolve the underlying issue. Instead investigate - Can the database max connections config be increased? Is connection pooling being used and properly configured? Is there a memory leak where some code is always opening, then forgetting to close a connection? Is there some work that could be moved to a background task runner to reduce the time needed to handle common requests? If many requests are read-only could increasing the number of database replicas help? For reads and writes, consider <a href=\"https://dzone.com/articles/how-to-horizontally-scale-your-postgres-database-using-citus\" class=\"markdown-link\">horizontal scaling</a> of database. Notice these investigations are going from simplest to more complex.</p>\n<p class=\"markdown-para\">Avoid over-engineering, i.e. building in abstractions and flexibility unless its known to be needed. Otherwise what can happen is this flexibility is never needed, but when future requirements come in, they need to \"flex\" in a different direction, resulting in overly complex code.</p>\n<p class=\"markdown-para\">Avoid premature optimization. For example, writing harder to understand code that shaves microseconds of performance over more straightforward code. Developers spend more of their time reading code others wrote rather than writing new code so legibility and avoiding second takes is often more valuable than a few microseconds that some obscurely written code saves. In my experience, performance issues have been caused more frequently by loading too much data from the server (eg: lack of pagination), missing database indices, N+1 queries, and loading too much JavaScript, such as trackers or non-minified code.</p>\n<p class=\"markdown-para\">There are exceptions - in some domains such as real-time systems or graphics processing, these microseconds matter. This is a good place to add <a href=\"../about-those-docs#code-comments\" class=\"markdown-link\">code comments</a> explaining what this code does, and more importantly <em class=\"markdown-emphasis\">why</em> this code is needed.</p>\n<h2 class=\"markdown-subtitle\" id=\"fullstack\" style=\"position:relative;\"><a href=\"#fullstack\" aria-label=\"fullstack permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fullstack</h2>\n<p class=\"markdown-para\">When I started my career, there were no separate titles for front and back end developers. The titles were just like \"software developer\" or \"programmer analyst\". These were fullstack roles before that term had been coined. Developers were responsible for building features end to end, including database schema design, back end services, APIs, and making the front end look and function as specified in the <a href=\"https://thedilldesign.com/web-design-comps-made/\" class=\"markdown-link\">design comps</a>.</p>\n<p class=\"markdown-para\">Then some years later, a trend emerged to have separate roles such as \"back end developer\" and \"front end developer\". The idea being that these are separate skills with often, separate languages, and that people should specialize in one area or another. I've had opportunities to work as fullstack, front-end only, and back-end only, and have found fullstack to be the most effective.</p>\n<p class=\"markdown-para\">It's true that there's a different kind of thinking involved in building the front end such as the declarative nature of HTML and CSS, weaving in JavaScript in an organized way (which could mean learning a number of <a href=\"https://developer.mozilla.org/en-US/docs/Glossary/SPA\" class=\"markdown-link\">SPA</a> frameworks), a focus on the visual, animations, and accessibility, just to name a few items. Whereas on the back end a developer is focused on ensuring the database is normalized, efficient queries, building models that accurately represent the business domain, and services and APIs that implement the business rules.</p>\n<p class=\"markdown-para\">However, neither of these are how the business people (who are paying the developers to have this software built), nor the customers (who will use the product) actually think about it. They view the application as a single unit that either solves their problem or doesn't.</p>\n<p class=\"markdown-para\">Consider an example: When the PM specifies a new feature to be added to the product such as advanced search, the requirements will have the design comps showing the layout of the new fields, and specify the behaviour for what kind of results should be returned for various combinations of fields. The PM is not thinking about (nor should they) which parts of the logic will execute on the server and which on the client.</p>\n<p class=\"markdown-para\">When there are separate teams of developers doing front vs back end work, this feature gets split up into two tickets - one to implement the front end and another for the back end. Now there's a very tight dependency between the two people working on these tickets. They might collaborate to determine the path of the search API endpoint and what parameters it will support. Then the back end person will implement it and submit a PR for that work, which will get merged. In the meantime, the front end person can start building their part, perhaps with a mock API (which someone will have to implement) that mirrors the real API that was agreed to.</p>\n<p class=\"markdown-para\">But the front end person won't be able to finish their work until the back end developer's real API is merged. Then the front end developer can update their branch with the real API and start using it. Then they might realize there's an issue, perhaps some edge cases that the search endpoint isn't handling or a bug. Or when the PM views the front end with the real back end, they may want some changes. Who here hasn't had the experience of a conversation with a PM along the lines of \"I thought it should work this way, but now that I see it in action, I think it would be better if it behaved this other way...\"</p>\n<p class=\"markdown-para\">Now the front end developer has to reach out to the back end developer, who may have moved on to another ticket and either have to context switch or tell the front end developer to wait until they have time to fix it. So the front end developer will mark the ticket as blocked and move on to something else, hopefully remembering to return to the original ticket whenever the backend developer gets around to merging the fixes.</p>\n<p class=\"markdown-para\">The other thing that often happens is there's a deadline to get the feature complete. In this case the front end developer may have no choice but to implement some workarounds on the front end to make things seemingly work, when it would have been more efficient to have the back end do this.</p>\n<p class=\"markdown-para\">It's not the fault of the PM that is asking for changes, remember Agile tells us we're supposed to embrace change! But when the teams are structured as horizontal slices of the stack (database, back end, front end), it creates friction to get features complete that are vertical slices through the stack. It's more effective to give every developer autonomy over the entire stack so they can use the appropriate tools to get their job done.</p>\n<p class=\"markdown-para\">If some team members prefer to specialize in one area or another, this can still work. In this case, have those experts be on the PR reviews, and gradually document their specialized knowledge. To the extent that the best practices can be encoded as linting rules, bring those rules into the project linter (more on this in the next section). In this way, it's like everyone on the team has the expert sitting beside them as they code, levelling up everyone's knowledge. It's also beneficial to the company in case the expert(s) leave.</p>\n<h2 class=\"markdown-subtitle\" id=\"automation\" style=\"position:relative;\"><a href=\"#automation\" aria-label=\"automation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Automation</h2>\n<p class=\"markdown-para\">An effective team establishes automated processes to minimize manual effort. This includes linting, automated testing, CI (Continuous Integration), and CD (Continuous Deployment) in place from the very early days of the project. <a href=\"../add-rubocop-to-legacy-project\" class=\"markdown-link\">Linting can be added later</a>, although that will be more effort. Unless it's a hack-a-thon or throw-away code, this is a must.</p>\n<p class=\"markdown-para\">A good set of linting rules suggests best practices, prevents common coding errors, and enforces code style/formatting to avoid <a href=\"https://en.wikipedia.org/wiki/Law_of_triviality\" class=\"markdown-link\">bike shedding</a> in PRs. Especially when it comes to code style, (eg: spacing, semi colons, etc.), it's less important to be \"right\" and more important for the team to be consistent.</p>\n<p class=\"markdown-para\">Getting in the habit of writing automated tests (unit, integration, and system/end-to-end) leads to better quality code. It also supports adding new features and refactoring without fear of causing regressions, and minimizes or eliminates entirely the need for manual QA.</p>\n<p class=\"markdown-para\">Linting and tests should be easy to run on each developers laptop, via CLI and/or editor plugins. These should also run as part of CI, which should be running on each commit pushed to feature branches and the main branch. A failure in CI should notify the developer that pushed the breaking commit. The main branch should be protected such that CI must be passing before any PR can be merged.</p>\n<p class=\"markdown-para\">Finally, where possible, continuous deployment should be setup to automatically deploy after code is merged to the main branch (given that CI is passing). This avoids manual effort of having a developer putting together a build, cutting a release branch, asking the team not to merge any PRs while the release is in progress, etc.</p>\n<h2 class=\"markdown-subtitle\" id=\"maintenance\" style=\"position:relative;\"><a href=\"#maintenance\" aria-label=\"maintenance permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Maintenance</h2>\n<p class=\"markdown-para\">As exciting as it is to work on new features, an effective team dedicates a certain percentage of time to maintenance. This could include dealing with dependabot PRs, alerts from monitoring systems, deprecation warnings, library upgrades, and bug fixes. Otherwise things can get stale or stop working altogether, and make it difficult to keep moving the project forward.</p>\n<p class=\"markdown-para\">Some teams will set aside a certain part of the year for these activities. Another way is to regularly add these items to the ticketing system with a tag such as <code>Maintenance</code>, and then let developers know for every 3 or so features they work on, pick up a maintenance task. This would work out to roughly 25% of time spent on maintenance. Adjust as per your teams needs, as long as its not 0.</p>\n<h2 class=\"markdown-subtitle\" id=\"rotate-assignments\" style=\"position:relative;\"><a href=\"#rotate-assignments\" aria-label=\"rotate assignments permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rotate Assignments</h2>\n<p class=\"markdown-para\">On many teams, developers tend to become experts on the area of the application that they've worked on most. It could be based on interest, or just by co-incidence of the initial task assignments. Then when new feature requests or bugs come up, they get assigned to the developer that's already most familiar with that area because it will be \"faster\" to get it done.</p>\n<p class=\"markdown-para\">However, this speed is an illusion, or a trade-off between the short term and long term viability of the project. When the expert goes on an extended vacation or leaves to pursue another opportunity, progress slows down when development is needed in the area that only the expert was familiar with.</p>\n<p class=\"markdown-para\">To mitigate this risk, an effective team will intentionally rotate task assignments so that all developers get opportunities to work on all areas of the project. It may feel slower at first, but the payoff is a more resilient team in the future.</p>\n<p class=\"markdown-para\">The purpose of this strategy is to lower the lottery count, i.e. how many team members would have to win the lottery in order for the project to be in trouble. This is also known as the <a href=\"https://www.agileadvice.com/2005/05/15/agilemanagement/truck-factor/\" class=\"markdown-link\">truck factor</a>, but it's nicer to visualize a lottery win rather than getting hit by a truck.</p>\n<p class=\"markdown-para\">This is also an opportunity to improve engineering documentation. As a developer works on an area of the project for the first time, they will naturally have questions that only the expert knows. The new developer can then update the related engineering docs and include it in the PR for the expert to review. This will improve speed of development for the next developer to work in this area.</p>\n<h2 class=\"markdown-subtitle\" id=\"psychological-safety\" style=\"position:relative;\"><a href=\"#psychological-safety\" aria-label=\"psychological safety permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Psychological Safety</h2>\n<p class=\"markdown-para\">Psychological safety is an absolute must in order for any team to work effectively. Here is the definition that was given on the <a href=\"https://www.se-radio.net/2022/12/episode-543-jon-smart-on-patterns-and-anti-patterns-for-successful-software-delivery-in-enterprises/\" class=\"markdown-link\">podcast</a> that inspired this post:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Psychological safety is the ability to feel safe to ask questions, to challenge authority, to have your voice heard, to express your thoughts without fear of repercussion, without fear of being shot down or belittled. It's the ability to have open, vulnerable conversations with respect. Not having a blame culture. If something goes wrong, its not because someone did something wrong, it's because there was something in the system of work that enabled this thing to happen.</p>\n</blockquote>\n<p class=\"markdown-para\">To this I would add, not just feeling safe to ask questions and challenge authority, but for it to be <em class=\"markdown-emphasis\">encouraged</em> across the hierarchy. For example, it should be ok for a junior dev to question the architecture proposed by the CTO. This is necessary for new idea generation. Otherwise the team stagnates into a culture of \"we've always done things this way\", and stops innovating. Not every new idea that people suggest will work out, but they should never be censured for it because other people will look to that example and think \"I better keep my mouth shut\", and that other idea that never gets surfaced could have been amazing.</p>\n<p class=\"markdown-para\">Developers also need to feel safe suggesting accurate estimates (which are typically larger than business people like to hear) or indicating that something is going to take longer than the initial estimate. When this safety isn't present, people end up working long hours trying to reach unrealistic deadlines, quality suffers, and burn out ensues.</p>\n<aside class=\"markdown-aside\">\nThe topic of estimates is way too large to fully cover in this post, and somewhat out of scope so I've only touched on it. Give a listen to this podcast from Freakonomics on <a class=\"markdown-link\" href=\"https://freakonomics.com/podcast/heres-why-all-your-projects-are-always-late-and-what-to-do-about-it/\">why all your projects are always late</a> for an insightful and entertaining take.\n</aside>\n<p class=\"markdown-para\">Another aspect of psychological safety is what happens when someone makes a mistake that has a serious impact such as data loss? It's important to not assign blame to the individual but rather, look to how the system can be improved so no one else can ever make this mistake again. For example, is there some connection between the dev and production environments that shouldn't exist? Was some operational documentation out of date? Should every developers shell profile include logic to turn the prompt red when connecting to production? Every mistake is an opportunity to improve systems and documentation. On the other hand if an individual \"gets in trouble\" for admitting to a mistake, you can be sure that no one will ever admit to a mistake again, which makes the entire matter worse.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered the definition of an effective software development team, and practices that lead to effectiveness. These practices include:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Lightweight process that lets developers get into flow state and supports traceability.</li>\n<li class=\"markdown-list-item\">Favoring written communication over frequent meetings.</li>\n<li class=\"markdown-list-item\">Maintaining a small team.</li>\n<li class=\"markdown-list-item\">Sticking to simple implementations where possible.</li>\n<li class=\"markdown-list-item\">Favoring fullstack where possible.</li>\n<li class=\"markdown-list-item\">Automate all the things.</li>\n<li class=\"markdown-list-item\">Dedicated time to maintenance.</li>\n<li class=\"markdown-list-item\">Giving all team members opportunities to work on all areas of the product, especially those in which they're less familiar.</li>\n<li class=\"markdown-list-item\">Ensuring a psychologically safe environment for everyone.</li>\n</ul>\n<p class=\"markdown-para\">For further reading on this topic, see this post on <a href=\"https://martinfowler.com/articles/developer-effectiveness.html\" class=\"markdown-link\">Developer Effectiveness</a> on Martin Fowler's blog.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","fields":{"slug":"/blog/reflections-on-effective-teams/"}}},{"node":{"id":"e033086f-0522-5adf-b26c-0299558696b4","frontmatter":{"title":"Private Gems and Docker for Development","date":"January 2023","category":"ruby"},"excerpt":"If you're using Docker for development with a Rails application, and want to introduce a private gem registry hosted with Github Packages…","html":"<p class=\"markdown-para\">If you're using Docker for development with a Rails application, and want to introduce a private gem registry hosted with <a href=\"https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry\" class=\"markdown-link\">Github Packages</a>, you may encounter an authentication error when building the development Docker image, at the point where it tries to pull the private gem(s). This post will walk you through the steps to resolve this.</p>\n<p class=\"markdown-para\">An important note before moving on - the solution presented in this post is only suitable for a <em class=\"markdown-emphasis\">development</em> Docker image. That is, an image that remains on the developer's laptop and <em class=\"markdown-emphasis\">never</em> gets pushed to production or made public.</p>\n<h2 class=\"markdown-subtitle\" id=\"configure-bundler\" style=\"position:relative;\"><a href=\"#configure-bundler\" aria-label=\"configure bundler permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configure Bundler</h2>\n<p class=\"markdown-para\">Given that your projects <code>Gemfile</code> is pulling some gems from Github Packages, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">source &#39;https://rubygems.pkg.github.com/some-project/&#39; do</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  gem &#39;myprivate_gem&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">end</span></span></code></pre>\n<p class=\"markdown-para\">The Github documentation on configuring bundler so that you can pull private gems specifies that you must first run the following command:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ bundle config https://rubygems.pkg.github.com/OWNER USERNAME:TOKEN</span></span></code></pre>\n<p class=\"markdown-para\">Where:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><code>OWNER</code> is the user or organization account that owns the repository that contains the gem project source.</li>\n<li class=\"markdown-list-item\"><code>USERNAME</code> is in the individual user (Github account) that would like to pull the gem when building the Rails app that depends on it.</li>\n<li class=\"markdown-list-item\"><code>TOKEN</code> is a Github personal access token (aka <a href=\"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token\" class=\"markdown-link\">PAT</a>) that each user running the project needs to create.</li>\n</ul>\n<p class=\"markdown-para\">If everyone on your team was running the Rails project natively on their laptops, you would just update the <code>README.md</code> telling each developer to create their  PAT, run the <code>bundle config...</code> command locally, then run <code>bundle install</code> which will pull the new private gem(s) specified in <code>Gemfile</code>. You keep your <a href=\"../about-those-docs\" class=\"markdown-link\">project setup docs</a> up to date right?</p>\n<aside class=\"markdown-aside\">\nThe Github documentation on private gems also refers to creating or updating your ~/.gemrc file, including the Github credentials in this file. However, this is only required for publishing gems, and will not be covered in this post.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"dockerized-development\" style=\"position:relative;\"><a href=\"#dockerized-development\" aria-label=\"dockerized development permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dockerized Development</h2>\n<p class=\"markdown-para\">However, things are a little more complicated if using a <a href=\"../dockerize-rails-app-for-dev-debug-and-testing\" class=\"markdown-link\">Dockerized setup for development</a>. With this setup, it's the <code>Dockerfile</code> that runs <code>bundle install</code> when the image is being built. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"dockerfile\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> ruby:whatever-version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle install</span></span></span></code></pre>\n<p class=\"markdown-para\">However, if any of the gems in the <code>Gemfile</code> are coming from a private registry, such as <a href=\"https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry\" class=\"markdown-link\">Github Packages RubyGems</a>, trying to build this image will fail with the following authentication error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Authentication is required for rubygems.pkg.github.com.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Please supply credentials for this source. You can do this by running:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle config rubygems.pkg.github.com username:password</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">executor failed running [bundle install]: exit code: 17</span></span></code></pre>\n<p class=\"markdown-para\">This means the <code>bundle config...</code> needs to be run as part of the image building, before running <code>bundle install</code>, something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"dockerfile\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> ruby:whatever-version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle config https://rubygems.pkg.github.com/OWNER USERNAME:TOKEN</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle install</span></span></span></code></pre>\n<p class=\"markdown-para\">The problem with the above is that the <code>Dockerfile</code> is committed in the project. You wouldn't  want to commit this line as is, because <code>USERNAME</code> will be different for each developer working on the project. <code>TOKEN</code> is a user-specific secret that provides some access to the developer's Github account so that definitely should not be committed.</p>\n<h2 class=\"markdown-subtitle\" id=\"dockerfile-arg\" style=\"position:relative;\"><a href=\"#dockerfile-arg\" aria-label=\"dockerfile arg permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dockerfile ARG</h2>\n<p class=\"markdown-para\">What we need to solve this problem is <em class=\"markdown-emphasis\">dynamic</em> values during the Docker build process. The <a href=\"https://docs.docker.com/engine/reference/builder/#arg\" class=\"markdown-link\">ARG</a> command in a Dockerfile can be used for exactly this. Specify the <code>ARG</code>s at beginning of the <code>Dockerfile</code>, just after the <code>FROM</code> command. Rather than <code>USERNAME</code> and <code>TOKEN</code> from the Github documentation, I'm going to name these to be more specific as to what they're used for:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"dockerfile\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> ruby:your-base-image</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ARG</span><span class=\"mtk1\"> GITHUB_USERNAME</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ARG</span><span class=\"mtk1\"> GITHUB_PAT_GEMS</span></span></span></code></pre>\n<p class=\"markdown-para\">Then later in Dockerfile, just before bundle install is run, add the <code>bundle config...</code> command from the Github documentation, but this time, using the <code>ARG</code> variables. Replace <code>project</code> with project name where the private gem source is located:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"dockerfile\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> ruby:whatever-version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ARG</span><span class=\"mtk1\"> GITHUB_USERNAME</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ARG</span><span class=\"mtk1\"> GITHUB_PAT_GEMS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle config https://rubygems.pkg.github.com/project GITHUB_USERNAME:GITHUB_PAT_GEMS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle install</span></span></span></code></pre>\n<p class=\"markdown-para\">Now if you were building the Docker image directly, you could run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker build -t app-image:latest \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  --build-arg GITHUB_USERNAME=your-github-username \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  --build-arg GITHUB_PAT_GEMS=your-github-pat \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  .</span></span></code></pre>\n<p class=\"markdown-para\">To re-emphasize the note from the beginning of this post, using <code>ARG</code> in this way is only suitable for a development image that will never be made public. This is because the <code>ARG</code> values become part of the image and are viewable in the output of the <code>docker history</code> command. If you need build-time secrets for a production image, see the Docker documentation on <a href=\"https://docs.docker.com/develop/develop-images/build_enhancements/#new-docker-build-secret-information\" class=\"markdown-link\">BuildKit</a>.</p>\n<aside class=\"markdown-aside\">\nYou may be wondering why not use <a class=\"markdown-link\" href=\"https://docs.docker.com/engine/reference/builder/#env\">ENV</a>? The reason is Docker does not provide a way to dynamically set ENV values during the build process, and these values are only needed during the image build time, not container run time. Read this <a class=\"markdown-link\" href=\"https://www.baeldung.com/ops/dockerfile-env-variable\">blog post</a> for more on this topic.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"docker-compose\" style=\"position:relative;\"><a href=\"#docker-compose\" aria-label=\"docker compose permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Compose</h2>\n<p class=\"markdown-para\">This project uses several other services including MySQL and Redis, therefore, <a href=\"https://docs.docker.com/compose/\" class=\"markdown-link\">Docker Compose</a> is used to build the image and run all the containers together. This means we need to be able to pass through the Docker <code>ARG</code>s from the <code>docker-compose.yml</code> file to the <code>Dockerfile</code>. Fortunately, docker compose provides the <a href=\"https://docs.docker.com/compose/compose-file/compose-file-v3/#args\" class=\"markdown-link\">args</a> keyword for the <code>build</code> command for just this purpose.</p>\n<p class=\"markdown-para\">Trying it out however poses a new problem as shown below:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># docker-compose.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">app</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">args</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">GITHUB_USERNAME</span><span class=\"mtk1\">: </span><span class=\"mtk6\">uh oh, what to put here?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">GITHUB_PAT_GEMS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">uh oh, what to put here?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mysql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># ...</span></span></span></code></pre>\n<p class=\"markdown-para\">Since the <code>docker-compose.yml</code> file is also committed into the project, we do not want to hard-code Github user names and tokens in this file either. Fortunately, docker compose supports the use of <a href=\"https://docs.docker.com/compose/environment-variables/\" class=\"markdown-link\">environment variables</a>. Here's how to specify the Github username and PAT as environment variables in the compose file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># docker-compose.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">app</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">args</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">GITHUB_USERNAME</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${GITHUB_USERNAME}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">GITHUB_PAT_GEMS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${GITHUB_PAT_GEMS}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mysql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># ...</span></span></span></code></pre>\n<p class=\"markdown-para\">Next step is being able to pass the values of these environment variables to docker compose via the command line. This can be accomplished with the <code>--env-file</code> argument, passing in a path to a file containing the values:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose --env-file .env.dockercompose.local build</span></span></code></pre>\n<p class=\"markdown-para\">Where <code>.env.dockercompose.local</code> is a gitignored file that specifies the secrets. You can name the .env file whatever you want, just make sure its in the <a href=\"https://git-scm.com/docs/gitignore\" class=\"markdown-link\">gitignore</a> so it doesn't get committed. Here's what the env file will look like:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">GITHUB_USERNAME=your-github-username</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">GITHUB_PAT_GEMS=your-github-pat</span></span></code></pre>\n<p class=\"markdown-para\">Now, when the docker-compose build command is run, it will have access to the values of <code>GITHUB_USERNAME</code> and <code>GITHUB_PAT_GEMS</code> from the .env file. Then these will get passed on to the <code>Dockerfile</code> as ARG's, where they can be used in building the image.</p>\n<h2 class=\"markdown-subtitle\" id=\"makefile\" style=\"position:relative;\"><a href=\"#makefile\" aria-label=\"makefile permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Makefile</h2>\n<p class=\"markdown-para\">To save yourself all that typing of the docker compose command with the env file, if your project uses a <code>Makefile</code>, you can add the following task:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"makefile\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose --env-file .env.dockercompose.local build</span></span></span></code></pre>\n<p class=\"markdown-para\">Now whenever you need to build the image (such as when new gems have been added to the project's <code>Gemfile</code>), simply run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">make build</span></span></code></pre>\n<p class=\"markdown-para\">Remember to also update the project's <code>README.md</code> with the new setup instructions that everyone wanting to build the image on their laptop needs to create a <code>.env.dockercompose.local</code> file and populate it with their Github username and personal access token.</p>\n<aside class=\"markdown-aside\">\nI've mentioned a few times about keeping the README.md up to date when making changes to the setup process that impact all the other developers working on the project. Although almost no one likes writing engineering documentation, they certainly appreciate having good, up to date docs. See my post on <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/about-those-docs/\">engineering documentation</a> for what kinds of things should get documented and how to get in a good frame of mind for writing it.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered how to authenticate to the Github Packages RubyGems private registry when using Docker for Rails development. The technique involves use of Docker <code>ARG</code>s to specify dynamic build time values, docker compose environment variables to pass them through to the build, and a gitignored env file to avoid committing the secrets. Again a reminder that this technique should only be used for a development image that will never leave the developer's laptop.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/private-gems-and-docker-dev/"}}},{"node":{"id":"41a3cfc2-1062-525c-b57b-3f04d6b73b8a","frontmatter":{"title":"When RSpec Doesn't Rollback","date":"December 2022","category":"rails"},"excerpt":"This post will walk you through some troubleshooting techniques when RSpec tests are failing due to unexpected data in the test database. I…","html":"<p class=\"markdown-para\">This post will walk you through some troubleshooting techniques when <a href=\"https://rspec.info/\" class=\"markdown-link\">RSpec</a> tests are failing due to unexpected data in the test database. I had experienced some RSpec tests that were passing the first time they ran, individually, but then failing on subsequent runs, or when run as part of the entire test suite. It turned out to be a combination of two things - not fully understanding how RSpec manages transactions, and how using or not using <code>let/let!</code> helper methods can impact this.</p>\n<h2 class=\"markdown-subtitle\" id=\"setup\" style=\"position:relative;\"><a href=\"#setup\" aria-label=\"setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setup</h2>\n<p class=\"markdown-para\">The RSpec tests are part of a Rails project using the <a href=\"https://github.com/rspec/rspec-rails\" class=\"markdown-link\">rspec-rails</a> gem. The tests also make use of the <a href=\"https://github.com/thoughtbot/factory_bot\" class=\"markdown-link\">FactoryBot</a> and <a href=\"https://github.com/faker-ruby/faker\" class=\"markdown-link\">faker</a> gems to create test data. This post assumes some familiarity with these tools. The other thing to know is I listen to the <a href=\"https://www.bikeshed.fm/\" class=\"markdown-link\">Bike Shed</a> podcast, and recently there have been some discussions about not using <code>let</code>, or at least, avoid <a href=\"https://thoughtbot.com/blog/lets-not\" class=\"markdown-link\">overusing</a> it.</p>\n<p class=\"markdown-para\">The <code>rails_helper.rb</code>, which is included in every spec file configures transactions as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/rails_helper.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">RSpec</span><span class=\"mtk1\">.configure </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.use_transactional_fixtures </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other config ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">My understanding of this setting was that data inserted into the test database <em class=\"markdown-emphasis\">anywhere</em> in a test would always get rolled back, leaving the database nice and clean for the next test.</p>\n<h2 class=\"markdown-subtitle\" id=\"failing-test\" style=\"position:relative;\"><a href=\"#failing-test\" aria-label=\"failing test permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Failing Test</h2>\n<p class=\"markdown-para\">Here is the troublesome test, it's for a subscription management app. It creates several different plans for an email service, exercises some code that generates the available options based on what's in the database, and then expects exactly two options to be available:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe </span><span class=\"mtk6\">&quot;my test class&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;year&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  it </span><span class=\"mtk6\">&quot;some test&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.generate_options(</span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># expects exactly two options: a monthly plan and a yearly plan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This test would pass when run individually and the first time but fail on subsequent runs. Also when run as part of a suite, other tests that also depended on exactly two options being available were failing. The failures were all due to more plans being available in the database than expected. For example, 4 instead of 2, and on the next run, 6 instead of 2, and so on.</p>\n<p class=\"markdown-para\">Before moving on with troubleshooting, there's a command you can run to reset the test database. This is needed to reproduce the problem of \"run the test first time, it passes, subsequent runs, it fails\":</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Rails 5+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails db:reset RAILS_ENV=test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Older versions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rake db:reset RAILS_ENV=test</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"test-database\" style=\"position:relative;\"><a href=\"#test-database\" aria-label=\"test database permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test Database</h2>\n<p class=\"markdown-para\">My first step in troubleshooting was to connect to the test database (this project uses MySQL) and see what's in the <code>plans</code> table upon completion of a test run. This project does not run seeds against the test database, therefore the <code>plans</code> table should be empty after tests run, since any data created during the test should have been rolled back.</p>\n<p class=\"markdown-para\">Check your projects <code>config/database.yml</code> to determine the name of the test database. By default, if your development database is named <code>myapp</code>, then the test database will be <code>myapp_test</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">mysql -u root -D myapp_test</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mysql&gt; SELECT COUNT(*) FROM plans;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2</span></span></code></pre>\n<p class=\"markdown-para\">That's not right, the count should have returned 0. I ran the test again, then the count returned 4. This confirms that the plan data inserted during the test is not being rolled back, but why?</p>\n<h2 class=\"markdown-subtitle\" id=\"test-log\" style=\"position:relative;\"><a href=\"#test-log\" aria-label=\"test log permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test Log</h2>\n<p class=\"markdown-para\">Next step in troubleshooting was to inspect the <code>log/test.log</code> file at the project root. By default, when tests run, all activity that would normally be displayed in the terminal when a Rails server is running, gets saved in this log file. This includes database inserts. Let's see if it reveals any clues as to what's going on with the database when this test is running.</p>\n<p class=\"markdown-para\">Here is the relevant portion of the file from running this test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;month&#39;, &#39;2022-07-27 19:59:17&#39;, &#39;2022-07-27 19:59:17&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">COMMIT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;year&#39;, &#39;2022-07-27 19:59:17&#39;, &#39;2022-07-27 19:59:17&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">COMMIT</span></span></code></pre>\n<p class=\"markdown-para\">The insert statements are a result of the <code>FactoryBot.create(:plan...)</code> methods run by the test. That part is expected. However, the INSERTs are being committed rather than rolled back. That is unexpected.</p>\n<h2 class=\"markdown-subtitle\" id=\"where-is-data-created\" style=\"position:relative;\"><a href=\"#where-is-data-created\" aria-label=\"where is data created permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Where is data created?</h2>\n<p class=\"markdown-para\">Taking a closer look at what the RSpec docs have to say about <a href=\"https://relishapp.com/rspec/rspec-rails/docs/transactions\" class=\"markdown-link\">transactions</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">What it really means in Rails is \"run every test method within a transaction.\" In the context of rspec-rails, it means \"run every example within a transaction.\"</p>\n</blockquote>\n<p class=\"markdown-para\">So any data created within an example will be run within a transaction and rolled back. However, is data created within a <code>describe</code> block considered part of the example? Doing some research on RSpec and rollbacks led me to this Stack Overflow <a href=\"https://stackoverflow.com/questions/3333743/factory-girl-rspec-doesnt-seem-to-roll-back-changes-after-each-example/24372747#24372747\" class=\"markdown-link\">answer</a>. The sentence in particular:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">... use transactional fixtures will clear the DB as long as you created the data in the example itself. before :all do ... end is considered outside of the example, because the data remains untouched across multiple examples. Whatever you create in before :all you have to delete in after :all.</p>\n</blockquote>\n<p class=\"markdown-para\">Although my test wasn't using a <code>before</code> block, this got me wondering whether data created in a <code>describe</code> block is considered <em class=\"markdown-emphasis\">outside</em> of the example? To answer this question, I modified the test to move the data creation into the <code>it</code> block:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe </span><span class=\"mtk6\">&quot;my test class&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  it </span><span class=\"mtk6\">&quot;some test&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;year&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.generate_options(</span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># expects exactly two options: a monthly plan and a yearly plan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">After running this version of the test, I checked the test database to see if it was clean - and it was. This time there were no records left in the <code>plans</code> table after the test run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">mysql -u root -D myapp_test</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mysql&gt; SELECT COUNT(*) FROM plans;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0</span></span></code></pre>\n<p class=\"markdown-para\">I also checked what got generated in the <code>log/test.log</code> file. This time both inserts into the <code>plans</code> table are wrapped in named transactions using <a href=\"https://dev.mysql.com/doc/refman/8.0/en/savepoint.html\" class=\"markdown-link\">SAVEPOINT</a>, and rolled back at the end of the test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;month&#39;, &#39;2022-07-27 20:59:17&#39;, &#39;2022-07-27 20:59:17&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;year&#39;, &#39;2022-07-27 20:59:17&#39;, &#39;2022-07-27 20:59:17&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ROLLBACK</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"multiple-tests-with-same-data\" style=\"position:relative;\"><a href=\"#multiple-tests-with-same-data\" aria-label=\"multiple tests with same data permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Multiple Tests with Same Data</h2>\n<p class=\"markdown-para\">Good, so creating the data in the <code>it</code> block solves this problem. But what if there are other tests in the same test file and <code>describe</code> block that also need this data?</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"repeat-data-creation\" style=\"position:relative;\"><a href=\"#repeat-data-creation\" aria-label=\"repeat data creation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Repeat Data Creation</h3>\n<p class=\"markdown-para\">One way to solve for this would be to repeat the test data creation in each test that needs it. Since transactional fixtures are enabled, the database inserts will be rolled back at the end of each example so each test will get a clean start. I've also added some temporary logging statements at the beginning of each test, which will help in identifying each run in the <code>log/test.log</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe </span><span class=\"mtk6\">&quot;my test class&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  it </span><span class=\"mtk6\">&quot;some test&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.logger.info(</span><span class=\"mtk6\">&quot;SOME TEST&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;year&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.generate_options(</span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># expects exactly two options: a monthly plan and a yearly plan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  it </span><span class=\"mtk6\">&quot;some other test&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.logger.info(</span><span class=\"mtk6\">&quot;SOME OTHER TEST&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;year&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>log/test.log</code> from this test run confirms a transaction is created and rolled back for each example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SOME TEST</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;month&#39;, &#39;2022-07-27 21:59:17&#39;, &#39;2022-07-27 21:59:17&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;year&#39;, &#39;2022-07-27 21:59:18&#39;, &#39;2022-07-27 21:59:18&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ROLLBACK</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SOME OTHER TEST</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;month&#39;, &#39;2022-07-27 21:59:19&#39;, &#39;2022-07-27 21:59:19&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;year&#39;, &#39;2022-07-27 21:59:20&#39;, &#39;2022-07-27 21:59:20&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ROLLBACK</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"use-describe-and-let\" style=\"position:relative;\"><a href=\"#use-describe-and-let\" aria-label=\"use describe and let permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use Describe and Let</h3>\n<p class=\"markdown-para\">But then I wondered whether use of the <a href=\"https://relishapp.com/rspec/rspec-core/docs/helper-methods/let-and-let\" class=\"markdown-link\">let</a> helper method could also solve for this, to avoid having to repeat the data creation statements in each example. In the test below, the data creation has been moved out of each <code>it</code> block and into the <code>describe</code> block, but using the <code>let!</code> helper method. I'm using the \"bang\" version of it to force execution because these tests need the data to already be there. Otherwise, the regular version <code>let</code> is lazily evaluated:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe </span><span class=\"mtk6\">&quot;my test class&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  let!(</span><span class=\"mtk4\">:monthly_plan</span><span class=\"mtk1\">) { </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  let!(</span><span class=\"mtk4\">:annual_plan</span><span class=\"mtk1\">) { </span><span class=\"mtk9 mtki\">FactoryBot</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">:plan</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;year&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  it </span><span class=\"mtk6\">&quot;some test&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.logger.info(</span><span class=\"mtk6\">&quot;SOME TEST&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.generate_options(</span><span class=\"mtk4\">service_type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># expects exactly two options: a monthly plan and a yearly plan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  it </span><span class=\"mtk6\">&quot;some other test&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.logger.info(</span><span class=\"mtk6\">&quot;SOME OTHER TEST&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This version of the test also passed, even on repeated runs. Taking a look at the <code>log/test.log</code> after this test run, the data creation happens before the logging statements and is repeated for each test, but this time, it does get included in the transaction, even though it occurs in the <code>describe</code> block. This is the effect of using the <code>let!</code> helper:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;month&#39;, &#39;2022-07-27 22:59:17&#39;, &#39;2022-07-27 22:59:17&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;year&#39;, &#39;2022-07-27 22:59:18&#39;, &#39;2022-07-27 22:59:18&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SOME TEST</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ROLLBACK</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;month&#39;, &#39;2022-07-27 22:59:19&#39;, &#39;2022-07-27 22:59:19&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Plan Create INSERT INTO `plans` (`service_type`, `recurring_interval`, `created_at`, `updated_at`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             VALUES (&#39;email&#39;, &#39;year&#39;, &#39;2022-07-27 22:59:20&#39;, &#39;2022-07-27 22:59:20&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RELEASE SAVEPOINT active_record_1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SOME OTHER TEST</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ROLLBACK</span></span></code></pre>\n<p class=\"markdown-para\">The <a href=\"https://relishapp.com/rspec/rspec-core/docs/helper-methods/let-and-let\" class=\"markdown-link\">docs</a> for the <code>let/let!</code> helper methods say:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">The value will be cached across multiple calls in the same example but not across examples.</p>\n</blockquote>\n<p class=\"markdown-para\">Which explains why the inserts are running repeatedly for each test. But what was less clear to me was that using the <code>let/let!</code> helper moves the execution of the logic into the transaction and therefore gets rolled back. Recall when the data creation was run in the <code>describe</code> block without the use of <code>let/let!</code> helper, it ran outside of each test transaction and got committed.</p>\n<h2 class=\"markdown-subtitle\" id=\"which-is-better\" style=\"position:relative;\"><a href=\"#which-is-better\" aria-label=\"which is better permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Which is Better?</h2>\n<p class=\"markdown-para\">So the problem of ensuring created data is rolled back can be solved in two ways. Either specify the data creation right in each example that needs it, i.e. in the <code>it</code> block, OR, if multiple tests need the same data, it can be created up one level in the <code>describe</code>, but then it must use the <code>let/let!</code> helper methods.</p>\n<p class=\"markdown-para\">Given the <a href=\"https://en.wikipedia.org/wiki/Don%27t_repeat_yourself\" class=\"markdown-link\">DRY</a> principle, it's tempting to say the better solution is to move the data creation up into <code>describe</code> block so it doesn't need to be repeated for each test. However, this has no impact on test performance because the data will still be created and rolled back for each example (as we saw earlier in the <code>log/test.log</code> file).</p>\n<p class=\"markdown-para\">Also \"DRYing\" up the tests can make them harder to read as it requires scrolling up to the top of the test file to understand where data, variables etc were defined. For a small test file maybe this isn't a big deal but can become an issue as the number of tests grow.</p>\n<aside class=\"markdown-aside\">\nA full discussion of optimal test design, is outside the scope of this post, but if you're interested in this topic, check out this Stack Overflow discussion on <a class=\"markdown-link\" href=\"https://stackoverflow.com/questions/6453235/what-does-damp-not-dry-mean-when-talking-about-unit-tests\">DAMP vs DRY</a> and an <a class=\"markdown-link\" href=\"https://www.globalapptesting.com/engineering/lets-take-a-closer-look-at-the-tests-created-in-rspec\">RSpec specific take</a> on DRY and let.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered some troubleshooting techniques you can use when RSpec tests are failing due to data not being cleaned up from the test database. Using these techniques, we have discovered that the <code>let/let!</code> helper methods have the effect of including any data created as part of the example's transaction. We also briefly touched on test design as to where data creation should be located.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/when-rspec-doesnt-rollback/"}}}]}},"pageContext":{}},"staticQueryHashes":["163244226"],"slicesMap":{}}