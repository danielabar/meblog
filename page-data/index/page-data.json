{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":71,"edges":[{"node":{"id":"96b087a4-28a9-51a7-ad22-48dc6787757b","frontmatter":{"title":"Efficient Database Queries in Rails: A Practical Approach","date":"March 2024","category":"rails"},"excerpt":"This post will walk through a step-by-step approach to PostgreSQL query enhancement in Rails applications. From indexing strategies toâ€¦","html":"<p class=\"markdown-para\">This post will walk through a step-by-step approach to PostgreSQL query enhancement in Rails applications. From indexing strategies to running migrations without downtime, to efficient column selection, you'll learn some techniques to ensure optimal query performance.</p>\n<h2 class=\"markdown-subtitle\" id=\"getting-started\" style=\"position:relative;\"><a href=\"#getting-started\" aria-label=\"getting started permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Getting Started</h2>\n<p class=\"markdown-para\">To get started quicker with a Rails application, schema design, and data, I've forked the <a href=\"https://github.com/andyatkinson/rideshare\" class=\"markdown-link\">Rideshare Rails application</a> on GitHub. This is used for exercises in the book <em class=\"markdown-emphasis\">High Performance PostgreSQL for Rails</em>. I had the opportunity to provide a technical review for the beta version of this book. Many insights shared in this post are derived from the lessons learned during that review process. If you're interested in the book, it can be <a href=\"https://pragprog.com/titles/aapsql/high-performance-postgresql-for-rails/\" class=\"markdown-link\">purchased here</a>.</p>\n<h2 class=\"markdown-subtitle\" id=\"introducing-rideshare\" style=\"position:relative;\"><a href=\"#introducing-rideshare\" aria-label=\"introducing rideshare permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introducing Rideshare</h2>\n<p class=\"markdown-para\">Rideshare is an API-only Rails application that implements a portion of a fictional rideshare service. Think of Uber or Lyft. The core Rideshare models are Drivers, Riders, Trips, Trip Requests. The database is PostgreSQL. The schema is shown below and was generated with the <a href=\"https://github.com/voormedia/rails-erd\" class=\"markdown-link\">rails-erd</a> gem:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABk0lEQVR42o2Uh27CQAyG8/4PR1ERFaWMEvbKuiQXpqvPkk+FFkSQFcdn//49jugqj38858tZsjyTqq7+nNnz2x5drhc5nU83gg0g9MPxIPPFXCbxRMqqFN94qX2tOm8SeV+rjn9kDkhzaNQRgN1+FwAAJYElh8lsPpPx91iKogh2MCLvvRrWm7UaCGy9tWS5Wmog34UrAts8z7XM4Wgo7XZb46wFCggraCNaQlVKHMeSZamyw44POm9jC7vuR1eBt7utJiU2At16hjPfBOZ5FkpxpQstOJ6OYUjo+EKEhGDoUAyEg812I0maSF7kMp1NZbFcKAPOASABuk33ftoB0EoCYJ/slS0ldTrv2ifnCmUKM2IeSQCELiUBiqRZqmUCQH9gybn5379v9tBKtqZTGsGshjWcNlDFM7AbQLsJBAMMY0ruf/UlSfbau/8YPgSEmU2raRpxzslgOJDVehV6Z1tg/XoKCCPbN1tgJm6tQOyWvARo93I0HuktAbj32dPVseXG52VAu4vGBp0Fplz7I3iF4Q/KHY+rKqpDMQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rideshare erd\"\n        title=\"rideshare erd\"\n        src=\"/static/5504ed1250c163eb70262b0565cd925f/5a190/rideshare-erd.png\"\n        srcset=\"/static/5504ed1250c163eb70262b0565cd925f/772e8/rideshare-erd.png 200w,\n/static/5504ed1250c163eb70262b0565cd925f/e17e5/rideshare-erd.png 400w,\n/static/5504ed1250c163eb70262b0565cd925f/5a190/rideshare-erd.png 800w,\n/static/5504ed1250c163eb70262b0565cd925f/c1b63/rideshare-erd.png 1200w,\n/static/5504ed1250c163eb70262b0565cd925f/71e8d/rideshare-erd.png 1304w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Single Table Inheritance (<a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Inheritance.html\" class=\"markdown-link\">STI</a>) is used to represent both Drivers and Riders in the Users table. This means that rows where <code>users.type = 'Driver'</code> are Drivers, and can be joined to Trips on <code>driver_id</code>. Rows where <code>users.type = 'Rider'</code> are Riders, and can be joined to TripRequests on <code>rider_id</code>.</p>\n<p class=\"markdown-para\">Here are the corresponding model classes, only focusing on the associations between them:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">User</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:trip_request</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:driver</span><span class=\"mtk1\">, </span><span class=\"mtk4\">class_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;User&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:trip_positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  delegate </span><span class=\"mtk4\">:rider</span><span class=\"mtk1\">, </span><span class=\"mtk4\">to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:trip_request</span><span class=\"mtk1\">, </span><span class=\"mtk4\">allow_nil:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Location</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">TripRequest</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:rider</span><span class=\"mtk1\">, </span><span class=\"mtk4\">class_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;User&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:start_location</span><span class=\"mtk1\">, </span><span class=\"mtk4\">class_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Location&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:end_location</span><span class=\"mtk1\">, </span><span class=\"mtk4\">class_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Location&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_one </span><span class=\"mtk4\">:trip</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Generating Data</strong></p>\n<p class=\"markdown-para\">Rideshare comes with a task to generate sample data <code>bin/rails data_generators:generate_all</code>. I've modified it to generate 1000 Drivers and Riders, and 50,000 Trips and Trip Requests. I've also modified it to generate random variability in the <code>trips.completed_at</code> date from anywhere between 1 and 90 days ago. The data generator can be re-run at any time, but first run the truncate task <code>bin/rails db:truncate_all</code> to quickly remove all data.</p>\n<p class=\"markdown-para\">While generating fake data for testing purposes can provide a valuable simulation of a sizeable database, seeded data tends to be very efficiently laid out, sequentially. This results in an unrealistically high number of rows in fewer pages. When the data is packed so efficiently, performance can be good for sequential scans. An equivalent range of data that grew and churned organically in production over time via <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code>, statements will result in a more dispersed distribution of data across pages.</p>\n<p class=\"markdown-para\">Therefore, when addressing a specific performance issues encountered in a production database, it might be necessary to replicate the environment in a test setup, by copying relevant portions of production data to a separate testing environment. This may also require anonymizing sensitive data during the copy process. The <a class=\"markdown-link\" href=\"((https://pragprog.com/titles/aapsql/high-performance-postgresql-for-rails/))\">High Performance PostgreSQL for Rails</a> book goes through this exercise with an example <code>users</code> table.</p>\n<p class=\"markdown-para\">However, for the purpose of this blog post, we'll be focused on optimizing a query to meet a new business requirement, so we don't need to worry about the complexities of a live environment.</p>\n<h2 class=\"markdown-subtitle\" id=\"building-an-admin-report\" style=\"position:relative;\"><a href=\"#building-an-admin-report\" aria-label=\"building an admin report permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Building an Admin Report</h2>\n<p class=\"markdown-para\">We have a business requirement to create a dashboard type view for the admin team that manages Rideshare. They would like to have a view that shows recently completed trips. Each trip should display:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Trip completed date</li>\n<li class=\"markdown-list-item\">Rating given by the rider</li>\n<li class=\"markdown-list-item\">Driver that provided the trip</li>\n<li class=\"markdown-list-item\">Rider that took the trip</li>\n<li class=\"markdown-list-item\">Location where the trip started</li>\n</ul>\n<p class=\"markdown-para\">Being an API-only application, we will only focus on the query part of this logic, and assume a separate front end application will take care of rendering the report.</p>\n<h2 class=\"markdown-subtitle\" id=\"first-attempt\" style=\"position:relative;\"><a href=\"#first-attempt\" aria-label=\"first attempt permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First Attempt</h2>\n<p class=\"markdown-para\">Before getting into the complexity of joins to get all the data, let's first focus on the main requirement, which is to show recently completed trips. We can use the <code>completed_at</code> timestamp column on the <code>Trip</code> model in a scope as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:recently_completed</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;completed_at &gt;= ?&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">.</span><span class=\"mtk5\">week</span><span class=\"mtk1\">.</span><span class=\"mtk5\">ago</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's try this out in a Rails console <code>bin/rails c</code></p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Trip</span><span class=\"mtk1\">.</span><span class=\"mtk5\">recently_completed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SELECT &quot;trips&quot;.&quot;id&quot;, &quot;trips&quot;.&quot;trip_request_id&quot;, &quot;trips&quot;.&quot;driver_id&quot;, &quot;trips&quot;.&quot;completed_at&quot;, &quot;trips&quot;.&quot;rating&quot;, &quot;trips&quot;.&quot;created_at&quot;, &quot;trips&quot;.&quot;updated_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># FROM &quot;trips&quot; WHERE (completed_at &gt;= &#39;2024-01-10 12:29:18.260820&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 559</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># {&quot;id&quot;=&gt;6011,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;trip_request_id&quot;=&gt;6031,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;driver_id&quot;=&gt;61038,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;completed_at&quot;=&gt;Wed, 10 Jan 2024 07:12:42.960652000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;rating&quot;=&gt;nil,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;created_at&quot;=&gt;Wed, 10 Jan 2024 02:12:42.960652000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  &quot;updated_at&quot;=&gt;Wed, 10 Jan 2024 07:12:42.960652000 CST -06:00}</span></span></span></code></pre>\n<p class=\"markdown-para\">In development mode, the console output displays the SQL query that ActiveRecord generated when the scope was executed. To understand the efficiency of this query, we need to view the query execution plan. To do this, launch a database console with <code>bin/rails dbconsole</code> and then enter the SQL query that was generated by ActiveRecord, preceded by the <code>EXPLAIN (ANALYZE)</code> command at the psql prompt:</p>\n<aside class=\"markdown-aside\">\n`bin/rails dbconsole` uses the database connection information specified in `config/database.yml` to make a connection to the database your project is using. Since this project uses PostgreSQL, it's equivalent to running `psql postgresql://role:password@host:port/database_name`. If `password` isn't specified in the database url, then Postgres will prompt for it or you can save the password in `~/.pgpass`. For even less typing, the alias `bin/rails db` can be used.\n</aside>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;trip_request_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;driver_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;completed_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;rating&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;created_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;updated_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (completed_at </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 12:29:18.260820&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">--                               QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-- ------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Seq Scan on trips  (cost=0.00..1106.00 rows=3521 width=48) (actual time=0.013..11.413 rows=3863 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Filter: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Rows Removed by Filter: 46137</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Planning Time: 1.193 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Execution Time: 11.880 ms</span></span></code></pre>\n<p class=\"markdown-para\">In PostgreSQL, the <code>EXPLAIN</code> statement is used to analyze and show the execution plan of a SQL query. It shows how the database engine is planning to execute the query, such as which indexes will be used and estimated costs. The cost is a unit-less value representing the estimated computational effort required for the operation. Lower values are generally better.</p>\n<p class=\"markdown-para\">While <code>EXPLAIN</code> can be run on its own, its typically used together with the <code>ANALYZE</code> option. This option tells PostgreSQL to actually execute the query, so the output will include statistics such as the number of rows processed, and execution time.</p>\n<p class=\"markdown-para\">From the output above we can see that a sequential scan was performed to retrieve rows from the <code>trips</code> table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Seq Scan on trips  (cost=0.00..1106.00 rows=3521 width=48) (actual time=0.013..11.413 rows=3863 loops=1)</span></span></code></pre>\n<p class=\"markdown-para\">It also shows that the query took nearly 12 ms to execute, which is relatively slow for such a simple query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 11.880 ms</span></span></code></pre>\n<p class=\"markdown-para\">A sequential scan means that PostgreSQL reads the entire table, and <em class=\"markdown-emphasis\">then</em> filters the rows out that match the query conditions. The number of rows removed by filtering are shown in the execution plan:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Filter: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Rows Removed by Filter: 46137</span></span></code></pre>\n<aside class=\"markdown-aside\">\nThere's more nuance here in that this particular query doesn't have a `LIMIT` clause. When that's present, PostgreSQL will \"short circuit\" and stop processing when it finds enough matches. See this post that digs deeper into <a class=\"markdown-link\" href=\"https://andyatkinson.com/blog/2024/01/25/PostgreSQL-rows-removed-by-filter-meaning\">Rows Removed By Filter</a>.\n</aside>\n<p class=\"markdown-para\">To understand why a slow sequential scan is being used to filter <code>trips</code> rows based on <code>completed_at</code>, we can take a look at the <code>trips</code> table schema. Still in the database console, the <code>\\d table_name</code> meta-command can be used to display any table schema:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=&gt; \\d trips</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                           Table &quot;rideshare.trips&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     Column      |              Type              | Collation | Nullable |              Default</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-----------------+--------------------------------+-----------+----------+-----------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> id              | bigint                         |           | not null | nextval(&#39;trips_id_seq&#39;::regclass)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> trip_request_id | bigint                         |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> driver_id       | integer                        |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> completed_at    | timestamp without time zone    |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> rating          | integer                        |           |          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> created_at      | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> updated_at      | timestamp(6) without time zone |           | not null |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;trips_pkey&quot; PRIMARY KEY, btree (id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_trips_on_driver_id&quot; btree (driver_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_trips_on_rating&quot; btree (rating)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;index_trips_on_trip_request_id&quot; btree (trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Check constraints:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;chk_rails_4743ddc2d2&quot; CHECK (completed_at &gt; created_at) NOT VALID</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;rating_check&quot; CHECK (rating &gt;= 1 AND rating &lt;= 5)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Foreign-key constraints:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;fk_rails_6d92acb430&quot; FOREIGN KEY (trip_request_id) REFERENCES trip_requests(id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;fk_rails_e7560abc33&quot; FOREIGN KEY (driver_id) REFERENCES users(id)</span></span></code></pre>\n<p class=\"markdown-para\">The <code>Indexes</code> section of the output above lists all the indexes that are available on the <code>trips</code> table. Notice there is no index on <code>completed_at</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;trips_pkey&quot; PRIMARY KEY, btree (id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;index_trips_on_driver_id&quot; btree (driver_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;index_trips_on_rating&quot; btree (rating)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;index_trips_on_trip_request_id&quot; btree (trip_request_id)</span></span></code></pre>\n<p class=\"markdown-para\">While the existing query may be sufficient for the current scale, this operation will become progressively slower as the number of trips increases. This means that the overall efficiency and performance of the application may be negatively impacted over time.</p>\n<p class=\"markdown-para\">Improving the scalability of the application involves optimizing queries to be less resource-intensive, and adding an index to the <code>completed_at</code> column, is a step towards achieving this goal. Scaling, in this context, refers to the ability of the database system to handle a growing workload efficiently. By addressing the performance bottlenecks, such as slow sequential scans, the application can better leverage the capabilities of the PostgreSQL instance as the workload increases.</p>\n<p class=\"markdown-para\">So the next step in improving this query is to add an index, which can help with accessing the data at a lower cost.</p>\n<h2 class=\"markdown-subtitle\" id=\"second-attempt-add-index\" style=\"position:relative;\"><a href=\"#second-attempt-add-index\" aria-label=\"second attempt add index permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Second Attempt: Add Index</h2>\n<p class=\"markdown-para\">To add an index to an existing table in a Rails application, start by generating a database migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate migration AddIndexToTripsCompletedAt</span></span></span></code></pre>\n<p class=\"markdown-para\">Fill in the <code>change</code> method, specifying what table the index should be added to, and on what column:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20240111132403_add_index_to_trips_completed_at.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddIndexToTripsCompletedAt</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_index </span><span class=\"mtk4\">:trips</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:completed_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Run the migration with <code>bin/rails db:migrate</code>. However, in the Rideshare application, the migration is not applied due to the following error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Migrating to AddIndexToTripsCompletedAt (20240111132403)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">== 20240111132403 AddIndexToTripsCompletedAt: migrating =======================</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.7ms)  BEGIN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   (1.6ms)  SHOW server_version_num</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   (0.7ms)  SET statement_timeout TO 3600000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   (0.7ms)  SET lock_timeout TO 10000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.7ms)  ROLLBACK</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   (0.8ms)  SELECT pg_advisory_unlock(5537362570877065845)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails aborted!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">StandardError: An error has occurred, this and all later migrations canceled: (StandardError)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== Dangerous operation detected #strong_migrations ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Adding an index non-concurrently blocks writes. Instead, use:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">class AddIndexToTripsCompletedAt &lt; ActiveRecord::Migration[7.1]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  disable_ddl_transaction!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  def change</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    add_index :trips, :completed_at, algorithm: :concurrently</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  end</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">end</span></span></code></pre>\n<p class=\"markdown-para\">This error is coming from the <a href=\"https://github.com/ankane/strong_migrations\" class=\"markdown-link\">Strong Migrations</a> gem that is included in Rideshare. This gem prevents \"dangerous\" migrations from being added to the project.</p>\n<p class=\"markdown-para\">What makes this particular migration risky is that adding an index will lock the table that it's being added to, which means the application won't be able to read or write from/to the <code>trips</code> table while this migration is in progress. Since adding an index can take a long time on large tables, this will result in application errors.</p>\n<p class=\"markdown-para\">Since access to the <code>trips</code> table is critical to the functioning of the application, we can avoid potential downtime, by following the advice generated by the <a href=\"https://github.com/ankane/strong_migrations\" class=\"markdown-link\">Strong Migrations</a> gem. Notice the error message included how the migration should be written. Here is the corrected version:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddIndexToTripsCompletedAt</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  disable_ddl_transaction!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_index </span><span class=\"mtk4\">:trips</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:completed_at</span><span class=\"mtk1\">, </span><span class=\"mtk4\">algorithm:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:concurrently</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Specifying <code>algorithm: :concurrently</code> tells PostgreSQL to add the index without locking the table. This means the <code>trips</code> table can continue to be queried while the index is being added, which keeps the application responsive. The trade-off with <code>:concurrently</code> is that it makes the operation take about twice as long.</p>\n<p class=\"markdown-para\"><code>disable_ddl_transaction!</code> disables the transaction for DDL (Data Definition Language) statements, because the concurrent approach can't be executed inside a transaction.</p>\n<p class=\"markdown-para\">With this change in place, <code>bin/rails db:migrate</code> completes successfully and the index is now added.</p>\n<aside class=\"markdown-aside\">\nFor a small and less busy table, creating the index in the standard way (i.e., without using `:concurrently`) may be fine. The `strong_migrations` gem issues warnings for potentially risky database operations, prompting developers to assess the situation and decide whether additional precautions, like `:concurrently`, are necessary.\n</aside>\n<p class=\"markdown-para\">Now we can, once again, examine the execution plan for the completed trips query after adding the index:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;trip_request_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;driver_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;completed_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;rating&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;created_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  , </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;updated_at&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (completed_at </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 12:29:18.260820&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                                            QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-------------------------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Bitmap Heap Scan on trips  (cost=67.58..592.59 rows=3521 width=48) (actual time=0.724..3.849 rows=3863 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Recheck Cond: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Heap Blocks: exact=481</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..66.70 rows=3521 width=0) (actual time=0.603..0.604 --rows=3863 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          Index Cond: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Planning Time: 0.242 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Execution Time: 4.229 ms</span></span></code></pre>\n<p class=\"markdown-para\">This time the query planner is using the index on <code>completed_at</code> instead of a sequential scan. This is shown with the <code>Bitmap Index Scan</code> which indicates that the <code>index_trips_on_completed_at</code> index is being used:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-&gt;  Bitmap Index Scan on index_trips_on_completed_at...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Index Cond: (completed_at &gt;= &#39;2024-01-04 12:20:54.270716&#39;::timestamp without time zone)</span></span></code></pre>\n<p class=\"markdown-para\">And the overall time to complete this query is just over 4ms, a significant improvement over the previous ~12ms when using a sequential scan:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 4.229 ms</span></span></code></pre>\n<p class=\"markdown-para\">This is because the index allows PostgreSQL to quickly locate and retrieve the relevant rows. Specifically, the index supports a faster filtering operation based on the query conditions. Note that since this isn't an <a href=\"https://www.postgresql.org/docs/current/indexes-index-only-scans.html\" class=\"markdown-link\">index-only scan</a>, a <code>Bitmap Heap Scan</code> was still required to access data from the table, which is shown in the first line of the query plan:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Bitmap Heap Scan on trips  (cost=67.58..592.59 rows=3521 width=48) (actual time=0.724..3.849 rows=3863 loops=1)</span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe query plan output can list many different operations, only a small number of which are covered in this post. PgMustard, a paid tool that helps to review query plans hosts a very useful <a class=\"markdown-link\" href=\"https://www.pgmustard.com/docs/explain\">EXPLAIN Glossary</a> with definitions of many of the terms shown in PostgreSQL plans.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"third-attempt-joins\" style=\"position:relative;\"><a href=\"#third-attempt-joins\" aria-label=\"third attempt joins permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Third Attempt: Joins</h2>\n<p class=\"markdown-para\">Now that use of <code>completed_at</code> is optimized, we can continue development of the admin dashboard query. Recall we also need to show driver and rider information, as well as the trip location. To do this, we'll use the ActiveRecord <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-joins\" class=\"markdown-link\">joins</a> method.</p>\n<p class=\"markdown-para\">To get location information, the Trip model must be joined to <code>trip_request</code>, which must then be joined to <code>start_location</code> via a nested join.</p>\n<p class=\"markdown-para\">Getting rider and driver information requires joining the <code>users</code> table twice, once for Riders (which are joined on <code>trip_request.rider_id</code>), and another time for Drivers (which are joined on <code>trips.driver_id</code>), due to use of Single Table Inheritance that models Drivers and Riders with the same underlying <code>users</code> table. This requires the use of a string join rather than just specifying the model.</p>\n<p class=\"markdown-para\">The same <code>where</code> clause as before is used to filter on recent trips.</p>\n<p class=\"markdown-para\">By default, the result of the ActiveRecord <code>joins</code> method will only select the columns from the model class on which its invoked, <code>Trip</code> in this case. But since the report needs to also show Driver, Rider, and Location information, this scope adds a <code>SELECT</code> clause to get all fields from all tables using the ActiveRecord <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-select\" class=\"markdown-link\">select</a> method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:recently_completed</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk4\">trip_request:</span><span class=\"mtk1\"> [</span><span class=\"mtk4\">:start_location</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;INNER JOIN users AS riders ON riders.id = trip_requests.rider_id&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;INNER JOIN users AS drivers ON drivers.id = trips.driver_id&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.completed_at &gt; ?&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">.</span><span class=\"mtk5\">week</span><span class=\"mtk1\">.</span><span class=\"mtk5\">ago</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.*, locations.*, drivers.*, riders.*&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is what it looks like in a Rails console. Note that even though <code>results</code> is a relation of Trip models, each instance contains attributes from trips, locations, and users tables. However, since both drivers and riders are actually from the same <code>users</code> table, the last one pulled in (<code>riders</code> in this case) \"wins\" and so the result only has the rider attributes. This is due to the order in which the attributes are selected in the SQL query and will be addressed in the next section.</p>\n<p class=\"markdown-para\">I've added <code>===</code> comments to highlight which model each set of attributes comes from:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Trip</span><span class=\"mtk1\">.</span><span class=\"mtk5\">recently_completed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Trip Load (2.5ms)  SELECT trips.*, locations.*, drivers.*, riders.*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># FROM &quot;trips&quot; INNER JOIN &quot;trip_requests&quot; ON &quot;trip_requests&quot;.&quot;id&quot; = &quot;trips&quot;.&quot;trip_request_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># INNER JOIN &quot;locations&quot; ON &quot;locations&quot;.&quot;id&quot; = &quot;trip_requests&quot;.&quot;start_location_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># INNER JOIN users AS riders ON riders.id = trip_requests.rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># INNER JOIN users AS drivers ON drivers.id = trips.driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># WHERE (trips.completed_at &gt; &#39;2024-01-10 12:20:01.192132&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 559</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   === TRIP ATTRIBUTES ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;id&quot;=&gt;61943,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;trip_request_id&quot;=&gt;56017,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;driver_id&quot;=&gt;60456,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;completed_at&quot;=&gt;Wed, 10 Jan 2024 07:21:26.462838000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rating&quot;=&gt;5,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   === LOCATION ATTRIBUTES ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;address&quot;=&gt;&quot;New York, NY&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;city&quot;=&gt;nil,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;state&quot;=&gt;&quot;NY&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;position&quot;=&gt;#&lt;struct ActiveRecord::Point x=40.7143528, y=-74.0059731&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   === USER AS RIDER ATTRIBUTES ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;first_name&quot;=&gt;&quot;Shantelle&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;last_name&quot;=&gt;&quot;Kris&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;email&quot;=&gt;&quot;Shantelle-Kris-522@email.com&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;type&quot;=&gt;&quot;Rider&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;password_digest&quot;=&gt;&quot;$2a$12...&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;trips_count&quot;=&gt;nil,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;drivers_license_number&quot;=&gt;nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># }</span></span></span></code></pre>\n<p class=\"markdown-para\">Now this query can be analyzed in a database console session <code>bin/rails dbconsole</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    trips.</span><span class=\"mtk7\">*</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    locations.</span><span class=\"mtk7\">*</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    drivers.</span><span class=\"mtk7\">*</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    riders.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trip_requests&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trip_requests&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trips&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;trip_request_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;locations&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;locations&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;trip_requests&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;start_location_id&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> riders </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> drivers </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 12:05:39.639423&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                       QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Hash Join  (cost=1399.44..2692.88 rows=524 width=453) (actual time=11.736..24.510 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Hash Cond: (trips.driver_id = drivers.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Nested Loop  (cost=529.22..1821.28 rows=524 width=294) (actual time=1.109..13.507 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Hash Join  (cost=528.93..1643.10 rows=524 width=139) (actual time=1.085..12.227 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                Hash Cond: (trip_requests.start_location_id = locations.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                -&gt;  Hash Join  (cost=527.89..1637.76 rows=524 width=56) (actual time=1.054..11.992 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      Hash Cond: (trip_requests.id = trips.trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Seq Scan on trip_requests  (cost=0.00..917.10 rows=50010 width=16) (actual time=0.004..4.868 rows=50010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Hash  (cost=521.34..521.34 rows=524 width=48) (actual time=1.028..1.032 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                            Buckets: 1024  Batches: 1  Memory Usage: 53kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                            -&gt;  Bitmap Heap Scan on trips  (cost=12.35..521.34 rows=524 width=48) (actual time=0.116..0.896 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  Recheck Cond: (completed_at &gt; &#39;2024-01-10 12:05:39.639423&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  Heap Blocks: exact=328</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..12.22 rows=524 width=0) (actual time=0.060..0.060 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                        Index Cond: (completed_at &gt; &#39;2024-01-10 12:05:39.639423&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                -&gt;  Hash  (cost=1.02..1.02 rows=2 width=87) (actual time=0.019..0.021 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      Buckets: 1024  Batches: 1  Memory Usage: 9kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Seq Scan on locations  (cost=0.00..1.02 rows=2 width=87) (actual time=0.011..0.013 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Index Scan using users_pkey on users riders  (cost=0.29..0.34 rows=1 width=159) (actual time=0.002..0.002 rows=1 loops=559)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                Index Cond: (id = trip_requests.rider_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Hash  (cost=595.10..595.10 rows=22010 width=159) (actual time=10.601..10.601 rows=22010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          Buckets: 32768  Batches: 1  Memory Usage: 3221kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Seq Scan on users drivers  (cost=0.00..595.10 rows=22010 width=159) (actual time=0.021..4.849 rows=22010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Planning Time: 1.046 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Execution Time: 24.936 ms</span></span></code></pre>\n<p class=\"markdown-para\">The SQL explain plan above shows this is a more complex query than the previous attempts. It includes many more operations than can be covered in this post, so we'll only be focusing on the join operations.</p>\n<p class=\"markdown-para\">Execution time has gone up, even though the query is still using the index on <code>trips.completed_at</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 24.936 ms</span></span></code></pre>\n<p class=\"markdown-para\">This is in part due to the multiple joins. Joins between tables are expressed in the plan as a combination of a <code>Hash</code> node, a <code>Hash Join</code> which implements the join details, and a <code>Hash Cond</code>, which shows the conditions that were used to perform the join, using the <code>Hash</code> node.</p>\n<p class=\"markdown-para\">For example, the join from the <code>trips</code> table to the <code>trip_requests</code> table is shown in the plan as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-&gt;  Hash Join  (cost=527.89..1637.76 rows=524 width=56) (actual time=1.054..11.992 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Hash Cond: (trip_requests.id = trips.trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      -&gt;  Hash  (cost=521.34..521.34 rows=524 width=48) (actual time=1.028..1.032 rows=559 loops=1)</span></span></code></pre>\n<p class=\"markdown-para\">Here's a definition of the Hash Join operation from the <a href=\"https://www.pgmustard.com/docs/explain/hash-join\" class=\"markdown-link\">pgMustard glossary</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">An implementation of join in which one of the collections of rows to be joined is hashed on the join keys using a separate 'Hash' node. PostgreSQL then iterates over the other collection of rows, for each one looking it up in the hash table to see if there are any rows it should be joined to.</p>\n</blockquote>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">CAUTION:</strong> When using joins, there should be an index on each foreign key column. In the example above, these are: <code>trips.trip_request_id</code>, <code>trip_requests.start_location_id</code>, <code>trip_requests.rider_id</code>, and <code>trips.driver_id</code>. If you used <code>references</code> when generating the migration with Rails, or specified <code>t.references :some_model, foreign_key: true</code> in the Rails migration file, then Rails (as of 5.2) will automatically generate an index on that column in addition to the foreign key constraint. In the Rideshare schema, all foreign keys are indexed.</p>\n<p class=\"markdown-para\">This version of the query is also fetching more data due to the <code>SELECT</code> clause specifying all columns on all tables in the joins:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">.</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.*, locations.*, drivers.*, riders.*&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">Another way to improve performance is to reduce the \"width\" of the results.</p>\n<h2 class=\"markdown-subtitle\" id=\"fourth-attempt-reduce-columns\" style=\"position:relative;\"><a href=\"#fourth-attempt-reduce-columns\" aria-label=\"fourth attempt reduce columns permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fourth Attempt: Reduce Columns</h2>\n<p class=\"markdown-para\">The previous query selected all columns from all of the joined tables. For example, each result was including user details such as password digest and drivers license number. But recall the business requirements were that we only need to display a subset of user and trip information.</p>\n<p class=\"markdown-para\">Let's \"narrow\" the amount of data by restricting the columns in the <code>SELECT</code> clause to only what we need. This also supports string concatenation to distinguish between driver and rider names:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:recently_completed</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk4\">trip_request:</span><span class=\"mtk1\"> [</span><span class=\"mtk4\">:start_location</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;INNER JOIN users AS riders ON riders.id = trip_requests.rider_id&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;INNER JOIN users AS drivers ON drivers.id = trips.driver_id&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;trips.completed_at &gt; ?&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">.</span><span class=\"mtk5\">week</span><span class=\"mtk1\">.</span><span class=\"mtk5\">ago</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.completed_at, trips.rating, locations.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">               CONCAT(drivers.first_name, &#39; &#39;, drivers.last_name) driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">               CONCAT(riders.first_name, &#39; &#39;, riders.last_name) rider_name&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nAs of Rails 7.1, the `select` method can <a class=\"markdown-link\" href=\"https://blog.kiprosh.com/rails-7-1-allows-activerecord-querymethods-select-and-reselect-to-receive-hash-values/\">accept a hash of columns and aliases</a> rather than raw SQL when specifying columns from the join tables. However, if the `select` uses SQL functions as in this case where concatenation is used to generate the driver and rider names, then raw SQL is still required.\n</aside>\n<p class=\"markdown-para\">Running this query in the Rails console shows the attributes contain exactly what's needed to display in the view, with no extraneous data.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Trip</span><span class=\"mtk1\">.</span><span class=\"mtk5\">recently_completed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;completed_at&quot; =&gt; Wed, 10 Jan 2024 07:12:42.960652000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rating&quot; =&gt; nil,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;address&quot; =&gt; &quot;New York, NY&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;driver_name&quot; =&gt; &quot;Rasheeda Brakus&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rider_name&quot; =&gt; &quot;Corina Gorczany&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;id&quot; =&gt; nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># }</span></span></span></code></pre>\n<p class=\"markdown-para\">Again we can view the query execution plan:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">CONCAT</span><span class=\"mtk1\">(</span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\">) driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">CONCAT</span><span class=\"mtk1\">(</span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\">) rider_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> trips</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> trip_requests </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">trip_request_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> locations </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">start_location_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> riders </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> drivers </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 12:27:19.062944&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                         QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Hash Join  (cost=1398.27..2693.98 rows=516 width=88) (actual time=8.572..20.188 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    Hash Cond: (trips.driver_id = drivers.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Nested Loop  (cost=528.05..1817.24 rows=516 width=41) (actual time=1.246..12.363 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Hash Join  (cost=527.76..1641.78 rows=516 width=32) (actual time=1.224..11.156 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                Hash Cond: (trip_requests.start_location_id = locations.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                -&gt;  Hash Join  (cost=526.71..1636.51 rows=516 width=24) (actual time=1.191..10.985 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      Hash Cond: (trip_requests.id = trips.trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Seq Scan on trip_requests  (cost=0.00..917.10 rows=50010 width=16) (actual time=0.005..4.199 rows=50010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Hash  (cost=520.26..520.26 rows=516 width=24) (actual time=1.167..1.174 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                            Buckets: 1024  Batches: 1  Memory Usage: 38kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                            -&gt;  Bitmap Heap Scan on trips  (cost=12.29..520.26 rows=516 width=24) (actual time=0.138..1.060 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  Recheck Cond: (completed_at &gt; &#39;2024-01-10 12:27:19.062944&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  Heap Blocks: exact=328</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                  -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..12.16 rows=516 width=0) (actual time=0.081..0.081 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                                        Index Cond: (completed_at &gt; &#39;2024-01-10 12:27:19.062944&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                -&gt;  Hash  (cost=1.02..1.02 rows=2 width=20) (actual time=0.020..0.021 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      Buckets: 1024  Batches: 1  Memory Usage: 9kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                      -&gt;  Seq Scan on locations  (cost=0.00..1.02 rows=2 width=20) (actual time=0.012..0.013 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Index Scan using users_pkey on users riders  (cost=0.29..0.34 rows=1 width=21) (actual time=0.002..0.002 rows=1 loops=559)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--                Index Cond: (id = trip_requests.rider_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--    -&gt;  Hash  (cost=595.10..595.10 rows=22010 width=21) (actual time=7.296..7.296 rows=22010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          Buckets: 32768  Batches: 1  Memory Usage: 1492kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--          -&gt;  Seq Scan on users drivers  (cost=0.00..595.10 rows=22010 width=21) (actual time=0.007..3.716 rows=22010 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Planning Time: 1.649 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--  Execution Time: 20.553 ms</span></span></code></pre>\n<p class=\"markdown-para\">This time the performance is slightly improved:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 20.553 ms</span></span></code></pre>\n<p class=\"markdown-para\">It still needs to perform all the joins, but less overall data is being fetched from the database. This can be observed by the smaller <code>width</code> attribute in the <code>Hash Join</code> operations. The <code>width</code> refers to the total number of bytes required to store the output of the join operation, and is proportional to the number of columns in the <code>SELECT</code> clause.</p>\n<p class=\"markdown-para\">For example, focusing on the top level Hash Join operation, this query has a width of 88:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Hash Join  (cost=1398.27..2693.98 rows=516 width=88) (actual time=8.572..20.188 rows=559 loops=1)</span></span></code></pre>\n<p class=\"markdown-para\">Whereas the <a href=\"../rails-query-perf#third-attempt-joins\" class=\"markdown-link\">previous version of the query</a> where all columns from all tables were being retrieved shows an overall width of 453:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Hash Join  (cost=1399.44..2692.88 rows=524 width=453) (actual time=11.736..24.510 rows=559 loops=1)</span></span></code></pre>\n<p class=\"markdown-para\">Selecting only the necessary columns can lead to performance improvements including reduced disk I/O and smaller memory requirements.</p>\n<h2 class=\"markdown-subtitle\" id=\"fifth-attempt-reduce-rows\" style=\"position:relative;\"><a href=\"#fifth-attempt-reduce-rows\" aria-label=\"fifth attempt reduce rows permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fifth Attempt: Reduce Rows</h2>\n<p class=\"markdown-para\">Another way to improve performance is to reduce the total number of rows returned by the query with additional filters (i.e. SQL <code>WHERE</code> clauses). This could require some discussion between engineering and product teams to make sure everyone understands the business problem that is being solved.</p>\n<p class=\"markdown-para\">In this case, it turns out the Rideshare admins want to focus only on recent trips with <em class=\"markdown-emphasis\">low ratings</em>, so they can investigate what happened on some of those trips to improve customer experience. They've defined a \"low\" rating as 3 or fewer stars, based on a 5 star rating system. Up until now, they've been sorting the results client side by rating, and investigating those.</p>\n<p class=\"markdown-para\">Given this better understanding of the requirements, another <code>WHERE</code> condition can be added to the scope, to only retrieve trips where the rating is less than or equal to 3.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">CAUTION:</strong> When adding further <code>WHERE</code> clauses to reduce the amount of data being returned, always check whether there's an index on the column you're planning to filter by. Otherwise, you could inadvertently make performance worse while trying to improve it! In this case, there already is an index on <code>trips.rating</code>. We saw this <a href=\"../rails-query-perf#first-attempt\" class=\"markdown-link\">earlier</a> when inspecting the table schema with <code>\\d trips</code> in the database console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=&gt; \\d trips</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Indexes:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;index_trips_on_rating&quot; btree (rating)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ...</span></span></code></pre>\n<p class=\"markdown-para\">Here is the modified scope adding an additional <code>WHERE</code> clause on <code>trip.rating</code> to only retrieve low ratings</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Trip</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:recently_completed</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk4\">trip_request:</span><span class=\"mtk1\"> [</span><span class=\"mtk4\">:start_location</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;INNER JOIN users AS riders ON riders.id = trip_requests.rider_id&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">joins</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;INNER JOIN users AS drivers ON drivers.id = trips.driver_id&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;trips.completed_at &gt; ?&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">.</span><span class=\"mtk5\">week</span><span class=\"mtk1\">.</span><span class=\"mtk5\">ago</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;trips.rating &lt;= ?&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;trips.completed_at, trips.rating, locations.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        CONCAT(drivers.first_name, &#39; &#39;, drivers.last_name) driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        CONCAT(riders.first_name, &#39; &#39;, riders.last_name) rider_name&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This time, the results are \"shaped\" the same as before because the <code>SELECT</code> columns are the same, but the total number of results is smaller. This also ensures the query only returns trips with ratings, as before, we were also getting results with <code>nil</code> ratings, i.e. where the customer didn't leave to leave a rating.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Trip</span><span class=\"mtk1\">.</span><span class=\"mtk5\">recently_completed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 78</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">results.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;completed_at&quot;=&gt;Mon, 22 Jan 2024 07:07:11.312416000 CST -06:00,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rating&quot;=&gt;2,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;address&quot;=&gt;&quot;New York, NY&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;driver_name&quot;=&gt;&quot;Bobbi Cronin&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;rider_name&quot;=&gt;&quot;Anibal Hammes&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &quot;id&quot;=&gt;nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># }</span></span></span></code></pre>\n<p class=\"markdown-para\">Explain/analyze the query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE) </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> rider_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> trips</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> trip_requests </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">trip_request_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> locations </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">start_location_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> riders </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> drivers </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 13:08:58.257990&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">AND</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                                QUERY PLAN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Nested Loop  (cost=97.88..1340.17 rows=75 width=88) (actual time=0.514..1.937 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   Join Filter: (trip_requests.start_location_id = locations.id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   Rows Removed by Join Filter: 78</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   -&gt;  Seq Scan on locations  (cost=0.00..1.02 rows=2 width=20) (actual time=0.012..0.015 rows=2 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   -&gt;  Materialize  (cost=97.88..1336.34 rows=75 width=42) (actual time=0.247..0.937 rows=78 loops=2)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         -&gt;  Nested Loop  (cost=97.88..1335.96 rows=75 width=42) (actual time=0.488..1.819 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               -&gt;  Nested Loop  (cost=97.59..862.59 rows=75 width=33) (actual time=0.463..1.492 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     -&gt;  Nested Loop  (cost=97.30..837.09 rows=75 width=24) (actual time=0.449..1.240 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                           -&gt;  Bitmap Heap Scan on trips  (cost=97.01..298.02 rows=75 width=24) (actual time=0.436..0.645 rows=78 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                 Recheck Cond: ((completed_at &gt; &#39;2024-01-10 13:08:58.25799&#39;::timestamp without time zone) AND (rating &lt;= 3))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                 Heap Blocks: exact=72</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                 -&gt;  BitmapAnd  (cost=97.01..97.01 rows=75 width=0) (actual time=0.419..0.421 rows=0 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                       -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..12.05 rows=501 width=0) (actual time=0.083..0.083 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                             Index Cond: (completed_at &gt; &#39;2024-01-10 13:08:58.25799&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                       -&gt;  Bitmap Index Scan on index_trips_on_rating  (cost=0.00..84.67 rows=7518 width=0) (actual time=0.314..0.314 rows=7531 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                             Index Cond: (rating &lt;= 3)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                           -&gt;  Index Scan using trip_requests_pkey on trip_requests  (cost=0.29..7.19 rows=1 width=16) (actual time=0.007..0.007 rows=1 loops=78)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                 Index Cond: (id = trips.trip_request_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     -&gt;  Index Scan using users_pkey on users riders  (cost=0.29..0.34 rows=1 width=21) (actual time=0.003..0.003 rows=1 loops=78)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                           Index Cond: (id = trip_requests.rider_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               -&gt;  Memoize  (cost=0.30..6.55 rows=1 width=21) (actual time=0.004..0.004 rows=1 loops=78)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Cache Key: trips.driver_id</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Cache Mode: logical</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     Hits: 8  Misses: 70  Evictions: 0  Overflows: 0  Memory Usage: 9kB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     -&gt;  Index Scan using users_pkey on users drivers  (cost=0.29..6.54 rows=1 width=21) (actual time=0.003..0.003 rows=1 loops=70)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                           Index Cond: (id = trips.driver_id)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Planning Time: 1.168 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Execution Time: 2.360 ms</span></span></code></pre>\n<p class=\"markdown-para\">This time the query execution time is just over 2ms, a significant improvement over the previous ~20ms. This is due to the additional filter condition <code>(rating &#x3C;= 3)</code> that reduces the number of rows that need to be processed in join operations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Execution Time: 2.360 ms</span></span></code></pre>\n<p class=\"markdown-para\">The <a href=\"https://www.pgmustard.com/docs/explain/bitmap-and\" class=\"markdown-link\">BitmapAnd</a> operation shows that both the indexes on <code>completed_at</code> and <code>rating</code> are being used. This operation combines bitmaps generated by Bitmap Index Scans, allowing information from more than one index to be quickly aggregated together.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-&gt;  BitmapAnd  (cost=97.01..97.01 rows=75 width=0) (actual time=0.419..0.421 rows=0 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  -&gt;  Bitmap Index Scan on index_trips_on_completed_at  (cost=0.00..12.05 rows=501 width=0) (actual time=0.083..0.083 rows=559 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Index Cond: (completed_at &gt; &#39;2024-01-10 13:08:58.25799&#39;::timestamp without time zone)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  -&gt;  Bitmap Index Scan on index_trips_on_rating  (cost=0.00..84.67 rows=7518 width=0) (actual time=0.314..0.314 rows=7531 loops=1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Index Cond: (rating &lt;= 3)</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"visualize-query-plan\" style=\"position:relative;\"><a href=\"#visualize-query-plan\" aria-label=\"visualize query plan permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Visualize Query Plan</h2>\n<p class=\"markdown-para\">Understanding query plans can be challenging, especially when dealing with complex queries. However, there's a free web-based tool that can help make sense of them: <a href=\"https://explain.dalibo.com/\" class=\"markdown-link\">explain.dalibo.com</a>. Here's how to use it.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Prepare Your Query</strong>: Start by putting your query into a file. For instance, you can create a directory called <code>queries</code> and save your SQL query in a file within it. In addition to the <code>ANALYZE</code> argument that we've been using, also pass in <code>COSTS, VERBOSE, BUFFERS, FORMAT JSON</code> to <code>EXPLAIN</code> as shown below. This will include additional information in the query plan output, such as the amount of disk data that was fetched, and format the results as JSON:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- queries/recently_completed_trips.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EXPLAIN (ANALYZE, COSTS, </span><span class=\"mtk7\">VERBOSE</span><span class=\"mtk1\">, BUFFERS, </span><span class=\"mtk9\">FORMAT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">JSON</span><span class=\"mtk1\">) </span><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> driver_name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> rider_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> trips</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> trip_requests </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">trip_request_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> locations </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">locations</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">start_location_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> riders </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">riders</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trip_requests</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rider_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">INNER JOIN</span><span class=\"mtk1\"> users </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> drivers </span><span class=\"mtk7\">ON</span><span class=\"mtk1\"> </span><span class=\"mtk4\">drivers</span><span class=\"mtk1\">.</span><span class=\"mtk4\">id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">driver_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">completed_at</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2024-01-10 13:08:58.257990&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">AND</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">trips</span><span class=\"mtk1\">.</span><span class=\"mtk4\">rating</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Run the Query</strong>: Execute the query from your terminal using <a href=\"https://www.postgresql.org/docs/current/app-psql.html\" class=\"markdown-link\">psql</a>, ensuring to redirect the output to a file. The <code>-XqAt</code> flags make the output machine-readable:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">psql -h 127.0.0.1 \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  -p 5432 -U owner \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  -d rideshare_development \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  -XqAt -f queries/recently_completed_trips.sql </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> queries/fifth.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># copy the contents of `queries/recently_completed_trips.json`</span></span></span></code></pre>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Visualize Your Plan</strong>: Visit <a href=\"https://explain.dalibo.com/\" class=\"markdown-link\">explain.dalibo.com</a> and paste the generated plan text and query. Then, hit Submit. The tool will generate a visualization of your query plan. Here's an example of the visualization for the fifth attempt version of the query from this post. It shows the different types of scans that were used and how the data gets combined. The duration of each operation is also shown:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 92%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACMElEQVR42o1Uy27bQAz0//9TD0XRiw89pU5aoBBiy4keq31wX5JqZQpSlWzHDpADsVotd5bkDLkhInxkzrl1ZfPeQ2sDbQymacLbGxBCvPLbfAaMgdgcEYw3sM4hhCCgOafVl23zERC55dtDqQ5KKViroXWDTmsURYGnp194ePiJl5dXeHIwprsGvIxqAaVAqJoK1hKmacSQHch7Obe2hap/w7sX9DnAe/NxhMtqnEZnO9lzmjGmtaazH+FQHuHJIPiLlBcndiCanau6lqKPw4CYe9R1g8OhRN/3SLmH94Ry/wedqkD6GeTUDPieTf72wUv9+PI4juiHHtorYZj/DeOIGByMKuFNhZwjYkrY3NRNimtgnIW1dk2VH7DuvI8hyIPkeQ2S2SqbRRpKa9Rti378C2drAbZ2fqhtWwEYhgEp5RXgnJU7y2YBjNaC2hZRG0wpIsW4ngWJiJBzFhNdXuhv1aFcEAkYFLtH/Pj6DYfdDqlp4LQWEfNlJqRpGsQYEWIWkdM9QH65aRXKY4Xt9ju22y+oWiXp576XaEJMAsz6Y4K4Q/ieuw/ooZoCWhWYThnASdqJa5JiwjCehD36X6uUkkR5TSRdt55zRowdWbjGWJTHV6iug6keYfVMCAMszN+q46KGM2MkztIdWqF6PSCQxhAa5DgPhoXJm75/H+HZ5mHgrQJ1JXSzR/DhZkR9IsLrQ0deUt4fjvAi6ng3mnt2d9rwhOFxxXtmmYn4LOA/TQhe4txZOiIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fifth attempt visualized\"\n        title=\"fifth attempt visualized\"\n        src=\"/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/5a190/fifth-attempt-visualized.png\"\n        srcset=\"/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/772e8/fifth-attempt-visualized.png 200w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/e17e5/fifth-attempt-visualized.png 400w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/5a190/fifth-attempt-visualized.png 800w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/c1b63/fifth-attempt-visualized.png 1200w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/29007/fifth-attempt-visualized.png 1600w,\n/static/ee47fdd0eaa0d3d0fdc19a34eb6440d5/25e83/fifth-attempt-visualized.png 2302w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">You can also click on the down caret icon beside any node to get more details about that operation. For example, focusing on the <code>Bitmap Index Scan</code> for use of the rating index on the <code>trips</code> table:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 634px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIElEQVR42oWTeW/TQBDF8/3/AAHqdwJKm4AQqE3iI06dw3Ziey/fP7STplIBgVfPs3prv5mdY6aVRmuNqhXWOqyxGGOE83tnHdkxI8sy2Rtt5PwPaCMas6ZpqJXi7n7Ox0+fWXz9xny+4O7+niAM8c8wDkxMjNMo9rpG4SZgpDBQKcvMOYcXVVqxOxw4ZhnF6ST7rCgoq4osz7GNE/HfRa+ORsBYy6w0Z5blg4Rc1TX5qRBx1zRY57DOvsA1Dh/AKwhnabsG6wWtNTiraJ1B1xVF7nOlgQmmgcl7/wuGK8aL9ZzP5WxTKm7WFTfrknerkg9BxdvlmTePJ96vztwmB46HPcsg5GG1ZhkErKOIJE1fwadHBCutmUcJX5Yht89YhAm3q4hFlPAYbwiiiCCKCeOYx/WaeLslShLCzYbNdivWi/rizpRS7NIngmBNGAYE/oc4ZLuJGfqGfujphp6278T24yC2Gzr6oRNeMHR4rZlPfnE+sdkmKF1zdiPxaWCdDxxVR61rnnY7lDHyXbrfC5eeW7an5lKMpsF1zUXQ3zsrcuIkkQqXSpMeC7JSU2kjEXqnXd/RdK1Uvu1aXNdj2/7lBr5XJYf+tT8c+P7jp3h/2qWku5SqLlGqpmkbaYtrzyH1ny5dcGWnCy9t43uprCseliuOeU5eFNJztaoFXtBHMf1nvQj6e/t5rqqKuq4lDzLbSgnM80zLDP8L5jLLvwDAbuChRqYPNAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rails-postgres-perf-node-visualized\"\n        title=\"rails-postgres-perf-node-visualized\"\n        src=\"/static/53afa741576a3d1c859e34b508f1ba73/374ac/rails-postgres-perf-node-visualized.png\"\n        srcset=\"/static/53afa741576a3d1c859e34b508f1ba73/772e8/rails-postgres-perf-node-visualized.png 200w,\n/static/53afa741576a3d1c859e34b508f1ba73/e17e5/rails-postgres-perf-node-visualized.png 400w,\n/static/53afa741576a3d1c859e34b508f1ba73/374ac/rails-postgres-perf-node-visualized.png 634w\"\n        sizes=\"(max-width: 634px) 100vw, 634px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">With this tool, deciphering the details of PostgreSQL query plans becomes a little more approachable. Just be mindful that using it involves sharing your query and its plan publicly. If privacy is a concern regarding sharing your query and its plan publicly, consider using <a href=\"https://www.pgadmin.org/\" class=\"markdown-link\">pgAdmin</a>, an open-source administrative tool for PostgreSQL that you can install on your local machine, which also offers a visualization feature for query plans.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered techniques to enhance PostgreSQL query performance in Rails applications. We began by examining a query execution plan using the <code>EXPLAIN (ANALYZE)</code> feature to understand how PostgreSQL processes queries. We then explored indexing, covering the addition of an index for performance improvements and how to do so without causing downtime or table locking.</p>\n<p class=\"markdown-para\">Further into query optimization, we discussed the importance of careful column selection in the <code>SELECT</code> statement, demonstrating how narrowing down the retrieved data can improve performance. We then covered aligning database queries with business needs, illustrating how additional filters can reduce the number of processed rows and enhance scalability. Finally we learned how to visualize query plans with a free web-based tool. These strategies provide developers with the tools to create efficient and resilient Rails applications with PostgreSQL.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-query-perf/"}}},{"node":{"id":"46291e3e-a073-5c67-8e47-681973f63d50","frontmatter":{"title":"The Development Iceberg: Unseen Efforts That Extend Project Schedules","date":"February 2024","category":"productivity"},"excerpt":"If youâ€™ve worked on a software development project of any significant complexity, youâ€™ve probably observed that it nearly always takesâ€¦","html":"<p class=\"markdown-para\">If youâ€™ve worked on a software development project of any significant complexity, youâ€™ve probably observed that it nearly always takes longer to deliver than the planned timeline. There are many reasons for this including incomplete initial understanding of requirements, salespeople providing unrealistic promises to close a deal, and unforseen technical challenges.</p>\n<p class=\"markdown-para\">But even if the scope and tech stack is well understood, and developers are empowered provide estimates rather than being imposed on by outside forces, things still take longer than expected. Why is that? This post will cover some additional factors that are often unaccounted for, but a crucial part of the process. When asked how long some new feature will take to build, developers are often focused on the effort to write the code, and possibly also the unit tests. However there are many other items that need to get done to get the feature released and into customers hands, but are often not included in estimates. Let's explore some of these.</p>\n<h2 class=\"markdown-subtitle\" id=\"ticket-description\" style=\"position:relative;\"><a href=\"#ticket-description\" aria-label=\"ticket description permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ticket Description</h2>\n<p class=\"markdown-para\">Some time needs to be spent in writing a useful description of what will be worked on in whatever ticketing system the project is using such as Jira, Gitlab, Trello etc.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAQADAQAAAAAAAAAAAAAAAAMBAgQF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgMB/9oADAMBAAIQAxAAAAHEoeiV1IM3QTdhSv8A/8QAHBAAAgEFAQAAAAAAAAAAAAAAAQMAAgQQEhMh/9oACAEBAAEFAmO5267lm4fAuosUj3jTNjNjj//EABcRAQADAAAAAAAAAAAAAAAAAAAQEkL/2gAIAQMBAT8BVbj/xAAWEQADAAAAAAAAAAAAAAAAAAAAEBL/2gAIAQIBAT8BKf8A/8QAHhABAAECBwAAAAAAAAAAAAAAAQACIREgIjFRkaH/2gAIAQEABj8CKBvMB7l5rIjY5m/uT//EABwQAAICAwEBAAAAAAAAAAAAAAABETEhQVFhcf/aAAgBAQABPyHwBuOGmHBhyU+EcapdwQIYKR2NTBasfByWKj//2gAMAwEAAgADAAAAEOfn/P/EABgRAQEAAwAAAAAAAAAAAAAAAAEAETFR/9oACAEDAQE/EECwtgeSA3//xAAYEQEAAwEAAAAAAAAAAAAAAAABABARUf/aAAgBAgEBPxAHKCoL2IbP/8QAIBABAAIBAgcAAAAAAAAAAAAAAQARITFRQWFxkaGx0f/aAAgBAQABPxCpK1I87k7RYcqgGw+QCreNvXmHm3LgX1ETrubM89JXAMj1FtlShFI7txrH/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kitten ticket description\"\n        title=\"kitten ticket description\"\n        src=\"/static/6dc02d098be905c3832ad3e16b878a44/066f9/kitten-ticket-description.jpg\"\n        srcset=\"/static/6dc02d098be905c3832ad3e16b878a44/e07e9/kitten-ticket-description.jpg 200w,\n/static/6dc02d098be905c3832ad3e16b878a44/066f9/kitten-ticket-description.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">The purpose is to provide both business and technical context so everyone can understand why this change is being made, and what areas of the code are impacted. It should include how the planned code changes relate to the business requirement. On some teams this task is done by a product manager, but I've found its beneficial to have the developer write this, or at least contribute to it, to confirm their understanding and ensure everyone is on the same page. One option is to have the product person write the business part, then have the developer add some technical context. It doesn't need to be too detailed such as getting into the method and variable names.</p>\n<p class=\"markdown-para\">The benefit of taking the time for this activity is that it provides traceability. That is, all the commit messages to version control will contain the ticket number. Then future developers reading the code will be able to go back to the ticket to understand why the changes were made. This will also help the PR (pull request) reviewer in getting a broader understanding of the code changes. It can be tempting to skip this part and write a quick one-liner in the ticket such as \"add advanced search\", but this apparent time-savings is an illusion. Every person that goes back to try and understand what was done will have to spend extra time tracking down the original developer and/or product person to ask them questions or dig into the code or production logs. The total human time spent on this can be much greater than the additional time taken to write a useful description before development starts.</p>\n<h2 class=\"markdown-subtitle\" id=\"local-verification\" style=\"position:relative;\"><a href=\"#local-verification\" aria-label=\"local verification permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Local Verification</h2>\n<p class=\"markdown-para\">This seems straightforward enough - given the developer has checked out the project to their laptop and has added some code, make sure the feature actually works.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAQFAQID/8QAFwEBAQEBAAAAAAAAAAAAAAAAAQACA//aAAwDAQACEAMQAAABzN16kSCV8sKuG+X/xAAcEAEBAAICAwAAAAAAAAAAAAACAQARAwQSITH/2gAIAQEAAQUCeihxnZ64s8C8MyKSG+ll+//EABgRAAIDAAAAAAAAAAAAAAAAAAEQAhEx/9oACAEDAQE/ATSlq//EABYRAQEBAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPwEhk//EAB4QAAIABwEBAAAAAAAAAAAAAAABAhESISIxQRBR/9oACAEBAAY/Akt/SLHlpmUI3Tcbcp6SOFXv/8QAGxABAAIDAQEAAAAAAAAAAAAAAQARITFBYZH/2gAIAQEAAT8hBEVwRdgzYxZAvyADrXfso3wyNECl/UatsgY5lm03T//aAAwDAQACAAMAAAAQ+z//AP/EABkRAQACAwAAAAAAAAAAAAAAAAEAEBEhMf/aAAgBAwEBPxAhME1OFf/EABcRAAMBAAAAAAAAAAAAAAAAAAEQMRH/2gAIAQIBAT8Q0aVRf//EAB8QAQEAAQQCAwAAAAAAAAAAAAERACExQWFRcYGRwf/aAAgBAQABPxAkdZqJ2ZoRQgLOX7mUFtdyE+HHTAFLL07mOjAyYB4vl/DGWSGoVM1mQit0FnmYCfeE2s//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kitten local verification\"\n        title=\"kitten local verification\"\n        src=\"/static/61cfe1661982c8f45a97134e22f094f7/066f9/kitten-local-verification.jpg\"\n        srcset=\"/static/61cfe1661982c8f45a97134e22f094f7/e07e9/kitten-local-verification.jpg 200w,\n/static/61cfe1661982c8f45a97134e22f094f7/066f9/kitten-local-verification.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">For a monolith with comprehensive seed data that covers all scenarios and easily configurable third party services that provide sandbox modes for development mode (eg: Braintree, Stripe, Mandrill, etc.), this can be true. However, many projects are not structured this way. The existing seed data may be insufficient to cover the new feature being worked on. So either the developer needs to write some one-off scripts to setup some data, or (better) take the time to enhance the seed data so that everyone who resets their database can also cover this scenario.</p>\n<p class=\"markdown-para\">Some projects rely on third party services that either do not support a sandbox mode, or the integration only works in a deployed environment with a particular url. If the feature being developed depends on this service, development can take longer because the developer needs to deploy their changes to the test environment in order to see them working \"for real\".</p>\n<p class=\"markdown-para\">Another complexity can be when projects are broken down into microservices, but the boundaries between them are ambiguous. This can result in any given feature requiring changes to multiple services. This will take additional time as developer has to setup multiple projects and juggle multiple change sets.</p>\n<h2 class=\"markdown-subtitle\" id=\"test-automation\" style=\"position:relative;\"><a href=\"#test-automation\" aria-label=\"test automation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test Automation</h2>\n<p class=\"markdown-para\">This refers to all levels of test automation including unit, integration, <em class=\"markdown-emphasis\">and</em> end-to-end.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQCAwX/xAAXAQEBAQEAAAAAAAAAAAAAAAABAAID/9oADAMBAAIQAxAAAAH0c46FQhJzoJmG+X//xAAaEAACAwEBAAAAAAAAAAAAAAACAwABESEi/9oACAEBAAEFAtsEJYbJk3g9X2VXlQ4JBU//xAAYEQADAQEAAAAAAAAAAAAAAAAAAQIQIf/aAAgBAwEBPwHKKXWf/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAECECH/2gAIAQIBAT8BpEXh/8QAGxAAAgIDAQAAAAAAAAAAAAAAAAEQEQIiMVH/2gAIAQEABj8CbXTaKsyOs9HH/8QAHBABAQEAAgMBAAAAAAAAAAAAAREAITFBUWGR/9oACAEBAAE/IYPoLiFAHqZ5aVsydXN5STr5vv8AXHxfDt7wCLLe9aWvHvf/2gAMAwEAAgADAAAAECzXvP/EABkRAAMAAwAAAAAAAAAAAAAAAAABMRBBYf/aAAgBAwEBPxDmKFS2z//EABkRAAMAAwAAAAAAAAAAAAAAAAABERAhMf/aAAgBAgEBPxCVY4GTs//EAB4QAQACAwEAAwEAAAAAAAAAAAEAESExQVFhkaGx/9oACAEBAAE/EKRqIJd5L/Lgt5oMxzM5o0xGRor5CAI3B4199gUu6/E/srjVg7mPYnYyize93yKqehXrP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kitten test automation\"\n        title=\"kitten test automation\"\n        src=\"/static/04da05d9d9960cffcbab2ff8022ea833/066f9/kitten-test-automation.jpg\"\n        srcset=\"/static/04da05d9d9960cffcbab2ff8022ea833/e07e9/kitten-test-automation.jpg 200w,\n/static/04da05d9d9960cffcbab2ff8022ea833/066f9/kitten-test-automation.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">The effort to write these tests needs to be baked into the development time and not treated as a separate activity. Otherwise its tempting to break this up into a follow-on task as in \"we're in such a hurry now, we'll catch up with the testing later when things are more calm\". I've seen this movie before and it never ends well. There will never be a \"good\" time to write tests later. If the product/feature is successful, there will always be more and more work to be done and the team will regret not having thorough test automation, especially in the end-to-end category. End to end tests can be harder to write and do take time, but pay off in the ability to add new features and have confidence that all the existing features continue to work, without manual testing effort.</p>\n<p class=\"markdown-para\">Another thing I've seen is sometimes the end-to-end tests are treated as someone else's responsibility such as the QA team. However, it's better for all testing activity to be part of the development lifecycle so issues can be caught early during development.</p>\n<aside class=\"markdown-aside\">\nThis is not to suggest that QA is not needed, but it can be incorporated in terms of thinking of test cases, and then having the developer implement those test cases during development. A great tool for this is <a class=\"markdown-link\" href=\"https://cucumber.io/\">Cucumber</a>, which supports having the tests written in as close to \"business language\" as possible. This means less technical team members such as QA or a product manager can contribute to the development of the test cases.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"engineering-docs\" style=\"position:relative;\"><a href=\"#engineering-docs\" aria-label=\"engineering docs permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Engineering Docs</h2>\n<p class=\"markdown-para\">Another task that may be needed is adding or maintaining existing engineering documentation.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAIEAQMF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAGGd8sb5K6W+Erg/8QAGxABAAIDAQEAAAAAAAAAAAAAAgEDABESISP/2gAIAQEAAQUCoPbRrjHE9UR9r9HPMNRKOmADaf/EABcRAAMBAAAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8BMV//xAAWEQADAAAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8BK//EACAQAAIABgIDAAAAAAAAAAAAAAABAhESITFBEBMiYXH/2gAIAQEABj8CiUWEPb0Mbl4sbl9LdbXtcVNXKosn/8QAGxABAQADAQEBAAAAAAAAAAAAAREAITFhQVH/2gAIAQEAAT8hEdo7cBJsPWcVMimAlGl/M+gFunMm6GcUuIXb44EwK85gkbxpmf/aAAwDAQACAAMAAAAQ/wAQPP/EABgRAAMBAQAAAAAAAAAAAAAAAAABESEx/9oACAEDAQE/EH3WU2FdG3T/xAAYEQADAQEAAAAAAAAAAAAAAAAAAREhMf/aAAgBAgEBPxBPOFrCCP/EABwQAQEAAgMBAQAAAAAAAAAAAAERACExQVFhof/aAAgBAQABPxAr1Qwo2amdvOVgE0z3FUavCcYhdQ7J/S5EExW3l35g6jChI+4ZkyJCCbHQbwwgSidjuOrknbbSgfnef//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kitten engineering docs\"\n        title=\"kitten engineering docs\"\n        src=\"/static/e9faf3e3fdccc65d5b4a3cd40fda5cf3/066f9/kitten-engineering-docs.jpg\"\n        srcset=\"/static/e9faf3e3fdccc65d5b4a3cd40fda5cf3/e07e9/kitten-engineering-docs.jpg 200w,\n/static/e9faf3e3fdccc65d5b4a3cd40fda5cf3/066f9/kitten-engineering-docs.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\nFor example, if the feature involves integrating with a third party service such as Stripe or Braintree, some documentation will be needed explaining how to obtain accounts, API keys, configure developer environments to work with either a sandbox or mock mode of these, how to configure production, access a dashboard or transaction details etc. The best time to write these docs is while the details are fresh in the developers mind, so they should be included as part of the PR in the form of markdown files in the <code>/docs</code> project directory. See my other post <a href=\"../about-those-docs\" class=\"markdown-link\">About Those Docs</a> for everything you need to know about engineering documentation.</p>\n<h2 class=\"markdown-subtitle\" id=\"deployed-verification\" style=\"position:relative;\"><a href=\"#deployed-verification\" aria-label=\"deployed verification permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deployed Verification</h2>\n<p class=\"markdown-para\">While its great to have thorough automated test coverage, it's also important to try out the code \"for real\" in a deployed environment.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIDBAX/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgD/2gAMAwEAAhADEAAAAedrlOb5TQZumDSMf//EABsQAQACAwEBAAAAAAAAAAAAAAEAAgMREiIj/9oACAEBAAEFAjnrJ846jioRqMtiW3SS3gvkd//EABcRAQADAAAAAAAAAAAAAAAAAAAQEUH/2gAIAQMBAT8BU2P/xAAWEQADAAAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8BK//EAB8QAQABAgcBAAAAAAAAAAAAAAEAAiEQERIiMUFxUf/aAAgBAQAGPwLdxNNNJ6S9pdZ9eoomUPYph//EABwQAAIDAQADAAAAAAAAAAAAAAERACFBUTFhof/aAAgBAQABPyGij2ogFnylmnFG+iuwcGUIUv5DcDUTThdhWQIlQBkE3kBz4Gep/9oADAMBAAIAAwAAABDj5z7/xAAWEQEBAQAAAAAAAAAAAAAAAAABABH/2gAIAQMBAT8QRLURv//EABgRAAMBAQAAAAAAAAAAAAAAAAABERAx/9oACAECAQE/EKmQLmf/xAAdEAEBAAICAwEAAAAAAAAAAAABEQAhMUFRgZFx/9oACAEBAAE/EJW7QKM85N4tgVft6yLA9grDSphCHR17xGEdDAfqJOfWOhSroeZnA84GkkxCmuaadM+4Xmq86aZ//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kitten deployed verification\"\n        title=\"kitten deployed verification\"\n        src=\"/static/188265cb1d2a21974b1014f7f73ab710/066f9/kitten-deployed-verification.jpg\"\n        srcset=\"/static/188265cb1d2a21974b1014f7f73ab710/e07e9/kitten-deployed-verification.jpg 200w,\n/static/188265cb1d2a21974b1014f7f73ab710/066f9/kitten-deployed-verification.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Ideally there are a few other environments besides production (eg: dev, qa, staging, etc.) for developers to deploy their branches to and make sure it works in a production-like environment. This is also a good opportunity to have the product manager or other team members try it out and provide feedback. This could include QA if manual QA is being used on the project.</p>\n<p class=\"markdown-para\">Time needs to be allocated to this, not just for the actual deployment and verification, but for the inevitable environment issues that may arise and require troubleshooting. Issues such as different environments may have different configuration, a networking issue may prevent access to a service that worked fine from the developers laptop, may realize that additional logs are needed for debugging, etc.</p>\n<p class=\"markdown-para\">To the extent that manual QA is being used on the project, this may result in some back and forth between QA and developer with some more code being written to address issues found by QA. Again, this is more time.</p>\n<h2 class=\"markdown-subtitle\" id=\"git-cleanup\" style=\"position:relative;\"><a href=\"#git-cleanup\" aria-label=\"git cleanup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Git Cleanup</h2>\n<p class=\"markdown-para\">For this section, I'm assuming <a href=\"https://git-scm.com/book/en/v2\" class=\"markdown-link\">Git</a> is being used for version control but this could apply to any version control system. Since it's a good practice to commit early and commit often, during development, there will inevitably be a lot of <a href=\"https://en.wikipedia.org/wiki/Stream_of_consciousness\" class=\"markdown-link\">stream of consciousness</a> commit messages to the feature branch such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">* fixing things</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">* rubocop</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">* model wip</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">* something or other...</span></span></code></pre>\n<p class=\"markdown-para\">Prior to submitting work for review, it's beneficial to take the time to reorganize and clean these up so that the set of commits tells a coherent story of the development.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAQADAQAAAAAAAAAAAAAAAAQBAgMF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgEA/9oADAMBAAIQAxAAAAHtmTQr1kKmriF0DT//xAAaEAACAwEBAAAAAAAAAAAAAAAAAgEDEyEj/9oACAEBAAEFAqX5DNqUQzDXe2zDqRVEPmf/xAAVEQEBAAAAAAAAAAAAAAAAAAAQAf/aAAgBAwEBPwEp/8QAFREBAQAAAAAAAAAAAAAAAAAAEAH/2gAIAQIBAT8BIf/EAB4QAAICAAcAAAAAAAAAAAAAAAABETECEBIhM0FR/9oACAEBAAY/AiHWVRh9NXSpHGJS4Fuy2f/EAB0QAAMAAgIDAAAAAAAAAAAAAAABESExQVFxkeH/2gAIAQEAAT8hZgzVzm+CIcVxbcZgrcwry9i24HQfSvXkj7n/2gAMAwEAAgADAAAAEBAwQ//EABkRAQACAwAAAAAAAAAAAAAAAAEAEBEhMf/aAAgBAwEBPxBOswzav//EABkRAQACAwAAAAAAAAAAAAAAAAEAERAhUf/aAAgBAgEBPxA5LIKNY//EAB8QAAICAgIDAQAAAAAAAAAAAAERACExQVFhgZHR4f/aAAgBAQABPxAoTNDcbjLKgD4BwvwJRdrqCHHMqENMI0n5htI6P5jXQWRIR6xiXhHLBl51Cwv1vk//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kitten git cleanup\"\n        title=\"kitten git cleanup\"\n        src=\"/static/9e120974f0033e45f8847d718a621d51/066f9/kitten-git-cleanup.jpg\"\n        srcset=\"/static/9e120974f0033e45f8847d718a621d51/e07e9/kitten-git-cleanup.jpg 200w,\n/static/9e120974f0033e45f8847d718a621d51/066f9/kitten-git-cleanup.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">This is also a good time to ensure each commit message has the associated ticket number. The result will be helpful for the reviewer to understand how the feature came together and for future developers running <code>git blame</code>. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">* [ACME-123] Create database schema and model for user profiles</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">* [ACME-123] Implement user authentication and registration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">* [ACME-123] Add end-to-end tests for user authentication and registration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">* [ACME-123] Update documentation for user management</span></span></code></pre>\n<aside class=\"markdown-aside\">\nIf you've never reorganized your git commits, see this excellent explainer from Thoughtbot on <a class=\"markdown-link\" href=\"https://thoughtbot.com/blog/git-interactive-rebase-squash-amend-rewriting-history/\">interactive rebase</a>, which can guide you through this process.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"pull-request\" style=\"position:relative;\"><a href=\"#pull-request\" aria-label=\"pull request permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pull Request</h2>\n<p class=\"markdown-para\">Code can't just be pushed from a developers laptop to production, it first has to be reviewed with a <a href=\"https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests\" class=\"markdown-link\">pull request</a> (PR).</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAIDBQEE/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQID/9oADAMBAAIQAxAAAAGmrQy89PK6uZVAxDP/xAAdEAADAAAHAAAAAAAAAAAAAAABAgMAEBETITEy/9oACAEBAAEFAuw65J6jTWjcNv0IDlSWJx//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAVEQEBAAAAAAAAAAAAAAAAAAABIP/aAAgBAgEBPwEj/8QAHBAAAgEFAQAAAAAAAAAAAAAAAAERAhASITFh/9oACAEBAAY/AhYrtvMBKraehkToldVv/8QAGhABAAMBAQEAAAAAAAAAAAAAAQARITFBUf/aAAgBAQABPyHWQ5Dasu4mxj6pZsljXUL7MDmxufyhEw0GIW9n/9oADAMBAAIAAwAAABD3CD3/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBSM//EABYRAAMAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAgEBPxCqgF//xAAdEAEAAgMBAAMAAAAAAAAAAAABABEhMVFBYZGh/9oACAEBAAE/ENoAWvCLgNhuqM/srZH4GlChxdfVxDiEFMjGeXUKCUEA+ZjVNgQFWHl8+I4jMDT2K3FbZ//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kitten pull request\"\n        title=\"kitten pull request\"\n        src=\"/static/161ea6912c18050827da2b342339f449/066f9/kitten-pull-request.jpg\"\n        srcset=\"/static/161ea6912c18050827da2b342339f449/e07e9/kitten-pull-request.jpg 200w,\n/static/161ea6912c18050827da2b342339f449/066f9/kitten-pull-request.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">The process of creating a PR seems easy enough, especially if you're using Github and the <a href=\"https://cli.github.com/\" class=\"markdown-link\">gh</a> command line utility. It can be as fast as typing <code>gh pr create</code> in your terminal and hitting <kbd class=\"markdown-kbd\">Enter</kbd> a few times to accept the defaults. However, a PR with only the branch name as the title and a one-liner description such as \"added user authentication\" is insufficient for an effective code review.</p>\n<p class=\"markdown-para\">There are two important sections that the developer submitting the PR needs to take the time to write:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Description:</strong> This covers technical details of the change, such as the overall approach that was taken, any architectural decisions made, and explanations of complex logic or algorithms. Include interesting details you'd like to draw the reviewer's attention to, such as performance optimizations, departure from conventions, or difficult challenges and trade-offs that were encountered during development.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Try it out:</strong> This section is to provide step-by-step instructions for the reviewer, how they can checkout the branch and exercise the code changes on their laptop. Essentially whatever steps the original developer took to verify the feature works should be repeatable by the reviewer. This can catch some \"works on my machine\" issues. In my experience, following this process has caught many more issues than simply scanning the code changes in the PR. It's also a useful historical reference for future developers maintaining this code, to know how it can be exercised.</p>\n<h2 class=\"markdown-subtitle\" id=\"context-shift\" style=\"position:relative;\"><a href=\"#context-shift\" aria-label=\"context shift permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Context Shift</h2>\n<p class=\"markdown-para\">While waiting for their pull request to be reviewed, the developer needs to switch to another task, such as picking up someone else's code to review, or working on a small bugfix or technical debt item that doesn't depend on the current work awaiting review.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAUEAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAACAf/aAAwDAQACEAMQAAABp+eTorE1EZlQlkBH/8QAHBAAAgICAwAAAAAAAAAAAAAAAQIDEgAEERMU/9oACAEBAAEFAomUrLUybnHoMUilY+tm1bsJXttMVFjn/8QAFhEBAQEAAAAAAAAAAAAAAAAAEAER/9oACAEDAQE/AdIf/8QAFhEBAQEAAAAAAAAAAAAAAAAAEAER/9oACAECAQE/AcKf/8QAHRAAAgEEAwAAAAAAAAAAAAAAAAERAhIxQSEyYf/aAAgBAQAGPwJCXA4EqHHpDct7Lr8nZkLRk//EABsQAAIDAAMAAAAAAAAAAAAAAAABESExQWGB/9oACAEBAAE/IcFIEstR0BJFg3uBkDd3pMMvgVlI3ViDTBDbyP/aAAwDAQACAAMAAAAQ4O+//8QAGREAAgMBAAAAAAAAAAAAAAAAAAEQETFB/9oACAEDAQE/EF0WYcf/xAAXEQEBAQEAAAAAAAAAAAAAAAABABAx/9oACAECAQE/EKF2Z//EAB0QAQEAAwACAwAAAAAAAAAAAAERACExQWFRcaH/2gAIAQEAAT8QkYmTKjj1dLjQxC19ZpN3nC3Qez5zeARBBrlembmu0OP3DHUCrpyTQEMqnvFq39Mz/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kitten context shift\"\n        title=\"kitten context shift\"\n        src=\"/static/3bb034de566a5545ad47a3cf1522a2a2/066f9/kitten-context-shift.jpg\"\n        srcset=\"/static/3bb034de566a5545ad47a3cf1522a2a2/e07e9/kitten-context-shift.jpg 200w,\n/static/3bb034de566a5545ad47a3cf1522a2a2/066f9/kitten-context-shift.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">When the feedback does come in on their PR, then another context shift is necessary to address the comments, and make further code changes if necessary. Another source of context shifting can be if an urgent production issue arises, or priorities change and the developer needs to switch to a different, now more important task.</p>\n<p class=\"markdown-para\">All of these activities take additional time, and depending on how busy the team is, it could take a few days or more to receive feedback on the PR, address it, then have the reviewer go over it again.</p>\n<h2 class=\"markdown-subtitle\" id=\"final-push\" style=\"position:relative;\"><a href=\"#final-push\" aria-label=\"final push permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final Push</h2>\n<p class=\"markdown-para\">After the code review feedback has been addressed and the PR approved, the developer needs to merge the PR, and follow the procedure to get the code into production.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMEBf/EABYBAQEBAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAAB6OfNpmpJE0UMtrhj/8QAHBAAAgICAwAAAAAAAAAAAAAAAQMAAhESEyIy/9oACAEBAAEFAm2401YWDzHbXbnrozOoErQC2Z//xAAVEQEBAAAAAAAAAAAAAAAAAAABIP/aAAgBAwEBPwEI/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAHhAAAgIBBQEAAAAAAAAAAAAAAAECESEQEiIxQoH/2gAIAQEABj8CtdnKkZFDdcSatM8/TA3p/8QAGhABAAMBAQEAAAAAAAAAAAAAAQARITFBYf/aAAgBAQABPyHHvARekDmRLVhjKUaSVOiBcbG/Grg00SiOpUEFGE//2gAMAwEAAgADAAAAEGjIPP/EABkRAAMAAwAAAAAAAAAAAAAAAAABERAxQf/aAAgBAwEBPxBk0OHMf//EABcRAQEBAQAAAAAAAAAAAAAAAAEAEBH/2gAIAQIBAT8QWOy5/8QAHxABAAIDAAEFAAAAAAAAAAAAAQARITFBUWFxgcHh/9oACAEBAAE/EGZjaidZZ8bFWl/kL1oqCPUsMDVU+a+5nCnNDiHziNQrVy4ObIjXeI6hwuNjqvbUBYDQYCf/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kitten final push\"\n        title=\"kitten final push\"\n        src=\"/static/0325277b2513293947e6d6bb5c0940f1/066f9/kitten-final-push.jpg\"\n        srcset=\"/static/0325277b2513293947e6d6bb5c0940f1/e07e9/kitten-final-push.jpg 200w,\n/static/0325277b2513293947e6d6bb5c0940f1/066f9/kitten-final-push.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Ideally a <a href=\"https://en.wikipedia.org/wiki/CI/CD\" class=\"markdown-link\">CI/CD</a> pipeline is in place to automate this activity, but there could still be some effort involved such as monitoring the deployment job, verifying the feature in production, and checking production logs to ensure all is well.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">So what to do with all this information? It's important to remember than when a manager is asking how long a feature will take, they really mean how many days between today and the day the feature is in production and customers are able to use it. This post has covered many other activities besides writing the code that are needed for this to happen. If you're a developer, keep these in mind when providing estimates. If you're a manager, also keep this in mind when you hear the estimates, that it covers a lot more than just implementation.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/development-iceberg/"}}},{"node":{"id":"a103f88f-4941-5f40-8adc-948b6eba5d2c","frontmatter":{"title":"A Tale of Rails, ChatGPT, and Scopes","date":"January 2024","category":"rails"},"excerpt":"Today I'd like to share a cautionary tale about using ChatGPT to improve some Rails model querying code, and how the Rails Guides and APIâ€¦","html":"<p class=\"markdown-para\">Today I'd like to share a cautionary tale about using ChatGPT to improve some Rails model querying code, and how the Rails Guides and API docs turned out to be a better resource in this case.</p>\n<h2 class=\"markdown-subtitle\" id=\"the-problem\" style=\"position:relative;\"><a href=\"#the-problem\" aria-label=\"the problem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Problem</h2>\n<p class=\"markdown-para\">I'm working on a Rails application to handle agile retrospective meetings for teams. The Retrospective model has an enum to indicate whether the retrospective is open or closed. There can only be one open retrospective at a time, which is represented with a custom validation rule. Here is the model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: retrospectives</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :bigint           not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  status     :enum             default(&quot;open&quot;), not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  title      :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Indexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  index_retrospectives_on_title  (title) UNIQUE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:comments</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">open:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">closed:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:status</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:only_one_open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">only_one_open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> open? </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">exists?</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors.</span><span class=\"mtk5\">add</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:status</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;There can only be one open retrospective at a time.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Throughout the application, I frequently need to access the one and only open retrospective. After some time, I noticed this code appeared multiple times throughout the services layer:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">])</span></span></span></code></pre>\n<p class=\"markdown-para\">In the future, the logic to find the retrospective could change, for example, if the application is enhanced for multi-tenancy. To avoid code duplication, and having the services be dependent on these details of the retrospective model, I decided to refactor by adding a class method <code>find_open</code> on the model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">open:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">closed:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.find_open</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Then all the services that need access to the open retrospective can simply call the <code>find_open</code> method on the model class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/services/some_service.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SomeService</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retro </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_open</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with retro...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"ask-chatgpt\" style=\"position:relative;\"><a href=\"#ask-chatgpt\" aria-label=\"ask chatgpt permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ask ChatGPT</h2>\n<p class=\"markdown-para\">The <code>find_open</code> model method worked, but I had a feeling there might be a more \"Rails-ey way\" of doing things. So I gave the model code to ChatGPT and asked if there was a more idiomatic Rails solution to deal with the code duplication. ChatGPT said that using Rails scopes would be better for query re-usability. Here's what it came up with:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">open:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">closed:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:open_retrospective</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> { </span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> statuses[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Looks reasonable? Let's try this out in a Rails console. I started from an empty database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create an open retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">retro1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;My Project Sprint 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Also create a closed retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">retro2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;My Project Sprint 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:closed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Use the scope suggested by ChatGPT to find the open retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SELECT &quot;retrospectives&quot;.*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># FROM &quot;retrospectives&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># WHERE &quot;retrospectives&quot;.&quot;status&quot; = $1 LIMIT $2  [[&quot;status&quot;, &quot;open&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># &lt;Retrospective:0x00000001140fa018</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   id: 22,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   title: &quot;My Project Sprint 2&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   status: &quot;open&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   created_at: ..., updated_at: ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result.</span><span class=\"mtk5\">class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; Retrospective(id: integer, title: string, created_at: datetime, updated_at: datetime, status: enum)</span></span></span></code></pre>\n<p class=\"markdown-para\">When the scope is invoked, the Rails console output shows a SQL SELECT running to find retrospectives where the status is <code>open</code>. Then the scope returns the model titled \"My Project Sprint 2\", which is the only open retrospective in the database. So far so good.</p>\n<p class=\"markdown-para\">However, what will the scope return when there are no open retrospectives? I was expecting a <code>nil</code> return, but here's what actually happened:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Close the currently open retrospective with the enum-generated method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">retro1.</span><span class=\"mtk5\">closed!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Use the scope suggested by ChatGPT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === RUNS THIS QUERY, THE SAME AS BEFORE,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === BUT IT DOES NOT RETURN ANY RESULTS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SELECT &quot;retrospectives&quot;.*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># FROM &quot;retrospectives&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># WHERE &quot;retrospectives&quot;.&quot;status&quot; = $1 LIMIT $2  [[&quot;status&quot;, &quot;open&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === THEN RUNS ANOTHER QUERY TO FETCH ALL RETROSPECTIVES!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SELECT &quot;retrospectives&quot;.* FROM &quot;retrospectives&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &lt;Retrospective:0x00000001140fa018</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     id: 23,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     title: &quot;My Project Sprint 1&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     status: &quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     created_at: ..., updated_at: ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &lt;Retrospective:0x00000001140fa018</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     id: 22,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     title: &quot;My Project Sprint 2&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     status: &quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     created_at: ..., updated_at: ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result.</span><span class=\"mtk5\">class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; Retrospective::ActiveRecord_Relation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result.</span><span class=\"mtk5\">size</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 2</span></span></span></code></pre>\n<p class=\"markdown-para\">This time, the results are unexpected. When the scope is invoked, the Rails console output shows its running the same SQL SELECT as before to find an open retrospective. However, in this case, none are found. Then the Rails console output shows that the scope proceeds to run a second query that fetches <em class=\"markdown-emphasis\">all</em> retrospectives from the database, regardless of status.</p>\n<p class=\"markdown-para\">In this case, the return result from the scope is an <a href=\"https://api.rubyonrails.org/v7.1.2/classes/ActiveRecord/Relation.html\" class=\"markdown-link\">ActiveRecord::Relation</a> representing a query that returns <em class=\"markdown-emphasis\">all</em> the retrospectives (there are just 2 in this simple example).</p>\n<p class=\"markdown-para\">Not only was I not getting <code>nil</code> as expected, but this could cause a performance problem as the application grows and there are large numbers of records in the <code>retrospectives</code> table.</p>\n<p class=\"markdown-para\">I explained the situation to ChatGPT and it did that thing where it apologizes, then provides the same solution again that doesn't fix the problem. (I encountered a similar issue awhile back trying to find the syntax for a <a href=\"../gatsby5-distinct-query#ai-to-the-rescue\" class=\"markdown-link\">distinct GraphQL query</a>)</p>\n<h2 class=\"markdown-subtitle\" id=\"ask-the-docs\" style=\"position:relative;\"><a href=\"#ask-the-docs\" aria-label=\"ask the docs permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ask the Docs</h2>\n<p class=\"markdown-para\">When AI doesn't provide the solution, it's good to lean on skills we engineers developed before the existence of such tools: Read the documentation! Industry veterans may remember this as <a href=\"https://en.wikipedia.org/wiki/RTFM\" class=\"markdown-link\">RTFM</a>.</p>\n<p class=\"markdown-para\">I started with the guide on the <a href=\"https://guides.rubyonrails.org/active_record_querying.html\" class=\"markdown-link\">Active Record Query Interface</a>, more specifically, the section on <a href=\"https://guides.rubyonrails.org/active_record_querying.html#scopes\" class=\"markdown-link\">scopes</a>. Here I found this illuminating description:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Scoping allows you to specify commonly-used queries which can be referenced as method calls on the association objects or models. With these scopes, you can use every method previously covered such as where, joins and includes. All scope bodies should return an ActiveRecord::Relation or nil to allow for further methods (such as other scopes) to be called on it.</p>\n</blockquote>\n<p class=\"markdown-para\">This phrase is key: <strong class=\"markdown-strong\">All scope bodies should return an ActiveRecord::Relation</strong></p>\n<p class=\"markdown-para\">Let's take another look at the scope that ChatGPT generated:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">scope </span><span class=\"mtk4\">:open_retrospective</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> { </span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> statuses[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]) }</span></span></span></code></pre>\n<p class=\"markdown-para\">What does the <code>find_by</code> method return? The answer to this can be found in the <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-find_by\" class=\"markdown-link\">Rails API docs for find_by</a>. Quoting the relevant snippet:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Finds the first record matching the specified conditions... If no record is found, returns nil.</p>\n</blockquote>\n<p class=\"markdown-para\">Aha! So <code>find_by</code> does not return an <code>ActiveRecord::Relation</code>. It returns either the model instance if one is found matching the given conditions, or it returns <code>nil</code>. This starts to explain some of the surprising behaviour encountered earlier with the scope, it's not being given a method that returns a relation.</p>\n<p class=\"markdown-para\">The next part of the mystery is, why did the scope proceed to query for <em class=\"markdown-emphasis\">all</em> model instances, when the finder returned <code>nil</code>? Although the guides explained that the scope should return a relation or <code>nil</code>, it didn't say what happens if <code>nil</code> is returned. The answer to this can be found in the Rails API docs for <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Scoping/Named/ClassMethods.html#method-i-scope\" class=\"markdown-link\">scope</a>. Quoting the relevant snippet:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Adds a class method for retrieving and querying objects... If it returns nil or false, an all scope is returned instead.</p>\n</blockquote>\n<p class=\"markdown-para\">Aha! Another piece of the mystery resolved. If the body of the scope returns <code>nil</code>, which is the behaviour of <code>find_by</code> when no records are found, then the scope will go ahead and return an <code>all</code> scope. What exactly is an <code>all</code> scope? You can probably guess by the name that it will return a relation representing all the records for the model where this scope is defined. To be absolutely sure, let's check the Rails API docs for <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Scoping/Named/ClassMethods.html#method-i-all\" class=\"markdown-link\">all</a>. Here there's only a one sentence description:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Returns an ActiveRecord::Relation scope object.</p>\n</blockquote>\n<p class=\"markdown-para\">And a code example that demonstrates the behavior of <code>all</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">posts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">posts.</span><span class=\"mtk5\">size</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># Fires &quot;select count(*) from  posts&quot; and returns the count</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">posts.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> {|p| </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk9\">p</span><span class=\"mtk1\">.</span><span class=\"mtk5\">name</span><span class=\"mtk1\"> } </span><span class=\"mtk3\"># Fires &quot;select * from posts&quot; and loads post objects</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"solution\" style=\"position:relative;\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h2>\n<p class=\"markdown-para\">Putting together all the information from the Rails guides and API documentation, the scope can be fixed to return an <code>ActiveRecord::Relation</code> by using the <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where\" class=\"markdown-link\">where</a> method rather than a finder method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">open:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">closed:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:open_retrospective</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> { </span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> statuses[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Trying this version in the Rails console <code>bin/rails c</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Starting from all retrospectives closed:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:id</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:status</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &lt;Retrospective:0xb2fb40 id: 23, title: &quot;My Project Sprint 1&quot;, status: &quot;closed&quot;&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &lt;Retrospective:0xb2faa0 id: 22, title: &quot;My Project Sprint 2&quot;, status: &quot;closed&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This time, using the scope returns an empty relation:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result.</span><span class=\"mtk5\">class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; Retrospective::ActiveRecord_Relation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Re-open one of the retrospectives with the enum method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;My Project Sprint 2&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">open!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Use the scope again, this time it returns a relation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># with the one open retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [ &lt;Retrospective:0xb2faa0 id: 22, title: &quot;My Project Sprint 2&quot;, status: &quot;closed&quot;&gt; ]</span></span></span></code></pre>\n<p class=\"markdown-para\">Since <code>where</code> always returns a relation (unlike <code>find_by</code> which returns the model instance), usage of this scope in application code can call <code>first</code> to get the model instance:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># anywhere in service code that needs the one open retro</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">retro </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIn this particular case, since the only search criteria is for an attribute that happens to be an enum, there's a simpler solution. `Retrospective.open` could be used to find all open retrospectives (of which, there would only be one due to the custom validation rule). This is because enum attributes on a model automatically add class level <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/rails-enum-mysql-postgres/#enum-scopes\">scope methods</a>. However, for this exercise, I was interested in understanding scopes more generally.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"lessons-learned\" style=\"position:relative;\"><a href=\"#lessons-learned\" aria-label=\"lessons learned permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lessons Learned</h2>\n<p class=\"markdown-para\">A few things learned from this experience:</p>\n<p class=\"markdown-para\">It seems that ChatGPT saw my original code using the finder method, and knew that scopes are a good solution for query re-usability, so it simply placed the finder in a scope. It did not make the inference that <code>find_by</code> doesn't return an ActiveRecord relation, therefore it doesn't make sense to put that in a scope.</p>\n<p class=\"markdown-para\">Always try positive and negative cases, whether its code you wrote yourself, or suggested by AI. Recall the positive case seemed to work, but unexpected results were encountered in the negative case.</p>\n<p class=\"markdown-para\">While ChatGPT can improve developer productivity, it may not fully understand the frameworks and libraries you're using, resulting in the introduction of subtle bugs. For now, any code it generates requires careful double-checking before committing.</p>\n<p class=\"markdown-para\">The <a href=\"https://guides.rubyonrails.org/\" class=\"markdown-link\">Rails Guides</a> and <a href=\"https://api.rubyonrails.org/\" class=\"markdown-link\">API docs</a> are fantastic resources. If you ever run into seemingly unexpected behaviour with Rails, there's a good chance you'll find an explanation there.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/a-tale-of-rails-chatgpt-and-scopes/"}}},{"node":{"id":"1c4c8585-87a3-573e-b9fc-09cb6a7b999b","frontmatter":{"title":"Maintain Node.js Version Consistency","date":"December 2023","category":"web development"},"excerpt":"In modern web development, Node.js is not limited to Node projects; it's widely used in frontend build tooling across various tech stacksâ€¦","html":"<p class=\"markdown-para\">In modern web development, Node.js is not limited to Node projects; it's widely used in frontend build tooling across various tech stacks like Rails and Java Spring. This creates a challenge for developers: which Node.js version to use? Some npm packages may only work with specific Node.js versions. Furthermore, developers often work on multiple projects, and each may require a different Node.js version. This post will explain how <a href=\"https://github.com/nvm-sh/nvm\" class=\"markdown-link\">nvm</a> (Node Version Manager) can be used to ensure a consistent Node.js environment across the project team, and make it easy to switch between different node versions when working on multiple projects.</p>\n<aside class=\"markdown-aside\">\nThis post assumes a basic understanding of what Node.js is and how it works. If you're new to it or need a refresher, check out the official <a class=\"markdown-link\" href=\"https://nodejs.org/en\">Node.js website</a> and <a class=\"markdown-link\" href=\"https://nodejs.org/en/docs\">documentation<a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"the-problem\" style=\"position:relative;\"><a href=\"#the-problem\" aria-label=\"the problem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Problem</h2>\n<p class=\"markdown-para\">Before getting into the details of how to use nvm, let's review what the problem is. If a project was originally set up with a specific Node.js version, as time goes on, newer LTS or Current versions are released. The default approach for many developers might be to install the latest available version from the official <a href=\"https://nodejs.org/en\" class=\"markdown-link\">Node.js website</a>. However, this approach can lead to issues when new team members join the project. If a new developer installs the latest Node.js version without considering the project's original setup, it may result in errors while running <code>npm install</code> or, even worse, cause unexpected behavior in the application if it relies on assumptions made for an older Node.js version.</p>\n<p class=\"markdown-para\">Moreover, when switching to work on a different project, which might require a specific Node.js version, the developer would have to uninstall the current version and manually install the required version from the list of previous <a href=\"https://nodejs.org/en/download/releases\" class=\"markdown-link\">Node.js releases</a>. This process becomes tedious, especially for developers who frequently switch between different projects. As such, a version management solution like nvm (Node Version Manager) becomes crucial to ensure consistency and avoid compatibility issues across various projects.</p>\n<h2 class=\"markdown-subtitle\" id=\"install-nvm\" style=\"position:relative;\"><a href=\"#install-nvm\" aria-label=\"install nvm permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install nvm</h2>\n<p class=\"markdown-para\">Start by going to <a href=\"https://github.com/nvm-sh/nvm\" class=\"markdown-link\">nvm on Github</a> and following the instructions to install it. At the time of this writing, the install command is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># OR</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> bash</span></span></span></code></pre>\n<p class=\"markdown-para\">The installation command will modify your profile by detecting which of <code>~/.bashrc</code>, <code>~/.bash_profile</code>, <code>~/.zshrc</code>, or <code>~/.zprofile</code> is in use. Therefore to activate nvm after initial installation, either close the terminal application and start it again, or reload the profile. For example, if your profile is in <code>~/.zshrc</code> the command to reload is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">source</span><span class=\"mtk1\"> </span><span class=\"mtk7\">~</span><span class=\"mtk1\">/.zshrc</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIf you're particularly safety conscious, an alternative approach to installing nvm is to download the nvm source directly from the latest <a class=\"markdown-link\" href=\"https://github.com/nvm-sh/nvm/releases\">release on GitHub</a> and review the \"install.sh\" script to ensure its integrity. Then, instead of piping the script through bash from raw.githubusercontent, you can run the script directly in your terminal.\n</aside>\n<p class=\"markdown-para\">If you're a Windows user, see these <a href=\"https://github.com/nvm-sh/nvm#important-notes\" class=\"markdown-link\">important notes</a> about nvm support for Windows.</p>\n<p class=\"markdown-para\">At this point, you should be able to use nvm to list currently installed Node.js versions:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm ls</span></span></span></code></pre>\n<p class=\"markdown-para\">Install a specific version:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm install 18.17.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># The `nvm install` command also switches you to that Node.js version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">node --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># v18.17.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># It also installs npm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">npm --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 9.6.7</span></span></span></code></pre>\n<p class=\"markdown-para\">Switch to a specific version, this will work assuming the specified version was previously installed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm use 16.20.1</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"use-nvmrc-file\" style=\"position:relative;\"><a href=\"#use-nvmrc-file\" aria-label=\"use nvmrc file permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use .nvmrc file</h2>\n<p class=\"markdown-para\">In the previous section, we saw how <code>nvm install x.y.z</code> and <code>nvm use x.y.z</code> can be used to install and switch to specific node versions. Another feature that nvm provides is the ability to install and use a node version without having to type it in the command line. To make use of this, create a file named <code>.nvmrc</code> in the root of your project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># in project root</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">touch .nvmrc</span></span></span></code></pre>\n<p class=\"markdown-para\">Edit the file so that it has a single line with the Node.js version that should be used for this project, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;18.17.0&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> .nvmrc</span></span></span></code></pre>\n<p class=\"markdown-para\">Now in this directory, you can type in:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Will install Node v18.17.0 from .nvmrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm install</span></span></span></code></pre>\n<p class=\"markdown-para\">If the node version specified in <code>.nvmrc</code> is already installed, then this will work:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Will switch to Node v18.17.0 from .nvmrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm use</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>.nvmrc</code> file can be committed to your project git repo. Then you can update the setup instructions in the project <code>README.md</code> to include the instructions to install nvm, then run <code>nvm install</code> and/or <code>nvm use</code>. This ensures that any developer working on this project will be using the same Node.js version. Furthermore, since nvm supports having multiple node versions installed at the same time, developers can easily switch between projects that have <code>.nvmrc</code> files in their roots, and use the nvm commands to quickly get the right Node.js version setup.</p>\n<h2 class=\"markdown-subtitle\" id=\"add-shell-integration\" style=\"position:relative;\"><a href=\"#add-shell-integration\" aria-label=\"add shell integration permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Add shell integration</h2>\n<p class=\"markdown-para\">One slight bit of friction with the setup so far is that if you run <code>nvm use</code> in a directory with a <code>.nvmrc</code> file that specifies a Node.js version that isn't already installed, it will result in an error. For example, suppose the <code>.nvmrc</code> file specifies Node.js v20.5.0, which isn't currently installed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Check what Node.js version this project requires</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /path/to/some_project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cat .nvmrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 20.5.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Try to use it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm use</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Found &#39;/path/to/some_project/.nvmrc&#39; with version &lt;20.5.0&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># N/A: version &quot;v20.5.0&quot; is not yet installed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># You need to run `nvm install` to install and use the node version specified in `.nvmrc`.</span></span></span></code></pre>\n<p class=\"markdown-para\">It would be nice if there was some automation that could handle this - i.e. check if the Node.js version specified in <code>.nvmrc</code> is already installed, if yes, use it, otherwise, install and then use it. Fortunately, nvm provides this as well via <a href=\"https://github.com/nvm-sh/nvm#deeper-shell-integration\" class=\"markdown-link\">shell integration</a>. The idea is you can add a script to your profile that will check for a <code>.nvmrc</code> file in any directory you <code>cd</code> to, then either install or use that Node.js version automatically.</p>\n<p class=\"markdown-para\">At the time of this writing, automatic shell integration is supported for the <a href=\"https://github.com/nvm-sh/nvm#bash\" class=\"markdown-link\">bash</a>, <a href=\"https://github.com/nvm-sh/nvm#zsh\" class=\"markdown-link\">zsh</a>, and <a href=\"https://github.com/nvm-sh/nvm#fish\" class=\"markdown-link\">fish</a> shells. I use zsh with my profile in <code>~/.zshrc</code>. Here are the lines I added to my profile to support automatic Node version installation and switching. I asked ChatGPT to add explanatory comments:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ~/.zshrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># My profile things...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This section was added by the nvm install script</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># and initializes nvm:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> NVM_DIR=</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$HOME</span><span class=\"mtk6\">/.nvm&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[ </span><span class=\"mtk7\">-s</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$NVM_DIR</span><span class=\"mtk6\">/nvm.sh&quot;</span><span class=\"mtk1\"> ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">\\.</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$NVM_DIR</span><span class=\"mtk6\">/nvm.sh&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[ </span><span class=\"mtk7\">-s</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$NVM_DIR</span><span class=\"mtk6\">/bash_completion&quot;</span><span class=\"mtk1\"> ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">\\.</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$NVM_DIR</span><span class=\"mtk6\">/bash_completion&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Add this section for shell integration AFTER nvm initialization:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Add functions to be executed when a hook is triggered.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">autoload -U add-zsh-hook</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Handle automatic Node.js version switching based on .nvmrc files.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">load-nvmrc</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Get the path of the .nvmrc file in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">local</span><span class=\"mtk1\"> nvmrc_path=</span><span class=\"mtk6\">&quot;$(nvm_find_nvmrc)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Check if an .nvmrc file was found in the current directory.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk7\">-n</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$nvmrc_path</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Get the Node.js version specified in the .nvmrc file.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">local</span><span class=\"mtk1\"> nvmrc_node_version=</span><span class=\"mtk6\">$(nvm version &quot;$(cat &quot;</span><span class=\"mtk1\">${nvmrc_path}</span><span class=\"mtk6\">&quot;)&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Check if the specified Node.js version is &quot;N/A&quot; (not installed)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$nvmrc_node_version</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;N/A&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If the specified version is not installed, use nvm to install it.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      nvm install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Check if the current Node.js version differs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># from the version specified in .nvmrc.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">elif</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$nvmrc_node_version</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$(nvm version)&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If the versions differ, use nvm to switch to the specified version.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      nvm use</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># If there is no .nvmrc file in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># but one is found in the parent directory,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># and the current Node.js version is different from the default version,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># switch back to the default version.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">elif</span><span class=\"mtk1\"> [ </span><span class=\"mtk7\">-n</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$(PWD=</span><span class=\"mtk1\">$OLDPWD</span><span class=\"mtk6\"> nvm_find_nvmrc)&quot;</span><span class=\"mtk1\"> ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;$(nvm version)&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$(nvm version default)&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Reverting to nvm default version&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    nvm use default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Add the load-nvmrc function to the &quot;chpwd&quot; hook,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># which is triggered whenever the current working directory changes.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">add-zsh-hook chpwd load-nvmrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Call the load-nvmrc function initially to set the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Node.js version based on the .nvmrc file in the current directory.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">load-nvmrc</span></span></span></code></pre>\n<p class=\"markdown-para\">With nvm shell integration in place, being on the right Node.js version is even easier, as you don't need to remember to do anything, your shell will handle all the work for you. For example, suppose you frequently toggle between two projects, one of which uses Node.js LTS and another which uses Current (18.17.0 and 20.5.0 respectively at the time of this writing), with a directory structure similar to the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ current_project</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”œâ”€â”€ .nvmrc # contains 20.5.0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â””â”€â”€ app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â      â””â”€â”€ index.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â””â”€â”€ lts_project</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â”œâ”€â”€ .nvmrc # contains 18.17.0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â””â”€â”€ app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        â””â”€â”€ index.js</span></span></code></pre>\n<p class=\"markdown-para\">Now you want to work on <code>current_project</code> but don't have that Node.js version installed. When you <code>cd</code> into the project directory, the code you added to your profile for shell integration will detect this and automatically install the correct version as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /path/to/current_project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Found &#39;/path/to/current_project/.nvmrc&#39; with version &lt;20.5.0&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Downloading and installing node v20.5.0...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Downloading https://nodejs.org/dist/v20.5.0/node-v20.5.0-darwin-arm64.tar.xz...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">######################################################################################################################################################################################################### 100.0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Computing checksum with shasum -a 256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Checksums matched!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Now using node v20.5.0 (npm v9.8.0)</span></span></span></code></pre>\n<p class=\"markdown-para\">Now if you need to switch to <code>lts_project</code> and already have that Node.js version installed, the shell integration will automatically switch to that, without attempting to install it again:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /path/to/lts_project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Found &#39;/path/to/lts_project/.nvmrc&#39; with version &lt;18.17.0&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Now using node v18.17.0 (npm v9.6.7)</span></span></span></code></pre>\n<p class=\"markdown-para\">Switching to a directory that doesn't have a <code>.nvmrc</code> file will make the shell integration code revert to the default Node.js version, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> </span><span class=\"mtk7\">~</span><span class=\"mtk1\">/Documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Reverting to nvm default version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Now using node v18.16.1 (npm v9.5.1)</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered the benefits of using <a href=\"https://github.com/nvm-sh/nvm\" class=\"markdown-link\">nvm</a> for web development. With the ability to easily manage different Node.js versions, nvm ensures a consistent environment across projects and simplifies the process of switching between versions. The use of the <code>.nvmrc</code> file supports specifying required Node.js versions per project, streamlining the setup for developers. Additionally, nvm's shell integration automates the installation and usage of specific Node.js versions, further enhancing productivity.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/consistent-node-version/"}}},{"node":{"id":"0e7236cf-2fc2-557b-a4f8-2c70b70c12c9","frontmatter":{"title":"Configurable Retry with Ruby","date":"November 2023","category":"ruby"},"excerpt":"When writing Ruby code, you may encounter a section of code that is known to fail the first time, but usually works on a repeated attemptâ€¦","html":"<p class=\"markdown-para\">When writing Ruby code, you may encounter a section of code that is known to fail the first time, but usually works on a repeated attempt. For example, when fetching data from a remote API, the request may occasionally fail due to network issues but be successful when trying the same request a second or even third time. This post will explore how to  handle such situations using Ruby's <a href=\"https://docs.ruby-lang.org/en/3.2/syntax/exceptions_rdoc.html\" class=\"markdown-link\">retry</a> keyword. Additionally, we'll delve into creating a custom module (written by my colleague <a href=\"https://www.linkedin.com/in/patryk-ptasi%C5%84ski-07941713b/\" class=\"markdown-link\">Patrick PtasiÅ„ski</a>) that extends the functionality of the built-in mechanism, providing additional enhancements and reducing boilerplate.</p>\n<h2 class=\"markdown-subtitle\" id=\"ruby-project\" style=\"position:relative;\"><a href=\"#ruby-project\" aria-label=\"ruby project permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ruby Project</h2>\n<p class=\"markdown-para\">All the code in this post is using Ruby v3.1.2. If you want to follow along with the code exercises, here is the project directory structure. This is a simple Ruby project with no Rails:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ .rspec</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ .rubocop.yml</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ .ruby-version</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ Gemfile</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ Gemfile.lock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”œâ”€â”€ file_reader.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â””â”€â”€ retryable.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ boot.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ example.txt</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â””â”€â”€ spec</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â”œâ”€â”€ retryable_spec.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â””â”€â”€ spec_helper.rb</span></span></code></pre>\n<p class=\"markdown-para\">Where <code>boot.rb</code> is used to load the code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;debug&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/file_reader&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">reload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">load</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">load</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/file_reader.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;FileReader loaded, try it out for example: FileReader.new(</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk6\">example.txt</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk6\">).read_file&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">The boot file is run when starting an irb console as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">irb -r ./boot.rb</span></span></code></pre>\n<p class=\"markdown-para\">This saves from having to manually require/load code in the console while working through the examples. You can also view the <a href=\"https://github.com/danielabar/ruby-retry\" class=\"markdown-link\">demo project</a> on Github.</p>\n<h2 class=\"markdown-subtitle\" id=\"built-in-retry\" style=\"position:relative;\"><a href=\"#built-in-retry\" aria-label=\"built in retry permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Built-in Retry</h2>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">If at first you don't succeed, try, try again.</p>\n</blockquote>\n<p class=\"markdown-para\">In Ruby, the <code>retry</code> keyword is used to repeat the execution of a block of code within a <code>rescue</code> clause. It allows you to handle and recover from exceptions by retrying the failed operation. In a web application, you would typically want to retry an external network request, but to keep the examples simple for this post, we'll be looking at some code that reads a file. There are many reasons why reading a file could fail, among them, if the file is not available on the file system.</p>\n<p class=\"markdown-para\">The <code>FileReader</code> class below is initialized with a path to a file, then attempts to read from the file using the <code>File.read</code> method, which could raise an error if the file is not available on disk:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">FileReader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file_path</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @file_path </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> file_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with file contents...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::ENOENT =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read failed, exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Loading and running this class in an irb console results in the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Assume example.txt exists in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;example.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File read successful</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Try it with a file that is not in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;does_not_exist.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File read failed, exception:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   No such file or directory @ rb_sysopen - does_not_exist.txt</span></span></span></code></pre>\n<p class=\"markdown-para\">Suppose this code is part of a bigger application with known timing issues, where a separate process is responsible for creating the file, but its possible that the first time the file is accessed, it might not have been created yet, then attempting it a second or even third time, by then its usually there. Here is one way the <code>FileReader</code> class can be enhanced to automatically retry the <code>read</code> operation if it fails up to a limited number of times:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">FileReader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  MAX_ATTEMPTS </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file_path</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @file_path </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> file_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @attempt </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with file contents...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::ENOENT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @attempt </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> MAX_ATTEMPTS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Increment attempt counter and try again,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># execution flows back to beginning of method.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      @attempt </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File not found. Retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">@attempt</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">MAX_ATTEMPTS</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)...&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Used up all the attempts, give up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File not found after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">MAX_ATTEMPTS</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> attempts.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">In the above version, if an error occurs reading the file, it incorporates a retry mechanism. If the number of attempts <code>@attempt</code> is less than the maximum allowed attempts <code>MAX_ATTEMPTS</code>, the method increments the attempt counter and uses the <code>retry</code> keyword to reattempt the file read operation. If the maximum number of attempts has been reached, it outputs a failure message indicating that the file was not found after the specified number of attempts.</p>\n<p class=\"markdown-para\">Loading this version in an irb console and trying it out we can see that when the file exists, it behaves the same as before. When the file does not exist, it makes two more attempts, then gives up if those still fail:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;example.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File read successful</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;does_not_exist.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File not found. Retrying (attempt 1 of 2)...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File not found. Retrying (attempt 2 of 2)...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File not found after 2 attempts.</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe \"retry\" method can only be used within a \"rescue\" clause, as it relies on the context of handling exceptions.\n</aside>\n<p class=\"markdown-para\">If you want to see the method succeed after a failed attempt, add a breakpoint just before the <code>retry</code>. I'm using Ruby's built-in debugger, which is available <a href=\"https://www.ruby-lang.org/en/news/2021/12/25/ruby-3-1-0-released/\" class=\"markdown-link\">without a separate gem install as of v3.1</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::ENOENT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @attempt </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> MAX_ATTEMPTS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @attempt </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File not found. Retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">@attempt</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">MAX_ATTEMPTS</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)...&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># === ADD BREAKPOINT HERE ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    debugger</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File not found after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">MAX_ATTEMPTS</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> attempts.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">When the breakpoint is reached, create the file <code>does_not_exist.txt</code> in the file system (using a separate terminal, i.e. <code>touch does_not_exist.txt</code>), then enter <code>continue</code> in the irb console to let the code continue execution. It will go back to the beginning of the method to attempt the file read again, and this time you should see the message <code>File read successful</code> printed to the console.</p>\n<h2 class=\"markdown-subtitle\" id=\"reusable-module\" style=\"position:relative;\"><a href=\"#reusable-module\" aria-label=\"reusable module permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reusable Module</h2>\n<p class=\"markdown-para\">The code in the previous section works, but there's a lot of boilerplate. Having the retry and attempt counting logic commingled with the actual business logic makes it difficult to quickly scan the method and determine what its true purpose is. Also, what if you need this logic in many methods throughout the code? What if some types of calls should only be re-attempted once and others multiple times? As currently written, the retry logic has to be repeated in every method where it's needed.</p>\n<p class=\"markdown-para\">Let's refactor by extracting the retry and attempt counting logic to a <code>Retryable</code> module that defines an instance method <code>with_retries</code>. This method uses the <a href=\"https://www.rubyguides.com/2019/12/yield-keyword/\" class=\"markdown-link\">yield</a> keyword to transfer control to a block of code that will get passed as an argument. This block of code will represent the actual operation that might raise an error. Since we don't know what kind of error might be raised, we'll rescue <code>StandardError</code> for now (we'll return to this shortly):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Initialize attempt counter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retried </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Execute block of code passed in by caller,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># eg: File.read(...)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If attempts have been exceeded, log message</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># and raise error for caller to handle.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> retried </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable failed after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> attempts, exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Increment attempt counter and try again.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Control flows back to `begin` block.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      retried </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">In the <code>rescue</code> block, the <code>retried</code> counter is checked and if it has reached the max attempt limit (hard-coded to 2 at the moment), then a message is logged and the error is raised. Otherwise, the <code>retried</code> counter is incremented and <code>retry</code> is used to execute the code in the <code>begin</code> block again.</p>\n<p class=\"markdown-para\">To use this <code>Retryable</code> module, it can be included in a class. As a result of including this module, the class now has the <code>with_retries</code> instance method, which it can call by passing a block of code that might raise an exception. The code will be retried up to 2 times before failing.</p>\n<p class=\"markdown-para\">Here's the <code>FileReader</code> modified to make use of the <code>Retryable</code> module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">FileReader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file_path</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @file_path </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> file_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    with_retries </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># do something with file contents...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Loading and running this version of the class in an irb console results in the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Assume example.txt exists in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;example.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File read successful</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;does_not_exist.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 1 of 2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 2 of 2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable failed after 2 attempts, exception:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   No such file or directory @ rb_sysopen - does_not_exist.txt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># file_reader.rb:28:in `read&#39;:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   No such file or directory @ rb_sysopen - does_not_exist.txt (Errno::ENOENT)</span></span></span></code></pre>\n<p class=\"markdown-para\">The benefit of extracting the retry logic to a module is that it cleans up the calling code, in that now it can be solely focused on its single purpose of reading a file. Also, the <code>Retryable</code> module can be easily reused by including it in any class, and wrapping any block of code that needs to be retried in the <code>with_retries</code> block.</p>\n<h2 class=\"markdown-subtitle\" id=\"flexibility\" style=\"position:relative;\"><a href=\"#flexibility\" aria-label=\"flexibility permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Flexibility</h2>\n<p class=\"markdown-para\">There are some problems with the <code>Retryable</code> module as currently written:</p>\n<p class=\"markdown-para\">It always rescues <code>StandardError</code>, but the caller may want to be more specific about which exceptions should be retried. For example, in the case of <code>File.read</code>, it could raise <code>Errno::ENOENT</code> (no such file or directory) or <code>Errno::EMFILE</code> (too many open files), which should be retried as those could get resolved in this particular application. But other errors such as <code>Errno::EISDIR</code> (is a directory) or <code>Errno::EACCES</code> (permission denied) would not get resolved on repeated attempts therefore should not be retried.</p>\n<aside class=\"markdown-aside\">\nThe \"Errno::\" exceptions in Ruby differ from the usual exceptions like \"NoMethodError\" or \"ArgumentError\" because they represent operating system errors. To delve deeper into the topic and understand why they may seem cryptic, refer to this blog post <a class=\"markdown-link\" href=\"https://www.honeybadger.io/blog/understanding-rubys-strange-errno-exceptions/\">Understanding Ruby's Strange Errno Exceptions</a> for more insights.\n</aside>\n<p class=\"markdown-para\">Another issue with the <code>Retryable</code> module is the maximum number of attempts is currently hard-coded to <code>2</code>. The caller might want to specify how many retries. For example, some use cases may require a higher number of retries such as <code>5</code>, whereas others should only be retried once.</p>\n<p class=\"markdown-para\">It would be nice if the <code>with_retries</code> method could accept some arguments where the caller could specify a list of exceptions that should be retried, and an options hash to specify the number of retries, like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::ENOENT, </span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::EMFILE, </span><span class=\"mtk4\">limit:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">In order to support this flexibility, the <code>with_retries</code> method in the <code>Retryable</code> will be modified to accept some arguments. We'll use the splat operator for the parameter <code>*args</code>, which will allow the <code>with_retries</code> method to accept a variable number of arguments as an array. The <a href=\"https://api.rubyonrails.org/classes/Array.html#method-i-extract_options-21\" class=\"markdown-link\">extract_options!</a> method from ActiveSupport will be used to assist in parsing out the array/options.</p>\n<p class=\"markdown-para\">The splat operator will also be used in the rescue clause, to expand the <code>*exceptions</code> array into multiple arguments, each one being an individual exception that should be retried.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;active_support/all&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">*</span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Remove and return last element in args if it&#39;s a hash,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># otherwise returns a blank hash, for example:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># { :limit =&gt; 2 }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args.</span><span class=\"mtk5\">extract_options!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># What&#39;s left of the args array will be an array of exceptions,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># for example: [Errno::ENOENT, Errno::EMFILE]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Set a default number of retries if caller did not specify.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Default exceptions to handle if caller has not provided any</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [StandardError] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> exceptions.</span><span class=\"mtk5\">empty?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retried </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\">exceptions =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> retried </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable failed after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> retry(ies), exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      retried </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\n<a class=\"markdown-link\" href=\"https://guides.rubyonrails.org/active_support_core_extensions.html\">ActiveSupport</a> provides many Ruby language extensions and utilities. It's installed automatically for Rails projects, but it can be used outside of Rails by specifying it in the Gemfile as \"gem 'activesupport'\", and then requiring it at the top of the module.\n</aside>\n<p class=\"markdown-para\">Another feature that would be useful when retrying is the ability to specify a timeout. That is, the caller might want to specify a time limit on each attempt such as \"if there are no results within 2 seconds, try again. This can be done with Ruby's <a href=\"https://docs.ruby-lang.org/en/3.2/Timeout.html\" class=\"markdown-link\">Timeout</a> module, which provides a way to halt a long running operation if it hasnâ€™t finished in a fixed amount of time.</p>\n<p class=\"markdown-para\">Below is a modified version of the <code>Retryable</code> module that supports a <code>timeout_in</code> option, and if specified, wraps the <code>yield</code> execution in a <code>Timeout.timeout</code> block, with the <code>timeout_in</code> value provided by the caller. We also add <code>Timeout::Error</code> to the list of default exceptions to handle:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;active_support/all&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;timeout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">*</span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args.</span><span class=\"mtk5\">extract_options!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Default exceptions to handle if caller has not provided any</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [StandardError, </span><span class=\"mtk9 mtki\">Timeout</span><span class=\"mtk1\">::Error] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> exceptions.</span><span class=\"mtk5\">empty?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retried </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If caller has provided a `timeout_in` option,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># wrap the execution in a timeout block:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:timeout_in</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Timeout</span><span class=\"mtk1\">.</span><span class=\"mtk5\">timeout</span><span class=\"mtk1\">(options[</span><span class=\"mtk4\">:timeout_in</span><span class=\"mtk1\">]) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Otherwise, execute the code as before:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\">exceptions =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> retried </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable failed after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> retry(ies), exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      retried </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">To try this out, modify the <code>FileReader#read_file</code> method to call <a href=\"https://docs.ruby-lang.org/en/3.2/Kernel.html#method-i-sleep\" class=\"markdown-link\">sleep</a> to simulate a slow operation. For this example, we'll have <code>with_retries</code> use defaults for the other options so it will retry 3 times, and handle <code>StandardError</code> and <code>Timeout::Error</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">FileReader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file_path</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @file_path </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> file_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Specify we should only wait 2 seconds before retrying.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk4\">timeout_in:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Simulate a slow operation by pausing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># current thread for 3 seconds.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">sleep</span><span class=\"mtk1\">(</span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful!&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now running this version in an irb console will show that it attempts 3 times (waiting 2 seconds each time), then raises a timeout error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;example.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_slow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 1 of 3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 2 of 3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 3 of 3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable failed after 3 retry(ies), exception: execution expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/file_reader.rb:29:in `sleep&#39;: execution expired (Timeout::Error)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   from app/file_reader.rb:29:in `block in read_slow&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   from app/retryable.rb:50:in `block in with_retries&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   from app/retryable.rb:49:in `with_retries&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   from app/file_reader.rb:28:in `read_slow&#39;</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"tests\" style=\"position:relative;\"><a href=\"#tests\" aria-label=\"tests permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tests</h2>\n<p class=\"markdown-para\">We're not quite finished, the Retryable module also needs tests. I'll be using <a href=\"http://rspec.info/\" class=\"markdown-link\">RSpec</a>. At first it looks tricky to test because it needs to be included in a class in order to invoke the <code>with_retries</code> method. So it might seem like the only way to test it would be to test the <code>FileReader</code> class that uses it. However, we can use Ruby's <a href=\"https://docs.ruby-lang.org/en/3.2/Module.html#method-i-module_function\" class=\"markdown-link\">module_function</a> to make any method in a module callable on the module, in addition to being an instance method on any class the module is included in.</p>\n<p class=\"markdown-para\">Here is the modified <code>Retryable</code> module that adds the <code>with_retries</code> method as a method that can be invoked directly on the module like <code>Retryable.with_retries(...)</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;active_support/all&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;timeout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">*</span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># === EXPOSE THIS METHOD DIRECTLY ON THE MODULE ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">module_function</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:with_retries</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now the module can be set as the <code>described_class</code> with RSpec, and invoked as <code>described_class.with_retries(...)</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/retryable_spec.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">RSpec</span><span class=\"mtk1\">.</span><span class=\"mtk5\">describe</span><span class=\"mtk1\"> Retryable </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;.with_retries&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;executes the code block without retrying if no exception is raised&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect { described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\"> { </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Executing code&quot;</span><span class=\"mtk1\"> } }.</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">output</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Executing code</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to_stdout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;retries the code block if a specified exception is raised&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      counter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(ZeroDivisionError, </span><span class=\"mtk4\">limit:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        counter </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> ZeroDivisionError </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> counter </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(counter).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk4\">4</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;raises an exception if the retry limit is exceeded&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(ZeroDivisionError, </span><span class=\"mtk4\">limit:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> ZeroDivisionError</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span><span class=\"mtk1\">.</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">raise_error</span><span class=\"mtk1\">(ZeroDivisionError)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;retries the code block with default options if no arguments are provided&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      counter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        counter </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> StandardError </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> counter </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(counter).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;retries the code block with a timeout if timeout_in option is provided&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      counter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk4\">timeout_in:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        counter </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">sleep</span><span class=\"mtk1\">(</span><span class=\"mtk4\">2</span><span class=\"mtk1\">) </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> counter </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(counter).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"documentation\" style=\"position:relative;\"><a href=\"#documentation\" aria-label=\"documentation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Documentation</h2>\n<p class=\"markdown-para\">The last thing to do before calling this feature done is to add some documentation. Fortunately ChatGPT can help out with this. I asked it to generate <a href=\"https://ruby.github.io/rdoc/\" class=\"markdown-link\">RDoc</a> comments for the <code>Retryable</code> module and here is what it came up with:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;active_support/all&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;timeout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Retries the execution of a block of code with retry logic.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @param [Array&lt;Exception&gt;] args The list of exceptions that should trigger a retry.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @param [Hash] options The options for retrying the code block.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @option options [Integer] :limit (3) The maximum number of retry attempts after initial run.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @option options [Integer] :timeout_in The maximum time in seconds to wait for each retry attempt.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @yield The block of code to be executed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @example Retry the code block with a specific exception and a custom limit:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   Retryable.with_retries(Errno::ENOENT, limit: 5) do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # Code to be retried if Errno::ENOENT is raised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @example Retry the code block with default exceptions and a timeout:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   Retryable.with_retries(limit: 3, timeout_in: 10) do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # Code to be retried if StandardError or Timeout::Error is raised,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # with a maximum of 3 retries and a timeout of 10 seconds.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @example Retry the code block with default options:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   Retryable.with_retries do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # Code to be retried if StandardError or Timeout::Error is raised,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # with a maximum of 3 retries and no timeout.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @example Retry the code block with multiple exceptions:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   Retryable.with_retries(Errno::ECONNRESET, Errno::ETIMEDOUT, limit: 5) do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # Code to be retried if Errno::ECONNRESET or Errno::ETIMEDOUT is raised,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # with a maximum of 5 retries and no timeout.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">*</span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args.</span><span class=\"mtk5\">extract_options!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [StandardError, </span><span class=\"mtk9 mtki\">Timeout</span><span class=\"mtk1\">::Error] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> exceptions.</span><span class=\"mtk5\">empty?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retried </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:timeout_in</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Timeout</span><span class=\"mtk1\">.</span><span class=\"mtk5\">timeout</span><span class=\"mtk1\">(options[</span><span class=\"mtk4\">:timeout_in</span><span class=\"mtk1\">]) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\">exceptions =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> retried </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable failed after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> retry(ies), exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      retried </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">module_function</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:with_retries</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered an introduction to Ruby's built-in <code>retry</code> mechanism and the development of a flexible <code>Retryable</code> module. This module provides code re-use for the retry logic with flexibility to specify which exception classes should be handled, how many times the code should be retried, and whether it should timeout after some period of time. Finally we covered testing and documentation. The development of this module was inspired by this post on <a href=\"https://scoutapm.com/blog/ruby-retry\" class=\"markdown-link\">Ruby retry</a> and this <a href=\"https://gist.github.com/cainlevy/1323593/2321056de18e63436e66562e218a631d32077a20\" class=\"markdown-link\">Github gist</a>, check them out for further reading on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/ruby-configurable-retry/"}}}]}},"pageContext":{}},"staticQueryHashes":["163244226"],"slicesMap":{}}