{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":18,"edges":[{"node":{"id":"9d0929c0-f756-50af-bb64-9c93f51f913d","frontmatter":{"title":"TDD by Example","date":"January 2021","category":"javascript"},"excerpt":"If you've been coding for any length of time, you've probably heard that you should test your code, and by that I mean writing automatedâ€¦","html":"<p>If you've been coding for any length of time, you've probably heard that you should test your code, and by that I mean writing automated tests. This can be challenging at first, but with some practice, it becomes easier. When first learning to write tests, it's easier to have already written the production code, then open up another editor tab side by side with that code, and write some tests against that code. However, there's another approach to writing tests called <a href=\"https://en.wikipedia.org/wiki/Test-driven_development\">Test Driven Development</a>, aka TDD. According to Wikipedia, TDD is:</p>\n<blockquote>\n<p>A software development process relying on software requirements being converted to test cases before software is fully developed, and tracking all software development by repeatedly testing the software against all test cases. This is opposed to software being developed first and test cases created later.</p>\n</blockquote>\n<p>In practice what this means is, suppose you want to add a new feature to some software. You would first write a test for that feature and run the test. The test would fail since the new feature hasn't been written yet. Then you write just enough code to get that test to pass. When it passes, then you add another test for this feature, run it to see that it fails, write more code to get this to pass, and continue until the feature is complete. Typically the first test you write would be for the \"happy path\", then next test would be for an edge case such as invalid input and so on.</p>\n<p>This is much harder to do because you don't have the actual code to look at, instead you have to picture what the result of the code should be and write a test to expect that result. In fact, this is the benefit of TDD. You end up with tests that verify the results of the code, rather than implementation details. But the first time you try this, it can be difficult to know where to start.</p>\n<p>This post will walk you through an example of using TDD that I did recently to add a new feature to <a href=\"https://github.com/danielabar/tidysum\">Tidysum</a>. I will assume that you already know how to write tests generally, but are new to TDD specifically.</p>\n<p>First, what is Tidysum? Tidysum is a personal finance app that takes in a list of daily expenses and outputs a summary json file with year and month breakdowns of these expenses by category, showing total and average spending per month and per year, and makes savings and spending recommendations. It's written as an npm module and runs as a CLI. The feature I added was a percentage difference calculation for total and by-category spending year over year. The idea is to calculate a personalized rate of inflation based on your actual spending, rather than some theoretical basket of goods determined by government bureaucrats.</p>\n<p>Aside: I was inspired to add this after learning from several finance podcasts that the official government inflation numbers may not reflect reality as they don't include food and energy. As some government benefits are indexed to inflation, as are many employers' annual cost of living increases, it may benefit some to have this number reported as lower than it really is. The inflation number is also used in personal finance for retirement planning and so can be disastrous if incorrect. Of course there's nothing I can do about the big macro, but as a developer, I can improve my software to generate more personalized information to help inform better decision making.</p>\n<p>Ok back to TDD. Tidysum reads in a csv file of expenses like this (abbreviated, but imagine this goes on for several years):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"csv\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-01-01,...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-10-01,34.29,Groceries,Loblaws</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-10-01,133.99,Restaurant,The Keg</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-10-04,5.99,Entertainment,Amazon</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-10-15,54.00,Groceries,Loblaws</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-11-15,11.67,Health,Loblaws</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2019-10-15,120,Groceries,Loblaws</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2019-10-20,20,Restaurant,Dominos</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2019-10-25,10.00,Entertainment,Apple</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2019-11-10,12.49,Health,Whole Foods</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2020-12-24,...</span></span></code></pre>\n<p>And generates a summary json where each key is the year. Each year shows the total spending for that year, and then has another object where each key is the month in that year. Each month shows total spending for that month, as well as the breakdown by category and by merchant.</p>\n<p>Each year also has an <code>average</code> section, where it shows on average how much was spent each month, and again, an average breakdown by category. The summary looks something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;2018&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;239.94&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Oct&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;228.27&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;88.29&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;133.99&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.99&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;88.29&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;The Keg&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;133.99&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Amazon&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.99&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Nov&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;average&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;monthly&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;119.97&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;44.15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;67.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;3.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.84&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;2019&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;162.49&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Oct&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;150&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;120&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;20&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;120&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Dominos&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;20&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Apple&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Nov&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Whole Foods&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;average&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;monthly&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;81.25&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;60.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;6.25&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>What I wanted to add was another per year entry to show the percentage difference in total and per category spending as compared to the previous year, like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;2018&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;239.94&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Oct&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;228.27&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;88.29&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;133.99&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.99&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;88.29&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;The Keg&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;133.99&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Amazon&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.99&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Nov&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;average&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;monthly&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;119.97&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;44.15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;67.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;3.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.84&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;percentageDiffPreviousYear&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;N/A&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;2019&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;162.49&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Oct&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;150&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;120&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;20&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;120&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Dominos&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;20&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Apple&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Nov&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Whole Foods&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;average&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;monthly&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;81.25&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;60.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;6.25&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;percentageDiffPreviousYear&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;-32.28&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;35.9&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;-85.07&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;66.67&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;7.02&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>So for the first recorded year, <code>percentageDiffPreviousYear</code> would be <code>N/A</code> because there's nothing to compare it to. Then for the following year, it should calculate percentage difference in total and by category spending as compared to the previous year.</p>\n<p>This kind of problem lends itself very well to TDD because the desired output is exactly known. And this is exactly what goes in the tests.</p>\n<p>Ok let's get into the code. Recall this project already exists and most of the code is already written. The processing of the file happens in a function named <code>processFile</code> in the <code>lib/expense.js</code> module. It first generates the <code>expenseSummary</code> by reading the expense csv line by line. then it goes over the expense summary to add in the averages - this part is delegated to a <code>calculator</code> module in a method named <code>calcAvg</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/expense.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> calculator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./calculator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> recommendation </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./recommendation&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other imports...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">mothlyIn</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">fixedExp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Read input csv of expenses to generate summary json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Enhance the json summary with averages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummaryWithAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> calculator.</span><span class=\"mtk5\">calcAvg</span><span class=\"mtk1\">(expenseSummary);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (mothlyIn </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> fixedExp) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    recommendation.</span><span class=\"mtk5\">determine</span><span class=\"mtk1\">(expenseSummaryWithAvg, mothlyIn, fixedExp);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// TODO: Further enhance json summary - Calculate percentage diff year over year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummaryWithAvg;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use csv-streamify to stream in input csv and generate expense summary json object</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Details are not relevant for this post, see project on github for complete code.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// rest of functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  process,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>My thought was after the averages have been added to the expense summary, it would be a good time to further process <code>expenseSummaryWithAvg</code> to add the percentage differences. Since the average calculation is delegated to the calculator module, it makes sense to delegate percentage difference calculation to this module as well. So it will look something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">mothlyIn</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">fixedExp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummaryWithAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> calculator.</span><span class=\"mtk5\">calcAvg</span><span class=\"mtk1\">(expenseSummary);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (mothlyIn </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> fixedExp) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    recommendation.</span><span class=\"mtk5\">determine</span><span class=\"mtk1\">(expenseSummaryWithAvg, mothlyIn, fixedExp);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEW LINE ADDED HERE:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> withYearlyDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> calculator.</span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(expenseSummaryWithAvg);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> withYearlyDiff;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2>Calculator Tests</h2>\n<p>Now instead of jumping in to add a new method <code>calcYearlyDiff</code> to the calculator module and implement it, this is where the TDD approach will come in. Let's first add a test to specify what should be the expected output of this method. This project uses the <a href=\"https://mochajs.org/\">Mocha</a> test framework and <a href=\"https://www.chaijs.com/api/assert/\">Chai</a> for assertions, but TDD principles can be used with any testing library.</p>\n<p>Here is the existing calculator module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"javascript\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcAvg</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// existing logic...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  calcAvg,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And the existing calculator tests:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"javascript\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/calculator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> calculator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/calculator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcAvg&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tests for existing calcAvg method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>We know the calculator module needs to have a new method <code>calcYearlyDiff</code> so let's add a test for that. The style I'm following is a <code>describe</code> block for each method in the module, and an <code>it</code> test for each condition of the method to be tested:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/calculator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> calculator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/calculator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcAvg&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tests for existing calcAvg method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcYearlyDiff&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculates percentage difference in total and categories compared to previous year&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// do test things here!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>So what should go in the test body? I like to follow the <a href=\"https://martinfowler.com/bliki/GivenWhenThen.html\">GivenWhenThen</a> approach. Just about every test can be expressed as \"Given\" a certain set of inputs, \"When\" the system under test is invoked, \"Then\" expect certain results.</p>\n<p>In this case, the input to the <code>calcYearlyDiff</code> method will be the expense summary json object which contains a key for each year, then each year having total and average by category spending. The system under test is the <code>calcYearlyDiff</code> method in the calculator module. The expected result is a modified expense summary object having an additional property <code>percentageDiffPreviousYear</code>, which itself is an object containing percentage differences for total spending, and for each category.</p>\n<p>Let's express this in a test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcYearlyDiff&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculates percentage difference in total and categories compared to previous year&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Given total spending increase of 25%, grocery spending increase of 11.11% and gift spending decrease of 20%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> summary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;2019&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total: </span><span class=\"mtk6\">&#39;20000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gifts: </span><span class=\"mtk6\">&#39;100&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;2020&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total: </span><span class=\"mtk6\">&#39;25000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gifts: </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedSummaryWithDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;2019&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total: </span><span class=\"mtk6\">&#39;20000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gifts: </span><span class=\"mtk6\">&#39;100&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        percentageDiffPreviousYear: </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;2020&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total: </span><span class=\"mtk6\">&#39;25000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gifts: </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        percentageDiffPreviousYear: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;25&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          groceries: </span><span class=\"mtk6\">&#39;11.11&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          gifts: </span><span class=\"mtk6\">&#39;-20&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// When calculator function calcYearlyDiff is invoked</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> calculator.</span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(summary);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Then expect result to contain `percentageDiffPreviousYear` as shown in `expectedSummaryWithDiff`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">eql</span><span class=\"mtk1\">(expectedSummaryWithDiff);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>The amazing this is all this can be written without knowing yet how the <code>calcYearlyDiff</code> function will be implemented. In fact we don't care about implementation at this point, the only thing that matters is expressing what the function should return given a certain input.</p>\n<p>Next step is to run the tests, this project uses npm scripts with the test script defined to run mocha as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// package.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;scripts&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;test&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;NODE_ENV=test mocha test/**/*.test.js&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Tests are run by entering the <code>npm test</code> command in a terminal. At this point, the newly added test will fail with the following error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">1) calculator</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  calcYearlyDiff</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    calculates percentage difference in total and categories compared to previous year:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TypeError: calculator.calcYearlyDiff is not a function</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> at Context.it (test/lib/calculator.test.js:96:33)</span></span></code></pre>\n<p>This is expected as we haven't yet touched the calculator module. Let's change that now by adding an empty function definition and exporting it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// TODO...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  calcAvg,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  calcYearlyDiff,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>Running the tests again <code>npm test</code> results in a different error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">1) calculator</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  calcYearlyDiff</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    calculates percentage difference in total and categories compared to previous year:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">AssertionError: expected undefined to deeply equal { Object (2019, 2020) }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> at Context.it (test/lib/calculator.test.js:98:25)</span></span></code></pre>\n<p>Again, this is expected because the function has no implementation, it implicitly returns <code>undefined</code>, which does not match the <code>expectedSummaryWithDiff</code> the test expects.</p>\n<h2>Calculator Implementation</h2>\n<p>Ok, NOW we're ready to write some implementation in the calculator module. This solution iterates over each year in the <code>expenseSummary</code> using <code>Object.entries(obj)</code> which returns an array of key/value pairs of the given object, and then <code>forEach</code> to loop over these.</p>\n<p>For each year, find the previous year in the object, if it's not found, set the current year's <code>percentageDiffPreviousYear</code> to <code>N/A</code> because there's nothing to compare to. Otherwise calculate percentage difference between the current year's total spending to previous years total spending and save this in the <code>percentageDiffPreviousYear.total</code> property of the current year. And then iterate over each average by category spending for current year, calculate its percentage difference relative to previous year, and save it in the <code>percentageDiffPreviousYear[curCategory]</code> property of the current year.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ((yearSummary.total </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\"> </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((curAvg </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\"> </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Now running the test results in a different failure, the returned object is not quite as expected.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1092c7575efc0803f4399221d0a2c997/5205c/tdd-fail-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.0984393757503%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABGElEQVQoz5VS2W7DMAzrb2w5fMZxHDtu06Ybhv3/b3FSjsLDBqx7oClaAi0JPkltEfMZbx+fxBco69AqA6EZFq3Uqy6x3he6oZq6lWiEwokDazrcLzcs1wUpTcgpI40JU5wQfEAMIwIhT5niSHxemZFiWmvYjL1WQ20MTHBwWiNTopcKlrjb4QhGyG+xK/I9oT0MGzoqEo3t8NIKVI3AK6Hi+wI11Tx0GR/5Y2Q+2GQcJyzLO+brHTnPiDR2P4wQvKO9+C9sHe6BNha3+UzGAX4Y4EkHWraT6vH6/wxdD3+b4VKCcA61Uj86e8b4YeiHCOf8OrrtPKq6pb1tu6mLHZXxr4ac5D0p+jrMDEnjsuY/ylBm42c6/ALWofuqMGgXbAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 1\"\n        title=\"tdd fail 1\"\n        src=\"/static/1092c7575efc0803f4399221d0a2c997/5a190/tdd-fail-1.png\"\n        srcset=\"/static/1092c7575efc0803f4399221d0a2c997/772e8/tdd-fail-1.png 200w,\n/static/1092c7575efc0803f4399221d0a2c997/e17e5/tdd-fail-1.png 400w,\n/static/1092c7575efc0803f4399221d0a2c997/5a190/tdd-fail-1.png 800w,\n/static/1092c7575efc0803f4399221d0a2c997/5205c/tdd-fail-1.png 833w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Well we've made some progress as the gifts and total percentage calculations are correct. But notice the color coding for expected (green) vs actual (red) results. If the result of the calculation is a decimal, we only want to see two decimals of precision. Currently there's no rounding or truncation so results are not as expected.</p>\n<p>Let's fix the code to make the test pass. To get the desired decimal precision, will use <code>Math.round(num * 100) / 100</code> where <code>num</code> is the percentage difference calculation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> totalDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((yearSummary.total </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> totalDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(totalDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> totalDiffRounded </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((curAvg </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(categoryDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And now the test passes - yay!</p>\n<p>At this point, you may have noticed two things: 1) The percentage difference calculation is repeated in two places - once for the total difference, and again in the loop for each category. And 2) this code is getting messy, especially once the rounding logic is added. At this point, it might be tempting to refactor, but let's hold off for now until all the tests are in place. The goal here is to get all the functionality working, then we can refactor to make improvements.</p>\n<h2>Detect New Categories</h2>\n<p>One more feature this code needs to support is detection of new categories. For example, suppose you purchased some vitamins in 2020, but didn't purchase any in 2019. In this case we can't calculate the percentage difference in vitamin spending because there's nothing to compare it to.  In this case, the code should simply display <code>new category</code>. Let's define this behavior in a new test. Again, this is TDD, we write the test before implementing the requirement:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/calculator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> calculator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/calculator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcAvg&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// existing tests for calcAvg function...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcYearlyDiff&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculates percentage difference in total and categories compared to previous year&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// test we just wrote...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Our new test here:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;detects a new category in the current year&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> summary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;2019&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;20000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              groceries: </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;2020&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;25000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              groceries: </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              vitamins: </span><span class=\"mtk6\">&#39;90&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedSummaryWithDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;2019&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;20000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              groceries: </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          percentageDiffPreviousYear: </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;2020&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;25000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              groceries: </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              vitamins: </span><span class=\"mtk6\">&#39;90&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          percentageDiffPreviousYear: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            total: </span><span class=\"mtk6\">&#39;25&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;11.11&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vitamins: </span><span class=\"mtk6\">&#39;new category&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      calculator.</span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(summary);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(summary).to.</span><span class=\"mtk5\">eql</span><span class=\"mtk1\">(expectedSummaryWithDiff);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Now when we run the calculation tests, the first test that we wrote earlier passes, but the newly added test fails:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 798px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f00ad508e984f49fa04c96e54beb3076/898f6/tdd-fail-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.80200501253132%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAABmklEQVQ4y42TWXIDIQxEfY14DANiGWbxmqVS+Ulluf+VOi3GdlxJyvHHMzIDTUuCRUgddocHdMME6wMa67AkzQ9WN2Baj0UrEfv7Bzw/PmG73iLFhJJyHXPMiPyeQoKECOF/rzHHGovOpTpnnVTRhZ5uVhbJtAiMMz8MdJo45iMdEWKIdb5uVtTRaVSqoBFBO3awOZ1TbvjxnG6N/e0pC21vyoCSS51o6FZZ0XFzwWnDNapDdTVs93h9/8Tj8wvKuEbuRwibFXhI7HpEHuhYp7lZ/lfDTlSHerow2PQDJgqsKbAfJ4yMJ8aKZtCz+FJr7BG5PpD0g7mG/PEpwo4ZzrUoSwPfGBjSEscDvaLrjkJyJFwgZ0EGS27QNEemrpRpg2GzQ8f0LWv8q1HXUq6NoGDHtD7fPvDCOh52B0wUE5nvl7mhIebSYYW1yWNh+gGBNCXhrkvn7q5uEPx2yE09HUU2o9/uKDyh8Vwg4U8XVwV1gWOdFMsJx2vU6jPSu2f+vrzXRGdBiuibPAl/v9f5nXq+48D/Ldf95/ALQOmFGO/mr3kAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 2\"\n        title=\"tdd fail 2\"\n        src=\"/static/f00ad508e984f49fa04c96e54beb3076/898f6/tdd-fail-2.png\"\n        srcset=\"/static/f00ad508e984f49fa04c96e54beb3076/772e8/tdd-fail-2.png 200w,\n/static/f00ad508e984f49fa04c96e54beb3076/e17e5/tdd-fail-2.png 400w,\n/static/f00ad508e984f49fa04c96e54beb3076/898f6/tdd-fail-2.png 798w\"\n        sizes=\"(max-width: 798px) 100vw, 798px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Again this makes sense because vitamin spending for 2019 doesn't exist therefore the line to retrieve the previous years category average will return <code>undefined</code>. Then trying to use <code>undefined</code> in a calculation results in <code>NaN</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// When `curCategory` is &#39;vitamins&#39;, `prevAvg` will be undefined</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((curAvg </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;    </span><span class=\"mtk3\">// NaN</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(categoryDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;   </span><span class=\"mtk3\">// NaN</span></span></span></code></pre>\n<p>Now that the test is in place, we can enhance the code to handle this case. The solution is to first check if the previous years average exists. If it doesn't, then output <code>new category</code>, otherwise, go ahead and run the percentage difference calculation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> totalDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((yearSummary.total </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> totalDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(totalDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> totalDiffRounded </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">prevAvg) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;new category&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((curAvg </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(categoryDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This time both tests should pass.</p>\n<p>But we're not done yet. Remember earlier I pointed out several issues with this code - the same percentage difference calculation is written twice, and overall code is getting messy. This code is both iterating the expense summary and doing some mathematical calculations. Now that we've got all the percentage difference feature covered by tests, we can tackle a refactor to fix these issues.</p>\n<h2>Refactoring Calculation</h2>\n<p>This project actually has another module <code>lib/decimal-util.js</code> to perform all numeric calculations. This module uses the <a href=\"https://github.com/MikeMcl/decimal.js/\">decimal.js</a> library. I was looking for something similar to <a href=\"https://docs.oracle.com/en/java/javase/15/docs/api/java.base/java/math/BigDecimal.html\">BigDecimal</a> in Java to avoid some Javascript known issues with decimal calculations. The decimal-util module would be a perfect place for the percentage difference calculation to live. Then the calculator module could simply make use of it wherever needed. Here's what I'm picturing:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// This module is already imported because its used in other functions in the calculator module</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other imports and functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// NEW: Use decimal-util module for percentage diff calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(expenseSummary[prevYear].total, yearSummary.total);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">prevAvg) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;new category&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// NEW: Use decimal-util module for percentage diff calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prevAvg, curAvg);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Now running the tests will fail:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4ab940436d77bc3aaa0fb0f79c6be3c9/d4c13/tdd-fail-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.81818181818181%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAABi0lEQVQ4y41SW1LDMAzsOWhi5+HYjvMuMDCUtsP9D7WsnKSEDmX6sbOyLW2kVXZ5adBPB/i2hyoMnlQWsd/wI0iIVOfYpVmB537EaTzgpW4QeNnxriFawmc5arLTN8x7y9gvLGIiuttrKqcaloeKkEQRkiS3FAhyxnpBtolXXAVVUSAPFqoySHQxj8zH/Qo1c/IAUhHM8hJd22Gij8bV8WHPjqM3K69+8pxs+BbRQxGoKXQ5nnA+fuKVwgMXNHUDDsOEhr62ocXQdBiGEYFv3cI17xrm1U0LRZtmD8U3bre1DqFy6J1HXwcMPsSzNxaurNAwNmRZovoDP0th+5qCNjSoKCLs2NF8rlFaTzgU5LXoHuLImh5aFnqOllE4XTamsnz+up5Z8lbBNWeLq6AkB3pxvnzh7f0jxo6dGhmRqOivQC8e/ScaBaOH8nOzw4Gdys/9SqPlPIqXshDGvYy9Eb0rKAklO5GNORYKPEUEhr4VXErOZUgsYz8kKImlFNJDKS5MtbD9FasHOvwG+G1tZvobWyQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 3\"\n        title=\"tdd fail 3\"\n        src=\"/static/4ab940436d77bc3aaa0fb0f79c6be3c9/5a190/tdd-fail-3.png\"\n        srcset=\"/static/4ab940436d77bc3aaa0fb0f79c6be3c9/772e8/tdd-fail-3.png 200w,\n/static/4ab940436d77bc3aaa0fb0f79c6be3c9/e17e5/tdd-fail-3.png 400w,\n/static/4ab940436d77bc3aaa0fb0f79c6be3c9/5a190/tdd-fail-3.png 800w,\n/static/4ab940436d77bc3aaa0fb0f79c6be3c9/d4c13/tdd-fail-3.png 825w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The reason both tests are failing now is because it's trying to invoke a function <code>decimalUtil.percentDiff(...)</code> that doesn't exist. The solution to this is to add the <code>percentDiff</code> function to the <code>decimal-util</code> module, write the implementation and export it. But wait, we're doing this TDD style. So before writing any implementation, let's write a test, this time for the decimal util module.</p>\n<p>Here's the existing decimal util module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/decimal-util.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> Decimal </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimal.js&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">divideAndRound</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">numeratorIn</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">denominatorIn</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> numerator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(numeratorIn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> denominator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(denominatorIn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> numerator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">dividedBy</span><span class=\"mtk1\">(denominator)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">toFixed</span><span class=\"mtk1\">(</span><span class=\"mtk4\">2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">toString</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">sum</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">in1</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">in2</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> in1Dec </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(in1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> in2Dec </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(in2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> in1Dec.</span><span class=\"mtk5\">plus</span><span class=\"mtk1\">(in2Dec).</span><span class=\"mtk5\">toString</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// more functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  divideAndRound,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  sum,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And the existing decimal util tests:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/decimal-utils.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimalUtil&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;divideAndRound&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tests for divideAndRound function...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// tests for other functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Looking at the refactored calculator module, we need a method in decimal util <code>percentDiff</code> that takes two numbers - a previous and current, and returns the percentage difference between them. If the current value is greater than previous, we expect a percentage increase. If current value is less than previous, we expect a percentage decrease. If they are the same, then percentage difference should be 0. Finally, if the result is not an integer, it should round to two decimal places. That's 4 different requirements, let's define all of these as tests:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/decimal-utils.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimalUtil&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;divideAndRound&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tests for divideAndRound function...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEW: Tests for percentDiff function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;percentDiff&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Returns percentage increase when current is greater than previous&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prev </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> cur </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;100&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prev, cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;25&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Returns percentage decrease when current is less than previous&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prev </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;100&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> cur </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prev, cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;-20&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Returns 0 when current is the same as previous&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prev </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> cur </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prev, cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;0&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Rounds to 2 decimal places&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prev </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> cur </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prev, cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;11.11&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Running the decimal util tests now will result in all of them failing because we haven't yet defined the function:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 657px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/892bf0fdcec84991ea71737850cde681/a1253/tdd-fail-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 101.67427701674276%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACiUlEQVQ4y42UaXLbMAyFfYomtbVQFmUt1L5ajqs4nU5z/xOhDyxpKx57Jj8+gSsIAo/ahFFMbT9QA2Sc0s71yfEDcjzxlN2Tvot9Gz8IqesGeptmaquGhC9ojwkmWFlh2j4ITdsSmnF2umHvARgxMIo9jTjgZOD2ZNoDOIIaa6xtzPoK1rMO+cMn8KLZTM7GES/mTSnIwAHrFGxkNrMTb5UefWXO187kwbWTsO6KLca2Zs32QQ7teh2hK0PyVUwijykIIwr28rrI4n4T7VAEeyqSlOokozA63KLkiA3ON9FX9pCntKhofr/QGSSqoB2fiFw5BneFHfMAK8QzbfdLlaG9uW5pHiaamo5ObU8T6MuajuiPoMahPdaUaUYzZFagn2O+qGqqMM96Zg1rhyFOyJG/hEEOC0yqQ0IlhF6BFH0mQUoykB+Qb0Rnr2mj01cWcJBD0PUwUoWofDj9sXPp1fE0L8b+tBZRsN2u4MhuVWa1ywOdzwst7x/UwGmGPKq8pDTLKWPQj1E0tpIjTRXFBoWrS9zmGiFfWYIJle6weVA5/ULEMzghP2fYCZs6OOthWzg+8mGw/PbZOQd0qzIrHxN8Cif2kbidlejXYw+vzKXPcPJpudDb8l82zkoiWkJYc5UOF4PnVs6/FEVXGVz6kZbjDMl0tHQ9HSGRU9MiBQXNGJtAi4PPKB6nwHvyivTPIeCHjxcjcbpEm+UTIy8slQxEUIJkQqnbMebFnWyuDlk2CgKt8IMtIVABRy93srE/D435WTzKq3bIHwknfz5+0+ffT2pQ1QYH1PwCcDVGYJNvEAbXFu7eoZYNGi1eQBknVMiIBkihBX2mdFvhiqlG6hdVIoAg2D+88j8SlDia3a/pFwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 4\"\n        title=\"tdd fail 4\"\n        src=\"/static/892bf0fdcec84991ea71737850cde681/a1253/tdd-fail-4.png\"\n        srcset=\"/static/892bf0fdcec84991ea71737850cde681/772e8/tdd-fail-4.png 200w,\n/static/892bf0fdcec84991ea71737850cde681/e17e5/tdd-fail-4.png 400w,\n/static/892bf0fdcec84991ea71737850cde681/a1253/tdd-fail-4.png 657w\"\n        sizes=\"(max-width: 657px) 100vw, 657px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Same drill as last time, first step to fix this is to define the function in the decimal util module and export it so it's visible:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/decimal-util.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> Decimal </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimal.js&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">prev</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">cur</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Implementation TBD...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  percentDiff,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>Results of running the tests again at this point should surprise no one - they all fail comparing <code>undefined</code> to the expected calculation. Just like when we started the TDD process in the calculator module, an empty function implicitly returns undefined:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 646px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3afcbbd8fbe99b8d32d408d2856d6546/27524/tdd-fail-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.40557275541795%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAACpUlEQVQ4y5WVaVLbQBCFdQ3bsvbd2jeMbSgXBEhy//t03hvNEEc4VcmPj26N2r2pe7DCOJFxPsr4cJS8rGXneJ/Yd3R7dX7L3vXFcrxA+n6UC5zO/SCRH0qEFyTQkvg3ZyQBsT6LNQxk0bNnOzI6rhxx+ACHJ3ABj+AIzmDW55Nm9ANpkAwlST3tkH8YkUZ01jJj/7dhr41TV+MtODojlklMOyybD3zpLkbKAC+M7mrj7Qp7hXFsOVEoXpWJV+cSppn4QbwY6SC2CfKPWMwgRakZSqW+3btfov8PlhdEcmg6uX57k5e3D6m7YSkBAf4K2wO5RmXIHzvIqm9aOWMWH4ZJurZXI9RWtYzQSY0ZHRC4LiupoDcIfKgaqfC7GucVoFM1NpylEpk2GPIqjKVMUhmyXLqsgCykTTIp41T6NJcCMsX7ENJZZaoyZMlpUUqGqMRBPzeYyw2yZj83GqNvzWZQh53Bvt2UGJGvL6/y9v5d5uNJPTNIguwMEbI0ktnRRtnlB4WLRD43JUS0EYdn9OGIvsx1K0/o2yP6c8HZI56HQyUnyPZQSodgOZ4zyAI9LVAZK1UOmaYP74HG5SpiO6iHMCJ87+tnpUO6sLlbso+PULWdnJ+vCt447KHaDmRubpKt7uNOc7sdhs9ddsCEcXm+PMk8zlJxHFBSi3Jz9I1jUuOMo1Oj7AqYEvernVY95NXTRrgX8eMOTW/RzxlMcDpBDjnOwYyeNbApoAewXztbVo/3H3Y4TBZ2ev1uy93d7LXZbTN3dx3yi72+f8j7j58y4KJlORFGgllQct3u3dx7c4msS+YFO6CcU9fLhD611PGhJqzeCeNzQAC2JYdjdUNDesrRctX9kaG6YJFlwo3BF1f/AqgTZJhpEsC1i7UeRvGX7MgvfnNVgAQCbZAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 5\"\n        title=\"tdd fail 5\"\n        src=\"/static/3afcbbd8fbe99b8d32d408d2856d6546/27524/tdd-fail-5.png\"\n        srcset=\"/static/3afcbbd8fbe99b8d32d408d2856d6546/772e8/tdd-fail-5.png 200w,\n/static/3afcbbd8fbe99b8d32d408d2856d6546/e17e5/tdd-fail-5.png 400w,\n/static/3afcbbd8fbe99b8d32d408d2856d6546/27524/tdd-fail-5.png 646w\"\n        sizes=\"(max-width: 646px) 100vw, 646px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now we can solve this by filling in the implementation for the <code>percentDiff</code> function:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/decimal-util.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> Decimal </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimal.js&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">prev</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">cur</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevDec </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(prev);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> curDec </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> diff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> curDec.</span><span class=\"mtk5\">minus</span><span class=\"mtk1\">(prevDec);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> diff</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">dividedBy</span><span class=\"mtk1\">(prevDec)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk4\">100</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">toDecimalPlaces</span><span class=\"mtk1\">(</span><span class=\"mtk4\">2</span><span class=\"mtk1\">, Decimal.ROUND_HALF_UP)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">toString</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  percentDiff,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And now all the decimal util tests pass:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 617px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/713e7a2ed61a530d78bde762b025d19e/bc962/tdd-pass.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.35980551053485%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAA1ElEQVQoz51Qy3LCMAzMd9Qk8UNOHD9ShjsM/f+P2kqCMIyHXnpY21qtVpKHcXZIuSDXHVuukPg02X9jkGM/X3C7/+B6u2PdiiYm69Vc8Oktd88L1NBYB2oVbT/rtFupqO1bJ5Z3Lk0hzQpvQktivmleuMeGDSGuGMbJwXAHm1asKat4SRsjszgjckwsDAdoecX91Lry+Nx99gHEYusJ1gUt8iHCPznRHAYH+v8TbjhJgghfKertuFg6mnFWkXkTfzLo8ZgwEkzmFZb4MvyroJ+w534BnAnDmsDgE8AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd-pass\"\n        title=\"tdd-pass\"\n        src=\"/static/713e7a2ed61a530d78bde762b025d19e/bc962/tdd-pass.png\"\n        srcset=\"/static/713e7a2ed61a530d78bde762b025d19e/772e8/tdd-pass.png 200w,\n/static/713e7a2ed61a530d78bde762b025d19e/e17e5/tdd-pass.png 400w,\n/static/713e7a2ed61a530d78bde762b025d19e/bc962/tdd-pass.png 617w\"\n        sizes=\"(max-width: 617px) 100vw, 617px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now let's turn our attention back to the calculator module, recall we had changed it to use the decimal util module to clean up the percentage difference calculation.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// This module is already imported because its used in other functions in the calculator module</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other imports and functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// NEW: Use decimal-util module for percentage diff calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(expenseSummary[prevYear].total, yearSummary.total);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">prevAvg) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;new category&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// NEW: Use decimal-util module for percentage diff calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prevAvg, curAvg);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>At this point the calculator tests should pass since we've finished implementing the decimal util <code>percentDiff</code> function:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 749px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f97fe6b373c9e705332595fc7d9ecb56/5bb8b/tdd-pass-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.49799732977303%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAAk0lEQVQY06WP2w7CIBBE+Q+w5bJciq0m2hij//9dI0tDvSTWBx9Oll3YGUbk/YQ8HqAtYdcbqE7/hTieZ1xvd5zmCygkdNqiN64aaOvWvsHz5z29zRghjYUvQgwLxpSR8ljPPg6FpVKI0GXBkq8CxvkKi3BtBkIRQfnFgX/DsRsc4bP/GVmmADmE6sKCW49fxb/xAOcxirTCMbJ2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd pass 2\"\n        title=\"tdd pass 2\"\n        src=\"/static/f97fe6b373c9e705332595fc7d9ecb56/5bb8b/tdd-pass-2.png\"\n        srcset=\"/static/f97fe6b373c9e705332595fc7d9ecb56/772e8/tdd-pass-2.png 200w,\n/static/f97fe6b373c9e705332595fc7d9ecb56/e17e5/tdd-pass-2.png 400w,\n/static/f97fe6b373c9e705332595fc7d9ecb56/5bb8b/tdd-pass-2.png 749w\"\n        sizes=\"(max-width: 749px) 100vw, 749px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>A quick note about the calculator module - since it's now delegating some of the functionality to the decimal-util module, the calculator tests function more like integration tests than unit tests because they're not isolated to just the one module. If this bothers you, you can introduce a mock to mock out the behavior of the decimal util module. I'm not a huge fan of this approach as it results in testing the implementation details rather than the actual output of the function. This is not strictly related to TDD so won't go into any more detail here, other than to say, I'm fine with having some of the tests more like integration tests. If in the future a bug gets introduced into decimal util that affects the calculator result, the calculator tests will fail which would be a good warning.</p>\n<p>One more quick note about the calculator - eagle eyed readers may have observed that the <code>calcYearlyDiff</code> function modifies its input. Normally I wouldn't do this, especially in a large application where there could be many callers of this function and modifying the input would be unexpected. But for a small side project where the input is actually running through a series of transformations and isn't used anywhere else, I decided this was fine. A future refactor could first make a deep copy of the input, and then operate only on the copy. Since the test makes assertions on the returned result, it would still be expected to pass.</p>\n<h2>Conclusion</h2>\n<p>I hope this post has given you some ideas about how to get started with TDD. The TDD approach lends itself really well to cases where the exact requirements are known. I've found this to especially be the case with calculations, validations and transformation type code. Next time you're adding a new feature to a project, if you know exactly how the new feature should behave, try to write a test for it first.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/tdd-by-example/"}}},{"node":{"id":"3a1ba4b4-52d8-52c5-a9b6-09cb99867c93","frontmatter":{"title":"Promotional interest rates and the fine print","date":"December 2020","category":"personal finance"},"excerpt":"Taking a break from programming topics to blog about personal finance today. Wanted to share an experience I had recently with one of theâ€¦","html":"<p>Taking a break from programming topics to blog about personal finance today. Wanted to share an experience I had recently with one of the banks in Canada that left me feeling deceived, even though strictly speaking, they did nothing wrong.</p>\n<h2>Background</h2>\n<p>First, a little background. If thereâ€™s one thing the Covid era has taught us, itâ€™s the importance of having a well stocked emergency fund.  Readers familiar with basic personal finance may want to skip this section and jump ahead to â€œThe Incidentâ€, otherwise, read on while I explain the concept.</p>\n<p>An emergency fund is basically a pile of cash that you sock away somewhere safe but that can be accessed easily and quickly, so that you have something to fall back on should an emergency happen. For example, being able to pay for an unexpected car repair when you rely on your car to get to work, or paying to replace the hot water tank should it break down.</p>\n<p>Financial experts say you should have approximately 3 - 6 months worth of expenses saved up in an emergency fund. This can be calculated by tracking all your expenses for a few months including fixed expenses such as mortgage/rent, car payments, property taxes, utilities, cell phone/internet, etc, and variable expenses such as groceries, personal care, clothing, gas, restaurants, entertainment etc. (albeit, much less of the latter categories lately). Then take an average of your monthly expenses, multiply by either 3 or 6 and thatâ€™s how much you should have saved in an emergency fund.</p>\n<p>As an aside, if youâ€™re looking for an app to track your expenses and make recommendations on savings and an emergency fund, check out <a href=\"https://github.com/danielabar/tidysum\">Tidysum</a>, a free, privacy-focused command line tool I wrote.</p>\n<p>I would argue that given the effects of this pandemic, a 1 year or slightly larger emergency fund is more appropriate to provide breathing room in case of a job loss where the entire industry is affected. This probably wonâ€™t be the last pandemic we face and who knows what other catastrophes may occur so better safe than sorry.</p>\n<p>Ok so weâ€™ve established the need for an emergency fund. Next question is - where should it be located? Keeping that amount of physical cash in your home is not a good idea because it could be lost due to theft or a fire. And physical cash loses its value due to inflation (has been running ~2% in Canada), so youâ€™re literally losing money by holding on to physical cash.</p>\n<p>On the other extreme, to get an inflation beating return, the most common option these days is the stock market, HOWEVER DO NOT PUT YOUR EMERGENCY FUND THERE! The stock market is too volatile for this purpose. Financial experts say donâ€™t put any money in the stock market that you might need in less than 10 years.</p>\n<p>So basically that leaves savings accounts at banks. Unfortunately with interest rates being near 0 these days, itâ€™s difficult to get much return on your cash. The best consistent rate in Canada has been 1.5% from one of the online-only banks. So youâ€™re still losing money to inflation but its better than the big chartered banks that are paying at most 0.1% (at the time of this writing).</p>\n<h2>The Incident</h2>\n<p>Which brings me to the incident that led to writing this blog post. Given the strong need to have an emergency fund (ideally not losing money to inflation), low interest rate environment and knowing that banks pay almost nothing in interest, imagine my delight to receive this offer from one of the major banks. The email subject line was â€œReady, set, save with 2.30% interestâ€</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 757px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ad8a7a72ea80ccd77bb39cd98116dbda/1fbe8/bank-offer-crop.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.03302509907529%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACJElEQVQ4y4VUa2/aQBDkX1dqqlbq50qR+ruqJCgUwiuAwRiD329j4+nOmgtf0uSk0XIP5mZ39jz48u0X3KOHg+vBOZw0HlwTb78d54j93hWY2MO+4iD//frjHgPPC3FuGgRBhLwokaYZ8rxEkmSIkxRZXmjsug6fDXIMTl4gJDnCMFZEcaII5DdBMkZeVtdnVHUtFxYoZM614goO3w8xOB59lWvbLqztXtN7XW2x3TlYrXfYWHvFerPDzj5g+WppPJ58BTOkqJ6QCk+BKvJFLjcZeZAxzXJVGEUJ4jhFWVbIZO1/6SshFZLA2jqqwqIaUcb5R4OkBpdLdyOkklrqwnSpVt0TR1kG4zqVte0FjZjXtq3E9o3EkL4R0plI0nkcTrBYWhiN54rn0UxrxfoQzIIXmViJQT0hboR02RNnOrk9lTYpxL2qLJFJ66RSu4so+SBniMxbNC57dEhS6apacakqiT3aokAjOOe5opELz2IK0cjc7NdZBqlbT8i6sVbaIlLHtWVjtbElzVDBHuS+4xJev+73e0zRFVN3Und2BM8qYZYV2uWJpMq2CKP405fx3j7LN+AN48lCTWAcPr/gz8MID09jTF6WmC/WmEyXeBLTHodj/JUzC2luZjSdr/p9OUeyUPpVTWHT8gPhSkqu9mWgTprBJ6cfANlvrwa8N5TwTr4QfFqL5UaflQGfH2+fUYXscc71fq1fN3E6W4niLb7//I1/r9lwWGuEQckAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bank offer\"\n        title=\"bank offer\"\n        src=\"/static/ad8a7a72ea80ccd77bb39cd98116dbda/1fbe8/bank-offer-crop.png\"\n        srcset=\"/static/ad8a7a72ea80ccd77bb39cd98116dbda/772e8/bank-offer-crop.png 200w,\n/static/ad8a7a72ea80ccd77bb39cd98116dbda/e17e5/bank-offer-crop.png 400w,\n/static/ad8a7a72ea80ccd77bb39cd98116dbda/1fbe8/bank-offer-crop.png 757w\"\n        sizes=\"(max-width: 757px) 100vw, 757px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Well this sounds just wonderful, even if it is only for a limited time (at the time I received it, it would have provided 6 months of the high interest). So naturally I called to sign up. Keep in mind this is from a large, chartered and reputable bank in Canada. Also Iâ€™d had some accounts with them in the past, already had their call centre number from having called them before, and confirmed it was the same number as shown in the promotion. So there was no concern about this being a scam.</p>\n<p>The sign up process was straightforward, my account was opened in minutes, and I was able to transfer funds from another institution where I was keeping my emergency fund previously, and only earning 1.5%, looking forward to end of the month to start seeing the 2.3% build up (with the understanding that this is an annualized rate).</p>\n<p>But when month end came and went, was very surprised to see the interest only being a tiny portion of the promised 2.3%. Figuring there must have been a mistake and the promotion hadnâ€™t yet been applied to my account, I called them to determine the issue.</p>\n<p>And this is where things went sideways. I was told that the 2.3% is a combination of of the regular rate of 0.1% and a promotional rate of 2.2%, but that during the promotional period, only the 0.1% would be paid out monthly (and compounded). The 2.2% would only be paid out one-time, after the offer period had finished, and would be based on the average daily balance during the offer period.</p>\n<p>In other words, the 2.2% would NOT be compounded, the way every other interest rate on savings accounts (promotional or otherwise) is calculated and how my intuition had told me this would work. Suddenly this â€œwonderfulâ€ offer was not looking so good, in fact, it was looking more like a trick. When I pointed this out I was told that all this was explained in the terms and conditions.</p>\n<p>Luckily I kept the promotional email. It turns out the the terms and conditions are displayed in tiny font below the fold of the catchy promotional material (bank name has been blanked out as itâ€™s not the point of this post to call out any particular institution):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 715px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/203d40fe0052aeb11134e86307633e5d/d0c0e/bank-terms-and-conditions-tiny.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.8041958041958%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABpklEQVQ4y22TabLCQAiEvf+xNO5rNO67cUm0XG6A9WF1THzvRxczwAANTOn5fFocxzafz229XttqtbLtdutSQC8cDgfbbDYObMvl0t/fbje73+9WIiDGdrtt3W7XOp1OJgF62ZC73c5Op5MHarVarhsMBna9Xr8ByVyv163RaDiq1apLHgBsoFarZT6AYPIjyePx+ATc7/c2Go1sPB5bFEUWhqEDHRgOh5ldUnbpaAWxPCA0yNbr9bx8wBn0+32/E1R3SYLSFgKez+dPha/Xy5tbqVScarPZdKc8zV+q5XLZgiBwP/wXi0Wxh1AmG1VMJhOnDRWBO1Ugp9NpdgYMlIBMOushShrLJEWJ7OioAD3gjE2T1yaQ9HK5FCmLFo+oVH1Ur4AqVZ/RIak6TdPilDHoATumpdVys/hQyy880JIX1oaR0ztAttlsVuilEskHOwk4s8MES5LkG5C10Q+hN9DkTtX5dcJOAipHypeghSnrL0MhT4uHuiN/bUB//Hg8/t9DbT508j9DtIFWDD2SgFD+85eZsFYCsDYkUkCkequE9JOhaA/fMx4eMH9UNbIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bank offer terms\"\n        title=\"bank offer terms\"\n        src=\"/static/203d40fe0052aeb11134e86307633e5d/d0c0e/bank-terms-and-conditions-tiny.png\"\n        srcset=\"/static/203d40fe0052aeb11134e86307633e5d/772e8/bank-terms-and-conditions-tiny.png 200w,\n/static/203d40fe0052aeb11134e86307633e5d/e17e5/bank-terms-and-conditions-tiny.png 400w,\n/static/203d40fe0052aeb11134e86307633e5d/d0c0e/bank-terms-and-conditions-tiny.png 715w\"\n        sizes=\"(max-width: 715px) 100vw, 715px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>And indeed, zooming way in reveals some surprising details about how the interest is calculated. Iâ€™ve plucked out the relevant portions below:</p>\n<p>â€œThe special annual interest rate of 2.30% is a combination of promotional and regular annual interest ratesâ€¦â€</p>\n<p>â€œPromotional interest is calculated as follows:â€¦ on the portion of the applicable accountâ€™s average daily closing balance from the date the account is opened to the end of the Offer Periodâ€¦â€</p>\n<p>â€œPromotional interest will be paid in Apâ€Œril 2021 into a single Eligible Savings Accountâ€</p>\n<p>â€œEligible Accounts will continue to earn regular interest, calculated on the daily closing balance and paidÂ monthly.â€</p>\n<p>Ok so technically and legally speaking, thereâ€™s nothing wrong here, the interest is being paid out exactly as per the terms. So why am I left with a bad feeling? Well the problem is how most ordinary people understand how interest on savings accounts work, based on their experiences at other banks. Itâ€™s generally understood that the posted regular or promotional rate will compound on a monthly basis. This is why people open savings account to get the â€œmagicâ€ of compounding, however small the interest rate may be.</p>\n<p>It is not at all intuitive that an interest rate would only get calculated one-time and not compound. This isnâ€™t even hinted at in the main promotional material. How many people are actually going to zoom in on the tiny font in the terms and conditions to decipher that it will only be a one-time payment and not compounded? Even if you read the terms closely, itâ€™s not obvious that itâ€™s a one-time non-compounding payment because these words are not used. Itâ€™s like they went out of their way to not use these obvious words that might set off alarm bells in customers heads that maybe this deal isnâ€™t as good as it sounds.</p>\n<p>I can almost imagine the marketing team (or whoever comes up with these promotions at banks) sitting around a zoom meeting coming up with this idea. Something likeâ€¦</p>\n<p>â€œHow can we get Canadians to withdraw their funds from our online-only high interest competitors and get them to come to our bank?â€</p>\n<p>â€œI know letâ€™s offer a slightly higher rate, maybe 1.6%â€</p>\n<p>â€œNah, that would increase our costs but itâ€™s too small to get people out of their natural inertiaâ€</p>\n<p>â€œHow about a really high rate that they wouldnâ€™t be able to ignore, like 2.3%?â€</p>\n<p>â€œYeah that would work but would affect our bottom line too muchâ€</p>\n<p>â€œIâ€™ve got an idea, how about we offer the 2.3% but donâ€™t compound it, just make it a one-time payment at the end of the promotional periodâ€</p>\n<p>â€œWould anyone go for that?â€</p>\n<p>â€œThey would if we present it like a regular interest rate, then bury the details in the tiny point font terms and conditions that no one ever readsâ€</p>\n<p>â€œBrilliant, we have a winner!â€</p>\n<p>Of course thatâ€™s all just a dramatization and my possibly over-active imagination of how bank meetings go.</p>\n<h2>Conclusion</h2>\n<p>So whatâ€™s the moral of the story here? Could I have been more vigilant about reading the terms? Sure, although Iâ€™m not sure that the wording would have overridden my strong intuition about how interest works on savings accounts, based on all my past experience. Is there any legal case to be made that the bank is in the wrong here? Nope, the terms are very clear about how it works.</p>\n<p>However, people donâ€™t make their impressions based on legalities and technicalities. My perception is that Iâ€™ve been tricked, even if legally everything is above board. That perception becomes reality, that I can no longer trust this institution and would not want to do business with them again. Itâ€™s sad that a Canadian bank would resort to a tactic like this to gain more customers. I hope other institutions wonâ€™t attempt to emulate this, and that with this post, Iâ€™ve increased some awareness of this issue.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","fields":{"slug":"/blog/emergency-fund-fine-print/"}}},{"node":{"id":"c0869cac-b2c2-502a-a83f-d20efc85f1b8","frontmatter":{"title":"Improve Productivity with VS Code Snippets","date":"November 2020","category":"vscode"},"excerpt":"Have you ever found yourself repeating a certain pattern while coding over and over and thought there's got to be a faster way? For exampleâ€¦","html":"<p>Have you ever found yourself repeating a certain pattern while coding over and over and thought there's got to be a faster way? For example, if you work with React and hooks, many component file will have this as the first line:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React, { useState, useEffect } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;react&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Well there is a faster way to enter these common lines. For React specifically, install the <a href=\"https://marketplace.visualstudio.com/items?itemName=burkeholland.simple-react-snippets\">Simple React Snippets</a> VS Code extension. After it's installed, open a Javascript file and type <code>imr</code>. An intellisense menu will appear like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/59fe44e6fc7363cb170b18c22ffb9cdb/20751/react-snippets.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.3404050144648%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABD0lEQVQY022Q207DMBBE8x9tkvre2LFj7CS9gMQLQuL/P2hYb/sAiIfRxvLs8Uw6qS1SzFhyRikB2gWcpCYZnmP7VgZCWQjyKuMgteOpzJml7WM2T3foR0ghYdd3DJIulCYZlnVkNhY+RNR1Q60btm2nhytCmDHPEXNMiKR2tgTujsMJgoD+7QsuJBitMU2eVUrB5XolUMXtfse+X5DmjEAPTa55KCX5pVQcRFKb7sBAgfD6CU/VNV1M3mNZMtKycJp1eySrdcUoFHraGUaJ4STQj7/1BEqE2wfOlJCBlM77wDUasIHqunK11uhIizz/0bOygCeg9YmiKzg3IaaE/FL43xWq3OrGtPDS31Q/9Q3LjK+44YmD/wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"react snippets\"\n        title=\"react snippets\"\n        src=\"/static/59fe44e6fc7363cb170b18c22ffb9cdb/5a190/react-snippets.png\"\n        srcset=\"/static/59fe44e6fc7363cb170b18c22ffb9cdb/772e8/react-snippets.png 200w,\n/static/59fe44e6fc7363cb170b18c22ffb9cdb/e17e5/react-snippets.png 400w,\n/static/59fe44e6fc7363cb170b18c22ffb9cdb/5a190/react-snippets.png 800w,\n/static/59fe44e6fc7363cb170b18c22ffb9cdb/20751/react-snippets.png 1037w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Keep typing until <code>imrse</code> is selected and hit enter. It will get replaced with:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React, { useState, useEffect } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;react&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>What's going on here is the Simple React Snippets extension has added a collection of frequently used React code sections as VS Code snippets. So what exactly are snippets? According to the VS Code docs:</p>\n<blockquote>\n<p>Code snippets are templates that make it easier to enter repeating code patterns, such as loops or conditional-statements.</p>\n</blockquote>\n<p>But what if you have some other frequently typed lines that aren't related to React or any other framework? It could be something very specific to your code style or the project you're working on. In this case, there won't be an extension for this. The good news is VS Code allows you to add your own snippets. This post will walk you through how to do just that with an example.</p>\n<p>Since I write a lot of documentation in markdown, I frequently want to insert a local image. The markdown for this is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"markdown\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">![</span><span class=\"mtk6\">alt</span><span class=\"mtk1\">](path </span><span class=\"mtk6\">&quot;title&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">For example:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">![</span><span class=\"mtk6\">dog and cat</span><span class=\"mtk1\">](../images/dog-and-cat.jpg  </span><span class=\"mtk6\">&quot;dog and cat&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>Let's build a snippet for this so that it only requires typing <code>img</code>, then <kbd>Ctrl</kbd> + <kbd>Space</kbd> to bring up the snippet template, which can then be filled in to specify the alt text, local path to image and a title. The final result will work like this:</p>\n<p><img src=\"/9eccd2efc7566ded54bc30c859df2582/user-snippet2.gif\" alt=\"user snippet\"></p>\n<h2>Create a Snippet</h2>\n<p>To get started, select Code -> Preferences -> User Snippets from the VS Code menu.</p>\n<p>From the \"New Snippets\" menu section, scroll down and select markdown.</p>\n<p>This will open a new <code>markdown.json</code> file in your user directory, for example mine is at <code>~/Library/Application Support/Code/User/snippets/markdown.json</code>.</p>\n<p>This file contains one json object. Each entry in this object represents a snippet. First add the <code>img</code> entry:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;img&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// snippet content will go here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2>Fill in Snippet Content</h2>\n<p>Next, tell VS Code what text you want to type in order to bring up the snippet in the intellisense menu. This is specified with the <code>prefix</code> property. In this case, we want this text to be <code>img</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;img&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;prefix&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;img&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Now comes the tricky part, the <code>body</code> property is where you define the template for the snippet. This is the text that will be inserted into the document when you hit enter from the intellisense menu. Recall we want this to generate a markdown image with the ability to tab through and enter alt text, image path and image title. So we will enter <code>![alt](path \"title\")</code> as the <code>body</code>, but with some variables denoted in a special syntax to indicate the tab stops.</p>\n<p>Tab stops are indicated with <code>$1</code>, <code>$2</code>, etc. But if you want the template to be more helpful and show a label (to make it clear what's supposed to go where), use the <code>${1:label}</code> syntax. Since we have 3 variables (alt text, path, and title), we will have 3 variables. Since the markdown image has double quotes for the title, and we're in a json file where quotes have a special meaning, these need to be escaped with <code>\\</code>.</p>\n<p>So the snippet is now:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;img&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;prefix&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;img&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;body&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;![${1:alt}](${2:path} </span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk12\">${3:title}</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk12\">)&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>It looks confusing but take a closer look, and its the same familiar syntax of a markdown image <code>![alt](path \"title\")</code>, but with <code>alt</code> replaced with <code>${1:alt}</code>, <code>path</code> replaced with <code>${2:path}</code>, <code>title</code> replaced with <code>${3:title}</code>, and the double quotes surrounding <code>title</code> escaped by preceding each one with a backslash <code>\\</code>.</p>\n<p>Finally, add a <code>description</code> property that will be displayed in the intellisense menu when this snippet is highlighted. You may think it's obvious now but if you create a lot of snippets, the description will be helpful in reminding your future self what it does:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;img&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;prefix&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;img&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;body&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;![${1:alt}](${2:path} </span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk12\">${3:title}</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk12\">)&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Markdown image with alt text and title.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2>Try it out</h2>\n<p>Save the <code>markdown.json</code> file. Then open a new or existing markdown file in your project, type <code>img</code>, then then <kbd>Ctrl</kbd> + <kbd>Space</kbd> to bring up snippet suggestions and select your new custom snippet. It should replace <code>img</code> with the markdown template and you can tab through entering the image alt text, path to image and a title.</p>\n<h2>Further Improvements</h2>\n<p>There's a few further improvements that can make this workflow even more efficient.</p>\n<p>First, I tend to make the alt text and title be the same value, so it would be faster to have the <code>title</code> field automatically be filled in wth the value of whatever is entered into the <code>alt</code> field. This can be achieved by using the same variable number.</p>\n<p>To do this, open the <code>markdown.json</code> snippets file and make the following change. If you've closed the file, go to Code -> Preferences -> User Snippets, and this time select Markdown from the Existing Snippets menu section (should be near the top).</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;img&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;prefix&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;img&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;body&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;![${1:alt}](${2:path} </span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk12\">${1:title}</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk12\">)&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Markdown image with title&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Notice this time the variable number <code>1</code> is being used both for <code>alt</code> and <code>title</code> fields. Save this and try to use the snippet again. This time as you're typing the alt text, notice the title is automatically populated with the same value as alt text.</p>\n<p>One last improvement is the final tab position. Notice that after you fill out all the fields when using the snippet, if you press tab one more time, it moves your cursor to the end of the line.</p>\n<p>Typically with a markdown image, it would be on a line by itself, so you have to hit enter twice to continue with the markdown editing. To save yourself from this extra work of having to hit enter twice, the snippet can be modified to use the special variable <code>$0</code> to indicate the final tab stop.</p>\n<p>Again edit the <code>markdown.json</code> snippets file, adding two new line characters after the markdown image, and then <code>$0</code> to indicate the final tab stop:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;img&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;prefix&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;img&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;body&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;![${1:alt}](${2:path} </span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk12\">${1:title}</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk12\">)</span><span class=\"mtk4\">\\n\\n</span><span class=\"mtk12\">$0&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Markdown image with title&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Again save these changes and try the snippet again in a markdown file. This time it will show a subtle grey line where the cursor will land from hitting tab after you've entered all the fields. It looks something like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 744px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c4590f9f6649c745383169b725ebdf86/cab8c/snippet-final-tab-stop.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.61290322580645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA3ElEQVQY041Q2XKDMBDjK1Iu21xJMCYkaQBjCJD+/0epa+cY+tYHeXa1Ho0kb38scZQKt67DYAzU+Qp16aGHEYdSIuYJmEj/gcT99XiSQaQ5yuoAsxgsa49Wa3RmQF4I+CGDHzEEL/hh/Jm3XMSEE3aCSVaAESG/dsiDCFngo8gLTPPqnM7rA9pMMNMd8/LAd0tpxjt6umkzkokfSlM5UW9rO+UCgmxzwtN1japuUDcXqFMDSfv11kKqk+PtbuuqmzPSfP+MbB8HEvwD4sKYO9hY79lW8J639+jV9S/eUI8zbBXPCwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"snippet final stab stop\"\n        title=\"snippet final stab stop\"\n        src=\"/static/c4590f9f6649c745383169b725ebdf86/cab8c/snippet-final-tab-stop.png\"\n        srcset=\"/static/c4590f9f6649c745383169b725ebdf86/772e8/snippet-final-tab-stop.png 200w,\n/static/c4590f9f6649c745383169b725ebdf86/e17e5/snippet-final-tab-stop.png 400w,\n/static/c4590f9f6649c745383169b725ebdf86/cab8c/snippet-final-tab-stop.png 744w\"\n        sizes=\"(max-width: 744px) 100vw, 744px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Summary</h2>\n<p>That's it, your very first custom VS Code snippet. I hope this post has taught you how to continue building more of these to optimize your workflow.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/improve-productivity-with-vs-code-snippets/"}}},{"node":{"id":"736f5c1e-fd4e-54cf-b5be-b3377433eb4a","frontmatter":{"title":"Construct a PATCH request for a JSON API","date":"November 2020","category":"rails"},"excerpt":"I'm currently building a subscription management and notification microservice in Rails and decided to use the jsonapi-resources gem toâ€¦","html":"<p>I'm currently building a subscription management and notification microservice in Rails and decided to use the <a href=\"https://github.com/cerebris/jsonapi-resources\">jsonapi-resources</a> gem to build a JSON spec compliant REST API. This will allow clients of the microservice to submit http requests to do things like add new plans and register new subscriptions for these plans.</p>\n<p>At this point some readers may be wondering why build a custom subscription management system? Why not use Stripe or Recurly or some other established subscription-as-a-service offering? The reasons for that are beyond the scope of this article, but suffice to say, several of these services were researched and determined not to be a good fit for this project.</p>\n<p>Back to the story. Another thing a client of this service may want to do is update a plan, for example, the price may have changed. Although the <code>jsonapi-resource</code> gem is fairly well documented, I couldn't find an example of how to construct a PATCH request to update a resource. After some trial and error, got it working, and wanted to share the results here.</p>\n<p>To start, here is the plan resource class, which is a wrapper for the <code>Plan</code> model. It exposes several attributes from the plan model such as currency, name, recurring interval and the price in cents (not related to this post, but it's generally good practice to store prices in cents to avoid rounding errors).</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/resources/api/v1/plan_resource.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Api</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">V1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">PlanResource</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">JSONAPI::Resource</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      attributes </span><span class=\"mtk4\">:currency</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:recurring_interval</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:recurring_interval_count</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:unit_amount_cents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      belongs_to </span><span class=\"mtk4\">:tenant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">meta</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">_options</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">last_updated_at:</span><span class=\"mtk1\"> _model.updated_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>And the plans resource is configured in the routes file as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/routes.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.routes.draw </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  namespace </span><span class=\"mtk4\">:api</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    namespace </span><span class=\"mtk4\">:v1</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      jsonapi_resources </span><span class=\"mtk4\">:plans</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now suppose there exists a Plan in the system with id <code>6d369edf-af6b-4da3-a928-3ab6160b3284</code> (if you want to learn how to configure Rails and Postgres to work with UUID as a primary key, see my <a href=\"/blog/rails-uuid-primary-key-postgres/\">post on UUID</a>) that has a current price of $20.00 per month (i.e. 2000 cents), and the price has gone up to $22.00 (i.e. 2200 cents). Given a rails server running on the default port 3000 via <code>bundle exec rails s</code>, then the following curl request will update this plan with the new price:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">curl --location --request PATCH &#39;http://localhost:3000/api/v1/plans/6d369edf-af6b-4da3-a928-3ab6160b3284&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--header &#39;Accept: application/vnd.api+json&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--header &#39;Content-Type: application/vnd.api+json&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--data-raw &#39;{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;data&quot;: {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        &quot;id&quot;: &quot;6d369edf-af6b-4da3-a928-3ab6160b3284&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        &quot;type&quot;: &quot;plans&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        &quot;attributes&quot;: {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &quot;unit-amount-cents&quot;: 2200</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}&#39;</span></span></code></pre>\n<p>A 200 OK (success) response will be returned with the body containing the updated plan, as well as some metadata (configured to show last updated timestamp in the resource class) and self and relationship links:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;id&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;6d369edf-af6b-4da3-a928-3ab6160b3284&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;type&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;plans&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;links&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;self&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;http://localhost:3000/api/v1/plans/6d369edf-af6b-4da3-a928-3ab6160b3284&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;attributes&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;currency&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;USD&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;name&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;The Best Plan Ever&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;recurring-interval&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;month&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;recurring-interval-count&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;unit-amount-cents&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">2200</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;relationships&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;tenant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;links&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;self&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;http://localhost:3000/api/v1/plans/6d369edf-af6b-4da3-a928-3ab6160b3284/relationships/tenant&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;related&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;http://localhost:3000/api/v1/plans/6d369edf-af6b-4da3-a928-3ab6160b3284/tenant&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;meta&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;last_updated_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2020-11-20 20:46:12 UTC&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The curious thing is that the plan id needs to be specified twice - once in the url so the route will match <code>PATCH /api/v1/plans/:id(.:format)</code>, but it also needs to be specified in the body, in the <code>data</code> hash. Not specifying it will result in a 400 bad request error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;errors&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A key is required&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;detail&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;The resource object does not contain a key.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;code&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;109&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;status&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;400&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>At first I couldn't understand why this error was returned given the id is specified in the url, but it looks like the <code>jsonapi-resource</code> gem expects to also find it in the body. I hope this will save you some time if you're setting up an api with this gem.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/patch-request-with-json-api/"}}},{"node":{"id":"c975b7e7-6342-5dfc-9f0b-77f98d4db732","frontmatter":{"title":"Use UUID for primary key with Rails and Postgres","date":"November 2020","category":"rails"},"excerpt":"When working with Rails and a relational database such as Postgres, the default option for primary key is an auto-incrementing sequence. Soâ€¦","html":"<p>When working with Rails and a relational database such as Postgres, the default option for primary key is an auto-incrementing sequence. So the first record inserted would get a primary key of 1, next one 2 and so on. Depending on the system, this can be an issue if these values get exposed in urls, for example <code>/subscription/265</code> would reveal that 265 subscriptions have been generated, and that the next one will be id 266.</p>\n<p>A less revealing option can be to use UUIDs (universally unique identifier) as a primary key. An example UUID looks like <code>123e4567-e89b-12d3-a456-426614174000</code>. The idea is that it's practically universally unique, and they are not sequential. So if this was a subscription id, the url would be <code>/subscription/123e4567-e89b-12d3-a456-426614174000</code> which reveals absolutely nothing about how many subscriptions have been created or what the next subscription id would be.</p>\n<p>This post shows the steps needed to configure Rails to use UUID for primary key with Postgres. This works best on a brand new application with no production data yet. Trying to convert an existing system could be risky because every single record in every table would have to get migrated and foreign key constraints temporarily dropped during migration.</p>\n<h2>Step 1: Enable pgycrypto</h2>\n<p>The <code>pgcrypto</code> module provides cryptographic functions for Postgres, however, it's not enabled by default. This should be the first migration to enable it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">EnableUuid</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    enable_extension </span><span class=\"mtk6\">&#39;pgcrypto&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Run the migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rake db:migrate</span></span></span></code></pre>\n<p>Verify the extension has been enabled. I'm using <a href=\"https://www.jetbrains.com/datagrip/\">Datagrip</a> but you can check with your sql client of choice. Expand the databases list, then check under extensions and you should see something like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 628px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d2d04dd917ab68a5442a832884c0e9d2/3d84d/postgres-pgcrypto-extension-enabled.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.917197452229296%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAByUlEQVQoz4VSy3LTQBDUH0AVlxRUoIKJZNl6S7taS9bDlq3YYMAQ8s4lBRyoJBU4JX/fzC5WSmC7OPTOvnqmt3c0w2LQ+xFk7NoM++4Auh2jS2vToWhztW/YAoYjzwR0i8Mgjk53jH+gyWG/F6HvJ4j8GE+Pf+D58gpFfoDq7RFGB58xnh0iHtZwwiGRor8SNGIeEzYbMsrE6kBWV+tQ4U/REG/MQKHT9dW6zd2sMBjg2ccr7M7PkKZTpOMF8skHcJpn1XuU9RJD2ivrT/BYAStI1xW2K5gU98QEr0UFly67RHKjHBYVk8+Vc5koGlRKgPR3a0LTjeF6Ai/GS+xlc/hEZqQsJHKUTCiOYQdD9L1EPVlf2dLwG7QSCrgOw87sFK+mh0hFiWT0DoNijjibKXi8XH0M2wrNCTNI2EFGnmTwqFUsVqKTLxDwApzUsaSCoF/m6USpbDiboHlshEfwEfwwh1kfYefyF84vvuH67h6nl99x8/MBx+dfEZK/HhX0eYvXgtajRl4D+WSSkh7ZYDpi1fSxwsb7LWhtQ1Xndz28pOc+ObtFktWYLk5Qzb8oSJ+b/tsGbc1YeUBKOlGh2kW2isvy/35Gg99AjYFQHF+f9AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alt\"\n        title=\"alt\"\n        src=\"/static/d2d04dd917ab68a5442a832884c0e9d2/3d84d/postgres-pgcrypto-extension-enabled.png\"\n        srcset=\"/static/d2d04dd917ab68a5442a832884c0e9d2/772e8/postgres-pgcrypto-extension-enabled.png 200w,\n/static/d2d04dd917ab68a5442a832884c0e9d2/e17e5/postgres-pgcrypto-extension-enabled.png 400w,\n/static/d2d04dd917ab68a5442a832884c0e9d2/3d84d/postgres-pgcrypto-extension-enabled.png 628w\"\n        sizes=\"(max-width: 628px) 100vw, 628px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Step 2: Configure Generator</h2>\n<p>Add the following to the generators config so it knows to generate uuid primary keys:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/generators.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.generators </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |g|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  g.orm </span><span class=\"mtk4\">:active_record</span><span class=\"mtk1\">, </span><span class=\"mtk4\">primary_key_type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:uuid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Step 3: Generate Model</h2>\n<p>Time to try it out. Start by generating a model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rails generate model Tenant name:string</span></span></span></code></pre>\n<p>Open the generated migration - notice the type for id is <code>uuid</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateTenants</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:tenants</span><span class=\"mtk1\">, </span><span class=\"mtk4\">id:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:uuid</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Run the migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rake db:migrate</span></span></span></code></pre>\n<p>Verify how this looks in the database - notice that the id column is using the <code>gen_random_uuid()</code> function:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 626px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e74efdf2cd58bc560613499d727203c5/af590/tenant-table-uuid.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.9073482428115%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABGElEQVQoz5VSy07DMBDMv5C0SWjzdN5xEnBDmlYtKoL2WHHk/z9g2HUaJAQHOIy8s94de7w27HUKxiqq4AYFlquJO16m18W9oFzyZxgeCQWJxPn6gf5wQdc/Q42vGs3m+G9Rg4sZnpBwKWE6xG+bnDftEJYbUz7SmOIQd5SfeKQ5g+uNWdla+rC2Z+xf9qiaAetY0s1blN2O4hqiVEjrJ4Rph0wOKNoRSdUjSFvNuY7dfAku6GShjhj7HHHW0mYGXzRIqYnfl1dRKC0gyo0Wi/NHRITkxn8ImkkHvxrgaDGJdVRrWzYNyPVzDW5iu7Nlxhx/t2wHCE5X9Jd3ZHSi2r3hYTiRaIW82UKqA1oaGN+K35F/w29D+QQht+Aasg9/pQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alt\"\n        title=\"alt\"\n        src=\"/static/e74efdf2cd58bc560613499d727203c5/af590/tenant-table-uuid.png\"\n        srcset=\"/static/e74efdf2cd58bc560613499d727203c5/772e8/tenant-table-uuid.png 200w,\n/static/e74efdf2cd58bc560613499d727203c5/e17e5/tenant-table-uuid.png 400w,\n/static/e74efdf2cd58bc560613499d727203c5/af590/tenant-table-uuid.png 626w\"\n        sizes=\"(max-width: 626px) 100vw, 626px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Launch the Rails console and insert some data into the new table - you should see that the id is a UUID:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rails console</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; Tenant.create(name: &#39;Acme&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=&gt; #&lt;Tenant id: &quot;bb57c11e-2ec7-44aa-8519-babd8b439b51&quot;, name: &quot;Acme&quot;, created_at: &quot;2020-11-01 22:06:58&quot;, updated_at: &quot;2020-11-01 22:06:58&quot;&gt;</span></span></code></pre>\n<h2>Step 4: Foreign Key Reference</h2>\n<p>One last thing to watch out for is adding a foreign key reference to a table. For example, suppose there is a <code>Plan</code> table and you want to add a reference to the Tenants table. The migration for this is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rails generate migration AddTenantRefToPlan tenant:references</span></span></span></code></pre>\n<p>Which would generate:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddTenantRefToPlan</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_reference </span><span class=\"mtk4\">:plans</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:tenant</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">foreign_key:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">index:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>However, running this won't work because it will try to create an integer type column <code>tenant_id</code> on the <code>Plans</code>  referencing the <code>id</code> column on <code>Tenants</code> table which is of type uuid which doesn't match. For these type of migrations, need to specify <code>type: :uuid</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddTenantRefToPlan</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_reference </span><span class=\"mtk4\">:plans</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:tenant</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">foreign_key:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">index:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:uuid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>That's it, now you're all setup to use UUID as the primary key in all your models.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-uuid-primary-key-postgres/"}}}]}},"pageContext":{}}}