{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":66,"edges":[{"node":{"id":"e7c2d55a-8f68-55c1-816f-45c791f9b011","frontmatter":{"title":"Add a Kafka Consumer to Rails","date":"October 2023","category":"rails"},"excerpt":"This post will walk through how to integrate a Kafka consumer into a Rails application in a maintainable and testable way. Why would youâ€¦","html":"<p class=\"markdown-para\">This post will walk through how to integrate a Kafka consumer into a Rails application in a maintainable and testable way. Why would you need to do this? Consider the following scenario: You're working on an e-commerce system that has been developed with Rails. The product details page needs to be enhanced to show whether the current product is in stock, out of stock, or only has small number of items left (eg: \"Only 3 left in stock!\"). This information comes from a legacy inventory management system that has been written in a different programming language. This legacy system is responsible for updating the inventory count based on events, such as product purchases, returns, or stock replenishments.</p>\n<p class=\"markdown-para\">In order to display this inventory information in the Rails e-commerce app, it needs the ability to communicate with the legacy inventory system. There are many <a href=\"https://en.wikipedia.org/wiki/Enterprise_Integration_Patterns\" class=\"markdown-link\">solutions</a> for enabling different systems to communicate, each with tradeoffs to consider. This post will demonstrate how <a href=\"https://kafka.apache.org/\" class=\"markdown-link\">Apache Kafka</a> can be used to solve this problem. Kafka is a distributed streaming platform that enables high-throughput, fault-tolerant, and real-time event data streaming for building scalable and event-driven applications.</p>\n<p class=\"markdown-para\">Given that the inventory information is updated based on business events, this makes it a good fit to integrate with Kafka, which is designed for event-driven systems. Using Kafka will make the integration between the legacy and e-commerce system more tolerant to large bursts of inventory events, whereas a REST/HTTP based integration might be prone to information loss in the case of temporary network or database outages.</p>\n<aside class=\"markdown-aside\">\nThis post assumes some basic knowledge of Rails (models and controllers), Kafka (producers, consumers, topics), and Docker (just enough to run a docker compose file). Looking to level up on any of these topics? Check out this guide on <a class=\"markdown-link\" href=\"https://www.akshaykhot.com/books-to-learn-ruby-and-rails/\">books for learning Rails</a>, an introductory Kafka <a class=\"markdown-link\" href=\"https://developer.confluent.io/what-is-apache-kafka/\">tutorial</a>, and Docker <a class=\"markdown-link\" href=\"https://docs.docker.com/get-started/\">getting started</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"big-picture\" style=\"position:relative;\"><a href=\"#big-picture\" aria-label=\"big picture permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Big Picture</h2>\n<p class=\"markdown-para\">Conceptually, here is what we'll be building:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTUlEQVR42m1Qy0rDQBSdT3MnIiJE8QP0K9y6cKH4aHEjKKjgQjeWglspFKVIE7NQxKIo2khjbKckadJ0HkdmkhT7OHC5J+eeM9xcwjmHlBK+H8BxHDDGIYSA0vMZpRSUdjXPdVVCSniehyiKNFc5ogYKkiWIe6Fi+luItGvwQVqpU4dzsCRW7iwjQJRho/SK+R0La8dPmNuu467RQRJSfLkUKwc2jIINo2hjqWDBaYeI/TZqjV/MbN5j9egRs1t1rF++6EeJlAKV5zYuat8oW67ub60A4Am6QYSzahPntw5OKh84rTZBg1jP3t0AhzefKJstrV/bP3p7otacBj6hD4Zs5BxjGZISOVL5jTphgsU9C8vFBxj7JhZ2TXh+P31USjCe+lmWy35ZYlqp9aOEoWS6uKq3hr3XZ3qmLNNyZHxtmW2XGibPobT/nnH8AWNkWdqcNOX4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"legacy kafka rails\"\n        title=\"legacy kafka rails\"\n        src=\"/static/468291585c9cbd21b4cb4ce7f593968b/5a190/legacy-kafka-rails-zoom.png\"\n        srcset=\"/static/468291585c9cbd21b4cb4ce7f593968b/772e8/legacy-kafka-rails-zoom.png 200w,\n/static/468291585c9cbd21b4cb4ce7f593968b/e17e5/legacy-kafka-rails-zoom.png 400w,\n/static/468291585c9cbd21b4cb4ce7f593968b/5a190/legacy-kafka-rails-zoom.png 800w,\n/static/468291585c9cbd21b4cb4ce7f593968b/c1b63/legacy-kafka-rails-zoom.png 1200w,\n/static/468291585c9cbd21b4cb4ce7f593968b/82f58/legacy-kafka-rails-zoom.png 1387w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">We'll be focusing on the Rails side of things. Assume that another team is maintaining the inventory management system and they've already modified it to produce JSON formatted messages every time there's an inventory change. Here's an example message showing that the product identified by product code <code>ABCD1234</code> has 23 units left in stock:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;product_code&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;ABCD1234&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;inventory_count&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">23</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">These messages will be produced to a Kafka topic named <code>inventory_management_product_updates</code>. When integrating Kafka, it's important for all the teams involved to agree on the topic name(s) and message formats, essentially agreeing on a \"contract\". This will ensure that the disparate systems can communicate with each other as expected.</p>\n<aside class=\"markdown-aside\">\nWhen it comes to Kafka topic naming conventions, there are many different <a class=\"markdown-link\" href=\"https://cnr.sh/essays/how-paint-bike-shed-kafka-topic-naming-conventions\">opinions</a> such as whether to include <a class=\"markdown-link\" href=\"https://www.kadeck.com/blog/kafka-topic-naming-conventions-5-recommendations-with-examples\">version numbers</a> or not. It's beyond the scope of this post to cover all of these. If your organization has already established a naming convention, use that.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"rails-product\" style=\"position:relative;\"><a href=\"#rails-product\" aria-label=\"rails product permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rails Product</h2>\n<p class=\"markdown-para\">For this demo, I used Ruby 3.1.2, Rails 7.x and the default options for a new project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ruby --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ruby 3.1.2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Rails 7.0.4.3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails new karafka_rails_consumer_demo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> karafka_rails_consumer_demo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate model product name:string code:string price:decimal inventory:integer</span></span></span></code></pre>\n<p class=\"markdown-para\">The Rails application has a <code>products</code> table to store the product name, product code, price, and inventory count. Here is the migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20230524104551_create_products.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateProducts</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:products</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">decimal</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:price</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">integer</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:inventory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the corresponding <code>Product</code> model with some validations added. I'm using the <a href=\"https://github.com/ctran/annotate_models\" class=\"markdown-link\">annotate</a> gem to automatically generate schema information as comments in the model class when migrations are run via <code>bin/rails db:migrate</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: products</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  code       :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  inventory  :integer          default(0), not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  name       :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  price      :decimal(, )      not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Product</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:price</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:inventory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">inspect</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;#&lt;Product id: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, name: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, code: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">code</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, price: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">formatted_price</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, inventory: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">inventory</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&gt;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">formatted_price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">format</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;%.2f&quot;</span><span class=\"mtk1\">, price)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nNot critical to this demo, but since the prices are stored as a decimal column in the database, a format method is added to the model, and the inspect method is overridden to use it. This is so when products are displayed in the console for debugging purposes, it will show a price like 47.53 rather than 0.4753e2. Also note that for a real application, the precision and scale would be defined such as decimal(10, 2) but this simple demo is using the default SQLite database which doesn't support specifying these.\n</aside>\n<p class=\"markdown-para\">In development, the <code>products</code> table is populated with seed data, using the <a href=\"https://github.com/faker-ruby/faker\" class=\"markdown-link\">faker</a> gem:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/seeds.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;faker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">development?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">destroy_all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">20</span><span class=\"mtk1\">.</span><span class=\"mtk5\">times</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Commerce</span><span class=\"mtk1\">.</span><span class=\"mtk5\">product_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Alphanumeric</span><span class=\"mtk1\">.</span><span class=\"mtk5\">alpha</span><span class=\"mtk1\">(</span><span class=\"mtk4\">number:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">).</span><span class=\"mtk5\">upcase</span><span class=\"mtk7\">}#{</span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Number</span><span class=\"mtk1\">.</span><span class=\"mtk5\">number</span><span class=\"mtk1\">(</span><span class=\"mtk4\">digits:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">price:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Commerce</span><span class=\"mtk1\">.</span><span class=\"mtk5\">price</span><span class=\"mtk1\">(</span><span class=\"mtk4\">range:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk7\">..</span><span class=\"mtk4\">100.0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rand</span><span class=\"mtk1\">(</span><span class=\"mtk4\">0</span><span class=\"mtk7\">..</span><span class=\"mtk4\">50</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Seeding skipped. Not in development environment.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The products can be viewed in a Rails console <code>bin/rails c</code></p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product id: 41, name: Awesome Wool Gloves, code: JANW7810, price: 47.53, inventory: 10&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product id: 42, name: Durable Steel Plate, code: BMJG7868, price: 96.25, inventory: 3&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product id: 43, name: Ergonomic Paper Bag, code: FLMA2165, price: 52.46, inventory: 6&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"install-kafka\" style=\"position:relative;\"><a href=\"#install-kafka\" aria-label=\"install kafka permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install Kafka</h2>\n<p class=\"markdown-para\">Even though we'll be focused on consuming messages in the Rails application, we're going to need to produce messages to try it out. This means we'll need access to a Kafka cluster, which includes one or more brokers, and <a href=\"https://zookeeper.apache.org/\" class=\"markdown-link\">Zookeeper</a> to manage the cluster. While you could point to a shared cluster if your organization manages their own or uses <a href=\"https://www.confluent.io/\" class=\"markdown-link\">Confluent</a> (Kafka as a service), I prefer to think of this similar to a database. In the same way that every developer working on a Rails application has their own local database installed, Kafka is also a kind of database (specifically, a raw, distributed database). It could get messy if all developers are pointing to a shared cluster, producing test messages that end up getting consumed by other developers running their own tests.</p>\n<p class=\"markdown-para\">The easiest way to set up a Kafka cluster locally is with Docker and docker-compose. Confluent provides these images in their <a href=\"https://github.com/confluentinc/cp-all-in-one\" class=\"markdown-link\">cp-all-in-one</a> repository. Just two containers are required for a minimal cluster - a broker, and a zookeeper instance. Add the following <code>docker-compose.yml</code> file to the root of the project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;2&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">zookeeper</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">confluentinc/cp-zookeeper:7.2.1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">hostname</span><span class=\"mtk1\">: </span><span class=\"mtk6\">zookeeper</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;2181:2181&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">ZOOKEEPER_CLIENT_PORT</span><span class=\"mtk1\">: </span><span class=\"mtk4\">2181</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">ZOOKEEPER_TICK_TIME</span><span class=\"mtk1\">: </span><span class=\"mtk4\">2000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">broker</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">confluentinc/cp-server:7.2.1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">hostname</span><span class=\"mtk1\">: </span><span class=\"mtk6\">broker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">zookeeper</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;9092:9092&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;9101:9101&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_BROKER_ID</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_ZOOKEEPER_CONNECT</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;zookeeper:2181&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class=\"mtk1\">: </span><span class=\"mtk6\">PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_ADVERTISED_LISTENERS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">PLAINTEXT://broker:29092,PLAINTEXT_HOST://localhost:9092</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_METRIC_REPORTERS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">io.confluent.metrics.reporter.ConfluentMetricsReporter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS</span><span class=\"mtk1\">: </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_CONFLUENT_LICENSE_TOPIC_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_CONFLUENT_BALANCER_TOPIC_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_TRANSACTION_STATE_LOG_MIN_ISR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_JMX_PORT</span><span class=\"mtk1\">: </span><span class=\"mtk4\">9101</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_JMX_HOSTNAME</span><span class=\"mtk1\">: </span><span class=\"mtk6\">localhost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">broker:29092</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_METRICS_ENABLE</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;true&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_SUPPORT_CUSTOMER_ID</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;anonymous&#39;</span></span></span></code></pre>\n<p class=\"markdown-para\">To start the containers, run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose up</span></span></code></pre>\n<p class=\"markdown-para\">Give it a few seconds to start, then check on the status in another terminal tab:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose ps</span></span></code></pre>\n<p class=\"markdown-para\">If all is well, the output should look something like this, showing that both zookeeper and a single broker are running, with the broker exposed on port 9092:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                 Name                              Command            State                       Ports</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">karafka_rails_consumer_demo_broker_1      /etc/confluent/docker/run   Up      0.0.0.0:9092-&gt;9092/tcp, 0.0.0.0:9101-&gt;9101/tcp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">karafka_rails_consumer_demo_zookeeper_1   /etc/confluent/docker/run   Up      0.0.0.0:2181-&gt;2181/tcp, 2888/tcp, 3888/tcp</span></span></code></pre>\n<aside class=\"markdown-aside\">\nThis tutorial is intentionally using just a single broker to keep the Kafka side simple. A real application would have multiple brokers with topics distributed and replicated across them for scalability and fault-tolerance. See this example <a class=\"markdown-link\" href=\"https://github.com/danielabar/kafka-getting-started-pluralsight/blob/main/docker-compose-multiple.yml\">docker-compose file</a> for a more advanced setup with multiple brokers and a <a class=\"markdown-link\" href=\"https://github.com/danielabar/kafka-getting-started-pluralsight#demo-fault-tolerance-and-resiliency\">demo</a> of how to use it.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"add-karafka-gem\" style=\"position:relative;\"><a href=\"#add-karafka-gem\" aria-label=\"add karafka gem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Add Karafka Gem</h2>\n<p class=\"markdown-para\">The Rails application needs to be enhanced so that it can consume messages from the <code>inventory_management_product_updates</code> Kafka topic. We're going to use the <a href=\"https://karafka.io/docs/\" class=\"markdown-link\">Karafka</a> gem to make the integration relatively easy. Some of the benefits of this gem include:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Abstracts complexities of working directly with the Kafka protocol.</li>\n<li class=\"markdown-list-item\">Leverages <a href=\"https://karafka.io/docs/Concurrency-and-multithreading/\" class=\"markdown-link\">multithreading</a> to achieve concurrency and high performance.</li>\n<li class=\"markdown-list-item\">Integrates easily with Rails, following <a href=\"https://karafka.io/docs/Routing/\" class=\"markdown-link\">routing</a> style conventions.</li>\n<li class=\"markdown-list-item\">Built in <a href=\"https://karafka.io/docs/Dead-Letter-Queue/\" class=\"markdown-link\">error handling</a> and retry logic.</li>\n<li class=\"markdown-list-item\">Testing utilities that make it easy to write <a href=\"https://karafka.io/docs/Testing/\" class=\"markdown-link\">automated tests</a> for consumers and producers.</li>\n<li class=\"markdown-list-item\">Provides both an open source and pro version with additional <a href=\"https://karafka.io/docs/Pro-Features-List/\" class=\"markdown-link\">advanced features</a>.</li>\n</ul>\n<p class=\"markdown-para\">To get started with Karafka, add the following to the project's <code>Gemfile</code> and then run <code>bundle install</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">gem &quot;karafka&quot;, &quot;&gt;= 2.0.34&quot;</span></span></code></pre>\n<p class=\"markdown-para\">Next run the karafka installation command which will setup some initial scaffolding:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec karafka install</span></span></code></pre>\n<p class=\"markdown-para\">This command will generate the main Karafka entrypoint file <code>karafka.rb</code> with some basic configuration, and an example topic and consumer:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># karafka.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  setup </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    config.</span><span class=\"mtk5\">kafka</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&quot;bootstrap.servers&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;127.0.0.1:9092&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    config.</span><span class=\"mtk5\">client_id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;example_app&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    config.</span><span class=\"mtk5\">consumer_persistence</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">development?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    topic </span><span class=\"mtk4\">:example</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      consumer ExampleConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Modify this file by replacing the <code>example</code> topic with the <code>inventory_management_product_updates</code> topic in the <code>routes.draw</code> block, and the example consumer with <code>ProductInventoryConsumer</code> (to be implemented shortly):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># config block...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    topic </span><span class=\"mtk4\">:inventory_management_product_updates</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      consumer ProductInventoryConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nFor this demo, there's no need to modify the default config block generated by Karafka. Recall the Kafka broker running in a docker container has exposed port 9092 so we'll be able to connect to it. In a real application, you would use environment variables to specify the location of the bootstrap servers and authentication information. There are also many more <a href=\"https://karafka.io/docs/Configuration/\" class=\"markdown-link\">configuration options</a>.\n</aside>\n<p class=\"markdown-para\">Now let's implement the <code>ProductInventoryConsumer</code> class. This is a class that inherits from <code>ApplicationConsumer</code>, which was also generated from the karafka installation command. The only method that's required to be implemented in a consumer class is the <code>consume</code> method, which will be invoked by Karafka with a batch of messages. For now, we will only log the message payload and <a href=\"https://github.com/danielabar/kafka-getting-started-pluralsight#consumer-offset-and-message-retention-policy\" class=\"markdown-link\">offset</a> to confirm messages are being received. The <code>consume</code> method also has access to the <code>topic</code> so let's log the topic name as well:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;ProductInventoryConsumer consuming Topic: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">topic.</span><span class=\"mtk5\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Message: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">,\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Offset: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">offset</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">To exercise this code, open a new terminal tab and run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec karafka server</span></span></code></pre>\n<p class=\"markdown-para\">This command initializes the Karafka application defined at <code>karafka.rb</code>, connects to the Kafka cluster specified by the <code>bootstrap.servers</code> config, starts consuming messages from the topics specified in the <code>routes.draw</code> block, and invokes the configured consumer classes to process those messages. The server will continuously listen for new messages until the process is terminated. The output of this command is as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running Karafka 2.1.0 server</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">See LICENSE and the LGPL-3.0 for licensing details</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polling messages...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polled 0 messages in 47.48299999954179ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polling messages...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polled 0 messages in 1000.3159999996424ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<p class=\"markdown-para\">In order to exercise the <code>ProductInventoryConsumer</code> code, messages need to be produced to the <code>inventory_management_product_updates</code> topic. In production, this will be done by the inventory management system. For local development, we don't have that system running on our laptops. Fortunately, Karafka can also be used to <a href=\"https://karafka.io/docs/Components/#producer\" class=\"markdown-link\">produce</a> messages. Let's try this out by launching a Rails console <code>bin/rails c</code> in another terminal tab and then enter the following code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Generate a message with the expected attributes in JSON format:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">code</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}.</span><span class=\"mtk5\">to_json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; &quot;{\\&quot;product_code\\&quot;:\\&quot;JANW7810\\&quot;,\\&quot;inventory_count\\&quot;:10}&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Produce and send a message to the `inventory_management_product_updates` topic:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">produce_async</span><span class=\"mtk1\">(</span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;inventory_management_product_updates&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">payload:</span><span class=\"mtk1\"> message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [ce1340a60c42] Async producing of a message to &#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   inventory_management_product_updates&#39; topic took 21.07400000002235 ms</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [ce1340a60c42] {:topic=&gt;&quot;inventory_management_product_updates&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   :payload=&gt;&quot;{\\&quot;product_code\\&quot;:\\&quot;JANW7810\\&quot;,\\&quot;inventory_count\\&quot;:10}&quot;}</span></span></span></code></pre>\n<p class=\"markdown-para\">After submitting the producer command, the terminal tab running the Karafka server will log output indicating the message has been consumed from topic <code>inventory_management_product_updates</code> and offset <code>0</code>. I've added some <code>=== EXPLANATIONS ===</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER STARTS PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[50b2762f16b2] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== CONSUMER INFO LEVEL LOGGING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ProductInventoryConsumer consuming: Topic: inventory_management_product_updates,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Message: {&quot;product_code&quot;=&gt;&quot;JANW7810&quot;, &quot;inventory_count&quot;=&gt;10}, Offset: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER FINISHES PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[50b2762f16b2] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 finished in 345.4149999995716ms</span></span></code></pre>\n<p class=\"markdown-para\">When there's a batch of messages ready to be processed, the <code>consume</code> method gets invoked with the <code>messages</code>, which can be iterated (in our simple case, there's only one message currently). Each of these is an instance of <a href=\"https://karafka.io/docs/code/karafka/Karafka/Messages/Message.html\" class=\"markdown-link\">Karafka::Messages::Message</a>. When the <code>payload</code> method is invoked on the <code>message</code> object, Karafka will deserialize it, which converts the raw Kafka message to a format you can work with in your Ruby code. By default, it uses JSON deserialization, which means it assumes the messages are in JSON format, and they will be deserialized into a Ruby hash. This is what's shown in the console output when we log <code>message.payload</code>. The Karafka docs have more details about <a href=\"https://karafka.io/docs/Deserialization/\" class=\"markdown-link\">deserialization</a>.</p>\n<aside class=\"markdown-aside\">\nFor those keeping count, that's three terminal tabs required to work with this application during development mode: First one to run the Kafka cluster in Docker containers, second one to run the Karafka server for consuming messages, and a third one to run a Rails console to produce messages. If you want to be able to view the output of these all at the same time, a simple way is to use the <a class=\"markdown-link\" href=\"https://iterm2.com/documentation-one-page.html\">Split Panes</a> feature of iTerm or <a class=\"markdown-link\" href=\"https://github.com/tmux/tmux/wiki\">tmux</a> for more advanced features.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"update-product\" style=\"position:relative;\"><a href=\"#update-product\" aria-label=\"update product permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Update Product</h2>\n<p class=\"markdown-para\">Now that we know we can produce and consume messages with Kafka, it's time to do the actual work of updating the product inventory. We saw from the previous exercise that a message like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;{\\&quot;product_code\\&quot;:\\&quot;JANW7810\\&quot;,\\&quot;inventory_count\\&quot;:10}&quot;</span></span></code></pre>\n<p class=\"markdown-para\">Gets deserialized to a Ruby hash when the <code>payload</code> method is invoked on it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&quot;JANW7810&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk4\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">This means the product code and inventory count can be accessed within the consumer as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Deserialize JSON message into a hash assigned to `payload`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Access payload attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Product code = </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;product_code&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># JANW7810</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Inventory count = </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;inventory_count&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># 10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">So updating the product inventory count could be done directly in the consumer like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">There are some problems with this approach as will be covered shortly, but first, let's exercise this version of the consumer to verify it works. Back in the Rails console, run the code shown below to check the inventory value of the first product, then produce a message to update it to a different value:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Check what the current inventory value is for the first product</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">inventory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 20</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Produce a message to update it to a different value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">code</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}.</span><span class=\"mtk5\">to_json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">produce_async</span><span class=\"mtk1\">(</span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;inventory_management_product_updates&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">payload:</span><span class=\"mtk1\"> message)</span></span></span></code></pre>\n<p class=\"markdown-para\">Now the tab running the Karafka server (consumer polling for messages), will show that the message has been received and the product inventory has been updated:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER STARTS PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d886a13043fd] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== RAILS DEV LOGGING FROM FINDING AND UPDATING PRODUCT ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.9ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;JANW7810&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.2ms)  begin transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Update (0.4ms)  UPDATE &quot;products&quot; SET &quot;inventory&quot; = ?, &quot;updated_at&quot; = ?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;id&quot; = ?  [[&quot;inventory&quot;, 123], [&quot;updated_at&quot;, &quot;2023-06-02 11:10:00.738034&quot;], [&quot;id&quot;, 41]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (2.1ms)  commit transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER FINISHES PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d886a13043fd] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 finished in 23.927999999839813ms</span></span></code></pre>\n<p class=\"markdown-para\">Back in the Rails console, fetch the product again and check its inventory count, it should be <code>123</code> from the Kafka message produced and consumed earlier:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">inventory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 123</span></span></span></code></pre>\n<p class=\"markdown-para\">Great it's working, ship it!</p>\n<p class=\"markdown-para\">Not so fast...</p>\n<h2 class=\"markdown-subtitle\" id=\"what-could-possibly-go-wrong\" style=\"position:relative;\"><a href=\"#what-could-possibly-go-wrong\" aria-label=\"what could possibly go wrong permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What Could Possibly Go Wrong?</h2>\n<p class=\"markdown-para\">In the previous section, we saw the happy path working. Now its time to think about things that could go wrong.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEA//EABYBAQEBAAAAAAAAAAAAAAAAAAIBA//aAAwDAQACEAMQAAABrylbNMIVf//EABoQAAICAwAAAAAAAAAAAAAAAAABAgMRE0H/2gAIAQEAAQUCkcJWtyVuDaf/xAAYEQACAwAAAAAAAAAAAAAAAAAAAQIiUf/aAAgBAwEBPwFxZbD/xAAXEQADAQAAAAAAAAAAAAAAAAAAAQIT/9oACAECAQE/AapNGx//xAAaEAACAgMAAAAAAAAAAAAAAAAAARAhIjJh/9oACAEBAAY/Ah1HDFUao//EAB0QAQABAwUAAAAAAAAAAAAAAAEAESFBEDFRYXH/2gAIAQEAAT8hilbpecaJHZ4Itpep2l//2gAMAwEAAgADAAAAEK/f/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAh8f/aAAgBAwEBPxBuEPa//8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAhUf/aAAgBAgEBPxDEMdl//8QAGhABAAMBAQEAAAAAAAAAAAAAAQARITFh4f/aAAgBAQABPxAUc267AgCdM08+xxpxMRi5wUyHCq83bLIWUzrP/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"what could possibly go wrong\"\n        title=\"what could possibly go wrong\"\n        src=\"/static/cb83bb05d8f118d8881b329eb784c7eb/4b190/what-could-go-wrong-fork-in-toaster.jpg\"\n        srcset=\"/static/cb83bb05d8f118d8881b329eb784c7eb/e07e9/what-could-go-wrong-fork-in-toaster.jpg 200w,\n/static/cb83bb05d8f118d8881b329eb784c7eb/066f9/what-could-go-wrong-fork-in-toaster.jpg 400w,\n/static/cb83bb05d8f118d8881b329eb784c7eb/4b190/what-could-go-wrong-fork-in-toaster.jpg 800w,\n/static/cb83bb05d8f118d8881b329eb784c7eb/72e01/what-could-go-wrong-fork-in-toaster.jpg 1024w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">For example, what if the inventory system sends a product code that the Rails e-commerce system doesn't have in its records? This could happen if the legacy system also manages in-store products that are not sold online, or maybe its buggy and no one quite understands how it works. Let's simulate this situation by producing a message in the Rails console for a non existing product code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;NO-SUCH-CODE&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}.</span><span class=\"mtk5\">to_json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">produce_async</span><span class=\"mtk1\">(</span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;inventory_management_product_updates&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">payload:</span><span class=\"mtk1\"> message)</span></span></span></code></pre>\n<p class=\"markdown-para\">Keep an eye on the terminal tab running the Karafka server, it will show a stack trace from attempting to consume this message:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[d886a13043fd] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.5ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO-SUCH-CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/gems/karafka-2.1.0/lib/karafka/messages/messages.rb:22:in `each&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/gems/karafka-2.1.0/lib/karafka/messages/messages.rb:22:in `each&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:3:in `consume&#39;</span></span></code></pre>\n<p class=\"markdown-para\">What's happening is that <code>nil</code> is returned from the <code>find_by</code> method, then it errors out attempting to call the <code>update!</code> method on the <code>nil</code> return:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This line returns `nil` when called with `code: &quot;NO-SUCH-CODE&quot;`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Which results in undefined method `update!` for nil:NilClass here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span></code></pre>\n<p class=\"markdown-para\">If you let the Karafka server keep running, you'll see the stack trace repeat several times, at increasing intervals of time. This is because Karafka's default behaviour is to keep retrying the failed message if an error is raised, according to a back-off strategy, up until a maximum value of 30,000 ms is reached (30 seconds), at which point, it will keep trying every 30 seconds:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d854346b76bf] Retrying of ProductInventoryConsumer after 2000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[8d4c56ce8e62] Retrying of ProductInventoryConsumer after 8000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[15a4dead41b2] Retrying of ProductInventoryConsumer after 16000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[8f894960f0ac] Retrying of ProductInventoryConsumer after 30000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># keeps retrying every 30000 ms</span></span></code></pre>\n<p class=\"markdown-para\">This behaviour is controlled by the following config settings, which get assigned default values. Here's a snippet from the Karafka source <a href=\"https://github.com/karafka/karafka/blob/master/lib/karafka/setup/config.rb\" class=\"markdown-link\">Karafka::Setup::Config</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># option [Boolean] should we use exponential backoff</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">setting </span><span class=\"mtk4\">:pause_with_exponential_backoff</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># option [Integer] what is the max timeout in case of an exponential backoff (milliseconds)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">setting </span><span class=\"mtk4\">:pause_max_timeout</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">30_000</span></span></span></code></pre>\n<p class=\"markdown-para\">Without error handling, it will keep trying to process this message, and not move on to other messages (because the offset of the bad message will not be committed). So clearly, some error handling is needed.</p>\n<h2 class=\"markdown-subtitle\" id=\"dead-letter-queue\" style=\"position:relative;\"><a href=\"#dead-letter-queue\" aria-label=\"dead letter queue permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dead Letter Queue</h2>\n<p class=\"markdown-para\">In terms of writing the least amount of application code, the easiest way to get error handling with Karafka is to configure a <a href=\"https://karafka.io/docs/Dead-Letter-Queue/\" class=\"markdown-link\">Dead Letter Queue</a> (DLQ) per each topic. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># karafka.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># config block...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    topic </span><span class=\"mtk4\">:inventory_management_product_updates</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      consumer ProductInventoryConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">dead_letter_queue</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># name this as per your organization&#39;s naming conventions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;dlq_inventory_management_product_updates&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">max_retries:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With this approach, if any error is raised during message processing, Karafka will automatically retry up to a configured number of <code>max_retries</code> (which can also be set to zero if you don't ever want it to retry). If message processing still fails after the retries are exhausted, a new message containing the same header and payload as the troublesome message will be produced to the topic specified in the <code>dead_letter_queue</code> method, in this case, <code>dlq_inventory_management_product_updates</code>.</p>\n<p class=\"markdown-para\">With the modified <code>karafka.rb</code> in place (remember to restart the karafka server <code>bundle exec karafka server</code> after making changes to <code>karafka.rb</code>), producing an inventory update message with a product code that does not exist will generate the following log messages in the Karafka server. I've annotated them with <code>=== EXPLANATION ===</code>, which shows that after consuming the bad message, Karafka will make two more attempts to process it. If those still fail, it writes the message the the topic <code>dlq_inventory_management_product_updates</code>, then moves on, waiting to consume new messages:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== START CONSUMING BAD MESSAGE ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d13504295353] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.2ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...stack trace...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== FIRST RETRY ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[fa875ec2db84] Retrying of ProductInventoryConsumer after 2000 ms on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d13504295353] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.1ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...stack trace...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== SECOND RETRY ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[76694e052832] Retrying of ProductInventoryConsumer after 4000 ms on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d13504295353] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.2ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...stack trace...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== WRITE BAD MESSAGE TO DLQ ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[23c9519eb294] Async producing of a message to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &#39;dlq_inventory_management_product_updates&#39; topic took 1.7790000000968575 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[23c9519eb294] {:topic=&gt;&quot;dlq_inventory_management_product_updates&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  :payload=&gt;&quot;{\\&quot;product_code\\&quot;:\\&quot;NO_SUCH_CODE\\&quot;,\\&quot;inventory_count\\&quot;:5}&quot;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d1e59c1bd1df] Dispatched message 1 from inventory_management_product_updates/0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  to DLQ topic: dlq_inventory_management_product_updates</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== OFFSET COMMITTED, READY TO PROCESS MORE MESSAGES ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[316f38a98a31] Pausing on topic inventory_management_product_updates/0 on offset 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[bc51bb551a3f] Polling messages...</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"error-monitoring\" style=\"position:relative;\"><a href=\"#error-monitoring\" aria-label=\"error monitoring permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Error Monitoring</h2>\n<p class=\"markdown-para\">It's also useful to capture the error messages and stack traces in your error tracking/monitoring tool of choice (Sentry, Rollback, etc.). Karafka provides a <a href=\"https://karafka.io/docs/Monitoring-and-logging/\" class=\"markdown-link\">monitoring API</a> that allows you to subscribe to instrumentation events, and deal with them as you wish.</p>\n<p class=\"markdown-para\">Add this block to the <code>karafka.rb</code> file in the project root, between the configuration block and the routes to extract the error object and stack trace from the <code>event</code> and log them. Additionally here is where you would log to whatever error monitoring service you use:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># frozen_string_literal: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  setup </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># config...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Common error handling example</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">monitor</span><span class=\"mtk1\">.</span><span class=\"mtk5\">subscribe</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;error.occurred&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |event|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    type </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> event[</span><span class=\"mtk4\">:type</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    error </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> event[</span><span class=\"mtk4\">:error</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    details </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> (error.</span><span class=\"mtk5\">backtrace</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> []).</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;An error: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">error</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of type: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">type</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> occurred, details: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">details</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Or whatever error monitoring service Airbrake, Rollbar, etc.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Sentry</span><span class=\"mtk1\">.</span><span class=\"mtk5\">capture_exception</span><span class=\"mtk1\">(error)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># topics and consumers...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now whenever an error occurs in the consumer, the message and stack trace will get logged, and additionally you can notify whatever error monitoring service you use such as Sentry, Rollbar, etc. The message that caused the error will still get produced to the DLQ as per the topic configuration.</p>\n<p class=\"markdown-para\">While we could use the DLQ, together with Karafka's built-in error monitoring and simply let Karafka deal with all errors, it will be cleaner to also have the business logic be more resilient, and ensure the system produces useful error messages. Otherwise some poor soul in production support is going to be dealing with a bunch of failed messages in the dead letter queue and have no idea what's gone wrong. That could be you if developers are also responsible for production support at your company!</p>\n<p class=\"markdown-para\">The other issue with this approach is there's some wasted processing with the retries. For example, if the product code does not exist in the e-commerce system, there's no point retrying the message because it still won't exist. While this can be mitigated by setting <code>max_retries: 0</code>, there could be other errors which should be retried such as if a network blip occurs and the database is temporarily unreachable.</p>\n<aside class=\"markdown-aside\">\nYou may have noticed that we never had to run any explicit commands to create the topics such as \"inventory_management_product_updates\" and \"dlq_inventory_management_product_updates\", they just appeared when we needed them. In development mode, Karafka will automatically create topics the first time a message is produced, if the topic does not already exist in the cluster. It will be created with default settings of one partition and a single replica, which is almost never what you would want in production. In production, you should ensure the topics have been created before deploying the consumer code.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"validation-in-consumer\" style=\"position:relative;\"><a href=\"#validation-in-consumer\" aria-label=\"validation in consumer permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Validation in Consumer</h2>\n<p class=\"markdown-para\">As a first attempt at making the code more resilient, the consumer could be modified to check if the product exists, before attempting an update, otherwise log an error and manually dispatch to the dead letter queue (Karafka will only automatically produce a message to the DLQ when an exception is raised):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> product.</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Product </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;product_code&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> does not exist&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With this in place, producing a message with an non-existing product code will result in logging an error, and the invalid message dispatched to the dead letter queue without any retries. Here's what this looks like in the Karafka server logs, again I've added <code>=== EXPLANATIONS ===</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== START CONSUMING MESSAGE ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ce8640c13bf0] Polled 1 messages in 1004.0149999996647ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ac5cf1c6d557] Consume job for ProductInventoryConsumer</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  on inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== CHECK IF PRODUCT EXISTS ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.4ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== RAILS LOGGER ERROR ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Product NO_SUCH_CODE does not exist</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== DISPATCH TO DQL ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[12cb723b4056] Async producing of a message to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &#39;dlq_inventory_management_product_updates&#39; topic took 0.9180000005289912 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[12cb723b4056] {:topic=&gt;&quot;dlq_inventory_management_product_updates&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  :payload=&gt;&quot;{\\&quot;product_code\\&quot;:\\&quot;NO_SUCH_CODE\\&quot;,\\&quot;inventory_count\\&quot;:5}&quot;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[89c41457fc4c] Dispatched message 2 from</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 to DLQ topic: dlq_inventory_management_product_updates</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ac5cf1c6d557] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 finished in 275.4199999999255ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== READY FOR MORE MESSAGES ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ce8640c13bf0] Polling messages...</span></span></code></pre>\n<p class=\"markdown-para\">While this works, the consumer is starting to get a little messy. And it will continue to get messier as more validation rules are enforced. For example, in the e-commerce system, there's a constraint that the inventory count must be greater than zero, recall the product model has:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Product</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other validations...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:inventory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Suppose the inventory management system could send negative inventory counts, or blank values. It might do this if the business rules in the legacy system are different than those in the e-commerce system, or again, it could be buggy and not enough time/people to deal with the legacy system quirks. The consumer could be modified to handle this case as well:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> product.</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Inventory count cannot be negative&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Product </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;product_code&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> does not exist&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">At this point, if the project is using <a href=\"https://rubocop.org/\" class=\"markdown-link\">Rubocop</a> with a default configuration, this code will light up with some offenses warning that the complexity of the <code>consume</code> method is too high and that the method is too long:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">app/consumers/product_inventory_consumer.rb:2:3:C: Metrics/AbcSize:Assignment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Branch Condition size for consume is too high. [&lt;3, 16, 6&gt; 17.35/17]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  def consume ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ^^^^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/consumers/product_inventory_consumer.rb:2:3: C: Metrics/MethodLength:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  def consume ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ^^^^^^^^^^^</span></span></code></pre>\n<p class=\"markdown-para\">While one could debate the max method length rule (default value is 10, perhaps 15 is reasonable), the complexity warning should not be ignored. The Rubocop <a href=\"https://docs.rubocop.org/rubocop/cops_metrics.html#metricsabcsize\" class=\"markdown-link\">Abc rule</a> calculates the complexity of a method by considering the number of assignments (A), branches (B), aka method calls, and conditions (C) and comparing it to a maximum threshold. In this case, it's calculated a score of <code>17.35</code> which exceeds the default threshold of <code>17</code>.</p>\n<p class=\"markdown-para\">One way to resolve this is to break up the <code>consume</code> method into smaller methods, for example, the validation and error handling could be extracted as separate methods. But this is just a simple example. A real application could be many more rules. For example, the e-commerce system could have a concept of active vs inactive products where only the active ones should have their inventory updated.</p>\n<aside class=\"markdown-aside\">\nAnother technique that can help with some validation issues when using Kafka is a <a class=\"markdown-link\" href=\"https://docs.confluent.io/platform/current/schema-registry/index.html\">schema registry</a>, although you will probably still want some business level validation in the application. This is an advanced topic that won't be covered in this post. You can also check out this <a class=\"markdown-link\" href=\"https://github.com/danielabar/karafka_avro_demo\">demo project</a> showing how to use the Avro schema format with a Confluent Schema Registry from a Ruby application with the Karafka gem.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"too-much-responsibility\" style=\"position:relative;\"><a href=\"#too-much-responsibility\" aria-label=\"too much responsibility permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Too Much Responsibility</h2>\n<p class=\"markdown-para\">The real issue here is that the Kafka consumer as currently written, is taking on too many responsibilities. These include:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Deserializing the message payloads received from the broker.</li>\n<li class=\"markdown-list-item\">Implementing business rules with validation on the message payload.</li>\n<li class=\"markdown-list-item\">Implementing business logic in updating the product inventory count.</li>\n<li class=\"markdown-list-item\">Producing new messages to the dead letter queue topic in case of validation errors.</li>\n</ol>\n<p class=\"markdown-para\">A useful way of thinking about this is to compare the consumer to a Rails controller. With a controller, its responsibilities should be limited to handling http requests and responses, while business logic should be delegated to services and/or models. This makes testing of business logic easier because its isolated from the complexity of http request and response handling.</p>\n<p class=\"markdown-para\">Applying this way of thinking to a Kafka consumer, we can say that it should only be concerned with Kafka-specific things such as communicating with the broker to consume and produce messages, and deserializing and serializing message payloads. To simplify the consumer, we will apply two concepts:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">A model, initialized with the message payload hash, to perform all business rule validations.</li>\n<li class=\"markdown-list-item\">A service to check if the model is valid, and only perform the business logic update if the model is valid.</li>\n</ol>\n<h2 class=\"markdown-subtitle\" id=\"model\" style=\"position:relative;\"><a href=\"#model\" aria-label=\"model permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Model</h2>\n<p class=\"markdown-para\">Typically in a Rails application, a model is a class that inherits from <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Base.html\" class=\"markdown-link\">ActiveRecord</a> and has an underlying database table. Then it has access to the <code>validates</code> and <code>validate</code> macros to perform validations such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SomeModel</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:some_attribute</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:my_custom_method?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">my_custom_method?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do some custom validation...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">These validation macros are very useful, and could help us clean up the consumer code by providing a model class whose sole responsibility is to indicate whether the message payload is valid, and if its not, list the error messages indicating what's wrong with it. But we don't have a database table specifically for the messages coming from Kafka and it would be overkill to create one. Fortunately, Rails has a solution for this. The <a href=\"https://guides.rubyonrails.org/active_model_basics.html\" class=\"markdown-link\">ActiveModel::Model</a> module can be included in any class. It provides a way to create model-like objects that have many of the same features as traditional Rails models, but are not backed by a database table.</p>\n<p class=\"markdown-para\">This new model will be named <code>ProductInventoryForm</code>. There's no naming convention on these, but the <code>Form</code> part of the name indicates that instances of this class are used to temporarily collect input data. Here is the model class, which includes <code>ActiveModel::Model</code>, defines attributes from the Kafka message <code>product_code</code> and <code>inventory_count</code>, and specifies validation using the <code>validates</code> and <code>validate</code> macros:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product_inventory_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:inventory_count</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:inventory_count</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Only invoke the `product_exists?` validation if there are no validation errors with product_code.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># For example, if product_code is blank, it doesn&#39;t make sense to try and check if it exists.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This is accomplished by specifying a &quot;stabby lamda&quot; (i.e. anonymous function) to the &quot;if&quot; hash key,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># i.e. the `validate` method accepts a hash of options, one of them being `if` to specify the conditions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># under which the given validation should run.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:product_exists?</span><span class=\"mtk1\">, </span><span class=\"mtk4\">if:</span><span class=\"mtk1\"> </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> { errors[</span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">].</span><span class=\"mtk5\">blank?</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">product_exists?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors.</span><span class=\"mtk5\">add</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">product_code</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> does not exist&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">exists?</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> product_code)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's launch a Rails console (<code>bin/rails c</code>) to experiment with this model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Instantiate an empty model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Including ActiveModel::Model exposes the `valid?` method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># We can also access the error messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#      &quot;Product code can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#      &quot;Inventory count can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#      &quot;Inventory count is not a number&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#    ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Instantiate a model with a hash to populate the attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This should be considered invalid because</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># product code does not exist and inventory is negative:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">({</span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;FOO&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">-</span><span class=\"mtk4\">5</span><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk3\">#&lt;ProductInventoryForm:0x000000010e7f93d8 @inventory_count=-5, @product_code=&quot;FOO&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run the validation rules. It runs a query against the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># products table due to the custom `product_exists?` validation.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Product Exists? (0.4ms)  SELECT 1 AS one FROM &quot;products&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;FOO&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Check the error messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     &quot;Inventory count must be greater than or equal to 0&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     &quot;Product code FOO does not exist&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Build a valid model: code exists and inventory count positive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">({</span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">15</span><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; #&lt;ProductInventoryForm:0x0000000110761540 @inventory_count=15, @product_code=&quot;JANW7810&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This time, the product code exists so the model is valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Product Exists? (0.3ms)  SELECT 1 AS one FROM &quot;products&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;JANW7810&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># And no error messages are populated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># []</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nI'm placing this in the \"app/models\" directory but if you prefer, these kind of models could go in a different directory such as \"app/form_objects\" if you want to keep them separate from the models backed by a database table. Just remember to update \"config.autoload_paths\" in \"config/application.rb\" to include the new directory.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"service\" style=\"position:relative;\"><a href=\"#service\" aria-label=\"service permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Service</h2>\n<p class=\"markdown-para\">With the <code>ProductInventoryForm</code> model in place, we have all the validation rules needed to replace the nested conditionals that are in the consumer. The next step is to introduce a service to make use of the model for validity checks, and to do the product updating.</p>\n<aside class=\"markdown-aside\">\nUnlike models, views, and controllers, a service is not a built-in Rails component, but it's very useful as a place for organizing business logic. Services are often used to encapsulate complex operations or interactions with external systems. See this RailsConf 2022 talk titled <a class=\"markdown-link\" href=\"https://youtu.be/CRboMkFdZfg\">Your Service Layer Needn't be Fancy, It Just Needs to Exist</a> to learn about the benefits of having a service layer and some practical examples how to implement it.\n</aside>\n<p class=\"markdown-para\">Create a new directory <code>app/services</code> in your project, and add the <code>UpdateProductInventoryService</code> class as shown below:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/services/update_product_inventory_service.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">UpdateProductInventoryService</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_reader</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:errors</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This will be initialized with the message payload from Kafka.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @errors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The `process` method returns true if update succeeded, false otherwise,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># with an array of error messages.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Instantiate the form object with the message payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    product_inventory_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(payload)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># If the &quot;form&quot; is valid, update product inventory, and return true.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Otherwise, populate `errors` from form validation messages, and return false.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> product_inventory_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">update_product</span><span class=\"mtk1\">(product_inventory_form)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Use the splat operator `*` to push each element of the form objects&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># validation messages to the service `errors` array.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk7\">*</span><span class=\"mtk1\">product_inventory_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Update product using `product_code` and `inventory_count` attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># from the form object.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">update_product</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">product_inventory_form</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> product_inventory_form.</span><span class=\"mtk5\">product_code</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> product_inventory_form.</span><span class=\"mtk5\">inventory_count</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This service is initialized with the message payload from Kafka, which recall, is just a hash, making it easy to test this class outside of having Kafka running. It also initializes an empty <code>errors</code> array. The <code>process</code> method instantiates a <code>ProductInventoryForm</code> with the payload, then checks if the inputs are valid by invoking the <code>valid?</code> method on the form object. Recall we saw in the previous section that the <code>valid?</code> method will run all the validation rules we defined on the form object.</p>\n<p class=\"markdown-para\">If the input is valid, it updates the product inventory by looking up the <code>product_code</code> from the form object, and updating it with the given <code>inventory_count</code> from the form object. If the input is invalid, the service <code>errors</code> array is populated with the error messages from the form object, which are available by calling <code>product_inventory_form.errors.full_messages</code>.</p>\n<p class=\"markdown-para\">Remember to tell Rails that this new directory should be auto loaded by adding the following to your configuration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/application.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">config.</span><span class=\"mtk5\">autoload_paths</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">root</span><span class=\"mtk1\">.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;services&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"refactor-consumer\" style=\"position:relative;\"><a href=\"#refactor-consumer\" aria-label=\"refactor consumer permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Refactor Consumer</h2>\n<p class=\"markdown-para\">Now that we have a model for validations, and a service for business logic, the consumer can be refactored to take on less responsibilities. This will eliminate the complexity warning from Rubocop and make the code more maintainable.</p>\n<p class=\"markdown-para\">In the version shown below, the consumer instantiates the <code>UpdateProductInventoryService</code> by passing it the message payload, and then invokes the <code>process</code> method on the service. If the <code>process</code> method does not return a truthy value, an error message is logged containing the original payload, and all the service error messages, then the message is moved to the dead letter queue:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;ProductInventoryConsumer consuming Topic: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">topic.</span><span class=\"mtk5\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Message: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">,\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Offset: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">offset</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      service </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">UpdateProductInventoryService</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(message.</span><span class=\"mtk5\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">handle_service_errors</span><span class=\"mtk1\">(message, service.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">) </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> service.</span><span class=\"mtk5\">process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">handle_service_errors</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">message</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">errors</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;ProductInventoryConsumer message invalid: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">errors.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;, &#39;</span><span class=\"mtk1\">)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered a technique for integrating Kafka into a Rails application using the <a href=\"https://karafka.io/docs/\" class=\"markdown-link\">Karafka</a> gem, including how to do error handling and use the dead letter queue. We also learned how to avoid complexity in the consumer by limiting its responsibilities to communicating with Kafka, while introducing a model for validations, and a service for business logic. This makes each component easier to maintain. This post got quite lengthy so I'm not including the tests here, but you can try out the <a href=\"https://github.com/danielabar/karafka_rails_consumer_demo\" class=\"markdown-link\">demo project</a> including tests in the <a href=\"https://github.com/danielabar/karafka_rails_consumer_demo/tree/main/spec\" class=\"markdown-link\">spec</a> directory on Github.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-kafka-consumer/"}}},{"node":{"id":"fff6ecc2-0dbb-59b1-80bb-97c0c24f82dd","frontmatter":{"title":"They Don't All Have To Be ActiveRecord Models","date":"September 2023","category":"rails"},"excerpt":"Rails makes it relatively easy to go from an idea to a working web application. If you follow along with the Getting Started with Railsâ€¦","html":"<p class=\"markdown-para\">Rails makes it relatively easy to go from an idea to a working web application. If you follow along with the <a href=\"https://guides.rubyonrails.org/getting_started.html\" class=\"markdown-link\">Getting Started with Rails</a> guide, you can see how straightforward it is to go from an idea of a blog application with articles that have that have a title and body text, to creating a database table that stores articles, a model to represent the articles and validation rules, views that render HTML to display articles, and a controller to handle http request/responses, and delegate to the model to perform the <a href=\"https://en.wikipedia.org/wiki/Create,_read,_update_and_delete\" class=\"markdown-link\">CRUD</a> operations.</p>\n<p class=\"markdown-para\">There's also plenty of online tutorials and courses that cover creating a Rails application from start to finish for other domains besides a blogging application. Going through any of these will give you a sense of how Rails can be used to represent just about any domain where you want to build a web app to expose CRUD operations on a relational data model.</p>\n<p class=\"markdown-para\">However, all of the learning materials that I have seen make an assumption that there is always a one to one relationship between each form field that will be displayed in the web view, and the underlying database table that will be persisted. For example a Pluralsight course I took on <a href=\"https://www.pluralsight.com/courses/adding-user-resource-rails-application\" class=\"markdown-link\">Adding Resources to a Rails Application</a> covered building a cryptocurrency tracking application. Here's the new cryptocurrency creation form from the course, notice that the fields shown in the form map neatly to the underlying table:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA30lEQVR42k1Qy4qEMBDM/3/V7E3w4GnHQdDdjCAqiCaal68aKpBlG4qEoru6usR5nrA+QOsVSi1YlgUhBBzH8QcW+9L/vu/Yp7XGPM9QSkVs2wYRvIc2Dt+vClL+YhxHGGOiKGGtRV3XWNcVzrkovO87qqpC13VomgZt20JKib7vITjk9wPPnzeKooibOUSeL11kWRYdTNOEYRjiy8XkKH5dF1IJ7z2M83g2b3w9HijLMoqRZzOHKJjnefyzyNM1QZfsZQzkBXNxPsA6H8/jWenc/2czBg6kPJM7IuVLfAAzKn5YXfL5RwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar cryptocurrency table vs form\"\n        title=\"not all ar cryptocurrency table vs form\"\n        src=\"/static/acad850593b0427e9ec84bdc6c969414/5a190/not-all-ar-cryptocurrency-table-vs-form.png\"\n        srcset=\"/static/acad850593b0427e9ec84bdc6c969414/772e8/not-all-ar-cryptocurrency-table-vs-form.png 200w,\n/static/acad850593b0427e9ec84bdc6c969414/e17e5/not-all-ar-cryptocurrency-table-vs-form.png 400w,\n/static/acad850593b0427e9ec84bdc6c969414/5a190/not-all-ar-cryptocurrency-table-vs-form.png 800w,\n/static/acad850593b0427e9ec84bdc6c969414/1843f/not-all-ar-cryptocurrency-table-vs-form.png 1186w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">This symmetry between the UI form and the underlying table is very nice for learning. But what I've found in the \"real world\" is that often, the interface presented in the web view does not exactly match the database table, due to complex business requirements. Then it's not obvious how to make use of all the Rails niceties around form binding to the model, validations and saving. This post will show a technique that can be used when there's a mismatch between a form presented to a user, and what needs to be persisted in the database.</p>\n<aside class=\"markdown-aside\">\nA quick note before moving on - this post assumes you already have a basic understanding of Rails fundamentals including how to build a simple web application with models, views, and controllers. If you don't, checkout the <a class=\"markdown-link\" href=\"https://guides.rubyonrails.org/getting_started.html\">Getting Started with Rails Guides</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"example\" style=\"position:relative;\"><a href=\"#example\" aria-label=\"example permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example</h2>\n<p class=\"markdown-para\">Consider an example of a back office for some application where administrators will fill out a form to create new customers. The <code>customers</code> table will persist email, first and last names. However, the form also has a field for the customers age. It's used for validation where customer must be greater than a certain age, but it will not be persisted to table, therefore its not part of customer model. A more complex case might be that the form asks for SIN/SSN to validate against an external service, but this value is not required to be persisted.</p>\n<p class=\"markdown-para\">Here's a visual, notice that most of the fields in the new customer creation form map to the <code>customers</code> table, but the \"age\" field does not, because the requirements are that it should not be persisted in the database:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABNklEQVR42pVSyU7DQAztt/MjnPgJDj1UHJAAoSi0kFWhIkoTaJbJOkvzkB1NRW/F0hvP2J7n50lWWmu0/YimaRhKKVDsr5/nmUFnstPphKIoGHmeI01T1HXNuZWSEj91i8enZyRJwpeklIxpmmCMQRAE2O/3HLOknuchjmPO7XY7ZFm2EGql0I0SjhcjCnyUZXlWRgSkxnVdvtj3PasiPwwjZlwa1TJh0w14ixK4joOvNGVVViXtoyhiNVVV4XA4QAiB47GEaDtIpaG1YRFnwnaY8Pru42GzQRiGF2NTkeM4WK/XPDa9JSkUooHRihtSjfUrWpYR9cXHoAILipFtt1tWSuesqPBdjegHyU3OhPiH2YaYDe7ufdzcvuDjs+KcVGohtL/ENbBGe9GNKJsBk1zGpmYU/wVm9meWBt66TQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar customer table vs form\"\n        title=\"not all ar customer table vs form\"\n        src=\"/static/cca5818d4489d34eb0b7b098cebce4e0/5a190/not-all-ar-customer-table-vs-form.png\"\n        srcset=\"/static/cca5818d4489d34eb0b7b098cebce4e0/772e8/not-all-ar-customer-table-vs-form.png 200w,\n/static/cca5818d4489d34eb0b7b098cebce4e0/e17e5/not-all-ar-customer-table-vs-form.png 400w,\n/static/cca5818d4489d34eb0b7b098cebce4e0/5a190/not-all-ar-customer-table-vs-form.png 800w,\n/static/cca5818d4489d34eb0b7b098cebce4e0/1843f/not-all-ar-customer-table-vs-form.png 1186w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">If we ignore the complexity of the \"age\" field for the moment, the majority of this requirement could be implemented with the <a href=\"https://www.rubyguides.com/2020/03/rails-scaffolding/\" class=\"markdown-link\">scaffold</a> generator. This will create a migration, model, controller, and all the CRUD views for the Customer model, specifying the fields that should be persisted for each customer:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate scaffold customer email:string first_name:string last_name:string</span></span></code></pre>\n<p class=\"markdown-para\">Here is the migration that creates the <code>customers</code> table. Notice there is no <code>:age</code> column because the requirements are that it should not be persisted. I've added not null constraints on all the fields, and a unique constraint on the <code>:email</code> field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateCustomers</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:customers</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">index:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">unique:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the corresponding <code>Customer</code> model. I've added some validations for the email, first, and last name fields. I'm also using the <a href=\"https://github.com/ctran/annotate_models\" class=\"markdown-link\">annotate</a> gem to get schema information outputted as comments at the top of the model class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: customers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  email      :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  first_name :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  last_name  :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Indexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  index_customers_on_email  (email) UNIQUE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Customer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"first-attempt\" style=\"position:relative;\"><a href=\"#first-attempt\" aria-label=\"first attempt permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First Attempt</h2>\n<p class=\"markdown-para\">Suppose in this hypothetical app, that the customer's age must be greater than 18. If you were to attempt to implement the age requirement in the standard Rails way as per the getting started guide and common tutorials, you might add the validation rule to the <code>Customer</code> model such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Customer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># validation rules based on fields in the `customers` table</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># this won&#39;t work as we&#39;ll see because `age` is not a column on the `customers` table</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">18</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Add the <code>age</code> field to the customer creation form in the view:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form_with(model: customer) do |form| %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other customer fields --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- try to bind the `age` field even though it does not exist on customer model --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :age, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.number_field :age %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.submit %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% end %&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Update the <code>CustomersController</code> to permit <code>:age</code> as a parameter for creation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomersController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># standard CRUD methods...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># POST /customers or /customers.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(customer_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |format|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @customer.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { redirect_to </span><span class=\"mtk5\">customer_url</span><span class=\"mtk1\">(@customer), </span><span class=\"mtk4\">notice:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Customer was successfully created.&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">json</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:show</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:created</span><span class=\"mtk1\">, </span><span class=\"mtk4\">location:</span><span class=\"mtk1\"> @customer }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:new</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">json</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">json:</span><span class=\"mtk1\"> @customer, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">customer_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># try to let `age` field through from the UI form</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.</span><span class=\"mtk5\">require</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer</span><span class=\"mtk1\">).</span><span class=\"mtk5\">permit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">When attempting to save a new customer, the following error will result, indicating that the record could not be saved due to unknown attribute <code>age</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ActiveModel::UnknownAttributeError (unknown attribute &#39;age&#39; for Customer.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  raise UnknownAttributeError.new(self, k.to_s)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">^^^^^):</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"solution\" style=\"position:relative;\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h2>\n<p class=\"markdown-para\">This type of problem can be solved with <a href=\"https://guides.rubyonrails.org/active_model_basics.html\" class=\"markdown-link\">ActiveModel</a>. This is a module in Rails that provides a way to create model-like objects that have many of the same features as traditional Rails models, but are not necessarily backed by a database table. This is useful when modeling data that is not directly related to the application's database, which is exactly what we need to solve this example.</p>\n<p class=\"markdown-para\">The steps in this section will explain what needs to be changed from the scaffolded code to implement the requirement of having a field in the create form that is used for validation, but not persisted. You can also check out this <a href=\"https://github.com/danielabar/not_all_activerecord\" class=\"markdown-link\">project</a> that demonstrates the complete solution.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"customerform\" style=\"position:relative;\"><a href=\"#customerform\" aria-label=\"customerform permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CustomerForm</h3>\n<p class=\"markdown-para\">Start by introducing a <code>CustomerForm</code> model. This will be used instead of the <code>Customer</code> model to bind to the form that admin users fill out to create a customer. This class lives in the same <code>models</code> directory as all the other Rails models, but rather than inheriting from <code>ApplicationRecord</code> as the other models that are backed by a database table, it includes the <code>ActiveModel::Model</code> module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/customer_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Next, define attributes for all the fields that are needed for the customer form. Unlike with an ActiveRecord model, Rails doesn't create these automatically because there is no backing database table. Notice the attributes don't necessarily have to match columns in the <code>customers</code> table because this model is not attached to any table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/customer_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Including <code>ActiveModel::Model</code>, provides access to the validation methods that are available with ActiveRecord. Let's specify that all the fields are required, email must be a valid (according to the format defined in the RFC 6068 standard for the \"mailto\" URI scheme), and that age must be numeric and greater than 18:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/customer_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">18</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This is a good place to pause, launch a Rails console (<code>bin/rails c</code>), and play around with this model to see some of the behaviour that's now available to the <code>CustomerForm</code> model, as a result of including <code>ActiveModel::Model</code>. Note that <code>CustomerForm</code> can be initialized with a hash of attributes, just like an Active Record object, and the same validation methods are available as with Active Record:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; #&lt;CustomerForm:0x0000000112e41408&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Email can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Email is invalid&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;First name can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Last name can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Age can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Age is not a number&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;sarah@example.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">first_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Sarah&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">last_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Smith&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">age:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">46</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; #&lt;CustomerForm:0x000000011496b878 @age=46, @email=&quot;sarah@example.com&quot;, @first_name=&quot;Sarah&quot;, @last_name=&quot;Smith&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">age</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [&quot;Age must be greater than 18&quot;]</span></span></span></code></pre>\n<p class=\"markdown-para\">Nice, so we can have (nearly) all the validations that are on the <code>Customer</code> model, plus some additional ones that aren't backed by a table column. The <code>uniqueness: true</code> validation isn't available on ActiveModel because that requires access to a database table to verify a unique value among all the existing records. Since email should be unique across all customers, this can be implemented  with a custom <code>validate</code> method. The API is the same as adding custom validation methods to an ActiveRecord object:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">18</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:email_available?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">email_available?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors.</span><span class=\"mtk5\">add</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;already taken&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's try this version of <code>CustomerForm</code> in a Rails console to see how the custom uniqueness validation works:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># First save a customer to the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;alice@example.com&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">first_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Alice&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">last_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Jones&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ... TRANSACTION (1.7ms)  commit transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a CustomerForm object with an email that has already been taken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;alice@example.com&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">first_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Alice&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">last_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Parker&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">age:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">41</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Checking if its valid queries the customer table by email</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Customer Load (0.2ms)  SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE &quot;customers&quot;.&quot;email&quot; = ? LIMIT ?  [[&quot;email&quot;, &quot;alice@example.com&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Error message indicates email is already taken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [&quot;Email already taken&quot;]</span></span></span></code></pre>\n<p class=\"markdown-para\">The last thing we'll need on the <code>CustomerForm</code> model is the ability to save a customer to the database. The <code>save</code> method should return false if the model is invalid, otherwise create and save an instance of the <code>Customer</code> model. Let's also make the saved <code>Customer</code> model an instance variable so that it can be accessed by the controller to populate the <code>show</code> view.</p>\n<p class=\"markdown-para\">The final <code>CustomerForm</code> class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/customer_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_reader</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:customer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">18</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:email_available?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">email_available?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors.</span><span class=\"mtk5\">add</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;already taken&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\"> </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer.</span><span class=\"mtk5\">email</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> email</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer.</span><span class=\"mtk5\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> first_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer.</span><span class=\"mtk5\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> last_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"customerscontroller-new\" style=\"position:relative;\"><a href=\"#customerscontroller-new\" aria-label=\"customerscontroller new permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CustomersController New</h3>\n<p class=\"markdown-para\">Now that we have the <code>CustomerForm</code> class that implements all the required validations and the ability to save a <code>Customer</code> record, it needs to be integrated into the customer creation workflow. The first step is to modify the <code>CustomersController#new</code> method to make a <code>CustomerForm</code> instance variable available to the new view instead of a <code>Customer</code> instance variable:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomersController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># GET /customers/new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># This line is the standard Rails way to make the Active Record model instance available to the view:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># @customer = Customer.new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Instead, let&#39;s make our ActiveModel model available:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"new-view-and-form\" style=\"position:relative;\"><a href=\"#new-view-and-form\" aria-label=\"new view and form permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>New View and Form</h3>\n<p class=\"markdown-para\">The next step is to modify the <code>new</code> view to use the <code>CustomerForm</code> object instead of a <code>Customer</code> object, and pass it to a new form partial that will render the customer creation form. Note that the scaffold command used earlier generated a <code>_form.html.erb</code> partial to be used for both creating and editing customer instances. We're changing this to introduce a <code>_form_new.html.erb</code> partial since the customer creation requirements are different from editing:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">&lt;!-- app/views/customers/new.html.erb --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;New customer&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= render &quot;form_new&quot;, customer_form: @customer_form %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">br</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= link_to &quot;Back to customers&quot;, customers_path %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the form that binds the form fields to the <code>@customer_form</code> instance variable passed to it by the <code>new</code> view. Notice the <code>url: customers_path</code> is specified for the <code>form_with</code> helper, otherwise the view will attempt to render a url <code>customer_forms_path</code> by convention of the model name, but this does not exist. Note also we pass the label \"Create Customer\" to the <code>form.submit</code> helper, otherwise by convention of the model name, it would render a label \"Create Customer form\".</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">&lt;!-- app/views/customers/_form_new.html.erb --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form_with(model: customer_form, url: customers_path) do |form| %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% if customer_form.errors.any? %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">style</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;color: red&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= pluralize(customer_form.errors.count, &quot;error&quot;) %&gt; prohibited this customer from being saved:&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">ul</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% customer_form.errors.each do |error| %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">li</span><span class=\"mtk1\">&gt;</span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= error.full_message %&gt;&lt;/</span><span class=\"mtk7\">li</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% end %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">ul</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% end %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :email, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.text_field :email %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :first_name, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.text_field :first_name %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :last_name, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.text_field :last_name %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :age, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.number_field :age %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.submit &quot;Create Customer&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% end %&gt;</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"customerscontroller-create\" style=\"position:relative;\"><a href=\"#customerscontroller-create\" aria-label=\"customerscontroller create permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CustomersController Create</h3>\n<p class=\"markdown-para\">When the \"Create Customer\" button is clicked from the new form, it will submit a POST request to the <code>CustomersController#create</code> method. This method must be modified to use the <code>CustomerForm</code> model instead of <code>Customer</code>. We also need to define a <code>customer_form_params</code> method to specify the allowed fields for customer creation.</p>\n<p class=\"markdown-para\">If the customer is saved successfully, the <code>create</code> method should redirect to the show view, providing the <code>customer</code> instance variable of the <code>customer_form</code> object. Otherwise, render the <code>new</code> view with a 422 Unprocessable Entity HTTP response code. Since the <code>@customer_form</code> instance variable has been set, the <code>new</code> view will be able to iterate over its <code>errors</code> property and display them:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/customers_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomersController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># POST /customers or /customers.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Initialize the ActiveModel with form parameters from the view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(customer_form_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |format|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># `save` is a custom method defined in `CustomerForm` that first calls `valid?`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @customer_form.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># If `save` returns true, redirect to `show` view passing in the saved customer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { redirect_to </span><span class=\"mtk5\">customer_url</span><span class=\"mtk1\">(@customer_form.</span><span class=\"mtk5\">customer</span><span class=\"mtk1\">), </span><span class=\"mtk4\">notice:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Customer successfully created.&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">json</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:show</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:created</span><span class=\"mtk1\">, </span><span class=\"mtk4\">location:</span><span class=\"mtk1\"> @customer }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># If `save` returns false, render the `new` view to display the errors in `customer_form`:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:new</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">json</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">json:</span><span class=\"mtk1\"> @customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Specify allowed fields for the CustomerForm model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">customer_form_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.</span><span class=\"mtk5\">require</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer_form</span><span class=\"mtk1\">).</span><span class=\"mtk5\">permit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"try-it\" style=\"position:relative;\"><a href=\"#try-it\" aria-label=\"try it permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Try It</h3>\n<p class=\"markdown-para\">Putting all of these code changes together, we can now navigate to the new customer create form at <code>http://localhost:3000/customers/new</code>, and fill it in with an age that is invalid:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 300px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 136.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAADjElEQVR42p1VXW8TRxTNMw995YmXqgIJtUKtiiqh9g2pb61Eq1IqQRGiVQtCfUagwkt/QH9BValVwUogfKhSXGfjRAnBiaFKUBLbJCaOs/5Y7653s+udnd1ZH3QnJPZCbAxXOpqPnb1zz5x7Z4bwkrXb7bfCzr9DW1tbSCbHkM1mkUwm4bru7seubXr044GQDXHOUa3WoRsmypsqoog+AiJqI2oDUdSW4zAUECKSczwI4fsBOA/g+xxBEHYipI+2vYVKpQrDMJHPF7CxUUatVpetqlZQKm3ANE3U65rse4xJ57QJoeWxjsNQRMjl8lAUBfPz8xgbG8PMzDSmp6cxOzuLubk5TE6msbKygoWFBTx6lIXjODG6jPkdyts7RZKWpPtiEfVpM6JEUTDG4fNArqU5ckJzHvPluEOZcxSLRei6Adu20Ww2oRsGDMNAGIYvnL9e4V2HjDFkMnOYmEhjcfEJFGUC4+OKbA3TlM54EMiD74VY2siJl1KAlKQ1QRj2dUSgzYh+TGVSkEQhESoVdY887G8xUSiXLMtGqVSSKdK0LERRJKMjwQaB53VFKA/2lazfbil5SUnm9wHjEELEVV5eXsLU1BTW19dlLlKuZTIZBEEwMO1Y6RWeriKXL0DTdCwv51AorCKffwrXbckoPJlze4PoxkovCATogrAs65UKGPT2iZ0hVQOVVTqdxszMA/j+tmIkzKBXV9xhKGTekZHznXIaBDuUWXfp0cHregMt10EUCbytxUQZvXsff99IoKbpYFzA9Xy4jPdEi1qPy7VctBF2p41hOVjb1FGumVAbNlTNgqrZfbGpWajqDvJFFQ8fL6FUMToOtaaLZ6UyLLPxxjSVVBKXLv6MusWkiJJyTbewtLqJclVHw2qhbjrQTLcnGk2CA8vl+P9JDiN3/kVR7YpQiBCMc/j0TlDLt0vK8/nueAekrGm3oFsEF7bL4TABp9X1BNRND9//Nolvryk4cSUlcfJXBaeuT8j+11dT+OpqCl9e/g+//D4rheir8uKagX3H/8CRsyP49MI9fHbxHt4/M4zDp4dx9IdRfPLjHRz76S4+ODOC/V/8harekj+KqMe7vLLexDuf/4l3v7khHXx8fhTvnbyJQ98l8NG52zhy9hY+PHcLB08lcODEP9CabPdZ2MuGPD/E/QclDKeLuDm+JkH9kfQzJJQ1JJSiBM2nsiqCMOp7AT8HPLrtF6W+gJ4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar invalid form\"\n        title=\"not all ar invalid form\"\n        src=\"/static/321c7f2c05c8c5bcc44f7495aa83307a/5a46d/not-all-ar-invalid-form.png\"\n        srcset=\"/static/321c7f2c05c8c5bcc44f7495aa83307a/772e8/not-all-ar-invalid-form.png 200w,\n/static/321c7f2c05c8c5bcc44f7495aa83307a/5a46d/not-all-ar-invalid-form.png 300w\"\n        sizes=\"(max-width: 300px) 100vw, 300px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Here is the rendered HTML form, notice the <code>name</code> attributes of the input fields are like <code>customer_form[field]</code> rather than <code>customer[field]</code>. This is because we're binding to the <code>CustomerForm</code> ActiveModel rather than the  <code>Customer</code> Active Record model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">form</span><span class=\"mtk1\"> </span><span class=\"mtk5\">action</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;/customers&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">method</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;post&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;hidden&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;authenticity_token&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">value</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;Lda1K...&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_email&quot;</span><span class=\"mtk1\">&gt;Email&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form[email]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_email&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_first_name&quot;</span><span class=\"mtk1\">&gt;First name&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form[first_name]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_first_name&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_last_name&quot;</span><span class=\"mtk1\">&gt;Last name&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form[last_name]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_last_name&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_age&quot;</span><span class=\"mtk1\">&gt;Age&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;number&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form[age]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_age&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;submit&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;commit&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">value</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;Create Customer&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">form</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">After clicking the \"Create Customer\" button, the request and response is logged to the Rails server output. Notice the <code>customer_form</code> parameter rather than <code>customer</code> due to the use of the <code>CustomerForm</code> ActiveModel.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Started POST &quot;/customers&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Processing by CustomersController#create as TURBO_STREAM</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Parameters: {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;authenticity_token&quot;=&gt;&quot;[FILTERED]&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;customer_form&quot;=&gt;{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;email&quot;=&gt;&quot;jane@example.com&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;first_name&quot;=&gt;&quot;Jane&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;last_name&quot;=&gt;&quot;Doe&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;age&quot;=&gt;&quot;3&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;commit&quot;=&gt;&quot;Create Customer&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Customer Load (0.5ms)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE &quot;customers&quot;.&quot;email&quot; = ? LIMIT ?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [[&quot;email&quot;, &quot;jane@example.com&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/models/customer_form.rb:15:in `email_available?&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Rendering customers/new.html.erb within layouts/application</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Rendered customers/_form_new.html.erb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Completed 422 Unprocessable Entity</span></span></code></pre>\n<p class=\"markdown-para\">Since there is an error with the <code>age</code> attribute in the <code>customer_form</code> instance variable set by the <code>CustomersController</code>, it will be displayed in the new form:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 677px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABsElEQVR42p2Ty27TQBSG/VCs2CPxICzYoi7YsIQ3QGLRFX2CigXwCJRGcZO2cS5EvsWpgmpTmjoXz8z5qhmnFqAiJbH068yM5nzznzNjj/EYpzCEfgDdDlxcQK8HgwFMJjAa1eMoguGw3m/X7NjGOIJ+H4oCT3o9xE6CAAkC8H04O4PLy3rTjxG02+C34fy8BtsDu11oteD0FDodODmB62s8tHYuZDpFsgkymyFxjFxdIVkGeY6w/efd3dwg8zmsVrBaQllCeQfLJSwWiF03ZjuJ4AX9AfNywapSrKrKxUoblBHM5lTnUP7j8591L8syxuMxURQRhiFpmlKWJcYISqlNjjya/GjJSTohThLyvEBpzbqqqKzLSjUgke276MVxTFH8Yr1eO1fGGCettdPOwDSd8Pv2FqW0c2ijbqLZHZgkCWEUkRdF0zcHV9rN9wCmrm82yTqysiU/QHcGzmY/NzDdAB+016VM7R8i/NVDGyul9rsUoxVijJNxr70u1z6bvYBPXhzz/OALz1595unLTxy8/9ZALGcXmAO+/vCdd0c+bz/6vDlscfR1+Adw9x7eA/nY10ouK1b2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar form error\"\n        title=\"not all ar form error\"\n        src=\"/static/afc538f24f2e194dc20f42e212cd036f/68de2/not-all-ar-form-error.png\"\n        srcset=\"/static/afc538f24f2e194dc20f42e212cd036f/772e8/not-all-ar-form-error.png 200w,\n/static/afc538f24f2e194dc20f42e212cd036f/e17e5/not-all-ar-form-error.png 400w,\n/static/afc538f24f2e194dc20f42e212cd036f/68de2/not-all-ar-form-error.png 677w\"\n        sizes=\"(max-width: 677px) 100vw, 677px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Let's correct the error by setting an age greater than 18 and submitting the form again:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 292px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 137%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAADA0lEQVR42p1VS08TURRm48L4M3SlwY2auDEx0f+gC4GgJi70X/ggEg1LV4YVCgaCBhZUqyl9GBIepcMjFmzLtEA7bWlDH/Oe+cw5baedWqB0ki/3ns703HO+851z+wqFAkRRRD6fRyqVgmEY6OWxbZvXvsPDQywvr8Dj+Y4f3p+oVKrQdAOqqkHTdIZah9aytsI0LcdpH/3ZfVJzb9lNm1bLsnk1DBO6bjioVpWmQ9OyIQgCfD4fgsEgFhYWEAgEEAqFsLS0hFAoyO+i0T9YD4fh9/tRLBZcQSiK1kxZ0wwkkykkk0mIYhKxWIztRCKBdDqNPVFkW5KyyGQkEEWKorIDy7IY7ghNi1Pp9FD0hmnBNO1amobJtqrqkBWVI6OVeHQcZjIZrK2tIRwOc1RbW5uc2urqKhRFPn+VS6UyRDGFiLCB/f0DrEcECMImwusRHB+XuKqNaDrhvwiJw1raFkul/dTGu5NgEodyC4eGYSEajcLr9WJ+fg5EAUvGsrpOt1EkTpkILpUqqFRlrla1KkOW1RqU00GO6LtyRW6tstlR1A2bPuoGjsNcLscVJUGTwAOBIDweDwtYlpsnn+XMcUi9m05LyB8VUK7v0xkJ2WyOaWhU8kTU6XEJm9Qfj8chSVJPk0ZuLQqpf3f3L/fr8spKrUPOkEo72mTjLkpTxGoX0Jy0HYdEvCjuIZvN9jxcXa1Hk5oqTAO2XC7zC4qa5NQtGk3AERKHJGhZVkBtyOmq54CiodI+vnZ2dnig9vq4Biydkj8qYv8gDUXVzwSNfOJab0A33BEC9rmiIWfU/60XmF6/l9ihEDvC4xE/ht8sYvCVjzFM9ogfQ68XHQy89OHF2G/kj9XTqzzpjeHC3Y+48WQW1wamcfPpLC4/mEL/0Azb/YMzvL/6aBoX741jM15wroeOw+HLr5rD60MzuP3sG+48n8OVh1OOfevpVz6EDrx0fxzbiWJ9Xnamqk/MlDE2tYH3kwJGJyJ4OxHh/bvPAkY/RRzQ7x9mt1Gq6q4U2x3+A4dl8PMyvEyAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar valid form\"\n        title=\"not all ar valid form\"\n        src=\"/static/175984a91f40f8370b5dfd1bf8811cec/2e9f9/not-all-ar-valid-form.png\"\n        srcset=\"/static/175984a91f40f8370b5dfd1bf8811cec/772e8/not-all-ar-valid-form.png 200w,\n/static/175984a91f40f8370b5dfd1bf8811cec/2e9f9/not-all-ar-valid-form.png 292w\"\n        sizes=\"(max-width: 292px) 100vw, 292px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">This time, the Rails server output shows a new <code>customers</code> record being inserted into the database, then redirecting to the customers show view at <code>http://localhost/customers/{id}</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Started POST &quot;/customers&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Processing by CustomersController#create as TURBO_STREAM</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Parameters: {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;authenticity_token&quot;=&gt;&quot;[FILTERED]&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;customer_form&quot;=&gt;{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;email&quot;=&gt;&quot;jane@example.com&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;first_name&quot;=&gt;&quot;Jane&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;last_name&quot;=&gt;&quot;Doe&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;age&quot;=&gt;&quot;19&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;commit&quot;=&gt;&quot;Create Customer&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Customer Load (9.8ms)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE &quot;customers&quot;.&quot;email&quot; = ? LIMIT ?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [[&quot;email&quot;, &quot;jane@example.com&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/models/customer_form.rb:15:in `email_available?&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.1ms)  begin transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Customer Create (3.3ms)  INSERT INTO &quot;customers&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (&quot;email&quot;, &quot;first_name&quot;, &quot;last_name&quot;, &quot;created_at&quot;, &quot;updated_at&quot;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    VALUES (?, ?, ?, ?, ?)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [[&quot;email&quot;, &quot;jane@example.com&quot;], [&quot;first_name&quot;, &quot;Jane&quot;], [&quot;last_name&quot;, &quot;Doe&quot;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [&quot;created_at&quot;, &quot;2023-03-24 11:22:45&quot;], [&quot;updated_at&quot;, &quot;2023-03-24 11:22:45&quot;]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/models/customer_form.rb:25:in `save&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (1.7ms)  commit transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  â†³ app/models/customer_form.rb:25:in `save&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Redirected to http://localhost:3000/customers/12</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Completed 302 Found</span></span></code></pre>\n<p class=\"markdown-para\">And here is the customer show view with the flash message that it was successfully created (this portion is directly from the scaffolded code):</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 391px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACdElEQVR42p1UW08TURDuiw/+DN+Mxgd8UDEmavgPvqgxkihqjPH/KBLfTEQUWqCl3nB759ILuu0C3bq7Zam73aVLW9pt2X7mTAutLWhkki8z5zs73zkzc7KuWrOGYrWIndoOjD0T5p6J3fou+bJdppihVCtBr+rYLm8Tb9UtymOo2BUwa7VacLHNVXUVnBRAWAkjIAeR1tP4JnFIFpKI5qNY2lrG15+LCClh8rzGY1ldwUfxEz7nvkA0xa5gO+qg347ijjEmxsyFE5rTckjkAIc31HUdoVCIEI/HIYoieJ6nOJ1OI5PJkGdQFAWCIKBS6fZsQLBarZIIS2QJsixDkiTiWMyQy+Vor1AoIJ/Po16v/1Fmr7mOIv+nZwOCmqbB6/ViYWEBkUgEHo8HPp+PbsbWiUQCjUaDBBzHGShxQPCwyY5D2N/fJxzEzWbzrwIDgrZtwzRNaJoOwzCoT2xQlmUR39+v3kH0gwRZIscFEAwGEYvF4Pf7wXEcsqJIk1ZVtVtBT7LTQbsVXf7E7/DYkktlG4HUNhIbRawKOrJbFjLSDlYEHWtZg3jdKCGYUhHjNXwXTWzmLfKhtQKSmwbCP35hXSm1b2hVbMxFZPiX8vDFFPLzEYXgjSpwByUkhAJ8URlRXoMgl+jAVNZAfKNIwiudi5AgW1wcfY+R53O49sSNyw+ncfPZLC49+IDhRzO4/tSDq4/dOHdnkg77Z8mLcRWnboxjeGwaQ/encPb2W1y49w5nbr3B+buTGBqdwpWxaZwemcDr+XVKajTbA2LDcPqHYlh1+vDFTAYv3RlMzAnkX80KGPe0OVp7BChapfNjOP49/gYGRek/Ib60ogAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar success\"\n        title=\"not all ar success\"\n        src=\"/static/8b5758d0ba2b86acac7cbdf8a93647e0/14e0c/not-all-ar-success.png\"\n        srcset=\"/static/8b5758d0ba2b86acac7cbdf8a93647e0/772e8/not-all-ar-success.png 200w,\n/static/8b5758d0ba2b86acac7cbdf8a93647e0/14e0c/not-all-ar-success.png 391w\"\n        sizes=\"(max-width: 391px) 100vw, 391px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 class=\"markdown-sub-subtitle\" id=\"tests\" style=\"position:relative;\"><a href=\"#tests\" aria-label=\"tests permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tests</h3>\n<p class=\"markdown-para\">Before we can conclude that we're done, the <code>CustomerForm</code> model should have automated tests. I'm using <a href=\"https://rspec.info/\" class=\"markdown-link\">RSpec</a> on this project. A really nice feature of including the ActiveModel module is the validation rules can be tested with <a href=\"http://matchers.shoulda.io/\" class=\"markdown-link\">shoulda matchers</a>, just like an Active Record model. Here are the tests for the validation rules, and the <code>save</code> method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">RSpec</span><span class=\"mtk1\">.</span><span class=\"mtk5\">describe</span><span class=\"mtk1\"> CustomerForm, </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:model</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">subject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer_form</span><span class=\"mtk1\">) { described_class.</span><span class=\"mtk7\">new</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;validations&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_presence_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">allow_value</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;email@example.com&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">for</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should_not </span><span class=\"mtk5\">allow_value</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">for</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_presence_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_presence_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_presence_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:age</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_numericality_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:age</span><span class=\"mtk1\">).</span><span class=\"mtk5\">only_integer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">is_greater_than</span><span class=\"mtk1\">(</span><span class=\"mtk4\">18</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    context </span><span class=\"mtk6\">&quot;when email is already taken&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">let!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer</span><span class=\"mtk1\">) { </span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer</span><span class=\"mtk1\">, </span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email@example.com&quot;</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      before { customer_form.</span><span class=\"mtk5\">email</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email@example.com&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it { should_not be_valid }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;has an error on email&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">]).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk7\">include</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;already taken&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#save&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    context </span><span class=\"mtk6\">&quot;when form is valid&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      before </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">email</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;this_is_good@test.com&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Fred&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Flinstone&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">age</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">44</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;creates a new customer&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        expect { subject.</span><span class=\"mtk5\">save</span><span class=\"mtk1\"> }.</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span><span class=\"mtk1\">(Customer, </span><span class=\"mtk4\">:count</span><span class=\"mtk1\">).</span><span class=\"mtk5\">by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;returns true&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(subject.</span><span class=\"mtk5\">save</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> be_truthy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;sets the customer attribute&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(subject.</span><span class=\"mtk5\">customer</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">be_a</span><span class=\"mtk1\">(Customer)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    context </span><span class=\"mtk6\">&quot;when form is invalid&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      before </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">allow</span><span class=\"mtk1\">(subject).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">receive</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:valid?</span><span class=\"mtk1\">).</span><span class=\"mtk5\">and_return</span><span class=\"mtk1\">(</span><span class=\"mtk4\">false</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;does not create a new customer&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        expect { subject.</span><span class=\"mtk5\">save</span><span class=\"mtk1\"> }.</span><span class=\"mtk5\">not_to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span><span class=\"mtk1\">(Customer, </span><span class=\"mtk4\">:count</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;returns false&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(subject.</span><span class=\"mtk5\">save</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> be_falsey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;does not set the customer attribute&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(subject.</span><span class=\"mtk5\">customer</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> be_nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIf you're setting up a new Rails project, it defaults to minitest rather than RSpec for automated testing. See this post I wrote on <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/start-rails-6-project-with-rspec/\">Starting a Rails Project with RSpec</a> for how to switch from minitest to RSpec.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has demonstrated how to use Active Model in a Rails application when the form presented to the user does not exactly match what should be persisted in the database. We just scratched the surface of what's available from the ActiveModel module with regards to validation. Be sure to check out the <a href=\"https://guides.rubyonrails.org/active_model_basics.html\" class=\"markdown-link\">Active Model Basics Rails Guides</a> to learn about all the available features.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/they-dont-all-have-to-be-activerecord-models/"}}},{"node":{"id":"c7b23da1-58aa-5f7e-8d61-8c308e6ef0ac","frontmatter":{"title":"Setup a Rails Project with Postgres and Docker","date":"August 2023","category":"rails"},"excerpt":"Update (September 2023): Rails projects using fixtures will need one additional permission for the Postgres role. See initialization sectionâ€¦","html":"<p class=\"markdown-para\"><strong class=\"markdown-strong\">Update (September 2023):</strong> Rails projects using fixtures will need one additional permission for the Postgres role. See <a href=\"../rails-postgres-docker#initialization\" class=\"markdown-link\">initialization</a> section for more details.</p>\n<p class=\"markdown-para\">When scaffolding a new Rails project, the database flag can be used to specify a database other than the default SQLite, such as Postgres. However, the generated configuration will assume that the database is running on localhost, i.e. installed directly on your laptop or development machine. If instead you'd like the database running in a Docker container, a few more steps are necessary. This post will walk you through how to setup a new Rails project with a Postgres database running in a Docker container rather than the default SQLite running on localhost. It will be demonstrated using the <a href=\"https://guides.rubyonrails.org/getting_started.html\" class=\"markdown-link\">Rails Getting Started Guide</a> which builds an example blog application. All the code explained in this post can be found in this <a href=\"https://github.com/danielabar/blogpg\" class=\"markdown-link\">blogpg project</a> on Github.</p>\n<aside class=\"markdown-aside\">\nThis post assumes some familiarity with Docker and Docker Compose. If you're new to these, checkout this <a class=\"markdown-link\" href=\"https://www.pluralsight.com/paths/docker-fundamentals-for-developers\">learning path</a> from Pluralsight (paid service). There's also a number of <a class=\"markdown-link\" href=\"https://docs.docker.com/get-started/resources/\">educational resources</a> listed on the Docker website.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"why\" style=\"position:relative;\"><a href=\"#why\" aria-label=\"why permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why?</h2>\n<p class=\"markdown-para\">But first, why would you want to use Docker to run your development database rather than simply installing it on your machine? There are a few benefits including:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Version consistency:</strong> Ideally, everyone on the team is running the same version locally as what's used in production. Suppose the production version gets upgraded, then every developer needs to remember to also upgrade their local installation. When the service is dockerized and run with Docker Compose, an upgrade just involves updating the image tag in the <code>docker-compose.yml</code> file and pushing to version control. Next time everyone pulls that change and runs <code>docker-compose up</code>, they'll automatically get the upgraded version. Version consistency also eliminates a source of <a href=\"https://dzone.com/articles/works-on-my-machine\" class=\"markdown-link\">works on my machine</a> problems.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Configuration consistency:</strong> If your project requires some custom database configuration, it can be committed into the project and set in the container with a host mount. This leads to faster local setup as compared to adding an instruction in the <code>README.md</code> telling each developer to configure their database manually.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Multiple versions and services:</strong>: For a developer that works on multiple projects, they could be using different database versions and it would be tedious to have to constantly uninstall/re-install versions every time you switch projects. Also as you work on multiple projects, each may have different service requirements such as Postgres, MySQL, Elasticsearch, Redis, etc. I'd rather not have all of those always running on my laptop when not needed, or have to remember to start/stop them for each project. Using Docker, with Docker Compose simplifies this.</p>\n<aside class=\"markdown-aside\">\nAll the benefits discussed above are for development, not production. The issue of whether a production database should be run in a container or not is outside the scope of this post. See some discussion <a class=\"markdown-link\" href=\"https://stackoverflow.com/questions/48515460/is-it-recommended-to-use-database-as-a-container-in-production-environment\">here</a> and follow the links to referenced blog posts if you want to learn more about this.\n</aside>\n<p class=\"markdown-para\">Now that we've covered some benefits of using Docker locally for services, let's see how to setup Postgres in a container for a new Rails project.</p>\n<h2 class=\"markdown-subtitle\" id=\"getting-started\" style=\"position:relative;\"><a href=\"#getting-started\" aria-label=\"getting started permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Getting Started</h2>\n<p class=\"markdown-para\">Install Postgres locally. Even though the Postgres database server will be run inside a Docker container, we still need the client installed on our laptop to connect to it. For a Mac, the easiest way is to use Homebrew. Note that you need to select your version. It's not necessary to start the service, so ignore the instruction at the end of the installation about starting Postgres.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">brew install postgresql@14</span></span></code></pre>\n<p class=\"markdown-para\">Scaffold a new Rails app, but specify that you want the database to be Postgres. Otherwise, the default option will use a SQLite database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">rails new blogpg --database=postgresql</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"docker-compose\" style=\"position:relative;\"><a href=\"#docker-compose\" aria-label=\"docker compose permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Compose</h2>\n<p class=\"markdown-para\">We'll use <a href=\"https://docs.docker.com/compose/\" class=\"markdown-link\">Docker Compose</a> to manage starting and stopping containers. Typically Docker Compose is used to manage multiple services, but there's still benefits to using it even if you only have one service as in this case. It's more convenient to start a container with a simple command <code>docker-compose up</code> than to use the equivalent <code>docker run...</code> because the compose file handles passing in all arguments such as volumes, port mapping and environment variables. Also as the project grows, more services such as Redis, Sidekiq, etc may be added that will each require their own container. Using Docker Compose means they can all be started with a single command.</p>\n<p class=\"markdown-para\">Add the following <code>docker-compose.yml</code> file to the root of the project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.8&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:14</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Named volume to persist database data outside of container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Format is &quot;named_volume:path/in/container&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">db_pg_data:/var/lib/postgresql/data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Host mount for one-time initialization.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Format is &quot;./path/on/host:/path/in/container&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">./init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Map to something other than default 5432 on host in case Postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># is also running natively on host.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Format is &quot;host:container&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;5434:5432&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Sets the superuser password for PostgreSQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">shhhhItsASecret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db_pg_data</span><span class=\"mtk1\">:</span></span></span></code></pre>\n<p class=\"markdown-para\">A few things to note here:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">image:</strong> This specifies what image to use. By default, it will pull from the <a href=\"https://index.docker.io/search?q=\" class=\"markdown-link\">Docker Hub</a> public registry. The <code>postgres</code> image refers to the <a href=\"https://hub.docker.com/_/postgres\" class=\"markdown-link\">Official Postgres Image</a>. Notice that the version tag <code>14</code> is specified. If you don't specify a tag, <code>latest</code> will be pulled which may not be what you want. Optionally you can use the <code>14-alpine</code> tag for a more minimal image.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">ports:</strong> By default, Postgres listens on port 5432. When the database is running in a container rather than directly on the local machine, this port must be mapped to a port on the host, in order for the Rails application to be able to connect to it. Typically, you'll see the container port mapped to same port number on the host such as <code>\"5432:5432\"</code>. I prefer to choose a different port to map to on the host in case anyone on the team happens to be running Postgres locally on the default port, maybe from an earlier tutorial, or even just installing the client via homebrew, they may have chosen to start the service. The idea here is to avoid a port conflict where Docker is trying to use a port that's already in use by the host. Learn more about <a href=\"https://docs.docker.com/compose/compose-file/#ports\" class=\"markdown-link\">ports</a>.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">volumes:</strong> There are two entries in the services - volumes section. The first is a named volume <code>db_pg_data:/var/lib/postgresql/data</code>. This maps the directory inside the container where Postgres stores all the data to a Docker volume named <code>db_pg_data</code>, which is defined at the end of the file in the <code>volumes</code> section. This will save all data outside of the container (you can list your volumes with the <code>docker volume ls</code> command). This means even if the container is removed, your data is still available.</p>\n<p class=\"markdown-para\">The second is a host mount <code>./init.sql:/docker-entrypoint-initdb.d/init.sql</code>. It maps a file <code>./init.sql</code> from the project root (we'll create it in the next section) to a special directory in the container <code>docker-entrypoint-initdb.d</code>. This is a property of the official Postgres Docker image. Any sql files located in this directory can be used for one-time initialization. That is, when the container starts, it checks if the default <code>postgres</code> database already exists, if not, it runs all sql scripts found in the initdb directory. If a database does exist, then the files are ignored. Learn more about <a href=\"https://docs.docker.com/compose/compose-file/#volumes\" class=\"markdown-link\">volumes</a>.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">environment:</strong> This section is used to set environment variables that will be available within the container. <code>POSTGRES_PASSWORD</code> sets the superuser password for the <code>postgres</code> user. Remember this is only a development image so this password isn't being used to protect production data. Optionally, you can set the <code>POSTGRES_HOST_AUTH_METHOD</code> to <code>trust</code>, and then the <code>POSTGRES_PASSWORD</code> environment variable is not required. Learn more about setting <a href=\"https://docs.docker.com/compose/compose-file/#environment\" class=\"markdown-link\">environment variables</a> in Docker Compose.</p>\n<h2 class=\"markdown-subtitle\" id=\"initialization\" style=\"position:relative;\"><a href=\"#initialization\" aria-label=\"initialization permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Initialization</h2>\n<p class=\"markdown-para\">The <code>docker-compose.yml</code> file explained in the previous section specifies a host mount for <code>init.sql</code>. When the Postgres container is run for the first time, it will detect that there is no default <code>postgres</code> database created yet, when this is the case, it will run all sql scripts located in the <code>docker-entrypoint-initdb.d</code> directory. Otherwise, if a default database does exist, this directory is ignored. This makes it perfect for performing one-time initialization.</p>\n<p class=\"markdown-para\">We'll use this feature of the Postgres image to <a href=\"https://www.postgresql.org/docs/current/sql-createrole.html\" class=\"markdown-link\">create a role</a> having the same name as the Rails database, in this case <code>blogpg</code> for our sample blog application. Create a file <code>init.sql</code> in the root of the Rails project with the following content:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Only used for development where Postgres is run in Docker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">create</span><span class=\"mtk1\"> </span><span class=\"mtk7\">role</span><span class=\"mtk1\"> blogpg </span><span class=\"mtk7\">with</span><span class=\"mtk1\"> CREATEDB </span><span class=\"mtk7\">login</span><span class=\"mtk1\"> </span><span class=\"mtk7\">password</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;blogpg&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p class=\"markdown-para\">If your project uses <a href=\"https://guides.rubyonrails.org/testing.html#the-low-down-on-fixtures\" class=\"markdown-link\">fixtures</a> for loading sample data, you may encounter the following error when running <code>bin/rails db:seed</code> or when running tests, both of which attempt to load the fixtures via <code>db:fixtures:load</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">WARNING: Rails was not able to disable referential integrity.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">This is most likely caused due to missing permissions.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Rails needs superuser privileges to disable referential integrity.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">cause: PG::InsufficientPrivilege: ERROR:  permission denied: &quot;RI_ConstraintTrigger_c_24650&quot; is a system trigger</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Tasks: TOP =&gt; db:fixtures:load</span></span></code></pre>\n<p class=\"markdown-para\">This is because when loading fixtures, Rails first deletes all the existing data in the database, and the fastest way to do that is to first disable referential integrity (i.e. foreign keys and check constraints). However, Postgres requires that the user doing this must have a role with <code>SUPERUSER</code> privileges. The role created in the example above only has <code>CREATEDB</code> privilege which is insufficient. To resolve this, include <code>SUPERUSER</code> privilege when creating the role as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- Only used for development where Postgres is run in Docker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">create</span><span class=\"mtk1\"> </span><span class=\"mtk7\">role</span><span class=\"mtk1\"> blogpg </span><span class=\"mtk7\">with</span><span class=\"mtk1\"> CREATEDB SUPERUSER </span><span class=\"mtk7\">login</span><span class=\"mtk1\"> </span><span class=\"mtk7\">password</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;blogpg&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p class=\"markdown-para\">According to the Postgres docs on creating roles:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Superuser status is dangerous and should be used only when really needed.</p>\n</blockquote>\n<p class=\"markdown-para\">In this case, it is <em class=\"markdown-emphasis\">only</em> being used for development purposes. Your production role should not have this.</p>\n<aside class=\"markdown-aside\">\nRoles and users are similar concepts in Postgres, although there are some differences. A full discussion of this topic is outside the scope of this post, see this <a class=\"markdown-link\" href=\"https://dba.stackexchange.com/questions/82271/postgresql-roles-versus-users-grant-permissions\">question on DBA Stack Exchange</a> for more details.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"rails-database-config\" style=\"position:relative;\"><a href=\"#rails-database-config\" aria-label=\"rails database config permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rails Database Config</h2>\n<p class=\"markdown-para\">The next step is to modify <code>config/database.yml</code> in the Rails project so that it can connect to the database running in the Docker container for <code>development</code> and <code>test</code>. It also needs the flexibility to connect to a different database for <code>production</code>.</p>\n<p class=\"markdown-para\">Before making changes to this file, let's take a look at what gets generated from running the <code>rails new blogpg --database=postgresql</code> command:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/database.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">default</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&amp;</span><span class=\"mtk5 mtku\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">adapter</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgresql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">encoding</span><span class=\"mtk1\">: </span><span class=\"mtk6\">unicode</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">pool</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 } %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">development</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">test</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">production</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">username</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">password</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;BLOGPG_DATABASE_PASSWORD&#39;] %&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Notice that there's no <code>host</code> or <code>port</code> specified in the default database configuration. This is because it's assumed that the database is running on <code>localhost</code>, i.e. the same machine as the Rails app is running on, and listening on the default Postgres port of <code>5432</code>. In our case, the database is running on the same machine, but inside a Docker container therefore <code>localhost</code> will not resolve. Instead we'll need to specify a host of <code>127.0.0.1</code>. As for the port, recall we mapped the default Postgres port of <code>5432</code> in the container to <code>5434</code> on the host so we'll also need to tell Rails about this.</p>\n<p class=\"markdown-para\">We also need to make sure that different values can be specified in production. We'll make use of environment variables for this, together with the logical or operator <code>||</code> to use a default when the environment variable is not specified.</p>\n<p class=\"markdown-para\">Here is the modified config file to support connecting to Postgres in a Docker container for development and test, and flexibility to specify a different database host, password, etc with environment variables for production:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">default</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&amp;</span><span class=\"mtk5 mtku\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">adapter</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgresql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">encoding</span><span class=\"mtk1\">: </span><span class=\"mtk6\">unicode</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">pool</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 } %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_NAME&#39;] || &quot;blogpg&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">username</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_USER&#39;] || &quot;blogpg&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">password</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_PASSWORD&#39;] || &quot;blogpg&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">port</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_PORT&#39;] || &quot;5432&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">host</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DATABASE_HOST&#39;] || &quot;127.0.0.1&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">development</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">port</span><span class=\"mtk1\">: </span><span class=\"mtk4\">5434</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">test</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">port</span><span class=\"mtk1\">: </span><span class=\"mtk4\">5434</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">production</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">&lt;&lt;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">*</span><span class=\"mtk1\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg_production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">username</span><span class=\"mtk1\">: </span><span class=\"mtk6\">blogpg</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">password</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;BLOGPG_DATABASE_PASSWORD&#39;] %&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Note that there's nothing Docker-specific in the <code>config/database.yml</code> file. All we've done is make it more flexible than what the Rails scaffold generated so that development and test can connect to databases other than that running on localhost and the default port.</p>\n<h2 class=\"markdown-subtitle\" id=\"start-container\" style=\"position:relative;\"><a href=\"#start-container\" aria-label=\"start container permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Start Container</h2>\n<p class=\"markdown-para\">Now it's time to try all this out and make sure everything's connected. Start the container(s) with docker compose:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose up</span></span></code></pre>\n<p class=\"markdown-para\">Since this is the first time this container is running, the default <code>postgres</code> database doesn't yet exist, so the console output should show that the <code>init.sql</code> script was run to create the <code>blogpg</code> role:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">database_1  | /usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/init.sql</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">database_1  | CREATE ROLE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">database_1  | 2022-09-06 10:33:56.184 UTC [1] LOG:  database system is ready to accept connections</span></span></code></pre>\n<p class=\"markdown-para\">Note that you can stop the database at any time with <code>docker-compose stop</code> and then use the <code>up</code> command to restart it. The <code>CREATE ROLE</code> from <code>init.sql</code> will not run again because the default <code>postgres</code> database already exists. Next time you start the database, the following message will be displayed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">PostgreSQL Database directory appears to contain a database; Skipping initialization</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"force-init\" style=\"position:relative;\"><a href=\"#force-init\" aria-label=\"force init permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Force Init</h3>\n<p class=\"markdown-para\">This section is optional. If you made a typo in <code>init.sql</code> or for whatever reason want to force it to run again, this can be accomplished by removing the named volume that contains the Postgres data (make sure there's nothing important saved there or back it up first!). Since a container exists that is using the volume, it must be stopped and removed first, here are the steps to force init to run again:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># stop the running Postgres container</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose stop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># remove the container (otherwise the volume cannot be removed)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose rm -f</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># list all volumes - should see blogpg_db_pg_data in the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker volume ls</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># remove the named volume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker volume rm blogpg_db_pg_data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># start database container again - should show its running CREATE ROLE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose up</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"create-database\" style=\"position:relative;\"><a href=\"#create-database\" aria-label=\"create database permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create Database</h2>\n<p class=\"markdown-para\">Next step is to create the Rails application database. Run the usual Rails command to do so:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails db:create</span></span></code></pre>\n<p class=\"markdown-para\">Use the <code>psql</code> command line tool (this got installed with homebrew earlier) to connect to Postgres running in the Docker container to verify the application database got created. Notice this command specifies <code>127.0.0.1</code> as the host and <code>5434</code> as the port because we need to connect to the Docker container rather than a database running directly on the laptop:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">psql -h 127.0.0.1 -p 5434 -U blogpg</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># enter password from init.sql</span></span></span></code></pre>\n<p class=\"markdown-para\">Use the <code>\\l</code> command to list all databases - you should see <code>blogpg</code> and <code>blogpg_test</code> in the listing, which were created from running the <code>bin/rails db:create</code> command:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">blogpg=&gt; \\l</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                  List of databases</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Name     |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-------------+----------+----------+------------+------------+-----------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> blogpg      | blogpg   | UTF8     | en_US.utf8 | en_US.utf8 |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> blogpg_test | blogpg   | UTF8     | en_US.utf8 | en_US.utf8 |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> postgres    | postgres | UTF8     | en_US.utf8 | en_US.utf8 |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> template0   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             |          |          |            |            | postgres=CTc/postgres</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> template1   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             |          |          |            |            | postgres=CTc/postgres</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(5 rows)</span></span></code></pre>\n<p class=\"markdown-para\">Keep this tab open, we'll come back to it to verify tables after creating and populating some models.</p>\n<h2 class=\"markdown-subtitle\" id=\"create-and-populate-table\" style=\"position:relative;\"><a href=\"#create-and-populate-table\" aria-label=\"create and populate table permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create and Populate Table</h2>\n<p class=\"markdown-para\">Now let's follow along with the Getting Started Rails Guide so we can get to the point of creating a table and populating it. Add the following to <code>config/routes.rb</code> to expose a route that will list all articles in the application:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">application</span><span class=\"mtk1\">.</span><span class=\"mtk5\">routes</span><span class=\"mtk1\">.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  root </span><span class=\"mtk6\">&quot;articles#index&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  get </span><span class=\"mtk6\">&quot;/articles&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">to:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;articles#index&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Use the Rails generator to scaffold an Articles controller and model, then run the migration (migration file got generated by the model generator) to create the <code>articles</code> table in the database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate controller Articles index --skip-routes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate model Article title:string body:text</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails db:migrate</span></span></code></pre>\n<p class=\"markdown-para\">Go back to the tab where <code>psql</code> is running and verify the <code>articles</code> table got created in the Postgres database running within Docker container. The <code>\\dt</code> command lists all tables in the database you're connected to:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">blogpg=&gt; \\dt</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">               List of relations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Schema |         Name         | Type  | Owner</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------+----------------------+-------+--------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> public | ar_internal_metadata | table | blogpg</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> public | articles             | table | blogpg</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> public | schema_migrations    | table | blogpg</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<p class=\"markdown-para\">We can see the <code>articles</code> table got created as well as the <code>schema_migrations</code> table Rails uses to keep track of migrations.</p>\n<p class=\"markdown-para\">Now launch a Rails console with <code>bin/rails console</code> and create a new article:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Article</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Hello Postgres Docker&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">body:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;I&#39;m being created in Postgres running in a Docker container&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">Go back to the tab where <code>psql</code> is running and verify the new article record has been created:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">blogpg=&gt; select * from articles;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> id |         title         |                            body                             |         created_at         |         updated_at</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----+-----------------------+-------------------------------------------------------------+----------------------------+----------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  1 | Hello Postgres Docker | I&#39;m being created in Postgres running in a Docker container | 2022-09-09 10:31:13.032458 | 2022-09-09 10:31:13.032458</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(1 row)</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"verify-full-stack\" style=\"position:relative;\"><a href=\"#verify-full-stack\" aria-label=\"verify full stack permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verify Full Stack</h2>\n<p class=\"markdown-para\">To tie this all together, let's update the Articles controller <code>index</code> method and the Articles index view to display the articles so we can verify the full stack is working with the Dockerized database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/articles_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ArticlesController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @articles </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Article</span><span class=\"mtk1\">.</span><span class=\"mtk5\">all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"erb\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">&lt;!-- app/views/articles/index.html.erb --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;Articles&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">table</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">tr</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">th</span><span class=\"mtk1\">&gt;Title&lt;/</span><span class=\"mtk7\">th</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">th</span><span class=\"mtk1\">&gt;Body&lt;/</span><span class=\"mtk7\">th</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">tr</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> @articles.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |article| </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">tr</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">td</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> article.</span><span class=\"mtk5\">title</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">td</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">td</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">&lt;%=</span><span class=\"mtk1\"> article.</span><span class=\"mtk5\">body</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">td</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">tr</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&lt;%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">end</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">table</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Start the server with <code>bin/rails s</code>, navigate to <code>http://localhost:3000</code> and you should see an unstyled HTML table listing the one article created earlier:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 615px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8klEQVR42q2QSUvEQBCF+xe54UHGGUVxGUVH8Y+Ox/yBnBNyySWQdPYNEgjZJOk3VDEnx4OgDz76VdXjHVqsn15wd7/G5u0Dy9UNLhZLXF3f4nXzjofHZywuVzg5PcfR8dmvEIZhwjAM2LYNKX14nmR839/PHlyXcL/h/YgwTROapuFzu4Wu6/irxDh+YRxHVFWFuq4PAkoBau+naULbtlBKHWRI8zxDdF3HhY7jIAxD9rTr+x7DMPBMniiKApZloWka3lM5ZQi6c2Ge54iiiMuyLOM3TVMkScI+jmP2lAmCAGVZ8h9SlnJ0J6SUXCzwz9oBZg3rcvfRqKwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rails postgres docker articles index\"\n        title=\"rails postgres docker articles index\"\n        src=\"/static/eb17de220eaacd6fefa9ae491727fe15/f6b72/rails-postgres-docker-articles-index.png\"\n        srcset=\"/static/eb17de220eaacd6fefa9ae491727fe15/772e8/rails-postgres-docker-articles-index.png 200w,\n/static/eb17de220eaacd6fefa9ae491727fe15/e17e5/rails-postgres-docker-articles-index.png 400w,\n/static/eb17de220eaacd6fefa9ae491727fe15/f6b72/rails-postgres-docker-articles-index.png 615w\"\n        sizes=\"(max-width: 615px) 100vw, 615px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Congratulations! You now have a running Rails application that is using a Dockerized Postgres database.</p>\n<aside class=\"markdown-aside\">\nSince the test database is also running in a Docker container, this will require Docker-specific setup to work on whatever CI (continuous integration) system your project is using. If using <a class=\"markdown-link\" href=\"https://github.com/features/actions\">Github Actions</a>, the host mount to the project source for initializing the database role doesn't work due to the order of how services and source checkout works. See my post on <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/debug-github-action/\">Debugging Github Actions</a> for more details.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has walked through the steps required to setup a Rails application with a Postgres database running in a Docker container. It requires adding a <code>docker-compose.yml</code> file to the project. This file defines the database service including what Docker image to use, port mapping, volumes, and environment variables. Then the Rails project file <code>config/database.yml</code> must be modified so that the development and test databases are configured to point to the Dockerized database rather than assuming they're available on localhost. Finally the <code>psql</code> command line tool can be used to connect to the database in the container to verify the Rails application is populating it as expected.</p>\n<h2 class=\"markdown-subtitle\" id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h2>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://github.com/danielabar/blogpg\" class=\"markdown-link\">Example Rails Project with Postgres in Docker</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://brew.sh/\" class=\"markdown-link\">Homebrew Package Manager for Mac</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://formulae.brew.sh/formula/postgresql@14\" class=\"markdown-link\">Postgresql on Homebrew</a> - notice they're all versioned now!</li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/getting_started.html\" class=\"markdown-link\">Rails Getting Started Building Blog App</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://guides.rubyonrails.org/command_line.html#rails-with-databases-and-scm\" class=\"markdown-link\">Rails Command Line Option for Database</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://hub.docker.com/_/postgres\" class=\"markdown-link\">Postgres Official Image on Docker Hub</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://github.com/docker-library/docs/blob/master/postgres/README.md\" class=\"markdown-link\">Postgres Docker Image Full Readme</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://stackoverflow.com/questions/27709456/what-is-the-difference-between-a-user-and-a-role\" class=\"markdown-link\">Postgres user vs role</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-postgres-docker/"}}},{"node":{"id":"d84ac79f-d860-544a-8abb-63add1da9214","frontmatter":{"title":"Understanding ActiveRecord Dependent Options","date":"July 2023","category":"rails"},"excerpt":"Rails makes defining relationships between models using Active Record associations super easy. Simply add a macro style declaration such asâ€¦","html":"<p class=\"markdown-para\">Rails makes defining relationships between models using Active Record associations super easy. Simply add a macro style declaration such as <code>has_one</code>, <code>has_many</code>, <code>belongs_to</code> etc. to your model and Rails will take care of maintaining the relationship. However, some thought is required when it comes to <em class=\"markdown-emphasis\">removing</em> data from the database, while maintaining data integrity such as foreign key constraints. All the Rails courses and tutorials I've done so far cover adding associations, but none have covered what happens when a record with associations needs to be removed.</p>\n<p class=\"markdown-para\">Many years ago, before the likes of GDPR and privacy concerns, the \"solution\" was to never remove any data or use <a href=\"https://stackoverflow.com/questions/378331/physical-vs-logical-hard-vs-soft-delete-of-database-record\" class=\"markdown-link\">soft delete</a>. But with increased privacy regulations and the <a href=\"https://en.wikipedia.org/wiki/Right_to_be_forgotten\" class=\"markdown-link\">right to be forgotten</a>, applications need the ability to safely remove certain data.</p>\n<p class=\"markdown-para\">The Rails Guide on <a href=\"https://guides.rubyonrails.org/association_basics.html\" class=\"markdown-link\">Active Record Associations</a> does cover deletion options. However, since there are so many options besides just for deletion, I found myself scrolling up and down through the docs and losing track of which side of the association was being referred to. Also, since different options can be specified on each side of an association, it can be tricky to reason about what would happen with various <em class=\"markdown-emphasis\">combinations</em> of options.</p>\n<p class=\"markdown-para\">A further complexity is that there are two different ways to remove an ActiveRecord model in rails: Delete and Destroy. They sound similar but do different things (more on this later). If you add that into the mix of removal options, the number of scenarios grows even further.</p>\n<p class=\"markdown-para\">In the vein of \"a picture is worth a thousand words\", I decided to build a sample Rails application and do a deep dive on all the removal options for some commonly used associations and how they behave when deleting or destroying a record. This post will walk through the results of this.</p>\n<p class=\"markdown-para\">For those in a hurry, you can skip ahead to the <a href=\"../activerecord-dependent-options/#which-should-you-use\" class=\"markdown-link\">Which Should You Use?</a> section.</p>\n<h2 class=\"markdown-subtitle\" id=\"project-setup\" style=\"position:relative;\"><a href=\"#project-setup\" aria-label=\"project setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Project Setup</h2>\n<p class=\"markdown-para\">I started by scaffolding a new Rails project with Ruby 3 and Rails 7, using the default SQLite database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">rbenv install 3.1.2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rbenv local 3.1.2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">gem install rails -v 7.0.4</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rails new learn-associations</span></span></code></pre>\n<p class=\"markdown-para\">I added the <a href=\"https://github.com/ctran/annotate_models\" class=\"markdown-link\">annotate</a> gem to add the corresponding table schema as code comments above each model class when migrations are run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Gemfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">group </span><span class=\"mtk4\">:development</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  gem </span><span class=\"mtk6\">&quot;annotate&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">I then generated several models to study the <code>belongs_to</code> and <code>has_many</code> associations. This is a very common use case. For example, in an e-commerce application a Customer has many Orders, and an Order belongs to a single Customer. Or a Product has many Sku variations, and a Sku belongs to a Product. For this sample application, I used the Book and Author models from the <a href=\"https://guides.rubyonrails.org/association_basics.html#the-belongs-to-association\" class=\"markdown-link\">Active Record Associations Guide</a>:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 771px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1UlEQVR42o2SW4/SUBSF+1ON86K+OM+++VPGqIP6KDEmmsEMGmHAUnoDuQy0lJYCvVFkuH/mNIFgxkRXss7JPjln7b3O3pKbKDSTl+h+jpvbFxiTHD9nl5hunvVqg8B+v88osNls6EYfaac5FOc15c5F9qYRvaI3kpHU4Ts+e2e8Nx/xpvKQgvOU0uycvPKMWTK/J7hYLLi2nvNl/JjLmwe8rZxRGJ5zPX1CQb5AsjwdpfuBaiOPf1dlhpFR7VyRxLOj4AHr9ZrbUZne9Ct6/xPBViHFJNjUUIxvSKOxQzR3SZcTkl8+fmARzz2MZo00TY9CorLVasV4PMaf2txtQxbrgHg+YhzahKmLqteQrL6F1beJwpgojFCUOuLMMEw8z2O5XDKZTLAsiziOabVaqKrGyPMJghDbsil9L+EMnOyt1Ol0uCpcoWoqw+GQYrFIuVymWq3iOA5JkmRCp7ZN00TTNLrdLs1mk3pdodFo0O/3kaIootfrZRXYtp3tg8EA13X5F06THCD97aIQFMLtdjurUtd1ZPlHVpUsy+iahu/79yZA7JJYdrvdkSIWloRtRVEyG4ZhUKlUCMMw67L41812+4fggdJpcBhcISK6eppI8H8s/wZBSuP/ffBHVAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"association book belongs to author\"\n        title=\"association book belongs to author\"\n        src=\"/static/e1b673483a9587c93f905077189a9903/5d030/association-book-belongs-to-author.png\"\n        srcset=\"/static/e1b673483a9587c93f905077189a9903/772e8/association-book-belongs-to-author.png 200w,\n/static/e1b673483a9587c93f905077189a9903/e17e5/association-book-belongs-to-author.png 400w,\n/static/e1b673483a9587c93f905077189a9903/5d030/association-book-belongs-to-author.png 771w\"\n        sizes=\"(max-width: 771px) 100vw, 771px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB3klEQVR42o2RXYvaYBCF83tLKXTr7d73g8IuW+i/KL0oLWXBNqBipSZN1GiiqRoTE6OJiZusipqnJIvill70wOGd92LOnDMjyMEVP+wbPjdfcqu+RvJvqE+usT2THFl2IMuy4s0RJhYN9woleM+t+oavv14h+e+oO28xrAZCPbqgbF3wUX3CN6uEnF4iTl+gaLVC4HDYPxJ0lxpl5xkVv8Qn7Sllq4SUXFKZP6emfEDoTspI+hf6rsg9OvcY2HGDvtnlHIfDg+AynvHbrzBwK4wWNdYYpOj4awlVayBEqUuUeESpxywY44cW1tSg2fzJZrNhtVqx2+1OwvFqibcYkm4XxEWPhbcY4cxMFFVGcOwpURQTLSO6WhddN5g6U0RRJIoiwjBkPB4TxzFpmuI4Dn1jQBgsubtLGI8tVLWF63pomoYgyRL9vsFgMEBRFNrtNlpXYz6fn1wlSUIQBIXoaDRCFL8jSVIh3uv1qFar9HpdVFVFOO7nuKOHy2an91gfsV6vabVaBXVdL5jX7U4Hz/MQzptyB7lt0zQLB5PJBNMc0JQkVEUpEuQu+obOerPlX3gkuN1ukWW5iJ9PHQ6HtNudYkieYL/fF8yPlP+PvecUziPmDm3b5n/x92pywT+55OH9P9j1hAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"association author has many books\"\n        title=\"association author has many books\"\n        src=\"/static/e5ba0409abfb813075ad0cefb45ceed4/e5715/association-author-has-many-books.png\"\n        srcset=\"/static/e5ba0409abfb813075ad0cefb45ceed4/772e8/association-author-has-many-books.png 200w,\n/static/e5ba0409abfb813075ad0cefb45ceed4/e17e5/association-author-has-many-books.png 400w,\n/static/e5ba0409abfb813075ad0cefb45ceed4/e5715/association-author-has-many-books.png 768w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">I also added a <code>title</code> attribute to the <code>Book</code> model to make it easier to look up individual books for removal.</p>\n<aside class=\"markdown-aside\">\nThere are many more <a href=\"https://guides.rubyonrails.org/association_basics.html#the-types-of-associations\" class=\"markdown-link\">association types</a> but this post will focus on the <code>belongs_to</code> and <code>has_many</code> as attempting to do more would make it too long. Perhaps a topic for a future blog post.\n</aside>\n<p class=\"markdown-para\">Here are the commands to generate the models, which also generate the migrations to create the tables. I also generated a <code>Post</code> model that is not associated with anything, to demonstrate the difference between <code>destroy</code> and <code>delete</code> in a simple case where there are no associated models.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># simple model with no associations to demonstrate difference between destroy and delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate model post title:string body:text</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># models with associations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate model author name:string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate model book title:string published_at:date author:references</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nPassing <code>-h</code> or <code>--help</code> to any generator command, eg: <code>bin/rails generate model -h</code> provides a complete guide to that generator. For example, if you want to know what are all the valid data types for model attributes.\n</aside>\n<p class=\"markdown-para\">Here are the migrations that are generated. Notice that the Book model has a foreign key reference to an Author since each Book belongs to one Author. The Post model is not related to anything:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreatePosts</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:posts</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">text</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateAuthors</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:authors</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">foreign_key:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">After running the migrations, here are the model classes showing that an Author has many Books and a Book belongs to an Author. The Post model has no associations. The schema information was added by the <a href=\"https://github.com/ctran/annotate_models\" class=\"markdown-link\">annotate</a> gem:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: posts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  body       :text</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  title      :string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Post</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: authors</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  name       :string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id           :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  published_at :date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  title        :string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at   :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at   :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  author_id    :integer          not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Indexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  index_books_on_author_id  (author_id)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Foreign Keys</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  author_id  (author_id =&gt; authors.id)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's seed some example Posts, Authors, and Books so that we can test what happens when trying to remove them:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/seeds.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Post is a simple model with no associations to demonstrate the difference between</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ActiveRecord methods destroy and delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Hello Post&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">body:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Learning about destroy and delete in Rails.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Another Post&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">body:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Lorem ipsum dolor sit amet, consectetur adipiscing elit.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author with multiple books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">author_ap </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Andrew Park&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author with a single book</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">author_jjk </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Julian James McKinnon&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author with no books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;John Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create 3 books for Andrew Park and just one book for Julian James McKinnon</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python Programming for Beginners&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;2022-07-20&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">author:</span><span class=\"mtk1\"> author_ap },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Machine Learning: 4 Books in 1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;2020-01-20&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">author:</span><span class=\"mtk1\"> author_ap },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python for Data Analysis&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;2021-01-20&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">author:</span><span class=\"mtk1\"> author_ap },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Computer Programming Crash Course: 7 Books in 1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;2021-01-20&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">author:</span><span class=\"mtk1\"> author_jjk }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">Run the seeds in both the development and test databases. We'll be using the development database to experiment a little, and later the test database to automate all the experiments:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails db:seed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">RAILS_ENV=test bin/rails db:seed</span></span></code></pre>\n<p class=\"markdown-para\">If you want to follow along with the project, here is the <a href=\"https://github.com/danielabar/learn-associations\" class=\"markdown-link\">source</a> on Github.</p>\n<h2 class=\"markdown-subtitle\" id=\"delete-destroy\" style=\"position:relative;\"><a href=\"#delete-destroy\" aria-label=\"delete destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Delete Destroy</h2>\n<p class=\"markdown-para\">I wanted to understand what would happen when attempting to remove various Author or Book records from the database with respect to their associations. However, there's an additional complexity in that there's two different methods to remove a record, which sound similar, but do slightly different things. From the <a href=\"https://api.rubyonrails.org/\" class=\"markdown-link\">Rails API Documentation</a>:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-delete\" class=\"markdown-link\">delete</a>: Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they can't be persisted). Returns the frozen instance. The row is simply removed with an SQL <code>DELETE</code> statement on the record's primary key, and no callbacks are executed.</li>\n<li class=\"markdown-list-item\"><a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-destroy\" class=\"markdown-link\">destroy</a>: Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they can't be persisted). There's a series of callbacks associated with destroy. If the <code>before_destroy</code> callback throws <code>:abort</code> the action is cancelled and destroy returns <code>false</code>.</li>\n<li class=\"markdown-list-item\"><a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-destroy-21\" class=\"markdown-link\">destroy!</a>: Similar to <code>destroy</code>, except raises <code>ActiveRecord::RecordNotDestroyed</code> rather than returning false if the record is not destroyed.</li>\n</ul>\n<p class=\"markdown-para\">To summarize the difference, <code>delete</code> immediately invokes SQL to remove the record from the database, whereas <code>destroy/destroy!</code> first invokes the model's <code>before_destroy</code> callback which can potentially stop the deletion. I'm assuming this could be a place for cleanup code.</p>\n<p class=\"markdown-para\">To understand this with a simple case, let's modify the <code>Post</code> model, which has no associations, to add a <code>before_destroy</code> callback. This callback will simply output a message:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Post</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Post model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Launch a Rails console with <code>bin/rails c</code> and let's see how the removal methods behave:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">post </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Hello Post&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">post.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Post Destroy (3.8ms)  DELETE FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 5]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">post.</span><span class=\"mtk5\">frozen?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">another_post </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Another Post&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">another_post.</span><span class=\"mtk5\">destroy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Post model 6 will be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># TRANSACTION (0.1ms)  begin transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Post Destroy (0.5ms)  DELETE FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 6]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># TRANSACTION (1.1ms)  commit transaction</span></span></span></code></pre>\n<p class=\"markdown-para\">From the above, we can see that <code>delete</code> immediately invokes the SQL <code>DELETE</code> statement whereas <code>destroy</code> first invokes the <code>before_destroy</code> callback. Now with this understood, we can move on to removal of records with associations.</p>\n<aside class=\"markdown-aside\">\nThere is one more difference in the behaviour the delete and destroy that isn't documented. When specifying a dependent option on an ActiveRecord association, the logic for that option will only run when the destroy method is invoked, not the delete method. This will be demonstrated in the various test scenarios further in this post.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"options-matrix\" style=\"position:relative;\"><a href=\"#options-matrix\" aria-label=\"options matrix permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options Matrix</h2>\n<p class=\"markdown-para\">Recall we have Books that <code>belong_to</code> an Author, and Author's <code>have_many</code> books. Let's start by looking at the dependent options for <a href=\"https://guides.rubyonrails.org/association_basics.html#options-for-belongs-to-dependent\" class=\"markdown-link\">belongs_to</a>:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\"><code>:destroy</code> when the object is destroyed, destroy will be called on its associated objects.</li>\n<li class=\"markdown-list-item\"><code>:delete</code> when the object is destroyed, all its associated objects will be deleted directly from the database without calling their destroy method.</li>\n</ol>\n<p class=\"markdown-para\">For example, to use the <code>destroy</code> option, the Book model would look like this to indicate that whenever a Book is destroyed, its associated Author should also be destroyed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here are the dependent options for <a href=\"https://guides.rubyonrails.org/association_basics.html#dependent\" class=\"markdown-link\">has_many</a>:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\"><code>:destroy</code> causes all the associated objects to also be destroyed</li>\n<li class=\"markdown-list-item\"><code>:delete_all</code> causes all the associated objects to be deleted directly from the database (so callbacks will not execute)</li>\n<li class=\"markdown-list-item\"><code>:destroy_async</code> when the object is destroyed, an <code>ActiveRecord::DestroyAssociationAsyncJob</code> job is enqueued which will call destroy on its associated objects. Active Job must be set up for this to work.</li>\n<li class=\"markdown-list-item\"><code>:nullify</code> causes the foreign key to be set to NULL. Polymorphic type column is also nullified on polymorphic associations. Callbacks are not executed.</li>\n<li class=\"markdown-list-item\"><code>:restrict_with_exception</code> causes an ActiveRecord::DeleteRestrictionError exception to be raised if there are any associated records</li>\n<li class=\"markdown-list-item\"><code>:restrict_with_error</code> causes an error to be added to the owner if there are any associated objects</li>\n</ol>\n<p class=\"markdown-para\">For example, to use the <code>destroy</code> option, the Author model would look like this to indicate that whenever an Author is destroyed, its Books should also be destroyed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Summing up the options, there are 2 dependent options on the <code>belongs_to</code> association, plus the \"option\" to not specify anything which makes 3. There are 6 dependent options on the <code>has_many</code> association, plus the do nothing \"option\" which makes 7.</p>\n<p class=\"markdown-para\">On the <code>has_many</code> side, the <code>restrict_with_error</code> option behaves similarly to the <code>restrict_with_exception</code> except that it populates the <code>errors</code> property of the model instead of raising an exception. Similarly, the <code>destroy_async</code> option behaves similarly to the <code>destroy</code> except it does so via a job. To reduce the number of combinations and avoid the complexity of setting up ActiveJob in this analysis, will only consider <code>restrict_with_exception</code> and leave off <code>destroy_async</code>.</p>\n<p class=\"markdown-para\">This means there are 3 * 5 = 15 possible combinations of dependent options:</p>\n<table class=\"markdown-table\">\n<thead>\n<tr>\n<th>Scenario</th>\n<th>belongs_to</th>\n<th>has_many</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#1-no-options\" class=\"markdown-link\">1</a></td>\n<td>not specified</td>\n<td>not specified</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">2</a></td>\n<td>not specified</td>\n<td>:destroy</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#3-has-many-delete-all\" class=\"markdown-link\">3</a></td>\n<td>not specified</td>\n<td>:delete_all</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#4-has-many-nullify\" class=\"markdown-link\">4</a></td>\n<td>not specified</td>\n<td>:nullify</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#5-has-many-restrict-with-exception\" class=\"markdown-link\">5</a></td>\n<td>not specified</td>\n<td>:restrict_with_exception</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#6-belongs-to-destroy\" class=\"markdown-link\">6</a></td>\n<td>:destroy</td>\n<td>not specified</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#7-belongs-to-destroy-has-many-destroy\" class=\"markdown-link\">7</a></td>\n<td>:destroy</td>\n<td>:destroy</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#8-belongs-to-destroy-has-many-delete-all\" class=\"markdown-link\">8</a></td>\n<td>:destroy</td>\n<td>:delete_all</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#9-belongs-to-destroy-has-many-nullify\" class=\"markdown-link\">9</a></td>\n<td>:destroy</td>\n<td>:nullify</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#10-belongs-to-destroy-has-many-restrict-with-exception\" class=\"markdown-link\">10</a></td>\n<td>:destroy</td>\n<td>:restrict_with_exception</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#11-belongs-to-delete\" class=\"markdown-link\">11</a></td>\n<td>:delete</td>\n<td>not specified</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#12-belongs-to-delete-has-many-destroy\" class=\"markdown-link\">12</a></td>\n<td>:delete</td>\n<td>:destroy</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#13-belongs-to-delete-has-many-delete-all\" class=\"markdown-link\">13</a></td>\n<td>:delete</td>\n<td>:delete_all</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#14-belongs-to-delete-has-many-nullify\" class=\"markdown-link\">14</a></td>\n<td>:delete</td>\n<td>:nullify</td>\n</tr>\n<tr>\n<td><a href=\"../activerecord-dependent-options/#15-belongs-to-delete-has-many-restrict-with-exception\" class=\"markdown-link\">15</a></td>\n<td>:delete</td>\n<td>:restrict_with_exception</td>\n</tr>\n</tbody>\n</table>\n<p class=\"markdown-para\">For each combination, I want to understand what happens given the following:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">An Author with no books is destroyed.</li>\n<li class=\"markdown-list-item\">An Author with a single book is destroyed.</li>\n<li class=\"markdown-list-item\">An Author with multiple books is destroyed.</li>\n<li class=\"markdown-list-item\">1 through 3 above but deleted instead of destroyed.</li>\n<li class=\"markdown-list-item\">A book belonging to an Author that only has that one book is destroyed.</li>\n<li class=\"markdown-list-item\">A book belonging to an Author that has multiple other books is destroyed.</li>\n<li class=\"markdown-list-item\">5 through 6 above but deleted instead of destroyed.</li>\n</ol>\n<p class=\"markdown-para\">So that's 7 actions * 15 scenarios = 105 actions. Definitely too much work to try out each one in the console, but easily handled by a test framework. I'll use <a href=\"https://rspec.info/\" class=\"markdown-link\">RSpec</a> as that's what I'm familiar with, and it automatically resets the database after each example.</p>\n<h2 class=\"markdown-subtitle\" id=\"test-setup\" style=\"position:relative;\"><a href=\"#test-setup\" aria-label=\"test setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test Setup</h2>\n<p class=\"markdown-para\">After <a href=\"../start-rails-6-project-with-rspec\" class=\"markdown-link\">adding RSpec to the project</a>, I added the following tests for the Author and Book models. These are exploratory tests, that is, they're being used to learn what will happen rather than declaring what should happen. That's why there are no expectations, and exceptions are caught and logged.</p>\n<p class=\"markdown-para\">The bang version <code>destroy!</code> is used since it raises an exception so its easier to see what went wrong. I'm also logging the beginning and ending of each test to make it clear in the log file what activity is coming from which test. Finally, a test helper is added to show the counts of how many authors and books were deleted at the end of each test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/helpers.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Add `require &quot;./spec/helpers&quot;` to rails_helper.rb after Rails is loaded</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Helpers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">show_model_counts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    original_author_count </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    original_book_count </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;  NUMBER AUTHORS DELETED: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">original_author_count </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">count</span><span class=\"mtk7\">}</span><span class=\"mtk6\">; NUMBER BOOKS DELETED: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">original_book_count </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">count</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/models/author_spec.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe Author, </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:model</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">before</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:each</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |example|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">=== BEGIN TEST </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">example.</span><span class=\"mtk5\">metadata</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:full_description</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> ===&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">after</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:each</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    show_model_counts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;=== END TEST ===</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#destroy!&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with no books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;John Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with a single book&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Julian James McKinnon&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with multiple books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Andrew Park&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#delete&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with no books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;John Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with a single book&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Julian James McKinnon&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove an author with multiple books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      author </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Author</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Andrew Park&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        author.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/models/book_spec.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe Book, </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:model</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">before</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:each</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |example|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">=== BEGIN TEST </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">example.</span><span class=\"mtk5\">metadata</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:full_description</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> ===&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">after</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:each</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    show_model_counts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;=== END TEST ===</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#destroy!&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove a book from author that only has that book&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Computer Programming Crash Course: 7 Books in 1&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        book.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove a book from author that has multiple books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python Programming for Beginners&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        book.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#delete&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove a book from author that only has that book&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Computer Programming Crash Course: 7 Books in 1&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        book.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;remove a book from author that has multiple books&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python Programming for Beginners&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        book.</span><span class=\"mtk5\">delete</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">class</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> - </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e.</span><span class=\"mtk5\">message</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<p class=\"markdown-para\">In this next section, each model class will be modified with respect to its dependent option, then the tests will be run and the log files analyzed to understand the behavior of each option.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"1-no-options\" style=\"position:relative;\"><a href=\"#1-no-options\" aria-label=\"1 no options permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1: No Options</h3>\n<p class=\"markdown-para\">In this scenario, we do not specify any <code>dependent</code> option on either side of the <code>belongs_to/has_many</code> relationship. So the models simply look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's run the tests with <code>bundle exec rspec</code> and then examine the <code>log/test.log</code> file:</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (7.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.4ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (3.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test Log Summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Author (i.e. model on the <code>has_many</code> side of the relationship) with one or more books cannot be removed. Both <code>destroy!</code> and <code>delete</code> methods raise <code>ActiveRecord::InvalidForeignKey</code>.</li>\n<li class=\"markdown-list-item\">Author with no books can be successfully removed with either <code>destroy!</code> or <code>delete</code> methods.</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">If your system never needs to delete any instance of the model on the <code>has_many</code> side, then not specifying any <code>dependent</code> options is ok, otherwise, consider one of the other scenarios.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"2-has-many-destroy\" style=\"position:relative;\"><a href=\"#2-has-many-destroy\" aria-label=\"2 has many destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2: Has Many Destroy</h3>\n<p class=\"markdown-para\">In this case, we leave the Book model with no dependent option, and specify <code>destroy</code> on the Author model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to also be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (1.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nBook model 2 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 2]]\nBook model 3 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 3]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy/destroy!</code> on Author model (<code>has_many</code> side of relationship) instance works to delete that author <em class=\"markdown-emphasis\">and</em> also destroys each of the author's books. That is, each associated book has its <code>before_destroy</code> callback invoked, and then is deleted from the database with a SQL DELETE statement. Note that in the case of an Author with multiple Books, the books are deleted one at a time with multiple SQL DELETE statements. This is because each book also must have its callbacks invoked.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on Author model fails on foreign key constraint for author instances that have one or more associated books. (<code>delete</code> on Author model with no books succeeds).</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">Use the <code>dependent: :destroy</code> option to support a cascade style delete where a parent model and all its associations can be removed, with the associated models <code>before_destroy</code> callbacks invoked for final cleanup.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"3-has-many-delete-all\" style=\"position:relative;\"><a href=\"#3-has-many-delete-all\" aria-label=\"3 has many delete all permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3: Has Many Delete All</h3>\n<p class=\"markdown-para\">In this case, we leave the Book model with no dependent option, and specify <code>delete_all</code> on the Author model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete_all</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container\">\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n</code>\n</pre>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy/destroy!</code> on Author model (<code>has_many</code> side of relationship) instance works to delete that author <em class=\"markdown-emphasis\">and</em> also directly deletes each of the author's books. That is, each associated book will be deleted via SQL DELETE statement but will <em class=\"markdown-emphasis\">not</em> have its <code>before_destroy</code> callback invoked. Unlike in <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a> where the books were deleted one at a time, in this case, all of an author's books are deleted in a single SQL DELETE statement.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on Author model fails on foreign key constraint for author instances that have one or more associated books.</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">Use the <code>dependent: :delete_all</code> option to support a cascade style delete where a parent model and all its associations can be removed, and where the associated models can be immediately deleted via SQL DELETE, with no need for their <code>before_destroy</code> callbacks invoked, i.e. no need for any final cleanup.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"4-has-many-nullify\" style=\"position:relative;\"><a href=\"#4-has-many-nullify\" aria-label=\"4 has many nullify permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4: Has Many Nullify</h3>\n<p class=\"markdown-para\">In this case, we leave the Book model with no dependent option, and specify <code>nullify</code> on the Author model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:nullify</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes the foreign key to be set to NULL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (1.2ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (1.2ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::NotNullViolation - SQLite3::ConstraintException: NOT NULL constraint failed: books.author_id\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::NotNullViolation - SQLite3::ConstraintException: NOT NULL constraint failed: books.author_id\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.0ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (1.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with no books invokes its <code>before_destroy</code> callback then removes the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with one or more books fails, but not on a foreign key constraint, rather, an <code>ActiveRecord::NotNullViolation</code>. This is because it's attempting to update <code>author_id</code> on the associated Book models to <code>null</code> which is not allowed due to how the Book migration was defined.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an Author with one or more books fails, raising <code>ActiveRecord::InvalidForeignKey</code>.</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">The <code>nullify</code> option could be useful if the system requirements were that an Author (parent model on the <code>has_many</code> side) could be removed from the database, but its associated Books could not be removed. In order for this to work, the Book model (child model on the <code>belongs_to</code>) side would need to allow its foreign key<code>author_id</code> to be null, i.e. the migration would have to look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Original column definition</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># t.references :author, null: false, foreign_key: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Modified column definition to support nullify option on Author model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With a null <code>author_id</code> allowed, the Author destroy tests succeed in removing the Author from the database, <em class=\"markdown-emphasis\">and</em> updating the Author's associated Books with a null <code>author_id</code> as shown in this test log below, focusing only on the Author tests:.</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nTest log for Author destroy with null FK allowed on Book\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (1.6ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\">In a real application, the code that handles or displays Books would have to be flexible enough to handle a null Author rather than assuming it will always be populated.</p>\n<p class=\"markdown-para\">One thing to watch out with the nullify option, is that calling <code>delete</code> on an author simply removes the author via SQL DELETE, but does not update the author's associated books to have a null <code>author_id</code>. This leaves the books as orphans, referencing an author that no longer exists, as shown in this snippet of the test log:</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nTest log for Author delete with null FK allowed on Book\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\">Lesson learned: When using the <code>dependent: :nullify</code>, remember to use the <code>destroy</code> method rather than <code>delete</code>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"5-has-many-restrict-with-exception\" style=\"position:relative;\"><a href=\"#5-has-many-restrict-with-exception\" aria-label=\"5 has many restrict with exception permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5: Has Many Restrict With Exception</h3>\n<p class=\"markdown-para\">In this case, we leave the Book model with no dependent option, and specify <code>restrict_with_exception</code> on the Author model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:restrict_with_exception</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># ActiveRecord::DeleteRestrictionError exception raised if there are any associated records</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 3], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (2.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.2ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with no books invokes its <code>before_destroy</code> callback then removes the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with one or more books fails, but not on a foreign key constraint, rather, an <code>ActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books</code>. This is the behaviour of <code>restrict_with_exception</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an Author with one or more books fails, raising <code>ActiveRecord::InvalidForeignKey</code>.</li>\n<li class=\"markdown-list-item\">Book instances (<code>belongs_to</code> side of relationship) can be destroyed or deleted with no errors and this action only affects the book, not the related author.</li>\n</ul>\n<p class=\"markdown-para\">Use this option if you want to prevent models with dependent models from being removed, but with an explicit exception that can be handled rather than catching a foreign key constraint violation from the database. Note that you have to use the <code>destroy</code> method to raise <code>DeleteRestrictionError</code>. The <code>delete</code> method still raises <code>ActiveRecord::InvalidForeignKey</code>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"6-belongs-to-destroy\" style=\"position:relative;\"><a href=\"#6-belongs-to-destroy\" aria-label=\"6 belongs to destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6: Belongs to Destroy</h3>\n<p class=\"markdown-para\">In this case, we update the Book model to specify <code>destroy</code> and the Author model is unspecified:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (2.0ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.5ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (1.6ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (1.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (1.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Author tests behave the same as <a href=\"../activerecord-dependent-options/#1-no-options\" class=\"markdown-link\">Scenario 1</a>, where any author with an associated book cannot be removed due to foreign key constraint.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that only has that one book, destroys both the book and the author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that has other books as well fails. It attempts to delete the author but then runs into a foreign key constraint because there's still other books in the system that belong to that author. In this case, nothing is deleted.</li>\n<li class=\"markdown-list-item\">Calling delete on a book (whether the author has only that one book or others as well), deletes only that book and does not attempt to go up to the author for further deletion.</li>\n</ul>\n<p class=\"markdown-para\">Note that the Rails Guides warn not to use this <code>dependent: :destroy</code> option in this way:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">You should not specify this option on a belongs_to association that is connected with a has_many association on the other class. Doing so can lead to orphaned records in your database.</p>\n</blockquote>\n<p class=\"markdown-para\">The test that attempts to destroy a book belonging to an author that has other books is where this issue could happen. If the associated author had been removed, that would leave the other books \"orphaned\". With a non nullable foreign key constraint on the Book model, this was not allowed.</p>\n<p class=\"markdown-para\">However, if the Book migration allowed a nullable foreign key for author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Original column definition</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># t.references :author, null: false, foreign_key: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># For experimentation in allowing a nullable foreign key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Then calling destroy on a book whose author has other books will remove both the book and author from the system, leaving the other books from this author as \"orphans\" in that they still have their <code>author_id</code> property populated, but the referenced author has been removed.</p>\n<p class=\"markdown-para\">Let's see this in a Rails console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># book by author that has other books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">book </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Python Programming for Beginners&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># removing book also removes associated author, even though that author has other books!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">book.</span><span class=\"mtk5\">destroy!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Book model 1 will be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># TRANSACTION (0.1ms)  begin transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Book Destroy (0.8ms)  DELETE FROM &quot;books&quot; WHERE &quot;books&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author Load (0.3ms)  SELECT &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = ? LIMIT ?  [[&quot;id&quot;, 1], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author model 1 will be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Author Destroy (0.3ms)  DELETE FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># TRANSACTION (0.7ms)  commit transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># this leaves some books still pointing to the deleted author - these are orphans</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">orphaned_books </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Book</span><span class=\"mtk1\">.</span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk4\">author_id:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">orphaned_books.</span><span class=\"mtk5\">count</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 2</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>dependent: :destroy</code> option on the <code>belongs_to</code> side of a relationship could be useful in a 1-1 situation, for example, if an Author specified <code>has_one</code> book instead of <code>has_many</code>. But otherwise, it doesn't really make sense because either it will lead to orphan records or foreign key constraint errors in some cases.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"7-belongs-to-destroy-has-many-destroy\" style=\"position:relative;\"><a href=\"#7-belongs-to-destroy-has-many-destroy\" aria-label=\"7 belongs to destroy has many destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7: Belongs to Destroy Has Many Destroy</h3>\n<p class=\"markdown-para\">In this case, the <code>destroy</code> option is specified on both sides of the relationship:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to also be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This could be a strange situation as declaring destroy on each side says \"when this model is destroyed, also destroy its associated models\". This means destroying a book would attempt to destroy its author, but that in turn would attempt to destroy its book(s), could this cause an infinite destroy loop? Let's see what happens with the tests.</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (2.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (8.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::RecordNotDestroyed - Failed to destroy Book with id=4\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::RecordNotDestroyed - Failed to destroy Book with id=1\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.9ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (2.0ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nBook model 2 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::RecordNotDestroyed - Failed to destroy Book with id=1\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with no books invokes its <code>before_destroy</code> callback then removes the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on an Author with one or more books fails, but not on a foreign key constraint, rather, an <code>ActiveRecord::RecordNotDestroyed - Failed to destroy Book with id={author id}</code>. In this case it's attempting to destroy the Author's associated book(s) but failing to do so. Interesting that the error message doesn't say why it failed. Recall that in <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a> where the destroy on the has_many side was used by itself, destroying an author with one or more books was successful.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an Author with one or more books fails, raising <code>ActiveRecord::InvalidForeignKey</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on a book belonging to an Author that only has that one book works - both the book and its author are removed from the database, although it does run a query first to see if that author has any other books.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> on a book belonging to an Author that has other books fails with <code>ActiveRecord::RecordNotDestroyed - Failed to destroy Book with id={book_id}</code>. In <a href=\"../activerecord-dependent-options/#6-belongs-to-destroy\" class=\"markdown-link\">Scenario 6</a>, where destroy was only specified on Book but not Author, this case also failed but with a more useful error indicating why the book could not be removed: <code>ActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book, regardless of its author having just that book or others, successfully removes that book and does not attempt to remove any authors.</li>\n</ul>\n<p class=\"markdown-para\">Even though Rails will not go into an infinite loop with <code>destroy</code> on both sides of the relationship, this seems like an invalid combination. In a simple application such as this one, it's easy to see the <code>destroy</code> on both sides and fix it (choose just one), but in a larger app with more models, it could be tricky to find.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"8-belongs-to-destroy-has-many-delete-all\" style=\"position:relative;\"><a href=\"#8-belongs-to-destroy-has-many-delete-all\" aria-label=\"8 belongs to destroy has many delete all permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>8: Belongs to Destroy Has Many Delete All</h3>\n<p class=\"markdown-para\">In this case, the <code>destroy</code> option is specified on Book and <code>delete_all</code> on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete_all</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all associated objects to be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (1.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.8ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Delete All (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.0ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Delete All (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy!</code> an author has the same effect as it did in <a href=\"../activerecord-dependent-options/#3-has-many-delete-all\" class=\"markdown-link\">Scenario 3</a>, in that it first directly removes all of the author's books via SQL DELETE, then calls the author's <code>before_destroy</code> callback, then removes the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author with books fails on a foreign key constraint.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that only has that one book removes both the book and its associated author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that has other books is the most interesting case - it removes the book from the database, then finds the author, then finds all the other books belonging to this author and removes those as well, then finally, it removes the author.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book removes just that book.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this combination as it can produce a surprising result when calling <code>book.destroy</code> on a book that belongs to an author that also has other books. It ends up removing not just that book but all the other books written by this author. It's a kind of cascade but starting from a child, going up to the parent, then back down to other children.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"9-belongs-to-destroy-has-many-nullify\" style=\"position:relative;\"><a href=\"#9-belongs-to-destroy-has-many-nullify\" aria-label=\"9 belongs to destroy has many nullify permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>9: Belongs to Destroy Has Many Nullify</h3>\n<p class=\"markdown-para\">In this case, the <code>destroy</code> option is specified on Book and <code>nullify</code> on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:nullify</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes the foreign key to be set to NULL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">In <a href=\"../activerecord-dependent-options/#4-has-many-nullify\" class=\"markdown-link\">Scenario 4</a>, we learned that in order for <code>nullify</code> to work, the model on the other side of the relationship (Book) needs to allow a nullable foreign key. So we'll run the tests with the database having this migration for the <code>books</code> table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># t.references :author, null: false, foreign_key: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># for experimentation in allowing a nullable foreign key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.5ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.6ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.7ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (16.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (1.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Update All (0.1ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.0ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Update All (0.1ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with one or more books is successful. It first finds the author's associated books, updates their <code>author_id</code> column to <code>nil</code>, then SQL DELETEs the author record.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author is also successful. However, it does not update its associated book models to have a null <code>author_id</code>. This will leave book records \"orphaned\" in that they're referencing an author that no longer exists.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that only has that one book successfully removes first the book, and then the author from the database.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that has other books is interesting. The book and author are removed from the database, and also, any other books the author has are updated to have a null <code>author_id</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on any book executes SQL DELETE to remove just that book and doesn't affect any author or other books.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this combination because there's a surprising result when calling <code>destroy</code> on a book that belongs to an author that has other books. Not only does it remove that book and author, but also updates the author's other books, let's call them siblings to the deleted book, to have a null <code>author_id</code>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"10-belongs-to-destroy-has-many-restrict-with-exception\" style=\"position:relative;\"><a href=\"#10-belongs-to-destroy-has-many-restrict-with-exception\" aria-label=\"10 belongs to destroy has many restrict with exception permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10: Belongs to Destroy Has Many Restrict With Exception</h3>\n<p class=\"markdown-para\">In this case, the <code>destroy</code> option is specified on Book and <code>restrict_with_exception</code> on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, destroy will be called on its associated objects</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:restrict_with_exception</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># ActiveRecord::DeleteRestrictionError exception raised if there are any associated records</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 3], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (1.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.9ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 2], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Exists? (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.2ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with one or more books fails due to <code>ActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books</code>. This is the same behaviour observed in <a href=\"../activerecord-dependent-options/#5-has-many-restrict-with-exception\" class=\"markdown-link\">Scenario 5</a>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author with one or more books also fails, but with a <code>ActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed</code> error raised. Again, the same as <a href=\"../activerecord-dependent-options/#5-has-many-restrict-with-exception\" class=\"markdown-link\">Scenario 5</a>.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that only has that one book removes both the book and author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that has other books is interesting - it starts a SQL DELETE to remove the book, then goes up to the author to remove it as well (due to <code>dependent: :destroy</code> being specified on Book model), but then the <code>dependent: :restrict_with_exception</code> option on Author model kicks in and raises <code>ActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books</code>. Since all this activity is wrapped in a transaction, it gets rolled back and nothing is removed.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on any book executes SQL DELETE to remove just that book and doesn't affect any author or other books.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this combination as it results in a conflict between the child model Book saying when I'm deleted, delete my parent, and the parent model Author saying, do not delete me if I have children.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"11-belongs-to-delete\" style=\"position:relative;\"><a href=\"#11-belongs-to-delete\" aria-label=\"11 belongs to delete permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>11: Belongs to Delete</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and the Author model does not specify any dependent option:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.4ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Similar to <a href=\"../activerecord-dependent-options/#6-belongs-to-destroy\" class=\"markdown-link\">Scenario 6</a>, when no dependent options are specified on the Author/has_many side of the relationship, trying to either <code>destroy</code> or <code>delete</code> an author with one or more books fails with <code>ActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a Book that belongs to an Author that only has that one book destroys the book (i.e. callbacks and SQL DELETE), and also deletes the Author (i.e. SQL DELETE, no callbacks). This is the effect of the <code>delete</code> option specified on Book.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a Book that belongs to an Author that has other books as well first destroys the book, then attempts to SQL DELETE the author. This fails on a foreign key constraint, since the other books belonging to this Author are still in the database referencing it, and so the entire transaction is rolled back and nothing is removed.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book invokes SQL DELETE on just that book, no other models are affected.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this option as the results seem inconsistent with respect to removing child models (on the belongs_to side of the relationship). That is, if removing a book that belongs to an author that only has that one book, then both the child and parent models are removed (with the child model having its destroy callback invoked but the parent model does not). But if a child model belongs to a parent with other children, then nothing is removed.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"12-belongs-to-delete-has-many-destroy\" style=\"position:relative;\"><a href=\"#12-belongs-to-delete-has-many-destroy\" aria-label=\"12 belongs to delete has many destroy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>12: Belongs to Delete Has Many Destroy</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and <code>destroy</code> option is specified on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to also be destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Similar to <a href=\"../activerecord-dependent-options/#7-belongs-to-destroy-has-many-destroy\" class=\"markdown-link\">Scenario 7</a>, this seems like a situation that could lead to an infinite delete/destroy loop with each side of the relationship trying to remove the other. Let's see what happens:</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (1.8ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (6.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.3ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (2.6ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an Author with a single book invokes destroy callback on the book and removes it from the database, and then removes the author from the database. Interesting that according to the test log, the SQL DELETE statement to delete the author runs <em class=\"markdown-emphasis\">before</em> the author's <code>before_destroy</code> callback is invoked. This is different than in <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a> in which the <code>before_destroy</code> callback is invoked before the SQL DELETE.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an Author with multiple books, finds all books belonging to this Author, invokes the first book's callback, then executes SQL DELETE on the first book, then SQL DELETE on the author. At that point, it fails on a foreign key constraint because the author still has other books remaining that reference it. Normally the <code>dependent: :destroy</code> option on Author performs a cascading delete on all its Books but having <code>dependent: :delete</code> on the book prevents this.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an Author with one or more books fails on a foreign key constraint, because <code>delete</code> method does not attempt to remove any associated models, and it would be invalid to have a book model referencing an author that no longer exists.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a Book belonging to an Author that only has that one book successfully removes the book (first invoking its callback), then removes the author via SQL DELETE (no callbacks).</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a Book belonging to an Author that has other books fails on a foreign key constraint when attempting to SQL DELETE the author, because that would leave the other books referencing an author that no longer exists.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book works to remove just that book.</li>\n</ul>\n<p class=\"markdown-para\">I wouldn't use this combination of options as the desired cascading delete effect from an Author to its Books won't happen as expected. See <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a> for the expected cascade.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"13-belongs-to-delete-has-many-delete-all\" style=\"position:relative;\"><a href=\"#13-belongs-to-delete-has-many-delete-all\" aria-label=\"13 belongs to delete has many delete all permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>13: Belongs to Delete Has Many Delete All</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and <code>delete_all</code> option is specified on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete_all</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes all the associated objects to be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Again a potential loop of deletes in that when a book is removed, it should delete its author, but when an author is removed, it should delete all its books.</p>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (1.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Delete All (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 3\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.4ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (1.0ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.9ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (1.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with a single book first deletes the associated book, then invokes the author's callback, then deletes the author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with multiple books deletes all its associated books, then invokes the author's callback, then deletes the author.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author with one or more books attempts to delete just that author, then fails on a foreign key constraint because there still exist books that reference this author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that only has that one book invokes the book's callback, deletes the book, then finds the associated author and deletes that.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book belonging to an author that has other books fails on a foreign key constraint, at the point when attempting to delete the associated author, because there are still other books referencing this author.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book works to delete just that book.</li>\n</ul>\n<p class=\"markdown-para\">It looks like these options don't interfere with each other and behave the same as if only one was specified. But having <code>dependent: :delete</code> on the belongs_to side of the relationship is still problematic, as was explained in <a href=\"../activerecord-dependent-options/#11-belongs-to-delete\" class=\"markdown-link\">Scenario 11</a>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"14-belongs-to-delete-has-many-nullify\" style=\"position:relative;\"><a href=\"#14-belongs-to-delete-has-many-nullify\" aria-label=\"14 belongs to delete has many nullify permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>14: Belongs to Delete Has Many Nullify</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and <code>nullify</code> option is specified on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:nullify</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># causes the foreign key to be set to NULL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Just like in <a href=\"../activerecord-dependent-options/#4-has-many-nullify\" class=\"markdown-link\">Scenario 4</a>, in order to observe the effects of <code>nullify</code>, the <code>books</code> migration needs to allow a nullable reference to <code>author_id</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateBooks</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:books</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">date</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:published_at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Original column definition</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># t.references :author, null: false, foreign_key: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Modified column definition to support nullify option on Author model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">references</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:author</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.2ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 3]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 2]]\nAuthor model 2 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Update All (0.4ms)</span>  <span class=\"rails-log-yellow\">UPDATE \"books\" SET \"author_id\" = ? WHERE \"books\".\"author_id\" = ?</span>  [[\"author_id\", nil], [\"author_id\", 1]]\nAuthor model 1 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (1.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.1ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.7ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with one or more books first updates its associated book's <code>author_id</code> to nil, then invokes the author's callback and deletes the author. So no books are removed from the database, but the book records are updated to have a nil author_id.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author, whether it has 0, 1, or more books deletes the author from the database, and does <em class=\"markdown-emphasis\">not</em> attempt to remove or update the associated book records. This creates an orphan situation where book records are left in the database referencing an author that no longer exists.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that only has that one book invokes the book's callback and deletes it. Then it finds the associated author and deletes that as well.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author that has other books deletes both the book and author, leaving the author's other books as orphans, i.e. referencing an author that no longer exists. This is different behaviour than when nullify was used in <a href=\"../activerecord-dependent-options/#9-belongs-to-destroy-has-many-nullify\" class=\"markdown-link\">Scenario 9</a>, in which case the other books were updated to have a nil author_id.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book removes just that book.</li>\n</ul>\n<p class=\"markdown-para\">Most surprising: The nullify option on the has_many side of the relationship behaves differently depending on whether the belongs_to specifies dependent option destroy or delete.</p>\n<p class=\"markdown-para\">I wouldn't use this combination as there's some surprising results. Specifically calling <code>destroy</code> on a book will result in its sibling books being made orphans because their author_id will still be populated, pointing to an author that no longer exists. With the nullify option on the author, it's expected that some books will have a nil author_id, but not that author_id could be populated but invalid.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"15-belongs-to-delete-has-many-restrict-with-exception\" style=\"position:relative;\"><a href=\"#15-belongs-to-delete-has-many-restrict-with-exception\" aria-label=\"15 belongs to delete has many restrict with exception permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>15: Belongs to Delete Has Many Restrict With Exception</h3>\n<p class=\"markdown-para\">In this case, the <code>delete</code> option is specified on Book and <code>restrict_with_exception</code> option is specified on Author:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Book</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  belongs_to </span><span class=\"mtk4\">:author</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:delete</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># when the object is destroyed, all its associated objects will be deleted directly from the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Book model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Author</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:books</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:restrict_with_exception</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># ActiveRecord::DeleteRestrictionError exception raised if there are any associated records</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  before_destroy </span><span class=\"mtk4\">:one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">one_last_thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk9\">warn</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Author model </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> will be destroyed&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<details class=\"markdown-details\">\n<summary class=\"markdown-summary\">\nView test log\n</summary>\n<pre class=\"grvsc-container gatsby-highlight-monokai\" data-language>\n<code class=\"grvsc-code\">\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.4ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 3], [\"LIMIT\", 1]]\nAuthor model 3 will be destroyed\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#destroy! remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Exists? (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT 1 AS one FROM \"books\" WHERE \"books\".\"author_id\" = ? LIMIT ?</span>  [[\"author_id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.0ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with no books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"John Doe\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 3]]\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with a single book ===\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Julian James McKinnon\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (7.4ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Author#delete remove an author with multiple books ===\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"name\" = ? LIMIT ?</span>  [[\"name\", \"Andrew Park\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.8ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.5ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\nBook model 4 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\n<span class=\"rails-log-cyan\">Author Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 2], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.3ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 2]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">RELEASE SAVEPOINT active_record_1</span>\nNUMBER AUTHORS DELETED: 1; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#destroy! remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (2.3ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\nBook model 1 will be destroyed\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-magenta\">SAVEPOINT active_record_1</span>\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">Author Load (0.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"authors\".* FROM \"authors\" WHERE \"authors\".\"id\" = ? LIMIT ?</span>  [[\"id\", 1], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Author Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"authors\" WHERE \"authors\".\"id\" = ?</span>  [[\"id\", 1]]\n<span class=\"rails-log-cyan\">TRANSACTION (0.1ms)</span>  <span class=\"rails-log-red\">ROLLBACK TO SAVEPOINT active_record_1</span>\nActiveRecord::InvalidForeignKey - SQLite3::ConstraintException: FOREIGN KEY constraint failed\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 0\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that only has that book ===\n<span class=\"rails-log-cyan\">Book Load (0.2ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Computer Programming Crash Course: 7 Books in 1\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (0.5ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 4]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===</p>\n<p class=\"markdown-para\">=== BEGIN TEST Book#delete remove a book from author that has multiple books ===\n<span class=\"rails-log-cyan\">Book Load (1.1ms)</span>  <span class=\"rails-log-blue\">SELECT \"books\".* FROM \"books\" WHERE \"books\".\"title\" = ? LIMIT ?</span>  [[\"title\", \"Python Programming for Beginners\"], [\"LIMIT\", 1]]\n<span class=\"rails-log-cyan\">Book Destroy (1.2ms)</span>  <span class=\"rails-log-red\">DELETE FROM \"books\" WHERE \"books\".\"id\" = ?</span>  [[\"id\", 1]]\nNUMBER AUTHORS DELETED: 0; NUMBER BOOKS DELETED: 1\n=== END TEST ===\n</code>\n</pre></p>\n</details>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Test log summary</strong></p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on an author with no books removes it (callback + SQL DELETE). But for an author with one or more books, an error is raised: <code>ActiveRecord::DeleteRestrictionError - Cannot delete record because of dependent books</code>.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on an author with one or more books fails on a foreign key constraint.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author with just that one book removes the book (callback + SQL DELETE), then deletes the author.</li>\n<li class=\"markdown-list-item\">Calling <code>destroy</code> on a book that belongs to an author with other books fails to remove anything. This is because a foreign key constraint exception is raised when trying to delete the author, that would leave its other book records with invalid references.</li>\n<li class=\"markdown-list-item\">Calling <code>delete</code> on a book works and only removes that book.</li>\n</ul>\n<p class=\"markdown-para\">The combination of <code>dependent: :delete</code> on <code>belongs_to</code> and <code>dependent: :restrict_with_exception</code> on <code>has_many</code> behave the same as if each option was specified independently and the other side was not specified.</p>\n<h2 class=\"markdown-subtitle\" id=\"which-should-you-use\" style=\"position:relative;\"><a href=\"#which-should-you-use\" aria-label=\"which should you use permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Which Should You Use?</h2>\n<h3 class=\"markdown-sub-subtitle\" id=\"requirements\" style=\"position:relative;\"><a href=\"#requirements\" aria-label=\"requirements permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Requirements</h3>\n<p class=\"markdown-para\">The answer, as in nearly all things tech is... it depends. Firstly, it depends on the business and/or legal requirements of the application. Which models need to be removed? For example, should a customer be able to click a button to remove their account? If so, what should happen to all other models that may refer to this customer record? For an e-commerce or SaaS application, the customer's shipping addresses and payment methods should probably be removed which would be a good use case for <code>has_many :shipping_addresses, dependent: :destroy</code> option on the Customer model.</p>\n<p class=\"markdown-para\">But what about the customer's orders, would removing those affect reporting and financial systems? How about any product reviews the customer may have written? This might be a good use case for allowing nullable foreign keys and using <code>has_many: product_reviews, dependent: :nullify</code> if the review content is considered the company's content, not the customers. All these questions need to be answered.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"performance\" style=\"position:relative;\"><a href=\"#performance\" aria-label=\"performance permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Performance</h3>\n<p class=\"markdown-para\">Both <code>dependent: :destroy</code> and <code>dependent: :delete_all</code> on the has_many side will perform a cascade style delete. But the <code>:destroy</code> option will execute multiple SQL DELETE statements, one for each associated model to be removed because its callbacks are also being invoked. Whereas the <code>:delete_all</code> option will remove all associated models in a single SQL DELETE statement. If the parent model is expected to have a lot of children, using <code>:destroy</code> could be noticeably slower than <code>:delete_all</code>. If the callbacks absolutely have to be executed, consider the <code>:destroy_async</code> option.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"surprises\" style=\"position:relative;\"><a href=\"#surprises\" aria-label=\"surprises permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Surprises</h3>\n<p class=\"markdown-para\">Another factor to consider is the <a href=\"https://en.wikipedia.org/wiki/Principle_of_least_astonishment\" class=\"markdown-link\">principle of least surprise</a>. For example, the combination of <code>dependent: :destroy</code> on the belongs_to side and <code>dependent: :nullify</code> on the has_many side results in siblings having their foreign key references set to nil when one of them is destroyed. We saw this in <a href=\"activerecord-dependent-options/#9-belongs-to-destroy-has-many-nullify\" class=\"markdown-link\">Scenario 9</a> where having nullify on the has_many side causes the <code>belongs_to: :destroy</code> to go from a book, up to its author for removal, and then back to all the other books to nullify their author_id foreign keys.</p>\n<p class=\"markdown-para\">We also encountered surprising results in <a href=\"../activerecord-dependent-options/#8-belongs-to-destroy-has-many-delete-all\" class=\"markdown-link\">Scenario 8</a>, with the combination of <code>dependent: :destroy</code> on belongs_to and <code>dependent :delete_all</code> on has_many. In this case, removing a book that belongs to an author that has other books resulted in all of these books being removed. I would avoid combinations of options that produce surprising results.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"consistency\" style=\"position:relative;\"><a href=\"#consistency\" aria-label=\"consistency permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Consistency</h3>\n<p class=\"markdown-para\">Another thing to consider is consistency. It's one thing to allow nullable foreign keys, but in <a href=\"../activerecord-dependent-options/#14-belongs-to-delete-has-many-nullify\" class=\"markdown-link\">Scenario 14</a>, the combination of <code>dependent: :delete</code> on the belongs_to side, and <code>dependent: :nullify</code> on the has_many side can result in books referencing an author that no longer exists. That is, their foreign key is not null, but specifies an author_id that no longer exists. Although ActiveRecord can handle this by simply returning <code>nil</code> when referencing <code>book.author</code>, it could result in inconsistencies if using direct SQL statements for a reporting system.</p>\n<p class=\"markdown-para\">This inconsistency can also happen when using <code>dependent: :nullify</code> as we learned in <a href=\"../activerecord-dependent-options/#4-has-many-nullify\" class=\"markdown-link\">Scenario 4</a> when invoking the <code>delete</code> method on the model with the <code>has_many</code> rather than the <code>destroy</code> method.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"combinations\" style=\"position:relative;\"><a href=\"#combinations\" aria-label=\"combinations permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Combinations</h3>\n<p class=\"markdown-para\">Proceed with caution when <em class=\"markdown-emphasis\">combining</em> options. From this exercise, we've learned that the same option can behave differently depending on what option if any is specified on the other side of the relationship. For example, when <code>dependent: :destroy</code> is used on the has_many side by itself as in <a href=\"../activerecord-dependent-options/#2-has-many-destroy\" class=\"markdown-link\">Scenario 2</a>, an author with one or more books can be successfully destroyed and all its books are also destroyed. But when this option is combined with <code>dependent: :destroy</code> on the belongs_to side as in <a href=\"../activerecord-dependent-options/#7-belongs-to-destroy-has-many-destroy\" class=\"markdown-link\">Scenario 7</a>, then the destroy method on an Author with one or more books fails. Even stranger, when this option is combined with <code>dependent: :delete</code> on the belongs_to side as in <a href=\"../activerecord-dependent-options/#12-belongs-to-delete-has-many-destroy\" class=\"markdown-link\">Scenario 12</a>, then an Author with a single book can be destroyed, but its before_destroy callback gets invoked after the SQL DELETE statement to remove it. And trying to destroy an Author with multiple books fails.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"orphans\" style=\"position:relative;\"><a href=\"#orphans\" aria-label=\"orphans permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Orphans</h3>\n<p class=\"markdown-para\">Consider the advice in the Rails Guides, specifically the warning not to use <code>dependent: :destroy</code> on the <code>belongs_to</code> side of a one-to-many relationship due to possibility of orphan records. We tried this in a few scenarios, starting with <a href=\"../activerecord-dependent-options/#6-belongs-to-destroy\" class=\"markdown-link\">Scenario 6</a>. This case did not result in orphan records (as long as a nullable foreign key was not allowed) but trying to remove a book belonging to an author that had other books failed on a foreign key constraint. In this case ActiveRecord prevents orphan records, but will result in more complex code that needs to handle some entities can be removed and some cannot due to how many other entities their parent has. Scenarios <a href=\"../activerecord-dependent-options/#7-belongs-to-destroy-has-many-destroy\" class=\"markdown-link\">7</a>, <a href=\"../activerecord-dependent-options/#8-belongs-to-destroy-has-many-delete-all\" class=\"markdown-link\">8</a>, <a href=\"../activerecord-dependent-options/#9-belongs-to-destroy-has-many-nullify\" class=\"markdown-link\">9</a>, and <a href=\"../activerecord-dependent-options/#10-belongs-to-destroy-has-many-restrict-with-exception\" class=\"markdown-link\">10</a> are other variations on using <code>dependent: :destroy</code> on the <code>belongs_to</code> side and all had some problems or possibly unintended consequences.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"removal-method\" style=\"position:relative;\"><a href=\"#removal-method\" aria-label=\"removal method permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Removal Method</h3>\n<p class=\"markdown-para\">A final thing to be aware of is when using any of the dependent options to affect related entities: This behaviour only kicks in when invoking the <code>destroy</code> or <code>destroy!</code> methods on the model instance. The <code>delete</code> method only invokes direct SQL on the model on which it is called and does not attempt to affect any of its associations.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has used <a href=\"https://github.com/danielabar/learn-associations\" class=\"markdown-link\">exploratory tests</a> to understand how ActiveRecord dependent options function in a one to many relationship to remove (or fail to remove) records from the database when used only on one, or both sides of the relationship. It has also explored differences in the <code>delete</code> vs <code>destroy</code> methods. It then covered some factors to consider in choosing which dependent option(s) to use.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/activerecord-dependent-options/"}}},{"node":{"id":"7a565b39-3dd4-5740-82a2-867e3565078c","frontmatter":{"title":"Old Ruby and New Mac","date":"June 2023","category":"rails"},"excerpt":"Picture this scenario - you're a Rails developer that just got one of the new M1 or M2 Macs and are enjoying the performance boost andâ€¦","html":"<p class=\"markdown-para\">Picture this scenario - you're a Rails developer that just got one of the new M1 or M2 Macs and are enjoying the performance boost and energy efficiency that comes from the ARM-based architecture. You've installed and configured all your dev tooling (oh-my-zsh, homebrew, rbenv, etc.) and are ready to get to work. Everything is great.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 97.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAFLElEQVR42iXReVPTBwLG8d/fnWkRNHfCWSAIigEliUlMQu4ECCHIYQhBAhEjIiUi2iq1q0Bb6oKoCIhmC17gUa1YsVXbIr1Hp9vtPa09pp3OdKYzO/sGvjvaN/CZ7zyPIFZkIJFnIJKlI5IqEUuVSOXpyOQZpKSu4qmnU0hJFSGWKFiRJuaZlDQUcgVVnipC/lqOJvqIBoPI05VI5CoEiSITqSITkVT1BJPIVE/glDQRLpefjtgu/N5qCvLUlBvNxDsSnEte5+sHv/HVx7/w4cLn3Dk1j2lDCamrpH+DMmUWElk6Ulk64sewTMW+3kO8e+sb/v3xnzxc+oH3F5Z5+MEj/vPgv3y2/Bf3bv/C4o0fOTVyjZFdvRg0JaSulCFIlZko03NQKLOQPy6VKMjIVjOYeIF4QzPx6B5eO/Qv7i4+4u7t31m6+ye3Fx6x+OZPLN74lfmpW0z09lKyuoiVIjnCSqkKkViOXJaOUpmFTJHB0ytW4bXY6G4IUm/R0xnezty5hyTH32Z06BzzM+9z9JU5xl6e485bP/PRpQU2FBSQ9hh0VFRS17AFq81B6ioJIqmciopKlJnZeModHI53cHJoiisXP2dHaButm1u4c/UTRl46TjzUzuzJm5wdv4BK+ff+gre2mnv3lzg8/Ar7D/azq6eb8cmT5K9ZjUguQ5WRwdDAeRaufMnp4UlODYzxYtdBRvoGmOofIHn8DZJHTqFWP4tUpUIoNG7g1ROjTJ5NMnf1EqdnkkTjbRSVFaPIUyHOFLNv3zGmxi7T3biZnaEIuVlq6j3VRH0ejiT2MPrCbtJUInLyMxHkRXkUGsvQ2I2Uesw4a/3klxSRvTYXWZ6K/FI1w8MTDB54Ffv6AjTPZlOYk48mJ5fKsmIujp3h0uwVstQZ5OQrEdLXqVGsyUVWlINYk4usOAdJQRY5hblIs6V0P5fguy/+x4XZZXY2R/Dp9FjWGfFqjexr72B0cJr7t7+nLdrCCnkqwvoaExs3WzDV2dAGLRjqLWhrDegDFsyuMqanXufT5T+YO/+A4YFx4k0RHFoLfmcFvTt62f/ci09enzw2SX5xNoKuwYQlXI4pbMXcZMO+1Y1nexWb2pz42/zcnH+Hq/Ofcja5zImxyyTi3VTb3LTUhemL97J3+x4mRuZZvH6fYL0Dwd3uZXNnDe6YF0uLDUerg6bdTVTEqzBGrCQnZpgcX2Bs5DKvT7/D6MvTHNo7SH/PARKxHhIdfZwcucjDpW9pj4cQquLV+Lb5cLQ5sbc5sUbLcbQ7sEUd6Jv1vHRsgqHBWQYGT3N+ZpmZ6fcYfW2OraE2NpbpaAhs4dCB49y5vkRTewChriuIO2rH02rF1WrFEy3H2GzAGrHgarXQ1d9DYs8wnZ39XJ3/gtnkB5wYu8H22PMoFSIC1SGOj17h2tw9Dg88jxCI+QjtqsEd3UTNNheReAWurQaqY2asTaXUd/rZ/48TuD1BBg6e4djIdUb/+QYXZj8h3t5HrKGBlpadNPqbOLh7J0Jjq4fYjiCBqAdXxE5N2IKrTo+rcSPesBl32MrQ8Bmc3iBOi5O9PUMcPXKNcF2cUCBEoMpAqS4Pq0GD3rAawdxopD7mo7bdh6vFhaPJgitspqrVhafZga6mlLauLjaaygk1tBIJRvA5PGgKstFp89Ga1rJpUwkmcwkGYwmCpkaHsd6AdYuVskAZ67ylaDzrWesuRW1dg9qkRuPUUmTQYvMGqHRasduKqfTp0RmL0OoL0esLsZevp8Ku4//pQhunNTWbUAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"happy dog yay\"\n        title=\"happy dog yay\"\n        src=\"/static/fbbe9341fa6e7f64a1d29dbf2f0dae62/0b533/happy-dog-yay-cropped.png\"\n        srcset=\"/static/fbbe9341fa6e7f64a1d29dbf2f0dae62/772e8/happy-dog-yay-cropped.png 200w,\n/static/fbbe9341fa6e7f64a1d29dbf2f0dae62/e17e5/happy-dog-yay-cropped.png 400w,\n/static/fbbe9341fa6e7f64a1d29dbf2f0dae62/0b533/happy-dog-yay-cropped.png 500w\"\n        sizes=\"(max-width: 500px) 100vw, 500px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Then you receive your next assignment, which is to perform some maintenance on an old Rails 4 project using Ruby 2.3.x (yes they still exist). So you get started by installing Ruby 2.3.3 and encounter the following error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ rbenv install 2.3.3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">To follow progress, use &#39;tail -f /var/folders/t7/6n5394/T/ruby-build.20230501063921.137.log&#39; or pass --verbose</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Downloading openssl-1.0.2u.tar.gz...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-&gt; https://dqw8nmjcqpjn7.cloudfront.net/ecd0c6ffb493dd06707d38b...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Installing openssl-1.0.2u...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BUILD FAILED (macOS 13.3.1 using ruby-build 20230330)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Inspect or clean up the working tree at /var/folders/t7/6n5394/T/ruby-build.20230501063921.137.TS6</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Results logged to /var/folders/t7/6n5394/T/ruby-build.20230501063921.137.log</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Last 10 log lines:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _dgram_write in libcrypto.a(bss_dgram.o)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _RAND_query_egd_bytes in libcrypto.a(rand_egd.o)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ld: symbol(s) not found for architecture i386</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make[4]: *** [link_a.darwin] Error 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make[3]: *** [do_darwin-shared] Error 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make[2]: *** [libcrypto.1.0.0.dylib] Error 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make[1]: *** [shared] Error 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">make: *** [build_crypto] Error 1</span></span></code></pre>\n<p class=\"markdown-para\">That feeling...</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 143.49999999999997%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAHEUlEQVR42m2SiVPTZx7G84/stDM7bXftdtddO45jt93RqUer67GuSoUqVAQvFFRUROQQkVtUTrmCJHIlEEhIIASSgIggVYEalFMFETyQHL8cRPzs5OfouuO+M8+877zzvp/3+33eR3J32k7fjJ2BZw4Gns7ROzZF99BjzHctDE69ZMLqZnLWwUvBy5Pnr7AMjWF3eZmzCdjtLhwOn5wIDheC4EJieebA8szO6JyHG/dGSb5wmZxiKRHHjmPuuctTm5sZq5PxJzMMWIbIv1KEw+nBanNitwlvYcJbmFNwIxl+4WDkhYMJ2zy9g2OkX8ymVF7JkcjjHAqPoMXYwfjkNAmJ57hWWUPYocPk5OThdHrwehfweLzvYU6HC8nDWYFHswJTVhdjT18QfSaO2IREUtLSybqUTY1SRd+AhZTUdNLSMsjMvEBeXj63bvUyNvaQR48mcLvmRZjL1/LkK4Epn2Yd2DxvqKhWUlQipefXu5jM1+kfsDA3Z6ewsIiOjk5MpnZu3uxGo2lErW6k68ZNvJ7XCHYnLl/LM3MCz60CL61OZq0CDvdrXJ4F7A43Ttc8nvnXOF0eXi8gyuVbe9+IWvC+EWFvq3O/Bc7aBGZtTl7ZnFjtLtFsq9WO4PSIILvVxuyzGawvXzAzPoIgzOMUPAh2QQR9CBOBc3YnNrtLlN0XAbsTzwLMPBymNj+D6txMHt02Y2nXUnIqlNF2FYLNjtvlFT37ECYC7e9ADqcot3seS283qSFbCVm9nNB/bWKos4VX4xakSafoLDjJqK4A6/PneNzej4HvMuSwC3hfQ393F35Lv2TfD//Af8UyNIXZXDoTRUFKEtdVcnqKoxhTpTLRo8Mzz/9U6XZ6kIj5EdwINgHf0NUqCfhmMYc3rGT1X/5AeUosp3b7s2LxIu7f6sTSrqOv7DRP+4x4PG/eA30wsUKnb8Nnrs87t5fpqWlO+q1n1Re/I3T7FhIPBnF0y0oSdq5msEvPAjD3/AVOx38hH7Xsg777Mbfby53e2+hrFdzttxCyYR3Htv5A4eEgjPn52Gdt/9e790Cn043rA7kFt5gx3xi5P8TpXQGkHj2ONCqS3zR1CHYX8758ujzMu70fSTI+NsH4+CSjo48ZGX/C0Ogk9+4/ZPjhNIZaJZfCf0FXdoUHN3RYJ+4xOfWc/uFJLGNTWEYmuTf0GMvwYx6MTop3JW36Dgx6M63NJsxtnRgN7RiaTZgM7dTnX6QgMgRl/mXuamSMGBU8GRtBr9Fh8KlBQ0uDBn29hpZ6Na0aLRJdjRJjg5rW+gaalSrafLNCQUtdPQ0FWZQdD6SutJTBNhV9NVm8mp6itUFNk0KJ726Lql48a1A10KbWIKmXydBV16C8KkNZUkzjNTnaqkpM2mZ0xdnIYg9hUNTwuK+Lblk60w/ucO9OH61qLTfazHSZOuhu76Sn44YoiVGtEV9rVihpqZZj1jTQZWynVd1I7tFfyD0SiE4m5X67luYLxxhoKmf0/jCdBiPdpg60ChUGTRMmvQmz3ohEr6jGrG3ielOLOPse6DSYMKobiQ/cREbYzzTJpPxm1mLMjeLX+mI6WlpF/6pLy1DJr6FV1FFfqRB9lehVGhqqajFp9TTWqGiqUdCm0dFUXcOZgPXEB29DVymn16BBeTaEQW0JveY2aqVl1F4tRyEtw6hWoyy7Sn1FNRJ5YRmVRSU0lpeglpWLBzVyGZrKKuJ3/ZPtyz7ndGgAqeG7ObF+Cf3KTAa7TVQU5NEgk1F6MQultBSTTo+sqBSJ8uo1ZDk5SNPOUp55nsLzcZSmJ1GWkURswDoiN/+d5Yu+YOPSv5Ea9CO3ZfF0N6uolsooz82jsqgIZXEhann521/WVVWhKLrC1cxk8s7FcSkhlqy4GNJPHCZiw7ck/ryWjcuX8ePXX1N2chcDNcloKipRXK3AUKeiVVWHtvIadaVF1BTmIynMyECaU0BuagbxUTEcD4tgh99Oog+EEr5pBeFr/8qXn/2eP376KemBq+ivu0xeYgxtDfX03bxJp74F6cUsspMSyU0+jyTu5GniIk+QFhtP8K49fL92C3t37hJhft8tITt0PV8t+pzPPvmE3CP+PDTKyY0JozDxFH0dJvq6e2isURIdcYTDwcFIUs+mkpqURWx0EvsOxhC4J5JNK75l5ZKvOBe0AXPaXtZ+t5Rlf/4TjSnhFCYeJeXYPmL3B1GRc4Fes4mB7ltUl1dw5GA4kujIaKKjkwkMiWKL/yE2bQ/l+zWb8d+6jegdaygIXsGONd+waulimuP86FNmEhdxgKiw/eQmnqG5Uo6+ugpVebmYR0lwwE6OhkWy+2ACG38KY/O/g9i2dSe7/fw4tecnzuzewp6t6zgUuJ1LEf7Ik8NJPbaX3LhIshNOkRFzgsgD+9gfGEh0eDj/AbCjFLrsoxOaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"uh oh dog\"\n        title=\"uh oh dog\"\n        src=\"/static/b64588996932e507183b781ea3c61c6d/e17e5/uh-oh-dog-text.png\"\n        srcset=\"/static/b64588996932e507183b781ea3c61c6d/772e8/uh-oh-dog-text.png 200w,\n/static/b64588996932e507183b781ea3c61c6d/e17e5/uh-oh-dog-text.png 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">The issue here is with OpenSSL linking against the i386 architecture, which is not compatible with the new Mac's ARM-based architecture, and so the build fails. There are some <a href=\"https://stackoverflow.com/questions/69012676/install-older-ruby-versions-on-a-m1-macbook\" class=\"markdown-link\">suggestions</a> related to uninstalling OpenSSL and re-installing with alternate compile flags. You can also attempt to uninstall all the dev tooling, setup for <a href=\"https://apple.stackexchange.com/questions/409746/run-everything-in-rosetta-2-on-silicon-mac\" class=\"markdown-link\">rosetta all the things</a>, then re-install.</p>\n<p class=\"markdown-para\">I tried a variety of these and was still getting errors. Keep in mind its not just Ruby that needs to be installed, its also all the older gems, some of which require native extensions and will run into compilation issues. I was also concerned that it would cause problems when switching to other projects that use newer Ruby versions (3.x and above are compiled for the newer Macs), as I frequently toggle between different projects. In this post I'll share an alternative solution using <a href=\"https://www.docker.com/\" class=\"markdown-link\">Docker</a> that I found easier to get working.</p>\n<p class=\"markdown-para\">The idea is to build a Docker image that comes with the older Ruby version needed for this project, mount the project code into this image, and install the project dependencies as part of the image. Then a container can be run from this image, and all the usual Rails commands such as starting a server, console, etc. can be run inside the container.</p>\n<aside class=\"markdown-aside\">\nThis post assumes familiarity with Docker concepts including images, containers, and use of Docker Compose to manage multi-container applications. If you need a refresher on Docker fundamentals, check out the <a class=\"markdown-link\" href=\"https://docs.docker.com/get-started/\">Getting Started</a> guide and <a class=\"markdown-link\" href=\"https://docs.docker.com/get-started/resources/\">Educational Resources</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"docker-image\" style=\"position:relative;\"><a href=\"#docker-image\" aria-label=\"docker image permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Image</h2>\n<p class=\"markdown-para\">The first thing that's needed is to build the Docker image. When doing so, we need to select a base image from which to get started. I'm using a <a href=\"https://hub.docker.com/r/circleci/ruby\" class=\"markdown-link\">CircleCI Ruby image</a> as it comes with common dev tooling and a non-root user named <code>circleci</code>. Here is the Dockerfile that uses the Ruby 2.3.3.</p>\n<p class=\"markdown-para\">To use it, place the following file named <code>Dockerfile</code> in the root of your project. Replace <code>2.3.3</code> with your Ruby version, and <code>myapp</code> with your app name:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"dockerfile\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> circleci/ruby:2.3.3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Set path to the app as an environment variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># so it can be referenced again in this file as `$app`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ENV</span><span class=\"mtk1\"> app /usr/share/myapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a directory for our app.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> sudo mkdir -p $app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Make the `circleci` user owner of our app dir.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> sudo chown circleci $app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Give `circleci` owner read/write/execute on app dir</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># and all dirs/files within it, and read/execute for other users.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> sudo chmod -R 0755 $app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Set the working directory to our app dir.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WORKDIR</span><span class=\"mtk1\"> $app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Copy files/dirs from build context to the current working directory in container,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># and sets the user/group ownership of copied files/dirs to circleci:circleci.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">COPY</span><span class=\"mtk1\"> --chown=circleci:circleci . .</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace with bundler version used by your old app.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> gem install bundler:1.17.3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install app dependencies</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle install</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe CMD instruction in the base Circle CI image is: CMD [\"bin/bash\"]. This means that when you run a container from this image, the container will start with a Bash shell prompt. We'll be making use of this to run all our Rails commands soon. You can see the full definition <a class=\"markdown-link\" href=\"https://hub.docker.com/layers/circleci/ruby/2.3.3/images/sha256-d4ee971ae3f1c1eac1301c79e7d1a9b994b2d8b0f0ed899ffa4f7f11dd21d1ff?context=explore\">here</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"docker-compose\" style=\"position:relative;\"><a href=\"#docker-compose\" aria-label=\"docker compose permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Compose</h2>\n<p class=\"markdown-para\">Add the following <code>docker-compose.yml</code> file to the root of the project. This will make it easy to run a container from the <code>Dockerfile</code> created in the previous step:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.9&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">myapp</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Use Dockerfile from current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Mount the current directory `.` into container at `/user/share/myapp`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/usr/share/myapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Map port 3000 on the container to 3000 on the host</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Allow container to respond to Ctrl+C and to view container&#39;s output in real-time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">tty</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span></span></span></code></pre>\n<p class=\"markdown-para\">To build the image, run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose build</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"docker-container\" style=\"position:relative;\"><a href=\"#docker-container\" aria-label=\"docker container permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Container</h2>\n<p class=\"markdown-para\">To run a container from the image, run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose up</span></span></code></pre>\n<p class=\"markdown-para\">This will run the container in the foreground, which attaches the terminal to the logs of the containers so that you can see its output. But then you can't use that terminal session for anything else, and have to open a new terminal tab to do other things.</p>\n<p class=\"markdown-para\">Alternatively, you can run the container in the background (aka detached mode), and the output will not be displayed in the terminal:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose up -d</span></span></code></pre>\n<p class=\"markdown-para\">If you run it in the background, you can always view the logs with the command below which will follow the logs in real time:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose logs -f</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"rails-server\" style=\"position:relative;\"><a href=\"#rails-server\" aria-label=\"rails server permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rails Server</h2>\n<p class=\"markdown-para\">Now that you have a running container, it's time to start a Rails server. To do this, first run a shell in the container, using <code>exec</code> which is used to execute a command inside a running container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash</span></span></code></pre>\n<p class=\"markdown-para\">Then from the shell prompt in the container, start the Rails server:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">pwd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Should be /usr/share/myapp because of WORKDIR setting in Dockerfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ls</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Should see contents of myapp such as models, views, controllers, lib, etc.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Start Rails server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Server should be listening on port 3000</span></span></span></code></pre>\n<p class=\"markdown-para\">At this point, you should be able to navigate to <code>http://localhost:3000</code> in a browser and view your app's home page.</p>\n<p class=\"markdown-para\">Note that if you shutdown your computer which will stop the container, or use <code>docker-compose stop</code> to stop the container, the Rails server process that's running in the container may not shut down cleanly because it's not running as PID 1 in the container. That means if you shell in again to run a Rails server, you may get the <a href=\"https://testsuite.io/a-server-is-already-running-pids\" class=\"markdown-link\">server is already running</a> error. We'll deal with this shortly.</p>\n<h2 class=\"markdown-subtitle\" id=\"other-commands\" style=\"position:relative;\"><a href=\"#other-commands\" aria-label=\"other commands permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other Commands</h2>\n<p class=\"markdown-para\">To run any other commands in the container such as database migrations or a Rails console, open a new terminal tab, shell into the container (you can have multiple shells) and run your command. For example, to run database migrations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rake db:migrate</span></span></code></pre>\n<p class=\"markdown-para\">To run a Rails console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rails console</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"combining-commands\" style=\"position:relative;\"><a href=\"#combining-commands\" aria-label=\"combining commands permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Combining Commands</h2>\n<p class=\"markdown-para\">One thing you may have noticed about running Rails dockerized is there's more typing to get things running. For example, to run a Rails console, requires three commands:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 1. Start container</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 2. Shell into container</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> myapp bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 3. Run Rails console from container shell</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails console</span></span></span></code></pre>\n<p class=\"markdown-para\">The last two can be combined as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp rails console</span></span></code></pre>\n<p class=\"markdown-para\">Starting a Rails server requires a little more effort to get it into one step, the following may not work:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp rails server</span></span></code></pre>\n<p class=\"markdown-para\">This is because if the <code>./tmp/server.pid</code> file still exists from last time you ran a Rails server in the container, you'll get a <code>server is already running</code> error. To solve this, let's introduce a script that first removes this file, then runs the Rails server, then use docker-compose to execute this script.</p>\n<p class=\"markdown-para\">Place the following in <code>scripts/run_dev.sh</code> (I'm assuming you have a directory <code>scripts</code> in the root of your project, if not, create it):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /usr/share/myapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rm -f ./tmp/pids/server.pid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails server</span></span></span></code></pre>\n<p class=\"markdown-para\">Make it executable with <code>chmod +x scripts/run_dev.sh</code>. Now you can start a Rails server by passing the <code>-c</code> flag to the <code>bash</code> command, which tells it to execute the script in the container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash -c &quot;./scripts/run_dev.sh&quot;</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"even-less-typing\" style=\"position:relative;\"><a href=\"#even-less-typing\" aria-label=\"even less typing permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Even Less Typing</h2>\n<p class=\"markdown-para\">Combining commands with <code>exec</code> and <code>-c</code> flag saves some typing, but we can do even better. Let's introduce a <a href=\"https://opensource.com/article/18/8/what-how-makefile\" class=\"markdown-link\">Makefile</a> into the project. A Makefile is a text file containing a set of instructions (rules) that specify how to build the project. The rules specify the dependencies and the commands needed to build or update them. Traditionally used for C/C++ projects, a Makefile can also make life more convenient by reducing the amount of typing needed to run commonly used commands on any project.</p>\n<p class=\"markdown-para\">For example, in the previous section, we saw that to run a Rails server within the Docker container required:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose exec myapp bash -c &quot;./scripts/run_dev.sh&quot;</span></span></code></pre>\n<p class=\"markdown-para\">If you were to add the following <code>Makefile</code> in the project root:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"makefile\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">server</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp bash -c &quot;./run_dev.sh&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Then you could run this at the terminal to start the Rails server:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">make server</span></span></code></pre>\n<p class=\"markdown-para\">There's still a problem though, if you don't remember to first start the container, running <code>make server</code> will result in an error like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">service &quot;myapp&quot; is not running container #1</span></span></code></pre>\n<p class=\"markdown-para\">This can be solved with task dependencies. We can add a <code>start</code> task that will check if the container isn't already running, then start it, and then have the <code>server</code> task depend on the <code>start</code> task:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"makefile\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Start the container if it isn&#39;t already running</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">start</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ./scripts/start_dev_container.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run the `start` task before the `server` task</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">server</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp bash -c &quot;./run_dev.sh&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Where the <code>start_dev_container.sh</code> script attempts to run an echo statement in the container, and then inspects the return code. If the container is not started, this would error and the return code will be non-zero. If we get a non-zero return code, then we start the container in the background. Place the following in the <code>scripts</code> directory of your project and run <code>chmod +x scripts/start_dev_container.sh</code> to make it executable:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> myapp </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;dev container is running&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ret=$?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[[ $ret </span><span class=\"mtk7\">-ne</span><span class=\"mtk1\"> 0 ]] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> docker-compose up -d</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">exit</span><span class=\"mtk1\"> 0</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nMakefiles are primarily designed to work on *nix operating systems like Linux and macOS, which have a Unix-like shell environment that supports the make command. However, if you're using Windows, you can still use Makefiles by installing the <a class=\"markdown-link\" href=\"https://learn.microsoft.com/en-us/windows/wsl/install\">Windows Subsystem for Linux</a>, which allows you to run a Linux environment directly on top of Windows.\n</aside>\n<p class=\"markdown-para\">You can add the most common Rails commands to the Makefile, making each dependent on the <code>start</code> task. Here's what I use, feel free to add more as per your projects needs:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"makefile\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Start the dev container if it&#39;s not already running.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">start</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ./scripts/start_dev_container.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Stop the dev container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">stop</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose stop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Display dev container status.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">status</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose ps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Start a Rails server.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">server</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp bash -c &quot;./run_dev.sh&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Launch a shell in container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">shell</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Launch a Rails console.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">console</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp rails c</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Migrate database.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">migrate_db</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">docker-compose</span><span class=\"mtk1\"> </span><span class=\"mtk5\">exec</span><span class=\"mtk1\"> </span><span class=\"mtk5\">myapp</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rake</span><span class=\"mtk1\"> </span><span class=\"mtk5\">db</span><span class=\"mtk1\">:migrate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Rollback database.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">rollback_db</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">docker-compose</span><span class=\"mtk1\"> </span><span class=\"mtk5\">exec</span><span class=\"mtk1\"> </span><span class=\"mtk5\">myapp</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rake</span><span class=\"mtk1\"> </span><span class=\"mtk5\">db</span><span class=\"mtk1\">:rollback</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Drop db, create db, load schema, custom seeds.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">reset_db</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">docker-compose</span><span class=\"mtk1\"> </span><span class=\"mtk5\">exec</span><span class=\"mtk1\"> </span><span class=\"mtk5\">myapp</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rake</span><span class=\"mtk1\"> </span><span class=\"mtk5\">db</span><span class=\"mtk1\">:reset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run all the RSpec tests: make test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># To run a specific test: SPECS=&quot;path/to/the_spec.rb&quot; make test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">test</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp rspec </span><span class=\"mtk10\">$$</span><span class=\"mtk1\">SPECS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run the linter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">rubocop</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp rubocop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Display all available routes.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">routes</span><span class=\"mtk1\">: start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  docker-compose exec myapp rake routes</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"drawbacks\" style=\"position:relative;\"><a href=\"#drawbacks\" aria-label=\"drawbacks permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Drawbacks</h2>\n<p class=\"markdown-para\">There are some drawbacks with this approach. There's some increased complexity in having to learn new tooling for those not already familiar with Docker and docker-compose. Also the commands are slower to run within the container as compared to running directly on the laptop.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered how to use Docker and docker-compose to run an old Ruby on Rails project that doesn't easily install on the newer ARM-based Macs. We've learned how to build an image, run a container from this image, and use <code>exec</code> to run commands in the container. Finally we covered how to use a Makefile with dependencies to save on some typing of lengthy commands.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/old-ruby-new-mac/"}}}]}},"pageContext":{}},"staticQueryHashes":["163244226"],"slicesMap":{}}