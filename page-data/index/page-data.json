{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":69,"edges":[{"node":{"id":"a103f88f-4941-5f40-8adc-948b6eba5d2c","frontmatter":{"title":"A Tale of Rails, ChatGPT, and Scopes","date":"January 2024","category":"rails"},"excerpt":"Today I'd like to share a cautionary tale about using ChatGPT to improve some Rails model querying code, and how the Rails Guides and API…","html":"<p class=\"markdown-para\">Today I'd like to share a cautionary tale about using ChatGPT to improve some Rails model querying code, and how the Rails Guides and API docs turned out to be a better resource in this case.</p>\n<h2 class=\"markdown-subtitle\" id=\"the-problem\" style=\"position:relative;\"><a href=\"#the-problem\" aria-label=\"the problem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Problem</h2>\n<p class=\"markdown-para\">I'm working on a Rails application to handle agile retrospective meetings for teams. The Retrospective model has an enum to indicate whether the retrospective is open or closed. There can only be one open retrospective at a time, which is represented with a custom validation rule. Here is the model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: retrospectives</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :bigint           not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  status     :enum             default(&quot;open&quot;), not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  title      :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Indexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  index_retrospectives_on_title  (title) UNIQUE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  has_many </span><span class=\"mtk4\">:comments</span><span class=\"mtk1\">, </span><span class=\"mtk4\">dependent:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:destroy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">open:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">closed:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:status</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:only_one_open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">only_one_open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> open? </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">exists?</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors.</span><span class=\"mtk5\">add</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:status</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;There can only be one open retrospective at a time.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Throughout the application, I frequently need to access the one and only open retrospective. After some time, I noticed this code appeared multiple times throughout the services layer:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">])</span></span></span></code></pre>\n<p class=\"markdown-para\">In the future, the logic to find the retrospective could change, for example, if the application is enhanced for multi-tenancy. To avoid code duplication, and having the services be dependent on these details of the retrospective model, I decided to refactor by adding a class method <code>find_open</code> on the model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">open:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">closed:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.find_open</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Then all the services that need access to the open retrospective can simply call the <code>find_open</code> method on the model class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/services/some_service.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SomeService</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retro </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_open</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with retro...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"ask-chatgpt\" style=\"position:relative;\"><a href=\"#ask-chatgpt\" aria-label=\"ask chatgpt permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ask ChatGPT</h2>\n<p class=\"markdown-para\">The <code>find_open</code> model method worked, but I had a feeling there might be a more \"Rails-ey way\" of doing things. So I gave the model code to ChatGPT and asked if there was a more idiomatic Rails solution to deal with the code duplication. ChatGPT said that using Rails scopes would be better for query re-usability. Here's what it came up with:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">open:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">closed:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:open_retrospective</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> { </span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> statuses[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Looks reasonable? Let's try this out in a Rails console. I started from an empty database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create an open retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">retro1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;My Project Sprint 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Also create a closed retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">retro2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;My Project Sprint 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">statuses</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:closed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Use the scope suggested by ChatGPT to find the open retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SELECT &quot;retrospectives&quot;.*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># FROM &quot;retrospectives&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># WHERE &quot;retrospectives&quot;.&quot;status&quot; = $1 LIMIT $2  [[&quot;status&quot;, &quot;open&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># &lt;Retrospective:0x00000001140fa018</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   id: 22,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   title: &quot;My Project Sprint 2&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   status: &quot;open&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   created_at: ..., updated_at: ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result.</span><span class=\"mtk5\">class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; Retrospective(id: integer, title: string, created_at: datetime, updated_at: datetime, status: enum)</span></span></span></code></pre>\n<p class=\"markdown-para\">When the scope is invoked, the Rails console output shows a SQL SELECT running to find retrospectives where the status is <code>open</code>. Then the scope returns the model titled \"My Project Sprint 2\", which is the only open retrospective in the database. So far so good.</p>\n<p class=\"markdown-para\">However, what will the scope return when there are no open retrospectives? I was expecting a <code>nil</code> return, but here's what actually happened:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Close the currently open retrospective with the enum-generated method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">retro1.</span><span class=\"mtk5\">closed!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Use the scope suggested by ChatGPT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === RUNS THIS QUERY, THE SAME AS BEFORE,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === BUT IT DOES NOT RETURN ANY RESULTS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SELECT &quot;retrospectives&quot;.*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># FROM &quot;retrospectives&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># WHERE &quot;retrospectives&quot;.&quot;status&quot; = $1 LIMIT $2  [[&quot;status&quot;, &quot;open&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># === THEN RUNS ANOTHER QUERY TO FETCH ALL RETROSPECTIVES!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># SELECT &quot;retrospectives&quot;.* FROM &quot;retrospectives&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &lt;Retrospective:0x00000001140fa018</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     id: 23,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     title: &quot;My Project Sprint 1&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     status: &quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     created_at: ..., updated_at: ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &lt;Retrospective:0x00000001140fa018</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     id: 22,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     title: &quot;My Project Sprint 2&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     status: &quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     created_at: ..., updated_at: ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result.</span><span class=\"mtk5\">class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; Retrospective::ActiveRecord_Relation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result.</span><span class=\"mtk5\">size</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; 2</span></span></span></code></pre>\n<p class=\"markdown-para\">This time, the results are unexpected. When the scope is invoked, the Rails console output shows its running the same SQL SELECT as before to find an open retrospective. However, in this case, none are found. Then the Rails console output shows that the scope proceeds to run a second query that fetches <em class=\"markdown-emphasis\">all</em> retrospectives from the database, regardless of status.</p>\n<p class=\"markdown-para\">In this case, the return result from the scope is an <a href=\"https://api.rubyonrails.org/v7.1.2/classes/ActiveRecord/Relation.html\" class=\"markdown-link\">ActiveRecord::Relation</a> representing a query that returns <em class=\"markdown-emphasis\">all</em> the retrospectives (there are just 2 in this simple example).</p>\n<p class=\"markdown-para\">Not only was I not getting <code>nil</code> as expected, but this could cause a performance problem as the application grows and there are large numbers of records in the <code>retrospectives</code> table.</p>\n<p class=\"markdown-para\">I explained the situation to ChatGPT and it did that thing where it apologizes, then provides the same solution again that doesn't fix the problem. (I encountered a similar issue awhile back trying to find the syntax for a <a href=\"../gatsby5-distinct-query#ai-to-the-rescue\" class=\"markdown-link\">distinct GraphQL query</a>)</p>\n<h2 class=\"markdown-subtitle\" id=\"ask-the-docs\" style=\"position:relative;\"><a href=\"#ask-the-docs\" aria-label=\"ask the docs permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ask the Docs</h2>\n<p class=\"markdown-para\">When AI doesn't provide the solution, it's good to lean on skills we engineers developed before the existence of such tools. Read the documentation! Industry old-timers may remember this as <a href=\"https://en.wikipedia.org/wiki/RTFM\" class=\"markdown-link\">RTFM</a>.</p>\n<p class=\"markdown-para\">I started with the guide on the <a href=\"https://guides.rubyonrails.org/active_record_querying.html\" class=\"markdown-link\">Active Record Query Interface</a>, more specifically, the section on <a href=\"https://guides.rubyonrails.org/active_record_querying.html#scopes\" class=\"markdown-link\">scopes</a>. Here I found this illuminating description:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Scoping allows you to specify commonly-used queries which can be referenced as method calls on the association objects or models. With these scopes, you can use every method previously covered such as where, joins and includes. All scope bodies should return an ActiveRecord::Relation or nil to allow for further methods (such as other scopes) to be called on it.</p>\n</blockquote>\n<p class=\"markdown-para\">This phrase is key: <strong class=\"markdown-strong\">All scope bodies should return an ActiveRecord::Relation</strong></p>\n<p class=\"markdown-para\">Let's take another look at the scope that ChatGPT generated:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">scope </span><span class=\"mtk4\">:open_retrospective</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> { </span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> statuses[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]) }</span></span></span></code></pre>\n<p class=\"markdown-para\">What does the <code>find_by</code> method return? The answer to this can be found in the <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-find_by\" class=\"markdown-link\">Rails API docs for find_by</a>. Quoting the relevant snippet:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Finds the first record matching the specified conditions... If no record is found, returns nil.</p>\n</blockquote>\n<p class=\"markdown-para\">Aha! So <code>find_by</code> does not return an <code>ActiveRecord::Relation</code>. It returns either the model instance if one is found matching the given conditions, or it returns <code>nil</code>. This starts to explain some of the surprising behaviour encountered earlier with the scope, it's not being given a method that returns a relation.</p>\n<p class=\"markdown-para\">The next part of the mystery is, why did the scope proceed to query for <em class=\"markdown-emphasis\">all</em> model instances, when the finder returned <code>nil</code>? Although the guides explained that the scope should return a relation or <code>nil</code>, it didn't say what happens if <code>nil</code> is returned. The answer to this can be found in the Rails API docs for <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Scoping/Named/ClassMethods.html#method-i-scope\" class=\"markdown-link\">scope</a>. Quoting the relevant snippet:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Adds a class method for retrieving and querying objects... If it returns nil or false, an all scope is returned instead.</p>\n</blockquote>\n<p class=\"markdown-para\">Aha! Another piece of the mystery resolved. If the body of the scope returns <code>nil</code>, which is the behaviour of <code>find_by</code> when no records are found, then the scope will go ahead and return an <code>all</code> scope. What exactly is an <code>all</code> scope? You can probably guess by the name that it will return a relation representing all the records for the model where this scope is defined. To be absolutely sure, let's check the Rails API docs for <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Scoping/Named/ClassMethods.html#method-i-all\" class=\"markdown-link\">all</a>. Here there's only a one sentence description:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Returns an ActiveRecord::Relation scope object.</p>\n</blockquote>\n<p class=\"markdown-para\">And a code example that demonstrates the behavior of <code>all</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">posts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\">.</span><span class=\"mtk5\">all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">posts.</span><span class=\"mtk5\">size</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># Fires &quot;select count(*) from  posts&quot; and returns the count</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">posts.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> {|p| </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk9\">p</span><span class=\"mtk1\">.</span><span class=\"mtk5\">name</span><span class=\"mtk1\"> } </span><span class=\"mtk3\"># Fires &quot;select * from posts&quot; and loads post objects</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"solution\" style=\"position:relative;\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h2>\n<p class=\"markdown-para\">Putting together all the information from the Rails guides and API documentation, the scope can be fixed to return an <code>ActiveRecord::Relation</code> by using the <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where\" class=\"markdown-link\">where</a> method rather than a finder method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retrospective</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">open:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;open&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">closed:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;closed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  scope </span><span class=\"mtk4\">:open_retrospective</span><span class=\"mtk1\">, </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> { </span><span class=\"mtk5\">where</span><span class=\"mtk1\">(</span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> statuses[</span><span class=\"mtk4\">:open</span><span class=\"mtk1\">]) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Trying this version in the Rails console <code>bin/rails c</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Starting from all retrospectives closed:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk9\">select</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:id</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:status</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &lt;Retrospective:0xb2fb40 id: 23, title: &quot;My Project Sprint 1&quot;, status: &quot;closed&quot;&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   &lt;Retrospective:0xb2faa0 id: 22, title: &quot;My Project Sprint 2&quot;, status: &quot;closed&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This time, using the scope returns an empty relation:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result.</span><span class=\"mtk5\">class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; Retrospective::ActiveRecord_Relation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Re-open one of the retrospectives with the enum method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;My Project Sprint 2&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">open!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Use the scope again, this time it returns a relation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># with the one open retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [ &lt;Retrospective:0xb2faa0 id: 22, title: &quot;My Project Sprint 2&quot;, status: &quot;closed&quot;&gt; ]</span></span></span></code></pre>\n<p class=\"markdown-para\">Since <code>where</code> always returns a relation (unlike <code>find_by</code> which returns the model instance), usage of this scope in application code can call <code>first</code> to get the model instance:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># anywhere in service code that needs the one open retro</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">retro </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">open_retrospective</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"lessons-learned\" style=\"position:relative;\"><a href=\"#lessons-learned\" aria-label=\"lessons learned permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lessons Learned</h2>\n<p class=\"markdown-para\">A few things learned from this experience:</p>\n<p class=\"markdown-para\">It seems that ChatGPT saw my original code using the finder method, and knew that scopes are a good solution for query re-usability, so it simply placed the finder in a scope. It did not make the inference that <code>find_by</code> doesn't return an ActiveRecord relation, therefore it doesn't make sense to put that in a scope.</p>\n<p class=\"markdown-para\">Always try positive and negative cases, whether its code you wrote yourself, or suggested by AI. Recall the positive case seemed to work, but unexpected results were encountered in the negative case.</p>\n<p class=\"markdown-para\">While ChatGPT can improve developer productivity, it may not fully understand the frameworks and libraries you're using, resulting in the introduction of subtle bugs. For now, any code it generates requires careful double-checking before committing.</p>\n<p class=\"markdown-para\">The <a href=\"https://guides.rubyonrails.org/\" class=\"markdown-link\">Rails Guides</a> and <a href=\"https://api.rubyonrails.org/\" class=\"markdown-link\">API docs</a> are fantastic resources. If you ever run into seemingly \"weird\" behaviour with Rails, there's a good chance you'll find an explanation here.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/a-tale-of-rails-chatgpt-and-scopes/"}}},{"node":{"id":"1c4c8585-87a3-573e-b9fc-09cb6a7b999b","frontmatter":{"title":"Maintain Node.js Version Consistency","date":"December 2023","category":"web development"},"excerpt":"In modern web development, Node.js is not limited to Node projects; it's widely used in frontend build tooling across various tech stacks…","html":"<p class=\"markdown-para\">In modern web development, Node.js is not limited to Node projects; it's widely used in frontend build tooling across various tech stacks like Rails and Java Spring. This creates a challenge for developers: which Node.js version to use? Some npm packages may only work with specific Node.js versions. Furthermore, developers often work on multiple projects, and each may require a different Node.js version. This post will explain how <a href=\"https://github.com/nvm-sh/nvm\" class=\"markdown-link\">nvm</a> (Node Version Manager) can be used to ensure a consistent Node.js environment across the project team, and make it easy to switch between different node versions when working on multiple projects.</p>\n<aside class=\"markdown-aside\">\nThis post assumes a basic understanding of what Node.js is and how it works. If you're new to it or need a refresher, check out the official <a class=\"markdown-link\" href=\"https://nodejs.org/en\">Node.js website</a> and <a class=\"markdown-link\" href=\"https://nodejs.org/en/docs\">documentation<a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"the-problem\" style=\"position:relative;\"><a href=\"#the-problem\" aria-label=\"the problem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Problem</h2>\n<p class=\"markdown-para\">Before getting into the details of how to use nvm, let's review what the problem is. If a project was originally set up with a specific Node.js version, as time goes on, newer LTS or Current versions are released. The default approach for many developers might be to install the latest available version from the official <a href=\"https://nodejs.org/en\" class=\"markdown-link\">Node.js website</a>. However, this approach can lead to issues when new team members join the project. If a new developer installs the latest Node.js version without considering the project's original setup, it may result in errors while running <code>npm install</code> or, even worse, cause unexpected behavior in the application if it relies on assumptions made for an older Node.js version.</p>\n<p class=\"markdown-para\">Moreover, when switching to work on a different project, which might require a specific Node.js version, the developer would have to uninstall the current version and manually install the required version from the list of previous <a href=\"https://nodejs.org/en/download/releases\" class=\"markdown-link\">Node.js releases</a>. This process becomes tedious, especially for developers who frequently switch between different projects. As such, a version management solution like nvm (Node Version Manager) becomes crucial to ensure consistency and avoid compatibility issues across various projects.</p>\n<h2 class=\"markdown-subtitle\" id=\"install-nvm\" style=\"position:relative;\"><a href=\"#install-nvm\" aria-label=\"install nvm permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install nvm</h2>\n<p class=\"markdown-para\">Start by going to <a href=\"https://github.com/nvm-sh/nvm\" class=\"markdown-link\">nvm on Github</a> and following the instructions to install it. At the time of this writing, the install command is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># OR</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> bash</span></span></span></code></pre>\n<p class=\"markdown-para\">The installation command will modify your profile by detecting which of <code>~/.bashrc</code>, <code>~/.bash_profile</code>, <code>~/.zshrc</code>, or <code>~/.zprofile</code> is in use. Therefore to activate nvm after initial installation, either close the terminal application and start it again, or reload the profile. For example, if your profile is in <code>~/.zshrc</code> the command to reload is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">source</span><span class=\"mtk1\"> </span><span class=\"mtk7\">~</span><span class=\"mtk1\">/.zshrc</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIf you're particularly safety conscious, an alternative approach to installing nvm is to download the nvm source directly from the latest <a class=\"markdown-link\" href=\"https://github.com/nvm-sh/nvm/releases\">release on GitHub</a> and review the \"install.sh\" script to ensure its integrity. Then, instead of piping the script through bash from raw.githubusercontent, you can run the script directly in your terminal.\n</aside>\n<p class=\"markdown-para\">If you're a Windows user, see these <a href=\"https://github.com/nvm-sh/nvm#important-notes\" class=\"markdown-link\">important notes</a> about nvm support for Windows.</p>\n<p class=\"markdown-para\">At this point, you should be able to use nvm to list currently installed Node.js versions:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm ls</span></span></span></code></pre>\n<p class=\"markdown-para\">Install a specific version:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm install 18.17.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># The `nvm install` command also switches you to that Node.js version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">node --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># v18.17.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># It also installs npm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">npm --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 9.6.7</span></span></span></code></pre>\n<p class=\"markdown-para\">Switch to a specific version, this will work assuming the specified version was previously installed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm use 16.20.1</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"use-nvmrc-file\" style=\"position:relative;\"><a href=\"#use-nvmrc-file\" aria-label=\"use nvmrc file permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use .nvmrc file</h2>\n<p class=\"markdown-para\">In the previous section, we saw how <code>nvm install x.y.z</code> and <code>nvm use x.y.z</code> can be used to install and switch to specific node versions. Another feature that nvm provides is the ability to install and use a node version without having to type it in the command line. To make use of this, create a file named <code>.nvmrc</code> in the root of your project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># in project root</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">touch .nvmrc</span></span></span></code></pre>\n<p class=\"markdown-para\">Edit the file so that it has a single line with the Node.js version that should be used for this project, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;18.17.0&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> .nvmrc</span></span></span></code></pre>\n<p class=\"markdown-para\">Now in this directory, you can type in:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Will install Node v18.17.0 from .nvmrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm install</span></span></span></code></pre>\n<p class=\"markdown-para\">If the node version specified in <code>.nvmrc</code> is already installed, then this will work:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Will switch to Node v18.17.0 from .nvmrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm use</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>.nvmrc</code> file can be committed to your project git repo. Then you can update the setup instructions in the project <code>README.md</code> to include the instructions to install nvm, then run <code>nvm install</code> and/or <code>nvm use</code>. This ensures that any developer working on this project will be using the same Node.js version. Furthermore, since nvm supports having multiple node versions installed at the same time, developers can easily switch between projects that have <code>.nvmrc</code> files in their roots, and use the nvm commands to quickly get the right Node.js version setup.</p>\n<h2 class=\"markdown-subtitle\" id=\"add-shell-integration\" style=\"position:relative;\"><a href=\"#add-shell-integration\" aria-label=\"add shell integration permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Add shell integration</h2>\n<p class=\"markdown-para\">One slight bit of friction with the setup so far is that if you run <code>nvm use</code> in a directory with a <code>.nvmrc</code> file that specifies a Node.js version that isn't already installed, it will result in an error. For example, suppose the <code>.nvmrc</code> file specifies Node.js v20.5.0, which isn't currently installed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Check what Node.js version this project requires</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /path/to/some_project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cat .nvmrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 20.5.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Try to use it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nvm use</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Found &#39;/path/to/some_project/.nvmrc&#39; with version &lt;20.5.0&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># N/A: version &quot;v20.5.0&quot; is not yet installed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># You need to run `nvm install` to install and use the node version specified in `.nvmrc`.</span></span></span></code></pre>\n<p class=\"markdown-para\">It would be nice if there was some automation that could handle this - i.e. check if the Node.js version specified in <code>.nvmrc</code> is already installed, if yes, use it, otherwise, install and then use it. Fortunately, nvm provides this as well via <a href=\"https://github.com/nvm-sh/nvm#deeper-shell-integration\" class=\"markdown-link\">shell integration</a>. The idea is you can add a script to your profile that will check for a <code>.nvmrc</code> file in any directory you <code>cd</code> to, then either install or use that Node.js version automatically.</p>\n<p class=\"markdown-para\">At the time of this writing, automatic shell integration is supported for the <a href=\"https://github.com/nvm-sh/nvm#bash\" class=\"markdown-link\">bash</a>, <a href=\"https://github.com/nvm-sh/nvm#zsh\" class=\"markdown-link\">zsh</a>, and <a href=\"https://github.com/nvm-sh/nvm#fish\" class=\"markdown-link\">fish</a> shells. I use zsh with my profile in <code>~/.zshrc</code>. Here are the lines I added to my profile to support automatic Node version installation and switching. I asked ChatGPT to add explanatory comments:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ~/.zshrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># My profile things...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This section was added by the nvm install script</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># and initializes nvm:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> NVM_DIR=</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$HOME</span><span class=\"mtk6\">/.nvm&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[ </span><span class=\"mtk7\">-s</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$NVM_DIR</span><span class=\"mtk6\">/nvm.sh&quot;</span><span class=\"mtk1\"> ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">\\.</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$NVM_DIR</span><span class=\"mtk6\">/nvm.sh&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[ </span><span class=\"mtk7\">-s</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$NVM_DIR</span><span class=\"mtk6\">/bash_completion&quot;</span><span class=\"mtk1\"> ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">\\.</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$NVM_DIR</span><span class=\"mtk6\">/bash_completion&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Add this section for shell integration AFTER nvm initialization:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Add functions to be executed when a hook is triggered.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">autoload -U add-zsh-hook</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Handle automatic Node.js version switching based on .nvmrc files.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">load-nvmrc</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Get the path of the .nvmrc file in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">local</span><span class=\"mtk1\"> nvmrc_path=</span><span class=\"mtk6\">&quot;$(nvm_find_nvmrc)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Check if an .nvmrc file was found in the current directory.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk7\">-n</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$nvmrc_path</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Get the Node.js version specified in the .nvmrc file.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">local</span><span class=\"mtk1\"> nvmrc_node_version=</span><span class=\"mtk6\">$(nvm version &quot;$(cat &quot;</span><span class=\"mtk1\">${nvmrc_path}</span><span class=\"mtk6\">&quot;)&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Check if the specified Node.js version is &quot;N/A&quot; (not installed)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$nvmrc_node_version</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;N/A&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If the specified version is not installed, use nvm to install it.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      nvm install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Check if the current Node.js version differs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># from the version specified in .nvmrc.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">elif</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$nvmrc_node_version</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$(nvm version)&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If the versions differ, use nvm to switch to the specified version.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      nvm use</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># If there is no .nvmrc file in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># but one is found in the parent directory,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># and the current Node.js version is different from the default version,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># switch back to the default version.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">elif</span><span class=\"mtk1\"> [ </span><span class=\"mtk7\">-n</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$(PWD=</span><span class=\"mtk1\">$OLDPWD</span><span class=\"mtk6\"> nvm_find_nvmrc)&quot;</span><span class=\"mtk1\"> ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;$(nvm version)&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$(nvm version default)&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Reverting to nvm default version&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    nvm use default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Add the load-nvmrc function to the &quot;chpwd&quot; hook,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># which is triggered whenever the current working directory changes.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">add-zsh-hook chpwd load-nvmrc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Call the load-nvmrc function initially to set the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Node.js version based on the .nvmrc file in the current directory.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">load-nvmrc</span></span></span></code></pre>\n<p class=\"markdown-para\">With nvm shell integration in place, being on the right Node.js version is even easier, as you don't need to remember to do anything, your shell will handle all the work for you. For example, suppose you frequently toggle between two projects, one of which uses Node.js LTS and another which uses Current (18.17.0 and 20.5.0 respectively at the time of this writing), with a directory structure similar to the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── current_project</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── .nvmrc # contains 20.5.0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   └── app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│       └── index.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── lts_project</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── .nvmrc # contains 18.17.0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        └── index.js</span></span></code></pre>\n<p class=\"markdown-para\">Now you want to work on <code>current_project</code> but don't have that Node.js version installed. When you <code>cd</code> into the project directory, the code you added to your profile for shell integration will detect this and automatically install the correct version as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /path/to/current_project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Found &#39;/path/to/current_project/.nvmrc&#39; with version &lt;20.5.0&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Downloading and installing node v20.5.0...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Downloading https://nodejs.org/dist/v20.5.0/node-v20.5.0-darwin-arm64.tar.xz...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">######################################################################################################################################################################################################### 100.0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Computing checksum with shasum -a 256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Checksums matched!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Now using node v20.5.0 (npm v9.8.0)</span></span></span></code></pre>\n<p class=\"markdown-para\">Now if you need to switch to <code>lts_project</code> and already have that Node.js version installed, the shell integration will automatically switch to that, without attempting to install it again:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /path/to/lts_project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Found &#39;/path/to/lts_project/.nvmrc&#39; with version &lt;18.17.0&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Now using node v18.17.0 (npm v9.6.7)</span></span></span></code></pre>\n<p class=\"markdown-para\">Switching to a directory that doesn't have a <code>.nvmrc</code> file will make the shell integration code revert to the default Node.js version, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> </span><span class=\"mtk7\">~</span><span class=\"mtk1\">/Documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Reverting to nvm default version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Now using node v18.16.1 (npm v9.5.1)</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered the benefits of using <a href=\"https://github.com/nvm-sh/nvm\" class=\"markdown-link\">nvm</a> for web development. With the ability to easily manage different Node.js versions, nvm ensures a consistent environment across projects and simplifies the process of switching between versions. The use of the <code>.nvmrc</code> file supports specifying required Node.js versions per project, streamlining the setup for developers. Additionally, nvm's shell integration automates the installation and usage of specific Node.js versions, further enhancing productivity.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/consistent-node-version/"}}},{"node":{"id":"0e7236cf-2fc2-557b-a4f8-2c70b70c12c9","frontmatter":{"title":"Configurable Retry with Ruby","date":"November 2023","category":"ruby"},"excerpt":"When writing Ruby code, you may encounter a section of code that is known to fail the first time, but usually works on a repeated attempt…","html":"<p class=\"markdown-para\">When writing Ruby code, you may encounter a section of code that is known to fail the first time, but usually works on a repeated attempt. For example, when fetching data from a remote API, the request may occasionally fail due to network issues but be successful when trying the same request a second or even third time. This post will explore how to  handle such situations using Ruby's <a href=\"https://docs.ruby-lang.org/en/3.2/syntax/exceptions_rdoc.html\" class=\"markdown-link\">retry</a> keyword. Additionally, we'll delve into creating a custom module (written by my colleague <a href=\"https://www.linkedin.com/in/patryk-ptasi%C5%84ski-07941713b/\" class=\"markdown-link\">Patrick Ptasiński</a>) that extends the functionality of the built-in mechanism, providing additional enhancements and reducing boilerplate.</p>\n<h2 class=\"markdown-subtitle\" id=\"ruby-project\" style=\"position:relative;\"><a href=\"#ruby-project\" aria-label=\"ruby project permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ruby Project</h2>\n<p class=\"markdown-para\">All the code in this post is using Ruby v3.1.2. If you want to follow along with the code exercises, here is the project directory structure. This is a simple Ruby project with no Rails:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── .rspec</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── .rubocop.yml</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── .ruby-version</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── Gemfile</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── Gemfile.lock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── app</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── file_reader.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   └── retryable.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── boot.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── example.txt</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── spec</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── retryable_spec.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── spec_helper.rb</span></span></code></pre>\n<p class=\"markdown-para\">Where <code>boot.rb</code> is used to load the code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;debug&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/file_reader&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">reload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">load</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">load</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/file_reader.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;FileReader loaded, try it out for example: FileReader.new(</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk6\">example.txt</span><span class=\"mtk4\">\\&quot;</span><span class=\"mtk6\">).read_file&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">The boot file is run when starting an irb console as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">irb -r ./boot.rb</span></span></code></pre>\n<p class=\"markdown-para\">This saves from having to manually require/load code in the console while working through the examples. You can also view the <a href=\"https://github.com/danielabar/ruby-retry\" class=\"markdown-link\">demo project</a> on Github.</p>\n<h2 class=\"markdown-subtitle\" id=\"built-in-retry\" style=\"position:relative;\"><a href=\"#built-in-retry\" aria-label=\"built in retry permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Built-in Retry</h2>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">If at first you don't succeed, try, try again.</p>\n</blockquote>\n<p class=\"markdown-para\">In Ruby, the <code>retry</code> keyword is used to repeat the execution of a block of code within a <code>rescue</code> clause. It allows you to handle and recover from exceptions by retrying the failed operation. In a web application, you would typically want to retry an external network request, but to keep the examples simple for this post, we'll be looking at some code that reads a file. There are many reasons why reading a file could fail, among them, if the file is not available on the file system.</p>\n<p class=\"markdown-para\">The <code>FileReader</code> class below is initialized with a path to a file, then attempts to read from the file using the <code>File.read</code> method, which could raise an error if the file is not available on disk:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">FileReader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file_path</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @file_path </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> file_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with file contents...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::ENOENT =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read failed, exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Loading and running this class in an irb console results in the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Assume example.txt exists in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;example.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File read successful</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Try it with a file that is not in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;does_not_exist.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File read failed, exception:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   No such file or directory @ rb_sysopen - does_not_exist.txt</span></span></span></code></pre>\n<p class=\"markdown-para\">Suppose this code is part of a bigger application with known timing issues, where a separate process is responsible for creating the file, but its possible that the first time the file is accessed, it might not have been created yet, then attempting it a second or even third time, by then its usually there. Here is one way the <code>FileReader</code> class can be enhanced to automatically retry the <code>read</code> operation if it fails up to a limited number of times:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">FileReader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  MAX_ATTEMPTS </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file_path</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @file_path </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> file_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @attempt </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with file contents...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::ENOENT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @attempt </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> MAX_ATTEMPTS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Increment attempt counter and try again,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># execution flows back to beginning of method.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      @attempt </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File not found. Retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">@attempt</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">MAX_ATTEMPTS</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)...&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Used up all the attempts, give up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File not found after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">MAX_ATTEMPTS</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> attempts.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">In the above version, if an error occurs reading the file, it incorporates a retry mechanism. If the number of attempts <code>@attempt</code> is less than the maximum allowed attempts <code>MAX_ATTEMPTS</code>, the method increments the attempt counter and uses the <code>retry</code> keyword to reattempt the file read operation. If the maximum number of attempts has been reached, it outputs a failure message indicating that the file was not found after the specified number of attempts.</p>\n<p class=\"markdown-para\">Loading this version in an irb console and trying it out we can see that when the file exists, it behaves the same as before. When the file does not exist, it makes two more attempts, then gives up if those still fail:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;example.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File read successful</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;does_not_exist.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File not found. Retrying (attempt 1 of 2)...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File not found. Retrying (attempt 2 of 2)...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File not found after 2 attempts.</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe \"retry\" method can only be used within a \"rescue\" clause, as it relies on the context of handling exceptions.\n</aside>\n<p class=\"markdown-para\">If you want to see the method succeed after a failed attempt, add a breakpoint just before the <code>retry</code>. I'm using Ruby's built-in debugger, which is available <a href=\"https://www.ruby-lang.org/en/news/2021/12/25/ruby-3-1-0-released/\" class=\"markdown-link\">without a separate gem install as of v3.1</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::ENOENT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @attempt </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> MAX_ATTEMPTS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @attempt </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File not found. Retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">@attempt</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">MAX_ATTEMPTS</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)...&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># === ADD BREAKPOINT HERE ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    debugger</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File not found after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">MAX_ATTEMPTS</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> attempts.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">When the breakpoint is reached, create the file <code>does_not_exist.txt</code> in the file system (using a separate terminal, i.e. <code>touch does_not_exist.txt</code>), then enter <code>continue</code> in the irb console to let the code continue execution. It will go back to the beginning of the method to attempt the file read again, and this time you should see the message <code>File read successful</code> printed to the console.</p>\n<h2 class=\"markdown-subtitle\" id=\"reusable-module\" style=\"position:relative;\"><a href=\"#reusable-module\" aria-label=\"reusable module permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reusable Module</h2>\n<p class=\"markdown-para\">The code in the previous section works, but there's a lot of boilerplate. Having the retry and attempt counting logic commingled with the actual business logic makes it difficult to quickly scan the method and determine what its true purpose is. Also, what if you need this logic in many methods throughout the code? What if some types of calls should only be re-attempted once and others multiple times? As currently written, the retry logic has to be repeated in every method where it's needed.</p>\n<p class=\"markdown-para\">Let's refactor by extracting the retry and attempt counting logic to a <code>Retryable</code> module that defines an instance method <code>with_retries</code>. This method uses the <a href=\"https://www.rubyguides.com/2019/12/yield-keyword/\" class=\"markdown-link\">yield</a> keyword to transfer control to a block of code that will get passed as an argument. This block of code will represent the actual operation that might raise an error. Since we don't know what kind of error might be raised, we'll rescue <code>StandardError</code> for now (we'll return to this shortly):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Initialize attempt counter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retried </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Execute block of code passed in by caller,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># eg: File.read(...)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> StandardError =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If attempts have been exceeded, log message</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># and raise error for caller to handle.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> retried </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable failed after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> attempts, exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Increment attempt counter and try again.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Control flows back to `begin` block.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      retried </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">In the <code>rescue</code> block, the <code>retried</code> counter is checked and if it has reached the max attempt limit (hard-coded to 2 at the moment), then a message is logged and the error is raised. Otherwise, the <code>retried</code> counter is incremented and <code>retry</code> is used to execute the code in the <code>begin</code> block again.</p>\n<p class=\"markdown-para\">To use this <code>Retryable</code> module, it can be included in a class. As a result of including this module, the class now has the <code>with_retries</code> instance method, which it can call by passing a block of code that might raise an exception. The code will be retried up to 2 times before failing.</p>\n<p class=\"markdown-para\">Here's the <code>FileReader</code> modified to make use of the <code>Retryable</code> module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">FileReader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file_path</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @file_path </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> file_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    with_retries </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># do something with file contents...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Loading and running this version of the class in an irb console results in the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Assume example.txt exists in the current directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;example.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># File read successful</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;does_not_exist.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 1 of 2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 2 of 2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable failed after 2 attempts, exception:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   No such file or directory @ rb_sysopen - does_not_exist.txt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># file_reader.rb:28:in `read&#39;:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   No such file or directory @ rb_sysopen - does_not_exist.txt (Errno::ENOENT)</span></span></span></code></pre>\n<p class=\"markdown-para\">The benefit of extracting the retry logic to a module is that it cleans up the calling code, in that now it can be solely focused on its single purpose of reading a file. Also, the <code>Retryable</code> module can be easily reused by including it in any class, and wrapping any block of code that needs to be retried in the <code>with_retries</code> block.</p>\n<h2 class=\"markdown-subtitle\" id=\"flexibility\" style=\"position:relative;\"><a href=\"#flexibility\" aria-label=\"flexibility permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Flexibility</h2>\n<p class=\"markdown-para\">There are some problems with the <code>Retryable</code> module as currently written:</p>\n<p class=\"markdown-para\">It always rescues <code>StandardError</code>, but the caller may want to be more specific about which exceptions should be retried. For example, in the case of <code>File.read</code>, it could raise <code>Errno::ENOENT</code> (no such file or directory) or <code>Errno::EMFILE</code> (too many open files), which should be retried as those could get resolved in this particular application. But other errors such as <code>Errno::EISDIR</code> (is a directory) or <code>Errno::EACCES</code> (permission denied) would not get resolved on repeated attempts therefore should not be retried.</p>\n<aside class=\"markdown-aside\">\nThe \"Errno::\" exceptions in Ruby differ from the usual exceptions like \"NoMethodError\" or \"ArgumentError\" because they represent operating system errors. To delve deeper into the topic and understand why they may seem cryptic, refer to this blog post <a class=\"markdown-link\" href=\"https://www.honeybadger.io/blog/understanding-rubys-strange-errno-exceptions/\">Understanding Ruby's Strange Errno Exceptions</a> for more insights.\n</aside>\n<p class=\"markdown-para\">Another issue with the <code>Retryable</code> module is the maximum number of attempts is currently hard-coded to <code>2</code>. The caller might want to specify how many retries. For example, some use cases may require a higher number of retries such as <code>5</code>, whereas others should only be retried once.</p>\n<p class=\"markdown-para\">It would be nice if the <code>with_retries</code> method could accept some arguments where the caller could specify a list of exceptions that should be retried, and an options hash to specify the number of retries, like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::ENOENT, </span><span class=\"mtk9 mtki\">Errno</span><span class=\"mtk1\">::EMFILE, </span><span class=\"mtk4\">limit:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">In order to support this flexibility, the <code>with_retries</code> method in the <code>Retryable</code> will be modified to accept some arguments. We'll use the splat operator for the parameter <code>*args</code>, which will allow the <code>with_retries</code> method to accept a variable number of arguments as an array. The <a href=\"https://api.rubyonrails.org/classes/Array.html#method-i-extract_options-21\" class=\"markdown-link\">extract_options!</a> method from ActiveSupport will be used to assist in parsing out the array/options.</p>\n<p class=\"markdown-para\">The splat operator will also be used in the rescue clause, to expand the <code>*exceptions</code> array into multiple arguments, each one being an individual exception that should be retried.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;active_support/all&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">*</span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Remove and return last element in args if it&#39;s a hash,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># otherwise returns a blank hash, for example:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># { :limit =&gt; 2 }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args.</span><span class=\"mtk5\">extract_options!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># What&#39;s left of the args array will be an array of exceptions,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># for example: [Errno::ENOENT, Errno::EMFILE]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Set a default number of retries if caller did not specify.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Default exceptions to handle if caller has not provided any</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [StandardError] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> exceptions.</span><span class=\"mtk5\">empty?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retried </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\">exceptions =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> retried </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable failed after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> retry(ies), exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      retried </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\n<a class=\"markdown-link\" href=\"https://guides.rubyonrails.org/active_support_core_extensions.html\">ActiveSupport</a> provides many Ruby language extensions and utilities. It's installed automatically for Rails projects, but it can be used outside of Rails by specifying it in the Gemfile as \"gem 'activesupport'\", and then requiring it at the top of the module.\n</aside>\n<p class=\"markdown-para\">Another feature that would be useful when retrying is the ability to specify a timeout. That is, the caller might want to specify a time limit on each attempt such as \"if there are no results within 2 seconds, try again. This can be done with Ruby's <a href=\"https://docs.ruby-lang.org/en/3.2/Timeout.html\" class=\"markdown-link\">Timeout</a> module, which provides a way to halt a long running operation if it hasn’t finished in a fixed amount of time.</p>\n<p class=\"markdown-para\">Below is a modified version of the <code>Retryable</code> module that supports a <code>timeout_in</code> option, and if specified, wraps the <code>yield</code> execution in a <code>Timeout.timeout</code> block, with the <code>timeout_in</code> value provided by the caller. We also add <code>Timeout::Error</code> to the list of default exceptions to handle:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;active_support/all&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;timeout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">*</span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args.</span><span class=\"mtk5\">extract_options!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Default exceptions to handle if caller has not provided any</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [StandardError, </span><span class=\"mtk9 mtki\">Timeout</span><span class=\"mtk1\">::Error] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> exceptions.</span><span class=\"mtk5\">empty?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retried </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If caller has provided a `timeout_in` option,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># wrap the execution in a timeout block:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:timeout_in</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Timeout</span><span class=\"mtk1\">.</span><span class=\"mtk5\">timeout</span><span class=\"mtk1\">(options[</span><span class=\"mtk4\">:timeout_in</span><span class=\"mtk1\">]) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Otherwise, execute the code as before:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\">exceptions =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> retried </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable failed after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> retry(ies), exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      retried </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">To try this out, modify the <code>FileReader#read_file</code> method to call <a href=\"https://docs.ruby-lang.org/en/3.2/Kernel.html#method-i-sleep\" class=\"markdown-link\">sleep</a> to simulate a slow operation. For this example, we'll have <code>with_retries</code> use defaults for the other options so it will retry 3 times, and handle <code>StandardError</code> and <code>Timeout::Error</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">FileReader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file_path</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @file_path </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> file_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">read_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Specify we should only wait 2 seconds before retrying.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk4\">timeout_in:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Simulate a slow operation by pausing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># current thread for 3 seconds.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">sleep</span><span class=\"mtk1\">(</span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">File</span><span class=\"mtk1\">.</span><span class=\"mtk5\">read</span><span class=\"mtk1\">(@file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;File read successful!&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now running this version in an irb console will show that it attempts 3 times (waiting 2 seconds each time), then raises a timeout error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">FileReader</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;example.txt&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">read_slow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 1 of 3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 2 of 3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable retrying (attempt 3 of 3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Retryable failed after 3 retry(ies), exception: execution expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/file_reader.rb:29:in `sleep&#39;: execution expired (Timeout::Error)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   from app/file_reader.rb:29:in `block in read_slow&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   from app/retryable.rb:50:in `block in with_retries&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   from app/retryable.rb:49:in `with_retries&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   from app/file_reader.rb:28:in `read_slow&#39;</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"tests\" style=\"position:relative;\"><a href=\"#tests\" aria-label=\"tests permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tests</h2>\n<p class=\"markdown-para\">We're not quite finished, the Retryable module also needs tests. I'll be using <a href=\"http://rspec.info/\" class=\"markdown-link\">RSpec</a>. At first it looks tricky to test because it needs to be included in a class in order to invoke the <code>with_retries</code> method. So it might seem like the only way to test it would be to test the <code>FileReader</code> class that uses it. However, we can use Ruby's <a href=\"https://docs.ruby-lang.org/en/3.2/Module.html#method-i-module_function\" class=\"markdown-link\">module_function</a> to make any method in a module callable on the module, in addition to being an instance method on any class the module is included in.</p>\n<p class=\"markdown-para\">Here is the modified <code>Retryable</code> module that adds the <code>with_retries</code> method as a method that can be invoked directly on the module like <code>Retryable.with_retries(...)</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;active_support/all&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;timeout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">*</span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># === EXPOSE THIS METHOD DIRECTLY ON THE MODULE ===</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">module_function</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:with_retries</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now the module can be set as the <code>described_class</code> with RSpec, and invoked as <code>described_class.with_retries(...)</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/retryable_spec.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./app/retryable&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">RSpec</span><span class=\"mtk1\">.</span><span class=\"mtk5\">describe</span><span class=\"mtk1\"> Retryable </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;.with_retries&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;executes the code block without retrying if no exception is raised&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect { described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\"> { </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Executing code&quot;</span><span class=\"mtk1\"> } }.</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">output</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Executing code</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to_stdout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;retries the code block if a specified exception is raised&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      counter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(ZeroDivisionError, </span><span class=\"mtk4\">limit:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        counter </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> ZeroDivisionError </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> counter </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(counter).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk4\">4</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;raises an exception if the retry limit is exceeded&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(ZeroDivisionError, </span><span class=\"mtk4\">limit:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> ZeroDivisionError</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span><span class=\"mtk1\">.</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">raise_error</span><span class=\"mtk1\">(ZeroDivisionError)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;retries the code block with default options if no arguments are provided&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      counter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        counter </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> StandardError </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> counter </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(counter).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&quot;retries the code block with a timeout if timeout_in option is provided&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      counter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      described_class.</span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk4\">timeout_in:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        counter </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">sleep</span><span class=\"mtk1\">(</span><span class=\"mtk4\">2</span><span class=\"mtk1\">) </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> counter </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(counter).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"documentation\" style=\"position:relative;\"><a href=\"#documentation\" aria-label=\"documentation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Documentation</h2>\n<p class=\"markdown-para\">The last thing to do before calling this feature done is to add some documentation. Fortunately ChatGPT can help out with this. I asked it to generate <a href=\"https://ruby.github.io/rdoc/\" class=\"markdown-link\">RDoc</a> comments for the <code>Retryable</code> module and here is what it came up with:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;active_support/all&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;timeout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Retryable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Retries the execution of a block of code with retry logic.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @param [Array&lt;Exception&gt;] args The list of exceptions that should trigger a retry.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @param [Hash] options The options for retrying the code block.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @option options [Integer] :limit (3) The maximum number of retry attempts after initial run.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @option options [Integer] :timeout_in The maximum time in seconds to wait for each retry attempt.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @yield The block of code to be executed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @example Retry the code block with a specific exception and a custom limit:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   Retryable.with_retries(Errno::ENOENT, limit: 5) do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # Code to be retried if Errno::ENOENT is raised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @example Retry the code block with default exceptions and a timeout:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   Retryable.with_retries(limit: 3, timeout_in: 10) do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # Code to be retried if StandardError or Timeout::Error is raised,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # with a maximum of 3 retries and a timeout of 10 seconds.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @example Retry the code block with default options:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   Retryable.with_retries do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # Code to be retried if StandardError or Timeout::Error is raised,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # with a maximum of 3 retries and no timeout.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  # @example Retry the code block with multiple exceptions:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   Retryable.with_retries(Errno::ECONNRESET, Errno::ETIMEDOUT, limit: 5) do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # Code to be retried if Errno::ECONNRESET or Errno::ETIMEDOUT is raised,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #     # with a maximum of 5 retries and no timeout.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  #   end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">with_retries</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">*</span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args.</span><span class=\"mtk5\">extract_options!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    exceptions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [StandardError, </span><span class=\"mtk9 mtki\">Timeout</span><span class=\"mtk1\">::Error] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> exceptions.</span><span class=\"mtk5\">empty?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    retried </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:timeout_in</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Timeout</span><span class=\"mtk1\">.</span><span class=\"mtk5\">timeout</span><span class=\"mtk1\">(options[</span><span class=\"mtk4\">:timeout_in</span><span class=\"mtk1\">]) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">yield</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">rescue</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\">exceptions =&gt; e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> retried </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable failed after </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> retry(ies), exception: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">e</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">raise</span><span class=\"mtk1\"> e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      retried </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Retryable retrying (attempt </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">retried</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">options[</span><span class=\"mtk4\">:limit</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">)&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">retry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">module_function</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:with_retries</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered an introduction to Ruby's built-in <code>retry</code> mechanism and the development of a flexible <code>Retryable</code> module. This module provides code re-use for the retry logic with flexibility to specify which exception classes should be handled, how many times the code should be retried, and whether it should timeout after some period of time. Finally we covered testing and documentation. The development of this module was inspired by this post on <a href=\"https://scoutapm.com/blog/ruby-retry\" class=\"markdown-link\">Ruby retry</a> and this <a href=\"https://gist.github.com/cainlevy/1323593/2321056de18e63436e66562e218a631d32077a20\" class=\"markdown-link\">Github gist</a>, check them out for further reading on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/ruby-configurable-retry/"}}},{"node":{"id":"e7c2d55a-8f68-55c1-816f-45c791f9b011","frontmatter":{"title":"Add a Kafka Consumer to Rails","date":"October 2023","category":"rails"},"excerpt":"This post will walk through how to integrate a Kafka consumer into a Rails application in a maintainable and testable way. Why would you…","html":"<p class=\"markdown-para\">This post will walk through how to integrate a Kafka consumer into a Rails application in a maintainable and testable way. Why would you need to do this? Consider the following scenario: You're working on an e-commerce system that has been developed with Rails. The product details page needs to be enhanced to show whether the current product is in stock, out of stock, or only has small number of items left (eg: \"Only 3 left in stock!\"). This information comes from a legacy inventory management system that has been written in a different programming language. This legacy system is responsible for updating the inventory count based on events, such as product purchases, returns, or stock replenishments.</p>\n<p class=\"markdown-para\">In order to display this inventory information in the Rails e-commerce app, it needs the ability to communicate with the legacy inventory system. There are many <a href=\"https://en.wikipedia.org/wiki/Enterprise_Integration_Patterns\" class=\"markdown-link\">solutions</a> for enabling different systems to communicate, each with tradeoffs to consider. This post will demonstrate how <a href=\"https://kafka.apache.org/\" class=\"markdown-link\">Apache Kafka</a> can be used to solve this problem. Kafka is a distributed streaming platform that enables high-throughput, fault-tolerant, and real-time event data streaming for building scalable and event-driven applications.</p>\n<p class=\"markdown-para\">Given that the inventory information is updated based on business events, this makes it a good fit to integrate with Kafka, which is designed for event-driven systems. Using Kafka will make the integration between the legacy and e-commerce system more tolerant to large bursts of inventory events, whereas a REST/HTTP based integration might be prone to information loss in the case of temporary network or database outages.</p>\n<aside class=\"markdown-aside\">\nThis post assumes some basic knowledge of Rails (models and controllers), Kafka (producers, consumers, topics), and Docker (just enough to run a docker compose file). Looking to level up on any of these topics? Check out this guide on <a class=\"markdown-link\" href=\"https://www.akshaykhot.com/books-to-learn-ruby-and-rails/\">books for learning Rails</a>, an introductory Kafka <a class=\"markdown-link\" href=\"https://developer.confluent.io/what-is-apache-kafka/\">tutorial</a>, and Docker <a class=\"markdown-link\" href=\"https://docs.docker.com/get-started/\">getting started</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"big-picture\" style=\"position:relative;\"><a href=\"#big-picture\" aria-label=\"big picture permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Big Picture</h2>\n<p class=\"markdown-para\">Conceptually, here is what we'll be building:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTUlEQVR42m1Qy0rDQBSdT3MnIiJE8QP0K9y6cKH4aHEjKKjgQjeWglspFKVIE7NQxKIo2khjbKckadJ0HkdmkhT7OHC5J+eeM9xcwjmHlBK+H8BxHDDGIYSA0vMZpRSUdjXPdVVCSniehyiKNFc5ogYKkiWIe6Fi+luItGvwQVqpU4dzsCRW7iwjQJRho/SK+R0La8dPmNuu467RQRJSfLkUKwc2jIINo2hjqWDBaYeI/TZqjV/MbN5j9egRs1t1rF++6EeJlAKV5zYuat8oW67ub60A4Am6QYSzahPntw5OKh84rTZBg1jP3t0AhzefKJstrV/bP3p7otacBj6hD4Zs5BxjGZISOVL5jTphgsU9C8vFBxj7JhZ2TXh+P31USjCe+lmWy35ZYlqp9aOEoWS6uKq3hr3XZ3qmLNNyZHxtmW2XGibPobT/nnH8AWNkWdqcNOX4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"legacy kafka rails\"\n        title=\"legacy kafka rails\"\n        src=\"/static/468291585c9cbd21b4cb4ce7f593968b/5a190/legacy-kafka-rails-zoom.png\"\n        srcset=\"/static/468291585c9cbd21b4cb4ce7f593968b/772e8/legacy-kafka-rails-zoom.png 200w,\n/static/468291585c9cbd21b4cb4ce7f593968b/e17e5/legacy-kafka-rails-zoom.png 400w,\n/static/468291585c9cbd21b4cb4ce7f593968b/5a190/legacy-kafka-rails-zoom.png 800w,\n/static/468291585c9cbd21b4cb4ce7f593968b/c1b63/legacy-kafka-rails-zoom.png 1200w,\n/static/468291585c9cbd21b4cb4ce7f593968b/82f58/legacy-kafka-rails-zoom.png 1387w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">We'll be focusing on the Rails side of things. Assume that another team is maintaining the inventory management system and they've already modified it to produce JSON formatted messages every time there's an inventory change. Here's an example message showing that the product identified by product code <code>ABCD1234</code> has 23 units left in stock:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;product_code&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;ABCD1234&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;inventory_count&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">23</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">These messages will be produced to a Kafka topic named <code>inventory_management_product_updates</code>. When integrating Kafka, it's important for all the teams involved to agree on the topic name(s) and message formats, essentially agreeing on a \"contract\". This will ensure that the disparate systems can communicate with each other as expected.</p>\n<aside class=\"markdown-aside\">\nWhen it comes to Kafka topic naming conventions, there are many different <a class=\"markdown-link\" href=\"https://cnr.sh/essays/how-paint-bike-shed-kafka-topic-naming-conventions\">opinions</a> such as whether to include <a class=\"markdown-link\" href=\"https://www.kadeck.com/blog/kafka-topic-naming-conventions-5-recommendations-with-examples\">version numbers</a> or not. It's beyond the scope of this post to cover all of these. If your organization has already established a naming convention, use that.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"rails-product\" style=\"position:relative;\"><a href=\"#rails-product\" aria-label=\"rails product permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rails Product</h2>\n<p class=\"markdown-para\">For this demo, I used Ruby 3.1.2, Rails 7.x and the default options for a new project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ruby --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ruby 3.1.2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails --version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Rails 7.0.4.3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails new karafka_rails_consumer_demo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> karafka_rails_consumer_demo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bin/rails generate model product name:string code:string price:decimal inventory:integer</span></span></span></code></pre>\n<p class=\"markdown-para\">The Rails application has a <code>products</code> table to store the product name, product code, price, and inventory count. Here is the migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20230524104551_create_products.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateProducts</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:products</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">decimal</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:price</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">precision:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">8</span><span class=\"mtk1\">, </span><span class=\"mtk4\">scale:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">integer</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:inventory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the corresponding <code>Product</code> model with some validations added. I'm using the <a href=\"https://github.com/ctran/annotate_models\" class=\"markdown-link\">annotate</a> gem to automatically generate schema information as comments in the model class when migrations are run via <code>bin/rails db:migrate</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: products</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  code       :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  inventory  :integer          default(0), not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  name       :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  price      :decimal(8,2)     not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Product</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:price</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:inventory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">inspect</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;#&lt;Product id: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">id</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, name: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, code: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">code</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, price: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">formatted_price</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, inventory: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">inventory</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&gt;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">formatted_price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">format</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;%.2f&quot;</span><span class=\"mtk1\">, price)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nNot critical to this demo, but since the prices are stored as a decimal column in the database, a format method is added to the model, and the inspect method is overridden to use it. This is so when products are displayed in the console for debugging purposes, it will show a price like 47.53 rather than 0.4753e2.\n</aside>\n<p class=\"markdown-para\">In development, the <code>products</code> table is populated with seed data, using the <a href=\"https://github.com/faker-ruby/faker\" class=\"markdown-link\">faker</a> gem:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/seeds.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;faker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">development?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">destroy_all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">20</span><span class=\"mtk1\">.</span><span class=\"mtk5\">times</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create!</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Commerce</span><span class=\"mtk1\">.</span><span class=\"mtk5\">product_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Alphanumeric</span><span class=\"mtk1\">.</span><span class=\"mtk5\">alpha</span><span class=\"mtk1\">(</span><span class=\"mtk4\">number:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">).</span><span class=\"mtk5\">upcase</span><span class=\"mtk7\">}#{</span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Number</span><span class=\"mtk1\">.</span><span class=\"mtk5\">number</span><span class=\"mtk1\">(</span><span class=\"mtk4\">digits:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">price:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faker</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Commerce</span><span class=\"mtk1\">.</span><span class=\"mtk5\">price</span><span class=\"mtk1\">(</span><span class=\"mtk4\">range:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk7\">..</span><span class=\"mtk4\">100.0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rand</span><span class=\"mtk1\">(</span><span class=\"mtk4\">0</span><span class=\"mtk7\">..</span><span class=\"mtk4\">50</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Seeding skipped. Not in development environment.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The products can be viewed in a Rails console <code>bin/rails c</code></p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">all</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product id: 41, name: Awesome Wool Gloves, code: JANW7810, price: 47.53, inventory: 10&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product id: 42, name: Durable Steel Plate, code: BMJG7868, price: 96.25, inventory: 3&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#&lt;Product id: 43, name: Ergonomic Paper Bag, code: FLMA2165, price: 52.46, inventory: 6&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"install-kafka\" style=\"position:relative;\"><a href=\"#install-kafka\" aria-label=\"install kafka permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install Kafka</h2>\n<p class=\"markdown-para\">Even though we'll be focused on consuming messages in the Rails application, we're going to need to produce messages to try it out. This means we'll need access to a Kafka cluster, which includes one or more brokers, and <a href=\"https://zookeeper.apache.org/\" class=\"markdown-link\">Zookeeper</a> to manage the cluster. While you could point to a shared cluster if your organization manages their own or uses <a href=\"https://www.confluent.io/\" class=\"markdown-link\">Confluent</a> (Kafka as a service), I prefer to think of this similar to a database. In the same way that every developer working on a Rails application has their own local database installed, Kafka is also a kind of database (specifically, a raw, distributed database). It could get messy if all developers are pointing to a shared cluster, producing test messages that end up getting consumed by other developers running their own tests.</p>\n<p class=\"markdown-para\">The easiest way to set up a Kafka cluster locally is with Docker and docker-compose. Confluent provides these images in their <a href=\"https://github.com/confluentinc/cp-all-in-one\" class=\"markdown-link\">cp-all-in-one</a> repository. Just two containers are required for a minimal cluster - a broker, and a zookeeper instance. Add the following <code>docker-compose.yml</code> file to the root of the project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;2&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">zookeeper</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">confluentinc/cp-zookeeper:7.2.1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">hostname</span><span class=\"mtk1\">: </span><span class=\"mtk6\">zookeeper</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;2181:2181&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">ZOOKEEPER_CLIENT_PORT</span><span class=\"mtk1\">: </span><span class=\"mtk4\">2181</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">ZOOKEEPER_TICK_TIME</span><span class=\"mtk1\">: </span><span class=\"mtk4\">2000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">broker</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">confluentinc/cp-server:7.2.1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">hostname</span><span class=\"mtk1\">: </span><span class=\"mtk6\">broker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">zookeeper</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;9092:9092&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;9101:9101&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_BROKER_ID</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_ZOOKEEPER_CONNECT</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;zookeeper:2181&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class=\"mtk1\">: </span><span class=\"mtk6\">PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_ADVERTISED_LISTENERS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">PLAINTEXT://broker:29092,PLAINTEXT_HOST://localhost:9092</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_METRIC_REPORTERS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">io.confluent.metrics.reporter.ConfluentMetricsReporter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS</span><span class=\"mtk1\">: </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_CONFLUENT_LICENSE_TOPIC_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_CONFLUENT_BALANCER_TOPIC_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_TRANSACTION_STATE_LOG_MIN_ISR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_JMX_PORT</span><span class=\"mtk1\">: </span><span class=\"mtk4\">9101</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">KAFKA_JMX_HOSTNAME</span><span class=\"mtk1\">: </span><span class=\"mtk6\">localhost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS</span><span class=\"mtk1\">: </span><span class=\"mtk6\">broker:29092</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_METRICS_ENABLE</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;true&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">CONFLUENT_SUPPORT_CUSTOMER_ID</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;anonymous&#39;</span></span></span></code></pre>\n<p class=\"markdown-para\">To start the containers, run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose up</span></span></code></pre>\n<p class=\"markdown-para\">Give it a few seconds to start, then check on the status in another terminal tab:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">docker-compose ps</span></span></code></pre>\n<p class=\"markdown-para\">If all is well, the output should look something like this, showing that both zookeeper and a single broker are running, with the broker exposed on port 9092:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                 Name                              Command            State                       Ports</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------------------------------------------------------------------------------------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">karafka_rails_consumer_demo_broker_1      /etc/confluent/docker/run   Up      0.0.0.0:9092-&gt;9092/tcp, 0.0.0.0:9101-&gt;9101/tcp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">karafka_rails_consumer_demo_zookeeper_1   /etc/confluent/docker/run   Up      0.0.0.0:2181-&gt;2181/tcp, 2888/tcp, 3888/tcp</span></span></code></pre>\n<aside class=\"markdown-aside\">\nThis tutorial is intentionally using just a single broker to keep the Kafka side simple. A real application would have multiple brokers with topics distributed and replicated across them for scalability and fault-tolerance. See this example <a class=\"markdown-link\" href=\"https://github.com/danielabar/kafka-getting-started-pluralsight/blob/main/docker-compose-multiple.yml\">docker-compose file</a> for a more advanced setup with multiple brokers and a <a class=\"markdown-link\" href=\"https://github.com/danielabar/kafka-getting-started-pluralsight#demo-fault-tolerance-and-resiliency\">demo</a> of how to use it.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"add-karafka-gem\" style=\"position:relative;\"><a href=\"#add-karafka-gem\" aria-label=\"add karafka gem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Add Karafka Gem</h2>\n<p class=\"markdown-para\">The Rails application needs to be enhanced so that it can consume messages from the <code>inventory_management_product_updates</code> Kafka topic. We're going to use the <a href=\"https://karafka.io/docs/\" class=\"markdown-link\">Karafka</a> gem to make the integration relatively easy. Some of the benefits of this gem include:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Abstracts complexities of working directly with the Kafka protocol.</li>\n<li class=\"markdown-list-item\">Leverages <a href=\"https://karafka.io/docs/Concurrency-and-multithreading/\" class=\"markdown-link\">multithreading</a> to achieve concurrency and high performance.</li>\n<li class=\"markdown-list-item\">Integrates easily with Rails, following <a href=\"https://karafka.io/docs/Routing/\" class=\"markdown-link\">routing</a> style conventions.</li>\n<li class=\"markdown-list-item\">Built in <a href=\"https://karafka.io/docs/Dead-Letter-Queue/\" class=\"markdown-link\">error handling</a> and retry logic.</li>\n<li class=\"markdown-list-item\">Testing utilities that make it easy to write <a href=\"https://karafka.io/docs/Testing/\" class=\"markdown-link\">automated tests</a> for consumers and producers.</li>\n<li class=\"markdown-list-item\">Provides both an open source and pro version with additional <a href=\"https://karafka.io/docs/Pro-Features-List/\" class=\"markdown-link\">advanced features</a>.</li>\n</ul>\n<p class=\"markdown-para\">To get started with Karafka, add the following to the project's <code>Gemfile</code> and then run <code>bundle install</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">gem &quot;karafka&quot;, &quot;&gt;= 2.0.34&quot;</span></span></code></pre>\n<p class=\"markdown-para\">Next run the karafka installation command which will setup some initial scaffolding:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec karafka install</span></span></code></pre>\n<p class=\"markdown-para\">This command will generate the main Karafka entrypoint file <code>karafka.rb</code> with some basic configuration, and an example topic and consumer:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># karafka.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  setup </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    config.</span><span class=\"mtk5\">kafka</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&quot;bootstrap.servers&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;127.0.0.1:9092&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    config.</span><span class=\"mtk5\">client_id</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;example_app&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    config.</span><span class=\"mtk5\">consumer_persistence</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">env</span><span class=\"mtk1\">.</span><span class=\"mtk5\">development?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    topic </span><span class=\"mtk4\">:example</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      consumer ExampleConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Modify this file by replacing the <code>example</code> topic with the <code>inventory_management_product_updates</code> topic in the <code>routes.draw</code> block, and the example consumer with <code>ProductInventoryConsumer</code> (to be implemented shortly):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># config block...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    topic </span><span class=\"mtk4\">:inventory_management_product_updates</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      consumer ProductInventoryConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nFor this demo, there's no need to modify the default config block generated by Karafka. Recall the Kafka broker running in a docker container has exposed port 9092 so we'll be able to connect to it. In a real application, you would use environment variables to specify the location of the bootstrap servers and authentication information. There are also many more <a href=\"https://karafka.io/docs/Configuration/\" class=\"markdown-link\">configuration options</a>.\n</aside>\n<p class=\"markdown-para\">Now let's implement the <code>ProductInventoryConsumer</code> class. This is a class that inherits from <code>ApplicationConsumer</code>, which was also generated from the karafka installation command. The only method that's required to be implemented in a consumer class is the <code>consume</code> method, which will be invoked by Karafka with a batch of messages. For now, we will only log the message payload and <a href=\"https://github.com/danielabar/kafka-getting-started-pluralsight#consumer-offset-and-message-retention-policy\" class=\"markdown-link\">offset</a> to confirm messages are being received. The <code>consume</code> method also has access to the <code>topic</code> so let's log the topic name as well:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;ProductInventoryConsumer consuming Topic: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">topic.</span><span class=\"mtk5\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Message: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">,\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Offset: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">offset</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">To exercise this code, open a new terminal tab and run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec karafka server</span></span></code></pre>\n<p class=\"markdown-para\">This command initializes the Karafka application defined at <code>karafka.rb</code>, connects to the Kafka cluster specified by the <code>bootstrap.servers</code> config, starts consuming messages from the topics specified in the <code>routes.draw</code> block, and invokes the configured consumer classes to process those messages. The server will continuously listen for new messages until the process is terminated. The output of this command is as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running Karafka 2.1.0 server</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">See LICENSE and the LGPL-3.0 for licensing details</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polling messages...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polled 0 messages in 47.48299999954179ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polling messages...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[00f6800d4770] Polled 0 messages in 1000.3159999996424ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<p class=\"markdown-para\">In order to exercise the <code>ProductInventoryConsumer</code> code, messages need to be produced to the <code>inventory_management_product_updates</code> topic. In production, this will be done by the inventory management system. For local development, we don't have that system running on our laptops. Fortunately, Karafka can also be used to <a href=\"https://karafka.io/docs/Components/#producer\" class=\"markdown-link\">produce</a> messages. Let's try this out by launching a Rails console <code>bin/rails c</code> in another terminal tab and then enter the following code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Generate a message with the expected attributes in JSON format:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">code</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}.</span><span class=\"mtk5\">to_json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; &quot;{\\&quot;product_code\\&quot;:\\&quot;JANW7810\\&quot;,\\&quot;inventory_count\\&quot;:10}&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Produce and send a message to the `inventory_management_product_updates` topic:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">produce_async</span><span class=\"mtk1\">(</span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;inventory_management_product_updates&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">payload:</span><span class=\"mtk1\"> message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [ce1340a60c42] Async producing of a message to &#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   inventory_management_product_updates&#39; topic took 21.07400000002235 ms</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># [ce1340a60c42] {:topic=&gt;&quot;inventory_management_product_updates&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   :payload=&gt;&quot;{\\&quot;product_code\\&quot;:\\&quot;JANW7810\\&quot;,\\&quot;inventory_count\\&quot;:10}&quot;}</span></span></span></code></pre>\n<p class=\"markdown-para\">After submitting the producer command, the terminal tab running the Karafka server will log output indicating the message has been consumed from topic <code>inventory_management_product_updates</code> and offset <code>0</code>. I've added some <code>=== EXPLANATIONS ===</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER STARTS PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[50b2762f16b2] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== CONSUMER INFO LEVEL LOGGING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ProductInventoryConsumer consuming: Topic: inventory_management_product_updates,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Message: {&quot;product_code&quot;=&gt;&quot;JANW7810&quot;, &quot;inventory_count&quot;=&gt;10}, Offset: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER FINISHES PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[50b2762f16b2] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 finished in 345.4149999995716ms</span></span></code></pre>\n<p class=\"markdown-para\">When there's a batch of messages ready to be processed, the <code>consume</code> method gets invoked with the <code>messages</code>, which can be iterated (in our simple case, there's only one message currently). Each of these is an instance of <a href=\"https://karafka.io/docs/code/karafka/Karafka/Messages/Message.html\" class=\"markdown-link\">Karafka::Messages::Message</a>. When the <code>payload</code> method is invoked on the <code>message</code> object, Karafka will deserialize it, which converts the raw Kafka message to a format you can work with in your Ruby code. By default, it uses JSON deserialization, which means it assumes the messages are in JSON format, and they will be deserialized into a Ruby hash. This is what's shown in the console output when we log <code>message.payload</code>. The Karafka docs have more details about <a href=\"https://karafka.io/docs/Deserialization/\" class=\"markdown-link\">deserialization</a>.</p>\n<aside class=\"markdown-aside\">\nFor those keeping count, that's three terminal tabs required to work with this application during development mode: First one to run the Kafka cluster in Docker containers, second one to run the Karafka server for consuming messages, and a third one to run a Rails console to produce messages. If you want to be able to view the output of these all at the same time, a simple way is to use the <a class=\"markdown-link\" href=\"https://iterm2.com/documentation-one-page.html\">Split Panes</a> feature of iTerm or <a class=\"markdown-link\" href=\"https://github.com/tmux/tmux/wiki\">tmux</a> for more advanced features.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"update-product\" style=\"position:relative;\"><a href=\"#update-product\" aria-label=\"update product permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Update Product</h2>\n<p class=\"markdown-para\">Now that we know we can produce and consume messages with Kafka, it's time to do the actual work of updating the product inventory. We saw from the previous exercise that a message like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;{\\&quot;product_code\\&quot;:\\&quot;JANW7810\\&quot;,\\&quot;inventory_count\\&quot;:10}&quot;</span></span></code></pre>\n<p class=\"markdown-para\">Gets deserialized to a Ruby hash when the <code>payload</code> method is invoked on it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&quot;JANW7810&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk4\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">This means the product code and inventory count can be accessed within the consumer as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Deserialize JSON message into a hash assigned to `payload`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Access payload attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Product code = </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;product_code&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># JANW7810</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">puts</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Inventory count = </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;inventory_count&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># 10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">So updating the product inventory count could be done directly in the consumer like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">There are some problems with this approach as will be covered shortly, but first, let's exercise this version of the consumer to verify it works. Back in the Rails console, run the code shown below to check the inventory value of the first product, then produce a message to update it to a different value:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Check what the current inventory value is for the first product</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">inventory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 20</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Produce a message to update it to a different value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">code</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}.</span><span class=\"mtk5\">to_json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">produce_async</span><span class=\"mtk1\">(</span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;inventory_management_product_updates&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">payload:</span><span class=\"mtk1\"> message)</span></span></span></code></pre>\n<p class=\"markdown-para\">Now the tab running the Karafka server (consumer polling for messages), will show that the message has been received and the product inventory has been updated:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER STARTS PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d886a13043fd] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== RAILS DEV LOGGING FROM FINDING AND UPDATING PRODUCT ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.9ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;JANW7810&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.2ms)  begin transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Update (0.4ms)  UPDATE &quot;products&quot; SET &quot;inventory&quot; = ?, &quot;updated_at&quot; = ?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;id&quot; = ?  [[&quot;inventory&quot;, 123], [&quot;updated_at&quot;, &quot;2023-06-02 11:10:00.738034&quot;], [&quot;id&quot;, 41]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (2.1ms)  commit transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== KARAFKA LOGGING WHEN CONSUMER FINISHES PROCESSING ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d886a13043fd] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 finished in 23.927999999839813ms</span></span></code></pre>\n<p class=\"markdown-para\">Back in the Rails console, fetch the product again and check its inventory count, it should be <code>123</code> from the Kafka message produced and consumed earlier:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">inventory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 123</span></span></span></code></pre>\n<p class=\"markdown-para\">Great it's working, ship it!</p>\n<p class=\"markdown-para\">Not so fast...</p>\n<h2 class=\"markdown-subtitle\" id=\"what-could-possibly-go-wrong\" style=\"position:relative;\"><a href=\"#what-could-possibly-go-wrong\" aria-label=\"what could possibly go wrong permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What Could Possibly Go Wrong?</h2>\n<p class=\"markdown-para\">In the previous section, we saw the happy path working. Now its time to think about things that could go wrong.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEA//EABYBAQEBAAAAAAAAAAAAAAAAAAIBA//aAAwDAQACEAMQAAABrylbNMIVf//EABoQAAICAwAAAAAAAAAAAAAAAAABAgMRE0H/2gAIAQEAAQUCkcJWtyVuDaf/xAAYEQACAwAAAAAAAAAAAAAAAAAAAQIiUf/aAAgBAwEBPwFxZbD/xAAXEQADAQAAAAAAAAAAAAAAAAAAAQIT/9oACAECAQE/AapNGx//xAAaEAACAgMAAAAAAAAAAAAAAAAAARAhIjJh/9oACAEBAAY/Ah1HDFUao//EAB0QAQABAwUAAAAAAAAAAAAAAAEAESFBEDFRYXH/2gAIAQEAAT8hilbpecaJHZ4Itpep2l//2gAMAwEAAgADAAAAEK/f/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAh8f/aAAgBAwEBPxBuEPa//8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAhUf/aAAgBAgEBPxDEMdl//8QAGhABAAMBAQEAAAAAAAAAAAAAAQARITFh4f/aAAgBAQABPxAUc267AgCdM08+xxpxMRi5wUyHCq83bLIWUzrP/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"what could possibly go wrong\"\n        title=\"what could possibly go wrong\"\n        src=\"/static/cb83bb05d8f118d8881b329eb784c7eb/4b190/what-could-go-wrong-fork-in-toaster.jpg\"\n        srcset=\"/static/cb83bb05d8f118d8881b329eb784c7eb/e07e9/what-could-go-wrong-fork-in-toaster.jpg 200w,\n/static/cb83bb05d8f118d8881b329eb784c7eb/066f9/what-could-go-wrong-fork-in-toaster.jpg 400w,\n/static/cb83bb05d8f118d8881b329eb784c7eb/4b190/what-could-go-wrong-fork-in-toaster.jpg 800w,\n/static/cb83bb05d8f118d8881b329eb784c7eb/72e01/what-could-go-wrong-fork-in-toaster.jpg 1024w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">For example, what if the inventory system sends a product code that the Rails e-commerce system doesn't have in its records? This could happen if the legacy system also manages in-store products that are not sold online, or maybe its buggy and no one quite understands how it works. Let's simulate this situation by producing a message in the Rails console for a non existing product code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">message </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;NO-SUCH-CODE&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}.</span><span class=\"mtk5\">to_json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">produce_async</span><span class=\"mtk1\">(</span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;inventory_management_product_updates&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">payload:</span><span class=\"mtk1\"> message)</span></span></span></code></pre>\n<p class=\"markdown-para\">Keep an eye on the terminal tab running the Karafka server, it will show a stack trace from attempting to consume this message:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[d886a13043fd] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.5ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO-SUCH-CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/gems/karafka-2.1.0/lib/karafka/messages/messages.rb:22:in `each&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/gems/karafka-2.1.0/lib/karafka/messages/messages.rb:22:in `each&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:3:in `consume&#39;</span></span></code></pre>\n<p class=\"markdown-para\">What's happening is that <code>nil</code> is returned from the <code>find_by</code> method, then it errors out attempting to call the <code>update!</code> method on the <code>nil</code> return:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This line returns `nil` when called with `code: &quot;NO-SUCH-CODE&quot;`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Which results in undefined method `update!` for nil:NilClass here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span></code></pre>\n<p class=\"markdown-para\">If you let the Karafka server keep running, you'll see the stack trace repeat several times, at increasing intervals of time. This is because Karafka's default behaviour is to keep retrying the failed message if an error is raised, according to a back-off strategy, up until a maximum value of 30,000 ms is reached (30 seconds), at which point, it will keep trying every 30 seconds:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d854346b76bf] Retrying of ProductInventoryConsumer after 2000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[8d4c56ce8e62] Retrying of ProductInventoryConsumer after 8000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[15a4dead41b2] Retrying of ProductInventoryConsumer after 16000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[1bcb7660af45] Pausing on topic inventory_management_product_updates/0 on offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[8f894960f0ac] Retrying of ProductInventoryConsumer after 30000 ms on topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># keeps retrying every 30000 ms</span></span></code></pre>\n<p class=\"markdown-para\">This behaviour is controlled by the following config settings, which get assigned default values. Here's a snippet from the Karafka source <a href=\"https://github.com/karafka/karafka/blob/master/lib/karafka/setup/config.rb\" class=\"markdown-link\">Karafka::Setup::Config</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># option [Boolean] should we use exponential backoff</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">setting </span><span class=\"mtk4\">:pause_with_exponential_backoff</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># option [Integer] what is the max timeout in case of an exponential backoff (milliseconds)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">setting </span><span class=\"mtk4\">:pause_max_timeout</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">30_000</span></span></span></code></pre>\n<p class=\"markdown-para\">Without error handling, it will keep trying to process this message, and not move on to other messages (because the offset of the bad message will not be committed). So clearly, some error handling is needed.</p>\n<h2 class=\"markdown-subtitle\" id=\"dead-letter-queue\" style=\"position:relative;\"><a href=\"#dead-letter-queue\" aria-label=\"dead letter queue permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dead Letter Queue</h2>\n<p class=\"markdown-para\">In terms of writing the least amount of application code, the easiest way to get error handling with Karafka is to configure a <a href=\"https://karafka.io/docs/Dead-Letter-Queue/\" class=\"markdown-link\">Dead Letter Queue</a> (DLQ) per each topic. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># karafka.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># config block...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    topic </span><span class=\"mtk4\">:inventory_management_product_updates</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      consumer ProductInventoryConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">dead_letter_queue</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># name this as per your organization&#39;s naming conventions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">topic:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;dlq_inventory_management_product_updates&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">max_retries:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With this approach, if any error is raised during message processing, Karafka will automatically retry up to a configured number of <code>max_retries</code> (which can also be set to zero if you don't ever want it to retry). If message processing still fails after the retries are exhausted, a new message containing the same header and payload as the troublesome message will be produced to the topic specified in the <code>dead_letter_queue</code> method, in this case, <code>dlq_inventory_management_product_updates</code>.</p>\n<p class=\"markdown-para\">With the modified <code>karafka.rb</code> in place (remember to restart the karafka server <code>bundle exec karafka server</code> after making changes to <code>karafka.rb</code>), producing an inventory update message with a product code that does not exist will generate the following log messages in the Karafka server. I've annotated them with <code>=== EXPLANATION ===</code>, which shows that after consuming the bad message, Karafka will make two more attempts to process it. If those still fail, it writes the message the the topic <code>dlq_inventory_management_product_updates</code>, then moves on, waiting to consume new messages:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== START CONSUMING BAD MESSAGE ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d13504295353] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.2ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...stack trace...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== FIRST RETRY ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[fa875ec2db84] Retrying of ProductInventoryConsumer after 2000 ms on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d13504295353] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.1ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...stack trace...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== SECOND RETRY ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[76694e052832] Retrying of ProductInventoryConsumer after 4000 ms on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  topic inventory_management_product_updates/0 from offset 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d13504295353] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.2ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Consumer consuming error: undefined method `update!&#39; for nil:NilClass</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      product.update!(inventory: payload[&quot;inventory_count&quot;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/path/to/app/consumers/product_inventory_consumer.rb:6:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...stack trace...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== WRITE BAD MESSAGE TO DLQ ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[23c9519eb294] Async producing of a message to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &#39;dlq_inventory_management_product_updates&#39; topic took 1.7790000000968575 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[23c9519eb294] {:topic=&gt;&quot;dlq_inventory_management_product_updates&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  :payload=&gt;&quot;{\\&quot;product_code\\&quot;:\\&quot;NO_SUCH_CODE\\&quot;,\\&quot;inventory_count\\&quot;:5}&quot;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[d1e59c1bd1df] Dispatched message 1 from inventory_management_product_updates/0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  to DLQ topic: dlq_inventory_management_product_updates</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== OFFSET COMMITTED, READY TO PROCESS MORE MESSAGES ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[316f38a98a31] Pausing on topic inventory_management_product_updates/0 on offset 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[bc51bb551a3f] Polling messages...</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"error-monitoring\" style=\"position:relative;\"><a href=\"#error-monitoring\" aria-label=\"error monitoring permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Error Monitoring</h2>\n<p class=\"markdown-para\">It's also useful to capture the error messages and stack traces in your error tracking/monitoring tool of choice (Sentry, Rollback, etc.). Karafka provides a <a href=\"https://karafka.io/docs/Monitoring-and-logging/\" class=\"markdown-link\">monitoring API</a> that allows you to subscribe to instrumentation events, and deal with them as you wish.</p>\n<p class=\"markdown-para\">Add this block to the <code>karafka.rb</code> file in the project root, between the configuration block and the routes to extract the error object and stack trace from the <code>event</code> and log them. Additionally here is where you would log to whatever error monitoring service you use:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># frozen_string_literal: true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">KarafkaApp</span><span class=\"mtk5 mtki mtku\"> &lt; Karafka::App</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  setup </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |config|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># config...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Common error handling example</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Karafka</span><span class=\"mtk1\">.</span><span class=\"mtk5\">monitor</span><span class=\"mtk1\">.</span><span class=\"mtk5\">subscribe</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;error.occurred&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |event|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    type </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> event[</span><span class=\"mtk4\">:type</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    error </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> event[</span><span class=\"mtk4\">:error</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    details </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> (error.</span><span class=\"mtk5\">backtrace</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> []).</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;An error: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">error</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> of type: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">type</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> occurred, details: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">details</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Or whatever error monitoring service Airbrake, Rollbar, etc.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Sentry</span><span class=\"mtk1\">.</span><span class=\"mtk5\">capture_exception</span><span class=\"mtk1\">(error)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  routes.</span><span class=\"mtk5\">draw</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># topics and consumers...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now whenever an error occurs in the consumer, the message and stack trace will get logged, and additionally you can notify whatever error monitoring service you use such as Sentry, Rollbar, etc. The message that caused the error will still get produced to the DLQ as per the topic configuration.</p>\n<p class=\"markdown-para\">While we could use the DLQ, together with Karafka's built-in error monitoring and simply let Karafka deal with all errors, it will be cleaner to also have the business logic be more resilient, and ensure the system produces useful error messages. Otherwise some poor soul in production support is going to be dealing with a bunch of failed messages in the dead letter queue and have no idea what's gone wrong. That could be you if developers are also responsible for production support at your company!</p>\n<p class=\"markdown-para\">The other issue with this approach is there's some wasted processing with the retries. For example, if the product code does not exist in the e-commerce system, there's no point retrying the message because it still won't exist. While this can be mitigated by setting <code>max_retries: 0</code>, there could be other errors which should be retried such as if a network blip occurs and the database is temporarily unreachable.</p>\n<aside class=\"markdown-aside\">\nYou may have noticed that we never had to run any explicit commands to create the topics such as \"inventory_management_product_updates\" and \"dlq_inventory_management_product_updates\", they just appeared when we needed them. In development mode, Karafka will automatically create topics the first time a message is produced, if the topic does not already exist in the cluster. It will be created with default settings of one partition and a single replica, which is almost never what you would want in production. In production, you should ensure the topics have been created before deploying the consumer code.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"validation-in-consumer\" style=\"position:relative;\"><a href=\"#validation-in-consumer\" aria-label=\"validation in consumer permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Validation in Consumer</h2>\n<p class=\"markdown-para\">As a first attempt at making the code more resilient, the consumer could be modified to check if the product exists, before attempting an update, otherwise log an error and manually dispatch to the dead letter queue (Karafka will only automatically produce a message to the DLQ when an exception is raised):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> product.</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Product </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;product_code&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> does not exist&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">With this in place, producing a message with an non-existing product code will result in logging an error, and the invalid message dispatched to the dead letter queue without any retries. Here's what this looks like in the Karafka server logs, again I've added <code>=== EXPLANATIONS ===</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">=== START CONSUMING MESSAGE ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ce8640c13bf0] Polled 1 messages in 1004.0149999996647ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ac5cf1c6d557] Consume job for ProductInventoryConsumer</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  on inventory_management_product_updates/0 started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== CHECK IF PRODUCT EXISTS ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Product Load (0.4ms)  SELECT &quot;products&quot;.* FROM &quot;products&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;NO_SUCH_CODE&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/consumers/product_inventory_consumer.rb:5:in `block in consume&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== RAILS LOGGER ERROR ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Product NO_SUCH_CODE does not exist</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== DISPATCH TO DQL ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[12cb723b4056] Async producing of a message to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &#39;dlq_inventory_management_product_updates&#39; topic took 0.9180000005289912 ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[12cb723b4056] {:topic=&gt;&quot;dlq_inventory_management_product_updates&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  :payload=&gt;&quot;{\\&quot;product_code\\&quot;:\\&quot;NO_SUCH_CODE\\&quot;,\\&quot;inventory_count\\&quot;:5}&quot;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[89c41457fc4c] Dispatched message 2 from</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 to DLQ topic: dlq_inventory_management_product_updates</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ac5cf1c6d557] Consume job for ProductInventoryConsumer on</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  inventory_management_product_updates/0 finished in 275.4199999999255ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=== READY FOR MORE MESSAGES ===</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[ce8640c13bf0] Polling messages...</span></span></code></pre>\n<p class=\"markdown-para\">While this works, the consumer is starting to get a little messy. And it will continue to get messier as more validation rules are enforced. For example, in the e-commerce system, there's a constraint that the inventory count must be greater than zero, recall the product model has:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Product</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other validations...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:inventory</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Suppose the inventory management system could send negative inventory counts, or blank values. It might do this if the business rules in the legacy system are different than those in the e-commerce system, or again, it could be buggy and not enough time/people to deal with the legacy system quirks. The consumer could be modified to handle this case as well:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> message.</span><span class=\"mtk5\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;product_code&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> product.</span><span class=\"mtk5\">present?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">&gt;=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> payload[</span><span class=\"mtk6\">&quot;inventory_count&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Inventory count cannot be negative&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Product </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">payload[</span><span class=\"mtk6\">&#39;product_code&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> does not exist&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">At this point, if the project is using <a href=\"https://rubocop.org/\" class=\"markdown-link\">Rubocop</a> with a default configuration, this code will light up with some offenses warning that the complexity of the <code>consume</code> method is too high and that the method is too long:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">app/consumers/product_inventory_consumer.rb:2:3:C: Metrics/AbcSize:Assignment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Branch Condition size for consume is too high. [&lt;3, 16, 6&gt; 17.35/17]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  def consume ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ^^^^^^^^^^^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/consumers/product_inventory_consumer.rb:2:3: C: Metrics/MethodLength:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  def consume ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ^^^^^^^^^^^</span></span></code></pre>\n<p class=\"markdown-para\">While one could debate the max method length rule (default value is 10, perhaps 15 is reasonable), the complexity warning should not be ignored. The Rubocop <a href=\"https://docs.rubocop.org/rubocop/cops_metrics.html#metricsabcsize\" class=\"markdown-link\">Abc rule</a> calculates the complexity of a method by considering the number of assignments (A), branches (B), aka method calls, and conditions (C) and comparing it to a maximum threshold. In this case, it's calculated a score of <code>17.35</code> which exceeds the default threshold of <code>17</code>.</p>\n<p class=\"markdown-para\">One way to resolve this is to break up the <code>consume</code> method into smaller methods, for example, the validation and error handling could be extracted as separate methods. But this is just a simple example. A real application could be many more rules. For example, the e-commerce system could have a concept of active vs inactive products where only the active ones should have their inventory updated.</p>\n<aside class=\"markdown-aside\">\nAnother technique that can help with some validation issues when using Kafka is a <a class=\"markdown-link\" href=\"https://docs.confluent.io/platform/current/schema-registry/index.html\">schema registry</a>, although you will probably still want some business level validation in the application. This is an advanced topic that won't be covered in this post. You can also check out this <a class=\"markdown-link\" href=\"https://github.com/danielabar/karafka_avro_demo\">demo project</a> showing how to use the Avro schema format with a Confluent Schema Registry from a Ruby application with the Karafka gem.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"too-much-responsibility\" style=\"position:relative;\"><a href=\"#too-much-responsibility\" aria-label=\"too much responsibility permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Too Much Responsibility</h2>\n<p class=\"markdown-para\">The real issue here is that the Kafka consumer as currently written, is taking on too many responsibilities. These include:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Deserializing the message payloads received from the broker.</li>\n<li class=\"markdown-list-item\">Implementing business rules with validation on the message payload.</li>\n<li class=\"markdown-list-item\">Implementing business logic in updating the product inventory count.</li>\n<li class=\"markdown-list-item\">Producing new messages to the dead letter queue topic in case of validation errors.</li>\n</ol>\n<p class=\"markdown-para\">A useful way of thinking about this is to compare the consumer to a Rails controller. With a controller, its responsibilities should be limited to handling http requests and responses, while business logic should be delegated to services and/or models. This makes testing of business logic easier because its isolated from the complexity of http request and response handling.</p>\n<p class=\"markdown-para\">Applying this way of thinking to a Kafka consumer, we can say that it should only be concerned with Kafka-specific things such as communicating with the broker to consume and produce messages, and deserializing and serializing message payloads. To simplify the consumer, we will apply two concepts:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">A model, initialized with the message payload hash, to perform all business rule validations.</li>\n<li class=\"markdown-list-item\">A service to check if the model is valid, and only perform the business logic update if the model is valid.</li>\n</ol>\n<h2 class=\"markdown-subtitle\" id=\"model\" style=\"position:relative;\"><a href=\"#model\" aria-label=\"model permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Model</h2>\n<p class=\"markdown-para\">Typically in a Rails application, a model is a class that inherits from <a href=\"https://api.rubyonrails.org/classes/ActiveRecord/Base.html\" class=\"markdown-link\">ActiveRecord</a> and has an underlying database table. Then it has access to the <code>validates</code> and <code>validate</code> macros to perform validations such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SomeModel</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:some_attribute</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:my_custom_method?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">my_custom_method?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do some custom validation...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">These validation macros are very useful, and could help us clean up the consumer code by providing a model class whose sole responsibility is to indicate whether the message payload is valid, and if its not, list the error messages indicating what's wrong with it. But we don't have a database table specifically for the messages coming from Kafka and it would be overkill to create one. Fortunately, Rails has a solution for this. The <a href=\"https://guides.rubyonrails.org/active_model_basics.html\" class=\"markdown-link\">ActiveModel::Model</a> module can be included in any class. It provides a way to create model-like objects that have many of the same features as traditional Rails models, but are not backed by a database table.</p>\n<p class=\"markdown-para\">This new model will be named <code>ProductInventoryForm</code>. There's no naming convention on these, but the <code>Form</code> part of the name indicates that instances of this class are used to temporarily collect input data. Here is the model class, which includes <code>ActiveModel::Model</code>, defines attributes from the Kafka message <code>product_code</code> and <code>inventory_count</code>, and specifies validation using the <code>validates</code> and <code>validate</code> macros:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/product_inventory_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:inventory_count</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:inventory_count</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than_or_equal_to:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Only invoke the `product_exists?` validation if there are no validation errors with product_code.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># For example, if product_code is blank, it doesn&#39;t make sense to try and check if it exists.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This is accomplished by specifying a &quot;stabby lamda&quot; (i.e. anonymous function) to the &quot;if&quot; hash key,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># i.e. the `validate` method accepts a hash of options, one of them being `if` to specify the conditions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># under which the given validation should run.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:product_exists?</span><span class=\"mtk1\">, </span><span class=\"mtk4\">if:</span><span class=\"mtk1\"> </span><span class=\"mtk9\">-&gt;</span><span class=\"mtk1\"> { errors[</span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">].</span><span class=\"mtk5\">blank?</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">product_exists?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors.</span><span class=\"mtk5\">add</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:product_code</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">#{</span><span class=\"mtk1\">product_code</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> does not exist&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">exists?</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> product_code)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's launch a Rails console (<code>bin/rails c</code>) to experiment with this model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Instantiate an empty model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Including ActiveModel::Model exposes the `valid?` method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># We can also access the error messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#      &quot;Product code can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#      &quot;Inventory count can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#      &quot;Inventory count is not a number&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#    ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Instantiate a model with a hash to populate the attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This should be considered invalid because</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># product code does not exist and inventory is negative:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">({</span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;FOO&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">-</span><span class=\"mtk4\">5</span><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk3\">#&lt;ProductInventoryForm:0x000000010e7f93d8 @inventory_count=-5, @product_code=&quot;FOO&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run the validation rules. It runs a query against the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># products table due to the custom `product_exists?` validation.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Product Exists? (0.4ms)  SELECT 1 AS one FROM &quot;products&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;FOO&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Check the error messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     &quot;Inventory count must be greater than or equal to 0&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     &quot;Product code FOO does not exist&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Build a valid model: code exists and inventory count positive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">({</span><span class=\"mtk4\">product_code:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">first</span><span class=\"mtk1\">.</span><span class=\"mtk5\">code</span><span class=\"mtk1\">, </span><span class=\"mtk4\">inventory_count:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">15</span><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; #&lt;ProductInventoryForm:0x0000000110761540 @inventory_count=15, @product_code=&quot;JANW7810&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This time, the product code exists so the model is valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Product Exists? (0.3ms)  SELECT 1 AS one FROM &quot;products&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   WHERE &quot;products&quot;.&quot;code&quot; = ? LIMIT ?  [[&quot;code&quot;, &quot;JANW7810&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># And no error messages are populated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">product_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># []</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nI'm placing this in the \"app/models\" directory but if you prefer, these kind of models could go in a different directory such as \"app/form_objects\" if you want to keep them separate from the models backed by a database table. Just remember to update \"config.autoload_paths\" in \"config/application.rb\" to include the new directory.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"service\" style=\"position:relative;\"><a href=\"#service\" aria-label=\"service permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Service</h2>\n<p class=\"markdown-para\">With the <code>ProductInventoryForm</code> model in place, we have all the validation rules needed to replace the nested conditionals that are in the consumer. The next step is to introduce a service to make use of the model for validity checks, and to do the product updating.</p>\n<aside class=\"markdown-aside\">\nUnlike models, views, and controllers, a service is not a built-in Rails component, but it's very useful as a place for organizing business logic. Services are often used to encapsulate complex operations or interactions with external systems. See this RailsConf 2022 talk titled <a class=\"markdown-link\" href=\"https://youtu.be/CRboMkFdZfg\">Your Service Layer Needn't be Fancy, It Just Needs to Exist</a> to learn about the benefits of having a service layer and some practical examples how to implement it.\n</aside>\n<p class=\"markdown-para\">Create a new directory <code>app/services</code> in your project, and add the <code>UpdateProductInventoryService</code> class as shown below:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/services/update_product_inventory_service.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">UpdateProductInventoryService</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_reader</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:errors</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This will be initialized with the message payload from Kafka.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @payload </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @errors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The `process` method returns true if update succeeded, false otherwise,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># with an array of error messages.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Instantiate the form object with the message payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    product_inventory_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ProductInventoryForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(payload)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># If the &quot;form&quot; is valid, update product inventory, and return true.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Otherwise, populate `errors` from form validation messages, and return false.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> product_inventory_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">update_product</span><span class=\"mtk1\">(product_inventory_form)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Use the splat operator `*` to push each element of the form objects&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># validation messages to the service `errors` array.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk7\">*</span><span class=\"mtk1\">product_inventory_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Update product using `product_code` and `inventory_count` attributes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># from the form object.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">update_product</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">product_inventory_form</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    product </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Product</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">code:</span><span class=\"mtk1\"> product_inventory_form.</span><span class=\"mtk5\">product_code</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    product.</span><span class=\"mtk5\">update!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">inventory:</span><span class=\"mtk1\"> product_inventory_form.</span><span class=\"mtk5\">inventory_count</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This service is initialized with the message payload from Kafka, which recall, is just a hash, making it easy to test this class outside of having Kafka running. It also initializes an empty <code>errors</code> array. The <code>process</code> method instantiates a <code>ProductInventoryForm</code> with the payload, then checks if the inputs are valid by invoking the <code>valid?</code> method on the form object. Recall we saw in the previous section that the <code>valid?</code> method will run all the validation rules we defined on the form object.</p>\n<p class=\"markdown-para\">If the input is valid, it updates the product inventory by looking up the <code>product_code</code> from the form object, and updating it with the given <code>inventory_count</code> from the form object. If the input is invalid, the service <code>errors</code> array is populated with the error messages from the form object, which are available by calling <code>product_inventory_form.errors.full_messages</code>.</p>\n<p class=\"markdown-para\">Remember to tell Rails that this new directory should be auto loaded by adding the following to your configuration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/application.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">config.</span><span class=\"mtk5\">autoload_paths</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">root</span><span class=\"mtk1\">.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;services&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"refactor-consumer\" style=\"position:relative;\"><a href=\"#refactor-consumer\" aria-label=\"refactor consumer permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Refactor Consumer</h2>\n<p class=\"markdown-para\">Now that we have a model for validations, and a service for business logic, the consumer can be refactored to take on less responsibilities. This will eliminate the complexity warning from Rubocop and make the code more maintainable.</p>\n<p class=\"markdown-para\">In the version shown below, the consumer instantiates the <code>UpdateProductInventoryService</code> by passing it the message payload, and then invokes the <code>process</code> method on the service. If the <code>process</code> method does not return a truthy value, an error message is logged containing the original payload, and all the service error messages, then the message is moved to the dead letter queue:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/consumers/product_inventory_consumer.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;ProductInventoryConsumer consuming Topic: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">topic.</span><span class=\"mtk5\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Message: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">,\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Offset: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">offset</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      service </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">UpdateProductInventoryService</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(message.</span><span class=\"mtk5\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">handle_service_errors</span><span class=\"mtk1\">(message, service.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">) </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> service.</span><span class=\"mtk5\">process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">handle_service_errors</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">message</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">errors</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;ProductInventoryConsumer message invalid: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">errors.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;, &#39;</span><span class=\"mtk1\">)</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">dispatch_to_dlq</span><span class=\"mtk1\">(message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"offset-management\" style=\"position:relative;\"><a href=\"#offset-management\" aria-label=\"offset management permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Offset Management</h2>\n<p class=\"markdown-para\">One more thing to be aware when consuming messages in a loop, is the consumer offsets. The last committed offset is the last message position in a topic partition that the consumer has confirmed to have read. This is important because in the event of a crash or if the service is restarted for whatever reason, the consumer will use the last commit offset to pick up where it left off. For example, if the consumer has a last commit offset of <code>26</code>, then the next time it starts reading from this topic and partition, it will start at position <code>27</code>.</p>\n<p class=\"markdown-para\">By default, the Karafka gem handles <a href=\"https://karafka.io/docs/Offset-management/\" class=\"markdown-link\">offset commit management</a> by automatically committing once every 5 seconds. Now suppose there was a failure in the middle of processing a batch of messages, but the consumer offset had not yet been committed. In this case, when the consumer was restarted, it might re-process some messages that it had already read. In this simple example, the updates are idempotent so it doesn't matter much if they run again. However, if you want to avoid ever re-processing a message, then you can modify the consumer loop to call Karafka's <code>mark_as_consumed</code> method after each message has been processed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ProductInventoryConsumer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationConsumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">consume</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    messages.</span><span class=\"mtk5\">each</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |message|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.</span><span class=\"mtk5\">logger</span><span class=\"mtk1\">.</span><span class=\"mtk5\">info</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;ProductInventoryConsumer consuming Topic: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">topic.</span><span class=\"mtk5\">name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Message: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">payload</span><span class=\"mtk7\">}</span><span class=\"mtk6\">,\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Offset: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">message.</span><span class=\"mtk5\">offset</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      service </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">UpdateProductInventoryService</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(message.</span><span class=\"mtk5\">payload</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">handle_service_errors</span><span class=\"mtk1\">(message, service.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">) </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> service.</span><span class=\"mtk5\">process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Commit this message&#39;s offset, so in the event of a crash/restart,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># it will not be consumed again.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      mark_as_consumed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered a technique for integrating Kafka into a Rails application using the <a href=\"https://karafka.io/docs/\" class=\"markdown-link\">Karafka</a> gem, including how to do error handling and use of the dead letter queue. We also learned how to avoid complexity in the consumer by limiting its responsibilities to communicating with Kafka, while introducing a model for validations, and a service for business logic. This makes each component easier to maintain. This post got quite lengthy so I'm not including the tests here, but you can try out the <a href=\"https://github.com/danielabar/karafka_rails_consumer_demo\" class=\"markdown-link\">demo project</a> including tests in the <a href=\"https://github.com/danielabar/karafka_rails_consumer_demo/tree/main/spec\" class=\"markdown-link\">spec</a> directory on Github.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-kafka-consumer/"}}},{"node":{"id":"fff6ecc2-0dbb-59b1-80bb-97c0c24f82dd","frontmatter":{"title":"They Don't All Have To Be ActiveRecord Models","date":"September 2023","category":"rails"},"excerpt":"Rails makes it relatively easy to go from an idea to a working web application. If you follow along with the Getting Started with Rails…","html":"<p class=\"markdown-para\">Rails makes it relatively easy to go from an idea to a working web application. If you follow along with the <a href=\"https://guides.rubyonrails.org/getting_started.html\" class=\"markdown-link\">Getting Started with Rails</a> guide, you can see how straightforward it is to go from an idea of a blog application with articles that have that have a title and body text, to creating a database table that stores articles, a model to represent the articles and validation rules, views that render HTML to display articles, and a controller to handle http request/responses, and delegate to the model to perform the <a href=\"https://en.wikipedia.org/wiki/Create,_read,_update_and_delete\" class=\"markdown-link\">CRUD</a> operations.</p>\n<p class=\"markdown-para\">There's also plenty of online tutorials and courses that cover creating a Rails application from start to finish for other domains besides a blogging application. Going through any of these will give you a sense of how Rails can be used to represent just about any domain where you want to build a web app to expose CRUD operations on a relational data model.</p>\n<p class=\"markdown-para\">However, all of the learning materials that I have seen make an assumption that there is always a one to one relationship between each form field that will be displayed in the web view, and the underlying database table that will be persisted. For example a Pluralsight course I took on <a href=\"https://www.pluralsight.com/courses/adding-user-resource-rails-application\" class=\"markdown-link\">Adding Resources to a Rails Application</a> covered building a cryptocurrency tracking application. Here's the new cryptocurrency creation form from the course, notice that the fields shown in the form map neatly to the underlying table:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA30lEQVR42k1Qy4qEMBDM/3/V7E3w4GnHQdDdjCAqiCaal68aKpBlG4qEoru6usR5nrA+QOsVSi1YlgUhBBzH8QcW+9L/vu/Yp7XGPM9QSkVs2wYRvIc2Dt+vClL+YhxHGGOiKGGtRV3XWNcVzrkovO87qqpC13VomgZt20JKib7vITjk9wPPnzeKooibOUSeL11kWRYdTNOEYRjiy8XkKH5dF1IJ7z2M83g2b3w9HijLMoqRZzOHKJjnefyzyNM1QZfsZQzkBXNxPsA6H8/jWenc/2czBg6kPJM7IuVLfAAzKn5YXfL5RwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar cryptocurrency table vs form\"\n        title=\"not all ar cryptocurrency table vs form\"\n        src=\"/static/acad850593b0427e9ec84bdc6c969414/5a190/not-all-ar-cryptocurrency-table-vs-form.png\"\n        srcset=\"/static/acad850593b0427e9ec84bdc6c969414/772e8/not-all-ar-cryptocurrency-table-vs-form.png 200w,\n/static/acad850593b0427e9ec84bdc6c969414/e17e5/not-all-ar-cryptocurrency-table-vs-form.png 400w,\n/static/acad850593b0427e9ec84bdc6c969414/5a190/not-all-ar-cryptocurrency-table-vs-form.png 800w,\n/static/acad850593b0427e9ec84bdc6c969414/1843f/not-all-ar-cryptocurrency-table-vs-form.png 1186w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">This symmetry between the UI form and the underlying table is very nice for learning. But what I've found in the \"real world\" is that often, the interface presented in the web view does not exactly match the database table, due to complex business requirements. Then it's not obvious how to make use of all the Rails niceties around form binding to the model, validations and saving. This post will show a technique that can be used when there's a mismatch between a form presented to a user, and what needs to be persisted in the database.</p>\n<aside class=\"markdown-aside\">\nA quick note before moving on - this post assumes you already have a basic understanding of Rails fundamentals including how to build a simple web application with models, views, and controllers. If you don't, checkout the <a class=\"markdown-link\" href=\"https://guides.rubyonrails.org/getting_started.html\">Getting Started with Rails Guides</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"example\" style=\"position:relative;\"><a href=\"#example\" aria-label=\"example permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example</h2>\n<p class=\"markdown-para\">Consider an example of a back office for some application where administrators will fill out a form to create new customers. The <code>customers</code> table will persist email, first and last names. However, the form also has a field for the customers age. It's used for validation where customer must be greater than a certain age, but it will not be persisted to table, therefore its not part of customer model. A more complex case might be that the form asks for SIN/SSN to validate against an external service, but this value is not required to be persisted.</p>\n<p class=\"markdown-para\">Here's a visual, notice that most of the fields in the new customer creation form map to the <code>customers</code> table, but the \"age\" field does not, because the requirements are that it should not be persisted in the database:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABNklEQVR42pVSyU7DQAztt/MjnPgJDj1UHJAAoSi0kFWhIkoTaJbJOkvzkB1NRW/F0hvP2J7n50lWWmu0/YimaRhKKVDsr5/nmUFnstPphKIoGHmeI01T1HXNuZWSEj91i8enZyRJwpeklIxpmmCMQRAE2O/3HLOknuchjmPO7XY7ZFm2EGql0I0SjhcjCnyUZXlWRgSkxnVdvtj3PasiPwwjZlwa1TJh0w14ixK4joOvNGVVViXtoyhiNVVV4XA4QAiB47GEaDtIpaG1YRFnwnaY8Pru42GzQRiGF2NTkeM4WK/XPDa9JSkUooHRihtSjfUrWpYR9cXHoAILipFtt1tWSuesqPBdjegHyU3OhPiH2YaYDe7ufdzcvuDjs+KcVGohtL/ENbBGe9GNKJsBk1zGpmYU/wVm9meWBt66TQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar customer table vs form\"\n        title=\"not all ar customer table vs form\"\n        src=\"/static/cca5818d4489d34eb0b7b098cebce4e0/5a190/not-all-ar-customer-table-vs-form.png\"\n        srcset=\"/static/cca5818d4489d34eb0b7b098cebce4e0/772e8/not-all-ar-customer-table-vs-form.png 200w,\n/static/cca5818d4489d34eb0b7b098cebce4e0/e17e5/not-all-ar-customer-table-vs-form.png 400w,\n/static/cca5818d4489d34eb0b7b098cebce4e0/5a190/not-all-ar-customer-table-vs-form.png 800w,\n/static/cca5818d4489d34eb0b7b098cebce4e0/1843f/not-all-ar-customer-table-vs-form.png 1186w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">If we ignore the complexity of the \"age\" field for the moment, the majority of this requirement could be implemented with the <a href=\"https://www.rubyguides.com/2020/03/rails-scaffolding/\" class=\"markdown-link\">scaffold</a> generator. This will create a migration, model, controller, and all the CRUD views for the Customer model, specifying the fields that should be persisted for each customer:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate scaffold customer email:string first_name:string last_name:string</span></span></code></pre>\n<p class=\"markdown-para\">Here is the migration that creates the <code>customers</code> table. Notice there is no <code>:age</code> column because the requirements are that it should not be persisted. I've added not null constraints on all the fields, and a unique constraint on the <code>:email</code> field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateCustomers</span><span class=\"mtk5 mtki mtku\"> &lt; ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">7.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:customers</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">index:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">unique:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">string</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.</span><span class=\"mtk5\">timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the corresponding <code>Customer</code> model. I've added some validations for the email, first, and last name fields. I'm also using the <a href=\"https://github.com/ctran/annotate_models\" class=\"markdown-link\">annotate</a> gem to get schema information outputted as comments at the top of the model class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># == Schema Information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Table name: customers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  id         :integer          not null, primary key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  email      :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  first_name :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  last_name  :string           not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  created_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  updated_at :datetime         not null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Indexes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  index_customers_on_email  (email) UNIQUE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Customer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"first-attempt\" style=\"position:relative;\"><a href=\"#first-attempt\" aria-label=\"first attempt permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First Attempt</h2>\n<p class=\"markdown-para\">Suppose in this hypothetical app, that the customer's age must be greater than 18. If you were to attempt to implement the age requirement in the standard Rails way as per the getting started guide and common tutorials, you might add the validation rule to the <code>Customer</code> model such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Customer</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># validation rules based on fields in the `customers` table</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># this won&#39;t work as we&#39;ll see because `age` is not a column on the `customers` table</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">18</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Add the <code>age</code> field to the customer creation form in the view:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form_with(model: customer) do |form| %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- other customer fields --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">&lt;!-- try to bind the `age` field even though it does not exist on customer model --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :age, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.number_field :age %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.submit %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% end %&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Update the <code>CustomersController</code> to permit <code>:age</code> as a parameter for creation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomersController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># standard CRUD methods...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># POST /customers or /customers.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(customer_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |format|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @customer.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { redirect_to </span><span class=\"mtk5\">customer_url</span><span class=\"mtk1\">(@customer), </span><span class=\"mtk4\">notice:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Customer was successfully created.&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">json</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:show</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:created</span><span class=\"mtk1\">, </span><span class=\"mtk4\">location:</span><span class=\"mtk1\"> @customer }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:new</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">json</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">json:</span><span class=\"mtk1\"> @customer, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">customer_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># try to let `age` field through from the UI form</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.</span><span class=\"mtk5\">require</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer</span><span class=\"mtk1\">).</span><span class=\"mtk5\">permit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">When attempting to save a new customer, the following error will result, indicating that the record could not be saved due to unknown attribute <code>age</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ActiveModel::UnknownAttributeError (unknown attribute &#39;age&#39; for Customer.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  raise UnknownAttributeError.new(self, k.to_s)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">^^^^^):</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"solution\" style=\"position:relative;\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h2>\n<p class=\"markdown-para\">This type of problem can be solved with <a href=\"https://guides.rubyonrails.org/active_model_basics.html\" class=\"markdown-link\">ActiveModel</a>. This is a module in Rails that provides a way to create model-like objects that have many of the same features as traditional Rails models, but are not necessarily backed by a database table. This is useful when modeling data that is not directly related to the application's database, which is exactly what we need to solve this example.</p>\n<p class=\"markdown-para\">The steps in this section will explain what needs to be changed from the scaffolded code to implement the requirement of having a field in the create form that is used for validation, but not persisted. You can also check out this <a href=\"https://github.com/danielabar/not_all_activerecord\" class=\"markdown-link\">project</a> that demonstrates the complete solution.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"customerform\" style=\"position:relative;\"><a href=\"#customerform\" aria-label=\"customerform permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CustomerForm</h3>\n<p class=\"markdown-para\">Start by introducing a <code>CustomerForm</code> model. This will be used instead of the <code>Customer</code> model to bind to the form that admin users fill out to create a customer. This class lives in the same <code>models</code> directory as all the other Rails models, but rather than inheriting from <code>ApplicationRecord</code> as the other models that are backed by a database table, it includes the <code>ActiveModel::Model</code> module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/customer_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Next, define attributes for all the fields that are needed for the customer form. Unlike with an ActiveRecord model, Rails doesn't create these automatically because there is no backing database table. Notice the attributes don't necessarily have to match columns in the <code>customers</code> table because this model is not attached to any table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/customer_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Including <code>ActiveModel::Model</code>, provides access to the validation methods that are available with ActiveRecord. Let's specify that all the fields are required, email must be a valid (according to the format defined in the RFC 6068 standard for the \"mailto\" URI scheme), and that age must be numeric and greater than 18:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/customer_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">18</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This is a good place to pause, launch a Rails console (<code>bin/rails c</code>), and play around with this model to see some of the behaviour that's now available to the <code>CustomerForm</code> model, as a result of including <code>ActiveModel::Model</code>. Note that <code>CustomerForm</code> can be initialized with a hash of attributes, just like an Active Record object, and the same validation methods are available as with Active Record:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; #&lt;CustomerForm:0x0000000112e41408&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Email can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Email is invalid&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;First name can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Last name can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Age can&#39;t be blank&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#       &quot;Age is not a number&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#     ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;sarah@example.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">first_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Sarah&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">last_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Smith&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">age:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">46</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; #&lt;CustomerForm:0x000000011496b878 @age=46, @email=&quot;sarah@example.com&quot;, @first_name=&quot;Sarah&quot;, @last_name=&quot;Smith&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">age</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [&quot;Age must be greater than 18&quot;]</span></span></span></code></pre>\n<p class=\"markdown-para\">Nice, so we can have (nearly) all the validations that are on the <code>Customer</code> model, plus some additional ones that aren't backed by a table column. The <code>uniqueness: true</code> validation isn't available on ActiveModel because that requires access to a database table to verify a unique value among all the existing records. Since email should be unique across all customers, this can be implemented  with a custom <code>validate</code> method. The API is the same as adding custom validation methods to an ActiveRecord object:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">18</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:email_available?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">email_available?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors.</span><span class=\"mtk5\">add</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;already taken&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's try this version of <code>CustomerForm</code> in a Rails console to see how the custom uniqueness validation works:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># First save a customer to the database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;alice@example.com&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">first_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Alice&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">last_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Jones&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ... TRANSACTION (1.7ms)  commit transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a CustomerForm object with an email that has already been taken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;alice@example.com&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">first_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Alice&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">last_name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Parker&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">age:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">41</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Checking if its valid queries the customer table by email</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Customer Load (0.2ms)  SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE &quot;customers&quot;.&quot;email&quot; = ? LIMIT ?  [[&quot;email&quot;, &quot;alice@example.com&quot;], [&quot;LIMIT&quot;, 1]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Error message indicates email is already taken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">.</span><span class=\"mtk5\">full_messages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># =&gt; [&quot;Email already taken&quot;]</span></span></span></code></pre>\n<p class=\"markdown-para\">The last thing we'll need on the <code>CustomerForm</code> model is the ability to save a customer to the database. The <code>save</code> method should return false if the model is invalid, otherwise create and save an instance of the <code>Customer</code> model. Let's also make the saved <code>Customer</code> model an instance variable so that it can be accessed by the controller to populate the <code>show</code> view.</p>\n<p class=\"markdown-para\">The final <code>CustomerForm</code> class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/customer_form.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomerForm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">ActiveModel</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_accessor</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">attr_reader</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:customer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">format:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">with:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">URI</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">MailTo</span><span class=\"mtk1\">::EMAIL_REGEXP }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">numericality:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">only_integer:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">greater_than:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">18</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validate </span><span class=\"mtk4\">:email_available?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">email_available?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors.</span><span class=\"mtk5\">add</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;already taken&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">find_by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">email:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\"> </span><span class=\"mtk7\">unless</span><span class=\"mtk1\"> valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Customer</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer.</span><span class=\"mtk5\">email</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> email</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer.</span><span class=\"mtk5\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> first_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer.</span><span class=\"mtk5\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> last_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"customerscontroller-new\" style=\"position:relative;\"><a href=\"#customerscontroller-new\" aria-label=\"customerscontroller new permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CustomersController New</h3>\n<p class=\"markdown-para\">Now that we have the <code>CustomerForm</code> class that implements all the required validations and the ability to save a <code>Customer</code> record, it needs to be integrated into the customer creation workflow. The first step is to modify the <code>CustomersController#new</code> method to make a <code>CustomerForm</code> instance variable available to the new view instead of a <code>Customer</code> instance variable:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomersController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># GET /customers/new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># This line is the standard Rails way to make the Active Record model instance available to the view:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># @customer = Customer.new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Instead, let&#39;s make our ActiveModel model available:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"new-view-and-form\" style=\"position:relative;\"><a href=\"#new-view-and-form\" aria-label=\"new view and form permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>New View and Form</h3>\n<p class=\"markdown-para\">The next step is to modify the <code>new</code> view to use the <code>CustomerForm</code> object instead of a <code>Customer</code> object, and pass it to a new form partial that will render the customer creation form. Note that the scaffold command used earlier generated a <code>_form.html.erb</code> partial to be used for both creating and editing customer instances. We're changing this to introduce a <code>_form_new.html.erb</code> partial since the customer creation requirements are different from editing:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">&lt;!-- app/views/customers/new.html.erb --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;New customer&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= render &quot;form_new&quot;, customer_form: @customer_form %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">br</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= link_to &quot;Back to customers&quot;, customers_path %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the form that binds the form fields to the <code>@customer_form</code> instance variable passed to it by the <code>new</code> view. Notice the <code>url: customers_path</code> is specified for the <code>form_with</code> helper, otherwise the view will attempt to render a url <code>customer_forms_path</code> by convention of the model name, but this does not exist. Note also we pass the label \"Create Customer\" to the <code>form.submit</code> helper, otherwise by convention of the model name, it would render a label \"Create Customer form\".</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">&lt;!-- app/views/customers/_form_new.html.erb --&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form_with(model: customer_form, url: customers_path) do |form| %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% if customer_form.errors.any? %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">style</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;color: red&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= pluralize(customer_form.errors.count, &quot;error&quot;) %&gt; prohibited this customer from being saved:&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">ul</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% customer_form.errors.each do |error| %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">li</span><span class=\"mtk1\">&gt;</span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= error.full_message %&gt;&lt;/</span><span class=\"mtk7\">li</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% end %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">ul</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% end %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :email, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.text_field :email %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :first_name, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.text_field :first_name %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :last_name, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.text_field :last_name %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.label :age, style: &quot;display: block&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.number_field :age %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">%= form.submit &quot;Create Customer&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">% end %&gt;</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"customerscontroller-create\" style=\"position:relative;\"><a href=\"#customerscontroller-create\" aria-label=\"customerscontroller create permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CustomersController Create</h3>\n<p class=\"markdown-para\">When the \"Create Customer\" button is clicked from the new form, it will submit a POST request to the <code>CustomersController#create</code> method. This method must be modified to use the <code>CustomerForm</code> model instead of <code>Customer</code>. We also need to define a <code>customer_form_params</code> method to specify the allowed fields for customer creation.</p>\n<p class=\"markdown-para\">If the customer is saved successfully, the <code>create</code> method should redirect to the show view, providing the <code>customer</code> instance variable of the <code>customer_form</code> object. Otherwise, render the <code>new</code> view with a 422 Unprocessable Entity HTTP response code. Since the <code>@customer_form</code> instance variable has been set, the <code>new</code> view will be able to iterate over its <code>errors</code> property and display them:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/customers_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CustomersController</span><span class=\"mtk5 mtki mtku\"> &lt; ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># POST /customers or /customers.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Initialize the ActiveModel with form parameters from the view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @customer_form </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">CustomerForm</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(customer_form_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |format|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># `save` is a custom method defined in `CustomerForm` that first calls `valid?`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> @customer_form.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># If `save` returns true, redirect to `show` view passing in the saved customer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { redirect_to </span><span class=\"mtk5\">customer_url</span><span class=\"mtk1\">(@customer_form.</span><span class=\"mtk5\">customer</span><span class=\"mtk1\">), </span><span class=\"mtk4\">notice:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Customer successfully created.&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">json</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:show</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:created</span><span class=\"mtk1\">, </span><span class=\"mtk4\">location:</span><span class=\"mtk1\"> @customer }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">else</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># If `save` returns false, render the `new` view to display the errors in `customer_form`:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">html</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">:new</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.</span><span class=\"mtk5\">json</span><span class=\"mtk1\"> { render </span><span class=\"mtk4\">json:</span><span class=\"mtk1\"> @customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">, </span><span class=\"mtk4\">status:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:unprocessable_entity</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Specify allowed fields for the CustomerForm model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">customer_form_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.</span><span class=\"mtk5\">require</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer_form</span><span class=\"mtk1\">).</span><span class=\"mtk5\">permit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:age</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"try-it\" style=\"position:relative;\"><a href=\"#try-it\" aria-label=\"try it permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Try It</h3>\n<p class=\"markdown-para\">Putting all of these code changes together, we can now navigate to the new customer create form at <code>http://localhost:3000/customers/new</code>, and fill it in with an age that is invalid:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 300px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 136.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAADjElEQVR42p1VXW8TRxTNMw995YmXqgIJtUKtiiqh9g2pb61Eq1IqQRGiVQtCfUagwkt/QH9BValVwUogfKhSXGfjRAnBiaFKUBLbJCaOs/5Y7653s+udnd1ZH3QnJPZCbAxXOpqPnb1zz5x7Z4bwkrXb7bfCzr9DW1tbSCbHkM1mkUwm4bru7seubXr044GQDXHOUa3WoRsmypsqoog+AiJqI2oDUdSW4zAUECKSczwI4fsBOA/g+xxBEHYipI+2vYVKpQrDMJHPF7CxUUatVpetqlZQKm3ANE3U65rse4xJ57QJoeWxjsNQRMjl8lAUBfPz8xgbG8PMzDSmp6cxOzuLubk5TE6msbKygoWFBTx6lIXjODG6jPkdyts7RZKWpPtiEfVpM6JEUTDG4fNArqU5ckJzHvPluEOZcxSLRei6Adu20Ww2oRsGDMNAGIYvnL9e4V2HjDFkMnOYmEhjcfEJFGUC4+OKbA3TlM54EMiD74VY2siJl1KAlKQ1QRj2dUSgzYh+TGVSkEQhESoVdY887G8xUSiXLMtGqVSSKdK0LERRJKMjwQaB53VFKA/2lazfbil5SUnm9wHjEELEVV5eXsLU1BTW19dlLlKuZTIZBEEwMO1Y6RWeriKXL0DTdCwv51AorCKffwrXbckoPJlze4PoxkovCATogrAs65UKGPT2iZ0hVQOVVTqdxszMA/j+tmIkzKBXV9xhKGTekZHznXIaBDuUWXfp0cHregMt10EUCbytxUQZvXsff99IoKbpYFzA9Xy4jPdEi1qPy7VctBF2p41hOVjb1FGumVAbNlTNgqrZfbGpWajqDvJFFQ8fL6FUMToOtaaLZ6UyLLPxxjSVVBKXLv6MusWkiJJyTbewtLqJclVHw2qhbjrQTLcnGk2CA8vl+P9JDiN3/kVR7YpQiBCMc/j0TlDLt0vK8/nueAekrGm3oFsEF7bL4TABp9X1BNRND9//Nolvryk4cSUlcfJXBaeuT8j+11dT+OpqCl9e/g+//D4rheir8uKagX3H/8CRsyP49MI9fHbxHt4/M4zDp4dx9IdRfPLjHRz76S4+ODOC/V/8harekj+KqMe7vLLexDuf/4l3v7khHXx8fhTvnbyJQ98l8NG52zhy9hY+PHcLB08lcODEP9CabPdZ2MuGPD/E/QclDKeLuDm+JkH9kfQzJJQ1JJSiBM2nsiqCMOp7AT8HPLrtF6W+gJ4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar invalid form\"\n        title=\"not all ar invalid form\"\n        src=\"/static/321c7f2c05c8c5bcc44f7495aa83307a/5a46d/not-all-ar-invalid-form.png\"\n        srcset=\"/static/321c7f2c05c8c5bcc44f7495aa83307a/772e8/not-all-ar-invalid-form.png 200w,\n/static/321c7f2c05c8c5bcc44f7495aa83307a/5a46d/not-all-ar-invalid-form.png 300w\"\n        sizes=\"(max-width: 300px) 100vw, 300px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Here is the rendered HTML form, notice the <code>name</code> attributes of the input fields are like <code>customer_form[field]</code> rather than <code>customer[field]</code>. This is because we're binding to the <code>CustomerForm</code> ActiveModel rather than the  <code>Customer</code> Active Record model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">form</span><span class=\"mtk1\"> </span><span class=\"mtk5\">action</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;/customers&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">method</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;post&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;hidden&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;authenticity_token&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">value</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;Lda1K...&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_email&quot;</span><span class=\"mtk1\">&gt;Email&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form[email]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_email&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_first_name&quot;</span><span class=\"mtk1\">&gt;First name&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form[first_name]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_first_name&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_last_name&quot;</span><span class=\"mtk1\">&gt;Last name&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form[last_name]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_last_name&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">label</span><span class=\"mtk1\"> </span><span class=\"mtk5\">for</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_age&quot;</span><span class=\"mtk1\">&gt;Age&lt;/</span><span class=\"mtk7\">label</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;number&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form[age]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;customer_form_age&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;submit&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;commit&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">value</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;Create Customer&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">form</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">After clicking the \"Create Customer\" button, the request and response is logged to the Rails server output. Notice the <code>customer_form</code> parameter rather than <code>customer</code> due to the use of the <code>CustomerForm</code> ActiveModel.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Started POST &quot;/customers&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Processing by CustomersController#create as TURBO_STREAM</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Parameters: {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;authenticity_token&quot;=&gt;&quot;[FILTERED]&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;customer_form&quot;=&gt;{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;email&quot;=&gt;&quot;jane@example.com&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;first_name&quot;=&gt;&quot;Jane&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;last_name&quot;=&gt;&quot;Doe&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;age&quot;=&gt;&quot;3&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;commit&quot;=&gt;&quot;Create Customer&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Customer Load (0.5ms)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE &quot;customers&quot;.&quot;email&quot; = ? LIMIT ?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [[&quot;email&quot;, &quot;jane@example.com&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/models/customer_form.rb:15:in `email_available?&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Rendering customers/new.html.erb within layouts/application</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Rendered customers/_form_new.html.erb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Completed 422 Unprocessable Entity</span></span></code></pre>\n<p class=\"markdown-para\">Since there is an error with the <code>age</code> attribute in the <code>customer_form</code> instance variable set by the <code>CustomersController</code>, it will be displayed in the new form:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 677px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABsElEQVR42p2Ty27TQBSG/VCs2CPxICzYoi7YsIQ3QGLRFX2CigXwCJRGcZO2cS5EvsWpgmpTmjoXz8z5qhmnFqAiJbH068yM5nzznzNjj/EYpzCEfgDdDlxcQK8HgwFMJjAa1eMoguGw3m/X7NjGOIJ+H4oCT3o9xE6CAAkC8H04O4PLy3rTjxG02+C34fy8BtsDu11oteD0FDodODmB62s8tHYuZDpFsgkymyFxjFxdIVkGeY6w/efd3dwg8zmsVrBaQllCeQfLJSwWiF03ZjuJ4AX9AfNywapSrKrKxUoblBHM5lTnUP7j8591L8syxuMxURQRhiFpmlKWJcYISqlNjjya/GjJSTohThLyvEBpzbqqqKzLSjUgke276MVxTFH8Yr1eO1fGGCettdPOwDSd8Pv2FqW0c2ijbqLZHZgkCWEUkRdF0zcHV9rN9wCmrm82yTqysiU/QHcGzmY/NzDdAB+016VM7R8i/NVDGyul9rsUoxVijJNxr70u1z6bvYBPXhzz/OALz1595unLTxy8/9ZALGcXmAO+/vCdd0c+bz/6vDlscfR1+Adw9x7eA/nY10ouK1b2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar form error\"\n        title=\"not all ar form error\"\n        src=\"/static/afc538f24f2e194dc20f42e212cd036f/68de2/not-all-ar-form-error.png\"\n        srcset=\"/static/afc538f24f2e194dc20f42e212cd036f/772e8/not-all-ar-form-error.png 200w,\n/static/afc538f24f2e194dc20f42e212cd036f/e17e5/not-all-ar-form-error.png 400w,\n/static/afc538f24f2e194dc20f42e212cd036f/68de2/not-all-ar-form-error.png 677w\"\n        sizes=\"(max-width: 677px) 100vw, 677px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Let's correct the error by setting an age greater than 18 and submitting the form again:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 292px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 137%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAADA0lEQVR42p1VS08TURRm48L4M3SlwY2auDEx0f+gC4GgJi70X/ggEg1LV4YVCgaCBhZUqyl9GBIepcMjFmzLtEA7bWlDH/Oe+cw5baedWqB0ki/3ns703HO+851z+wqFAkRRRD6fRyqVgmEY6OWxbZvXvsPDQywvr8Dj+Y4f3p+oVKrQdAOqqkHTdIZah9aytsI0LcdpH/3ZfVJzb9lNm1bLsnk1DBO6bjioVpWmQ9OyIQgCfD4fgsEgFhYWEAgEEAqFsLS0hFAoyO+i0T9YD4fh9/tRLBZcQSiK1kxZ0wwkkykkk0mIYhKxWIztRCKBdDqNPVFkW5KyyGQkEEWKorIDy7IY7ghNi1Pp9FD0hmnBNO1amobJtqrqkBWVI6OVeHQcZjIZrK2tIRwOc1RbW5uc2urqKhRFPn+VS6UyRDGFiLCB/f0DrEcECMImwusRHB+XuKqNaDrhvwiJw1raFkul/dTGu5NgEodyC4eGYSEajcLr9WJ+fg5EAUvGsrpOt1EkTpkILpUqqFRlrla1KkOW1RqU00GO6LtyRW6tstlR1A2bPuoGjsNcLscVJUGTwAOBIDweDwtYlpsnn+XMcUi9m05LyB8VUK7v0xkJ2WyOaWhU8kTU6XEJm9Qfj8chSVJPk0ZuLQqpf3f3L/fr8spKrUPOkEo72mTjLkpTxGoX0Jy0HYdEvCjuIZvN9jxcXa1Hk5oqTAO2XC7zC4qa5NQtGk3AERKHJGhZVkBtyOmq54CiodI+vnZ2dnig9vq4Biydkj8qYv8gDUXVzwSNfOJab0A33BEC9rmiIWfU/60XmF6/l9ihEDvC4xE/ht8sYvCVjzFM9ogfQ68XHQy89OHF2G/kj9XTqzzpjeHC3Y+48WQW1wamcfPpLC4/mEL/0Azb/YMzvL/6aBoX741jM15wroeOw+HLr5rD60MzuP3sG+48n8OVh1OOfevpVz6EDrx0fxzbiWJ9Xnamqk/MlDE2tYH3kwJGJyJ4OxHh/bvPAkY/RRzQ7x9mt1Gq6q4U2x3+A4dl8PMyvEyAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar valid form\"\n        title=\"not all ar valid form\"\n        src=\"/static/175984a91f40f8370b5dfd1bf8811cec/2e9f9/not-all-ar-valid-form.png\"\n        srcset=\"/static/175984a91f40f8370b5dfd1bf8811cec/772e8/not-all-ar-valid-form.png 200w,\n/static/175984a91f40f8370b5dfd1bf8811cec/2e9f9/not-all-ar-valid-form.png 292w\"\n        sizes=\"(max-width: 292px) 100vw, 292px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p class=\"markdown-para\">This time, the Rails server output shows a new <code>customers</code> record being inserted into the database, then redirecting to the customers show view at <code>http://localhost/customers/{id}</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Started POST &quot;/customers&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Processing by CustomersController#create as TURBO_STREAM</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Parameters: {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;authenticity_token&quot;=&gt;&quot;[FILTERED]&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;customer_form&quot;=&gt;{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;email&quot;=&gt;&quot;jane@example.com&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;first_name&quot;=&gt;&quot;Jane&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;last_name&quot;=&gt;&quot;Doe&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      &quot;age&quot;=&gt;&quot;19&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;commit&quot;=&gt;&quot;Create Customer&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Customer Load (9.8ms)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE &quot;customers&quot;.&quot;email&quot; = ? LIMIT ?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [[&quot;email&quot;, &quot;jane@example.com&quot;], [&quot;LIMIT&quot;, 1]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/models/customer_form.rb:15:in `email_available?&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (0.1ms)  begin transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Customer Create (3.3ms)  INSERT INTO &quot;customers&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (&quot;email&quot;, &quot;first_name&quot;, &quot;last_name&quot;, &quot;created_at&quot;, &quot;updated_at&quot;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    VALUES (?, ?, ?, ?, ?)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [[&quot;email&quot;, &quot;jane@example.com&quot;], [&quot;first_name&quot;, &quot;Jane&quot;], [&quot;last_name&quot;, &quot;Doe&quot;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [&quot;created_at&quot;, &quot;2023-03-24 11:22:45&quot;], [&quot;updated_at&quot;, &quot;2023-03-24 11:22:45&quot;]]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/models/customer_form.rb:25:in `save&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TRANSACTION (1.7ms)  commit transaction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ↳ app/models/customer_form.rb:25:in `save&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Redirected to http://localhost:3000/customers/12</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Completed 302 Found</span></span></code></pre>\n<p class=\"markdown-para\">And here is the customer show view with the flash message that it was successfully created (this portion is directly from the scaffolded code):</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 391px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACdElEQVR42p1UW08TURDuiw/+DN+Mxgd8UDEmavgPvqgxkihqjPH/KBLfTEQUWqCl3nB759ILuu0C3bq7Zam73aVLW9pt2X7mTAutLWhkki8z5zs73zkzc7KuWrOGYrWIndoOjD0T5p6J3fou+bJdppihVCtBr+rYLm8Tb9UtymOo2BUwa7VacLHNVXUVnBRAWAkjIAeR1tP4JnFIFpKI5qNY2lrG15+LCClh8rzGY1ldwUfxEz7nvkA0xa5gO+qg347ijjEmxsyFE5rTckjkAIc31HUdoVCIEI/HIYoieJ6nOJ1OI5PJkGdQFAWCIKBS6fZsQLBarZIIS2QJsixDkiTiWMyQy+Vor1AoIJ/Po16v/1Fmr7mOIv+nZwOCmqbB6/ViYWEBkUgEHo8HPp+PbsbWiUQCjUaDBBzHGShxQPCwyY5D2N/fJxzEzWbzrwIDgrZtwzRNaJoOwzCoT2xQlmUR39+v3kH0gwRZIscFEAwGEYvF4Pf7wXEcsqJIk1ZVtVtBT7LTQbsVXf7E7/DYkktlG4HUNhIbRawKOrJbFjLSDlYEHWtZg3jdKCGYUhHjNXwXTWzmLfKhtQKSmwbCP35hXSm1b2hVbMxFZPiX8vDFFPLzEYXgjSpwByUkhAJ8URlRXoMgl+jAVNZAfKNIwiudi5AgW1wcfY+R53O49sSNyw+ncfPZLC49+IDhRzO4/tSDq4/dOHdnkg77Z8mLcRWnboxjeGwaQ/encPb2W1y49w5nbr3B+buTGBqdwpWxaZwemcDr+XVKajTbA2LDcPqHYlh1+vDFTAYv3RlMzAnkX80KGPe0OVp7BChapfNjOP49/gYGRek/Ib60ogAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not all ar success\"\n        title=\"not all ar success\"\n        src=\"/static/8b5758d0ba2b86acac7cbdf8a93647e0/14e0c/not-all-ar-success.png\"\n        srcset=\"/static/8b5758d0ba2b86acac7cbdf8a93647e0/772e8/not-all-ar-success.png 200w,\n/static/8b5758d0ba2b86acac7cbdf8a93647e0/14e0c/not-all-ar-success.png 391w\"\n        sizes=\"(max-width: 391px) 100vw, 391px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 class=\"markdown-sub-subtitle\" id=\"tests\" style=\"position:relative;\"><a href=\"#tests\" aria-label=\"tests permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tests</h3>\n<p class=\"markdown-para\">Before we can conclude that we're done, the <code>CustomerForm</code> model should have automated tests. I'm using <a href=\"https://rspec.info/\" class=\"markdown-link\">RSpec</a> on this project. A really nice feature of including the ActiveModel module is the validation rules can be tested with <a href=\"http://matchers.shoulda.io/\" class=\"markdown-link\">shoulda matchers</a>, just like an Active Record model. Here are the tests for the validation rules, and the <code>save</code> method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;rails_helper&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">RSpec</span><span class=\"mtk1\">.</span><span class=\"mtk5\">describe</span><span class=\"mtk1\"> CustomerForm, </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:model</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">subject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer_form</span><span class=\"mtk1\">) { described_class.</span><span class=\"mtk7\">new</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;validations&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_presence_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">allow_value</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;email@example.com&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">for</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should_not </span><span class=\"mtk5\">allow_value</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">for</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_presence_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:first_name</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_presence_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:last_name</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_presence_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:age</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it { should </span><span class=\"mtk5\">validate_numericality_of</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:age</span><span class=\"mtk1\">).</span><span class=\"mtk5\">only_integer</span><span class=\"mtk1\">.</span><span class=\"mtk5\">is_greater_than</span><span class=\"mtk1\">(</span><span class=\"mtk4\">18</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    context </span><span class=\"mtk6\">&quot;when email is already taken&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">let!</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer</span><span class=\"mtk1\">) { </span><span class=\"mtk5\">create</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:customer</span><span class=\"mtk1\">, </span><span class=\"mtk4\">email:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email@example.com&quot;</span><span class=\"mtk1\">) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      before { customer_form.</span><span class=\"mtk5\">email</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;email@example.com&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it { should_not be_valid }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;has an error on email&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">valid?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(customer_form.</span><span class=\"mtk5\">errors</span><span class=\"mtk1\">[</span><span class=\"mtk4\">:email</span><span class=\"mtk1\">]).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk7\">include</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;already taken&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;#save&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    context </span><span class=\"mtk6\">&quot;when form is valid&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      before </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">email</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;this_is_good@test.com&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">first_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Fred&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">last_name</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Flinstone&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        customer_form.</span><span class=\"mtk5\">age</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">44</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;creates a new customer&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        expect { subject.</span><span class=\"mtk5\">save</span><span class=\"mtk1\"> }.</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span><span class=\"mtk1\">(Customer, </span><span class=\"mtk4\">:count</span><span class=\"mtk1\">).</span><span class=\"mtk5\">by</span><span class=\"mtk1\">(</span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;returns true&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(subject.</span><span class=\"mtk5\">save</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> be_truthy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;sets the customer attribute&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(subject.</span><span class=\"mtk5\">customer</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">be_a</span><span class=\"mtk1\">(Customer)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    context </span><span class=\"mtk6\">&quot;when form is invalid&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      before </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">allow</span><span class=\"mtk1\">(subject).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">receive</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:valid?</span><span class=\"mtk1\">).</span><span class=\"mtk5\">and_return</span><span class=\"mtk1\">(</span><span class=\"mtk4\">false</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;does not create a new customer&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        expect { subject.</span><span class=\"mtk5\">save</span><span class=\"mtk1\"> }.</span><span class=\"mtk5\">not_to</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span><span class=\"mtk1\">(Customer, </span><span class=\"mtk4\">:count</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;returns false&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(subject.</span><span class=\"mtk5\">save</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> be_falsey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      it </span><span class=\"mtk6\">&quot;does not set the customer attribute&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject.</span><span class=\"mtk5\">save</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(subject.</span><span class=\"mtk5\">customer</span><span class=\"mtk1\">).</span><span class=\"mtk5\">to</span><span class=\"mtk1\"> be_nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIf you're setting up a new Rails project, it defaults to minitest rather than RSpec for automated testing. See this post I wrote on <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/start-rails-6-project-with-rspec/\">Starting a Rails Project with RSpec</a> for how to switch from minitest to RSpec.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has demonstrated how to use Active Model in a Rails application when the form presented to the user does not exactly match what should be persisted in the database. We just scratched the surface of what's available from the ActiveModel module with regards to validation. Be sure to check out the <a href=\"https://guides.rubyonrails.org/active_model_basics.html\" class=\"markdown-link\">Active Model Basics Rails Guides</a> to learn about all the available features.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/they-dont-all-have-to-be-activerecord-models/"}}}]}},"pageContext":{}},"staticQueryHashes":["163244226"],"slicesMap":{}}