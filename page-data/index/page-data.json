{
    "componentChunkName": "component---src-pages-index-js",
    "path": "/",
    "result": {"data":{"allMarkdownRemark":{"totalCount":46,"edges":[{"node":{"id":"41a1eab5-7685-581e-9d15-1fb7583289ba","frontmatter":{"title":"Add Related Posts Feature to a Gatsby Blog","date":"February 2022","category":"gatsby"},"excerpt":"This post will explain how to add a Related Posts feature to a Gatsby blog. The idea is to add a small number of links at the bottom of a…","html":"<p class=\"markdown-para\">This post will explain how to add a Related Posts feature to a Gatsby blog. The idea is to add a small number of links at the bottom of a post page, to other posts that the reader may be interested in. The display of these could be just simple text links, or include a small version of the feature photo and the title. For example, at the end of a post about Gatsby, display a few other articles about Gatsby like this:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVQY0x2QSUgbAQBF59i7eJUcXS+CEksVxCUJKCJpIQdDFBdwjwtGD9pGkWK0adWLHhRXUEuxB0E8elVJxC0GNTqZZBQTZzCKS9W84vzr48HjC75DP17PHjtbXjw7u2xveZDEMLzBvxe4fQb1CZQniDxC7BniL2/c3T0gX12jRG9QlFsiUQU1qiB8sdnIzM3lU5GBPIOJlKwspmbned+mN8Dg2DT2bictPf18HfjO6t81jS2t/qGuvRHXkBNHVwv2ng6+DQ0ifCwuIkGnIyk5FV1aOh8SExkZHdck968JyguNVFS3Y7Y2YdTr+eH6qbG538uUmU10O5qpspoxlBRQ39aIYKmsIjs/n7zi90IjGfocZhYWNWls2M1nUwk1DhcVrf2UllmYnFnR2NrGOjX2Bro6muhsa8Baa6PP2YtwdnLO4b4Pv+8U8VwiJMk83D8Sf40TDIgcHfgRL8JIokw4dEVMjWn/Ri6vOfadIAVl5NAlwQsJNaryH9dsJQQJsgGKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"gatsby related posts example\"\n        title=\"gatsby related posts example\"\n        src=\"/static/574e3d1ff036bf363ef8312daa703884/5a190/gatsby-related-posts-example.png\"\n        srcset=\"/static/574e3d1ff036bf363ef8312daa703884/772e8/gatsby-related-posts-example.png 200w,\n/static/574e3d1ff036bf363ef8312daa703884/e17e5/gatsby-related-posts-example.png 400w,\n/static/574e3d1ff036bf363ef8312daa703884/5a190/gatsby-related-posts-example.png 800w,\n/static/574e3d1ff036bf363ef8312daa703884/bb3ba/gatsby-related-posts-example.png 1121w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p class=\"markdown-para\">The related posts will be curated, that is, the author of the blog is responsible for selecting related articles for each post and populating them in the markdown (we'll be getting into the details of this shortly). If you are looking for a more automated solution, checkout the <a href=\"https://www.npmjs.com/package/gatsby-remark-related-posts\" class=\"markdown-link\">gatsby-remark-related-posts</a> plugin. This plugin didn't suit my use case as I wanted the flexibility to occasionally choose tangential content that a similarity based algorithm may not select. I also found it valuable as a learning exercise to build this out myself rather than relying on a plugin.</p>\n<h2 class=\"markdown-subtitle\" id=\"existing-post-page\" style=\"position:relative;\"><a href=\"#existing-post-page\" aria-label=\"existing post page permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Existing Post Page</h2>\n<p class=\"markdown-para\">Before getting into adding Related Posts, let's briefly look at how a typical post page is built with Gatsby using the <a href=\"https://www.npmjs.com/package/gatsby-transformer-remark\" class=\"markdown-link\">gatsby-transformer-remark</a> plugin. If you already have a solid understanding of Gatsby and the remark plugin, feel free to skip ahead to the <a href=\"../gatsby-related-posts#adding-related-posts\" class=\"markdown-link\">adding related posts</a> section.</p>\n<p class=\"markdown-para\">This plugin allows you to write posts in markdown, and then exposes fields that it generates such as <code>html</code> and <code>excerpt</code> in the GraphQL server during development, under the node type <code>allMarkdownRemark</code>. It also exposes any frontmatter fields you add at the top of your markdown (content delimited by <code>--</code> symbols).</p>\n<p class=\"markdown-para\">For example, given the following project layout:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── README.md</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── gatsby-config.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── gatsby-node.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── package.json</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── src</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── components</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   │   ├── article.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   │   ├── footer.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   │   ├── header.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   │   ├── layout.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── markdown</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   │   ├── here-is-a-post.md</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   │   ├── another-post.md</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   │   ├── yet-another-post.md</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── pages</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   │   ├── index.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   ├── templates</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   │   ├── post.js</span></span></code></pre>\n<p class=\"markdown-para\">And some markdown content in <code>markdown/here-is-a-post.md</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"markdown\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">title</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">description</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;This is a sample description for the post.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">date</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;2022-02-15&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">category</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;example&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">featuredImage</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;../images/example.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.</span></span></span></code></pre>\n<p class=\"markdown-para\">The following GraphQL query would find this post and return all its data. Notice that all the fields in the markdown frontmatter can be exposed from the schema via <code>edges -> node -> frontmatter</code>. To execute queries in Gatsby during development, navigate to <a href=\"http://localhost:8000/___graphql\" class=\"markdown-link\">http://localhost:8000/___graphql</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    # limit results to only the example post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\"> } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # These fields come from the top of markdown/here-is-a-post.md</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">          # Images are a little more complicated, making use of gatsby-plugin-sharp and gatsby-transformer-sharp plugins.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              gatsbyImageData(</span><span class=\"mtk10 mtki\">width</span><span class=\"mtk1\">: </span><span class=\"mtk4\">900</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">layout</span><span class=\"mtk1\">:</span><span class=\"mtk4\"> CONSTRAINED</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # This is generated by the gatsby-transformer-remark plugin,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # which converts the markdown content to html.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">And here is the resulting JSON response from the GraphQL server. Notice that it pretty much mirrors the structure of the query, with the exception of being wrapped in a <code>data</code> object and the <code>featuredImage</code> field containing more details for rendering responsive images:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;allMarkdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for the post.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;featuredImage&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk9 mtki\">&quot;childImageSharp&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk9 mtki\">&quot;gatsbyImageData&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk9 mtki\">&quot;layout&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;constrained&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk9 mtki\">&quot;images&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      </span><span class=\"mtk9 mtki\">&quot;sources&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                          </span><span class=\"mtk9 mtki\">&quot;srcSet&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/static/67f.../71a10/example.webp 225w,</span><span class=\"mtk4\">\\n</span><span class=\"mtk12\">/static/67f.../901f1/example.webp 450w,</span><span class=\"mtk4\">\\n</span><span class=\"mtk12\">/static/67f.../5acd1/example.webp 900w&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                          </span><span class=\"mtk9 mtki\">&quot;type&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;image/webp&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                          </span><span class=\"mtk9 mtki\">&quot;sizes&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;(min-width: 900px) 900px, 100vw&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk9 mtki\">&quot;width&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">900</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk9 mtki\">&quot;height&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">599</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;html&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;&lt;p&gt;And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.&lt;/p&gt;...&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nWhile it's easy to understand how the frontmatter text fields are populated, the contents of featuredImage are more complicated. This is generated by some additional plugins that make the job of generating responsive images with Gatsby relatively easy. A full discussion of this topic is outside the scope of this post, but if you'd like to learn more about this, see the Gatsby docs on <a class=\"markdown-link\" href=\"https://www.gatsbyjs.com/docs/working-with-images/\">Working with Images</a>.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"retrieve-all-posts\" style=\"position:relative;\"><a href=\"#retrieve-all-posts\" aria-label=\"retrieve all posts permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Retrieve all Posts</h3>\n<p class=\"markdown-para\">We've just seen an example GraphQL query and JSON response to retrieve a single post. But for building a blog, all the posts must be retrieved, and then fed one at a time to the post template for rendering. This is performed by <code>gatsby-node.js</code>, a file that sits at the project root. It should export a <code>createPages</code> function, which the Gatsby build process will invoke.</p>\n<p class=\"markdown-para\">Notice the result handler invokes a Gatsby function <code>createPage</code>. This function receives an object specifying the <code>component</code>, which is the path to the template to be rendered, and a <code>context</code>, which can contain anything, but practically speaking will contain some results of the GraphQL query that has just resolved. In this case, we're passing in the post <code>slug</code>, which will then be available to the template to execute a GraphQL query to lookup details about just this <code>$slug</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// gatsby-node.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\">.</span><span class=\"mtk5\">createPages</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">graphql</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">actions</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// A Gatsby function which will be used to create the post pages from GraphQL data and a template.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { createPage } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> actions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// This gets ALL markdown posts, sorting by most recent date first.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// We only need to retrieve the slug so that the post template can use this</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// to lookup all the other content from in a page query (see next section).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        allMarkdownRemark(sort: { fields: [frontmatter___date], order: DESC }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    `</span><span class=\"mtk1\">).</span><span class=\"mtk5\">then</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">result</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result.data.allMarkdownRemark.edges.</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(({ </span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">createPage</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          path: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          component: path.</span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;./src/templates/post.js&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// any field provided here in context will be available to the post.js template</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// to be used in a page query to retrieve further details about this post.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          context: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            slug: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"post-template\" style=\"position:relative;\"><a href=\"#post-template\" aria-label=\"post template permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Post Template</h3>\n<p class=\"markdown-para\">The Post template, which is a React component, receives this JSON data as props and renders it. It does so by running a GraphQL page query at build time, using the <code>slug</code> field  provided to it by the <code>createPage</code> function implemented in <code>gatsby-node.js</code>. This query is doing the GraphQL equivalent of something like this SQL statement: <code>SELECT html, title, date... FROM markdown WHERE slug = $slug</code>.</p>\n<p class=\"markdown-para\">Somewhat confusingly, the page query is written <em class=\"markdown-emphasis\">after</em> the rendering code in the template. I'm going to focus in on just the query, and come back to the rendering code in a bit:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// This is called once for each markdown file from gatsby-node.js.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// The $slug paramter is available because of the context that was</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// passed in to the createPage function in gatsby-node.js.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">query</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">$slug</span><span class=\"mtk1\">: </span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    markdownRemark(</span><span class=\"mtk10 mtki\">fields</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">slug</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: $slug } }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gatsbyImageData(</span><span class=\"mtk10 mtki\">width</span><span class=\"mtk1\">: </span><span class=\"mtk4\">900</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">layout</span><span class=\"mtk1\">:</span><span class=\"mtk4\"> CONSTRAINED</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">`</span></span></span></code></pre>\n<p class=\"markdown-para\">Finally, the results of the page query are exposed to the Post component in its <code>props</code> via the <code>data</code> property. For example, the markdown html is available at <code>props.data.markdownRemark.html</code>, whereas the title is available at <code>props.data.markdownRemark.frontmatter.title</code>. The Post component extracts these properties and renders them using React.</p>\n<p class=\"markdown-para\">For example, this Post template renders the title, publish date, a featured image and html content generated from the markdown:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { GatsbyImage } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby-plugin-image&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> markdown </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> props.data.markdownRemark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> title </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> publishedDate </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> featuredImgFluid </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.featuredImage.childImageSharp.gatsbyImageData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> content </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">article</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;Published </span><span class=\"mtk7\">{</span><span class=\"mtk1\">publishedDate</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">GatsbyImage</span><span class=\"mtk1\"> </span><span class=\"mtk5\">image</span><span class=\"mtk7\">={</span><span class=\"mtk1\">featuredImgFluid</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">dangerouslySetInnerHTML</span><span class=\"mtk7\">={</span><span class=\"mtk1\">{ __html: content }</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">article</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">query</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">$slug</span><span class=\"mtk1\">: </span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">`</span></span></span></code></pre>\n<p class=\"markdown-para\">Now that we have an understanding of how a basic post page gets rendered from Markdown content in Gatsby, we can move on to enhancing this process with a Related Posts feature.</p>\n<aside class=\"markdown-aside\">\nIf this all seems like a lot of work to get a basic blog post up, it is! A full discussion of the pros and cons of various blogging solutions is outside the scope of this article, but suffice to say, if you like building things and especially love React, Gatsby is a great choice for a blog. However, if you just want to hit the ground publishing articles and not worry about building an entire website, including design, layout, search, SEO etc, then an online platform such as <a class=\"markdown-link\" href=\"https://medium.com/\">Medium</a> or <a class=\"markdown-link\" href=\"https://dev.to/\">dev.to</a> may be a better choice.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"adding-related-posts\" style=\"position:relative;\"><a href=\"#adding-related-posts\" aria-label=\"adding related posts permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding Related Posts</h2>\n<p class=\"markdown-para\">Probably the most important aspect to understand when adding a new feature to a Gatsby/Markdown site is that you can add anything you want to the frontmatter fields (top section of markdown file contained  within <code>---</code>). There's nothing special about the fields I've shown you so far such as <code>title</code>, <code>description</code>, etc.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"customizing-frontmatter\" style=\"position:relative;\"><a href=\"#customizing-frontmatter\" aria-label=\"customizing frontmatter permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Customizing Frontmatter</h3>\n<p class=\"markdown-para\">To demonstrate this, let's add a nonsense field that has nothing to do with blogging such as <code>favColor</code> to the example post shown earlier:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"markdown\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">title</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">description</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;This is a sample description for the post.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">date</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;2022-02-15&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">category</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;example&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">featuredImage</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;../images/example.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">favColor</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;purple&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.</span></span></span></code></pre>\n<p class=\"markdown-para\">Now let's modify the GraphQL query shown earlier that fetches this markdown post, to include the nonsense field <code>favColor</code>. I'm leaving out the generated <code>html</code> field and image field for simplicity:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    # limit results to only the example post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\"> } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # These fields come from the top of markdown/here-is-a-post.md</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          favColor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">And here is the result - notice the new field <code>favColor</code> in the results:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;allMarkdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for the post.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;favColor&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;purple&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Now that we've verified anything can be added to the frontmatter fields, let's add something useful.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"frontmatter-arrays\" style=\"position:relative;\"><a href=\"#frontmatter-arrays\" aria-label=\"frontmatter arrays permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Frontmatter Arrays</h3>\n<p class=\"markdown-para\">Another important concept to understand is the frontmatter field values are not limited to strings. An array value can be created by nesting a list of values with <code>-</code>. This is exactly what's needed to define a <code>related</code> field, as each markdown post will have three related posts.</p>\n<p class=\"markdown-para\">Here is the <code>markdown/here-is-a-post.md</code> markdown file, with the nonsense field <code>favColor</code> replaced with a <code>related</code> field containing an array value, which specifies the title of three other markdown posts:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"markdown\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">title</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">featuredImage</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;../images/example.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">description</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;This is a sample description for the post.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">date</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;2022-02-15&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">category</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;example&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">related</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk6\">&quot;Related Post 1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk6\">&quot;Related Post 2&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk6\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.</span></span></span></code></pre>\n<p class=\"markdown-para\">Now let's run a query to fetch the example post, this time including the new <code>related</code> array field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    # limit results to only the example post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\"> } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # These fields come from the top of markdown/here-is-a-post.md</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          related</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">And here are the results - notice that the <code>related</code> field contains an Array of strings, representing the titles of the related posts:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;allMarkdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for the post.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;related&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">&quot;Related Post 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">&quot;Related Post 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Assume there are an additional three markdown files titled \"Related Post 1\", 2 and 3 such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"markdown\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">title</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Related Post 1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">featuredImage</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;../images/example.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">description</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;This is a sample description for related post 1.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">date</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;2022-02-14&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">category</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;example&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"update-retrieval-of-all-posts\" style=\"position:relative;\"><a href=\"#update-retrieval-of-all-posts\" aria-label=\"update retrieval of all posts permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Update Retrieval of all Posts</h3>\n<p class=\"markdown-para\">Recall the post template contains a page query that queries for the current content using the <code>$slug</code> value that was passed in from <code>gatsby-node.js</code>. The template will also need to query for the related posts. In order for this information to be available, <code>gatsby-node.js</code> must be modified to include the <code>related</code> field when its fetching all posts, and then provide this as <code>context</code> to the post template:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// gatsby-node.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\">.</span><span class=\"mtk5\">createPages</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">graphql</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">actions</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// A Gatsby function which will be used to create the post pages from GraphQL data and a template.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { createPage } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> actions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// This gets ALL markdown posts, sorting by most recent date first.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ### NEW: Retrieve custom frontmatter field `related` here ###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        allMarkdownRemark(sort: { fields: [frontmatter___date], order: DESC }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                related</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    `</span><span class=\"mtk1\">).</span><span class=\"mtk5\">then</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">result</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result.data.allMarkdownRemark.edges.</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(({ </span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">createPage</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          path: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          component: path.</span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;./src/templates/post.js&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// any field provided here in context will be available to the post.js template</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// to be used in a page query to retrieve further details about this post.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          context: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            slug: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// ### NEW: Pass relatedPosts array to the template here ###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            relatedPosts: node.frontmatter.related</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"querying-for-multiple-results\" style=\"position:relative;\"><a href=\"#querying-for-multiple-results\" aria-label=\"querying for multiple results permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Querying for Multiple Results</h3>\n<p class=\"markdown-para\">The <a href=\"../gatsby-related-posts#post-template\" class=\"markdown-link\">post template</a>, will need to have its page query modified. In addition to querying for the specific markdown content to be displayed, now it must also query the <code>relatedPosts</code> field (provided by <code>gatsby-node.js</code>) to fetch each related posts title, featured image, and slug for linking.</p>\n<p class=\"markdown-para\">Up until now, the example queries I've been showing you have either retrieved all posts (as used by <code>gatsby-node.js</code>) or have retrieved just a single post using the GraphQL <code>eq</code> filter. But now, the post template must query for the related posts, which is an array of string post titles. Fortunately, GraphQL has an <code>in</code> <a href=\"https://www.gatsbyjs.com/docs/graphql-reference/#filter\" class=\"markdown-link\">filter</a> to do this. For example, the following query will fetch post information for the three related posts:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    # limit results to the specified posts using `in` filter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">in</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ] } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Here are the results. Notice that the <code>edges</code> array now contains multiple results, whereas previously when using the <code>eq</code> filter, it contained a list of only a single result:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;allMarkdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for related post 1.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-14&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for related post 2.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-13&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 3&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for related post 3.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-12&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"update-post-template-page-query\" style=\"position:relative;\"><a href=\"#update-post-template-page-query\" aria-label=\"update post template page query permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Update Post Template Page Query</h3>\n<p class=\"markdown-para\">Armed with all this knowledge, we can now update the <a href=\"../gatsby-related-posts#post-template\" class=\"markdown-link\">post template</a> page query to fetch each related post title, featured image, and slug for linking. There is no need to fetch the html content as the related posts only display an image and title. It will use the <code>in</code> filter as described in the previous section.</p>\n<p class=\"markdown-para\">Notice that the <code>query</code> now accepts two parameters - the <code>$slug</code> as before, and <code>$relatedPosts</code>, which is denoted as an array with <code>[String!]</code>. This is possible because earlier we modified the <a href=\"../gatsby-related-posts#update-retrieval-of-all-posts\" class=\"markdown-link\">retrieval of all posts</a> to provide this as context.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// This is called once for each markdown file from gatsby-node.js.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// $slug and $relatedPosts paramters are available because of the context that was</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// passed in to the createPage function in gatsby-node.js.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">query</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">$slug</span><span class=\"mtk1\">: </span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">$relatedPosts</span><span class=\"mtk1\">: [</span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">]</span><span class=\"mtk7\">!</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    markdownRemark(</span><span class=\"mtk10 mtki\">fields</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">slug</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: $slug } }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gatsbyImageData(</span><span class=\"mtk10 mtki\">width</span><span class=\"mtk1\">: </span><span class=\"mtk4\">900</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">layout</span><span class=\"mtk1\">:</span><span class=\"mtk4\"> CONSTRAINED</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">relatedP</span><span class=\"mtk1\">: allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">in</span><span class=\"mtk1\">: $relatedPosts } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                gatsbyImageData(</span><span class=\"mtk10 mtki\">width</span><span class=\"mtk1\">: </span><span class=\"mtk4\">270</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">height</span><span class=\"mtk1\">: </span><span class=\"mtk4\">150</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">layout</span><span class=\"mtk1\">:</span><span class=\"mtk4\"> FIXED</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">`</span></span></span></code></pre>\n<p class=\"markdown-para\">Notice that the new <code>relatedP</code> section is being defined as a sibling to the existing <code>markdownRemark</code> section. The resulting response object will still be wrapped in a <code>data</code> field as before, but will now contain both a <code>markdownRemark</code> field containing the current post content, and a <code>relatedP</code> section, containing an array of <code>edges</code>, representing the list of related posts. This is the power of GraphQL that you can define any structure you'd like the response object to have.</p>\n<p class=\"markdown-para\">Just to visualize the data that is now available to the page template, we can execute an example query that the template would be running for one specific post, leaving out the generated <code>html</code> and image fields for simplicity. Sorry about all the brackets, that's the syntax of the GraphQL filter:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  markdownRemark(</span><span class=\"mtk10 mtki\">fields</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">slug</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;/blog/here-is-a-post/&quot;</span><span class=\"mtk1\"> } }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">relatedP</span><span class=\"mtk1\">: allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">in</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ] } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the result of the above query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;markdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for the post.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;fields&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/here-is-a-post/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;relatedP&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;fields&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/related-post-1/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 2&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;fields&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/related-post-2/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;fields&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/related-post-3/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"update-post-template-jsx\" style=\"position:relative;\"><a href=\"#update-post-template-jsx\" aria-label=\"update post template jsx permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Update Post Template JSX</h3>\n<p class=\"markdown-para\">Now that we know the shape of the new data available to the post template from its page query, the template JSX can be updated to render it. Specifically, we will pass the data as props to a new <code>RelatedPosts</code> component (described in next section), to prevent the existing Post Template from getting too cluttered:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { GatsbyImage } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby-plugin-image&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ### NEW: Component to render related posts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> RelatedPosts </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/related-posts&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> markdown </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> props.data.markdownRemark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> title </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> publishedDate </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> featuredImgFluid </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.featuredImage.childImageSharp.gatsbyImageData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> content </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ### NEW: Extract related posts from page query</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> related </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> props.data.relatedP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">article</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;Published </span><span class=\"mtk7\">{</span><span class=\"mtk1\">publishedDate</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">GatsbyImage</span><span class=\"mtk1\"> </span><span class=\"mtk5\">image</span><span class=\"mtk7\">={</span><span class=\"mtk1\">featuredImgFluid</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">dangerouslySetInnerHTML</span><span class=\"mtk7\">={</span><span class=\"mtk1\">{ __html: content }</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">article</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">RelatedPosts</span><span class=\"mtk1\"> </span><span class=\"mtk5\">related</span><span class=\"mtk7\">={</span><span class=\"mtk1\">related</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">query</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">$slug</span><span class=\"mtk1\">: </span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">$relatedPosts</span><span class=\"mtk1\">: [</span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">]</span><span class=\"mtk7\">!</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">`</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"related-posts-component\" style=\"position:relative;\"><a href=\"#related-posts-component\" aria-label=\"related posts component permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Related Posts Component</h3>\n<p class=\"markdown-para\">The last step in the process is to define a <code>RelatedPosts</code> component. This component will iterate over the posts it receives as props from the post template page and render their titles and images as links, with the target of the link being the post slug:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/related-posts.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { GatsbyImage } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby-plugin-image&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">RelatedPosts</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">section</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;You may also like...&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">props.related.edges.</span><span class=\"mtk5\">map</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">post</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">key</span><span class=\"mtk7\">={</span><span class=\"mtk1\">post.node.id</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">={</span><span class=\"mtk1\">post.node.fields.slug</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk9 mtki\">GatsbyImage</span><span class=\"mtk1\"> </span><span class=\"mtk5\">image</span><span class=\"mtk7\">={</span><span class=\"mtk1\">post.node.frontmatter.featuredImage.childImageSharp.gatsbyImageData</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">post.node.frontmatter.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ))</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">section</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> RelatedPosts</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered the basics of building blog post pages using Gatsby and the <a href=\"https://www.npmjs.com/package/gatsby-transformer-remark\" class=\"markdown-link\">gatsby-transformer-remark</a> plugin and how to modify the process to add a related posts feature. This involves customizing the markdown frontmatter to include an array of post titles that are related to the current post, modifying the outer query run by the <code>gatsby-node.js</code> build process to pass the related content to the post template, then modifying the post template query and rendering to retrieve and render the related posts.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/gatsby-related-posts/"}}},{"node":{"id":"ee62db41-d335-5e83-a05c-da0ea1ec621c","frontmatter":{"title":"Nomad Tips and Tricks","date":"January 2022","category":"devops"},"excerpt":"I've been working on a platform migration project to containerize and move several web applications and associated services from a home…","html":"<p class=\"markdown-para\">I've been working on a platform migration project to containerize and move several web applications and associated services from a home grown system to Hashicorp's <a href=\"https://www.nomadproject.io/\" class=\"markdown-link\">Nomad</a>. Nomad is a workload orchestration tool designed to make it (relatively) easy to deploy, manage and scale containers on private and public clouds. It's <a href=\"https://www.nomadproject.io/docs/nomad-vs-kubernetes\" class=\"markdown-link\">comparable</a> to Kubernetes, but focuses on a smaller scope, delegating features including discovery and secrets management to other tools such as <a href=\"https://www.consul.io/\" class=\"markdown-link\">Consul</a> and <a href=\"https://www.vaultproject.io/\" class=\"markdown-link\">Vault</a>, while providing integration with these. It's also newer than Kubernetes.</p>\n<p class=\"markdown-para\">One of the challenges in working with a newer platform is a smaller community, and finding online help. Many of my web searches lead to the official Nomad docs. While they are well written, if I'm doing a search, it's because I couldn't find the solution the docs. In the spirit of increasing the body of online knowledge, this post will share a few tips and tricks I've picked up going through this migration.</p>\n<aside class=\"markdown-aside\">\nThis post assumes some working knowledge of Hashicorp's Nomad. If you haven't used it before, checkout this excellent <a class=\"markdown-link\" href=\"https://adri-v.medium.com/just-in-time-nomad-80f57cd403ca\">primer</a> and <a class=\"markdown-link\" href=\"https://adri-v.medium.com/just-in-time-nomad-running-traefik-on-hashiqube-7d6dfd8ef9d8\">tutorial</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"job-specification\" style=\"position:relative;\"><a href=\"#job-specification\" aria-label=\"job specification permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Job Specification</h2>\n<p class=\"markdown-para\">The first set of tips are for working with the job specification file (aka jobspec). This is a declarative way of telling Nomad about your application and its resource requirements. The jobspec file is written in <a href=\"https://github.com/hashicorp/hcl\" class=\"markdown-link\">HCL</a>, which stands for Hashicorp Configuration Language.</p>\n<p class=\"markdown-para\">Although it can be irritating when tools require learning a framework-specific (i.e. non portable) language, HCL is similar enough to JSON and YAML that anyone familiar with these will pick it up easily. In fact, if JSON and YAML had a baby it might look something like HCL.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"increase-docker-pull-timeout\" style=\"position:relative;\"><a href=\"#increase-docker-pull-timeout\" aria-label=\"increase docker pull timeout permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Increase Docker Pull Timeout</h3>\n<p class=\"markdown-para\">When using the <a href=\"https://www.nomadproject.io/docs/drivers/docker\" class=\"markdown-link\">Docker driver</a> to run a task, the Nomad client on which the task is running will first pull the Docker image from the specified location. This can be from Docker Hub, Github Container Registry, or a private Docker registry. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;webapp&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">But what happens if there's a networking issue resulting in a longer than usual amount of time to pull the image? In this case, Nomad will timeout the docker pull after 5 minutes and restart according to the <code>restart</code> stanza. If the networking issues are not resolved, the job will eventually fail.</p>\n<p class=\"markdown-para\">To avoid having the job fail when docker pull is taking longer than usual, use the <code>image_pull_timeout</code> property of the docker <code>config</code> stanza to override Nomad's default timeout. For example, to increase it to 10 minutes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image_pull_timeout</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;10m&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"reuse-docker-tag-for-development\" style=\"position:relative;\"><a href=\"#reuse-docker-tag-for-development\" aria-label=\"reuse docker tag for development permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reuse Docker Tag for Development</h3>\n<p class=\"markdown-para\">When using Docker to run a Nomad task, the Nomad client will use a cached image if the image:tag specified in the docker driver config stanza of the jobspec has already been pulled. However, during development, you may be making changes to a dev version of the Docker image and re-using the same tag.</p>\n<p class=\"markdown-para\">For example when developing a new feature, I'll switch to a git feature branch on my laptop, build an image tagged with the feature branch name, push it to the container registry, and deploy it to the Nomad dev environment (we use multiple <a href=\"https://learn.hashicorp.com/tutorials/nomad/namespaces\" class=\"markdown-link\">namespaces</a> to isolate dev, staging, and production environments). In this case, I don't want Nomad to use the cached image from my last deploy, but to always pull a \"fresh\" version of the image. This can be accomplished using <code>force_pull</code> as shown below:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:my-feature&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">force_pull</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"always-deploy-a-new-job-version\" style=\"position:relative;\"><a href=\"#always-deploy-a-new-job-version\" aria-label=\"always deploy a new job version permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Always deploy a new job version</h3>\n<p class=\"markdown-para\">The command to deploy a new version of a job is <code>nomad job run path/to/nomad/jobspec</code>. However, if nothing has changed in the jobspec file since the last deploy, then Nomad will not take any action. This is fine for production where there will be a new Docker image tag (we use the main line git commit sha) for each deploy, which effectively changes the contents of the Nomad file, thus triggering a new deploy.</p>\n<p class=\"markdown-para\">But for development, we use the same image tag (branch name) so Nomad thinks nothing has changed, even if the image has been updated. Even the <code>force_pull</code> explained in the previous section won't help because Nomad won't get as far as evaluating the jobspec file.</p>\n<p class=\"markdown-para\">To force Nomad to always run a deploy, use a <a href=\"https://www.nomadproject.io/docs/job-specification/meta\" class=\"markdown-link\">meta</a> stanza that is populated with the return value from a uuid function that always generates a unique value. The <code>meta</code> stanza allow user-defined arbitrary key-value pairs. Nomad is written in Golang and so Go functions such as <code>uuidv4()</code> can be interpolated in the Nomad file as shown below. The <code>meta</code> stanza should be placed directly in the <code>job</code> stanza:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">meta</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">run_uuid</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">uuidv4</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"resiliency\" style=\"position:relative;\"><a href=\"#resiliency\" aria-label=\"resiliency permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resiliency</h3>\n<p class=\"markdown-para\">This one is not so much a tip, rather a summary of important stanzas in the jobspec file. One of the many benefits of using an orchestration tool like Nomad is it can handle updates and failures gracefully without manual intervention. In order to take advantage of these features, you must understand and make use of the following stanzas in the job spec file.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/update\" class=\"markdown-link\">update</a> Specifies update strategy Nomad uses when deploying a new version of the task group. i.e. when <code>nomad job run path/to/jobspec</code> is run. For example, perform rolling updates 3 at a time and wait until all tasks for an allocation are running and their Consul health checks are passing for at least 10 seconds before considering the allocation healthy.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/restart\" class=\"markdown-link\">restart</a> Specifies strategy for Nomad to restart failed tasks on the same nomad client. For example, if the application server has crashed, attempt 2 restarts within 30 minutes, delay 15s between each restart, and don't try anymore restarts after those are exhausted.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/check_restart\" class=\"markdown-link\">check_restart</a> Specifies how Nomad should restart a task that is not yet failing, but has become unresponsive or otherwise unhealthy. Works together with Consul health checks. Nomad restarts tasks when a health check has failed. For example, restart the Redis task after its health check has failed 3 consecutive times, and wait 90 seconds after restarting the task to resume health checking.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/reschedule\" class=\"markdown-link\">reschedule</a> This handles the case where the specified number of restarts have been attempted and the task still isn't running. This suggests the issue could be with the Nomad client such as a hardware failure or kernel deadlock. The <code>reschedule</code> stanza is used to specify details for rescheduling a failing task to another nomad client. For example, reschedule the task group an unlimited number of times and increase the delay between subsequent attempts exponentially, with a starting delay of 30 seconds up to a maximum of 1 hour.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/migrate\" class=\"markdown-link\">migrate</a> When a Nomad client needs to come out of service, it gets marked for draining and tasks will no longer be scheduled on it. Then Nomad will migrate all existing jobs to other clients. The <code>migrate</code> stanza specifies the strategy for migrating tasks off of draining nodes. For example, migrate one allocation at a time, and mark migrated allocations healthy once all their tasks are running and associated health checks are passing for 10 seconds or more within a 5 minute deadline.</p>\n<p class=\"markdown-para\">For further details on how these stanzas are used with examples, I recommend these blog posts from Hashicorp's site:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://www.hashicorp.com/blog/resilient-infrastructure-with-nomad-restarting-tasks\" class=\"markdown-link\">Building Resilient Infrastructure: Restarting Tasks</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.hashicorp.com/blog/resilient-infrastructure-with-nomad-scheduling\" class=\"markdown-link\">Building Resilient Infrastructure: Scheduling</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.hashicorp.com/blog/building-resilient-infrastructure-with-nomad-job-lifecycle\" class=\"markdown-link\">Building Resilient Infrastructure: Job Lifecycle</a></li>\n</ul>\n<h3 class=\"markdown-sub-subtitle\" id=\"prestart-hook-for-one-time-initialization\" style=\"position:relative;\"><a href=\"#prestart-hook-for-one-time-initialization\" aria-label=\"prestart hook for one time initialization permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prestart hook for one-time initialization</h3>\n<p class=\"markdown-para\">An application may have some one-time initialization task that needs to be completed before the main application can start. For example, before starting a Rails app, the database migrations should be run. This can be accomplished in Nomad using the <a href=\"https://www.nomadproject.io/docs/job-specification/lifecycle\" class=\"markdown-link\">lifecycle</a> stanza.</p>\n<p class=\"markdown-para\">The idea is, you would have multiple tasks within a group, let's say one task to start the Rails app, and another to run the database migrations. For the migration task, you define the lifecycle hook to be <code>prestart</code>, to indicate the db migrations should run <em class=\"markdown-emphasis\">before</em> the Rails task is started. You would also set <code>sidecar</code> to false, to indicate that this task will start and finish before the main task is started. Setting <code>sidecar</code> to true would make the task run for the duration of the main task, which might be desirable for something like a logging agent.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;dbmigrate&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># The dbmigrate task will run BEFORE the puma task in this group.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">lifecycle</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">hook</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;prestart&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">sidecar</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec rake db:migrate&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;puma&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec puma&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"nomad-environment-variables\" style=\"position:relative;\"><a href=\"#nomad-environment-variables\" aria-label=\"nomad environment variables permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nomad Environment Variables</h3>\n<p class=\"markdown-para\">Nomad ships with a number of <a href=\"https://www.nomadproject.io/docs/runtime/environment\" class=\"markdown-link\">environment variables</a> that are available in the job file <em class=\"markdown-emphasis\">and</em> in any command/scripts that are run in Docker containers as part of the job.</p>\n<p class=\"markdown-para\">Here's an example of using <code>NOMAD_ALLOC_INDEX</code> in a script that runs database migrations, to ensure that it only runs once, when located in a task group that runs multiple instances (specified using <code>count</code> parameter of the <code>group</code> stanza).</p>\n<p class=\"markdown-para\">Here's a modified version of the jobspec from the previous example that introduced the prestart hook:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Will launch 3 instances of the &quot;web&quot; group.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># count parameter can only be specified at the group level.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">count</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># But the database migrations should only run once.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Notice the use of a command script where we will</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># write some custom logic using env var NOMAD_ALLOC_INDEX</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;dbmigrate&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">lifecycle</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">hook</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;prestart&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">sidecar</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;registry/image:tag&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/usr/bin/run-db-migrations&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;puma&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;registry/image:tag&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec puma&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Where <code>/usr/bin/run-db-migrations</code> is a custom script that is added to the Docker image. It checks the value of the <code>NOMAD_ALLOC_INDEX</code> environment variable. Database migrations will only be run when this is <code>z0</code>, the first allocation, and will not be run for any others.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;z</span><span class=\"mtk1\">$NOMAD_ALLOC_INDEX</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">==</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;z0&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  RAILS_ENV=production bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rake db:migrate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">fi</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"replace-cron-jobs\" style=\"position:relative;\"><a href=\"#replace-cron-jobs\" aria-label=\"replace cron jobs permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Replace Cron Jobs</h3>\n<p class=\"markdown-para\">If your application also has cron jobs, these can easily be replaced with Nomad's <a href=\"https://www.nomadproject.io/docs/job-specification/periodic\" class=\"markdown-link\">periodic</a> jobs. For example, given the following crontab for a job that runs daily at 10:30:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">30 10 * * * nobody bundle exec rake app:some_daily_task</span></span></code></pre>\n<p class=\"markdown-para\">It can be replaced with the following jobspec:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;cron_daily&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;30 10 * * *&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;daily&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;daily&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">   </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;RAILS_ENV=production bundle exec rake app:some_daily_task&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">One challenge with cron jobs, especially for those that run frequently, is how to prevent the next instance of the job from launching, if the previous instance is still running. This can be be <a href=\"https://serverfault.com/questions/82857/prevent-duplicate-cron-jobs-running\" class=\"markdown-link\">tricky</a> to solve with cron, but with Nomad, this can be solved by adding the <code>prohibit_overlap</code> overlap to the <code>periodic</code> stanza.</p>\n<p class=\"markdown-para\">Here's an example of this property for a job that runs every minute:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;cron_frequent_task&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;* * * * *&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">prohibit_overlap</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;frequent&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frequent&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">   </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;RAILS_ENV=production bundle exec rake app:frequent_task&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIf you have a lot of cron jobs to convert to Nomad, it can be tedious to write up all the jobspec files by hand. See my post on <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/convert-multiple-cron-jobs-to-nomad-periodic-jobs/\">Migrating Cron Jobs to Nomad the Lazy Way</a> for an easy way to do this.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"turn-off-auto-restart\" style=\"position:relative;\"><a href=\"#turn-off-auto-restart\" aria-label=\"turn off auto restart permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Turn off auto restart</h3>\n<p class=\"markdown-para\">One of the many fantastic features of Nomad is integration with Vault for secrets management. From a jobspec file, you can read in secrets from Vault, and have them loaded as environment variables in the application. Without a platform managing this, if an environment variable is changed, the application must manually be restarted to pick up the new value. With Nomad's Vault integration, any change to a secret in Vault will cause all jobs that use this secret to automatically be restated.</p>\n<p class=\"markdown-para\">However, there may be times where this is undesirable. One such case is for cron jobs (called periodic jobs in Nomad). For example, the application I'm working on has an autorenew cron job that picks up all subscriptions that are due for renewal and renews them, which includes billing the customer and sending a confirmation email. We would not want this job stopped in the middle and restarted just because a setting had been changed, it would be better for the job to complete and have the change be picked up next time the job runs.</p>\n<p class=\"markdown-para\">In order to implement this behaviour, set <code>change_mode = \"noop\"</code> in the <code>template</code> stanza that reads in the secrets (default is <code>restart</code>):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;autorenew&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;autorenew&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;autornew&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">destination</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;secrets/local.env&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">env</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">change_mode</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;noop&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">data</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> &lt;&lt;EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">API_KEY=&quot;{{with secret &quot;secret/data/api-key&quot;}}{{.Data.value}}{{end}}&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>destination</code> file is still updated when the secrets change and so the updated value will be used the next time the cron job is scheduled.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"populate-environment-variables-from-vault\" style=\"position:relative;\"><a href=\"#populate-environment-variables-from-vault\" aria-label=\"populate environment variables from vault permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Populate Environment Variables from Vault</h3>\n<p class=\"markdown-para\">As mentioned in the previous section, Nomad integrates with Vault for secrets management, which can be used to set environment variables for the containerized application that Nomad is running as a task. This is accomplished with the <a href=\"https://www.nomadproject.io/docs/job-specification/template\" class=\"markdown-link\">template</a> stanza. This stanza has a few parameters. Most significant is the <code>data</code>  parameter which can take either a single line string, or multi-line using a heredoc. This string is written using a <a href=\"https://learn.hashicorp.com/tutorials/nomad/go-template-syntax\" class=\"markdown-link\">Go template</a> and is one of the least intuitive aspects of Nomad.</p>\n<p class=\"markdown-para\">Let's start with a simple example. Suppose the application has a single secret such as DB_PASSWORD that the application expects to be provided as an environment variable to connect to the database. Given that the <a href=\"https://learn.hashicorp.com/tutorials/vault/getting-started-install?in=vault/getting-started\" class=\"markdown-link\">Vault CLI</a> has been installed and configured, the database password would be persisted in Vault as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault kv put kv/secret/config DB_PASSWORD=veryverysecretpassword</span></span></span></code></pre>\n<p class=\"markdown-para\">Then the following jobspec would read in this secret (when being deployed by Nomad) and expose it as an environment variable to the application:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">type</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;service&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Here is where the Vault integration happens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># result of data template will be populated in this file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">destination</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;secrets/file.env&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># all key/value pairs read will be exposed as environment variables to the frontend task</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">env</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># read secret from Vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">data</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> &lt;&lt;EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{with secret &quot;kv/secret/config&quot;}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">DB_PASSWORD={{.Data.data.DB_PASSWORD | toJSON}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{end}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">If you're thinking \"whaaaat the heck is that data thing???\", don't worry. Like I mentioned earlier, this part of Nomad is not very intuitive. While a full coverage of the <a href=\"https://learn.hashicorp.com/tutorials/nomad/go-template-syntax\" class=\"markdown-link\">template syntax</a> is out of scope for this post, here's a brief explanation of what's going on:</p>\n<p class=\"markdown-para\">The <code>&#x3C;&#x3C;IDENTIFIER ... IDENTIFIER</code> denotes the beginning and end of the heredoc, which is a multiline template string. Think of the content in the heredoc as a function that outputs some value. Whatever is output will get written to the <code>destination</code> file, which is <code>secrets/file.env</code> in the above example.</p>\n<p class=\"markdown-para\">Any plain string literals such as <code>DB_PASSWORD</code> will get output exactly as they appear.</p>\n<p class=\"markdown-para\">Anything between double curly braces <code>{{ ... }}</code> represents a dynamic portion of the template, these contain actions.</p>\n<p class=\"markdown-para\"><code>with</code> is an action that redefines the context available to the template. I couldn't find a good explanation of what <code>with secret</code> does but from observation, it reads in the secret stored in Vault at the given location (<code>kv/secret/config</code> in the above example). Now the value from Vault can be traversed using <code>.Data.data.DB_PASSWORD</code>. The reason for <code>.Data.data</code> has to do with how Vault stores the data.</p>\n<p class=\"markdown-para\">The pipe symbol <code>|</code> is used to chain together one or more commands. Since the database password could contain special characters, it's recommended to run all values extracted from Vault through the <code>toJSON</code> function to ensure they're properly parsed.</p>\n<p class=\"markdown-para\">The result of all this is the following contents written to the destination file <code>secrets/file.env</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">DB_PASSWORD=veryverysecretpassword</span></span></code></pre>\n<p class=\"markdown-para\">And if you were to shell in the container (next section on Nomad CLI will explain how to do that) and run <code>env</code>, the <code>DB_PASSWORD</code> environment variable would be listed.</p>\n<p class=\"markdown-para\">Well that's all well and good for a single environment variable, but what if your application has many environment variables? For example, it could be using multiple databases, and integrate with third party services for transactional email, marketing campaigns, payment provider etc., all of which require configuring secrets.</p>\n<p class=\"markdown-para\">Of course you could populate multiple key/value pairs in Vault like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault kv put kv/secret/config DB_PASSWORD=veryverysecretpassword OTHER_DB_PASSWORD=anothersecret EMAIL_PROVIDER_API_KEY=abc123...</span></span></span></code></pre>\n<p class=\"markdown-para\">And update the template data with a row for each secret.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">destination</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;secrets/file.env</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        env = true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        # read multiple secrets from Vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        data = &lt;&lt;EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{with secret &quot;</span><span class=\"mtk1\">kv/secret/config</span><span class=\"mtk6\">&quot;}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">DB_PASSWORD={{.Data.data.DB_PASSWORD | toJSON}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">OTHER_DB_PASSWORD={{.Data.data.OTHER_DB_PASSWORD | toJSON}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">EMAIL_PROVIDER_API_KEY={{.Data.data.EMAIL_PROVIDER_API_KEY | toJSON}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{end}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The problem  with this is the <code>template</code> stanza will get quite lengthy. Also maintenance becomes an issue because the <code>template</code> stanza can only be placed in the <code>task</code> stanza. So if the jobspec has multiple groups/tasks, the lengthy template needs to occur in all of them, and if a new secret is added, multiple template stanzas need to be updated.</p>\n<p class=\"markdown-para\">Fortunately there's a more efficient way to do this. It involves populating Vault with a JSON file rather than individual key/value pairs. Then using the <code>range</code> action in the template stanza, to iterate over the key/value map from Vault, and dynamically create all environment variables from the json that was loaded in Vault.</p>\n<p class=\"markdown-para\">To start, create a json file with all the secrets, this is just temporary and can be deleted after its loaded into Vault. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"># data.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;DB_PASSWORD&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;veryverysecretpassword&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;OTHER_DB_PASSWORD&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;anothersecret&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;EMAIL_PROVIDER_API_KEY&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;abc123&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Run the following command to load this file into Vault:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault kv put kv/secret/config @data.json</span></span></span></code></pre>\n<p class=\"markdown-para\">Update the template stanza in the jobspec to use the <code>range</code> action to iterate over each key/value pair in Vault. Since the value being read from Vault is a map, two variables <code>$key</code> and <code>$value</code> can be assigned with the result of each key/value pair, i.e. environment variable and its value. These then get written out with a literal equals sign <code>=</code> between them, with the value being piped through the <code>toJSON</code> function as explained previously:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">destination</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;secrets/file.env</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        env = true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        # read multiple secrets from Vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        data = &lt;&lt;EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{with secret &quot;</span><span class=\"mtk1\">kv/hover/config</span><span class=\"mtk6\">&quot;}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{range $key, $value := .Data.data}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{$key}}={{$value | toJSON}}{{end}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{end}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">After this job is deployed, the destination file <code>secrets/file.env</code> will be populated as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">DB_PASSWORDveryverysecretpassword</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">OTHER_DB_PASSWORDanothersecret</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">EMAIL_PROVIDER_API_KEYabc123</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"nomad-cli\" style=\"position:relative;\"><a href=\"#nomad-cli\" aria-label=\"nomad cli permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nomad CLI</h2>\n<p class=\"markdown-para\">This next section contains tips on working with the Nomad CLI. Follow the <a href=\"https://www.nomadproject.io/docs/install\" class=\"markdown-link\">instructions</a> for your OS to install it. Although Nomad does have a Web UI to display jobs, their status, and allocations among many other things, it's usually more convenient to use the CLI to get this information.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"validation\" style=\"position:relative;\"><a href=\"#validation\" aria-label=\"validation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Validation</h3>\n<p class=\"markdown-para\">For a new jobspec file, or if you've made changes to an existing one, you'll want to validate it first, before submitting it to Nomad for deployment. This will provide quick feedback if there are any errors in the file.</p>\n<p class=\"markdown-para\">For example, given the following jobspec:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># example.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;us-west-1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">type</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;service&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;hashicorp/web-frontend&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">ports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;http&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;https&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">It can be validated as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job validate example.nomad</span></span></code></pre>\n<p class=\"markdown-para\">Output from the validate command shows validation passed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Job Warnings:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0 warning(s):</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Job validation successful</span></span></code></pre>\n<p class=\"markdown-para\">As an exercise, we can intentionally break this, suppose the job had specified <code>type = \"services\"</code> instead of <code>service</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># example.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;us-west-1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">type</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;services&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;hashicorp/web-frontend&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">ports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;http&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;https&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">This time the result of running the validation command <code>nomad job validate example.nomad</code> yields an error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Job validation errors:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1 error occurred:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t* Invalid job type: &quot;services&quot;</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"allocation-status\" style=\"position:relative;\"><a href=\"#allocation-status\" aria-label=\"allocation status permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Allocation Status</h3>\n<p class=\"markdown-para\">After deploying a job (<code>nomad job run /path/to/jobspec_file</code>), the output of this command may indicate that it's complete, but it's possible that some tasks may have failed to start. In order to get more insight into this, you'll want to query the job and <em class=\"markdown-emphasis\">allocation</em> status.</p>\n<p class=\"markdown-para\">Before showing the CLI command for allocation status, let's take a brief detour to define it. An allocation is how Nomad declares that some tasks in a given job should be run on a particular node, aka Nomad client machine.</p>\n<p class=\"markdown-para\">All of the jobspec examples so far have shown a single task, but you can actually have multiple tasks within a group, and multiple groups within a job. Putting multiple tasks within the same group tells Nomad that you want all those tasks running on the same Nomad client machine. Having one task per group and multiple groups within a job tells Nomad that it's free to allocate each task group to separate Nomad clients (although it could still choose to allocate them to the same client, pending resource utilization).</p>\n<p class=\"markdown-para\">For example, suppose you submit the following jobspec to run a Rails app including 3 Puma servers and Sidekiq for background job processing:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># railsapp.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;rails-app&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;us-west-1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">type</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;service&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">count</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;puma&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec puma&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;background&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;sidekiq&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec sidekiq&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">After submitting the job via <code>nomad job run railsapp.nomad</code>, the console output will show that submission is complete. But to check whether things are actually working, first check the job status:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job status rails-app</span></span></code></pre>\n<p class=\"markdown-para\">The last portion of this output will show the allocations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Allocations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ID        Node ID   Task Group  Version  Desired  Status   Created   Modified</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">dac34c14  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">df7e2471  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">26002bd0  2008ce70  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fa2b2ed6  4163a6ca  background   1       run      running  1d6h ago  1d6h ago</span></span></code></pre>\n<p class=\"markdown-para\">There are 4 allocations - 3 are for the <code>web</code> group because the jobspec indicated a <code>count</code> property of 3 for these, and 1 for the <code>background</code> group because this jobspec only indicated 1 sidekiq process (the <code>count</code> property defaults to 1).</p>\n<p class=\"markdown-para\">In the previous example, all allocations were successfully started, but sometimes you may see the status as <code>failed</code>. In this case, you can inspect the allocation to investigate by passing the allocation ID (first column of previous output) to the <code>nomad alloc status</code> command. For example, to inspect the first <code>web</code> allocation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad alloc status dac34c14</span></span></code></pre>\n<p class=\"markdown-para\">The output will include events that happened during this allocation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Task &quot;puma&quot; is &quot;running&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Task Events:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Started At     = 2021-12-17T19:28:21Z</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Finished At    = N/A</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Total Restarts = 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Last Restart   = N/A</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Recent Events:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Time                       Type        Description</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-17T14:28:21-05:00  Started     Task started by client</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-17T14:28:19-05:00  Driver      Downloading image</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-17T14:28:18-05:00  Task Setup  Building Task Directory</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-17T14:28:14-05:00  Received    Task received by client</span></span></code></pre>\n<p class=\"markdown-para\">If something went wrong such as the Nomad client could not download the Docker image, the error would be shown in the events.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Bonus:</strong> The Nomad CLI supports tab completion. Simply run <code>nomad -autocomplete-install</code> to enable it.</p>\n<p class=\"markdown-para\">For example, given a list of allocations displayed from the <code>nomad status rails-app</code> command:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Allocations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ID        Node ID   Task Group  Version  Desired  Status   Created   Modified</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">dac34c14  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">df7e2471  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">26002bd0  2008ce70  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fa2b2ed6  4163a6ca  background   1       run      running  1d6h ago  1d6h ago</span></span></code></pre>\n<p class=\"markdown-para\">You can type in <code>nomad alloc status da{TAB}</code> and Nomad will fill in the allocation ID to complete the command.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"run-a-shell-in-container\" style=\"position:relative;\"><a href=\"#run-a-shell-in-container\" aria-label=\"run a shell in container permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Run a shell in container</h3>\n<p class=\"markdown-para\">Sometimes you'll want to shell into a running container to troubleshoot something. For example, to check whether the expected environment variables were properly populated from Vault secrets, or whether you can ping a certain host if having some networking issues. This can be done with the <code>nomad alloc exec</code> command, passing in the task name and allocation id.</p>\n<p class=\"markdown-para\">To launch a shell in the sidekiq container from the previous example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task sidekiq fa2b2ed6 /bin/bash</span></span></span></code></pre>\n<p class=\"markdown-para\">Tab completion still works here for the allocation ID.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"run-a-command-in-container\" style=\"position:relative;\"><a href=\"#run-a-command-in-container\" aria-label=\"run a command in container permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Run a command in container</h3>\n<p class=\"markdown-para\">Taking it one step further, you might want to run a specific command from a shell in the container. For example, with a Rails app, a common troubleshooting technique is to launch a Rails console and run some application code.</p>\n<p class=\"markdown-para\">The two step way to do this is to run a shell as before, then type in your command from within the shell, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task puma fa2b2ed6 /bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">root@725b3752ada5: bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rails c</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># do rails console things...</span></span></span></code></pre>\n<p class=\"markdown-para\">Shorten this to one step with the <code>-c</code> flag to pass a command to the shell:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task puma fa2b2ed6 /bin/bash -c </span><span class=\"mtk6\">&quot;bundle exec rails c&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Tab completion still works here for the allocation ID.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"node-status\" style=\"position:relative;\"><a href=\"#node-status\" aria-label=\"node status permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Node Status</h3>\n<p class=\"markdown-para\">Recall the list of allocations that were displayed from the <code>nomad job status rails-app</code> command:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Allocations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ID        Node ID   Task Group  Version  Desired  Status   Created   Modified</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">dac34c14  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">df7e2471  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">26002bd0  2008ce70  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fa2b2ed6  4163a6ca  background   1       run      running  1d6h ago  1d6h ago</span></span></code></pre>\n<p class=\"markdown-para\">We've been looking at the allocations, but you can also get more information about the node (aka Nomad client machine) that the allocation is running on. This is done by passing the Node ID (second column in the Allocations table) to the <code>nomad node status</code> command. In the above table, we can see that two of the <code>web</code> task groups and the <code>background</code> group are running on the same node, whereas the third <code>web</code> group got allocated to a different node.</p>\n<p class=\"markdown-para\">To get information about the node that's running the two web and background groups:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad node status 4163a6ca</span></span></code></pre>\n<p class=\"markdown-para\">This displays a lot of output, just going to highlight a few things. The Node Events can be useful for troubleshooting, for example if the node is no longer able to connect to the docker daemon. In the example below, it was able to recover:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Node Events</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Time                  Subsystem       Message</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-06T18:49:11Z  Cluster         Node re-registered</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-06T18:42:08Z  Cluster         Node heartbeat missed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-03T23:07:31Z  Driver: docker  Healthy</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-03T23:04:01Z  Driver: docker  Failed to connect to docker daemon</span></span></code></pre>\n<p class=\"markdown-para\">The output also shows cpu and memory resources that are allocated on this node and how much is currently being used:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Allocated Resources</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CPU              Memory         Disk</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">36988/36784 MHz  32 GiB/31 GiB  2.1 GiB/93 GiB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Host Resource Utilization</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CPU            Memory          Disk</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">889/36784 MHz  4.8 GiB/31 GiB  110 MiB/98 GiB</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"job-version---whats-changed\" style=\"position:relative;\"><a href=\"#job-version---whats-changed\" aria-label=\"job version   whats changed permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Job Version - What's Changed?</h3>\n<p class=\"markdown-para\">Every time you run <code>nomad job run /path/to/jobspec</code>, Nomad will create a new version of the job. It can be useful to know what was changed between versions.</p>\n<p class=\"markdown-para\">The following command will display the complete version history for a job:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job history -p job_name</span></span></code></pre>\n<p class=\"markdown-para\">However, if there have been a lot of deploys, the output of this can be too verbose. It's also possible to get history for just one specific version number, which will show the diff between that version and the previous version.</p>\n<p class=\"markdown-para\">For example, the <code>rails-app</code> job from the previous section has 50 versions. To see the difference between version 50 and 49 that came before it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job history -version 50 -p rails-app</span></span></code></pre>\n<p class=\"markdown-para\">The sample output below shows that the <code>sidekiq</code> task in the <code>background</code> group had its memory increased from 2GB to 8GB:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Version     = 50</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Stable      = true</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Submit Date = 2021-12-17T14:27:22-05:00</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Diff        =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+/- Job: &quot;rails-app&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+/- Task Group: &quot;background&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  +/- Task: &quot;sidekiq&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    +/- Resources {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      +/- MemoryMB:    &quot;2048&quot; =&gt; &quot;8192&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          MemoryMaxMB: &quot;0&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"aliases-and-bash-functions\" style=\"position:relative;\"><a href=\"#aliases-and-bash-functions\" aria-label=\"aliases and bash functions permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Aliases and Bash Functions</h3>\n<p class=\"markdown-para\">Here are a few aliases and shell functions I use to save myself typing for the most frequently run Nomad CLI commands.</p>\n<p class=\"markdown-para\">Get status for the main web app <code>rails-app</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># change the alias value for something easy to remember for your job</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">alias</span><span class=\"mtk1\"> nsra=</span><span class=\"mtk6\">&quot;nomad status rails-app&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Get allocation status:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># usage nas {alloc id}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">alias</span><span class=\"mtk1\"> nas=</span><span class=\"mtk6\">&quot;nomad alloc status&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Tab complete will work with the alias, for example, if first few characters of the allocation ID are <code>4d</code>, then type: <code>nas 4d{TAB}</code></p>\n<p class=\"markdown-para\">The other commands I use most frequently are to run a shell, and Rails console in a container. An alias won't work here as the allocation ID occurs in the middle of the command, and AFAIK, aliases don't support variables. However, this can be solved with shell functions.</p>\n<p class=\"markdown-para\">Add the following functions to your bash or zsh profile. Replace the task names with the values from your jobspec file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run bash in the Nomad puma container specified by allocation id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Usage: nab alloc_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">nab</span><span class=\"mtk1\"> () { nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task puma $@ /bin/bash }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run a Rails console in the Nomad puma container specified by allocation id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Usage: nrc alloc_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">nrc</span><span class=\"mtk1\"> () { nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task puma $@ /bin/bash -c </span><span class=\"mtk6\">&quot;bundle exec rails c&quot;</span><span class=\"mtk1\"> }</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"easily-switch-between-namespaces\" style=\"position:relative;\"><a href=\"#easily-switch-between-namespaces\" aria-label=\"easily switch between namespaces permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Easily switch between Namespaces</h3>\n<p class=\"markdown-para\">When running Nomad CLI commands from a laptop and connecting to a remote Nomad cluster, there are a number of environment variables that must be specified. These include:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><code>NOMAD_NAMESPACE</code>: Namespace to limit commands to, for example, our team uses: <code>dev</code>, <code>staging</code>, and <code>prod</code>.</li>\n<li class=\"markdown-list-item\"><code>NOMAD_ADDR</code>: Address of the machine where Nomad server is running. For our installation, this varies by namespace.</li>\n<li class=\"markdown-list-item\"><code>NOMAD_TOKEN</code>: ACL token to authenticate API requests. For our setup, this also varies by namespace.</li>\n</ul>\n<p class=\"markdown-para\">When using multiple namespaces and having to switch between them, it's tedious to have to remember to modify one's profile to ensure the correct set of environment variables are exported.</p>\n<p class=\"markdown-para\"><a href=\"https://direnv.net/\" class=\"markdown-link\">direnv</a> is a shell extension that makes this more convenient. It will load/unload environment variables based on presence of a <code>.envrc</code> file in the current directory. Here's how I've organized to support easily switching between our dev, staging, and prod environments.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad-env</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── dev</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   └── .envrc</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── staging</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   └── .envrc</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── prod</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── .envrc</span></span></code></pre>\n<p class=\"markdown-para\">Where each .envrc file contains:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_ADDR=https://nomad-server-url (for the current env)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_TOKEN=acl_token (for the current env)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_NAMESPACE=dev (or staging or prod)</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nNote that direnv is not Nomad specific. This tool can be used anywhere you need to easily switch between sets of environment variables.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered a number of useful tips for working with Nomad including working with the jobspec HCL file and making use of the Nomad CLI. Here are some resources for further reading and bookmarking if you're going to be using Nomad:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://www.nomadproject.io/docs/job-specification\" class=\"markdown-link\">Job Specification</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.nomadproject.io/docs/commands\" class=\"markdown-link\">Command Line Reference</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.nomadproject.io/docs/runtime/environment\" class=\"markdown-link\">Environment Variables</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://github.com/angrycub/nomad_example_jobs\" class=\"markdown-link\">Github Repo with Numerous Example Jobs</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/nomad-tips-and-tricks/"}}},{"node":{"id":"c05066a2-3b0b-5ae4-b724-05d4506939f9","frontmatter":{"title":"Automate Keyboard with Mac","date":"December 2021","category":"OSX"},"excerpt":"This post will explain how to automate a series of key sequences on a Mac and assign a keyboard shortcut to play the entire sequence. But…","html":"<p class=\"markdown-para\">This post will explain how to automate a series of key sequences on a Mac and assign a keyboard shortcut to play the entire sequence. But first, a little background on how I came to be solving this particular problem.</p>\n<p class=\"markdown-para\">I recently found myself having to use a website to perform a critical task. This website required constantly refreshing, as in every second, to get up to date data. However, pressing the browser refresh button or keyboard shortcut for refresh triggered navigation to the previous page rather than refreshing the current data. The only way to force a refresh on the current page was to select a different value from a dropdown that had values for number of kilometers away for the location data being displayed. For example, 10km away, 20km away, etc.</p>\n<p class=\"markdown-para\">At first I was using the mouse to do this which involved one click on the dropdown control to open it, and another click on any option other than the currently selected one. However, after a few minutes of this, my right wrist (mouse hand) began to ache. Fortunately the dropdown was keyboard accessible, and could be manipulated with the following key sequence:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><kbd class=\"markdown-kbd\">Space</kbd> to open the dropdown.</li>\n<li class=\"markdown-list-item\"><kbd class=\"markdown-kbd\">Tab</kbd> to move the focus to the next selection within the open dropdown.</li>\n<li class=\"markdown-list-item\"><kbd class=\"markdown-kbd\">Down Arrow</kbd> to select the next option, if current selection was last in the list, this would circle around to the first selection.</li>\n<li class=\"markdown-list-item\"><kbd class=\"markdown-kbd\">Enter</kbd> to submit the change.</li>\n</ul>\n<p class=\"markdown-para\">However, after several more minutes of refreshing via keyboard, both my wrists started to ache. This is something to watch out for if you type for a living, a repetitive strain injury can put a serious dent in your career. That's why seeking out automation solutions to replace repetitive tasks is so important. In this case, I wasn't seeking to replace the entire workflow, only this small repetitive sequence that was causing wrist strain.</p>\n<aside class=\"markdown-aside\">\nThe automation solution described in this post is not a bot that scoops up concert tickets or causes other such mischief by impersonating human users. It is only to automate a small repetitive sequence that is otherwise painful to execute over and over. A real human is still required to provide personal information to authenticate to the website and get to the location selection screen.\n</aside>\n<p class=\"markdown-para\">You would think there was a built-in macro recorder on Mac for this sort of thing, but that's not the case. There are a few third party apps, some paid, some freemium, but it seemed like overkill to install an app just for this small automation. It turns out, it is possible to do with native Mac apps, but the solution is not intuitive. There are four parts to the solution:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Use the built-in <a href=\"https://support.apple.com/en-ca/guide/script-editor/welcome/mac\" class=\"markdown-link\">Script Editor</a> app to write an <a href=\"https://developer.apple.com/library/archive/documentation/AppleScript/Conceptual/AppleScriptLangGuide/introduction/ASLR_intro.html\" class=\"markdown-link\">AppleScript</a> script to activate Chrome (or whatever browser) and send the key sequences as system events.</li>\n<li class=\"markdown-list-item\">Use the built-in <a href=\"https://support.apple.com/en-ca/guide/automator/welcome/mac\" class=\"markdown-link\">Automator</a> app to \"register\" the AppleScript as a service.</li>\n<li class=\"markdown-list-item\">Use the <a href=\"https://support.apple.com/en-mide/guide/mac-help/kbdm162/mac\" class=\"markdown-link\">Keyboard Preferences</a> to assign a keyboard shortcut to the newly registered service.</li>\n<li class=\"markdown-list-item\">Enable the Automator, Script Editor, and the custom script to control your computer in the <a href=\"https://support.apple.com/en-ae/guide/mac-help/mh32356/mac\" class=\"markdown-link\">Security &#x26; Privacy</a> -> Accessibility preferences.</li>\n</ol>\n<p class=\"markdown-para\">Ok, let's dive into each of these.</p>\n<h2 class=\"markdown-subtitle\" id=\"1-scripteditor\" style=\"position:relative;\"><a href=\"#1-scripteditor\" aria-label=\"1 scripteditor permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. ScriptEditor</h2>\n<p class=\"markdown-para\">Launch the <a href=\"https://support.apple.com/en-ca/guide/script-editor/welcome/mac\" class=\"markdown-link\">Script Editor</a> app, create a new file, and enter the following AppleScript code. <code>tell</code> is is a statement that sends a command to a script object:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"applescript\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">tell</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">application</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Google Chrome&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">to</span><span class=\"mtk1\"> </span><span class=\"mtk9\">activate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">tell</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">application</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;System Events&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">-- Space</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk9\">key code</span><span class=\"mtk1\"> </span><span class=\"mtk4\">49</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">-- Tab</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk9\">key code</span><span class=\"mtk1\"> </span><span class=\"mtk4\">48</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">-- Down Arrow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk9\">key code</span><span class=\"mtk1\"> </span><span class=\"mtk4\">123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">-- Enter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk9\">key code</span><span class=\"mtk1\"> </span><span class=\"mtk4\">76</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end tell</span></span></span></code></pre>\n<p class=\"markdown-para\">This script ensures that Chrome is the active application, and then uses the <code>key code</code> command to emulate key presses using Apple's system events. You're not limited to these key codes of course, you can script any sequence you like using this <a href=\"https://eastmanreference.com/complete-list-of-applescript-key-codes\" class=\"markdown-link\">reference</a>:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPElEQVQ4y2VTS0uyYRB9/5U/I3BRIQmBJKSYl+yeFyxv5aKNaCl2I1BQEKLMu5bt2wpCpIjYplxUtjofZ+D1U1ocznNmRuc4MyofHx94f3+fYDgcTt6fn58zYC0xrad5NBpBOTs7QywWQyqVAt/ExcWF6NPTU5yfn0/ijMXjcSSTSamJRqOSJ05OTtDpdKAUi0WUSiU0Gg1UKhVBrVYTMK4yUS6XBXzX6/UJ87N3d3fo9/tQ7HY7XC4X/H4/dnd3cXBwgJ2dHQSDQWxvbyMQCMDpdEp+c3Nzor1eLzY2NqTOYDBgZWUFr6+vUPjNj4+P0oVgR7WrytVq9U+czvlrqB8eHnB/f4/BYABFo9GIE3bb39+Hw+EQbbVasbe3B4vFImwymSba4/HAbDaLXltbE200GtFut6Hkcjnp2Gq10Gw2xa0Kajp4enqaccc4HVKTC4UCbm9v5UKUubk56eJ2u2U2BJ1ubW2Ja2o6IVNz5pzx+vo6bDabvPV6PVZXV9HtdqFks1nQJefBDXIe08wrIOiCWyUTzKu5TCbz3+H8/Dx0Op1sNxKJyDyOjo5ki9R8h0IhwfHxsWyZNT6fTzZPp1qtVhy+vb1Bubq6QjqdRj6fx+XlpXTiQZNvbm7kiBOJhDBj19fX4kh19fLyIgfPmcsdHh4eihveE++MrtiNbnhbS0tLWF5exsLCgrhjDes583A4LBexuLgo239+foby+/uL7+9vwc/Pzx9WMR6PZ3Iq+P/lpnu9Hr6+vvAPlmkDrDBx2FIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"apple keycode reference\"\n        title=\"apple keycode reference\"\n        src=\"/static/1b6265210751adba1d67a0845a2840b0/5a190/apple-keycode-reference.png\"\n        srcset=\"/static/1b6265210751adba1d67a0845a2840b0/772e8/apple-keycode-reference.png 200w,\n/static/1b6265210751adba1d67a0845a2840b0/e17e5/apple-keycode-reference.png 400w,\n/static/1b6265210751adba1d67a0845a2840b0/5a190/apple-keycode-reference.png 800w,\n/static/1b6265210751adba1d67a0845a2840b0/c1b63/apple-keycode-reference.png 1200w,\n/static/1b6265210751adba1d67a0845a2840b0/54c3a/apple-keycode-reference.png 1257w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Hit <kbd class=\"markdown-kbd\">Cmd</kbd> + <kbd class=\"markdown-kbd\">s</kbd> to save the script, but save it as an <em class=\"markdown-emphasis\">application</em> (app extension), not a script file. Save this anywhere you like, but remember the location, we'll return to this later.</p>\n<aside class=\"markdown-aside\">\nAppleScript can be used to do a lot more than automating the keyboard. It can be used to create custom workflows for just about any aspect of your Mac and even to create apps. This post is limited to keyboard automation but if you're interested in learning more about what can be done with AppleScript, checkout this <a class=\"markdown-link\" href=\"https://discover.hubpages.com/technology/applescript_code\">post</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"2-automator\" style=\"position:relative;\"><a href=\"#2-automator\" aria-label=\"2 automator permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Automator</h2>\n<p class=\"markdown-para\">Although it's not obvious, this next step will register the script app created in the previous step as a Service, which is necessary for being able to assign a keyboard shortcut to it.</p>\n<p class=\"markdown-para\">Launch the <a href=\"https://support.apple.com/en-ca/guide/automator/welcome/mac\" class=\"markdown-link\">Automator</a> app and choose Quick Action.</p>\n<p class=\"markdown-para\">Set the \"Workflow receives\" dropdown to \"no input\".</p>\n<p class=\"markdown-para\">Using the search bar at the top, search for \"Launch Application\" and drag the result to the middle of the workflow pane (on top of the message that says Drag actions or files here).</p>\n<p class=\"markdown-para\">From the Launch Application inner pane that gets created, click on the Application dropdown and select the script <code>.app</code> file created in the previous step. Unless you saved it in the main Applications folder, it probably will not show up in the list of options. However, the second from last option says \"Other...\", select that. It will open a file finder window, navigate to wherever you saved your <code>.app</code> file and select it.</p>\n<p class=\"markdown-para\">Notice that it only allows selection of <code>.app</code> files, this is why we saved our script as an application in the previous step.</p>\n<p class=\"markdown-para\">Hit <kbd class=\"markdown-kbd\">Cmd</kbd> + <kbd class=\"markdown-kbd\">s</kbd> to save the Quick Action. Give it a meaningful name such as \"Chrome Dropdown Selector\". This save dialog doesn't give you a choice as to where the Quick Action gets saved, but fyi, it will be saved in <code>~/Library/Services/*.workflow</code>.</p>\n<h2 class=\"markdown-subtitle\" id=\"3-keyboard-shortcut\" style=\"position:relative;\"><a href=\"#3-keyboard-shortcut\" aria-label=\"3 keyboard shortcut permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Keyboard Shortcut</h2>\n<p class=\"markdown-para\">Open System Preferences -> Keyboard.</p>\n<p class=\"markdown-para\">Click on \"Services\" from the left pane. Then in the right pane, scroll all the way down to \"General\". Here you will see the Quick Action created in the previous step. It will show up as whatever name you saved it as.</p>\n<p class=\"markdown-para\">Select your Quick Action, then click on the \"Add Shortcut\" button directly beside it, and press your desired keyboard shortcut to associate it with this Action. Test that your desired shortcut isn't already in use for some other feature.</p>\n<p class=\"markdown-para\">Almost there, one more step to pull this all together.</p>\n<h2 class=\"markdown-subtitle\" id=\"4-security\" style=\"position:relative;\"><a href=\"#4-security\" aria-label=\"4 security permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Security</h2>\n<p class=\"markdown-para\">By default, Mac will not allow any custom scripts/workflow/automation etc to control your computer. This must be enabled with the following steps:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Open System Preferences -> Security &#x26; Privacy.</li>\n<li class=\"markdown-list-item\">Click the lock icon at the bottom left and enter your computer password.</li>\n<li class=\"markdown-list-item\">Select Accessibility from the left hand side.</li>\n<li class=\"markdown-list-item\">Click on the Privacy tab at the top.</li>\n<li class=\"markdown-list-item\">From the right hand list of applications, make sure Automator and Script Editor are selected. If they don't appear in the list, click on the plus button, locate them from the Applications folder (might be under Applications/Utilities) and add them.</li>\n<li class=\"markdown-list-item\">Also add the script app file created in Step 1.</li>\n</ul>\n<p class=\"markdown-para\">Now open the browser to the web site where the automation should be performed, ensure focus is on the select control, and hit the keyboard shortcut that was set in Step 3.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">Phew, that was a lot of work, but worth it to save some wrist strain. This is just the tip of the iceberg in terms of what these automation tools can do for your Mac. Here are some resources I used to put this all together and further reading:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://eastmanreference.com/how-to-automate-your-keyboard-in-mac-os-x-with-applescript\" class=\"markdown-link\">Automate Keyboard with AppleScript</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://eastmanreference.com/complete-list-of-applescript-key-codes\" class=\"markdown-link\">Complete List of AppleScript Keycodes</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.addictivetips.com/mac-os/convert-an-applescript-to-an-app-on-macos/\" class=\"markdown-link\">Save AppleScript as Application</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.addictivetips.com/mac-os/run-an-applescript-with-a-keyboard-shortcut-on-macos/\" class=\"markdown-link\">Run AppleScript with Keyboard Shortcut</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://developer.apple.com/library/archive/documentation/AppleScript/Conceptual/AppleScriptLangGuide/introduction/ASLR_intro.html\" class=\"markdown-link\">AppleScript Language Guide</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.idownloadblog.com/2018/11/21/cool-things-mac-automator-tutorial/\" class=\"markdown-link\">10 Cool Things to do with Automator</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/automate-keyboard-mac/"}}},{"node":{"id":"c05effd5-0385-5cd2-b201-06a523790aeb","frontmatter":{"title":"Working Towards an Asynchronous Future","date":"December 2021","category":"career"},"excerpt":"I was inspired to write this after reading a post about how big tech companies organize their software engineering processes and the curious…","html":"<p class=\"markdown-para\">I was inspired to write this after reading a post about how big tech companies organize their software engineering processes and the <a href=\"https://blog.pragmaticengineer.com/project-management-at-big-tech/\" class=\"markdown-link\">curious absence of scrum</a> at these companies. While I don't work at a FAANG (or MAANA given some company renames), I am fortunate to be working on a team where engineers are empowered to be self organizing, and try different ways of working to optimize for results, developer productivity, and overall quality of life.</p>\n<p class=\"markdown-para\">To this end, our team has moved increasingly to an asynchronous work style and the results have been fantastic. This post will walk through why we decided to try this, how we're doing it, and address some common concerns.</p>\n<h2 class=\"markdown-subtitle\" id=\"background\" style=\"position:relative;\"><a href=\"#background\" aria-label=\"background permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Background</h2>\n<p class=\"markdown-para\">But first, a little background. Our team is composed of three engineers (looking for a fourth at the time of this writing), and a product manager. We also have an engineering manager who manages several teams. There is no QA as the product has a thorough suite of end-to-end tests that cover just about every feature and workflow.</p>\n<p class=\"markdown-para\">The product consists of several publicly accessible web apps, built with Rails and MySQL. Our team is in full control over the product direction, features to be added and tech debt that should be addressed. The code base is very large, having been developed and iterated on over 10 years.</p>\n<p class=\"markdown-para\">We're part of a mid-sized company that delivers a number of other products and services. Prior to the pandemic, most people worked in office, with occasional work-from-home days. After the pandemic, the company went fully remote and will remain that way going forward.</p>\n<p class=\"markdown-para\">Our team has never been big fans of the official scrum methodology, preferring a more kanban/flow approach to delivering features. So we were fairly light on ceremonial meetings, but we did have some regular meetings including a daily standup and some planning meetings. We were also in the habit of \"let's hop on a call\" type meetings, for example to deal with a tricky production bug or figure out how a new feature should be integrated into the existing product.</p>\n<p class=\"markdown-para\">This all came to a head one day when our manager seemed really stressed out in standup and remarked that he was in too many meetings. Since none of us were fans of meetings to start with (is any engineer really??), we decided right there and then to move standup to an async channel using Slack and to generally try and work more asynchronously.</p>\n<h2 class=\"markdown-subtitle\" id=\"remote--async\" style=\"position:relative;\"><a href=\"#remote--async\" aria-label=\"remote  async permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Remote !== Async</h2>\n<p class=\"markdown-para\">Some terminology to clarify before moving on. Sometimes the terms remote working and asynchronous working get used interchangeably but there's an important difference.</p>\n<p class=\"markdown-para\">Remote working is when the entire team is not co-located in a physical office, and instead is working from home or some other location. However, they are still required to all be online and working during official business hours, typically 9am - 5pm. Some companies may have a variation on this where everyone is required to be online during \"core hours\", say 10am - 4pm, with a little flexibility for those that wish to start and finish earlier or later by about an hour. This results in the majority of the teams' work hours overlapping which makes it easy to book meetings or impromptu calls because there's an expectation that every one is available at the same time.</p>\n<p class=\"markdown-para\">Asynchronous working takes this to another level. In addition to the team not being co-located, there is no expectation of overlapping work hours at all. Each team member picks their own working hours that suit them best. Furthermore, these hours don't have to be contiguous or the same times each day. For example, someone may find their optimal focus time is in the very early hours of the morning, then take the afternoon off for exercise, running errands, picking up kids from school etc. and then log back in later in the evening to complete some tasks. Someone else may prefer to start around midday or later, and work late into the night because that's when they're at their most productive.</p>\n<aside class=\"markdown-aside\">\nIf you'd like to learn more about planning your day for optimal focus time, and when you'll get the best results from focusing on certain kinds of problems, the book <a class=\"markdown-link\"href=\"https://www.danpink.com/books/when/\">When: The Scientific Secrets of Perfect Timing</a> presents compelling research and stories on this. I also gave a <a class=\"markdown-link\" href=\"https://danielabar.github.io/when/#/\">presentation</a> on this topic.\n</aside>\n<p class=\"markdown-para\">There can also be a spectrum, where a team may want some real-time meetings such as weekly one on ones with managers, but the rest of the week everyone is free to manage their time however suits them. This is where our team has landed.</p>\n<p class=\"markdown-para\">Now that the definitions are out of the way, how does a team go from everyone working pretty much the same hours to async?</p>\n<h2 class=\"markdown-subtitle\" id=\"communication\" style=\"position:relative;\"><a href=\"#communication\" aria-label=\"communication permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Communication</h2>\n<p class=\"markdown-para\">One thing we realized in moving to async is that we would all have to hone our written communication skills, since this would be taking the place of verbal communication. Not only can effective writing replace a lot of meetings, there's also a benefit to the company. Decisions and discussions in a written format are easily accessible to everyone, not just whoever happened to participate in the meeting that day. This is also helpful to the team in an environment of shifting priorities, where people may not remember what was discussed in a meeting several months ago. When decisions are written down, this is no longer a problem.</p>\n<p class=\"markdown-para\">Here are a few examples of the type of writing our team has been doing to reduce the need for all of us to be online at the same time. We try as much as possible to choose writing tools that support markdown, which is more developer friendly than WYSIWG editors, but that's just our team preference.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 667px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEFA//EABYBAQEBAAAAAAAAAAAAAAAAAAIDBP/aAAwDAQACEAMQAAABu5OfldYRcf/EABkQAQEBAAMAAAAAAAAAAAAAAAEAAgMREv/aAAgBAQABBQJhz3bYPHPf/8QAFxEAAwEAAAAAAAAAAAAAAAAAAQIQEf/aAAgBAwEBPwELs//EABcRAQEBAQAAAAAAAAAAAAAAAAEAAhL/2gAIAQIBAT8B70uob//EABsQAAEEAwAAAAAAAAAAAAAAABAAAQIhETFC/9oACAEBAAY/AlWzmPT2P//EABwQAQACAQUAAAAAAAAAAAAAAAEAERAhMUFRcf/aAAgBAQABPyFla7SkDhRxCQAo9Qvqf//aAAwDAQACAAMAAAAQ4z//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEUH/2gAIAQMBAT8QwI//xAAbEQEAAgIDAAAAAAAAAAAAAAABADERIYGx0f/aAAgBAgEBPxALDgK4u5lDXfk//8QAGxAAAgMBAQEAAAAAAAAAAAAAAREAITFRYXH/2gAIAQEAAT8QAQGWzgkY4DA1ewvwjjSLl0QpIa4CWD9M/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"markdown all the things\"\n        title=\"markdown all the things\"\n        src=\"/static/4e1e2d0e387f8bb940c46deb12b1355f/e20b3/markdown-all-the-things.jpg\"\n        srcset=\"/static/4e1e2d0e387f8bb940c46deb12b1355f/e07e9/markdown-all-the-things.jpg 200w,\n/static/4e1e2d0e387f8bb940c46deb12b1355f/066f9/markdown-all-the-things.jpg 400w,\n/static/4e1e2d0e387f8bb940c46deb12b1355f/e20b3/markdown-all-the-things.jpg 667w\"\n        sizes=\"(max-width: 667px) 100vw, 667px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<aside class=\"markdown-aside\">\nThe topic of documentation, such as how to write it, what should get documented, how to maintain it etc. is enough for a whole blog post on its own. See this excellent <a class=\"markdown-link\" href=\"https://chelseatroy.com/2021/09/14/the-art-of-documentation/\">post</a> for thorough coverage of this topic.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"pull-requests\" style=\"position:relative;\"><a href=\"#pull-requests\" aria-label=\"pull requests permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pull Requests</h3>\n<p class=\"markdown-para\">When a pull request is submitted for review, the developer writes a detailed description including what the new code does, what areas of the project were modified, and most importantly, step by step instructions for the reviewer to exercise the code. Our review process includes not just providing feedback on the code, but also having the reviewer check out the branch and try out the new feature or bug fix on their laptops.</p>\n<p class=\"markdown-para\">This level of detail in the PR description eliminates the need for real-time discussion about what the PR does. Having the reviewer try it out means at least one other person besides the original developer gains an understanding of this feature beyond what merely scanning the code can provide.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"project-docs\" style=\"position:relative;\"><a href=\"#project-docs\" aria-label=\"project docs permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Project Docs</h3>\n<p class=\"markdown-para\">The main project <code>README.md</code> file contains project setup instructions which we strive to maintain whenever there's a change, such as some new configuration or external dependency required. The idea being that a new developer should be able to spin up a working dev environment without getting stuck and needing real time help from someone else on the team. If something is discovered that's missing from the setup instructions, that's a great first PR for the new developer to submit to update the readme.</p>\n<p class=\"markdown-para\">When a new feature is added such as a third party integration, we add or update the project documentation as part of the PR. This takes the form of markdown files in a <code>/docs</code> directory of the project, and a link to this doc from the <code>Further Reading</code> section of the main project <code>README.md</code> file. The benefit of maintaining these docs is it spreads the knowledge of each feature so if someone has a question, they can find the answer in the docs rather than requiring the original developer to be online to answer. Keeping the docs with the project source means they're more likely to turn up in a search when someone is making a change, and therefore get maintained along with the code as it evolves.</p>\n<aside class=\"markdown-aside \">\nEven for a non async team, maintaining docs along with the code is helpful because the original developer may be on vacation or have left the company, and this knowledge could otherwise be forever lost.\n</aside >\n<h3 class=\"markdown-sub-subtitle\" id=\"jira\" style=\"position:relative;\"><a href=\"#jira\" aria-label=\"jira permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Jira</h3>\n<p class=\"markdown-para\">Hear me out, please don't close this tab. Jira is painful when used as a management tool. Like those dreaded sprint review meetings where the scrum master is closing out the sprint, and there's one lonely ticket in the Done column and all the others are scattered throughout the Not Started, In Progress, and In Review columns. Or when developers have to track actual hours vs estimate hours in Jira, shudder!</p>\n<p class=\"markdown-para\">But our use of Jira is simply to use the epics to write down an overall goal, and the individual tickets within an epic serve as our todo list. We write detailed descriptions in each ticket, including context and scope. Links are used to identify dependencies between tickets. Bug reports include steps to reproduce and actual vs expected results. This way everyone knows the big picture, what everyone else is working on, and can pick up work without a planning meeting or any other real-time coordination.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"slack-async\" style=\"position:relative;\"><a href=\"#slack-async\" aria-label=\"slack async permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slack Async</h3>\n<p class=\"markdown-para\">For simple question and answer communication, we use Slack but in an async fashion. Effectively this means there's no expectation of an immediate reply and we don't monitor whether someone's dot is green on Slack. We mostly disable notifications to make this type of communication less disruptive to focus time.</p>\n<aside class=\"markdown-aside\">\nRegardless of your team being async or not, it's a good idea to minimize notifications and other <a class=\"markdown-link\" href =\"https://danielabaron.me/blog/off-with-the-digital-distractions/\">digital distractions</a> to get the most out of your focus time.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"wiki-discussions\" style=\"position:relative;\"><a href=\"#wiki-discussions\" aria-label=\"wiki discussions permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wiki Discussions</h3>\n<p class=\"markdown-para\">We use Github to host our project source, which also has a Wiki. We use this when a team member has something they'd like to discuss that is more involved than what could be covered with a Slack question. They can add a page and write up a discussion topic in markdown, and share it with the team via Slack. Then team members can update the document with their thoughts on the topic on their own time. This replaces the \"let's hop on a call\" type of meetings and has helped us resolve a number of issues. The benefit of this written approach over a real-time meeting is each developer can do some analysis on the code before piping in to the \"conversation\". This results in more accurate and thoughtful points being made.</p>\n<p class=\"markdown-para\">The meeting equivalent of this is where some participants say \"umm... let me check...\", clackety clack of keyboards, while other participants watch and wait. The async version of this has been more effective for our team and leaves a searchable artifact for ourselves and future team members.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"architecture-decision-records\" style=\"position:relative;\"><a href=\"#architecture-decision-records\" aria-label=\"architecture decision records permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture Decision Records</h3>\n<p class=\"markdown-para\"><a href=\"https://adr.github.io/\" class=\"markdown-link\">ADR</a> is a more formal written document to be used when someone would like to propose a significant architectural change to the project. It gets submitted as a markdown document in a PR, then team members can discuss via PR comments. This is a new format we're experimenting with so it's too early to report on its effectiveness.</p>\n<p class=\"markdown-para\">What brought this about is since the project code is ~10 years old, we sometimes come across areas of the code where the original developer is long gone and it's not well understood why that particular implementation was chosen. There may have been a meeting at that time to discuss the approach, but of course, the conclusions of that meeting are forever lost. The idea with ADR docs is to generate discussion about proposed changes <em class=\"markdown-emphasis\">and</em> have the reasoning and final decisions captured in writing for posterity.</p>\n<h2 class=\"markdown-subtitle\" id=\"ownership\" style=\"position:relative;\"><a href=\"#ownership\" aria-label=\"ownership permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ownership</h2>\n<p class=\"markdown-para\">In addition to effective writing, another thing that's required to make async work is that each engineer has full ownership of their tasks. This means they are responsible for the entire feature end to end and have freedom to make all implementation decisions. This minimizes real time coordination with other engineers. For example, rather than splitting a feature into back end assigned to one engineer, and another gets the front end, one person would be responsible for the entire vertical slice.</p>\n<p class=\"markdown-para\">This doesn't mean \"cowboy\" style coding, there's still room for questions and discussion as described in the previous section on writing. But it's left to the engineer's judgement as to whether something is significant enough to require team input, or if it's something they can make an \"executive\" decision on.</p>\n<aside class=\"markdown-aside\">\nHaving every engineer on the team be an equal and effective owner is easy to accomplish when the size of the team is small relative to the size of the code base. This allows each person to work independently, minimizing the chance of stepping on someone else's toes.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"trust\" style=\"position:relative;\"><a href=\"#trust\" aria-label=\"trust permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Trust</h2>\n<p class=\"markdown-para\">Related to the ownership point, is trust. I don't think it would be possible for a team to work asynchronously without a high degree of trust. We trust that each team member is intrinsically motivated to move the project forward without any monitoring of their online status and that they can manage their time effectively to complete their tasks. We also trust that if someone is stuck on something, they'll reach out for help, or if they finish a task, they'll take the initiative to go into the epic list and pick up another one rather than waiting to be assigned.</p>\n<h2 class=\"markdown-subtitle\" id=\"objections\" style=\"position:relative;\"><a href=\"#objections\" aria-label=\"objections permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Objections</h2>\n<p class=\"markdown-para\">This post is not to suggest that everyone should stop what they're doing and switch to this approach. If your team feels happy and productive working fixed hours and having regular meetings, then by all means, continue.</p>\n<p class=\"markdown-para\">But for those feeling burned out by all the meetings or open to exploring a more flexible way of working, there may be concerns like \"what about...\" or \"our team could never...\". This next section will address some common concerns with async working.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"but-our-team-does-scrum\" style=\"position:relative;\"><a href=\"#but-our-team-does-scrum\" aria-label=\"but our team does scrum permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>But our team does Scrum</h3>\n<p class=\"markdown-para\">I'm going to tread carefully here as this post is not intended as a scrum good or bad discussion.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEP0lEQVQ4yz2PWUzTdwDH/3vYFpfNJ3WgYMCDTW2hBQpFjgK2tJQeHC1HYbAhh0MOlUOGzNaCIm25HYqIioNwq4ALRJdlatRkczO6LTHbvJa9bA/b9GHLkub3WeRhD5983j75fqU1yZH+LWYNijyjUBVaROIHdrEjWydCMhLEq1GbhVoWIBYu6MTSw2Ixc6NATE5litnudDF/0yH6JywiqzFPmD6uFMaW3cLYUiakgF0qv9ymZ1u2VmzP1pJaXkBMkRVthYPVGgXS5nX0H9UzcbOc8eUsFmuNfFf3Hlf6TPTOWdlZ30SsqwfDsS70HT2sBCNy09mWpRVyu16klBeImCLrytI3E+TiLdka0V5rEwNTB8X09Wwx684QN2vNYn4sUwzMZgpVzV5ReXpQ3P31a3Hr6VdCWpsS6ZflpCG36UW43UBiqZ1oh4VdFQW8plYgbVhLZ72Joak6Lt7KZfp6PhNLOSzcLeLEpJmommpqz5/hl39+5uGLH5HWpUb5ZTb9/0FtZRHxJVlEFuaSXxlGe+PbTI4ZWPqhhLnr+Vy+XcilO4Us3C6m77yduIY6MrsH6Lgyg3thBukN9TZ/wC4V61KjRKBWRZg1ha2WJEKMOsbP6ODxJham05m642Bsycb41VzGr+UwtlhMh7eUpIa9RDq7kB1sQ9bcjiSFb/RL8mAkebBY8Y4NSLINSGGBzF9I59HV7XS7E+mdsuIZNuE9a8Y7YqZn1EKLV0v87lJiXV3Et/nY6fYhScoQv6QMRVKGihUrQpHCQ1il2kRRWRDXakOZciXQN22h97yJ/gtmfGct9IxaOeTToWluIMbdg9rVidrlQXpFttH/ujyYVbIgsTo8mODojQQrNpGUGsahsnd5oH6Hbypj8A4msbctm/3H7XjPZtD7qYVWnxZN0wFi3T3EuTyoj3iR9r0f7m+tjuR4c6zocsfT5dEwMKijqVOHozqOspo9fNheg3fIzHp9HFsdZjpP2egayaPFYySxuYHo9j5i3D5ULy8Pzpj9AxczGZjPEScX7QxdsTOyXIT7dA72fTpqvOVUd1TRVpGGNSUcmyUBd0EincUpuHLVVGUls8eWTmWOnqo8I9LiZYd/Yc7O9KhFnBmy0N2Tj/eQFXdxPJXGBKrysqg3JeMyqvCYIvGZo/CYoum0xnKxOZ/7w/XcO1nHg+H9fO4uQfptTON/8kkEfwyHiM8ObKUpRYEzdQdOrZw2g5z2tO20GWS4M5QcNihw6hUcs8YwUmbkfl8dj859xOPRVp5MOPn+cDnS74MB/ufnAmE2UCw3bqYxWUmbSYErXYFzBSWudCVOgwKfQ8O9c838eeMEz7/o58VyN38tdfHT+GG+LLVwyqxH+ncyyP/3eBDMrRdLjVtoTFHiNkbgNESsRF/SmibnREkqN/qqeTp3hGdzLp7MHeHpJTfPFtv59ugeLuVoqMi28x/ez5qoIrsUOgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Bart Simpson writing lines\"\n        title=\"Bart Simpson writing lines\"\n        src=\"/static/a19cae528584e1d1ab0f472ce5f07dda/5a190/bart-simpson-scrum.png\"\n        srcset=\"/static/a19cae528584e1d1ab0f472ce5f07dda/772e8/bart-simpson-scrum.png 200w,\n/static/a19cae528584e1d1ab0f472ce5f07dda/e17e5/bart-simpson-scrum.png 400w,\n/static/a19cae528584e1d1ab0f472ce5f07dda/5a190/bart-simpson-scrum.png 800w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p class=\"markdown-para\">If your team believes that scrum is the best thing since sliced bread and you're all feeling happy and healthy doing it, then by all means, keep on scrumming! However, strict adherence to the <a href=\"https://scrumexplainer.com/scrum/scrum-methodology/\" class=\"markdown-link\">scrum methodology</a> is incompatible with asynchronous work. This is due to the numerous ceremonial meetings required every week or other week.</p>\n<p class=\"markdown-para\">Our team intentionally rejects scrum in favour of a flow approach. Our PM  has a strong sense of product direction and is able to express this well in writing. We break down tasks as small as possible, putting them behind feature flags where appropriate. This allows us to deliver small increments of value continuously, without any big bang planning meetings.</p>\n<p class=\"markdown-para\">For estimates, we use the T-shirt sizing approach. For tricky problems requiring team input, we use the writing approaches described earlier in this post. This eliminates the need for backlog grooming meetings and <a href=\"https://www.simplilearn.com/what-is-planning-poker-article\" class=\"markdown-link\">planning poker</a> games.</p>\n<p class=\"markdown-para\">We use a slack channel to post our daily updates. This has worked out better than real-time standup because seeing the updates in writing is easier to absorb and reply if someone is having a blocker, without holding up the whole team. How often has it happened that you're trying to remember your tasks so that you can recite them when it's your turn, so much so that you miss what others are saying.</p>\n<p class=\"markdown-para\">Finally, if there's a process improvement someone would like to explore, for example, turning on auto-merge on PR's, we just try it, no need to wait for official \"end of sprint\" retrospective meeting. We provide each other feedback continuously which eliminates that ceremony as well.</p>\n<aside class=\"markdown-aside\">\nI started my career before Scrum, when Waterfall was the only option. Over the years as Scrum became increasingly trendy, I've noticed some surprising similarities between the two. This post on <a class=\"markdown-link\" href=\"https://medium.com/serious-scrum/the-unmistakable-signs-you-are-participating-in-fake-agile-theater-a7d1bd6a5dbc\">Agile Theatre</a> takes a fascinating look at that.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"we-dont-have-time-for-all-that-writing\" style=\"position:relative;\"><a href=\"#we-dont-have-time-for-all-that-writing\" aria-label=\"we dont have time for all that writing permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>We don't have time for all that writing</h3>\n<p class=\"markdown-para\">This reminds me of a similar argument against automated testing. It goes something like this:</p>\n<p class=\"markdown-para\"><em class=\"markdown-emphasis\">\"We don't have time to write tests, we're too rushed meeting the deadlines\".</em></p>\n<p class=\"markdown-para\">To which my answer is:</p>\n<p class=\"markdown-para\"><em class=\"markdown-emphasis\">\"Then there must be plenty of time for fixing bugs and putting out production fires\".</em></p>\n<p class=\"markdown-para\">In a similar way, if a team doesn't have time to write, then there must be plenty of time for developers to sit around in endless meetings rather than focusing on their work.</p>\n<p class=\"markdown-para\">Take an example of a single developer stuck on a problem. The seemingly quick approach is to reach out to the team, i.e. \"let's hop on a call\". Let's say there's 4 engineers on the team and they all get caught up in real time trying to solve this problem. I've seen these types of meetings run on for 3 hours or even more. That's at least 12 hours of people time!</p>\n<p class=\"markdown-para\">Now, imagine the original developer taking the time to articulate the problem in a wiki discussion doc or ADR. This could include a description of the problem, approaches that have been tried and didn't work, and consideration of a few alternatives with their pros and cons. A practiced writer may be able to accomplish this in about an hour. Then the doc is shared with the team where others who have knowledge in this area can share their feedback in the document. Since the problem is now well laid out, let's say the 3 other engineers on the team take an hour each to provide feedback. Then the original developer can review this for another hour to arrive at the solution. That's 5 hours rather than 12, <em class=\"markdown-emphasis\">and</em> there's a written artifact for anyone else that may later want to understand why that particular solution was chosen.</p>\n<p class=\"markdown-para\">The effects compound further when considering that many initiatives get put on the back burner for some other higher priority, then get restarted in 6 months to a year. Even if by some good fortune, the original engineers that had that meeting are still at the company, what are the chances anyone will remember the details and outcome of a meeting from about a year ago? This can lead to yet another meeting and the original 12 hours were wasted.</p>\n<aside class=\"markdown-aside\">\nOne \"solution\" I've seen to the forgotten outcome of meetings problem, is to designate one participant to take notes. However, when someone is tasked with note taking, it's difficult for that person to be an active participant in the technical problem solving. This results in highly skilled, highly paid engineers doing secretarial duties. Not only can it create resentment if the same person tends to be selected for this task (especially insidious if assigned to the only female engineer), but it's not the most effective use of engineering time.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"im-not-a-good-writer\" style=\"position:relative;\"><a href=\"#im-not-a-good-writer\" aria-label=\"im not a good writer permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>I'm not a good writer</h3>\n<p class=\"markdown-para\">Notice the emphasis has been on <em class=\"markdown-emphasis\">effective</em> writing rather than <em class=\"markdown-emphasis\">good</em> writing. This isn't about making the New York Times bestseller list or being nominated for a <a href=\"https://en.wikipedia.org/wiki/Pulitzer_Prize\" class=\"markdown-link\">Pulitzer Prize</a>. The goal is to make yourself understood to the rest of the team. Yes this takes some practice, but so does anything worth doing. Just as it takes time to develop effective programming skills, so too does it take time to develop writing skills.</p>\n<p class=\"markdown-para\">As long as everyone on the team is willing to work on this, it shouldn't be a blocker. Those team members that are stronger writers should remember to be kind to others with respect to spelling and grammar errors. Personally I don't think this matters much for internal docs as long as the overall meaning of the document is clear.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"what-about-onboarding\" style=\"position:relative;\"><a href=\"#what-about-onboarding\" aria-label=\"what about onboarding permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What about Onboarding?</h3>\n<p class=\"markdown-para\">Full disclosure: Since going asynchronous, our team has not yet on-boarded a new team member, so this process may need some work. There are three aspects to consider here:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Technical Setup:</strong> The project <code>README.md</code> should be sufficiently detailed and up to date so that a new team member can install all dependencies they need, get the project running and tests passing without getting on a call with another engineer. Ideally, the project docs also contain some \"What's next\" steps like how to run through a typical workflow in the application.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Domain Knowledge:</strong> It's not enough to have knowledge of the tech stack and familiarity with the code. An engineer also needs to understand the business domain. In my experience, this has been done by having the new person book 1-1 meetings with various domain experts in the company. This hasn't been a good experience because I've found myself furiously scribbling (or typing) notes trying to absorb all the important information being given and missing about half of it due to talking speed being faster than note taking speed. It's also sub-optimal for the domain experts because they need to spend this time repeating the same things every time a new person starts.</p>\n<p class=\"markdown-para\">This process could be optimized by having domain experts would write down their knowledge such as what the products are doing, critical workflows, business rules, what are the primary sources of revenue etc. Then the new person could review these and reach out to each expert with follow-on questions. The answers to these questions could then be used to update the business docs, leaving them improved for everyone.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Team Introduction:</strong> The initial introduction to the team might be a case where it's nice to have a real time meeting. No specific agenda other than for everyone to introduce themselves and \"shoot the breeze\" a bit. In the event that it's not possible to get everyone online all at the same time, this could be scheduled as individual 1-1 short meetings with team members.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"what-about-human-connection\" style=\"position:relative;\"><a href=\"#what-about-human-connection\" aria-label=\"what about human connection permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What about human connection?</h3>\n<p class=\"markdown-para\">Connection with others is an important part of being human, we are social creatures. Having said that, different people vary in the amount of social connections they need to feel fulfilled and function effectively. This can depend on introversion/extroversion and other dimensions of personality. Some people thrive on socializing at work and developing friendships with colleagues, while others may prefer to keep emotional distance between their work and social lives. There is no right or wrong here, and I don't think this is something that companies can mandate. The role a company can play is to provide some social opportunities (such as in-person or virtual events, depending on where things land with the pandemic and <a href=\"https://www.who.int/westernpacific/emergencies/covid-19/information/covid-19-variants\" class=\"markdown-link\">variants</a>), while keeping attendance optional.</p>\n<p class=\"markdown-para\">Another way of thinking of this is how connected do you really feel to your colleagues from attending scrum ceremonies and other work-related meetings? I don't believe even daily stand-ups are meaningfully connecting people. If you want to try an experiment with this - next time your spouse or a good friend asks you how was your day, try responding with: Yesterday I... Today I'm planning to... Blockers are...</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"how-do-i-know-people-are-working\" style=\"position:relative;\"><a href=\"#how-do-i-know-people-are-working\" aria-label=\"how do i know people are working permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How do I know people are working?</h3>\n<p class=\"markdown-para\">This is a question some managers might have, and it goes back to the point about <a href=\"#Trust\" class=\"markdown-link\">trust</a>. I would argue that without trust, it's going to be difficult for any team to effectively deliver software, whether asynchronous or not.</p>\n<p class=\"markdown-para\">There may be an old school approach among some managers that they feel the need to \"see\" the team at all times at their desk either physically, or virtually with surveillance software. There are many ways that managers can have visibility into engineering <em class=\"markdown-emphasis\">output</em> including git commits, pull requests, and jira. Slack integration with these tools can make it even easier to see what's going on. There is absolutely no need to monitor anyone's <em class=\"markdown-emphasis\">input</em> (i.e. time spent on laptop).</p>\n<p class=\"markdown-para\">Another angle on the trust issue - many engineers are put on a rotating on-call schedule to handle production issues. So think about that for a moment - an organization trusts someone with access to production but not with the ability to get their work done on their own schedule?</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"what-if-theres-an-emergency\" style=\"position:relative;\"><a href=\"#what-if-theres-an-emergency\" aria-label=\"what if theres an emergency permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What if there's an emergency?</h3>\n<p class=\"markdown-para\">This is the situation where everyone needs to get on a real-time call to resolve some urgent issue. I like to answer this concern with another question: What is the team doing if there's an emergency <em class=\"markdown-emphasis\">outside</em> of standard business hours? A well organized team will have:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">A rotating on-call schedule, ideally with a primary and secondary person to take the calls.</li>\n<li class=\"markdown-list-item\">A monitoring and alerting system to inform the on-call person of an issue.</li>\n<li class=\"markdown-list-item\">A playbook/troubleshooting guide for common problems.</li>\n<li class=\"markdown-list-item\">A maintenance procedure where if the on-call person encounters a new problem, they add the solution to the troubleshooting guide after it's resolved. This increases the body of knowledge for everyone.</li>\n<li class=\"markdown-list-item\">Compensation for people when they're on call.</li>\n</ul>\n<p class=\"markdown-para\">Given that the above is in place, then that's the same procedure to follow if there's an emergency at any time. It's not sustainable to require the entire team to be in potential emergency mode, even for a standard workday.</p>\n<h2 class=\"markdown-subtitle\" id=\"who-does-this-work-best-for\" style=\"position:relative;\"><a href=\"#who-does-this-work-best-for\" aria-label=\"who does this work best for permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Who does this work best for?</h2>\n<p class=\"markdown-para\">Wrapping this all up, here are some characteristics of a team for which the async style of working is likely to succeed:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">A team of effective writers, or at the very least, everyone's willing to spend time developing this skill.</li>\n<li class=\"markdown-list-item\">Small team size <em class=\"markdown-emphasis\">relative</em> to size of code base. The project should be large enough that every developer can work independently on a feature without requiring real time coordination.</li>\n<li class=\"markdown-list-item\">It's not necessary that all team members be senior, but a recent graduate or junior developer may require some real time guidance and mentoring.</li>\n<li class=\"markdown-list-item\">Great for product and SaaS companies where teams have full control over the product or service. May be more challenging to implement with project based consulting as it would require \"selling\" each client on the idea.</li>\n</ul>\n<h2 class=\"markdown-subtitle\" id=\"final-thoughts\" style=\"position:relative;\"><a href=\"#final-thoughts\" aria-label=\"final thoughts permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final Thoughts</h2>\n<p class=\"markdown-para\">Our team has found a great deal of benefits from working asynchronously. The individual benefits include freedom to manage your own time, and arrange work around life rather than the other way around. Having a nearly clear calendar allows everyone to do their most important work whenever is optimal for them. The benefits also extend to the company. When everything important about a project is written down, it eliminates the \"single point of failure\" where all knowledge about a given area is in a single person's head. If that person goes on vacation or leaves the company, the rest of the team or even new team members can get up to speed.</p>\n<p class=\"markdown-para\">I would love to hear your thoughts on this - has your team tried asynchronous work? What has worked well? What have been some challenges?</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","fields":{"slug":"/blog/working-towards-asynchronous-future/"}}},{"node":{"id":"c382bd2e-abc6-5f49-9e07-c45c351245f0","frontmatter":{"title":"Migrate Cron Jobs to Nomad the Lazy Way","date":"November 2021","category":"devops"},"excerpt":"Laziness is usually considered a negative or insulting term, but when it comes to software engineering, this can be a valuable attribute…","html":"<p class=\"markdown-para\">Laziness is usually considered a negative or insulting term, but when it comes to software engineering, this can be a valuable attribute. This post will walk through a problem I was facing in converting multiple cron jobs from a legacy platform to a new one, and how being lazy saved manual effort and made future maintenance easier.</p>\n<p class=\"markdown-para\">The application I'm working on has a custom build and deploy pipeline based on <a href=\"https://en.wikipedia.org/wiki/Xen\" class=\"markdown-link\">xen</a> and some home grown promotion tools. Our team is working on switching to a more modern workflow including building out a private cloud with Openstack, the Hashicorp stack for infrastructure as code (including Terraform, Nomad, Vault, and Consul), and Github Actions for CI/CD automation.</p>\n<aside class=\"markdown-aside\">\nThe remainder of this post assumes some familiarity with Hashicorp's Nomad. If you haven't used it before, checkout this excellent <a class=\"markdown-link\" href=\"https://adri-v.medium.com/just-in-time-nomad-80f57cd403ca\">primer</a> and <a class=\"markdown-link\" href=\"https://adri-v.medium.com/just-in-time-nomad-running-traefik-on-hashiqube-7d6dfd8ef9d8\">tutorial</a>.\n</aside>\n<p class=\"markdown-para\">As part of this migration, 30+ cron jobs from the old xen based build had to be converted to run on Nomad. Nomad has a <a href=\"https://www.nomadproject.io/docs/job-specification/periodic\" class=\"markdown-link\">periodic</a> stanza that is designed to run a given task on a particular schedule, so this is perfect for running cron jobs. However, the <code>periodic</code> stanza which defines the <code>cron</code> schedule can only be placed at the Nomad <code>job</code> level. This means that each entry in the application's former crontab needs its own <code>.nomad</code> job file. Each resulting <code>.nomad</code> job file would end up looking very similar, the only differences being in the job, group, and task names, the cron schedule, and the command to run.</p>\n<p class=\"markdown-para\">Being a <a href=\"https://medium.com/the-lazy-developer/on-laziness-26d7a9f32066\" class=\"markdown-link\">lazy</a> developer, there was no way I wanted to manually write over 30 nomad files. Not only would the initial work be tedious, but what if they all required a change in the future? Even with global find/replace in files, that would still be too much manual effort. Instead, I decided to write a generator - a bash script to parse the existing crontab (well, a modified version of it which I'll discuss soon) and generate each nomad file from a template file.</p>\n<h2 class=\"markdown-subtitle\" id=\"cron\" style=\"position:relative;\"><a href=\"#cron\" aria-label=\"cron permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cron</h2>\n<p class=\"markdown-para\">To start, let's take a look at the existing crontab. This is for a Rails application so all the jobs are written using rake:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">* * * * * nobody bundle exec rake app:frequent_tasks</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">5,10,15,25,30 * * * * nobody bundle exec rake app:export_widgets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0 * * * * nobody bundle exec rake app:cleanup_widgets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"nomad-example\" style=\"position:relative;\"><a href=\"#nomad-example\" aria-label=\"nomad example permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nomad Example</h2>\n<p class=\"markdown-para\">Now let's look at what the first job would look like written as a Nomad file. This project uses the <a href=\"https://github.blog/2020-09-01-introducing-github-container-registry/\" class=\"markdown-link\">Github Container Registry</a> to store its Docker images. The same image is used to run the app with Puma, database migrations, and cron jobs, therefore it intentionally doesn't have a <code>CMD</code> or <code>ENTRYPOINT</code> specified in its <code>Dockerfile</code>, rather, each Nomad task specifies the command to run. This is accomplished by specifying <code>bash</code> as the command to run, then passing an array of arguments with the actual command to run.</p>\n<p class=\"markdown-para\"><code>prohibit_overlap</code> prevents two instances of the same cron jobs from running at the same time, in the case that the first run takes longer and the second instance would have been scheduled to start.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;app_frequent_tasks&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;dc1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;* * * * *&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">prohibit_overlap</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;frequent_tasks&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frequent_tasks&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">   </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;RAILS_ENV=production bundle exec rake app:frequent_tasks&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">resources</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">cpu</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">500</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">env</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">RAILS_ENV</span><span class=\"mtk7\">=</span><span class=\"mtk1\">production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Access secrets from Vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Details not relevant for this example.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Note the use of <code>RAILS_ENV=production</code> in the command args. In theory, this shouldn't be required due to use of the <code>env</code> stanza further below, but in practice, the <code>env</code> stanza did not work for me so I had to specify it in the command args.</p>\n<h2 class=\"markdown-subtitle\" id=\"nomad-template\" style=\"position:relative;\"><a href=\"#nomad-template\" aria-label=\"nomad template permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nomad \"Template\"</h2>\n<p class=\"markdown-para\">To express this in a more general way, the rake task name from the cron entry (eg: <code>frequent_tasks</code>) becomes the job name, pre-pended with app (eg: <code>app_frequent_tasks</code>). The cron schedule (eg: <code>* * * * *</code>) becomes the periodic cron value. The rake task name is also used for the Nomad group and task name, and as the last value in the <code>args</code> for the Docker command configuration in the Nomad file.</p>\n<p class=\"markdown-para\">In order to write a script that will generate these Nomad files for each cron, start with a \"template\" Nomad file that is structured as the above, but with the specific values as strings <code>JOB_NAME</code> and <code>CRON_VALUE</code> that can be replaced. Use of the word template here refers to a file template that the script will use, not the <code>template</code> Nomad stanza used to read values from Vault or Consul:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># template.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;app_JOB_NAME&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;dc1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;CRON_VALUE&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">prohibit_overlap</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;JOB_NAME&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;JOB_NAME&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">   </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;RAILS_ENV=production bundle exec rake app:JOB_NAME&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">resources</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">cpu</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">500</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">env</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">RAILS_ENV</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Access secrets from Vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Details not relevant for this example.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"generator-script\" style=\"position:relative;\"><a href=\"#generator-script\" aria-label=\"generator script permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Generator Script</h2>\n<p class=\"markdown-para\">The generator script will have to iterate over each line of the cron, and parse it into the cron value, and job name. I ran into a snag here as there was no natural character to separate on. Couldn't use space or comma since these can also occur within the cron value. This required a one-time manual task of creating a file <code>cron-input</code> to add a pipe character separating the cron schedule from remainder of command. Also removed the <code>nobody</code> user:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">* * * * *|bundle exec rake app:frequent_tasks</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">5,10,15,25,30 * * * *|bundle exec rake app:export_widgets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0 * * * *|bundle exec rake app:cleanup_widgets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<p class=\"markdown-para\">And finally, here is the annotated script to iterate over <code>cron-input</code> and generate the <code>.nomad</code> files:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This is the pipe separated version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">INPUT_FILE=/path/to/cron-input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># The &quot;template&quot; nomad file with strings JOB_NAME and CRON_VALUE to be replaced</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">TEMPLATE_FILE=/path/to/template.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Record the original value of Internal File Separator so we can put it back later</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">OIFS=$IFS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Iterate over each line in input file (aka pipe separated cron)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">while</span><span class=\"mtk1\"> </span><span class=\"mtk9\">read</span><span class=\"mtk1\"> line</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Temporarily set Internal File Separator to pipe character for parsing cron input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  IFS=</span><span class=\"mtk6\">&#39;|&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Parse line of cron-input into cron and command values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Example, given a line: * * * * *|bundle exec rake app:frequent_tasks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Then cron_value will be &quot;* * * * *&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># and command_value will be &quot;bundle exec rake app:frequent_tasks&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">read</span><span class=\"mtk1\"> -r cron_value command_value </span><span class=\"mtk7\">&lt;&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$line&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Temporarily set Internal File Separate to colon character to parse out the job name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  IFS=</span><span class=\"mtk6\">&#39;:&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Parse `command_value` from previous step to extract the job name.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Example, given a command_value: bundle exec rake app:frequent_tasks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Then discard will be &quot;bundle exec rake app&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># and job_name will be &quot;frequent_tasks&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The first part is not needed so the variable is called `discard`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">read</span><span class=\"mtk1\"> -r discard job_name </span><span class=\"mtk7\">&lt;&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$command_value&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Generate nomad file for job from the template file.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Example, if the job_name extracted from previous step was: &quot;frequent_tasks&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># then generate a file named frequent_tasks.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Assumes there is a directory named `generated` to contain all the resulting .nomad files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  cp TEMPLATE_FILE generated/$job_name.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Replace all strings JOB_NAME and CRON_VALUE in generated file with values parsed from cron input file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># On a mac, must provide a bakup extension when editing files in place, on Linux, this can be skipped</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  sed -i </span><span class=\"mtk6\">&#39;.bak&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;s/JOB_NAME/</span><span class=\"mtk1\">$job_name</span><span class=\"mtk6\">/g;s/CRON_VALUE/</span><span class=\"mtk1\">$cron_value</span><span class=\"mtk6\">/&quot;</span><span class=\"mtk1\"> $job_name.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">done</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> $INPUT_FILE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># remove temporary .bak files from sed (only needed on mac)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rm generated/</span><span class=\"mtk7\">*</span><span class=\"mtk1\">.bak</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># reset original Internal File Separator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">IFS=$OIFS</span></span></span></code></pre>\n<p class=\"markdown-para\">Running this script will result in a <code>.nomad</code> file being generated for each entry in the <code>cron-input</code> file. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── generated</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── frequent_tasks.nomad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── export_widgets.nomad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── cleanup_widgets.nomad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── ...</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"deploy\" style=\"position:relative;\"><a href=\"#deploy\" aria-label=\"deploy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy</h2>\n<p class=\"markdown-para\">It's not enough to generate the files, they also need to be deployed to Nomad so that it can start scheduling each periodic job to run based on the specified cron schedule. For just a single file, the command is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job run generated/frequent_tasks.nomad</span></span></code></pre>\n<p class=\"markdown-para\">However, since the theme of this post is laziness, I'm not going to enter 30+ commands like the above to submit each job. Instead, the following script can be used to iterate over each nomad file in the generated directory:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Contains generated nomad files from previous step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">GENERATED_DIR=/path/to/generated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Iterate over each file in generated directory and submit it to nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> $GENERATED_DIR/</span><span class=\"mtk7\">*;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  nomad job run $i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">done</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIn order to run nomad commands like the above, you must have nomad <a class=\"markdown-link\" href=\"https://www.nomadproject.io/docs/install\">installed</a> and have configured environment variables NOMAD_ADDR, NOMAD_NAMESPACE, AND NOMAD_TOKEN in your profile.\n</aside>\n<p class=\"markdown-para\">This can also be incorporated into a CI/CD workflow. Modify the script slightly to accept arguments for the nomad address, namespace, and token (so that they can be provided by the pipeline) and set them before invoking nomad:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Will be provided by pipeline when invoking this script</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_ADDR=$1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_NAMESPACE=$2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_TOKEN=$3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This directory should contain all the generated nomad files from previous step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">GENERATED_DIR=/path/to/generated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Iterate over each file in generated directory and submit it to nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> $GENERATED_DIR/</span><span class=\"mtk7\">*;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  nomad job run $i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">done</span></span></span></code></pre>\n<p class=\"markdown-para\">Given that this script is named <code>run-nomad-periodic.sh</code>, here's an example of running it in a step as part of a Github Actions based workflow. It assumes that all the Nomad environment variables have been configured as Github repository <a href=\"https://docs.github.com/en/actions/security-guides/encrypted-secrets\" class=\"markdown-link\">secrets</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/deploy.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Deploy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">workflow_run</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">workflows</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;CI&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">main</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">types</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">completed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">build_image</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># build Docker image for app and push to container registry...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy_prod</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">needs</span><span class=\"mtk1\">: </span><span class=\"mtk6\">build_image</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">NOMAD_ADDR</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.NOMAD_ADDR }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">NOMAD_NAMESPACE</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.NOMAD_NAMESPACE }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">NOMAD_TOKEN</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.NOMAD_TOKEN }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Nomad Periodic</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">./path/to/run-nomad.periodic.sh $NOMAD_ADDR $NOMAD_NAMESPACE $NOMAD_TOKEN</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe workflow_run event is used to trigger a workflow when another workflow has completed. In this case, the Deploy workflow will only run after the CI (Continuous Integration) workflow has completed. See my post on <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/ci-cd-pipeline-for-gatsby/#Continuous-Deployment-When\">CI/CD</a> to learn more about the workflow_run event.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"maintenance\" style=\"position:relative;\"><a href=\"#maintenance\" aria-label=\"maintenance permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Maintenance</h2>\n<p class=\"markdown-para\">Here's where the power of laziness really shines. Suppose a change is needed to the periodic jobs. For example, the data center is being changed. There's no need to use global find/replace to edit the generated files directly. Rather, the <code>nomad.template</code> file can be modified:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># template.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;app_JOB_NAME&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># was dc1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;dc2&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;CRON_VALUE&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">prohibit_overlap</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Then run the generator script again to regenerate the nomad files, then they can be deployed again with the run script.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has explained why, when faced with a large repetitive task, it's good to embrace your inner laziness and find an automated way to perform this task. Specifically we've covered how to automate generation of Nomad periodic jobs from multiple cron jobs from a legacy platform and how to deploy them via scripts.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/convert-multiple-cron-jobs-to-nomad-periodic-jobs/"}}}]}},"pageContext":{}},
    "staticQueryHashes": ["163244226"]}