{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":14,"edges":[{"node":{"id":"c975b7e7-6342-5dfc-9f0b-77f98d4db732","frontmatter":{"title":"Use UUID for primary key with Rails and Postgres","date":"November 2020","category":"rails"},"excerpt":"When working with Rails and a relational database such as Postgres, the default option for primary key is an auto-incrementing sequence. Soâ€¦","html":"<p>When working with Rails and a relational database such as Postgres, the default option for primary key is an auto-incrementing sequence. So the first record inserted would get a primary key of 1, next one 2 and so on. Depending on the system, this can be an issue if these values get exposed in urls, for example <code>/subscription/265</code> would reveal that 265 subscriptions have been generated, and that the next one will be id 266.</p>\n<p>A less revealing option can be to use UUIDs (universally unique identifier) as a primary key. An example UUID looks like <code>123e4567-e89b-12d3-a456-426614174000</code>. The idea is that it's practically universally unique, and they are not sequential. So if this was a subscription id, the url would be <code>/subscription/123e4567-e89b-12d3-a456-426614174000</code> which reveals absolutely nothing about how many subscriptions have been created or what the next subscription id would be.</p>\n<p>This post shows the steps needed to configure Rails to use UUID for primary key with Postgres. This works best on a brand new application with no production data yet. Trying to convert an existing system could be risky because every single record in every table would have to get migrated and foreign key constraints temporarily dropped during migration.</p>\n<h2>Step 1: Enable pgycrypto</h2>\n<p>The <code>pgcrypto</code> module provides cryptographic functions for Postgres, however, it's not enabled by default. This should be the first migration to enable it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">EnableUuid</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    enable_extension </span><span class=\"mtk6\">&#39;pgcrypto&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Run the migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rake db:migrate</span></span></span></code></pre>\n<p>Verify the extension has been enabled. I'm using <a href=\"https://www.jetbrains.com/datagrip/\">Datagrip</a> but you can check with your sql client of choice. Expand the databases list, then check under extensions and you should see something like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 628px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d2d04dd917ab68a5442a832884c0e9d2/3d84d/postgres-pgcrypto-extension-enabled.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.917197452229296%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAByUlEQVQoz4VSy3LTQBDUH0AVlxRUoIKJZNl6S7taS9bDlq3YYMAQ8s4lBRyoJBU4JX/fzC5WSmC7OPTOvnqmt3c0w2LQ+xFk7NoM++4Auh2jS2vToWhztW/YAoYjzwR0i8Mgjk53jH+gyWG/F6HvJ4j8GE+Pf+D58gpFfoDq7RFGB58xnh0iHtZwwiGRor8SNGIeEzYbMsrE6kBWV+tQ4U/REG/MQKHT9dW6zd2sMBjg2ccr7M7PkKZTpOMF8skHcJpn1XuU9RJD2ivrT/BYAStI1xW2K5gU98QEr0UFly67RHKjHBYVk8+Vc5koGlRKgPR3a0LTjeF6Ai/GS+xlc/hEZqQsJHKUTCiOYQdD9L1EPVlf2dLwG7QSCrgOw87sFK+mh0hFiWT0DoNijjibKXi8XH0M2wrNCTNI2EFGnmTwqFUsVqKTLxDwApzUsaSCoF/m6USpbDiboHlshEfwEfwwh1kfYefyF84vvuH67h6nl99x8/MBx+dfEZK/HhX0eYvXgtajRl4D+WSSkh7ZYDpi1fSxwsb7LWhtQ1Xndz28pOc+ObtFktWYLk5Qzb8oSJ+b/tsGbc1YeUBKOlGh2kW2isvy/35Gg99AjYFQHF+f9AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alt\"\n        title=\"alt\"\n        src=\"/static/d2d04dd917ab68a5442a832884c0e9d2/3d84d/postgres-pgcrypto-extension-enabled.png\"\n        srcset=\"/static/d2d04dd917ab68a5442a832884c0e9d2/772e8/postgres-pgcrypto-extension-enabled.png 200w,\n/static/d2d04dd917ab68a5442a832884c0e9d2/e17e5/postgres-pgcrypto-extension-enabled.png 400w,\n/static/d2d04dd917ab68a5442a832884c0e9d2/3d84d/postgres-pgcrypto-extension-enabled.png 628w\"\n        sizes=\"(max-width: 628px) 100vw, 628px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Step 2: Configure Generator</h2>\n<p>Add the following to the generators config so it knows to generate uuid primary keys:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/generators.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.generators </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |g|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  g.orm </span><span class=\"mtk4\">:active_record</span><span class=\"mtk1\">, </span><span class=\"mtk4\">primary_key_type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:uuid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Step 3: Generate Model</h2>\n<p>Time to try it out. Start by generating a model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rails generate model Tenant name:string</span></span></span></code></pre>\n<p>Open the generated migration - notice the type for id is <code>uuid</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreateTenants</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:tenants</span><span class=\"mtk1\">, </span><span class=\"mtk4\">id:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:uuid</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Run the migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rake db:migrate</span></span></span></code></pre>\n<p>Verify how this looks in the database - notice that the id column is using the <code>gen_random_uuid()</code> function:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 626px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e74efdf2cd58bc560613499d727203c5/af590/tenant-table-uuid.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.9073482428115%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABGElEQVQoz5VSy07DMBDMv5C0SWjzdN5xEnBDmlYtKoL2WHHk/z9g2HUaJAQHOIy8s94de7w27HUKxiqq4AYFlquJO16m18W9oFzyZxgeCQWJxPn6gf5wQdc/Q42vGs3m+G9Rg4sZnpBwKWE6xG+bnDftEJYbUz7SmOIQd5SfeKQ5g+uNWdla+rC2Z+xf9qiaAetY0s1blN2O4hqiVEjrJ4Rph0wOKNoRSdUjSFvNuY7dfAku6GShjhj7HHHW0mYGXzRIqYnfl1dRKC0gyo0Wi/NHRITkxn8ImkkHvxrgaDGJdVRrWzYNyPVzDW5iu7Nlxhx/t2wHCE5X9Jd3ZHSi2r3hYTiRaIW82UKqA1oaGN+K35F/w29D+QQht+Aasg9/pQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alt\"\n        title=\"alt\"\n        src=\"/static/e74efdf2cd58bc560613499d727203c5/af590/tenant-table-uuid.png\"\n        srcset=\"/static/e74efdf2cd58bc560613499d727203c5/772e8/tenant-table-uuid.png 200w,\n/static/e74efdf2cd58bc560613499d727203c5/e17e5/tenant-table-uuid.png 400w,\n/static/e74efdf2cd58bc560613499d727203c5/af590/tenant-table-uuid.png 626w\"\n        sizes=\"(max-width: 626px) 100vw, 626px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Launch the Rails console and insert some data into the new table - you should see that the id is a UUID:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rails console</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; Tenant.create(name: &#39;Acme&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=&gt; #&lt;Tenant id: &quot;bb57c11e-2ec7-44aa-8519-babd8b439b51&quot;, name: &quot;Acme&quot;, created_at: &quot;2020-11-01 22:06:58&quot;, updated_at: &quot;2020-11-01 22:06:58&quot;&gt;</span></span></code></pre>\n<h2>Step 4: Foreign Key Reference</h2>\n<p>One last thing to watch out for is adding a foreign key reference to a table. For example, suppose there is a <code>Plan</code> table and you want to add a reference to the Tenants table. The migration for this is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rails generate migration AddTenantRefToPlan tenant:references</span></span></span></code></pre>\n<p>Which would generate:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddTenantRefToPlan</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_reference </span><span class=\"mtk4\">:plans</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:tenant</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">foreign_key:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">index:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>However, running this won't work because it will try to create an integer type column <code>tenant_id</code> on the <code>Plans</code>  referencing the <code>id</code> column on <code>Tenants</code> table which is of type uuid which doesn't match. For these type of migrations, need to specify <code>type: :uuid</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddTenantRefToPlan</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span><span class=\"mtk1\">[</span><span class=\"mtk4\">6.0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_reference </span><span class=\"mtk4\">:plans</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:tenant</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">foreign_key:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">index:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:uuid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>That's it, now you're all setup to use UUID as the primary key in all your models.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-uuid-primary-key-postgres/"}}},{"node":{"id":"517e3854-9ffe-5a1c-bdd6-940cf899b728","frontmatter":{"title":"Start a Rails 6 Project with RSpec","date":"October 2020","category":"rails"},"excerpt":"Currently at work I have one of those rare opportunities to greenfield new project. Since we're a Rails shop, naturally I'm using Rails, andâ€¦","html":"<p>Currently at work I have one of those rare opportunities to greenfield new project. Since we're a Rails shop, naturally I'm using Rails, and since it's a new project, might as well use the latest and greatest, which at the time of this writing is Rails 6.</p>\n<p>However I ran into a little surprise when it came to testing. Being somewhat of a Rails noob, based on the handful of projects I've worked on so far, had assumed that RSpec was the default test framework that comes with Rails. But it turns out, this is not the case. There's a few additional steps needed to setup a Rails project to use RSpec. This post will walk you through the steps I took to scaffold a new Rails 6 project and set it up for testing with RSpec.</p>\n<h2>Project Scaffolding</h2>\n<p>Run the following commands to get the project started. I'm using Ruby 2.7.1 and will be using Postgres as the database.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem install rails -v 6.0.3.4 </span><span class=\"mtk3\"># the most recent version at the time of this writing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">brew install postgresql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails new myapp -d=postgresql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> myapp</span></span></span></code></pre>\n<p>My next step was to generate some models. Since this will be a multi tenant system, first model is the Tenant class.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails generate model Tenant name:string</span></span></span></code></pre>\n<p>The output of this command is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running via Spring preloader in process 19406</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  invoke  active_record</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  create    db/migrate/20201018145546_create_tenants.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  create    app/models/tenant.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  invoke    test_unit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  create      test/models/tenant_test.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  create      test/fixtures/tenants.yml</span></span></code></pre>\n<p>Notice it didn't generate an RSpec test. It turns out, the default testing library that comes with Rails is Minitest and the generator creates a Minitest test file and fixture. Here's what's needed to switch to RSpec.</p>\n<h2>Add RSpec</h2>\n<p>First start by adding the RSpec gem to the test section of the Gemfile. Actually the <a href=\"https://relishapp.com/rspec/rspec-rails/v/4-0/docs\">rspec-rails</a> gem is used which adds RSpec support to Rails:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">group </span><span class=\"mtk4\">:test</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  gem </span><span class=\"mtk6\">&#39;rspec-rails&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Then install and bootstrap it. This will generate the <code>spec</code> dir and some support files:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails generate rspec:install</span></span></span></code></pre>\n<h2>Configure RSpec</h2>\n<p>You would think at this point, you could run the model generator and this time an RSpec test would get generated. But in my experience, it still generated the Minitest test and fixture. One more change you need to make is to tell the Rails generator that you only want RSpec tests. This configuration is specified in the <code>config/initializers/generators.rb</code> file. Go ahead and create this file if it's not already there. Then add the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.generators </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |g|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  g.test_framework </span><span class=\"mtk4\">:rspec</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now the model generator will generate an RSpec test file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rails generate model Tenant name:string</span></span></span></code></pre>\n<p>Command output:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running via Spring preloader in process 21305</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  invoke  active_record</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  create    db/migrate/20201018150823_create_tenants.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  create    app/models/tenant.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  invoke    rspec</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  create      spec/models/tenant_spec.rb</span></span></code></pre>\n<h2>Cleanup</h2>\n<p>Final step is to remove the generated <code>test</code> dir to avoid confusion. RSpec uses the <code>spec</code> dir for all test and support files.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rm -rf </span><span class=\"mtk9\">test</span></span></span></code></pre>\n<p>That's it, now you're setup for RSpec testing, happy coding!</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/start-rails-6-project-with-rspec/"}}},{"node":{"id":"5a6705c1-41fe-5b21-a127-9abfefa26707","frontmatter":{"title":"Find Jira Tickets Faster","date":"October 2020","category":"productivity"},"excerpt":"A short blog post for today. Just wanted to share a neat trick my colleague showed me recently to find Jira tickets faster, given that youâ€¦","html":"<p>A short blog post for today. Just wanted to share a neat trick my colleague showed me recently to find Jira tickets faster, given that you know the ticket number.</p>\n<h2>Add Custom Search Engine</h2>\n<p>To start, open Chrome Settings by clicking on the 3 vertical dots icon from the top right corner of Chrome, then select <code>Settings</code>. On a Mac, Settings can be launched with <kbd>Cmd</kbd> + <kbd>,</kbd>. Then click on <code>Search Engines</code> from the left menu option. I'm intentionally not including screenshots as Chrome changes the layout regularly. From the options that appear, select <code>Manage Search Engines</code>. Then click <code>Add</code> button to add a new search engine. Fill in the form as follows:</p>\n<p>Search engine: Jira</p>\n<p>Keyword: Your project code, for example, if Jira tickets on your project look something like <code>ABC-123</code>, then enter <code>abc</code> in this field.</p>\n<p>URL: Your company's Jira URL, for example <code>https://jira.acme.com/browse/ABC-%s</code>. The <code>%s</code> is the key here, this will get replaced with the actual ticket number when doing a search.</p>\n<h2>Use Custom Search Engine</h2>\n<p>With this setup, you can simply type in the Chrome address bar: Project code, for example <code>abc</code>, then <kbd>tab</kbd>. This will change the address bar to a Search bar. Then type in the ticket number, for example <code>123</code>, then <kbd>Enter</kbd>. This will replace the <code>%s</code> defined earlier in the search url with the ticket number and navigate to <code>https://jira.acme.com/browse/ABC-123</code>.</p>\n<h2>Conclusion</h2>\n<p>If you work in any mid or larger size company, there's a good chance you have to use Jira. It's kind of meh, but at least in this one small way, finding tickets can be more efficient.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","fields":{"slug":"/blog/find-jira-tickets-faster/"}}},{"node":{"id":"f6387f97-0e68-5f08-a943-ce401b1812a5","frontmatter":{"title":"View Localhost on Your Phone","date":"September 2020","category":"Web Development"},"excerpt":"A common occurrence when developing a new website or app is that you'd like to see what it will look like on your phone, tablet, or otherâ€¦","html":"<p>A common occurrence when developing a new website or app is that you'd like to see what it will look like on your phone, tablet, or other device. There are several pure software ways to do this, including <a href=\"https://developers.google.com/web/tools/chrome-devtools/device-mode\">Device Mode</a> in Chrome developer tools, and <a href=\"https://www.browserstack.com/\">Browserstack</a> which is a paid service with a free option for open source. However, all of these are only approximations of how your site will look and behave on another device. To get a more accurate experience, testing should be done on a real physical device. This post will show how to do that, with whatever devices are on hand.</p>\n<p>When developing locally, the usual process is to have a development server running on a laptop. This server is responsible for serving up the files (html, css, and javascript) on a certain port, watching those files for changes, possibly running them through a build step (eg: transform JSX, convert sass to css etc.), and refreshing the browser or hot module reloading so the changes can be seen right away.</p>\n<p>To access the website running on this local dev server, you open a browser tab on the same laptop that server is running on and navigate to an address such as <code>http://localhost:8080</code>. However, trying to enter this same address in a browser on a phone will not work. This is because <code>localhost</code> refers to the hostname of the computer it's running on. Here's the formal definition from <a href=\"https://en.wikipedia.org/wiki/Localhost\">Wikipedia</a>:</p>\n<blockquote>\n<p>In computer networking, localhost is a hostname that refers to the current computer used to access it. It is used to access the network services that are running on the host via the loopback network interface. Using the loopback interface bypasses any local network interface hardware.</p>\n</blockquote>\n<p>This means that if you enter <code>http://localhost:8080</code> on a phone, it's going to look for a web server running on the phone, which does not exist. What's needed, is to provide the phone an address of the laptop where the development server is running, i.e. something like <code>http://mylaptop:8080</code>.</p>\n<p>So now the question is, what is <code>mylaptop</code>? It turns out, when multiple devices (laptop, phone, tablet, etc.) are all on the same WiFi network, they can communicate with each other via an internal IP address. The <a href=\"https://www.computerhope.com/jargon/i/internip.htm\">Computer Hope</a> website has a clear definition of what an internal IP address is:</p>\n<blockquote>\n<p>Alternatively referred to as the local IP address, the internal IP address is the address that is assigned by your local network router that often begins with 192.168.x.x. These IP addresses are only seen by other computers in your local network and not by computers connected to an external network, such as the Internet.</p>\n</blockquote>\n<p>The key here is that your laptop's internal IP address can be seen by your phone if both are on the same network. This means that an address entered in the phone's browser like <code>http://laptop-local-ip:8080</code> will work.</p>\n<h2>Find your Local IP</h2>\n<p>So the next question is, what is the laptop's local IP address? On a Mac, open System Preferences, then select Network, then select the WiFi connection - the IP address will be shown under the Status. On Windows, run <code>ipconfig</code> in a terminal window. It starts with <code>192.168.</code> For example, if it shows <code>192.168.1.50</code>, then when a web server is running on the laptop (let's assume on port 8080), a browser can be opened in any phone/tablet that is on the same WiFi as the laptop at <code>http://192.168.1.50:8080</code> and it will display the web site.</p>\n<h2>Demo</h2>\n<p>Let's put it all together with a simple example. For this demonstration, we'll use the <a href=\"https://www.npmjs.com/package/live-server\">live-server</a> npm module to run a development web server with live reload capabilities.  In order to run npm modules, you must first have <a href=\"https://nodejs.org/en/\">Node.js</a> installed.</p>\n<p>Install live-server globally so that it can be run from any directory:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">npm install -g live-server</span></span></span></code></pre>\n<p>Then create a new directory with a simple index.html page:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">mkdir demo </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk9\">cd</span><span class=\"mtk1\"> demo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">touch index.html</span></span></span></code></pre>\n<p>Edit index.html so it contains the following</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;!</span><span class=\"mtk7\">DOCTYPE</span><span class=\"mtk1\"> </span><span class=\"mtk5\">html</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">html</span><span class=\"mtk1\"> </span><span class=\"mtk5\">lang</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;en&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">head</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">charset</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;UTF-8&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;viewport&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;width=device-width, initial-scale=1.0&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">title</span><span class=\"mtk1\">&gt;Demo Phone on Localhost&lt;/</span><span class=\"mtk7\">title</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">head</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">body</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;Hello from localhost!&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">body</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">html</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p>Now run live-server from the same directory where index.html is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">live-server</span></span></span></code></pre>\n<p>The console will show output something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Serving &quot;/path/to/demo&quot; at http://127.0.0.1:8080</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Ready for changes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">GET /favicon.ico 404 2.439 ms - 150</span></span></code></pre>\n<p>A browser tab on laptop will automatically open at <code>http://127.0.0.1:8080/</code> displaying the simple web page. By default, if live-server finds an index.html page in the directory root where it's running, it will serve that.</p>\n<p>Now open a browser on your phone or tablet and enter the address <code>http://your.local.ip.address:8080</code>, replacing <code>your.local.ip.address</code> with your actual <code>192.168...</code> address. It should display a web page with the heading \"Hello from localhost!\"</p>\n<p>Try making a change to index.html, for example, add a subheading:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;!</span><span class=\"mtk7\">DOCTYPE</span><span class=\"mtk1\"> </span><span class=\"mtk5\">html</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">html</span><span class=\"mtk1\"> </span><span class=\"mtk5\">lang</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;en&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">head</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">charset</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;UTF-8&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;viewport&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;width=device-width, initial-scale=1.0&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">title</span><span class=\"mtk1\">&gt;Demo Phone on Localhost&lt;/</span><span class=\"mtk7\">title</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">head</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">body</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;Hello from localhost!&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;test&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">body</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">html</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p>The browser on the phone should automatically refresh and display \"test\" under the heading.</p>\n<p>And there you have it, a workflow to view the site or app you're building on your laptop, on another device.</p>\n<h2>But what about React, Vue etc.</h2>\n<p>Just about all modern frameworks come with a CLI or starter project that includes a dev server. So instead of live-server that we used in the demo, it could be for example, a Webpack dev server. But the technique to view the site on your phone is the same. After the dev server is started, check the console it will show what port its running on. Then find your local IP address and navigate to that from a browser on the phone.</p>\n<p>For example, running <code>npm start</code> from a <a href=\"https://github.com/facebook/create-react-app\">create-react-app</a> project outputs the following, notice it helpfully tells you the address to access the site from the network:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">You can now view project-name in the browser.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Local:            http://localhost:3000/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">On Your Network:  http://192.168.2.16:3000/</span></span></code></pre>\n<p>Enter the \"On Your Network\" address in a browser on your phone.</p>\n<h2>Conclusion</h2>\n<p>This is great technique get quick feedback if the site/app is having issues on mobile, display issues, or something just doesn't feel right. It can be done for as many devices as you happen to have lying around. I like to keep my old devices instead of throwing them out specifically for testing.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/phone-localhost/"}}},{"node":{"id":"cc09b42e-b111-566f-889d-27d1a2345f9c","frontmatter":{"title":"Dockerize a Rails Application for Development","date":"September 2020","category":"rails"},"excerpt":"At work, I was recently tasked with Dockerizing a Rails monolith. This app has a React front end built with Webpacker, client sideâ€¦","html":"<p>At work, I was recently tasked with Dockerizing a Rails monolith. This app has a React front end built with Webpacker, client side dependencies managed with Yarn, runs background jobs with Active Job, and uses a MySQL database and Redis. The existing setup involved developers installing all dependencies on their laptops and took some non-trivial amount of time to get working. The goal of packaging everything with Docker was to make it easier and faster for new developers to get up and running. It was also important to ensure the project could still be run the \"old fashioned\" way, i.e. all dependencies installed directly on laptop. This was a hedge in case something was found that could not be made to work with Docker.</p>\n<h2>Development Workflow</h2>\n<p>Although there are many benefits to using Docker for development, there are also some challenges such as how to run tests? how to debug? In order for the Docker setup to be effective, it needs to cover the entire development workflow, including:</p>\n<ol>\n<li>Running the Rails app with changes to server side code made on host machine automatically reflected in container.</li>\n<li>Running one-time setup tasks such as applying the schema to database and populating it with <code>db/seeds.rb</code>.</li>\n<li>Running a Webpack dev server so that changes in client side code made on host machine are automatically compiled in container and browser is automatically refreshed to reflect these changes.</li>\n<li>Running a background job processor (this project uses Active Job, but Sidekiq could be used instead).</li>\n<li>Debugging with either a command line debugger (<code>binding.pry</code>) or an IDE such as VS Code.</li>\n<li>Running one off commands such as applying database migrations or running tests.</li>\n<li>Being able to access an interactive Rails console.</li>\n</ol>\n<p>This post will walk through the setup, to achieve each of the above workflows steps. A quick note first - this post assumes knowledge of Docker concepts such as Images, Containers and Volumes. For those unfamiliar or new to Docker, I recommend the <a href=\"https://www.pluralsight.com/courses/docker-deep-dive-update\">Docker Deep Dive</a> course on Pluralsight.</p>\n<h2>Introducing docker-compose</h2>\n<p>According to <a href=\"https://docs.docker.com/develop/develop-images/dockerfile_best-practices/\">Docker Best Practices</a>:</p>\n<blockquote>\n<p>Each container should have only one concern. Decoupling applications into multiple containers makes it easier to scale horizontally and reuse containers. For instance, a web application stack might consist of three separate containers, each with its own unique image, to manage the web application, database, and an in-memory cache in a decoupled manner.</p>\n</blockquote>\n<p>Looking at what's needed to run a Rails app (server, webpacker, MySQL, Redis, etc), it becomes clear that each of these is a separate concern, therefore should be run in a separate container. However, these containers will need to communicate with each other, and be coordinated such that they run at the appropriate time. For example, it would not make sense for the container that seeds the database to start running before the container that houses the MySQL database is available.</p>\n<p><a href=\"https://docs.docker.com/compose/\">Docker Compose</a> is a great tool to coordinate and synchronize multiple containers for this purpose. Here is a visual representation of what we will be creating:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/274cc9f675b6637bd48b37c8c0039759/efcdd/dockerize-rails.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAC4jAAAuIwF4pT92AAACTElEQVQ4y21T2W7bMBD0//9KX/peoEARpAhSpE3RBkFs6z4pitRFSrYke7qklMspgQXBJTk7uzu7OZ/POGNZZjdns8bpBKV7KKUwjtNyb95emFnTNEFrbc+bZjghKDqERY2Qt0ibEUl1RCZqxLxCKAbE1QFpTf76aM28ielN1c8mCjoKKqWkwCM2oj/BTUuUv26RxBm2rKdPClfXGW7vGHI1wi0P8MV7Mz7eTTavvu/Rdd0KqGf4XIGlBVKh4AnDYsDdg8DvJ4mkORLAEYFcjcDM7tFeqqUUBrCqKszzjI3UkwXZ8x47puAUGi7rICqJQlbwygG+PMALUnhhjqAaLahnGK6AbdtCCPHMkADlaIH2ZM+AZdWCiQb7vCWfQhxxRCFHQLUMKkNifGFY1zXyPF8AJaXsshZezOCz2qbnlz32xMZJuGWzTVsk1KSMgriUhZsU9o53RwvYNI21lxqGvIF++gOeZNgVPYJSw/dD+GFCqfUIya4en3CzDxAJjdrZovEcFPo1ZVPDV4aUkh8XiAjI1Mh0MW86ko+yjKN6wkMk8ZiQtKiecdEiIqnxbsTlsk0xEjANMYV2+UA6G/D9B8PPvyWS9rj6NTxqnOmwTzV3KdBzDd8KfQUcLEvzwaGU00bj67XAzb2RzWB9rmkWgS7yed/l/wPax4toA5qOTHZIpVrPBysfd2V4qcO3Y2hl4/DBysXYNtfIWo1Pn1N8+caQdgN2+SIpE9hbJ8V5mZQLwO4wI29HFHT5anSm+WX14YOf2bej/dMM8wfAf9aIJ70EoouMAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"docker compose rails\"\n        title=\"Docker Compose Rails\"\n        src=\"/static/274cc9f675b6637bd48b37c8c0039759/5a190/dockerize-rails.png\"\n        srcset=\"/static/274cc9f675b6637bd48b37c8c0039759/772e8/dockerize-rails.png 200w,\n/static/274cc9f675b6637bd48b37c8c0039759/e17e5/dockerize-rails.png 400w,\n/static/274cc9f675b6637bd48b37c8c0039759/5a190/dockerize-rails.png 800w,\n/static/274cc9f675b6637bd48b37c8c0039759/c1b63/dockerize-rails.png 1200w,\n/static/274cc9f675b6637bd48b37c8c0039759/29007/dockerize-rails.png 1600w,\n/static/274cc9f675b6637bd48b37c8c0039759/efcdd/dockerize-rails.png 3450w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>In order to proceed with the next steps in this post, make sure <a href=\"https://docs.docker.com/get-docker/\">Docker</a> is installed, this installation also comes with docker-compose.</p>\n<h2>1. Run Rails with changes on host machine reflected in container</h2>\n<p>Start by creating a <code>Dockerfile</code> at the root of the project as follows. This particular project uses Ruby version 2.6.6 and is deployed on Debian Stretch. It's a good idea to have the base image be the same as the projects' production environment. This provides an early warning in case of environment issues such as something that works on a laptop (eg: Mac or Windows) but fails or behaves differently in production (eg: Linux).</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"dockerfile\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace this with your Ruby version and Linux flavor/version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> ruby:2.6.6-stretch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Package dependencies</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt-get update &amp;&amp; apt-get install -y curl build-essential gnupg mysql-client</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace with newer bundler version if using</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> gem install bundler --no-document -v </span><span class=\"mtk6\">&#39;1.17.3&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace this with your Node version if newer than 10.x, this is for client side tooling.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install Node.js https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-debian-9</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> curl -sL https://deb.nodesource.com/setup_10.x -o nodesource_setup.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bash nodesource_setup.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt-get install -y nodejs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Skip this if your project uses npm instead of yarn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install yarn https://linuxize.com/post/how-to-install-yarn-on-debian-9/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> echo </span><span class=\"mtk6\">&quot;deb https://dl.yarnpkg.com/debian/ stable main&quot;</span><span class=\"mtk1\"> | tee /etc/apt/sources.list.d/yarn.list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt update</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt install -y yarn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ENV</span><span class=\"mtk1\"> PATH $(yarn global bin):$PATH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Copy all project source to working directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WORKDIR</span><span class=\"mtk1\"> /app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">COPY</span><span class=\"mtk1\"> . /app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run server and client side builds. These steps are performed one time as part of the image build,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># so they don&#39;t need to be re-run each time a container is started.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle check || bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> yarn install --check-files</span></span></span></code></pre>\n<p>Next, create a <code>docker-compose.yml</code> file at the root of the project as follows. Note that the <code>web</code> service refers to the Dockerfile created previously:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The main service that runs a Rails server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">web</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">dockerfile</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Dockerfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># This runs when container started as part of docker-compose up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;rm -f tmp/pids/server.pid &amp;&amp; bundle exec rails s -b &#39;0.0.0.0&#39;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;redis&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount current directory as shared volume for development so that changes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># made to local code will reflect on app running on container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount a persistent docker volume in place of local node_modules directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># this prevents yarn (or npm) errors in case developer has also been running the app natively.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Expose port 3000 from container to host so can run http://localhost:3000 in browser on laptop.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Used in database.yml to tell Rails where the database is.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">DB_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://redis/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run MySQL database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Replace with your MySQL version or refer to Postgres image if using.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mysql:5.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Use a named volume so that changes to db state will persist even if container removed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">db_data:/var/lib/mysql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If a MySQL database is also running on laptop, map 3306 in container to a different port on host,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># such as 3307. Otherwise can use &quot;3306:3306&quot; here. This is useful for connecting a SQL client from</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># host machine to container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3307:3306&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;yes&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Replace with your app&#39;s database name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">MYSQL_DATABASE</span><span class=\"mtk1\">: </span><span class=\"mtk6\">appdb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Enable if required for development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># MYSQL_USERNAME: appdbuser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># MYSQL_PASSWORD: appdbpassword</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run Redis</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If you&#39;re also running a Redis instance on host, map 6379 in container to a different port on host,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># such as 6380. Otherwise can use &quot;6379:6379&quot; here. This is useful for connecting a Redis client from</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># host machine to container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;6380:6379&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># All named volumes referenced by services must be listed here.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db_data</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">node_modules</span><span class=\"mtk1\">:</span></span></span></code></pre>\n<p>Next, modify the application's <code>database.yml</code> file to tell Rails where the database is located:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">adapter</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mysql2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Use DB_HOST environment variable if set, otherwise default to localhost,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This ensures that project can still run the &quot;old fashioned&quot; way when everything</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># is installed directly on laptop.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">host</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;DB_HOST&#39;] || &quot;127.0.0.1&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Replace with your app&#39;s database name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">database</span><span class=\"mtk1\">: </span><span class=\"mtk6\">appdb</span></span></span></code></pre>\n<p>Next, open a terminal and run the following commands to build the app image, and run the containers:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose up</span></span></span></code></pre>\n<p>At this point, the containers should all start up (run <code>docker ps</code> to confirm), but the app won't work yet because the database schema has not been loaded. Hit <kbd>Ctrl</kbd> + <kbd>C</kbd> to stop the containers, then continue to next step.</p>\n<h2>2. Run one-time database setup</h2>\n<p>This project makes use of <code>db/seeds.rb</code> to initialize the database with some sample data, which should only run on first time setup. The solution is to use an ephemeral container, based on the app image to issue the <code>rake db:reset</code> command, if the <code>INIT_DBS</code> environment variable is set. This will drop the database if it already exists, then run <code>db:setup</code> which will create the database, load the schema (defined in <code>db/schema.rb</code> which gets populated every time a new migration is added), and run <code>db:seed</code> to populate the database.</p>\n<p>Aside: See this <a href=\"https://stackoverflow.com/a/10302357/3991687\">Stack Overflow Answer</a> for an explanation of what all the various <code>rake db:xxx</code> tasks do.</p>\n<p>One thing to watch out for, is that the <code>db:reset</code> command cannot run until the database is available to handle requests. We will use <a href=\"https://github.com/vishnubob/wait-for-it\">wait-for-it.sh</a> to solve this synchronization issue.</p>\n<p>Download <a href=\"https://github.com/vishnubob/wait-for-it\">wait-for-it.sh</a> from Github and place it in project root.</p>\n<p>Then modify <code>Dockerfile</code> so that this file is included in the image and made executable:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"dockerfile\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace this with your Ruby version and Linux flavor/version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> ruby:2.6.6-stretch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Package dependencies</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt-get update &amp;&amp; apt-get install -y curl build-essential gnupg mysql-client</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace with newer bundler version if using</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> gem install bundler --no-document -v </span><span class=\"mtk6\">&#39;1.17.3&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace this with your Node version if newer than 10.x, this is for client side tooling.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install Node.js https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-debian-9</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> curl -sL https://deb.nodesource.com/setup_10.x -o nodesource_setup.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bash nodesource_setup.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt-get install -y nodejs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Skip this if your project uses npm instead of yarn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install yarn https://linuxize.com/post/how-to-install-yarn-on-debian-9/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> echo </span><span class=\"mtk6\">&quot;deb https://dl.yarnpkg.com/debian/ stable main&quot;</span><span class=\"mtk1\"> | tee /etc/apt/sources.list.d/yarn.list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt update</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt install -y yarn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ENV</span><span class=\"mtk1\"> PATH $(yarn global bin):$PATH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">############## NEW SECTION TO ADD HERE #############################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Use wait-for-it.sh to control startup order of containers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">COPY</span><span class=\"mtk1\"> wait-for-it.sh /wait-for-it.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> chmod +x /wait-for-it.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">####################################################################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Copy all project source to working directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WORKDIR</span><span class=\"mtk1\"> /app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">COPY</span><span class=\"mtk1\"> . /app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run server and client side builds. These steps are performed one time as part of the image build,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># so they don&#39;t need to be re-run each time a container is started.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle check || bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> yarn install --check-files</span></span></span></code></pre>\n<p>Then modify <code>docker-compose.yml</code> to define a new <code>dbcmd</code> service. Note that it's based on the same app image as the <code>web</code> service, which means that when <code>docker-compose build</code> is run, it won't need to run a separate build for this service because it can re-use the same image that's already been built for the <code>web</code> service. For this to work, the <code>web</code> service definition is modified to name the image <code>app</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The main service that runs a Rails server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">web</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">dockerfile</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Dockerfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">############### ADD THIS LINE HERE #####################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># name this image so it can be used by other containers without requiring a build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># This runs when container started as part of docker-compose up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;rm -f tmp/pids/server.pid &amp;&amp; bundle exec rails s -b &#39;0.0.0.0&#39;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;redis&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount current directory as shared volume for development so that changes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># made to local code will reflect on app running on container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount a persistent docker volume in place of local node_modules directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># this prevents yarn (or npm) errors in case developer has also been running the app natively.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Expose port 3000 from container to host so can run http://localhost:3000 in browser on laptop.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Used in database.yml to tell Rails where the database is.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">DB_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://redis/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">############### ADD NEW SERVICE HERE #####################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Ephemeral container to issue rake db:reset command</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">dbcmd</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Use same image as `web` service to avoid multiple builds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Make sure MySQL is up before attempting db population</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;/wait-for-it.sh&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;db:3306&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;--&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;./docker-entrypoint-dbcmd.sh&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">DB_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Usage to populate databases with seed data: INIT_DBS=yes docker-compose up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">INIT_DBS</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run MySQL database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Replace with your MySQL version or refer to Postgres image if using.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mysql:5.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Use a named volume so that changes to db state will persist even if container removed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">db_data:/var/lib/mysql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If a MySQL database is also running on laptop, map 3306 in container to a different port on host,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># such as 3307. Otherwise can use &quot;3306:3306&quot; here. This is useful for connecting a SQL client from</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># host machine to container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3307:3306&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;yes&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Replace with your app&#39;s database name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">MYSQL_DATABASE</span><span class=\"mtk1\">: </span><span class=\"mtk6\">appdb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Enable if required for development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># MYSQL_USERNAME: appdbuser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># MYSQL_PASSWORD: appdbpassword</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run Redis</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If you&#39;re also running a Redis instance on host, map 6379 in container to a different port on host,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># such as 6380. Otherwise can use &quot;6379:6379&quot; here. This is useful for connecting a Redis client from</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># host machine to container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;6380:6379&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># All named volumes referenced by services must be listed here.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db_data</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">node_modules</span><span class=\"mtk1\">:</span></span></span></code></pre>\n<p>Also add <code>docker-entrypoint-dbcmd.sh</code> to project root which contains the database reset commands for the development and test databases:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sh\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">set</span><span class=\"mtk1\"> -e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$INIT_DBS</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;yes&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;=== INITIALIZING DATABASES&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  bin/rails db:environment:set RAILS_ENV=development </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rake db:reset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  bin/rails db:environment:set RAILS_ENV=test </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rake db:test:reset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">fi</span></span></span></code></pre>\n<p>Now run the build again (since the <code>Dockerfile</code> was modified) and bring up the containers with the <code>INIT_DBS</code> environment variable set to trigger database population:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">INIT_DBS=yes docker-compose up</span></span></span></code></pre>\n<p>Now open a browser and navigate to <a href=\"http://localhost:3000\">http://localhost:3000</a>, your app's homepage should load. It may be very slow due to webpacker compiling front end assets on demand, but not to worry, this will be resolved in the next step.</p>\n<p>Before moving on to next step, make sure that the <code>/app</code> bind mount is working by making a small change to the server side code on your laptop, then check that it's reflected in the <code>web</code> container. For example, add some logging to the <code>index</code> method of the main controller:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.logger.info(</span><span class=\"mtk6\">&quot;Hello from Docker!)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">end</span></span></span></code></pre>\n<p>Refresh the app in browser (assuming it's still on the main page) and watch the console output where <code>docker-compose up</code> is running, it should display <code>Hello from Docker!</code>.</p>\n<h2>3. Run Webpacker</h2>\n<p>The next step is to run a Webpack dev server in another container to watch for changes to front end assets, recompile them, and refresh the browser. This will greatly speed up page load time during development.</p>\n<p>But first, take a look at the <code>dev_server</code> section of <code>config/webpacker.yml</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">dev_server</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">https</span><span class=\"mtk1\">: </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">host</span><span class=\"mtk1\">: </span><span class=\"mtk6\">localhost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">port</span><span class=\"mtk1\">: </span><span class=\"mtk4\">3035</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span></code></pre>\n<p>In order for the Webpack dev server to work in a container, the host can no longer be <code>localhost</code>, instead it should be the container this service will be running in, which will be named <code>webpacker</code>. However, the goal is to also have this setup work in a non Docker environment, so it won't work to simply change it to <code>host: webpacker</code>. One would think that since this is a yaml file in Rails, ERB syntax is supported to make a similar change as was done in <code>database.yml</code>, for example something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">dev_server</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">https</span><span class=\"mtk1\">: </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># DOES NOT WORK!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">host</span><span class=\"mtk1\">: </span><span class=\"mtk7\">host</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&lt;%= ENV[&#39;WEBPACK_HOST&#39;] || &quot;localhost&quot; %&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">port</span><span class=\"mtk1\">: </span><span class=\"mtk4\">3035</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span></code></pre>\n<p>However, this particular yaml file is also used on the JavaScript side therefore ERB cannot be used. Fortunately, Webpacker has a solution for this, the <code>WEBPACKER_DEV_SERVER_HOST</code> environment variable can be specified when running Webpacker, which will override the <code>host</code> value in <code>config/webpacker.yml</code>. It should also be specified in the container running the Rails server.</p>\n<p>Modify <code>docker-compose.yml</code> to add a new <code>webpacker</code> service as shown below. Also note the change to the <code>web</code> container command to specify the <code>WEBPACKER_DEV_SERVER_HOST</code> environment variable.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The main service that runs a Rails server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">web</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">dockerfile</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Dockerfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># name this image so it can be used by other containers without requiring a build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">################ MODIFY COMMAND HERE ####################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># This runs when container started as part of docker-compose up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;rm -f tmp/pids/server.pid &amp;&amp; WEBPACKER_DEV_SERVER_HOST=webpacker bundle exec rails s -b &#39;0.0.0.0&#39;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;redis&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount current directory as shared volume for development so that changes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># made to local code will reflect on app running on container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount a persistent docker volume in place of local node_modules directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># this prevents yarn (or npm) errors in case developer has also been running the app natively.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Expose port 3000 from container to host so can run http://localhost:3000 in browser on laptop.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Used in database.yml to tell Rails where the database is.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">DB_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://redis/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Ephemeral container to issue rake db:reset command</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">dbcmd</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Use same image as `web` service to avoid multiple builds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Make sure MySQL is up before attempting db population</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;/wait-for-it.sh&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;db:3306&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;--&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;./docker-entrypoint-dbcmd.sh&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">DB_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Usage to populate databases with seed data: INIT_DBS=yes docker-compose up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">INIT_DBS</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run MySQL database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Replace with your MySQL version or refer to Postgres image if using.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mysql:5.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Use a named volume so that changes to db state will persist even if container removed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">db_data:/var/lib/mysql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If a MySQL database is also running on laptop, map 3306 in container to a different port on host,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># such as 3307. Otherwise can use &quot;3306:3306&quot; here. This is useful for connecting a SQL client from</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># host machine to container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3307:3306&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;yes&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Replace with your app&#39;s database name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">MYSQL_DATABASE</span><span class=\"mtk1\">: </span><span class=\"mtk6\">appdb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Enable if required for development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># MYSQL_USERNAME: appdbuser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># MYSQL_PASSWORD: appdbpassword</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run Redis</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If you&#39;re also running a Redis instance on host, map 6379 in container to a different port on host,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># such as 6380. Otherwise can use &quot;6379:6379&quot; here. This is useful for connecting a Redis client from</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># host machine to container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;6380:6379&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">############## ADD NEW SERVICE HERE ##################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run Webpack</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">webpacker</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;WEBPACKER_DEV_SERVER_HOST=webpacker ./bin/webpack-dev-server&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">3035:3035</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># All named volumes referenced by services must be listed here.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db_data</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">node_modules</span><span class=\"mtk1\">:</span></span></span></code></pre>\n<p>Now start the containers again (<code>docker-compose up</code>), give webpacker a few seconds to compile all front end assets, then open a browser and navigate to <a href=\"http://localhost:3000\">http://localhost:3000</a>. This time the home page should load quickly. Also make a change to some front end code on your laptop, save it, then watch the terminal where docker-compose is running. Webpack should pick up the change, recompile, and browser should refresh and the change should be visible.</p>\n<h2>4. Running background job processor</h2>\n<p>This project uses <a href=\"https://guides.rubyonrails.org/active_job_basics.html\">Active Job</a> with Delayed Job queuing backend, which uses the <code>delayed_job</code> table. As we've seen in previous sections, the job processor is a separate process therefore will run in its own container. However, because it depends on the existence of the <code>delayed_job</code> table, this introduces another synchronization issue with the database. The simplest solution would be to use <code>wait-for-it.sh</code> again, waiting for the database on port 3306. But this will fail on first time setup when the database is being seeded. Since the seeds take some time to run, its possible the database will be available, but the schema has not yet been applied therefore the <code>delayed_job</code> table doesn't exist yet.</p>\n<p>A custom wait wrapper can be used to solve this. Start by modifying the <code>docker-compose.yml</code> file to add a new <code>delayedjob</code> service:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The main service that runs a Rails server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">web</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">dockerfile</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Dockerfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># name this image so it can be used by other containers without requiring a build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># This runs when container started as part of docker-compose up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;rm -f tmp/pids/server.pid &amp;&amp; WEBPACKER_DEV_SERVER_HOST=webpacker bundle exec rails s -b &#39;0.0.0.0&#39;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;redis&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount current directory as shared volume for development so that changes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># made to local code will reflect on app running on container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount a persistent docker volume in place of local node_modules directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># this prevents yarn (or npm) errors in case developer has also been running the app natively.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Expose port 3000 from container to host so can run http://localhost:3000 in browser on laptop.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Used in database.yml to tell Rails where the database is.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">DB_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://redis/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Ephemeral container to issue rake db:reset command</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">dbcmd</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Use same image as `web` service to avoid multiple builds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Make sure MySQL is up before attempting db population</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;/wait-for-it.sh&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;db:3306&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;--&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;./docker-entrypoint-dbcmd.sh&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">DB_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Usage to populate databases with seed data: INIT_DBS=yes docker-compose up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">INIT_DBS</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run MySQL database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Replace with your MySQL version or refer to Postgres image if using.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mysql:5.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Use a named volume so that changes to db state will persist even if container removed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">db_data:/var/lib/mysql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If a MySQL database is also running on laptop, map 3306 in container to a different port on host,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># such as 3307. Otherwise can use &quot;3306:3306&quot; here. This is useful for connecting a SQL client from</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># host machine to container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3307:3306&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;yes&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Replace with your app&#39;s database name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">MYSQL_DATABASE</span><span class=\"mtk1\">: </span><span class=\"mtk6\">appdb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Enable if required for development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># MYSQL_USERNAME: appdbuser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># MYSQL_PASSWORD: appdbpassword</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run Redis</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If you&#39;re also running a Redis instance on host, map 6379 in container to a different port on host,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># such as 6380. Otherwise can use &quot;6379:6379&quot; here. This is useful for connecting a Redis client from</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># host machine to container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;6380:6379&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Run Webpack</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">webpacker</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;WEBPACKER_DEV_SERVER_HOST=webpacker ./bin/webpack-dev-server&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">3035:3035</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">############## ADD NEW SERVICE HERE ##################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">delayedjob</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Make sure delayed_jobs table has been created before starting jobs processing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;/wait-for-mysql.sh&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;db&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;./docker-entrypoint-delayedjob.sh&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;web&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;dbcmd&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">DB_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># All named volumes referenced by services must be listed here.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db_data</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">node_modules</span><span class=\"mtk1\">:</span></span></span></code></pre>\n<p>Create a new file in project root named <code>delayed_job.sql</code>, this simply queries the <code>delayed_job</code> table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> delayed_jobs;</span></span></span></code></pre>\n<p>Then create a new file in project root named <code>wait-for-mysql.sh</code>. Notice the way it gets invoked from the compose file, the first argument will be the host, in this case the <code>db</code> service to query. Then it enters a loop, invoking <code>mysql</code> client with the <code>delayed_job.sql</code> file. The <code>mysql</code> client is installed on the image as part of the <code>Dockerfile</code>. If the table exists, this will return 0 (i.e. success) and exit the loop. Otherwise, it sleeps for 3 seconds, then tries again. Upon successful exit of the loop, it then runs whatever command the script was called with as its remaining arguments. In our case, <code>docker-entrypoint-delayedjob.sh</code>, which will be created in the next step.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># wait-for-mysql.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># https://docs.docker.com/compose/startup-order/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">host=</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$1</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">shift</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cmd=</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$@</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">while</span><span class=\"mtk1\"> </span><span class=\"mtk9\">true</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  mysql -h </span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">$host</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> -u root appdbpswd </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> /delayed_job.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ $? </span><span class=\"mtk7\">-eq</span><span class=\"mtk1\"> 0 ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">break</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">&gt;&amp;2</span><span class=\"mtk1\"> </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;MySQL delayed_jobs table is UNAVAILABLE - sleeping&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  sleep 3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">done</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt;&amp;2</span><span class=\"mtk1\"> </span><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;MySQL delayed_jobs table is AVAILABLE - executing command&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">exec</span><span class=\"mtk1\"> $cmd</span></span></span></code></pre>\n<p>Add another file <code>docker-entrypoint-delayedjob.sh</code> in project root, which simply starts the Active Job processor:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">set</span><span class=\"mtk1\"> -e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">echo</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;=== RUNNING DELAYED JOBS&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rails jobs:work</span></span></span></code></pre>\n<p>One final change required to make this all work is to modify the <code>Dockerfile</code> to add these additional files and make them executable.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"dockerfile\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace this with your Ruby version and Linux flavor/version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> ruby:2.6.6-stretch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Package dependencies</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt-get update &amp;&amp; apt-get install -y curl build-essential gnupg mysql-client</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace with newer bundler version if using</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> gem install bundler --no-document -v </span><span class=\"mtk6\">&#39;1.17.3&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Replace this with your Node version if newer than 10.x, this is for client side tooling.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install Node.js https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-debian-9</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> curl -sL https://deb.nodesource.com/setup_10.x -o nodesource_setup.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bash nodesource_setup.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt-get install -y nodejs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Skip this if your project uses npm instead of yarn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install yarn https://linuxize.com/post/how-to-install-yarn-on-debian-9/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> echo </span><span class=\"mtk6\">&quot;deb https://dl.yarnpkg.com/debian/ stable main&quot;</span><span class=\"mtk1\"> | tee /etc/apt/sources.list.d/yarn.list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt update</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> apt install -y yarn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ENV</span><span class=\"mtk1\"> PATH $(yarn global bin):$PATH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Use wait-for-it.sh to control startup order of containers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">COPY</span><span class=\"mtk1\"> wait-for-it.sh /wait-for-it.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> chmod +x /wait-for-it.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">############## NEW COMMANDS TO ADD HERE #############################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">COPY</span><span class=\"mtk1\"> wait-for-mysql.sh /wait-for-mysql.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> chmod +x /wait-for-mysql.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">COPY</span><span class=\"mtk1\"> delayed_job.sql /delayed_job.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">####################################################################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Copy all project source to working directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WORKDIR</span><span class=\"mtk1\"> /app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">COPY</span><span class=\"mtk1\"> . /app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run server and client side builds. These steps are performed one time as part of the image build,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># so they don&#39;t need to be re-run each time a container is started.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> bundle check || bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">RUN</span><span class=\"mtk1\"> yarn install --check-files</span></span></span></code></pre>\n<p>Now if the database has not been seeded, and the containers are started, the console will display several <code>MySQL delayed_jobs table is UNAVAILABLE - sleeping</code>. Then when the <code>dbcmd</code> service has finished seeding the database, shortly after the compose console should display <code>MySQL delayed_jobs table is AVAILABLE - executing command</code>, then the Active Job processor should start up. Remember to run a build first as the <code>Dockerfile</code> wss modified:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">INIT_DBS=yes docker-compose up</span></span></span></code></pre>\n<h2>5. Debugging</h2>\n<p>At this point, all app services are fully functional. However, we also need the ability to debug (i.e. step through the code one line at a time, inspecting variables). There are two ways to do this depending on the developers preference - either via command line with <a href=\"https://github.com/pry/pry\">binding.pry</a>, or with an IDE such as VS Code.</p>\n<h3>Command line debugging</h3>\n<p>First add <a href=\"https://github.com/pry/pry\">pry</a> and <a href=\"https://github.com/deivid-rodriguez/pry-byebug\">pry-byebug</a> to the <code>Gemfile</code>, then run <code>docker-compose build</code> to update the app image with these installed gems.</p>\n<p>Given that the <code>pry</code> is available, the line <code>binding.pry</code> can be inserted anywhere in a running Ruby program, which will suspend execution and open an interactive <code>pry</code> session. From there, variable values can be inspected, expressions can be evaluated, basically anything that could be done in pry.</p>\n<p>To make this work in a Docker container, add the following two properties to the <code>web</code> service definition in <code>docker-compose.yml</code>. The code below only shows the web service portion of the file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The main service that runs a Rails server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">web</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">dockerfile</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Dockerfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># name this image so it can be used by other containers without requiring a build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># This runs when container started as part of docker-compose up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;rm -f tmp/pids/server.pid &amp;&amp; WEBPACKER_DEV_SERVER_HOST=webpacker bundle exec rails s -b &#39;0.0.0.0&#39;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;redis&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount current directory as shared volume for development so that changes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># made to local code will reflect on app running on container.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Mount a persistent docker volume in place of local node_modules directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># this prevents yarn (or npm) errors in case developer has also been running the app natively.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Expose port 3000 from container to host so can run http://localhost:3000 in browser on laptop.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">################# ADD THESE TWO PROPERTIES ################################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Keep the stdin open to support attaching to app containers process for binding.pry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">tty</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Allow for sending signals (CTRL+C, CTRL+P + CTRL+Q) into the container</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">stdin_open</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">###########################################################################</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Used in database.yml to tell Rails where the database is.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">DB_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">development</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://redis/&quot;</span></span></span></code></pre>\n<p>Restart the containers with these new properties set, then add <code>binding.pry</code> to any section of code to be inspected, for example, the <code>index</code> method in home controller:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">binding</span><span class=\"mtk1\">.pry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Then open a new terminal and <code>attach</code> to the running <code>web</code> container. You'll need the name of the container to do this, first run <code>docker ps</code>, it will be named after the directory compose is running in. For example, if you're in a directory named <code>myproject</code>, then the <code>web</code> container name will be <code>myproject_web_1</code>. To attach to it, run the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker attach myproject_web_1</span></span></span></code></pre>\n<p>This will display the console output of the <code>web</code> container. It may display nothing at the moment because there's no activity. Let's change that. On your laptop, open a browser and navigate to your project's home page (or any page that will exercise the code where <code>binding.pry</code> was added earlier). Keep an eye on the terminal where the <code>attach</code> command is running. It will now show the console output, AND pause execution at the line where <code>binding.pry</code> was added, and open an interactive pry session. Go ahead and inspect variables.</p>\n<p>When finished, type <code>exit</code> to end <code>pry</code>. Do NOT use <kbd>Ctrl</kbd> + <kbd>C</kbd> to end the attach session because that will cause the process (rails server) in the container to end, which causes the container to exit. Instead, use the detach sequence <kbd>Ctrl</kbd> + <kbd>P</kbd> + <kbd>Q</kbd>.</p>\n<h3>IDE Debugging</h3>\n<p>This is a little more complicated than command line debugging because the Rails server needs to be started in a different way, with some additional ports exposed. To start, make sure the <a href=\"https://github.com/ruby-debug/ruby-debug-ide\">rdebug-ide</a> gem is included in the Gemfile. If it's not, add it, then run <code>docker-compose build</code>.</p>\n<p>Then add a new file to project root named <code>docker-compose.debug.yml</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">web</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;rm -f tmp/pids/server.pid &amp;&amp; WEBPACKER_DEV_SERVER_HOST=webpacker bundle exec rdebug-ide --debug --host 0.0.0.0 --port 1234 -- bin/rails s -p 3000 -b 0.0.0.0&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">depends_on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;db&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;redis&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;webpacker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">node_modules:/app/node_modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># IDE debug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;1234:1234&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;26166:26168&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;26162:26162&quot;</span></span></span></code></pre>\n<p>Now run the containers with the debug file specified as an override. What this will do is override the definition of the <code>web</code> service in <code>docker-compose.yml</code> with the version in <code>docker-compose.debug.yml</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose -f docker-compose.debug.yml up</span></span></span></code></pre>\n<p>Since the <code>command</code> is running <code>rdebug-ide</code>, the rails server won't start as it usually does, but rather, it's waiting for an IDE debugger to be attached. to do that, open your project in VS Code, click on the Run button from the sidebar as shown below:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 448px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/76e3e90dd8376678ac4dc25c2b3b458e/33b38/vscode-run.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 110.71428571428572%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAADO0lEQVQ4y4VU2VYbWRDzF0wO9O7e933xgoGB4LCGkzzk/79GUd0GDyaBedC5DbetlkpVteiHCWe7C5yc6oiSDFXdoRtWcP2Q/9NgmDZ0w1IwXs73kHcse6meF0K2PTuH7bgoqwZdPxGjIs7yEj6J/SBCQLiER/h/QRDGcL0AC2HXdAtZVmC/v8X35x+4v3/i+ROPj88YSS4fqInLrsWm69F1A/p3GEQEBS08KojiBElW4vJqj3uS7O+e1PPVzS0u9g/omg6PbYWHrkHbjWi6iRgPqOWks7xqsVi6PhxKNfwMlp/i6S7HtD3D9O8t+t01vo4r/Npu0KQF/rED6MtQwfRiWF5CzKfpRbCjAgvTcmDarnrJMUzUto60qHA+jngsEtxSVUM7ed2iJoqyZn1bLF0Pum4yEGuGbpA4wiJn4ZO8gu7w6yT34xpfiww/hhZlkiKte9oaULfzOa62yIuaIpYwRMwLhFTULuRLhuPhyzJCYdsYVtfYtR3G7TmqlgTTGqvNDgNPaaeibGCxIzSqm4ns+TReCOUyZuzPnom1Y8KtJqVqnDbIaU9C6FnHOYABUnNV96V3IDsi/HZ3j6vLK6pzlOXvpY+2rObUaK1qaJVKS6khbbfSRhyGKM4OKo8IgzCCKZadCI5l4ybzVZtM6zPUJBvGtXoWu+Nqo+yvtzt1Fuw7mY4jQqlhmOQw3VBdfKm2yNhPMpJiVaZFfiSTJOMl5+vzX2vY0oY0pGb76iWtuUFWtmoEpWYygmLvVDMOc/sWf1iWOmgGL11a5wurwUfTNLR0zmQ3VLlWAaUczSUH4NXiexwIkzSnogYa+1AIv/U62qZmzdYqgIr1lFYRpbIA/pewH5gaVZxYHhwm/cDpqIo5ZUlXCKM4VevtUK93do8ITzUdJ9w2Ytlmyhcp26ZplV0hFMiefN15/03GB4RZXqhtccrBF8Jrtk3JZGsSZRxJ6T8JR2ZY1ZvhvFX6B6HHQgdMUXdCWLyI0krVTBS2tC2QYKQPpcnlTiblQ4VCYjn+vJJk3TMcP4gR02bMwMIoQUCov9mvIesp4/qpZQlgTtlSkCSVvQ/wqWXbWcJxgxeF1tFK+gwfKfwNlPhhpn+FpNcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"VS Code run\"\n        title=\"VS Code run\"\n        src=\"/static/76e3e90dd8376678ac4dc25c2b3b458e/33b38/vscode-run.png\"\n        srcset=\"/static/76e3e90dd8376678ac4dc25c2b3b458e/772e8/vscode-run.png 200w,\n/static/76e3e90dd8376678ac4dc25c2b3b458e/e17e5/vscode-run.png 400w,\n/static/76e3e90dd8376678ac4dc25c2b3b458e/33b38/vscode-run.png 448w\"\n        sizes=\"(max-width: 448px) 100vw, 448px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Then add the following configuration to <code>launch.json</code>. If this file hasn't been created, click on <code>create a launch.json file</code> link in the <code>Run</code> panel.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;name&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Attach to Docker&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;type&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Ruby&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;request&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;attach&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;remotePort&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;1234&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;remoteHost&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;0.0.0.0&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;remoteWorkspaceRoot&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/app&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;cwd&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;${workspaceRoot}&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;showDebuggerOutput&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>After this is added, <code>Attach to Docker</code> will show up in the dropdown menu at the top of the Run panel. Click on the green triangle to run it. This will attach to the Rails server via rdebug-ide on port <code>1234</code>.</p>\n<p>Then add breakpoints in VS Code, navigate to a page in your browser to exercise that code, and VS Code will suspend at that point in the Debugger.</p>\n<h2>6. Run one-off commands such as migrations or tests</h2>\n<p>To run commands such as migrations or tests, the <code>docker-compose run</code> command will be used. This will start up another container based on the service specified (<code>web</code>), overriding the <code>command</code> in the compose file with a provided command. Use the <code>--no-deps</code> option to tell compose not to also start up this service's dependent containers and the <code>--rm</code> option to have this temporary container removed after the command is finished.</p>\n<p>To run migrations: (if you use a rake task, replace the command in quotes with your command)</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose run --no-deps --rm web bash -c </span><span class=\"mtk6\">&quot;bin/rails db:migrate RAILS_ENV=development&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose run --no-deps --rm web bash -c </span><span class=\"mtk6\">&quot;bin/rails db:migrate RAILS_ENV=test&quot;</span></span></span></code></pre>\n<p>A similar technique is used to run tests. Use <code>-e</code> option to override the services' <code>RAILS_ENV: development</code> environment variable to <code>test</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose run -e RAILS_ENV=test --no-deps --rm web bash -c </span><span class=\"mtk6\">&quot;bundle exec rspec&quot;</span></span></span></code></pre>\n<p>More generally, this technique can be used for any command to run against the Rails environment. Anywhere you would have opened a new terminal tab at the project root and run a command, place that command in the quotes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose run --no-deps --rm web bash -c </span><span class=\"mtk6\">&quot;your command here&quot;</span></span></span></code></pre>\n<h2>7. Rails Console</h2>\n<p>Last thing that's needed to complete the development workflow is to have access to an interactive Rails console. Turns out this is simple, use the same technique as in the previous section to run a command against a temporary container from the same image as <code>web</code>. Except this time, since the Rails console is interactive, you will be in a shell in the container until exiting <kbd>Ctrl</kbd> + <kbd>D</kbd>, at which point the container will be removed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker-compose run --no-deps --rm web bash -c </span><span class=\"mtk6\">&quot;bundle exec rails c&quot;</span></span></span></code></pre>\n<h2>Conclusion</h2>\n<p>Phew, that was a lot of work, but well worth it to have a complete development workflow in Docker. This took me several weeks of work to figure out all the details but hopefully will save you some time if you're looking to Dockerize your Rails setup.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/dockerize-rails-app-for-dev-debug-and-testing/"}}}]}},"pageContext":{}}}