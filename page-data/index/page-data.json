{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":29,"edges":[{"node":{"id":"dd1cdd32-e0f8-5581-afb6-87e489963516","frontmatter":{"title":"A VS Code Alternative to Postman","date":"June 2021","category":"Web Development"},"excerpt":"If you've been doing web development for any length of time, you've probably built or worked on an HTTP REST style API and needed a REST…","html":"<p>If you've been doing web development for any length of time, you've probably built or worked on an HTTP REST style API and needed a REST Client to test it. <a href=\"https://www.postman.com/product/rest-client/\">Postman</a> is a very popular choice and I used to reach for this all the time. However, I'd like to share another tool, a VS Code extension that is working better for me, as an alternative to Postman.</p>\n<p>But first, why not just stick with Postman? Below I've outlined a few pain points that have caused me to seek out an alternative.</p>\n<p><strong>Disclaimer</strong> This is not at all to suggest that Postman is a bad product. In fact its very good, feature rich, constantly evolving, and certainly solves a lot of problems for a lot of teams and companies. The following is just my perspective using it as a developer.</p>\n<h2>Why Not Postman?</h2>\n<h3>Context Switching</h3>\n<p>Postman is a separate application that needs to be downloaded and installed, and is separate from the text editor/IDE I use for development (which is VS Code). This requires a context switch, which creates just enough friction to make me a little irritated. It would be nicer to stay in the editor where I can continue to use my preferred keyboard shortcuts, fonts and themes.</p>\n<h3>Team Sharing</h3>\n<p>If you're working by yourself on a project, then the Postman free tier can be sufficient as there's no need to share collections with anyone else. However, if working on a team, it will require being able to share the collection(s) of HTTP requests and environments configuration (dev, qa, staging, prod, etc.) to test your API. This requires a paid Teams account on Postman. If this is an internal API or something proprietary being built for a client, this means trusting a 3rd party (Postman, the company) with the API, and environment information.</p>\n<h3>Backups</h3>\n<p>As you add more and more requests/collections/environments for your API, you will come to depend on Postman and would lose a lot of work if the data were lost. When working on the free tier, collections and environments can be saved to an external json file with the Export feature, but that requires manual work. Or Postman encourages account creation, and then your collections and environments are backed up and synced on their servers. While this is certainly convenient, it does raise the 3rd party trust issue as mentioned earlier.</p>\n<h3>Secrets Management</h3>\n<p>Speaking of trust, many APIs require authentication such as a username/password or token provided on each request. When using Postman, this gets saved as part of the request (or environment if using variables). For a personal side project, this may not be a big deal. But when working on a company project, this effectively makes Postman a secrets manager, especially if storing tokens for staging and production, or other environments that may be publicly accessible. This may not be desirable, especially if the company you're working for already has an approved secrets manager such as LastPass, 1Password, or Vault.</p>\n<h3>Version Control</h3>\n<p>Another thing I find irritating about working with Postman is lack of version control, at least, on the free tier.  The API requests will evolve as the project evolves. If you have to go back to a previous point in time to fix a bug or track down where a regression occurred in the project, it's impossible to \"git checkout ...\" the Postman collection at the same git commit hash. Note that the paid teams account does support version control, which I haven't used. From the <a href=\"https://learning.postman.com/docs/collaborating-in-postman/version-control-for-collections/\">docs</a> it looks like a proprietary system based roughly on Github PRs, accessible via the Postman GUI. But this is not the same as the git you'd be using for version control on the project.</p>\n<h2>VS Code REST Client</h2>\n<p>So what to use instead? I've been using this VS Code <a href=\"https://marketplace.visualstudio.com/items?itemName=humao.rest-client\">REST Client</a> extension for nearly a year and am very happy with it, as it solves all the pain points I've had with Postman. Here a quick introduction to using it.</p>\n<h3>Getting Started</h3>\n<p>After installing the extension, create a new folder somewhere in your project such as <code>requests</code> or <code>http</code> (doesn't matter what you call it, it's just for organization to have a single place for all the \"collections\").</p>\n<p>Now create a file in the folder and give it an <code>.http</code> extension. For example, I'm going to be testing the subscriptions endpoint on my project so will create a file <code>http/subscription.http</code>. Think of this as a Collection in Postman as it supports multiple requests.</p>\n<p>To add the first request, edit the file as follows. If following along with your project's API, replace with appropriate endpoint:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Get all subscriptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> http://localhost:4000/api/v1/subscriptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/vnd.api+json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Myapp-Tenant-Api-Key:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">thekey</span></span></span></code></pre>\n<p>Comments can be added by starting a line with <code>#</code>.</p>\n<p>The request is specified with any of the usual HTTP verbs, followed by the resource endpoint.</p>\n<p>Then following an empty line, the request headers are specified in <code>key: value</code> format. In this case, the request is accepting a json response, and also specifies a custom headers specific to this application for the api key.</p>\n<p>To submit the request, either click on the <code>Send Request</code> text that will appear right above the request line (this is added by the extension), or use keyboard shortcut <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>R</kbd>.</p>\n<p>This will open a new editor tab in a side-by-side view displaying the results. The tab title will contain the HTTP response code, the response headers will be listed in the new editor tab, followed by the response body.</p>\n<h3>Environment Variables</h3>\n<p>A few problems may jump out from the simple example above. Firstly the URL is hard-coded to <code>localhost</code>, which makes this less flexible to test other environments. Second issue is secret api key is hard-coded in the file. This is just a regular file in your project that will be committed to version control so secrets should not be a part of that.</p>\n<p>To fix both of these issues, the extension provides environment variables - this is a similar idea to Environments in Postman. The environment variables are specified in a <code>.vscode/settings.json</code> file at the root of the project. The <code>.vscode</code> directory should be git ignored so this is where the secrets will go.</p>\n<p>First, edit the request in <code>http/subscriptions.http</code> to indicate that <code>host</code> and <code>apikey</code> should be variable - note the double curly brace syntax for variables:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Get all subscriptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/api/v1/subscriptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/vnd.api+json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Myapp-Tenant-Api-Key:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{{apikey}}</span></span></span></code></pre>\n<p>Then configure the variables for each environment you'll be testing against in <code>.vscode/settings.json</code>. For example, if your environments are local, dev, and staging:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;rest-client.environmentVariables&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;$shared&quot;</span><span class=\"mtk1\">: {},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;local&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;host&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;http://localhost:4000&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;apikey&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;local-api-key&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;dev&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;host&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;http://dev.host&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;apikey&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;dev-api-key&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;staging&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;host&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;http://staging.host&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;apikey&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;staging-api-key&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The <code>$shared</code> section is for any non-environment specific variables that should be available even when no specific environment is selected.</p>\n<p>Now at the bottom right of your editor, an environment selector will appear. Click it to select the environment you want to test with, for example <code>local</code>. Or use <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>E</kbd> to bring up the environment selector.</p>\n<p>Then back in <code>http/subscriptions.http</code>, you can hover over the variables and it will show you the value for the selected environment. When submitting the request, the values from <code>.vscode/settings.json</code> are filled in for the variables.</p>\n<h3>Adding Another Request</h3>\n<p>You can add as many requests as you like in a single http file. Simply separate them by an empty line and <code>###</code>. For example, to add a POST request to the <code>http/subscriptions.http</code> file, the POST body follows the request headers after an empty line.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Get all subscriptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/api/v1/subscriptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/vnd.api+json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Myapp-Tenant-Api-Key:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{{apikey}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create a new subscription</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">POST</span><span class=\"mtk1\"> {{host}}/api/v1/subscriptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/vnd.api+json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Content-Type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/vnd.api+json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Myapp-Tenant-Api-Key:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{{apikey}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;type&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;subscriptions&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;attributes&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;status&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;active&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;customer-id&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;some-customer&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;plan-id&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;some-plan&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>I've barely scratched the surface of all the cool features this extension provides, see the <a href=\"https://marketplace.visualstudio.com/items?itemName=humao.rest-client\">docs</a> for a lot more such as cURL and GraphQL support.</p>\n<h2>Why I Prefer This</h2>\n<h3>Editor Integration</h3>\n<p>Using the http requests does not require leaving the editor. The request files get formatted/styled in your theme of choice, fonts, etc. All the customizations you've made to make your editor perfect for you will also apply to the <code>.http</code> files. You can use the usual shortcut keys to find the http files, intellisense on environment variables when editing the http files, and it even supports finding requests by symbol, just like any other code file in VS Code.</p>\n<h3>Version Control, Backups, Sharing</h3>\n<p>The <code>.http</code> files are part of your project, therefore they live under the same version control as the rest of your code. Now you get all the benefits of git and PR reviews, and the requests are tied to the code they're testing. Of course this also means the request files are backed up just like the rest of your code. This also takes care of the team sharing - all the developers on your team will access any newly added http files or requests as soon as they <code>git fetch</code> or <code>git pull</code>.</p>\n<h3>Secrets Management</h3>\n<p>API secrets will not get committed as part of the http files as long as they're specified with environment variables. Then the actual values can be stored in the company's approved secrets manager, which developers can use to populate their git ignored settings file.</p>\n<h2>Drawbacks</h2>\n<p>One potential issue with using a VS Code extension instead of Postman is that the HTTP requests are not easily accessible to non-techies, or anyone who doesn't have access to the git repo where the request files are stored.</p>\n<p>The VS Code client also doesn't run tests the way Postman can (see the Tests tab in Postman if you've never used this feature, can write some assertions about the http response in JavaScript). Although, this can be covered by adding API tests as part of the project itself. For example <code>request</code> type tests with RSpec.</p>\n<p>Finally if not every developer on the team is using VS Code, will have to investigate plugins for other editors that cover similar functionality as VS Code. For example a <a href=\"https://github.com/diepm/vim-rest-console\">rest client for vim</a>.</p>\n<h2>Conclusion</h2>\n<p>If everyone on the team that wants to run requests is able to access version control, and setup VS Code (or another editor that supports the http extension), then this is a great solution and alternative to Postman. I've been using it for nearly a year now, both on work and side projects and am very happy with it. I hope you'll give it a try and see some benefits as well.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/postman-alternative-vscode/"}}},{"node":{"id":"4f25e2ac-c220-5dae-80b6-7a98024fb72a","frontmatter":{"title":"Rails CORS Middleware For Multiple Resources","date":"June 2021","category":"rails"},"excerpt":"A short post for today on a usage of CORS Middleware for Rails (well any Rack application) that wasn't obvious from the docs - how to…","html":"<p>A short post for today on a usage of <a href=\"https://github.com/cyu/rack-cors\">CORS Middleware</a> for Rails (well any Rack application) that wasn't obvious from the docs - how to specify multiple endpoints, or resources?</p>\n<p>If you want Javascript from a web page that is hosted on a different domain than your Rails app (or any app actually) to make HTTP API calls to the Rails app, it will require adding CORS support (Cross-Origin Resource Sharing) on the app server. Otherwise the request will fail due to the <a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\">Same-origin policy</a>.</p>\n<p>In my case, I have a Rails server that provides some back end services for this blog (which is statically hosted on Github Pages). So the blog and Rails server live on different domains. One of the services is privacy focused analytics. Visits to blog pages are recorded via a <code>POST {{my-rails-server}}/visits</code> with some information about the page being visited and user agent (but no cookie is used for further tracking, hence the privacy focus).</p>\n<p>In order for the POST from the blog hosted on Github Pages to be allowed through to the Rails server, the Rails server needs to have CORS middleware configured as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Gemfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem </span><span class=\"mtk6\">&#39;rack-cors&#39;</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins </span><span class=\"mtk6\">&#39;https://danielabaron.me&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/visits&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[post]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>This allows the <code>POST</code> HTTP method on the <code>/visits</code> resource, only from the origin <code>https://danielabaron.me</code>.</p>\n<h2>Multiple Resources</h2>\n<p>This has been working well, but recently I added a second service to the Rails server which also needed to be accessible to the blog with CORS. This is a search service, backed by Postgres full-text search. The API is available via a <code>GET {{my-rails-server}}/search?q=whatever</code>.</p>\n<p>Looking at the <a href=\"https://github.com/cyu/rack-cors#configuration-reference\">Configuration Reference</a> for the Rails/Rack CORS middleware gem, I couldn't determine how to add a second <code>resource</code> to the cors middleware configuration. It says:</p>\n<blockquote>\n<p>A Resource path can be specified as exact string match (/path/to/file.txt) or with a * wildcard (/all/files/in/*)</p>\n</blockquote>\n<p>I already had an exact string match <code>/visits</code>, and only wanted to allow exactly one more <code>/search</code>. A wildcard wouldn't work for this.</p>\n<h2>Solution</h2>\n<p>Turns out, this middleware supports multiple blocks. To allow CORS for two different, exactly specified resources, the following works:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins </span><span class=\"mtk6\">&#39;https://danielabaron.me&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/visits&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[post]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins </span><span class=\"mtk6\">&#39;https://danielabaron.me&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/search&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[get]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Local Development</h2>\n<p>One final tweak to support local development. When developing on this blog (or whatever web app you're working on), it will be running on localhost, for example <code>http://localhost:8000</code>, and the Rails server also runs locally at <code>http://localhost:3000</code>. In this case, the Rails server should accept CORS requests from <code>http://localhost:8000</code>. To get this flexibility, use an environment variable <code>ALLOWED_ORIGIN</code> as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/visits&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[post]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/search&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[get]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.logger.info(</span><span class=\"mtk6\">&quot;Cors Configured to allow origin: </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>When the Rails server runs locally, don't specify any environment variable and it defaults to allowing <code>localhost</code> requests. For production (or any other environment), run the server with the <code>ALLOWED_ORIGIN</code> environment variable set to the origin that requires access.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-cors-middleware-multiple/"}}},{"node":{"id":"b0cddc64-856c-548f-8d68-f449a0f43e28","frontmatter":{"title":"TDD by Example: Fixing a Bug","date":"May 2021","category":"javascript"},"excerpt":"This post will demonstrate an example of using TDD (test driven development) to fix a bug on an existing project. If you're not familiar…","html":"<p>This post will demonstrate an example of using TDD (test driven development) to fix a bug on an existing project. If you're not familiar with TDD, see an <a href=\"/blog/tdd-by-example/\">earlier post</a> I wrote on this topic.</p>\n<h2>Discovering the Problem</h2>\n<p>Last month when running my monthly expense report with <a href=\"https://github.com/danielabar/tidysum\">Tidysum</a> (a Node.js command line program I wrote that processes a csv list of daily expenses and outputs a summary json with year and month breakdowns of expenses by category, and makes savings/spending recommendations and calculates a personal rate of inflation), it seemed to be under-reporting April's spending by roughly $200. Although my spending has been lower during Covid times because, you know, there's nothing to do, nevertheless the total amount for April seemed unusually low.</p>\n<p>Digging into the input <code>expenses.csv</code> file, I found the issue - notice the second line in this snip from the file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-11,131.32,Groceries,Metro</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04,24,194.87,Groceries,Metro &lt;-- BUG HANDLING THIS LINE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-25,20.00,Gas,Shell</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<p>The expected format for the input csv is: <code>date in YYYY-MM-DD format,numeric spending amount,category,store</code>. However, the second line has a typo in the date, there's a <code>,</code> where the second <code>-</code> should be. But, <code>2021-04</code> is a valid date. So what the program did is take the first field <code>2021-04</code> as the date, then the second \"field\", which was really the date portion of <code>24</code> as the amount field, then the amount field of <code>194.87</code> which was now the third field got tracked as a category, and the actual category <code>Groceries</code> was now the fourth field and got tracked as the store. The final field <code>Metro</code> which is the actual store ended up in the fifth position and was ignored entirely. This is how the spending of <code>$194.87</code> got incorrectly recorded as <code>$24.00</code> and that's how total spending for April was under-reported.</p>\n<p>Normally when a developer discovers a bug in their code, there's an instinct to dive in, figure out what's wrong and fix it as quickly as possible. But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven't actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass.</p>\n<p>The benefit of this approach is it forces you to first think about how the code should behave under the bug circumstances by documenting it in a test. Then having the test ensures that this bug will never creep into your code again.</p>\n<p>So first things first, let's figure out where in the code this problem with processing potentially invalid data occurs.</p>\n<p><strong>Aside:</strong> Some of you may be wondering why write a custom program for expense tracking when there's Excel and countless free apps out there, a <a href=\"https://github.com/danielabar/tidysum#why-not-use-excel\">short explanation here</a>.</p>\n<h2>Analysis</h2>\n<p>Looking at the code, I realized there was no validation of the input file. It's read in via a csv stream library and processed one line at a time, assuming each line is in the expected format. Here's the relevant code starting from the command line entrypoint:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// index.js (entrypoint)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expense </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./lib/expense&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Left out some code for brevity - that grabs the command line arguments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// including `argv.e` which is path to expense file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk7\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> expense.</span><span class=\"mtk5\">process</span><span class=\"mtk1\">(argv.e);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  fs.</span><span class=\"mtk5\">writeFileSync</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;expenses.json&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9\">JSON</span><span class=\"mtk1\">.</span><span class=\"mtk9\">stringify</span><span class=\"mtk1\">(result, </span><span class=\"mtk4\">null</span><span class=\"mtk1\">, </span><span class=\"mtk4\">2</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})();</span></span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/expense.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// No validation, inputFile is passed as is to processFile function.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// csv-streamify exposes the data as an array of values from csv line</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// eg: 2020-04-29,194.23,Groceries,Metro turns into:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// [&#39;2020-04-29&#39;, &#39;194.23&#39;, &#39;Groceries&#39;, &#39;Metro&#39;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">processLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use destructuring assignment to unpack values out of array that csv-streamify generated from line in csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> [dateStr, amountStr, category, merchant] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> line;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">processEntry</span><span class=\"mtk1\">({ dateStr, amountStr, category, merchant }, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processEntry</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">data</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Begin calculations...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The critical part is this line that uses <code>csv-streamify</code> to stream in the csv file one line at a time:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>At this point, <code>line</code> is an array of values from the line in the csv file that was just read. There will be one entry in the array for each value in the csv line. Then this array <code>line</code> gets passed to the <code>processLine</code> function which uses <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment\">destructuring assignment</a> to unpack the values in the <code>line</code> array into individual values:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use destructuring assignment to unpack values out of array that csv-streamify generated from line in csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> [dateStr, amountStr, category, merchant] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> line;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This is where the bug occurs because if the csv line had a comma instead of an expected dash in date such as <code>2021-04,24,194.87,Groceries,Metro</code>, then the variables will be assigned as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;24&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;194.87&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dateStr </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;2021-04&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">amountStr </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;24&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">category </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;194.87&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">merchant </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Groceries&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Metro is ignored</span></span></span></code></pre>\n<h2>Define Expectations</h2>\n<p>Now that the analysis has revealed how the bug occurs, the next step is to determine how the program <em>should</em> behave when given invalid data. This \"should\" behaviour will then get encoded into a test.</p>\n<p>If this was a work project, the decision as to how the program should behave usually goes to the product manager/owner. But in this case, it's a side project which makes me the product owner so I need to decide. Given that this is a financial application, it doesn't make sense to perform <em>any</em> calculation if even a single record is invalid. This is because all the numbers get added, averaged, and compared. So even one number being off could throw off all the results.</p>\n<p>What this means is that there should be a validation step <em>before</em> the file is processed for calculation. This validation should read in all lines of the file and for each line, check that it has exactly 4 fields. Any more or less is a sign that the data is probably incorrect. There's other things that could be validated like the date format and numeric spending amount, but will get to that later. It's easier to start with just a single validation and then add in more.</p>\n<p>As the program finds invalid lines, it should accumulate these. For each invalid line it should record all the things that are wrong with it. For now there will only be one thing its checking (number of values), but there could be more.</p>\n<p>Then before the program goes into the calculation step, it should check if any validation errors occurred, stop and return these instead of going into the calculation step.</p>\n<h2>Write a Failing Test</h2>\n<p>Since the bug can be observed from the results of the <code>process</code> function in <code>lib/expense.js</code>, I will start with writing a test for this function. The test will provide an invalid input file to the <code>process</code> function, and expects some validation errors returned instead of the usual calculations that <code>process</code> would return.</p>\n<p>It's very likely that the validation implementation won't go in the <code>process</code> function itself because the <code>lib/expense.js</code> module is about calculating expenses. Keeping with the <a href=\"https://en.wikipedia.org/wiki/Single-responsibility_principle\">single responsibility principle</a>, the actual validation will be performed by another module, and <code>process</code> will just call out to it before proceeding with calculation. However, I don't want to get into any implementation details before having at least one failing test in place, and since I can see the buggy behaviour from <code>process</code>, this is where I'm starting with a (failing) test.</p>\n<p>This project uses the <a href=\"https://mochajs.org/\">Mocha</a> testing library with <a href=\"https://www.chaijs.com/\">Chai</a> expect-style assertions, but the same TDD principles would apply to any test framework/library.</p>\n<p>The <code>process</code> function is asynchronous because it reads in a file, so the test will also be asynchronous. As for the input file for the test, this project already has a <code>test/fixtures</code> directory, so will first write an <code>invalid-data.csv</code> test file and place it in the fixtures directory:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// test/fixtures/invalid-data.csv</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04,29,194.32,Groceries,Metro</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-30,45.87,Electronics</span></span></code></pre>\n<p>This input file has two invalid lines. The first one has 5 fields and the second one has 3 fields. Recall the expectation is each line should have exactly 4 fields. The first line has an additional problem that the date format is incorrect, but for now we're only interested in the \"number of fields\" validation.</p>\n<p>The test will pass the invalid file from the <code>test/fixtures</code> directory to the <code>process</code> function, then define an expected result object containing the line errors, then use chai's <code>deep.equal</code> assertion to verify that the actual result returned from <code>process</code> matches the expected result.</p>\n<p>Where does the expected result object come from? That's my requirements that I decided on what would be a nice easy way to show the errors to the user. Remember, this isn't implemented yet, the test is how you can express the thought - \"I wish the program worked like this\"...</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/expense.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expense </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/expense&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;processExpenses&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;process&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Contains validation errors&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> expense.</span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">process.</span><span class=\"mtk9\">cwd</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span><span class=\"mtk6\">/test/fixtures/invalid-data.csv`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        hasErrors: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04,29,194.32,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 5.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-30,45.87,Electronics&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedResult);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Doesn&#39;t process year results from file due to validation errors</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).not.to.have.any.</span><span class=\"mtk5\">keys</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;2021&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Run <code>npm test</code> in a terminal to run the tests, and as expected, this new test fails because validation has not yet been implemented.</p>\n<p>You can see the bug in action here because the code is attempting to run calculations on invalid data. There's a category of <code>194.32</code> due to the date parsing error on the first invalid line. Also there's a Merchant of <code>undefined</code> which comes from the second invalid line that only has 3 fields (missing Merchant field). And the total spending is incorrect, it should be <code>194.32</code> + <code>45.87</code> = <code>240.19</code> (the intended amounts from input data if it were valid), but instead the total is <code>29</code> (from incorrectly parsed date in ine 1) + <code>45.87</code> = <code>74.87</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6b0b734a2ffb50eac107906c4cb08ac4/ef6b9/tdd-bug-fail-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 117.54807692307692%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsSAAALEgHS3X78AAACC0lEQVQ4y51V0ZabIBD1L5qICoKAGE2y2/b0oadn//+rZu8gGLeb3WgerjPgeBnmDliYwZG0HSndUaM01bJdUDXqw3gLiut0oZfrKw3jOU6IWkbcyLaT8jeFG0b6+++NTiAOgMc4gLxpDQkEVLwI7CPkBAqNDIK1FExHk7E0wrLfY/seAQbo1QwHn+fYBry3K7/NGcquIzF4klpTjwnFKwESAYwm2TWalc3+smUF9hEDjcFhSX9+uRdxy+w4bOcPanYFuUurPqNyzDB/PIHskgi5bu2zbZNr8AsZ/gQ8srX/ke0hLqIAtaIJdTuzokm5pxu7ajVV14HUZaA6OGrNrf8yabWLEO1SBk/HcyDhbCSrV2CyjHoD+ZwhnwZkKEBaMSn6UnhL/G4hWdnva8gXApr7CKISJOWpJ4GtR1IGj2E/kH9LyMcJ6v4G+AipmMVNkN1b5qAGyG0zgnRIxJX8XM/HW8ZDofcGzrSZD79Oi6yzrDeqHVWuATlBENSuYZG0mWvGQfX27BaVBQh/QOEDSA9jH+3x5KnsIQ5u80rtyJAfFvefR0P3gIPaDqobBvxmNyECQ7rCTlLHo6dRyzYi1/L+zXKXUKJeAhkc8R9hlAhcwP+XJI64c/fdIy34b2c6PsOWjPWkYSMwl+fbNCfRVg8zVAiyro9k1gfqkm+si34XfQ/fx0XaRPwV4TuFXJRopUHWowAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 1\"\n        title=\"tdd bug fail 1\"\n        src=\"/static/6b0b734a2ffb50eac107906c4cb08ac4/5a190/tdd-bug-fail-1.png\"\n        srcset=\"/static/6b0b734a2ffb50eac107906c4cb08ac4/772e8/tdd-bug-fail-1.png 200w,\n/static/6b0b734a2ffb50eac107906c4cb08ac4/e17e5/tdd-bug-fail-1.png 400w,\n/static/6b0b734a2ffb50eac107906c4cb08ac4/5a190/tdd-bug-fail-1.png 800w,\n/static/6b0b734a2ffb50eac107906c4cb08ac4/ef6b9/tdd-bug-fail-1.png 832w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Make the Test Pass</h2>\n<p>Finally, it's time to implement some validation!</p>\n<p>Looking again at the <code>process</code> function, it needs to read the entire file for validation purposes <em>before</em> going into the calculations, and if any validation errors are found, return them instead of going on to perform calculations. Since I know the actual validation logic doesn't belong here, I will introduce a new <code>validator</code> module and call out to it. Will get to writing this shortly. Since reading a file is an asynchronous operation in Node.js, the function to be exposed by the validator module must also be asynchronous.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/expense.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// NEW MODULE (not written yet)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEW CODE ADDED HERE: Call validator module to process file, if any errors, return immediately</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validationResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> validator.</span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (validationResult.hasErrors) </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> validationResult;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Since some implementation code has been added, <code>npm test</code> to run tests again. Not surprisingly, the expense test fails because the new <code>validator</code> module cannot be found:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 542px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/419af29638021620f798a0348fff7898/c0388/tdd-bug-fail-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.490774907749078%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA80lEQVQY02WQWZaCMBBFWYetDCLN5MAkKCQhCQH3v6JnKnb3T3+8U9Opdyvx8vKCuu2QFWd09wHl+YrLrULddLhWDeIktbFGe+/dbHcI8GW190McguhPv7V3qxss64auH6CXFU3XI81LFHaZIEmao7BQqgl++s4QxQn88Ijd3v9n7oXHE7iQTmQ8Kw0+Swip8XhONleuN3EBJmaoxUDYXtW0yCyYoEEUO3My9qggMyEVzPqC0gZSL+7akXFnTCDqSfXRYjaY7eVybVYHqurWvib7GNLiOHG3xKw547O7cniO7jKCsR8oiXo0p0h6jMz9O134BjjAn4fwsj1iAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 2\"\n        title=\"tdd bug fail 2\"\n        src=\"/static/419af29638021620f798a0348fff7898/c0388/tdd-bug-fail-2.png\"\n        srcset=\"/static/419af29638021620f798a0348fff7898/772e8/tdd-bug-fail-2.png 200w,\n/static/419af29638021620f798a0348fff7898/e17e5/tdd-bug-fail-2.png 400w,\n/static/419af29638021620f798a0348fff7898/c0388/tdd-bug-fail-2.png 542w\"\n        sizes=\"(max-width: 542px) 100vw, 542px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>To fix this, need to add the validator module and expose a <code>processFile</code> function:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// TODO: Stream in csv file and validate each line</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This time when running the tests, get a failure about being unable to read property <code>hasErrors</code> of undefined, which makes sense since the <code>processFile</code> function of the <code>validator</code> module doesn't return anything yet:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 558px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c46b4eda546cf6ed38975ce6d2e1898c/42a8d/tdd-bug-fail-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.634408602150536%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABIUlEQVQoz5VR0W6DMAzkMzZaQkKCA6EVrFBKW6nTtD1M+///uV0olaqp0raH0xk7Pp9NklaCtPF4Ch66FLjSQ+kCa6WR5ebfSEpxqGtBIFRhoY2dC48E/zIkESfwViDGze6cVDDWPW7+RTD2JKWvcbq84uPzC5e3d/TjBKkbpFmOlA8iPxMrxis2zUysF77/nh2mawXLm50pdJ5OaCjWdzucDkcMLz0Gxsf9CKF7Q2HLJkNooiAcEXMqOoyCMegKh714dHTbcuVhZo/eVxgZT3VAbUu0PMWOHHhnS0cNe1ttsIkDFqdJtFpQRMJmXlVCA99sYf01F7bttVaFpX595zjI0LXmP8hdiSJuwGHJ7dBqOay6B08Rkf2sMZcvtRvf8A3PLeHn4P3vMwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 3\"\n        title=\"tdd bug fail 3\"\n        src=\"/static/c46b4eda546cf6ed38975ce6d2e1898c/42a8d/tdd-bug-fail-3.png\"\n        srcset=\"/static/c46b4eda546cf6ed38975ce6d2e1898c/772e8/tdd-bug-fail-3.png 200w,\n/static/c46b4eda546cf6ed38975ce6d2e1898c/e17e5/tdd-bug-fail-3.png 400w,\n/static/c46b4eda546cf6ed38975ce6d2e1898c/42a8d/tdd-bug-fail-3.png 558w\"\n        sizes=\"(max-width: 558px) 100vw, 558px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Next step, need to fill in that <code>processFile</code> function for validation. I'm using the same <a href=\"https://github.com/klaemo/csv-stream\">csv-streamify</a> library already used in the project to process the file for calculations. The basic skeleton for reading in a file via streams with this library is like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `data` event for every line read from csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// `line` is an array of values from the current line in csv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Validate `line` array size</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Return validation results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;finished&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>Aside:</strong> Why use a streaming approach to read in the expense file? While certainly the code would be easier to read by reading the entire file into memory in a single operation, this won't scale. If the user has been diligently tracking their every single expense for many years, the expense file could grow too large to fit into memory and then the program would crash. A full discussion of Node.js streams is outside the scope of this article, but if you'd like to learn more about this topic, see the <a href=\"https://nodejs.dev/learn/nodejs-streams\">Streams</a> documentation.</p>\n<p>Back to implementation. Since the csv input file is being read one line at a time, an object is needed to accumulate the results of validation. What should this object look like? This is the expected result specified in the test (that is currently failing), recall the expected object to be returned from this function looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  hasErrors: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      line: </span><span class=\"mtk6\">&#39;2021-04,29,194.32,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 5.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      line: </span><span class=\"mtk6\">&#39;2021-04-30,45.87,Electronics&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>There's two levels of accumulation that can be happening with this object. First is the <code>lineErrors</code> array, which should contain an entry for each line that has a problem. Then each line could potentially have more than one thing wrong with it, so the <code>errors</code> property within each <code>lineErrors</code> entry is an array to record <em>all</em> the issues with this line.</p>\n<p>To build up this object, will initialize an <code>output</code> object with <code>false</code> for <code>hasErrors</code> property (being optimistic, start with assumption that nothing is wrong unless proven otherwise), and an empty array for <code>lineErrors</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Accumulator object to record all validation errors and be returned to caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `data` event for every line read from csv file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// `line` is an array of values from the current line in csv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Validate `line` array size and record results in `output` object</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Return validation results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;finished&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Next need to populate the <code>output</code> object <code>lineErrors</code> array for each line that doesn't have exactly 4 fields. This logic will go on the <code>.on('data')</code> event since this is where the line value is available. The line will be collapsed back to a comma separated string to make it easier to read, and a helpful error message is set stating the expected number of fields, and how many were actually in this line:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Accumulator object to record all validation errors and be returned to caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// collapse the array back into a comma separated string to make the result easy to read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          errors: [</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// TODO: Return validation results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;finished&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>But this still won't make the test pass because the <code>output</code> object isn't yet being returned. Since this is an asynchronous function, to \"return\" a value is to pass it to the <code>resolve</code> function of the <code>Promise</code>. This means some logic needs to be added to the <code>.on('end')</code> event which is called when the entire file has been read. Currently its resolving with a string <code>finished</code>. This needs to be modified to first set <code>hasErrors</code> property of object if there's at least one entry in its <code>lineErrors</code> array, and then resolve it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Accumulator object to record all validation errors and be returned to caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// collapse the array back into a comma separated string to make the result easy to read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          errors: [</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// will receive the `end` event when entire csv file has been read</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// result is returned to caller by resolving the promise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (output.lineErrors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.hasErrors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Start reading the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And finally, the test passes!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 543px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b2527dd634069a64835746c9cd031e7/29579/tdd-bug-pass-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.12707182320442%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAbUlEQVQI142NzQ5AMBCE+yBU/61yII5S4iK8/wONtgeJiHCY2c1m5lvGhYIjD+MIddOCfAehDAouHiorec03sWRTmLHtB8Kyoh/GDE9FLu7hL1gGFmX8HouSCMbWqKSG1BY2QhNYGZf3dP8DPAHFgFP9lbPO0wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug pass 1\"\n        title=\"tdd bug pass 1\"\n        src=\"/static/3b2527dd634069a64835746c9cd031e7/29579/tdd-bug-pass-1.png\"\n        srcset=\"/static/3b2527dd634069a64835746c9cd031e7/772e8/tdd-bug-pass-1.png 200w,\n/static/3b2527dd634069a64835746c9cd031e7/e17e5/tdd-bug-pass-1.png 400w,\n/static/3b2527dd634069a64835746c9cd031e7/29579/tdd-bug-pass-1.png 543w\"\n        sizes=\"(max-width: 543px) 100vw, 543px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Refactoring: Extract Method</h2>\n<p>There's still more work to be done though. Remember the number of fields is not the only thing that could be wrong with a line in the input file. The program should also validate that the date is in expected <code>YYYY-MM-DD</code> format and that the amount field is numeric.</p>\n<p>However, looking at the <code>processFile</code> function in the <code>validator</code> module currently, it's getting messy. There's the complexity of streaming the csv file to read it, which needs to respond to the <code>data</code> and <code>end</code> events, and the validation is implemented inside the <code>data</code> event handling. Adding more validation rules here will only make the code messier.</p>\n<p>It would be cleaner to extract a <code>validateLine</code> function that will perform all the validation rules on a given line, accumulating the <code>errors</code> array for this line, and have the <code>.on('data')</code> event handler call out to this new <code>validateLine</code> function to perform the validation. Let's get this refactoring done before adding any further validation rules.</p>\n<p>Often when refactoring, new bugs can be introduced, which can make developers hesitant to try and improve existing code. This is where TDD really shines. A test has already been written to verify the expected behaviour. If the test fails after refactoring, then it will be obvious that the refactor broke something and needs to be fixed. In other words, TDD allows you to refactor with confidence.</p>\n<p>Here is the refactored <code>validator</code> module with a new <code>validateLine</code> function. This function receives as arguments the <code>line</code> array from the csv file, and the <code>output</code> object for accumulating <code>lineError</code> entries. It then builds up a <code>lineErrorEntry</code> object with an <code>errors</code> array. For now only one message can be pushed to the <code>errors</code> array about the number of fields.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      hasErrors: </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> parser </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">csv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Rather than doing validation right here in event handler,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// call out to validateLine function to do the work.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parser.</span><span class=\"mtk5\">on</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (output.lineErrors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        output.hasErrors </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fs.</span><span class=\"mtk5\">createReadStream</span><span class=\"mtk1\">(file, { encoding: </span><span class=\"mtk6\">&#39;utf8&#39;</span><span class=\"mtk1\"> }).</span><span class=\"mtk5\">pipe</span><span class=\"mtk1\">(parser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate number of fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// If found at least one thing wrong with this line, add it to the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (lineErrorEntry.errors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And the tests still pass. Good, this refactor didn't break anything, and the code is cleaner.</p>\n<h2>More Validation: Date Format</h2>\n<p>Now we're in a good position to add more validation. Recall that the <code>invalid-data.csv</code> being passed to the test had one line with two things wrong with it. The number of fields, and invalid date format of <code>YYYY-MM</code> whereas the program is expecting <code>YYYY-MM-DD</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04,29,194.32,Groceries,Metro  &lt;-- 5 fields should be 4, AND date is YYYY-MM</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-04-30,45.87,Electronics</span></span></code></pre>\n<p>According to the TDD process, before modifying the validation code to add date format validation, first the test should be updated to expect a new error message for date format. Notice the first <code>lineErrors</code> entry now expects 2 error messages in the <code>errors</code> array. The first one is for number of fields, the second message is for the date format.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/expense.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expense </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/expense&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;processExpenses&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;process&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Contains validation errors&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> expense.</span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">process.</span><span class=\"mtk9\">cwd</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span><span class=\"mtk6\">/test/fixtures/invalid-data.csv`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedResult </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        hasErrors: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04,29,194.32,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// NEW ERROR MESSAGE EXPECTATION ADDED HERE:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 5.&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Date format must be YYYY-MM-DD.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-30,45.87,Electronics&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedResult);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Doesn&#39;t process year results from file due to validation errors</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).not.to.have.any.</span><span class=\"mtk5\">keys</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;2021&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>This time the test will fail because the date format validation has not yet been implemented:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/74b2086624adfa8ddb40558c923f4421/eb3fa/tdd-bug-fail-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.614035087719294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAA7UlEQVQoz5VSW3KDMAzkHgRjW36BgZS0nd7/ZFtJjTMMH0nzsUiWrEUruTOe4FLAYD0GY3G5Yxjd25C6zvmAj/2G6+0LFDOMI8XlQP5fCGknzrps2K87SpkxTxU5FVhOCsaTPaPFHx2KTBcDYsmoLDvw2TMCXxDQ3XpGPMWaL3HTCOVjWPa6f2KuK0aRbEn/2HOub/YFHpK1cBiR6oL68w3aFsRthd0qeiJd1FtLacwhF3heSuIZpmlWO3HHied6HvyzV6CEItOHCEd/sDyCoy/5YxfPulTJUuhDQkhZn46cxVJMGieGEBte2ivCX4+o+QiHJljNAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 4\"\n        title=\"tdd bug fail 4\"\n        src=\"/static/74b2086624adfa8ddb40558c923f4421/5a190/tdd-bug-fail-4.png\"\n        srcset=\"/static/74b2086624adfa8ddb40558c923f4421/772e8/tdd-bug-fail-4.png 200w,\n/static/74b2086624adfa8ddb40558c923f4421/e17e5/tdd-bug-fail-4.png 400w,\n/static/74b2086624adfa8ddb40558c923f4421/5a190/tdd-bug-fail-4.png 800w,\n/static/74b2086624adfa8ddb40558c923f4421/eb3fa/tdd-bug-fail-4.png 1026w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now let's go back to the <code>validateLine</code> function of the <code>validate</code> module to add date format validation. The technique used here is to <a href=\"https://momentjs.com/docs/#/parsing/string-format/\">parse</a> the date using moment.js in strict mode (passing boolean <code>true</code> as the third argument), then checking the resulting moment.js object's <code>isValid()</code> function to determine if parsing worked as expected.</p>\n<p><strong>Aside:</strong> This program is from a few years ago and already using moment.js for date handling so will continue using that for the validation. However, if starting a new project, there are more lightweight and modern <a href=\"https://momentjs.com/docs/#/-project-status/\">alternatives</a> available.</p>\n<p>Here is the updated <code>validateLine</code> function with additional date validation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> fs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;fs&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> moment </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;moment&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// same code as before...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate number of fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate date format</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk5\">moment</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">], DATE_FORMAT, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk5\">isValid</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Date format must be </span><span class=\"mtk7\">${</span><span class=\"mtk1\">DATE_FORMAT</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// If found at least one thing wrong with this line, add it to the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (lineErrorEntry.errors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Now the updated test passes.</p>\n<h2>From Integration to Unit Test</h2>\n<p>Up until this point the validation code has been test driven from the <code>process</code> function test of the <code>expense</code> module. This is an integration test because it's using file I/O and testing the result of multiple modules working together. It was a good place to start with testing because that's where the buggy behaviour was observed. But now that the program is taking shape and we see that the actual validation logic is in a validation module, it's time to move one level lower and unit test just the validation module. While it's great to have higher level integration tests to ensure all the modules work together, these can be slower than unit tests.</p>\n<p>I'd like to just test the <code>validateLine</code> function of the <code>validator</code> module because it doesn't require a file input, allowing the tests to focus on passing it just one invalid line at a time. Here is a skeleton of the <code>validator</code> module test and a few tests that cover the existing validation rules for number of fields and date format. A <code>beforeEach</code> block is used to reset the <code>output</code> accumulator object to an empty state before each test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/validator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validateLine&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> output;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">beforeEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets errors when number of fields is greater than 4 and date field is invalid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;05&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;78.34&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;foo&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04,05,78.34,Groceries,Metro,foo&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 6.&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Date format must be YYYY-MM-DD.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when number of fields is less than 4&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04-05&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;78.34&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-05,78.34,Groceries&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Expected 4 fields, got 3.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>These tests cover functionality we've already seen working from the <code>expense</code> module integration test, so these <em>should</em> pass as well. However, they fail with the error <code>validator.validateLine is not a function</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a04a78af118c9a50e87c37af8fbd9a49/8bd7c/tdd-bug-fail-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.307692307692314%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABN0lEQVQoz42SWXKDMBBEuUYco4VFSEjINtgFTlK5/606LeIFY6cqH08zEqOheyBTRYXTOGG376GKErlQEFLP5Beue7lALOKWd6612ZZLMBajbTGUFXaqwKALRMaUB3IgHalY2xBDUl5f4lPDjeZGaSheEi8UiIWSO/oWc3nPM0k1tTOQdQmhy9Wl/5EvXpbJZMdHHE8jqsZRafFIsrLIRXKx4sHyOzdtY/E9nXFm02O3Q0+G0CG2AdF36CPPGK3zcCm2HoYzb9xvfGqoOT9T1WhMg8AiS6XeOriZdsZUBumPWCvK1x9Fcm4uRHSHAaqs8ZbLmQ2LblzOXs3saYZpsbT89fGJaTxznrTaRXjXzrmlykDrnsqF0g/KXipMlg1VRjYNtNp7zo3N9iSySbDtvO/4XP9heckPlIMZCDtmzKUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 5\"\n        title=\"tdd bug fail 5\"\n        src=\"/static/a04a78af118c9a50e87c37af8fbd9a49/5a190/tdd-bug-fail-5.png\"\n        srcset=\"/static/a04a78af118c9a50e87c37af8fbd9a49/772e8/tdd-bug-fail-5.png 200w,\n/static/a04a78af118c9a50e87c37af8fbd9a49/e17e5/tdd-bug-fail-5.png 400w,\n/static/a04a78af118c9a50e87c37af8fbd9a49/5a190/tdd-bug-fail-5.png 800w,\n/static/a04a78af118c9a50e87c37af8fbd9a49/8bd7c/tdd-bug-fail-5.png 845w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The reason for this is the <code>validator</code> module currently only exposes the <code>processFile</code> method in its exports. Strictly speaking that's the only \"public\" method needed for the module because it's only used by the <code>expense</code> module, which only calls <code>processFile</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Only one function is public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, in order to unit test the <code>validateLine</code> method of the <code>validator</code> module, it must also be exposed in the <code>module.exports</code> section, effectively making it public. This is one of the few times that I miss Java, where the <code>default</code> and <code>protected</code> <a href=\"https://www.programiz.com/java-programming/access-modifiers\">access modifiers</a> are perfect for this purpose. A method can be marked <code>default</code> or <code>protected</code> to give it package level visibility, which makes it available to the test which lives in the same package, but doesn't make it <code>public</code> to the entire program.</p>\n<p>One way around this in JavaScript is to extract out the method to be tested into yet another module, say <code>validator-details.js</code>, expose that method publicly in the new module, then have the <code>validator</code> module call out to <code>validator-details</code> module. However, this feels like way too much overhead for this purpose so I'm simply going to add <code>validateLine</code> to the list of public methods in the <code>validator</code> module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NOW validateLine can be unit tested</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validateLine,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And this makes the tests pass, including the new tests in <code>test/lib/validator.test.js</code></p>\n<h2>More Validation: Numeric Amount</h2>\n<p>The last validation to add is to ensure the spending amount provided in each csv line is numeric. Now that we have lower level unit testing set up for the <code>validator</code> module, let's add this test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/validator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validateLine&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> output;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">beforeEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets errors when number of fields is greater than 4 and date field is invalid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when number of fields is less than 4&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NEW TEST HERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when amount is not numeric&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04-27&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;1o7.e8&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            line: </span><span class=\"mtk6\">&#39;2021-04-27,1o7.e8,Groceries,Metro&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            errors: [</span><span class=\"mtk6\">&#39;Amount must be numeric.&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>At this point, the test will fail because numeric amount validation has not yet been implemented. So the <code>lineErrors</code> property of the <code>output</code> object will be an empty array rather than the expected error:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2f1badec3504d40fc0b3fa0932cdaef8/2b2c6/tdd-bug-fail-6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.04142692750288%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABGUlEQVQoz4VSW3KDMAzkHMEG/H4AaTP9bKf3v9VWwjAQ4oaPtexFrCVrG6E1ZHTonMWgLGSvXiC6ocrX0Chtcc8ZKeWFaGW/gEW2/ZXI8cKGlzx94PvnF/fHF3yeENII4yM8RRcSWhYniBM2bhNlNLwYpTHGiNkHfFqPiRCNw7xGSz/EQcNTPII5da6QD521EMGhJ8LxxxM64v+DrAn2yiCQqDc8GL23xclHVNp+bZkPNGmRPNrHCOEdBLWyTJ+T5YqtisrEnytkQhWB2z3hNtMQplhi9BBkp5YvWS8QFzbaK7SmCBtT9hwXsV1we4Z33ixvqE1JYs/JoY6DwPsK6SOb25Pf2HM+ZhgXlr0LcYmWPKnIPpx3JfgHOGQvIokA5IAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd bug fail 6\"\n        title=\"tdd bug fail 6\"\n        src=\"/static/2f1badec3504d40fc0b3fa0932cdaef8/5a190/tdd-bug-fail-6.png\"\n        srcset=\"/static/2f1badec3504d40fc0b3fa0932cdaef8/772e8/tdd-bug-fail-6.png 200w,\n/static/2f1badec3504d40fc0b3fa0932cdaef8/e17e5/tdd-bug-fail-6.png 400w,\n/static/2f1badec3504d40fc0b3fa0932cdaef8/5a190/tdd-bug-fail-6.png 800w,\n/static/2f1badec3504d40fc0b3fa0932cdaef8/2b2c6/tdd-bug-fail-6.png 869w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>For implementation, there's plenty of JavaScript <a href=\"https://www.wikitechy.com/tutorials/javascript/validate-decimal-numbers\">solutions</a> to verify if a given input is a decimal number. Since the Tidysum app is already using <a href=\"https://github.com/MikeMcl/decimal.js/\">decimal.js</a>, I decided to make use of that library's parsing, which throws an error if the input cannot be parsed to a numeric. Note that all values come in as strings from csv parsing, so the solution needs to consider <code>'123.45'</code> to be valid, but <code>'123abc'</code> is not.</p>\n<p>Here is the updated validator module with numeric amount validation added:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> moment </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;moment&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> Decimal </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimal.js&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate number of fields</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected 4 fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate date format</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk5\">moment</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">], </span><span class=\"mtk6\">&#39;YYYY-MM-DD&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk5\">isValid</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Date format must be YYYY-MM-DD.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEWLY ADDED: Validate numeric amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">catch</span><span class=\"mtk1\"> (_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Amount must be numeric.&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validateLine,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And now the tests pass.</p>\n<p>One last test that should be added is to pass in a valid line, and ensure that no errors are reported. This is to make sure there's no false negative in the validation code - i.e. flagging a valid line as invalid:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/validator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> validator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/validator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;validateLine&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> output;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">beforeEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets errors when number of fields is greater than 4 and date field is invalid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when number of fields is less than 4&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;sets error when amount is not numeric&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// existing test...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NEW TEST HERE: Valid scenario</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;does not report any errors when input line is valid&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> line </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;2021-04-05&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;78.34&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Groceries&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;Metro&#39;</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      validator.</span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(line, output);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedOutput </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lineErrors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(output).to.deep.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(expectedOutput);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>And this test passes as well.</p>\n<p>Good, all validation is now implemented. But not quite ready to call it a day.</p>\n<h2>Refactoring: Extract Validation Methods</h2>\n<p>It's time to do just a little more refactoring. Looking at the validator module, there's a few things bothering me:</p>\n<ol>\n<li>The <code>validateLine</code> function has gotten too long, it has the details of 3 different validations, and each one has a comment describing what it does. It would be cleaner to extract each of these to a separate method, and name the method to match the comment, then the comments can be removed.</li>\n<li>There are several hard-coded values: <code>4</code> for number of fields, and <code>YYYY-MM-DD</code> for date format. It would be cleaner to extract these as constants.</li>\n</ol>\n<p>Again we can rely on the tests here. It's safe to re-arrange the code to make any internal improvements, and as long as the tests are still passing, can be confident that the code is still working as expected.</p>\n<p>Here is the refactored validation module with individual methods to implement each validation rule, and hard-coded values extracted as constants:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/validator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> NUM_FIELDS </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> DATE_FORMAT </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;YYYY-MM-DD&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateLine</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Build an entry to record everything that might be wrong with this line.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> lineErrorEntry </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    line: line.</span><span class=\"mtk5\">join</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;,&#39;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    errors: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Call out to individual validation methods for each rule</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">validateNumFields</span><span class=\"mtk1\">(line, lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">validateDateFormat</span><span class=\"mtk1\">(line, lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">validateNumeric</span><span class=\"mtk1\">(line, lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// If found at least one thing wrong with this line, add it to the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (lineErrorEntry.errors.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    output.lineErrors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(lineErrorEntry);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateNumFields</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">lineErrorEntry</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> NUM_FIELDS) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Expected </span><span class=\"mtk7\">${</span><span class=\"mtk1\">NUM_FIELDS</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> fields, got </span><span class=\"mtk7\">${</span><span class=\"mtk1\">line.length</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateDateFormat</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">lineErrorEntry</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!</span><span class=\"mtk5\">moment</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">], DATE_FORMAT, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk5\">isValid</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`Date format must be </span><span class=\"mtk7\">${</span><span class=\"mtk1\">DATE_FORMAT</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">validateNumeric</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">line</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">lineErrorEntry</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (line.length </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(line[</span><span class=\"mtk4\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">catch</span><span class=\"mtk1\"> (_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lineErrorEntry.errors.</span><span class=\"mtk5\">push</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Amount must be numeric.&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  processFile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validateLine,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And all the tests are still passing, hurray!</p>\n<h2>Summary</h2>\n<p>This post has walked you through a practical example of using TDD to fix a bug, and apply refactoring to improve the design of the code, while relying on the tests to confirm the code still works as expected. In general the process is as follows:</p>\n<ol>\n<li>Analyze the code to find where/how/why the bug is occurring.</li>\n<li>Define expectations about how the code should behave.</li>\n<li>Write a test that fails because of the bug.</li>\n<li>Write some code to make the test pass.</li>\n<li>Refactor and re-run tests as needed.</li>\n</ol>\n<p>I hope this has inspired you to try out TDD next time you're faced with a bug. Good luck and happy coding!</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>You've seen a few simple examples of refactoring in this blog post. Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is the go-to book to learn all about this topic.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/tdd-by-example-bugfix/"}}},{"node":{"id":"d0256ff7-f0e3-528d-b34f-2fdc4999476d","frontmatter":{"title":"Saving on monthly expenses - A Cautionary Tale","date":"April 2021","category":"personal finance"},"excerpt":"Today I want to share a cautionary tale about trying to save money on my mobility bill, and how its important to balance time, effort, and…","html":"<p>Today I want to share a cautionary tale about trying to save money on my mobility bill, and how its important to balance time, effort, and aggravation vs dollars saved.</p>\n<p>An often repeated piece of personal finance advice is to minimize recurring expenses wherever possible, such as utility bills, cell phone, other subscriptions etc. Small increases in these may not seem like much when paying on a monthly basis, but when calculated on a yearly basis it can really add up. One way to keep on top of this is to set aside some time once a year to call all your service providers and negotiate a better rate (or get rid of the service altogether if its not providing any value).</p>\n<p>Stories like <a href=\"https://www.mrmoneymustache.com/2019/08/22/1000-per-hour/\">this one</a> of saving ~$1000 on a yearly basis from just an hour on the phone are very compelling. So when a few months ago I received a notice of my cell phone bill going up by $3/month, I was very motivated to call my provider to avoid this increase, and perhaps get an even better price. $3/month works out to $36/year so that's certainly worth a quick phone call (ignoring taxes for this story, just to keep all the numbers simple). Here's how it went:</p>\n<p>One quick note first - all the customer service reps I spoke to on this journey were very nice and doing their best to be helpful. If this comes off as sounding critical, it's my frustration at the provider/system as a whole, not any individual working there.</p>\n<h2>Call One</h2>\n<p>The first customer service rep (CSR) I spoke to had some great news. Not only could she save me the $3/month increase, there was a new plan available that would save me $35/month compared to my current rate. I carefully confirmed with her that <em>all</em> the features of my existing plan would still be available on the new plan and she assured me that was the case. So I went ahead with the switch.</p>\n<p>Duration: Half hour on the phone.</p>\n<p>At this point I was feeling very pleased with myself having saved $35 * 12 = $420/year with just a half hour of work. But little did I know what was to come. About 10 minutes later I received an email confirmation from the service provider about the plan change. Looking over the features, there was no data listed. This was a big problem as I definitely had a data plan before.</p>\n<h2>Call Two</h2>\n<p>So I called back the provider. This CSR told me that the previous CSR had made a mistake. The new plan I was on had no data. The cheapest data plan they had available was $5/month <em>more</em> than what I was paying originally. At this point it was better to go back to my original + $3/month increase (the original notification that had started this whole process).</p>\n<p>Now this is where things started to get hairy. This CSR told me it was impossible to go back to my old plan because it no longer existed. How is that possible? It was just there 15 minutes ago before making the switch. She told me it was a legacy plan that was no longer available. My options were to stay with the new cheaper plan but have no data, or go up to the more expensive plan.</p>\n<p>None of the personal finance articles I had read about saving money on monthly expenses mentioned this risk of... let's call it an administrative snafu. I asked the CSR if there was anything else she could do as it wasn't right for the previous CSR to have removed me from my old plan if the new plan didn't have all the features she had confirmed. After much time on hold I got transferred to another CSR who said she would try and help me. Eventually she found an option where I could pay $5/month less than my original plan, and it would include 1GB of data. This was a lot less data than what I had originally, but could work, certainly during Covid when I don't go out much in any case. So I told her to go ahead with the switch.</p>\n<p>Duration: One hour on the phone.</p>\n<p>After all this effort, I had managed to save only $5/month * 12 = $60/year, with one and a half hours of work total. Together with loss of data, this didn't feel like such an achievement. But oh well, I tried to follow the personal finance savings advice. Unfortunately things got worse.</p>\n<h2>Call Three</h2>\n<p>When next month's bill arrived, I was very surprised that it was $12 <em>higher</em> than my old bill! How could this be possible when I had switched to a <em>cheaper</em> plan? Once again on the phone with a CSR. This one explained to me that the reason for the higher bill was due to pro-rating because I had switched in the middle of the billing period. But this explanation didn't pass the sniff test. When switching from a more expensive to cheaper plan mid cycle (my switch was about half way through), the next bill should have 50% of the charge from the expensive plan, and 50% from the cheaper plan, which would end up with a bill somewhere in between the expensive and cheaper plan. <a href=\"https://www.billsby.com/2019/12/26/explained-what-is-pro-rating-and-how-can-you-use-it-in-your-subscription-business\">This post</a> has a simple explanation of pro-rating. It's impossible for the next bill to end up greater than the more expensive plan. It must, by definition of pro-rating come out somewhere in between. But apparently subscription arithmetic is not part of the training curriculum at this service provider as the CSR kept insisting the reason for the $12 increase was due to pro-rating.</p>\n<p>In the meantime I kept digging into the bill trying to make sense of it, and finally found the culprit. My provider had added a $12 service charge for changing plans mid cycle. When I mentioned this to the CSR he dropped the pro-rating argument and confirmed there is a charge for switching mid cycle. I pointed out that the previous CSR had not informed me of this, had I known, would have waited till end of billing cycle to change plans. This CSR agreed I should have been told and issued me a credit (to appear on next bill) for the service charge.</p>\n<p>Duration: Another hour on the phone.</p>\n<p>For those keeping track, that's two and a half hours of work for a savings of $60/year, less data, <em>and</em> a whole lot of aggravation. This definitely wasn't mentioned in any of the personal finance articles about saving on monthly expenses. They make it seem so simple, just a quick phone call to your service providers and poof, money saved. The story continues...</p>\n<p>About a week later, I received another notification about my eligibility for yet another plan that was $15/month less than my original and had nearly as much data as I used to have. Had to give this some serious thought - should I call and switch plans yet again? The potential savings were $15/month * 12 = $180/year. But what if things went sideways again? Decided to take a chance as I had already spent so much time, might as well try to save a little more. Kind of a <a href=\"https://en.wikipedia.org/wiki/Sunk_cost\">sunk cost fallacy</a> but with regards to time.</p>\n<h2>Call Four</h2>\n<p>On the phone again, another CSR. Again confirmed every single feature was available on the new plan. Again it was mid-cycle, and CSR made no effort to warn me about the mid cycle service charge, but I had learned my lesson and insisted on the plan change taking effect at the beginning of the next cycle. Who knows whether it's a lack of training that the CSRs don't mention the mid cycle service charge or a strategy on the part of the provider, figuring most customers won't bother to challenge it.</p>\n<p>This time, things worked out fine. My next bill for the new plan arrived at $15 less than what I was paying before, and no surprise charges.</p>\n<p>Duration: Half hour on the phone.</p>\n<h2>Final Thoughts</h2>\n<p>The final tally is 3 hours of work to save $180/year and staying at roughly equivalent service, which works out to $60/hour for my efforts. Was it worth it? Well I'm happy to be saving money but not sure it was worth all the aggravation - potential loss of service, all that time on hold, debating with CSRs. This is something to think about when embarking on a money saving task -  how much money could be saved vs the value and opportunity cost of your time to do it. It may not always be worth it.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>This book <a href=\"https://amzn.to/2Q4UboX\">Your Money or Your Life</a>, completely changed how I view money. Never mind all the economists definitions like money is a \"unit of account\" or a \"store of value\". This book will teach you the only definition of money that matters in your life.</p>\n<p>Even if you love your job and could never imagine quitting, <a href=\"https://amzn.to/3hu0xcQ\">Quit Like A Millionaire</a> will teach you how to amass enough wealth to live life on your own terms. Equal parts entertaining and educational, this is one of the most enjoyable personal finance books I have read.</p>\n<p>Another book I really enjoyed is <a href=\"https://amzn.to/2Q7BIrT\">The Psychology of Money: Timeless lessons on wealth, greed, and happiness</a>. In it you'll learn that being successful with money depends way more on how you behave than being a so-called financial expert.</p>\n<p>Looking for information on Canadian taxes? You might like this book: <a href=\"https://amzn.to/3aaj4qh\">The Grumpy Accountant: One Fed-Up Tax Pro's Practical Plan to Fix Canada's Senselessly Complicated Tax System</a>.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","fields":{"slug":"/blog/save-monthly-expense-caution/"}}},{"node":{"id":"4a646086-9475-575c-8bbc-aa6196417962","frontmatter":{"title":"Rails Blocked Host Solved by Docker Cleanup","date":"April 2021","category":"rails"},"excerpt":"Today I want to share a debugging story about trying to make different versioned Rails containers talk to each other via docker compose…","html":"<p>Today I want to share a debugging story about trying to make different versioned Rails containers talk to each other via docker compose networking, and a blocked host error that ended up being resolved by a Docker cleanup.</p>\n<h2>Setup</h2>\n<p>I'm running a Rails 5 monolith, dockerized, using docker-compose. This monolith needs to make use of a new subscription service that is developed as a separate project with Rails 6. The subscription service also runs dockerized with docker-compose. Why run them with Docker locally? <a href=\"/blog/dockerize-rails-app-for-dev-debug-and-testing\">I've written about the benefits of this approach and how to do it here</a>.</p>\n<p>Communication between the services is via an HTTP api. Specifically, the monolith needs to make GET/POST/PATCH requests to the subscription service to access services such as creating a new subscription, getting a list of active subscriptions for a user, cancelling a subscription, etc.</p>\n<p>The monolith runs the Rails server on port 3000 and the subscription service runs on port 4000. If the services were running natively on the laptop, the monolith could address the service via <code>localhost</code>, for example, <code>GET http://localhost:4000/api/subscriptions</code>. But this won't work when the monolith is running in a Docker container because it will look for a service running on port 4000 <em>within the container</em>, which does not exist.</p>\n<p>One solution is to build an image of the subscription service, push it to a Docker registry (self hosted, Docker Hub, Github container registry etc.) then add another service in the <code>docker-compose.yml</code> of the monolith that uses this image. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># docker-compose.yml in the monolith project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">web</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">mysubapp</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">https://path/to/registry/your-organization/project-name:image-tag</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;4000:4000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">...</span></span></span></code></pre>\n<p>Then the monolith could make requests to the subscription service using the service label given in the <code>docker-compose.yml</code> file, for example: <code>GET http://mysubapp:4000/api/subscriptions</code>.</p>\n<p>However, in my case, both applications (the monolith and subscription service) are in active development, so I needed the flexibility to make changes to both and have the changes be reflected immediately. Having to build an image each time and push to a registry (or even host it locally) would have created too much friction.</p>\n<h2>Docker Compose Networking</h2>\n<p>Another solution is to use docker compose networking. Recall I mentioned that both projects have their own docker compose file and are run via <code>docker-compose up</code>. The subscription service <code>docker-compose.yml</code> file has:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">api</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">buiild</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">4000:4000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># remainder of services...</span></span></span></code></pre>\n<p>Running <code>docker-compose up</code> creates a default network named <code>your-project_default</code>. To view all the docker networks run, <code>docker network ls</code>. For example, when I'm running both the monolith (<code>app</code>) and the subscription service (<code>subapp</code>), my networks are:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ docker network ls</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">NETWORK ID     NAME                DRIVER    SCOPE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4c70ec63569c   bridge              bridge    local</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">506eb008c078   host                host      local</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">9e95129ab709   app_default         bridge    local</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0029021041d2   none                null      local</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">6bf8ff8bc594   subapp_default      bridge    local</span></span></code></pre>\n<p>Since I want the <code>web</code> service in the monolith to address the <code>api</code> service in the subscription project, this can be accomplished by having the app <a href=\"https://docs.docker.com/compose/networking/#use-a-pre-existing-network\">join</a> the subscription services' network using the <code>external</code> option:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yaml\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># docker-compose.yml in monolith</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># all the services...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Join the subcription service network</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">networks</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">default</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">external</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">subapp_default</span></span></span></code></pre>\n<p>And now the monolith app can make an http request such as <code>GET http://subapp_api_1:4000/api/subscriptions</code>. Where <code>subapp</code> is the project name of the subscription service and <code>api</code> is the service name defined in its <code>docker-compose.yml</code> file. To confirm that these services can communicate with each other, run <code>docker network inspect subapp_default</code> and it will list all the services that are participating in this network.</p>\n<h2>Blocked Host Error</h2>\n<p>At least in theory this should work. In practice, when the monolith made an http request to <code>GET http://subapp_api_1:4000/api/subscriptions</code>, received a Rails html error page with the following error message:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;Blocked host: subapp_api_1&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;To allow requests to subapp_api_1, add the following to your environment configuration:&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;config.hosts </span><span class=\"mtk8\">&lt;&lt;</span><span class=\"mtk1\"> &quot;subapp_api_1&quot;&lt;/</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p>This error comes from new <a href=\"https://api.rubyonrails.org/classes/ActionDispatch/HostAuthorization.html\">ActionDispatch::HostAuthorization</a> middleware that guards against DNS rebinding attacks by explicitly permitting the hosts a request can be sent to. What was puzzling about receiving this error is that this middleware is newly added to Rails 6, but it was being sent by the Rails 5 container running the monolith code.</p>\n<h2>Debugging Attempts</h2>\n<p>On the off chance this middleware had gotten back ported to Rails 5, I tried adding the line <code>config.hosts &#x3C;&#x3C; \"subapp_api_1\"</code> entry to <code>config/environments/development.rb</code> exactly as recommended by the error message. But then the Rails 5 server failed on startup running this initialization with an error that the <code>config</code> object has no such method <code>hosts</code>. This makes sense as this feature is only present as of Rails 6, but then <em>why</em> was I receiving this message from Rails 5???</p>\n<p>It was also possible that I misunderstood the message and that the host configuration should be added on the Rails 6 container (the one running the subscription service) to make sure it could communicate back to the Rails 5. Even though the subscription service didn't need to make any http requests to the monolith, sometimes when you're debugging, just need to try a bunch of things, if nothing else, to rule them out. So added <code>config.hosts &#x3C;&#x3C; \"app_web_1\"</code> to <code>config/environments/development.rb</code> on the Rails 6 project, restarted it, but this had no effect, was still getting the same error.</p>\n<p>Also ran <code>bundle exec rake middleware</code> which lists all the middleware in sequence, to investigate whether the monolith project had a library or custom middleware that was implementing host blocking, but couldn't find any.</p>\n<p>Another possibility could have been that the networking wasn't working and the containers couldn't really \"see\" each other. To verify this, I ran ran a shell in the container running the Rails monolith: <code>docker exec -it app_web_1 bash</code>. Then checked if it could \"see\" the subscription service with <code>ping subapp_api_1</code>, and indeed it could communicate.</p>\n<p>Ok well if they can communicate at a network level, what about running <code>curl</code> in the shell (still in the Rails 5 container)? Tried <code>curl http://subapp_api_1:4000/api/subscription</code> (along with necessary auth headers), and <em>amazingly</em>, this also returned the Rails 6 html error page <code>&#x3C;h1>Blocked host: subapp_api_1&#x3C;/h1></code>!</p>\n<p>At the same time, I was monitoring the log files for the container running the subscription service and there was no activity there, confirming that the http requests were never getting past the Rails 5 container.</p>\n<h2>Solution: Docker Cleanup</h2>\n<p>After nearly a day of investigation, my manager suggested wiping out all the Docker things to get a fresh start. Was it possible that somehow the Rails 5 and 6 image layers had gotten mixed up? Seems strange but at this point had exhausted all the other possibilities so why not try this.</p>\n<p>When using Docker and docker-compose, there will be a variety of docker images, containers, networks and volumes. Although it is possible to list each type and remove them one at a time, it's faster to wipe them all out in one go. To start, make sure there are no running containers by running <code>docker ps</code>. If any are listed, stop them with <code>docker stop {container ID or name}</code> OR go to the project directory where docker-compose was started and stop it. Then run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ docker system prune -a</span></span></code></pre>\n<p>This will remove all images, containers, and networks. It will not remove volumes however. This is a kind of safety as there might be valuable data that should be backed up. In my case, all volumes contain only development data which can be easily recreated by running <code>bundle exec rake db:seed</code>. To have system prune also remove volumes run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ docker system prune -a --volumes</span></span></code></pre>\n<p>After this I re-ran <code>docker-compose up</code> in both projects which built/downloaded all images from scratch, ran the scripts to re-seed data in both projects, then tried the code to <code>GET http://subapp_api_1:4000/api/subscriptions</code> from the monolith and it worked!</p>\n<p>I'm curious if you've had mysterious issues resolved by a Docker cleanup? Tweet me your stories if you have.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-blocked-host-docker-clean/"}}}]}},"pageContext":{}}}