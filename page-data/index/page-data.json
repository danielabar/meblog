{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":21,"edges":[{"node":{"id":"c89b5350-b4ef-5094-8dc8-83a0567384a7","frontmatter":{"title":"Solving a Python Interview Question in Ruby","date":"March 2021","category":"ruby"},"excerpt":"A few months ago, I came across a tweet posing a technical interview question for a data science position using Python:  Let's set aside for…","html":"<p>A few months ago, I came across a tweet posing a technical interview question for a data science position using Python:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aa3189a9b02cbb2f3bc0aba0a844810a/0d1a4/tweet-interview-question.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.24710424710425%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABb0lEQVQoz41Sy3LCMAw0oYSQkHfIg0cChAxceoBLp/T/v2vrVUeBthcOmrVkWVqtbKqyxHq9RlEU2G636Lpu9Imr1QpN06CqKvGJ9Ev7rq5ryWdsMpnAGAOTpDnKqkaWZZLIokymz2LaiDEtvNlsxga73U7upBjNfzOIAxdhFGOx8LBcLqUQLYoiTKfTR/Ir1qUG70ODj88vnE49brcb7ve74PV6xeFwELZ5ngtbRbJyXVeKjOMqw2DuoKoby6qwLBfwPA++78uZLNM0Hc9hGArGcQzHcf4zjBOrVVnBtw+SJBEGTCbqQ8ZZVIszxjPjZEocWWY2obXCUjOKryJTeG6RMRqXoFslqk9JKMHIkOOxA5fBcWjKiiyUpY6r94pBEIjGvP8Z2QbbtpUu7EhmZMkYbb/fCwueGe/73i7vJF+GRvbDMDy+DsVml2eczWZyJutfG3zFqAU7ksnlcsH5fMbxeBQkGx2FhZ9NC/z1vwGIZAVWLK0vEAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tweet interview question\"\n        title=\"tweet interview question\"\n        src=\"/static/aa3189a9b02cbb2f3bc0aba0a844810a/5a190/tweet-interview-question.png\"\n        srcset=\"/static/aa3189a9b02cbb2f3bc0aba0a844810a/772e8/tweet-interview-question.png 200w,\n/static/aa3189a9b02cbb2f3bc0aba0a844810a/e17e5/tweet-interview-question.png 400w,\n/static/aa3189a9b02cbb2f3bc0aba0a844810a/5a190/tweet-interview-question.png 800w,\n/static/aa3189a9b02cbb2f3bc0aba0a844810a/0d1a4/tweet-interview-question.png 1036w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Let's set aside for a moment whether this style of interviewing is useful in identifying good software developers. Plenty has been written about the problems with technical interviews so I don't want to get too much into that. Suffice to say when I'm faced with this type of question in a technical interview, this is my reaction:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 586px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1b280c7d6cd37b0adf58b639b8aec267/a76f4/deer-caught-in-headlights.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 98.97610921501708%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAE60lEQVQ4yy2T+VNTVxiG+UNaFQi5Sy6BkBASQghrIKhVVBbZZK1KiSyiICBaBhGLqEBdkSrQAkLBal1qi8vo6OBMrY6jY1vbsePY6Y/9E55+N/SHb+69557znPe833uiFMWLovhR1AxUJR1Vk6fqlUpDiXMRZ7FhjUuU8aDM82C1GFKJ8s+LpgbRlCR0IyTzM7EqKUQpSoBIyQJVoFYlTSamy0QBWt3/A+PR9ALMza1xBrq5odUjAjLQZDObLRPdUY5VxiJA1ZomP/2iIkd+ZskiH7ooVVS/qLGjWHT0+PV8/FESXa2HKMgrJ3qNKNNy0awOdBNo3yaiAkSZUtUI1IemZTPUN0tuViVr1qaKqhwZd8kiO+ssbmrL2vj9+Xsy00OsW6sJKEdO4pZKxWZsRrPlrwJNDzXZLSY2l6HuCzyZf8mmUBiLslFUBomJVsn2BlmeX+HVg79wJXiIjdFkjSkmGSNhPUZipZxiiwnMk8EskZ+HxZpPyF/Iw/Flbnz9mC15DSQ5NpHhCjDUcYxfX/7LmeE5LOt0Ue6MeKxaxUMjgN1dSbyrgShN3SBNWO2Spmdjk+ppHOTF47+5PHiG7uJ6DhbXsrJwl0tfLWAY4qvYoCsugaWI3wlyVJ/ANqPqaWZTxCezxENdDYjSUKRawseYnLnOQEOYE529TM/cJNeXQ3R0ingnDbMmRDodASpOURmSMaccWTEjIh5aU2WCF0MXL6UhVXUdtE9/y5G2gwwPn6dt4gqlm0qJtXgldybQHlGkSJfjYvTIeHSsxwQWCMiEmpW5qlJNjWRs8uwiT5YecWfqFq8fvmG0exibli7AIJZYg9i4NCyWBBJVBz5HOpvTpMvWSNpNULY8s8RLP4Zkcc1aDx3hQabG5ult7uPdynvunJ6nPL9IuuvHLuoyHJmU+LL5LBiid1sRp2pqxUNV8mfCpMuqbgID8p0hPmYSHx9iqOcsNydv8m75OfdPTzPW3ENbUTW9xVWMNzYzWFFN28ZCuraWcqyqThTK/VPkiOZ108U/m7Ehkq34eDNGAdpr23kxe49Xs7e42j/K3OERzrZ0Mb47zGh9IwMV9XQUbqdzawlDdbvFQ11iYEZA7qdNz8SwF0s0CohPEJ/Ex8rCet4s3eOXqevcHZnixvFxestqudjYyrldrVxoaud4zU5GJA0Xmtokh7bgqkIjS3LowybKbIZ5p/1ifg4pzhxuj13ij+8e8XTiKhP7+2n/ZBtLB/pYlLp95DgL3YdZHjzJ/S9OCVAPRHJlT5SAi9E2W0BUBjG0ZBITc8XXDDl2N2+vrfDn9aeM7G6lr3QHNw4Ncjncyo9HT/Ds/DRvpuZ4PTlnxsYpoBSB5EjlY08oIMlZgju5Fl/qXtL9h8jKOEpf+Bw/f/MTE3sPMLC9mqXufq7s7+XB0BhvZ6/yz7XbfFj8nqhEx3Yczhocrk9xuhtJTmnCnRLG620R4H4C/h6BduHx7qO1vJeZrn7GGvZwaU8nl5u7+GHgJL/NLPFhYZ5nX44S5XJV4XJV43RWSG0nObkCj7taqlxUVpDq2YXfFxZoMwFvA50VzcyJdxNNLZyWpph1saWNJ6OnmGpuIsqZtBGXc6tAiwUmJe8eVwleefe6i/F5Kknz1RFI34k/rYZ0TylFOWV0FNew+PkQXUVldG8pES8H2Ve2g/8AhssUA9sGB0YAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"deer caught in headlights\"\n        title=\"deer caught in headlights\"\n        src=\"/static/1b280c7d6cd37b0adf58b639b8aec267/a76f4/deer-caught-in-headlights.png\"\n        srcset=\"/static/1b280c7d6cd37b0adf58b639b8aec267/772e8/deer-caught-in-headlights.png 200w,\n/static/1b280c7d6cd37b0adf58b639b8aec267/e17e5/deer-caught-in-headlights.png 400w,\n/static/1b280c7d6cd37b0adf58b639b8aec267/a76f4/deer-caught-in-headlights.png 586w\"\n        sizes=\"(max-width: 586px) 100vw, 586px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Why? Because being asked to solve something like this on the spot with someone timing you and waiting for a result is unnatural. In nearly 20 years of working as a software developer, its never been the case that as part of a conversation with a manager, product owner, colleagues etc. that anyone expected a piece of code to be written immediately on the spot during that conversation while they watched me code. Typically, the actual coding work is done when developer goes back to their desk (or comfort of their home office), does a little research if needed on various language APIs, tries out a few things in a REPL, then gradually comes up with a solution, and hopefully some tests. Even better if there's also some documentation produced and later, a demo to the team on how the new feature works.</p>\n<p>But regardless of my thoughts on technical interviews, found myself curious about solving this, although not in Python. It's been quite a few years since I worked in that language and have since pivoted to Ruby/Rails. So thought it would be interesting to break down this problem in Ruby and solve it TDD style with RSpec.</p>\n<h2>Caveats</h2>\n<p>Ruby is <a href=\"https://www.quora.com/Is-Ruby-a-good-language-for-data-science?share=1\">not the go-to language for data science</a>, and my experience is primarily with web development, not data science, so this is just an exercise to get some practice with Ruby.</p>\n<h2>Analysis</h2>\n<p>At first glance the problem seems relatively straightforward, given an input string such as <code>'aaaabbbcca'</code>, return a data structure containing a key for each letter, and the value being the count of how many times the letter appears in the string. But looking more closely, that's not what's being asked. Notice the last letter <code>a</code> in the input string appears separate from the first 4 <code>a</code>s in the beginning of the string. Then the expected output has two entries for the letter <code>a</code>. The first entry has a count of 4, and the last entry has a count of 1. So the question is actually asking to identify counts of repeating sequences of letters. This problem is known as <a href=\"https://en.wikipedia.org/wiki/Run-length_encoding\">Run-length encoding</a>.</p>\n<p>What this means is that as each letter in the string is being processed, we need to \"remember\" what the previous letter we just processed was. This is because the decision whether to increment a given letter counter or start a new counter will depend on whether the previous letter was the same as the current one (in which case, increment counter) or different than the current one (in which case, start a new counter).</p>\n<p>A general technique for this is before entering the loop, grab the first letter of the input string and store it in a variable. Then loop over the remaining letters in the string. At each iteration in the loop, compare current letter to previous, process it accordingly, then update the \"previous letter\" to the current letter in the loop. This way when the next loop iteration runs, it will have access to the letter that was processed in the previous iteration.</p>\n<p>To solve these types of problems, I find it useful to write down the solution in plain English. This allows for a focus on logic, without worrying about language-specific syntax or even data structures. Something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Start by assigning &quot;previous letter&quot; to the first letter in the input</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Record the first entry as this letter, with a count of 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Add this entry to list of results which will eventually be returned</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">For each letter in input string starting from second letter</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  If the current letter is the same as the previous letter</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Increment the counter for this letter in the entry created earlier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Else</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Create a new entry for this letter with a count of 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Add this entry to results</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  End If</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Update the &quot;previous letter&quot; to the current letter for next loop iteration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">End Loop</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Return results</span></span></code></pre>\n<h2>Tuples</h2>\n<p>Now that the logic is sorted out, it's time to write some Ruby code. But before we do, let's take a closer look at the expected output, keeping in mind the original question is in Python:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"python\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Example input:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">&quot;aaaabbbcca&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Expected output:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[(</span><span class=\"mtk6\">&quot;a&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">4</span><span class=\"mtk1\">), (</span><span class=\"mtk6\">&quot;b&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">3</span><span class=\"mtk1\">), (</span><span class=\"mtk6\">&quot;c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">2</span><span class=\"mtk1\">), (</span><span class=\"mtk6\">&quot;a&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)]</span></span></span></code></pre>\n<p>This is an array of tuples, which don't exist natively in Ruby but can be approximated with a <code>Struct</code> as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Tuple </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Struct</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:_1</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:_2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_count </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;a&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">4</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_count._1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;a&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">a_count._2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">4</span></span></span></code></pre>\n<p>See this <a href=\"https://stackoverflow.com/questions/525957/using-tuples-in-ruby\">SO answer</a> for more details.</p>\n<h2>Setup for TDD</h2>\n<p>Next step is to get a TDD workflow going with RSpec. If you want to know more about TDD, I've <a href=\"/blog/tdd-by-example/\">written about it here</a>. Up until this point, my experience with RSpec has been using it with Rails, but turns out, it can also be used for a plain \"vanilla\" Ruby project as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">mkdir RLE  </span><span class=\"mtk3\"># this will be project name, name this whatever you want</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> RLE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">touch Gemfile</span></span></span></code></pre>\n<p>Edit the <code>Gemfile</code> so it looks as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Gemfile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rubocopsource </span><span class=\"mtk6\">&#39;https://rubygems.org/&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem </span><span class=\"mtk6\">&#39;rspec&#39;</span></span></span></code></pre>\n<p>Then back in the terminal:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem install bundler  </span><span class=\"mtk3\"># only if you don&#39;t already have it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rspec --init</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">touch data_science.rb  </span><span class=\"mtk3\"># this will be the module where we will write the code, name it whatever you want</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">touch spec/data_science_spec.rb  </span><span class=\"mtk3\"># the corresponding test file</span></span></span></code></pre>\n<p>At this point, the project directory should look as follows: (the <code>spec_helper.rb</code> file was generated by the <code>rspec --init</code> command run in previous step):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── Gemfile</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── Gemfile.lock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├── data_science.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── spec</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── data_science_spec.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── spec_helper.rb</span></span></code></pre>\n<p>Now open the project in your editor of choice and open the test file <code>data_science_spec.rb</code>.</p>\n<p>I'm planning to write the method that implements the interview question logic in a method named <code>rle</code>, which will be defined in a module named <code>DataScience</code>. This module and method will live in the <code>data_science.rb</code> file. They haven't been written yet so of course any tests written for this module/method will fail but that's ok, this is the start of the TDD process. I'm also expecting the <code>Tuple</code> struct to be defined in the <code>DataScience</code> module.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/data_science_spec.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;./data_science&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe DataScience </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&#39;Run Length Encoding&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Counts consecutive occurrences of letters in a string&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">DataScience</span><span class=\"mtk1\">.rle(</span><span class=\"mtk6\">&#39;aaaabbbcca&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      a4 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;a&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">4</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      b3 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;b&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      c2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;c&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      a1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;a&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(result).to eq([a4, b3, c2, a1])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>To run the tests, open a terminal and enter:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rspec</span></span></span></code></pre>\n<p>The test should fail because the module hasn't been defined:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 582px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9b9f2a4c1cde8a123dfa7293a3b69639/7c1cd/interview-q-tdd-module-undefined.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.97594501718214%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACQUlEQVQ4y3WUua7UQBRE5xsggBnvS7vdXsfL2MzCIiECQiRC+AQkIhIC9EQCX13U7WcP89AjOKq+3Xa5brvtjTd/hPv+O7x3X7F9+w3Fhy/48dPD3d0T/Pr9FJ8+OyiqA+q2pdaomj1MUWHreHC8wOL6IbwgsrpJTQu9n5E1I7J2QjkcMZ1a9IcC41QSGpUNumFE2w007qyasrYPyPLiaia6qVOFS25wznNcjEHHsdEVtCqgVIk0rxArjZypNG/OFqQW0iy3Rt5qKIOOgzmMrQ6kDUL0VMM15QdIqAFbe+b62FK3boAdx5al5ZWNwxsDUtNwjhIMZCKv4xRH6ilOrL5kLWsNr2ujGAVVk5JUJA8j+Dbh0n8oibgQUzUplovUUstNYqaXAN6Cv7DW1tChYUYVOklAeqZIxYymO66vODftPcbVcE0l7Y7RfftiJsnWN3jLY3M2obs8NV0SSrKeJsOS0NwYuqvZOpZUN/PWcN0DmdyR7Q1r7Txi9l9DwyNyJCNff+b5SHgURDPWimjZXxLx+Lic9wRXNLiaejftb4LMIG8HFMMLGGq5H6HrAarcQxUNcqrWJULisHZZO1UP1zQPjK6fnqka1OOE/vwKuu3RzkcEeYnnUYptpEiKHfdxFyZwWDsxSTI4rF1J+c/3vPF4cchD61NlL+NEPSBKUkRcj9PMXidzIU9AIrXAOlHZ34SFKXA+TJi7HhW/zTenC45MPOx7y4E/g65uuT6gF+1HdOxqHg52ra8b+7MI+BAx/AMmKa5S1N1leQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"interview question tdd module undefined\"\n        title=\"interview question tdd module undefined\"\n        src=\"/static/9b9f2a4c1cde8a123dfa7293a3b69639/7c1cd/interview-q-tdd-module-undefined.png\"\n        srcset=\"/static/9b9f2a4c1cde8a123dfa7293a3b69639/772e8/interview-q-tdd-module-undefined.png 200w,\n/static/9b9f2a4c1cde8a123dfa7293a3b69639/e17e5/interview-q-tdd-module-undefined.png 400w,\n/static/9b9f2a4c1cde8a123dfa7293a3b69639/7c1cd/interview-q-tdd-module-undefined.png 582w\"\n        sizes=\"(max-width: 582px) 100vw, 582px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Let's fix that by defining the module, method and Tuple struct in <code>data_science.rb</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># data_science.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Unlike Python, Ruby doesn&#39;t have native tuples.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Tuple </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Struct</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:_1</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:_2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">DataScience</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># RLE (run-length encoding): Encode each character by the number of times it appears consecutively.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.rle</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">input</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># TBD...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Run the test again with <code>bundle exec rspec</code>. This time it fails comparing an array of tuples (expected value from test) to <code>nil</code> which is what is currently being returned because the <code>rle</code> method has not yet been implemented:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/37024f1557112d0e40d33761156b59a2/ae953/interview-q-tdd-method-nil.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.89399293286219%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABE0lEQVQoz22RW2rDMBBFvYlCiS1Zo7fsOA2EQqC/hWygf9n/Om7vxE4oTT4OF1nS8cyok9MF76cffH6fcb2+4fwVIHFCqg1mFPRmxGDdE7r3iq7mhLlGjNZj1zc4KYgxwYeEmAoC8SnDxwzhN2HqxVc/UTrrAg654ZgLjiXjg7lQMlOyZ04URJWHiMTMKnYeI6WOyJb3ddfT6kePSrEwDRnsWr594GEl3C44nv8rkI2HUFsrbY86HZCIawuEa2E6pqt7mNTQ5wmDxLU1bfk/95bnOmGZZrRSOa91TjrDuGUIOl8eHgwMH8jY8TmV+6MUzmShtFEQeDHpRsjY5Rn9VllfZgxa4Y2GQdfcuxELqZSulf8CLsTElSXlNoIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"interview question tdd method nil\"\n        title=\"interview question tdd method nil\"\n        src=\"/static/37024f1557112d0e40d33761156b59a2/5a190/interview-q-tdd-method-nil.png\"\n        srcset=\"/static/37024f1557112d0e40d33761156b59a2/772e8/interview-q-tdd-method-nil.png 200w,\n/static/37024f1557112d0e40d33761156b59a2/e17e5/interview-q-tdd-method-nil.png 400w,\n/static/37024f1557112d0e40d33761156b59a2/5a190/interview-q-tdd-method-nil.png 800w,\n/static/37024f1557112d0e40d33761156b59a2/ae953/interview-q-tdd-method-nil.png 1132w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Implementation</h2>\n<p>Now that there's a failing test and a scaffold of the module, we can finally implement the <code>rle</code> method to make the test pass. I filled in lines of code to go along with the English logic written earlier. To keep track of letter counters, a hash is used to conveniently lookup letters that have already been seen and increment their counters. Leaving in the English as explanatory comments (if strictly following clean code principles, further methods with more meaningful names can be extracted and comments removed, but for this exercise, simpler to read all the code linearly from top to bottom):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># data_science.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Unlike Python, Ruby doesn&#39;t have native tuples.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Tuple </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Struct</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk4\">:_1</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:_2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">DataScience</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># RLE (run-length encoding): Encode each character by the number of times it appears consecutively.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.rle</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">input</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Keep track of letters that have been seen for incrementing consecutive counter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    track </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Array of results to be returned.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Initialize based on first character in input string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    previous_letter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> input[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    track[previous_letter] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(previous_letter, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    result </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> track[previous_letter]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Process input string one character at a time, starting from second character</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">..input.length </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      current_letter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> input[i]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># If the current letter was just seen in the previous iteration, increment its tracking counter,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># but do not append anything to results because its already been appended.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      track[previous_letter]._2 </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\"> </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> current_letter </span><span class=\"mtk7\">==</span><span class=\"mtk1\"> previous_letter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Otherwise start tracking a new letter and add it to results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> current_letter </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> previous_letter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        track[current_letter] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(current_letter, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        result </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> track[current_letter]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># The letter that has just been processed (current) now becomes the previous for next iteration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      previous_letter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> current_letter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    result</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>This time the test should pass:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 561px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b64fe327688c353d0b178a10aa3cef3/410f3/interview-q-tdd-method-pass.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.499108734402853%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA2klEQVQY01WOzU6EMBzEeQcTo7T0AyjQLltKgSW6D7AeTLz7HG6yJz25B33osW0MxsNkJv+PyS/jx1ew5w+wpzPo6YL65YL3a4fr5w2+vm/xdr6D8x5+PmA/jOitC3mBKGsUXP4TZQIZLTvkQiPnLYg0IKVBZzialqDpKFrN0jOX1SZZKZCC454UyXPKk8fSrNUa08MKO3vovsccslsfYYYJ1i3QO7eR7QeHcVqSbJhFatPbcOfTPhEypSDWEXwZwHcawluIkGXIVd0kukhU1urXm02V+ttHj4U/iPt44h4CfK0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd interview question method pass\"\n        title=\"tdd interview question method pass\"\n        src=\"/static/3b64fe327688c353d0b178a10aa3cef3/410f3/interview-q-tdd-method-pass.png\"\n        srcset=\"/static/3b64fe327688c353d0b178a10aa3cef3/772e8/interview-q-tdd-method-pass.png 200w,\n/static/3b64fe327688c353d0b178a10aa3cef3/e17e5/interview-q-tdd-method-pass.png 400w,\n/static/3b64fe327688c353d0b178a10aa3cef3/410f3/interview-q-tdd-method-pass.png 561w\"\n        sizes=\"(max-width: 561px) 100vw, 561px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Edge Cases</h2>\n<p>It appears we now have a working solution, but it's good to push it a little with some variety of inputs. In the example given from the original tweet, all the initial letters have some repeating sequences. But what happens if there are letters that repeat, but not sequentially? For example an input of \"abab\" should return <code>[(\"a\", 1), (\"b\", 1), (\"a\", 1), (\"b\", 1)]</code>. Let's add a test for this case:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;./data_science&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe DataScience </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&#39;Run Length Encoding&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Counts consecutive occurrences of letters in a string&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles alternating letters&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">DataScience</span><span class=\"mtk1\">.rle(</span><span class=\"mtk6\">&#39;abab&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      a1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;a&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      b1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;b&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(result).to eq([a1, b1, a1, b1])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>The tests are still passing so this case is handled, good!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 554px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1686e63f04ba4926e98f935e05c26161/04abd/interview-q-tdd-two-passing.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.75812274368231%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA20lEQVQY02WPvU7DMBwH8wKwIAFqEjvOh+ukqePEaVXE3AoYmFh5ASQkYGHg4Q/XQBeG0/30X3xOxO4J8fBFvn8LfCDvPrl4feb85cDZ+yP5/S3z4Bkmj3UTbgw7OBUFuVT/SDJtWZgtqfakyzlyPVqunOFy7EiNRqmaoqyRqjo5zSWLTET/bEkWHkm0MUyjwzlH24btJ3yoWHcWH8q6to9lXW+jj8zbHb11jH7Dam0DQywXRUkitKa48ciAsCuUs8iNQ06WShtU1VDW+uSybqh/71WzjP7bxy9/A9gzd5dWtKgfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"interview question tdd two passing\"\n        title=\"interview question tdd two passing\"\n        src=\"/static/1686e63f04ba4926e98f935e05c26161/04abd/interview-q-tdd-two-passing.png\"\n        srcset=\"/static/1686e63f04ba4926e98f935e05c26161/772e8/interview-q-tdd-two-passing.png 200w,\n/static/1686e63f04ba4926e98f935e05c26161/e17e5/interview-q-tdd-two-passing.png 400w,\n/static/1686e63f04ba4926e98f935e05c26161/04abd/interview-q-tdd-two-passing.png 554w\"\n        sizes=\"(max-width: 554px) 100vw, 554px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>What about if there's only a single character, repeating or not? A few more tests for this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;./data_science&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe DataScience </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&#39;Run Length Encoding&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Counts consecutive occurrences of letters in a string&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles alternating letters&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles a single character occurring once&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">DataScience</span><span class=\"mtk1\">.rle(</span><span class=\"mtk6\">&#39;z&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      z1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;z&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(result).to eq([z1])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles a single character occurring multiple times&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">DataScience</span><span class=\"mtk1\">.rle(</span><span class=\"mtk6\">&#39;zzzzz&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      z1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;z&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">5</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(result).to eq([z1])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>All tests still passing:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 538px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b002ae0abef36b243863d349d1960a84/9516f/interview-q-tdd-four-passing.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.561338289962826%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA70lEQVQY01WPy0rDQBSG8wauBJu0STpJZtImc8k0l3pBUBQXrn0Il7osgoKIvvXntIrg4uP7OYtz/hNl2wfS+xfS2yeyu2dmNzsed5d8vB/x+nbC59cxV9eSbnOG8x7jPK7bHDxPcxbZ8h9RoixxsyWWPUk9MJMjdpBM25h+TJhOE0qZkwtJtiyCS/Jfz+Yp8SIjCcQh7w9EUik6awKWOmTfOVrtkdKizUhZGRrtWLcabR1NazC2o163+M1AaxyrRof2PcuiIsrCEnHeIy4GcqcR3iKmDjE6VNNQlFVoqCgq9edKrQ6W9Y9FKQ+z/QffJP956HCDfpMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"interview question tdd four passing\"\n        title=\"interview question tdd four passing\"\n        src=\"/static/b002ae0abef36b243863d349d1960a84/9516f/interview-q-tdd-four-passing.png\"\n        srcset=\"/static/b002ae0abef36b243863d349d1960a84/772e8/interview-q-tdd-four-passing.png 200w,\n/static/b002ae0abef36b243863d349d1960a84/e17e5/interview-q-tdd-four-passing.png 400w,\n/static/b002ae0abef36b243863d349d1960a84/9516f/interview-q-tdd-four-passing.png 538w\"\n        sizes=\"(max-width: 538px) 100vw, 538px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>How about en empty string? Hmm... what should the result be in this case? If this were for a product, this would be a good case to discuss with the product owner or with the team if there's an established standard on how to handle the empty case. For this exercise, let's assume an empty array should be returned to indicate there are no sequences.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;./data_science&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe DataScience </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&#39;Run Length Encoding&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Counts consecutive occurrences of letters in a string&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles alternating letters&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles a single character occurring once&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles a single character occurring multiple times&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Returns en empty array when given an empty string&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">DataScience</span><span class=\"mtk1\">.rle(</span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(result).to eq([])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>This time get a failure:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f47192ed1043b62c9e06d77824d7c6a6/8ecb0/interview-q-tdd-empty-fail.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66835187057634%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABO0lEQVQoz32SS3LDIBBEdQ1LYCG+AiE7TrLOAVKVZcqr5P636DRY/lQiZfHceFDPDAyNfHnH7vUT4e0DX98tzucd8iHCjxNCTJD9gE72EHv1h7J31SvNSNOYJvSDxn6wxFXttWHMQGm7ylqymtBYj+f5iEOcKk9MfkgZp2nGOCZ4FvTUMF70Sim2mrCTCoZHStx0RFd6DIwp0m2weWTBH6cGZKURieFaMdYvyH9Y7bAm1J73EiCVgXy8+L4YFlMxP7KVsLQvrUMbR+w81dkLxqCj4U4xaAieQiwFxErXjeZQhjRDzycYUlTnI/R0hMlPt7WKGV2YIHysibZoMid24lSLphChXahY5+EWtSyq+VSE3LOz/o5cuMUUmkBT5nNJfqxTHbihSMe32PJu26oOHdfCBgjjH/j1n9/9AJFYF3zv6c+ZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"interview question tdd empty case fails\"\n        title=\"interview question tdd empty case fails\"\n        src=\"/static/f47192ed1043b62c9e06d77824d7c6a6/5a190/interview-q-tdd-empty-fail.png\"\n        srcset=\"/static/f47192ed1043b62c9e06d77824d7c6a6/772e8/interview-q-tdd-empty-fail.png 200w,\n/static/f47192ed1043b62c9e06d77824d7c6a6/e17e5/interview-q-tdd-empty-fail.png 400w,\n/static/f47192ed1043b62c9e06d77824d7c6a6/5a190/interview-q-tdd-empty-fail.png 800w,\n/static/f47192ed1043b62c9e06d77824d7c6a6/8ecb0/interview-q-tdd-empty-fail.png 989w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The problem happens at lines 14-16 of the <code>rle</code> method which initializes the results. In Ruby, getting the first character of an empty string returns nil. So the code adds a Tuple of <code>(nil, 1)</code> to results and returns an array with this entry:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">previous_letter </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> input[</span><span class=\"mtk4\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">track[previous_letter] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Tuple</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(previous_letter, </span><span class=\"mtk4\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> track[previous_letter]</span></span></span></code></pre>\n<p>Let's fix this by first checking if the input is an empty string. While we're at it, might as well also check for nil. If this was a Rails project, could use the handy <code>blank?</code> method to check for nil or empty with a single method. But in plain Ruby, can use <code>variable.to_s.empty?</code> as explained in <a href=\"https://stackoverflow.com/a/9915384/3991687\">this SO answer</a>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">module</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">DataScience</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.rle</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">input</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> [] </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> input.to_s.empty?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># rest of the code...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Add another test for nil case and re-run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;./data_science&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe DataScience </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&#39;Run Length Encoding&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Counts consecutive occurrences of letters in a string&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles alternating letters&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles a single character occurring once&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Handles a single character occurring multiple times&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Returns en empty array when given an empty string&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">DataScience</span><span class=\"mtk1\">.rle(</span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(result).to eq([])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;Returns en empty array when given nil&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">DataScience</span><span class=\"mtk1\">.rle(</span><span class=\"mtk4\">nil</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(result).to eq([])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 563px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6c1d073baaa7e46d6b5cb70b7aac4516/7cb89/interview-q-tdd-six-passing.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.268206039076375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+0lEQVQY012OSU7EMBREcwDYICFBBk+Juzt0Bg8ZnBO06AXiDmwRKxASrDh5YbtJFiye6n/bKr+kKGsUwvOXuTwg21ceiUxWIEyA8jLmSkE5csJi/ichTz8gj58g5y/Q0zdu315x9XHG9fszbl5OUNrCDBOUsWg6hWFy2NdHZAXdylfCJ0kqJFJSIqPeini8Tco57hhDytj2MBQEwh4yzQnuPet52KPh4BzMPKFuGgyLw7gsaJTG6E363qDXBl2vo6EyA7QdMbklzuPsUB9bdMrAjvOlkDoDumiQ5gFMt6C2Q2FbiEMN7u2ZqMBLCVHJmJd5FynlbrsPhMJf8O+TFb1gofcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"interview question tdd six passing\"\n        title=\"interview question tdd six passing\"\n        src=\"/static/6c1d073baaa7e46d6b5cb70b7aac4516/7cb89/interview-q-tdd-six-passing.png\"\n        srcset=\"/static/6c1d073baaa7e46d6b5cb70b7aac4516/772e8/interview-q-tdd-six-passing.png 200w,\n/static/6c1d073baaa7e46d6b5cb70b7aac4516/e17e5/interview-q-tdd-six-passing.png 400w,\n/static/6c1d073baaa7e46d6b5cb70b7aac4516/7cb89/interview-q-tdd-six-passing.png 563w\"\n        sizes=\"(max-width: 563px) 100vw, 563px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Success, edge cases are now passing!</p>\n<p>For the complete code and project, go ahead and <a href=\"https://github.com/danielabar/RLE\">clone it on Github</a>.</p>\n<h2>Conclusion</h2>\n<p>To circle back to the original tweet that inspired all this, I didn't time myself exactly but estimate spent approximately an hour. Figuring out the actual logic was around half hour, with some extra time researching how to model Tuples in Ruby. Then more time researching how to setup a plain Ruby project with RSpec, and time to write the tests. Then a little more time thinking of edge cases. This was definitely a useful exercise, I learned a few new things including:</p>\n<ul>\n<li>The term \"run length encoding\"</li>\n<li>Use of Ruby <code>Struct</code> to model a tuple.</li>\n<li>Use of <code>some_var.to_s.empty?</code> to check for nil or empty in a single expression.</li>\n<li>How to setup a plain Ruby project with RSpec tests.</li>\n</ul>\n<p>What do you think of all this? Tweet me if you have some thoughts on - is there a faster/better way to implement run length encoding in Ruby? Have I missed some test cases? What do you think of this style of interview question?</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/python-interview-question-in-ruby/"}}},{"node":{"id":"fea5f655-6a4d-51fd-bb61-b203d7733e70","frontmatter":{"title":"Automate Tabs & Commands in iTerm2","date":"February 2021","category":"terminal"},"excerpt":"Do you find yourself opening many iTerm tabs every day to do the same daily routine such as opening editors, running a build, starting up…","html":"<p>Do you find yourself opening many iTerm tabs every day to do the same daily routine such as opening editors, running a build, starting up various services etc? If yes, good news, this tedious daily startup routine can be automated, saving you precious minutes each day. This post will walk you through how to achieve this automation using <a href=\"https://iterm2.com/\">iTerm</a> and Python.</p>\n<h2>Create Script</h2>\n<p>To get started, make sure iTerm is open, then select from the menu: Scripts -> Manage -> New Python Script as shown below:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 676px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f6d76417ae3fa8b6bfd758ac3501ebad/9bb7a/iterm-menu-new-script.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.1301775147929%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABbUlEQVQoz53O3U/TUBiA8SLqsltvCESEKt1a2daP0w9Kuy7rykbdcKWaLCZ8GEn42EQviNfe4pX6Fz8eJxfAFfHid96ck5wnrzJOA0TcQtgmrrDwJFv4NEU817AD1oIDWsNvvOpdsbQ1Rcu/0z76TXTwk/jwF5vFNcs7P3idnqI8i0asFl9ZGU95XsxYHl/ilnsMC53BeJPdosHevk6crtDNlmi0G0SdNpN3bymLIZP3BW8GKd1tgWaaKFW3R7V/QjU7nqv0PvGiP8DLVJyshp1pWFkdMzMQOzXUJCDs5XyezTi/mHJ6ds7s8gsD+We16aAomqyqBsrLW9SWnL7k3SPf1k3sMOLDZMJoNKIvQ7t5TreTsG4KGdTlYbh3LBiCR4Yzt3DL37tSsxBRwsejQ5IkwfM8fN8nDrdQLfcm+BB159/ULJp+SFmWdLopQgZdPyCXW2644X8E5Xxct6nIbZ/WLZ7UzLmKbrOoO/wBN7PdvRdocBQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"iterm menu new script\"\n        title=\"iterm menu new script\"\n        src=\"/static/f6d76417ae3fa8b6bfd758ac3501ebad/9bb7a/iterm-menu-new-script.png\"\n        srcset=\"/static/f6d76417ae3fa8b6bfd758ac3501ebad/772e8/iterm-menu-new-script.png 200w,\n/static/f6d76417ae3fa8b6bfd758ac3501ebad/e17e5/iterm-menu-new-script.png 400w,\n/static/f6d76417ae3fa8b6bfd758ac3501ebad/9bb7a/iterm-menu-new-script.png 676w\"\n        sizes=\"(max-width: 676px) 100vw, 676px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If prompted, go ahead and download the Python runtime:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 434px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c6b6fab2ae5ed392a0f1b6faec6db7e8/ade6e/download-runtime.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.78341013824885%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABeklEQVQoz11RSW7CQBDkCxwTESIQQQSMPbbHC9jIQUICW6xecC4cyCUJ/8gD8oycorywMt0sWQ6l7im7a6prKle6hPCH0FwffXdwge6d+yPvej6C4RBBGCIIgj8If3GV254Oz7YghQWHqkXVhmWasC0TjrS5WoonmOZP/x/0rVLraHAdB9pIoi8dWEosjmMU2y3yosB6s0FBdb1GlmXYKn48HkPXdRYQQjCoZ8Gb+6NgtV1HtVaHMC1MJhNslNBqtcJyueQ+SZILl6Yp5osF5vMFn2fKwMUhCdKqjWYbjdYdDMNQP87ZSVmWDBIi5HnObs98lqXserfbcX40exGUUsJRTsn+dDplUXJCK1M/m83geR5jMBjA91z4vq9mXOYoZ3ZYp5VV8Bw2P4SyfspFqBspKxokF4fDAfv9Ex6iEM34De7zF0YvHxi+fqK1ej8KXnd6PKzpBvrGGQL6CXQW6pJwNOLHiKJIuZLoegmM6BFmVEBEJbr+gnW+Af0pESNQCB0fAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"download runtime\"\n        title=\"download runtime\"\n        src=\"/static/c6b6fab2ae5ed392a0f1b6faec6db7e8/ade6e/download-runtime.png\"\n        srcset=\"/static/c6b6fab2ae5ed392a0f1b6faec6db7e8/772e8/download-runtime.png 200w,\n/static/c6b6fab2ae5ed392a0f1b6faec6db7e8/e17e5/download-runtime.png 400w,\n/static/c6b6fab2ae5ed392a0f1b6faec6db7e8/ade6e/download-runtime.png 434w\"\n        sizes=\"(max-width: 434px) 100vw, 434px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Next choose the Basic environment (Full Environment is only for more complex scripts that need to install other packages, that won't be necessary for simply opening tabs and running commands):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 475px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b2fe08d8a61b87de8b81ac2079fc5a60/466da/choose-python-env.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.26315789473684%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACJ0lEQVQ4y51USa7TQBD1SWADKyQyKMnPhOMkTuw4sZ04kzLyM1gJGZQvsUAIroE4BRI7JI7BgiOw4ARILB5+9dVR/mdYsHiqruryq65X3dZSqRTyuRxygqzYbPbW5vN5ZDIZxONxJBKJf0LlaPzQ81yYNUvgex7qdQu2bcN1XVSrVbAoiS+RTqfvgDHmaTyFUTYx7HsYDdvQS1U4jhMV8VCr1SLyupD/CY1G47zmN+VyGVoqU8BxVsK3Lzt8/3rEflJE0w2wXi9hWdaZ1DTNO2uiUqlITMUNw4D2NPUM7/cx/Pj0AD8/P8S77RNYbh83pyMOhwN2ux32+72A/mazOceGw6EQkZDFhTCbL6DTKOPD60f4+OYx2raOhuNiMOgjCAJ0Oh1Bt9tFu90WqBj3fyPkhGuWA6NqQzdqMOt2lGDKJjVhW7QcjmrvEiQiqOctYTQUy6LwdQxGE9gNB77vYT6fYzQaYTweCyi60pFQOiqcNSQhExbLELPnKwTtAG6rhevFArPZTLBcLkUv3/fR6/Wk/X6/L1aBUggh70+42WEdbvDy1Vs40QmZcDqdsN1uz4MgKf0wDMUyxsGsViuxLKTrejSUqytcr0KELw4IIqErlbJUY5tseTqdSruX95Ga0Vf6qbjcw6uIUA2gVCrJEOhzrSz3/gbmFAoFFItFeara/bdIe//tqtglGI/FYkI0mUxEazlhMpnE/4Kk/JE0m020okHypL8AQOMFBTh4ei0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"choose python environment\"\n        title=\"choose python environment\"\n        src=\"/static/b2fe08d8a61b87de8b81ac2079fc5a60/466da/choose-python-env.png\"\n        srcset=\"/static/b2fe08d8a61b87de8b81ac2079fc5a60/772e8/choose-python-env.png 200w,\n/static/b2fe08d8a61b87de8b81ac2079fc5a60/e17e5/choose-python-env.png 400w,\n/static/b2fe08d8a61b87de8b81ac2079fc5a60/466da/choose-python-env.png 475w\"\n        sizes=\"(max-width: 475px) 100vw, 475px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Choose Simple script template (because the script we will write will simply run its commands and then exit, it doesn't need to stay open listening for iTerm events):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 482px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d021707f4cf4637a49320a48dcf91a52/37e0d/choose-script-template.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.04979253112033%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACEUlEQVQ4y51UyY7aQBDle1jEIkAwLMbGG9gGbAyGERD2JaBRcsl5znPIIT+Qwyi/EOXvXvwa2fLMIYlyeKrq7upXr6rcTj08PKBWq6Fer8doNBool8soFAooFovC/g2My+VySDmOA01T0TNNWJaFfr+PwWCAZrOJSqWCarX6T6CAbDaLVK/XgzeZwbIH0A1DELquC9u2YYZJkmBscm2E8bS8oygKMpkMUtv9CR9vn/D0+QvGkwCj0Qin0wnj8ThUrsWXdF2P1yRmNQT3eCbL8p3QNA0slx/CQwfdbheTyQSXywWHwwHH4xHX6xXn81n4xO12w3w+x2w2EzZKFhN6rofHYC6GwU32z/d9odTzPKE06dNSJZVF6kgal2z2TGi6du9JqJYBVKqqqrBJPyJ530e2IFZodEMS1YChhVkVXQRwIO/BxpM4mShKxiSdTudO6Jam+Fr7jm+NV7j5AEN/iOPhiN1uh/1+L3pJu1qt3kybCWijQcUKH8tbvA5/4sfwF4LMBo5vY787YL1eh8NaCuLtdovFYoHNZiMGxD2esddU+GYotu7g2X/Bs/eCnmzBdizMZ/cpcuLRRHl5Op0KPwgCoTD5GcVDUVQFUkeCJEtQurI4kCRJgH1J+sk144hWq4V2uy1elngpxUJRvEOBpP8HlEol5PN5QcJWsHySp9NppHj4PyAxfyosnV8Bfygs+Tfd+v4Lahjq7wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"choose script template\"\n        title=\"choose script template\"\n        src=\"/static/d021707f4cf4637a49320a48dcf91a52/37e0d/choose-script-template.png\"\n        srcset=\"/static/d021707f4cf4637a49320a48dcf91a52/772e8/choose-script-template.png 200w,\n/static/d021707f4cf4637a49320a48dcf91a52/e17e5/choose-script-template.png 400w,\n/static/d021707f4cf4637a49320a48dcf91a52/37e0d/choose-script-template.png 482w\"\n        sizes=\"(max-width: 482px) 100vw, 482px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Finally, give your script a name to save it, I name mine <code>daily-startup.py</code> but you can choose any name you like:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 340px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c036064967a69f688e96b5474c7f2ffa/9f933/save-script.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.352941176470594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB2ElEQVQoz22Sy27TUBRF/SFMGAASJbHjx41fSe3aaUnjpHk1VEljQykoNEQqkyKhMOYbmCM+gQkDPm1xr9ugpGWwdK7O0dna++hqQRCwg+8RbhP49E96dLMOgeeW84fc9eW+ZhgGlUqFarVaUjEdnpuCF1adPVkVuvCx/GZZq84uuqpCVQ+jVkOzbZu01eIgjmjECdHpGyYXH+icFfTnl5ycv6U3vaDR7iOSY9w0o552tshwkzbi5RgjTNFM06TRaEjLPnXPJ+i+on32mmQwpTU653A852iSExwPcZIM0eoi0m16kgznaEDNa6LVpE0VNU1T0iRBOA6iXpe4O7h+gB+EePdQ9wvDAE/OLWmuFFSxPc/Ddd1yKZbiiRRXxHFMHEVE/2UfEUvnfsJ+s4FpWWi6rpfDLOsSNUN5u5zi23c+39ywXq9ZLpfMZjOKoiDP83/MJcV8SvDuB3b7inx2iu2I2xsqlxts28GWER0ZfYNKoGbqR6hqSSfCNhGWTsWwZV8v36ZZu42sRDeUwneLm/u25C9YLBasViuulh+ZDDOepp94XPzh4PoX+vvfPBr9xLC9h4L3Ua7CMGQwGDAejxkORxymEXvBmGftr3ijL1S7a54k19Qsh78IvF6yL0incQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"save script\"\n        title=\"save script\"\n        src=\"/static/c036064967a69f688e96b5474c7f2ffa/9f933/save-script.png\"\n        srcset=\"/static/c036064967a69f688e96b5474c7f2ffa/772e8/save-script.png 200w,\n/static/c036064967a69f688e96b5474c7f2ffa/9f933/save-script.png 340w\"\n        sizes=\"(max-width: 340px) 100vw, 340px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Script Skeleton</h2>\n<p>This will open the script in an editor with a basic skeleton already filled in. I've added a few comments to explain what each part does:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"python\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/usr/bin/env python3.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Import the iterm2 python module to provide an interface for communicating with iTerm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> iterm2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># All the script logic goes in the main function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># `connection` holds the link to a running iTerm2 process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># `async` indicates that this function can be interrupted. This is required because</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  iTerm2 communicates with the script over a websocket connection,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#  any time the script sends/receives info from iterm2, it has to wait for a few milliseconds.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">main</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">connection</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Get a reference to the iterm2.App object - a singleton that provides access to iTerm2’s windows,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># and in turn their tabs and sessions.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    app </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> iterm2.async_get_app(connection)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Fetch the “current terminal window” from the app (returns None if there is no current window)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    window </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> window </span><span class=\"mtk7\">is</span><span class=\"mtk1\"> </span><span class=\"mtk7\">not</span><span class=\"mtk1\"> </span><span class=\"mtk4\">None</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Add a tab to current window using the default profile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> window.async_create_tab()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">else</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># You can view this message in the script console.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;No current window&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Make a connection to iTerm2 and invoke the main function in an asyncio event loop.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># When main returns the program terminates.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">iterm2.run_until_complete(main)</span></span></span></code></pre>\n<h2>Run Script</h2>\n<p>Currently, all the <code>daily-startup.py</code> script does is to open a new tab in the current terminal window. It doesn't do any real work yet but let's do a quick test and run it just to make sure everything is setup correctly.</p>\n<p>There are several different ways to <a href=\"https://iterm2.com/python-api/tutorial/running.html\">run a script</a> but the easiest is to use the \"Open Quickly\" window. To launch it, enter <kbd>Cmd</kbd> + <kbd>Shift</kbd> + <kbd>O</kbd>, then start typing the name of the script, when its highlighted, hit <kbd>Enter</kbd> to run it. Make sure the focus is in iTerm when you do this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 487px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/66e01a6789f75f70e996318cf158aac2/7b439/open-quickly.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.86242299794661%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABr0lEQVQoz43Su2/TUBTHcVMkHlOHZukGQ4SEaKo09r3Xr7iJH0mbVGrd4JpCm/KWgsSGhChL/wo2JhYQEisSQ0kZOgFFMADif/ly47RBLIjho3P8s6905XOMy5ZEeHWizgoLtsOVmkXFFMyZ1kRFsywLKeU/OY6D4Xg+V9OUB4MBS+02trKLF57r4nmermOu5ujshHucjXP9je8TBAFG1Q+YFS62Du7dvsVmnrGzfZ2w4eMoE9cWBUdZk/7k2ZbmH6KG7+kbXlIRMwstRLNLZ3WdqJtpOfUkxYvXCFopzeV1XddotFOCZJVwuVfUqmrq3xQWqirErscYc4N3PH3+jdrjIXuvXxLsfUQ8+YXc/YHY/cn0za8Y2RGnr31hKj8qjPqRUxufx9nGJ4z8O7PZK4zyzhsePTvkwt195h++pXx/SGnrgOnNA2ZufOB8NuRM7/3E2d7wr37kXG+fqd4hF/MXGPN+SElELLa69Pt32NruE4YxNT1tSyiUHpKUCvEfRgMyyqaiVNGH/TpL3Y62QpgkLIYRjSimEcc040RP3EUUqyOQQhRViPE6iWNKSX4Duc8nxXFed1MAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"open quickly\"\n        title=\"open quickly\"\n        src=\"/static/66e01a6789f75f70e996318cf158aac2/7b439/open-quickly.png\"\n        srcset=\"/static/66e01a6789f75f70e996318cf158aac2/772e8/open-quickly.png 200w,\n/static/66e01a6789f75f70e996318cf158aac2/e17e5/open-quickly.png 400w,\n/static/66e01a6789f75f70e996318cf158aac2/7b439/open-quickly.png 487w\"\n        sizes=\"(max-width: 487px) 100vw, 487px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The script should run and you should see a new tab open.</p>\n<h2>Run Commands in Tabs</h2>\n<p>Now that we know the script is working, let's go ahead and open another tab, and run some commands in each tab. To do this, we need to get the current session associated with each tab, and then use the <code>async_send_text</code> method to send text through to the tab as if a user had entered it directly into the terminal. The newline character <code>\\n</code> must be appended to each command to actually submit it. Edit your script as follows and save it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"python\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/usr/bin/env python3.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> iterm2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">main</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">connection</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    app </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> iterm2.async_get_app(connection)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    window </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> window </span><span class=\"mtk7\">is</span><span class=\"mtk1\"> </span><span class=\"mtk7\">not</span><span class=\"mtk1\"> </span><span class=\"mtk4\">None</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Open a tab</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> window.async_create_tab()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Get the active session in this tab</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        session </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window.current_tab.current_session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Send text to the session as though the user had typed it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;echo hello</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Open another tab</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> window.async_create_tab()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        session </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window.current_tab.current_session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;echo world</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">else</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;No current window&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">iterm2.run_until_complete(main)</span></span></span></code></pre>\n<p>Go ahead and use the Open Quickly window again (<kbd>Cmd</kbd> + <kbd>Shift</kbd> + <kbd>O</kbd>) to run <code>daily-startup.py</code> again.</p>\n<p>This time you should get two tabs opened with the first one having run <code>echo hello</code> and the second one having run <code>echo world</code>. Of course, echo-ing various text is not that useful, that was just to demonstrate the concept.</p>\n<p>Now that the basic idea is working, the script can be customized to perform all the daily startup tasks you would run. For example, I run two different projects, one of which is started with <code>docker-compose up</code> and another which also uses docker compose but only to start the databases, then runs a rails server in another tab. I also launch a redis gui in another tab. And open VS Code for each project in more tabs. So my script looks something like this. I find it useful to comment each tab section with the task its performing:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"python\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/usr/bin/env python3.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> iterm2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">main</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">connection</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    app </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> iterm2.async_get_app(connection)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    window </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> window </span><span class=\"mtk7\">is</span><span class=\"mtk1\"> </span><span class=\"mtk7\">not</span><span class=\"mtk1\"> </span><span class=\"mtk4\">None</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Open VS Code for project A</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> window.async_create_tab()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        session </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window.current_tab.current_session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;cd path/to/projectA</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;code .</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Run the full stack for project A</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> window.async_create_tab()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        session </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window.current_tab.current_session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;cd path/to/projectA</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;docker-compose up</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Open VS Code for project B</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> window.async_create_tab()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        session </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window.current_tab.current_session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;cd path/to/projectB</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;code .</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Run Postgres and Redis for project B</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> window.async_create_tab()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        session </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window.current_tab.current_session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;cd path/to/projectB</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;docker-compose up</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Run Rails server for project B</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> window.async_create_tab()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        session </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window.current_tab.current_session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;cd path/to/projectB</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;bundle exec rails s</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Run a Redis GUI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> window.async_create_tab()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        session </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> app.current_terminal_window.current_tab.current_session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> session.async_send_text(</span><span class=\"mtk6\">&#39;redis-commander --redis-port 6381 --redis-db 0</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">else</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;No current window&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">iterm2.run_until_complete(main)</span></span></span></code></pre>\n<p>You can keep customizing until the script is performing all the daily tasks you would otherwise be typing in manually.</p>\n<h2>Backup</h2>\n<p>Last thing to do is to make a backup of the script to avoid losing it should your hard drive crash. The script is located at <code>/Users/yourusername/Library/Application Support/iTerm2/Scripts/script-name.py</code>.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/iterm-automation/"}}},{"node":{"id":"1049076a-0894-5c62-a4a2-8cf49e0a80f8","frontmatter":{"title":"Debug Github Actions","date":"February 2021","category":"rails"},"excerpt":"A few weeks ago I was setting up CI (continuous integration) for a Rails project that uses Sidekiq, Redis, and Postgres. Pretty…","html":"<p>A few weeks ago I was setting up CI (continuous integration) for a Rails project that uses Sidekiq, Redis, and Postgres. Pretty straightforward, just needed to run a build, install and configure the services (Postgres and Redis), initialize the database, then run linting and tests.</p>\n<p>Prior to the general release of Github Actions, I would have reached for Travis CI or Circle CI to set this up, which involves giving a 3rd party service access to your Github repo. But ever since <a href=\"https://github.com/features/actions\">Github Actions</a> has been available, its no longer necessary to integrate a 3rd party solution. Github Actions support running any workflow on any event such as push to a branch, merge a PR etc. The configuration is done via a yaml file in the <code>.github/workflows</code> directory in your project. No need to install anything, as soon as you push a branch with a workflow yaml in the directory Github looks for, it will start running the jobs and steps specified in the file. By default, the action will run on Github hosted machines but it's also possible to configure a self-hosted runner. For this post, we will be using the Github action runner.</p>\n<p>As great as Github Actions are, sometimes something will go wrong with the workflow, and the console output from the runner will not be sufficient to figure out what the issue is. This post will walk you through a debugging technique you can use to troubleshoot your workflow.</p>\n<h2>First Attempt</h2>\n<p>The <code>ci.yml</code> file shown below was my first attempt at getting a build going for my Rails project. This file specifies the services that are needed (Postgres and Redis) which are defined in the same syntax as a docker-compose file. The next section specifies all the steps that should be run in sequence. These include checking out the project, setting up the necessary Ruby and Node versions, installing the project dependencies with <code>bundle install</code> and <code>yarn install</code>, then initializing the database with <code>rake db:reset</code>, and finally running the linter (rubocop) and RSpec tests.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">push</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RACK_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">DATABASE_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ci</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">6379:6379</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup Ruby 2.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-ruby@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">ruby-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;2.7&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup Node</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-node@v2-beta</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">node-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;12&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">yarn install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">yarn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Initialize database</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle exec rake db:reset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Run linter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">rubocop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Run tests</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bundle exec rspec</span></span></span></code></pre>\n<p>But after pushing this file and monitoring the Actions output (as soon as you push a valid workflow file, Github will run in and display the results in a new <code>Actions</code> tab displayed on your project page on github.com), the workflow failed with the following error displayed under the <code>Initialize database</code> step:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">PG::ConnectionBad: could not connect to server: Connection refused</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Is the server running on host &quot;127.0.0.1&quot; and accepting</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TCP/IP connections on port 5432?</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/opt/hostedtoolcache/Ruby/2.7.2/x64/bin/bundle:23:in `load&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/opt/hostedtoolcache/Ruby/2.7.2/x64/bin/bundle:23:in `&lt;main&gt;&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Tasks: TOP =&gt; db:reset =&gt; db:drop =&gt; db:check_protected_environments</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(See full trace by running task with --trace)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Error: Process completed with exit code 2.</span></span></code></pre>\n<p>According to the error message, the rake task to initialize the database could not run because the database server wasn't running. This seemed strange as I had the same services configured locally via a <code>docker-compose.yml</code> file and it worked perfectly on my laptop. What I needed was a way to \"inspect\" the Github runner host machine where this flow was running, to investigate why the database failed to start up.</p>\n<h2>Add Tmate Debugger</h2>\n<p>Fortunately, there's a relatively easy way to do this via a community action named <a href=\"https://github.com/mxschmitt/action-tmate\">tmate</a>. This action can be added as a step anywhere in the workflow. It outputs a temporary hostname that you can ssh to and you will be connected to the runner machine. Here's the modified workflow with tmate added just after checking out sources:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">push</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RAILS_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">RACK_ENV</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">DATABASE_HOST</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">REDIS_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;redis://127.0.0.1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ci</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">redis:6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk6\">6379:6379</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup tmate session</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">mxschmitt/action-tmate@v3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># rest of the steps...</span></span></span></code></pre>\n<p>After pushing this change and monitoring the action runner again, when it got to the <code>Setup tmate session</code> step, the following was displayed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">SSH: ssh HghSLAQZ6JqNEQjPEHTu5prMM@nyc1.tmate.io</span></span></code></pre>\n<h2>Debugging in Runner</h2>\n<p>To make use of this, open a terminal tab (I use iTerm) and enter:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ssh HghSLAQZ6JqNEQjPEHTu5prMM@nyc1.tmate.io</span></span></span></code></pre>\n<p>This opens a temporary ssh session on the Github action runner, that is now paused at the last step it was running. In this case, I put the tmate action just after checking out sources but before the setup Ruby step.</p>\n<p>Recall the error said that the rake task to initialize the database had been unable to connect to Postgres. Since Postgres is supposed to be running in a Docker container (that's what the <code>services</code> section of <code>ci.yml</code> specifies), I listed all the active docker processes with the <code>docker ps</code> command (reminder, I'm on the Github Action runner machine here):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az139-674:~/work/myapp/myapp$ docker ps</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4336ebfbbd89        redis:6             &quot;docker-entrypoint.s…&quot;   4 minutes ago       Up 4 minutes        0.0.0.0:6379-&gt;6379/tcp   d04eb80007624ff19d2b34cb344cf4fd_redis6_d9fced</span></span></code></pre>\n<p>Well that's clearly a problem, only the Redis container is running, so what happened to the Postgres container? To get the answer to this question, list the docker processes again but this time with the <code>-a</code> flag to list <em>all</em> processes, not just the running processes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az139-674:~/work/myapp/myapp$ docker ps -a</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS                    NAMES</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4336ebfbbd89        redis:6             &quot;docker-entrypoint.s…&quot;   5 minutes ago       Up 4 minutes               0.0.0.0:6379-&gt;6379/tcp   d04eb80007624ff19d2b34cb344cf4fd_redis6_d9fced</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3ce2dda6db40        postgres:13         &quot;docker-entrypoint.s…&quot;   5 minutes ago       Exited (1) 5 minutes ago                            d9f1a3d336094b2d8b26703081b78d99_postgres13_67885a</span></span></code></pre>\n<p>Ah, so a Postgres container was started, but something went wrong and it exited shortly after starting. In order to get a clue as to what went wrong, we can check the containers logs using the <code>docker logs</code> command, passing in the container name:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az139-674:~/work/myapp/myapp$ docker logs d9f1a3d336094b2d8b26703081b78d99_postgres13_67885a</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The files belonging to this database system will be owned by user &quot;postgres&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">This user must also own the server process.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The database cluster will be initialized with locale &quot;en_US.utf8&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The default database encoding has accordingly been set to &quot;UTF8&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The default text search configuration will be set to &quot;english&quot;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Data page checksums are disabled.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fixing permissions on existing directory /var/lib/postgresql/data ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">creating subdirectories ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting dynamic shared memory implementation ... posix</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting default max_connections ... 100</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting default shared_buffers ... 128MB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">selecting default time zone ... Etc/UTC</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">creating configuration files ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">running bootstrap script ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">performing post-bootstrap initialization ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">syncing data to disk ... ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Success. You can now start the database server using:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pg_ctl -D /var/lib/postgresql/data -l logfile start</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">initdb: warning: enabling &quot;trust&quot; authentication for local connections</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">You can change this by editing pg_hba.conf or using the option -A, or</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--auth-local and --auth-host, the next time you run initdb.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">waiting for server to start....2021-01-31 18:52:53.451 UTC [47] LOG:  starting PostgreSQL 13.1 (Debian 13.1-1.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-01-31 18:52:53.461 UTC [47] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-01-31 18:52:53.463 UTC [48] LOG:  database system was shut down at 2021-01-31 18:52:52 UTC</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-01-31 18:52:53.467 UTC [47] LOG:  database system is ready to accept connections</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> done</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">server started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/init.sql</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">psql:/docker-entrypoint-initdb.d/init.sql: error: could not read from input file: Is a directory</span></span></code></pre>\n<p>This reveals another clue, so the database fails to start because it tried to run <code>init.sql</code> but was unable to find it. Before moving on, to exit the debug session, enter <code>touch continue</code> in the runner ssh session, this will end it and the workflow on Github will continue to run after this point.</p>\n<p>Back to the investigation, what is this <code>init.sql</code> file that the Postgres container logs reported as not being able to read? The <code>postgres:13</code> Docker image has support for running one-time initialization sql files. The first time the database is being created, if any files are found in directory <code>/docker-entrypoint-initdb.d</code>, then they will be run.</p>\n<p>For this project, <code>init.sql</code> is located in the project root and is only intended to be used for development and CI where Postgres is run in a container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- init.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">create</span><span class=\"mtk1\"> </span><span class=\"mtk7\">role</span><span class=\"mtk1\"> myapp </span><span class=\"mtk7\">with</span><span class=\"mtk1\"> createdb </span><span class=\"mtk7\">login</span><span class=\"mtk1\"> </span><span class=\"mtk7\">password</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;thepasswordgoeshere&#39;</span></span></span></code></pre>\n<p>Looking back at the service definition, a <a href=\"https://docs.docker.com/storage/bind-mounts/\">bind mount</a> is used to mount <code>init.sql</code> from the project root into the Postgres container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span></span></code></pre>\n<h2>Second Attempt</h2>\n<p>So why couldn't it find <code>init.sql</code>? Doing some searching led me to a suggestion to try mounting to a folder rather than specific file like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">/home/runner/work/myapp/myapp:/docker-entrypoint-initdb.d/</span></span></span></code></pre>\n<p>So I pushed this change, leaving the debug tmate action in place, triggering another run of the action runner. Then once again used the ssh command provided by tmate to connect to the runner (it provides a different address each time), then ran <code>docker ps</code> to see if this time the Postgres container was running. This time it did look like Postgres started successfully:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az121-980:~/work/myapp/myapp$ docker ps</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS         PORTS                    NAMES</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">42a987ae5e27   redis:6       &quot;docker-entrypoint.s…&quot;   3 minutes ago   Up 3 minutes   0.0.0.0:6379-&gt;6379/tcp   fe73cffdfe5a474cb4844f6018b151f8_redis6_db473b</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">f96addde3fe1   postgres:13   &quot;docker-entrypoint.s…&quot;   3 minutes ago   Up 3 minutes   0.0.0.0:5432-&gt;5432/tcp   aeaf1d3eae4b46948276077399135246_postgres13_3406a2</span></span></code></pre>\n<p>But it was too early to declare success. The question is - was it able to locate the <code>init.sql</code> file and run it to create the <code>myapp</code> role? A check of the logs revealed that did not happen (it would otherwise output <code>CREATE ROLE</code> in the logs). Also note the logs indicate its ignoring the docker entrypoint script:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az121-980:~/work/myapp/myapp$ docker logs aeaf1d3eae4b46948276077399135246_postgres13_3406a2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/usr/local/bin/docker-entrypoint.sh: ignoring /docker-entrypoint-initdb.d/*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[snip]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PostgreSQL init process complete; ready for start up.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.125 UTC [1] LOG:  starting PostgreSQL 13.2 (Debian 13.2-1.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.126 UTC [1] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.126 UTC [1] LOG:  listening on IPv6 address &quot;::&quot;, port 5432</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.129 UTC [1] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-02-15 16:45:09.135 UTC [1] LOG:  database system is ready to accept connections</span></span></code></pre>\n<p>Hmm... so the folder mount didn't work. So what is the containers view of the <code>/docker-entrypoint-initdb.d</code> directory? To answer this question, you can use <code>docker exec container_name command</code> to run a command in the container. Let's run bash so we can run further shell commands inside the Postgres container:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">runner@fv-az121-980:~/work/myapp/myapp$ docker exec -it aeaf1d3eae4b46948276077399135246_postgres13_3406a2 bash</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">root@f96addde3fe1:/# ls -al /docker-entrypoint-initdb.d</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[no output - empty dir]</span></span></code></pre>\n<p>So the <code>/docker-entrypoint-initdb.d</code> directory is empty, which is strange because in the workflow file <code>.github/workflows/ci.yml</code> it's mounted to the project root, so you would think all the project files would be listed.</p>\n<p>And here is where I had a big AHA! moment. Looking at the order in which Github processes the workflow file, the containers are started BEFORE the project source is checked out. This means a bind mount to any file in the project will never work because the project sources don't yet exist on the host (i.e. Github Action runner).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/07bf4b46f29724ffefd08baca207aaef/bc3ae/github-actions-order.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.76971608832807%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABSUlEQVQ4y5WT2W6DMBREkdqEsG9mpxCySFFTpVIeqv7/j009NzUvkSLzcGUD9vj4zuDs/ARekCLNGwRRDj/MpLwgg+vF4HfXS2T+GF+Xww1BXOB2/0Xd7VG1E9rhgLRo8Lbxsd2FuiLrcgxFUfZCGCZKysx5GNdw8YPydQlhqDddv3+gqgH9eNSEM8pm1PMTmn6WFlgLGsKqHYUmiAo5gIR83vnpImYjuvTw8nUXQtIZQvYyySq8bwN7QUPIzXFaLk6TkmOk3626shBqkdPlBlUPIlz/O113E4bprClrbNzQvofM4bB/bGQPSRUlpaZUEh0jZn1lP8wxnz6Rl524yixyzIp2WbjKZU/3aDpcJMyxNoFGcG7CulqQTZ/PV+Sq0+5+oKh6idEaoSdBVwKu5I/hVTPVatcrazOerswsMjbMH0XpOI1ZK/gHm4NEfzLMSvQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github action order\"\n        title=\"github action order\"\n        src=\"/static/07bf4b46f29724ffefd08baca207aaef/5a190/github-actions-order.png\"\n        srcset=\"/static/07bf4b46f29724ffefd08baca207aaef/772e8/github-actions-order.png 200w,\n/static/07bf4b46f29724ffefd08baca207aaef/e17e5/github-actions-order.png 400w,\n/static/07bf4b46f29724ffefd08baca207aaef/5a190/github-actions-order.png 800w,\n/static/07bf4b46f29724ffefd08baca207aaef/c1b63/github-actions-order.png 1200w,\n/static/07bf4b46f29724ffefd08baca207aaef/bc3ae/github-actions-order.png 1268w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Solution</h2>\n<p>So now that we know the root cause of the issue, the problem can be solved. The solution is to use <code>docker exec</code> to run a <code>psql</code> client inside the container to create the role rather than relying on a bind mount. However, in order to run <code>docker exec</code> the container name must be known. As can be seen from the earlier output, by default, the name is dynamically generated. This can be resolved by passing the <code>--name</code> flag in the service options which assigns the container a predictable name:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">db</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres:13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_PASSWORD</span><span class=\"mtk1\">: </span><span class=\"mtk6\">its_a_secret</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">POSTGRES_USER</span><span class=\"mtk1\">: </span><span class=\"mtk6\">postgres</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">5432:5432</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># volume for bind mount removed!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># assign the container a predictable name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">options</span><span class=\"mtk1\">: </span><span class=\"mtk6\">--name myapp_db</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">redis</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># same as before...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Create role</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">docker exec myapp_db bash -c &quot;PGPASSWORD=shhhhh psql -U postgres -c \\&quot;create role myapp with createdb login password &#39;myapp&#39;\\&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># remainder of the steps...</span></span></span></code></pre>\n<p>And this time the workflow did run successfully. The database was initialized with the role so <code>bundle exec rake:db_reset</code> could complete successfully.</p>\n<h2>Conclusion</h2>\n<p>If you get stuck on a Github Action workflow not running as you would expect, try adding the <a href=\"https://github.com/mxschmitt/action-tmate\">tmate</a> action to your workflow file, ssh to the runner machine, and see what you can find. Remember to remove the debug step when the issue has been resolved.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/debug-github-action/"}}},{"node":{"id":"9d0929c0-f756-50af-bb64-9c93f51f913d","frontmatter":{"title":"TDD by Example","date":"January 2021","category":"javascript"},"excerpt":"If you've been coding for any length of time, you've probably heard that you should test your code, and by that I mean writing automated…","html":"<p>If you've been coding for any length of time, you've probably heard that you should test your code, and by that I mean writing automated tests. This can be challenging at first, but with some practice, it becomes easier. When first learning to write tests, it's easier to have already written the production code, then open up another editor tab side by side with that code, and write some tests against that code. However, there's another approach to writing tests called <a href=\"https://en.wikipedia.org/wiki/Test-driven_development\">Test Driven Development</a>, aka TDD. According to Wikipedia, TDD is:</p>\n<blockquote>\n<p>A software development process relying on software requirements being converted to test cases before software is fully developed, and tracking all software development by repeatedly testing the software against all test cases. This is opposed to software being developed first and test cases created later.</p>\n</blockquote>\n<p>In practice what this means is, suppose you want to add a new feature to some software. You would first write a test for that feature and run the test. The test would fail since the new feature hasn't been written yet. Then you write just enough code to get that test to pass. When it passes, then you add another test for this feature, run it to see that it fails, write more code to get this to pass, and continue until the feature is complete. Typically the first test you write would be for the \"happy path\", then next test would be for an edge case such as invalid input and so on.</p>\n<p>This is much harder to do because you don't have the actual code to look at, instead you have to picture what the result of the code should be and write a test to expect that result. In fact, this is the benefit of TDD. You end up with tests that verify the results of the code, rather than implementation details. But the first time you try this, it can be difficult to know where to start.</p>\n<p>This post will walk you through an example of using TDD that I did recently to add a new feature to <a href=\"https://github.com/danielabar/tidysum\">Tidysum</a>. I will assume that you already know how to write tests generally, but are new to TDD specifically.</p>\n<p>First, what is Tidysum? Tidysum is a personal finance app that takes in a list of daily expenses and outputs a summary json file with year and month breakdowns of these expenses by category, showing total and average spending per month and per year, and makes savings and spending recommendations. It's written as an npm module and runs as a CLI. The feature I added was a percentage difference calculation for total and by-category spending year over year. The idea is to calculate a personalized rate of inflation based on your actual spending, rather than some theoretical basket of goods determined by government bureaucrats.</p>\n<p>Aside: I was inspired to add this after learning from several finance podcasts that the official government inflation numbers may not reflect reality as they don't include food and energy. As some government benefits are indexed to inflation, as are many employers' annual cost of living increases, it may benefit some to have this number reported as lower than it really is. The inflation number is also used in personal finance for retirement planning and so can be disastrous if incorrect. Of course there's nothing I can do about the big macro, but as a developer, I can improve my software to generate more personalized information to help inform better decision making.</p>\n<p>Ok back to TDD. Tidysum reads in a csv file of expenses like this (abbreviated, but imagine this goes on for several years):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"csv\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-01-01,...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-10-01,34.29,Groceries,Loblaws</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-10-01,133.99,Restaurant,The Keg</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-10-04,5.99,Entertainment,Amazon</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-10-15,54.00,Groceries,Loblaws</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2018-11-15,11.67,Health,Loblaws</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2019-10-15,120,Groceries,Loblaws</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2019-10-20,20,Restaurant,Dominos</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2019-10-25,10.00,Entertainment,Apple</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2019-11-10,12.49,Health,Whole Foods</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2020-12-24,...</span></span></code></pre>\n<p>And generates a summary json where each key is the year. Each year shows the total spending for that year, and then has another object where each key is the month in that year. Each month shows total spending for that month, as well as the breakdown by category and by merchant.</p>\n<p>Each year also has an <code>average</code> section, where it shows on average how much was spent each month, and again, an average breakdown by category. The summary looks something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;2018&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;239.94&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Oct&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;228.27&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;88.29&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;133.99&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.99&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;88.29&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;The Keg&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;133.99&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Amazon&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.99&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Nov&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;average&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;monthly&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;119.97&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;44.15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;67.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;3.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.84&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;2019&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;162.49&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Oct&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;150&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;120&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;20&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;120&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Dominos&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;20&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Apple&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Nov&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Whole Foods&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;average&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;monthly&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;81.25&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;60.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;6.25&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>What I wanted to add was another per year entry to show the percentage difference in total and per category spending as compared to the previous year, like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;2018&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;239.94&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Oct&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;228.27&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;88.29&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;133.99&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.99&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;88.29&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;The Keg&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;133.99&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Amazon&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.99&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Nov&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;11.67&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;average&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;monthly&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;119.97&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;44.15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;67.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;3.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.84&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;percentageDiffPreviousYear&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;N/A&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;2019&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;162.49&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Oct&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;150&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;120&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;20&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Loblaws&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;120&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Dominos&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;20&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Apple&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;Nov&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byMerchant&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Whole Foods&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;12.49&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;average&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;monthly&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;81.25&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;byCategory&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;60.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;10.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;5.00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;6.25&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;percentageDiffPreviousYear&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;total&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;-32.28&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;Groceries&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;35.9&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;Restaurant&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;-85.07&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;Entertainment&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;66.67&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;Health&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;7.02&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>So for the first recorded year, <code>percentageDiffPreviousYear</code> would be <code>N/A</code> because there's nothing to compare it to. Then for the following year, it should calculate percentage difference in total and by category spending as compared to the previous year.</p>\n<p>This kind of problem lends itself very well to TDD because the desired output is exactly known. And this is exactly what goes in the tests.</p>\n<p>Ok let's get into the code. Recall this project already exists and most of the code is already written. The processing of the file happens in a function named <code>processFile</code> in the <code>lib/expense.js</code> module. It first generates the <code>expenseSummary</code> by reading the expense csv line by line. then it goes over the expense summary to add in the averages - this part is delegated to a <code>calculator</code> module in a method named <code>calcAvg</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/expense.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> csv </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;csv-streamify&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> calculator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./calculator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> recommendation </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./recommendation&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other imports...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">mothlyIn</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">fixedExp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Read input csv of expenses to generate summary json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Enhance the json summary with averages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummaryWithAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> calculator.</span><span class=\"mtk5\">calcAvg</span><span class=\"mtk1\">(expenseSummary);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (mothlyIn </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> fixedExp) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    recommendation.</span><span class=\"mtk5\">determine</span><span class=\"mtk1\">(expenseSummaryWithAvg, mothlyIn, fixedExp);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// TODO: Further enhance json summary - Calculate percentage diff year over year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummaryWithAvg;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">file</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use csv-streamify to stream in input csv and generate expense summary json object</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Details are not relevant for this post, see project on github for complete code.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// rest of functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  process,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>My thought was after the averages have been added to the expense summary, it would be a good time to further process <code>expenseSummaryWithAvg</code> to add the percentage differences. Since the average calculation is delegated to the calculator module, it makes sense to delegate percentage difference calculation to this module as well. So it will look something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">process</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">inputFile</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">mothlyIn</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">fixedExp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">processFile</span><span class=\"mtk1\">(inputFile);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expenseSummaryWithAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> calculator.</span><span class=\"mtk5\">calcAvg</span><span class=\"mtk1\">(expenseSummary);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (mothlyIn </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> fixedExp) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    recommendation.</span><span class=\"mtk5\">determine</span><span class=\"mtk1\">(expenseSummaryWithAvg, mothlyIn, fixedExp);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEW LINE ADDED HERE:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> withYearlyDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> calculator.</span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(expenseSummaryWithAvg);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> withYearlyDiff;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2>Calculator Tests</h2>\n<p>Now instead of jumping in to add a new method <code>calcYearlyDiff</code> to the calculator module and implement it, this is where the TDD approach will come in. Let's first add a test to specify what should be the expected output of this method. This project uses the <a href=\"https://mochajs.org/\">Mocha</a> test framework and <a href=\"https://www.chaijs.com/api/assert/\">Chai</a> for assertions, but TDD principles can be used with any testing library.</p>\n<p>Here is the existing calculator module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"javascript\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcAvg</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// existing logic...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  calcAvg,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And the existing calculator tests:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"javascript\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/calculator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> calculator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/calculator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcAvg&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tests for existing calcAvg method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>We know the calculator module needs to have a new method <code>calcYearlyDiff</code> so let's add a test for that. The style I'm following is a <code>describe</code> block for each method in the module, and an <code>it</code> test for each condition of the method to be tested:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/calculator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> calculator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/calculator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcAvg&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tests for existing calcAvg method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcYearlyDiff&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculates percentage difference in total and categories compared to previous year&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// do test things here!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>So what should go in the test body? I like to follow the <a href=\"https://martinfowler.com/bliki/GivenWhenThen.html\">GivenWhenThen</a> approach. Just about every test can be expressed as \"Given\" a certain set of inputs, \"When\" the system under test is invoked, \"Then\" expect certain results.</p>\n<p>In this case, the input to the <code>calcYearlyDiff</code> method will be the expense summary json object which contains a key for each year, then each year having total and average by category spending. The system under test is the <code>calcYearlyDiff</code> method in the calculator module. The expected result is a modified expense summary object having an additional property <code>percentageDiffPreviousYear</code>, which itself is an object containing percentage differences for total spending, and for each category.</p>\n<p>Let's express this in a test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcYearlyDiff&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculates percentage difference in total and categories compared to previous year&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Given total spending increase of 25%, grocery spending increase of 11.11% and gift spending decrease of 20%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> summary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;2019&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total: </span><span class=\"mtk6\">&#39;20000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gifts: </span><span class=\"mtk6\">&#39;100&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;2020&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total: </span><span class=\"mtk6\">&#39;25000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gifts: </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedSummaryWithDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;2019&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total: </span><span class=\"mtk6\">&#39;20000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gifts: </span><span class=\"mtk6\">&#39;100&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        percentageDiffPreviousYear: </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;2020&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total: </span><span class=\"mtk6\">&#39;25000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gifts: </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        percentageDiffPreviousYear: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;25&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          groceries: </span><span class=\"mtk6\">&#39;11.11&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          gifts: </span><span class=\"mtk6\">&#39;-20&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// When calculator function calcYearlyDiff is invoked</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> calculator.</span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(summary);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Then expect result to contain `percentageDiffPreviousYear` as shown in `expectedSummaryWithDiff`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">eql</span><span class=\"mtk1\">(expectedSummaryWithDiff);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>The amazing this is all this can be written without knowing yet how the <code>calcYearlyDiff</code> function will be implemented. In fact we don't care about implementation at this point, the only thing that matters is expressing what the function should return given a certain input.</p>\n<p>Next step is to run the tests, this project uses npm scripts with the test script defined to run mocha as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// package.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;scripts&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;test&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;NODE_ENV=test mocha test/**/*.test.js&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Tests are run by entering the <code>npm test</code> command in a terminal. At this point, the newly added test will fail with the following error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">1) calculator</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  calcYearlyDiff</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    calculates percentage difference in total and categories compared to previous year:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TypeError: calculator.calcYearlyDiff is not a function</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> at Context.it (test/lib/calculator.test.js:96:33)</span></span></code></pre>\n<p>This is expected as we haven't yet touched the calculator module. Let's change that now by adding an empty function definition and exporting it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// TODO...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  calcAvg,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  calcYearlyDiff,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>Running the tests again <code>npm test</code> results in a different error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">1) calculator</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  calcYearlyDiff</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    calculates percentage difference in total and categories compared to previous year:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">AssertionError: expected undefined to deeply equal { Object (2019, 2020) }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> at Context.it (test/lib/calculator.test.js:98:25)</span></span></code></pre>\n<p>Again, this is expected because the function has no implementation, it implicitly returns <code>undefined</code>, which does not match the <code>expectedSummaryWithDiff</code> the test expects.</p>\n<h2>Calculator Implementation</h2>\n<p>Ok, NOW we're ready to write some implementation in the calculator module. This solution iterates over each year in the <code>expenseSummary</code> using <code>Object.entries(obj)</code> which returns an array of key/value pairs of the given object, and then <code>forEach</code> to loop over these.</p>\n<p>For each year, find the previous year in the object, if it's not found, set the current year's <code>percentageDiffPreviousYear</code> to <code>N/A</code> because there's nothing to compare to. Otherwise calculate percentage difference between the current year's total spending to previous years total spending and save this in the <code>percentageDiffPreviousYear.total</code> property of the current year. And then iterate over each average by category spending for current year, calculate its percentage difference relative to previous year, and save it in the <code>percentageDiffPreviousYear[curCategory]</code> property of the current year.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ((yearSummary.total </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\"> </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((curAvg </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\"> </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Now running the test results in a different failure, the returned object is not quite as expected.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1092c7575efc0803f4399221d0a2c997/5205c/tdd-fail-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.0984393757503%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABGElEQVQoz5VS2W7DMAzrb2w5fMZxHDtu06Ybhv3/b3FSjsLDBqx7oClaAi0JPkltEfMZbx+fxBco69AqA6EZFq3Uqy6x3he6oZq6lWiEwokDazrcLzcs1wUpTcgpI40JU5wQfEAMIwIhT5niSHxemZFiWmvYjL1WQ20MTHBwWiNTopcKlrjb4QhGyG+xK/I9oT0MGzoqEo3t8NIKVI3AK6Hi+wI11Tx0GR/5Y2Q+2GQcJyzLO+brHTnPiDR2P4wQvKO9+C9sHe6BNha3+UzGAX4Y4EkHWraT6vH6/wxdD3+b4VKCcA61Uj86e8b4YeiHCOf8OrrtPKq6pb1tu6mLHZXxr4ac5D0p+jrMDEnjsuY/ylBm42c6/ALWofuqMGgXbAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 1\"\n        title=\"tdd fail 1\"\n        src=\"/static/1092c7575efc0803f4399221d0a2c997/5a190/tdd-fail-1.png\"\n        srcset=\"/static/1092c7575efc0803f4399221d0a2c997/772e8/tdd-fail-1.png 200w,\n/static/1092c7575efc0803f4399221d0a2c997/e17e5/tdd-fail-1.png 400w,\n/static/1092c7575efc0803f4399221d0a2c997/5a190/tdd-fail-1.png 800w,\n/static/1092c7575efc0803f4399221d0a2c997/5205c/tdd-fail-1.png 833w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Well we've made some progress as the gifts and total percentage calculations are correct. But notice the color coding for expected (green) vs actual (red) results. If the result of the calculation is a decimal, we only want to see two decimals of precision. Currently there's no rounding or truncation so results are not as expected.</p>\n<p>Let's fix the code to make the test pass. To get the desired decimal precision, will use <code>Math.round(num * 100) / 100</code> where <code>num</code> is the percentage difference calculation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> totalDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((yearSummary.total </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> totalDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(totalDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> totalDiffRounded </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((curAvg </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(categoryDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And now the test passes - yay!</p>\n<p>At this point, you may have noticed two things: 1) The percentage difference calculation is repeated in two places - once for the total difference, and again in the loop for each category. And 2) this code is getting messy, especially once the rounding logic is added. At this point, it might be tempting to refactor, but let's hold off for now until all the tests are in place. The goal here is to get all the functionality working, then we can refactor to make improvements.</p>\n<h2>Detect New Categories</h2>\n<p>One more feature this code needs to support is detection of new categories. For example, suppose you purchased some vitamins in 2020, but didn't purchase any in 2019. In this case we can't calculate the percentage difference in vitamin spending because there's nothing to compare it to.  In this case, the code should simply display <code>new category</code>. Let's define this behavior in a new test. Again, this is TDD, we write the test before implementing the requirement:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/calculator.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> calculator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/calculator&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculator&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcAvg&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// existing tests for calcAvg function...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calcYearlyDiff&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;calculates percentage difference in total and categories compared to previous year&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// test we just wrote...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Our new test here:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;detects a new category in the current year&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> summary </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;2019&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;20000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              groceries: </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;2020&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;25000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              groceries: </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              vitamins: </span><span class=\"mtk6\">&#39;90&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> expectedSummaryWithDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;2019&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;20000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              groceries: </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          percentageDiffPreviousYear: </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;2020&#39;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          total: </span><span class=\"mtk6\">&#39;25000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          average: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            byCategory: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              groceries: </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              vitamins: </span><span class=\"mtk6\">&#39;90&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          percentageDiffPreviousYear: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            total: </span><span class=\"mtk6\">&#39;25&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            groceries: </span><span class=\"mtk6\">&#39;11.11&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            vitamins: </span><span class=\"mtk6\">&#39;new category&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      calculator.</span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(summary);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(summary).to.</span><span class=\"mtk5\">eql</span><span class=\"mtk1\">(expectedSummaryWithDiff);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Now when we run the calculation tests, the first test that we wrote earlier passes, but the newly added test fails:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 798px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f00ad508e984f49fa04c96e54beb3076/898f6/tdd-fail-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.80200501253132%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAABmklEQVQ4y42TWXIDIQxEfY14DANiGWbxmqVS+Ulluf+VOi3GdlxJyvHHMzIDTUuCRUgddocHdMME6wMa67AkzQ9WN2Baj0UrEfv7Bzw/PmG73iLFhJJyHXPMiPyeQoKECOF/rzHHGovOpTpnnVTRhZ5uVhbJtAiMMz8MdJo45iMdEWKIdb5uVtTRaVSqoBFBO3awOZ1TbvjxnG6N/e0pC21vyoCSS51o6FZZ0XFzwWnDNapDdTVs93h9/8Tj8wvKuEbuRwibFXhI7HpEHuhYp7lZ/lfDTlSHerow2PQDJgqsKbAfJ4yMJ8aKZtCz+FJr7BG5PpD0g7mG/PEpwo4ZzrUoSwPfGBjSEscDvaLrjkJyJFwgZ0EGS27QNEemrpRpg2GzQ8f0LWv8q1HXUq6NoGDHtD7fPvDCOh52B0wUE5nvl7mhIebSYYW1yWNh+gGBNCXhrkvn7q5uEPx2yE09HUU2o9/uKDyh8Vwg4U8XVwV1gWOdFMsJx2vU6jPSu2f+vrzXRGdBiuibPAl/v9f5nXq+48D/Ldf95/ALQOmFGO/mr3kAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 2\"\n        title=\"tdd fail 2\"\n        src=\"/static/f00ad508e984f49fa04c96e54beb3076/898f6/tdd-fail-2.png\"\n        srcset=\"/static/f00ad508e984f49fa04c96e54beb3076/772e8/tdd-fail-2.png 200w,\n/static/f00ad508e984f49fa04c96e54beb3076/e17e5/tdd-fail-2.png 400w,\n/static/f00ad508e984f49fa04c96e54beb3076/898f6/tdd-fail-2.png 798w\"\n        sizes=\"(max-width: 798px) 100vw, 798px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Again this makes sense because vitamin spending for 2019 doesn't exist therefore the line to retrieve the previous years category average will return <code>undefined</code>. Then trying to use <code>undefined</code> in a calculation results in <code>NaN</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// When `curCategory` is &#39;vitamins&#39;, `prevAvg` will be undefined</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((curAvg </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;    </span><span class=\"mtk3\">// NaN</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(categoryDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;   </span><span class=\"mtk3\">// NaN</span></span></span></code></pre>\n<p>Now that the test is in place, we can enhance the code to handle this case. The solution is to first check if the previous years average exists. If it doesn't, then output <code>new category</code>, otherwise, go ahead and run the percentage difference calculation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> totalDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((yearSummary.total </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> expenseSummary[prevYear].total) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> totalDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(totalDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> totalDiffRounded </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">prevAvg) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;new category&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ((curAvg </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> prevAvg) </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk9\">round</span><span class=\"mtk1\">(categoryDiff </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">) </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> categoryDiffRounded </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This time both tests should pass.</p>\n<p>But we're not done yet. Remember earlier I pointed out several issues with this code - the same percentage difference calculation is written twice, and overall code is getting messy. This code is both iterating the expense summary and doing some mathematical calculations. Now that we've got all the percentage difference feature covered by tests, we can tackle a refactor to fix these issues.</p>\n<h2>Refactoring Calculation</h2>\n<p>This project actually has another module <code>lib/decimal-util.js</code> to perform all numeric calculations. This module uses the <a href=\"https://github.com/MikeMcl/decimal.js/\">decimal.js</a> library. I was looking for something similar to <a href=\"https://docs.oracle.com/en/java/javase/15/docs/api/java.base/java/math/BigDecimal.html\">BigDecimal</a> in Java to avoid some Javascript known issues with decimal calculations. The decimal-util module would be a perfect place for the percentage difference calculation to live. Then the calculator module could simply make use of it wherever needed. Here's what I'm picturing:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// This module is already imported because its used in other functions in the calculator module</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other imports and functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// NEW: Use decimal-util module for percentage diff calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(expenseSummary[prevYear].total, yearSummary.total);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">prevAvg) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;new category&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// NEW: Use decimal-util module for percentage diff calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prevAvg, curAvg);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Now running the tests will fail:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4ab940436d77bc3aaa0fb0f79c6be3c9/d4c13/tdd-fail-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.81818181818181%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAABi0lEQVQ4y41SW1LDMAzsOWhi5+HYjvMuMDCUtsP9D7WsnKSEDmX6sbOyLW2kVXZ5adBPB/i2hyoMnlQWsd/wI0iIVOfYpVmB537EaTzgpW4QeNnxriFawmc5arLTN8x7y9gvLGIiuttrKqcaloeKkEQRkiS3FAhyxnpBtolXXAVVUSAPFqoySHQxj8zH/Qo1c/IAUhHM8hJd22Gij8bV8WHPjqM3K69+8pxs+BbRQxGoKXQ5nnA+fuKVwgMXNHUDDsOEhr62ocXQdBiGEYFv3cI17xrm1U0LRZtmD8U3bre1DqFy6J1HXwcMPsSzNxaurNAwNmRZovoDP0th+5qCNjSoKCLs2NF8rlFaTzgU5LXoHuLImh5aFnqOllE4XTamsnz+up5Z8lbBNWeLq6AkB3pxvnzh7f0jxo6dGhmRqOivQC8e/ScaBaOH8nOzw4Gdys/9SqPlPIqXshDGvYy9Eb0rKAklO5GNORYKPEUEhr4VXErOZUgsYz8kKImlFNJDKS5MtbD9FasHOvwG+G1tZvobWyQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 3\"\n        title=\"tdd fail 3\"\n        src=\"/static/4ab940436d77bc3aaa0fb0f79c6be3c9/5a190/tdd-fail-3.png\"\n        srcset=\"/static/4ab940436d77bc3aaa0fb0f79c6be3c9/772e8/tdd-fail-3.png 200w,\n/static/4ab940436d77bc3aaa0fb0f79c6be3c9/e17e5/tdd-fail-3.png 400w,\n/static/4ab940436d77bc3aaa0fb0f79c6be3c9/5a190/tdd-fail-3.png 800w,\n/static/4ab940436d77bc3aaa0fb0f79c6be3c9/d4c13/tdd-fail-3.png 825w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The reason both tests are failing now is because it's trying to invoke a function <code>decimalUtil.percentDiff(...)</code> that doesn't exist. The solution to this is to add the <code>percentDiff</code> function to the <code>decimal-util</code> module, write the implementation and export it. But wait, we're doing this TDD style. So before writing any implementation, let's write a test, this time for the decimal util module.</p>\n<p>Here's the existing decimal util module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/decimal-util.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> Decimal </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimal.js&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">divideAndRound</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">numeratorIn</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">denominatorIn</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> numerator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(numeratorIn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> denominator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(denominatorIn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> numerator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">dividedBy</span><span class=\"mtk1\">(denominator)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">toFixed</span><span class=\"mtk1\">(</span><span class=\"mtk4\">2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">toString</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">sum</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">in1</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">in2</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> in1Dec </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(in1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> in2Dec </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(in2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> in1Dec.</span><span class=\"mtk5\">plus</span><span class=\"mtk1\">(in2Dec).</span><span class=\"mtk5\">toString</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// more functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  divideAndRound,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  sum,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And the existing decimal util tests:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/decimal-utils.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimalUtil&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;divideAndRound&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tests for divideAndRound function...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// tests for other functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Looking at the refactored calculator module, we need a method in decimal util <code>percentDiff</code> that takes two numbers - a previous and current, and returns the percentage difference between them. If the current value is greater than previous, we expect a percentage increase. If current value is less than previous, we expect a percentage decrease. If they are the same, then percentage difference should be 0. Finally, if the result is not an integer, it should round to two decimal places. That's 4 different requirements, let's define all of these as tests:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/lib/decimal-utils.test.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;../../lib/decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { expect } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;chai&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimalUtil&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;divideAndRound&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tests for divideAndRound function...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// NEW: Tests for percentDiff function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;percentDiff&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Returns percentage increase when current is greater than previous&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prev </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> cur </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;100&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prev, cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;25&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Returns percentage decrease when current is less than previous&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prev </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;100&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> cur </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prev, cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;-20&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Returns 0 when current is the same as previous&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prev </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> cur </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;80&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prev, cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;0&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Rounds to 2 decimal places&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prev </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;900&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> cur </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;1000&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// When</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prev, cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(result).to.</span><span class=\"mtk5\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;11.11&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Running the decimal util tests now will result in all of them failing because we haven't yet defined the function:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 657px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/892bf0fdcec84991ea71737850cde681/a1253/tdd-fail-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 101.67427701674276%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACiUlEQVQ4y42UaXLbMAyFfYomtbVQFmUt1L5ajqs4nU5z/xOhDyxpKx57Jj8+gSsIAo/ahFFMbT9QA2Sc0s71yfEDcjzxlN2Tvot9Gz8IqesGeptmaquGhC9ojwkmWFlh2j4ITdsSmnF2umHvARgxMIo9jTjgZOD2ZNoDOIIaa6xtzPoK1rMO+cMn8KLZTM7GES/mTSnIwAHrFGxkNrMTb5UefWXO187kwbWTsO6KLca2Zs32QQ7teh2hK0PyVUwijykIIwr28rrI4n4T7VAEeyqSlOokozA63KLkiA3ON9FX9pCntKhofr/QGSSqoB2fiFw5BneFHfMAK8QzbfdLlaG9uW5pHiaamo5ObU8T6MuajuiPoMahPdaUaUYzZFagn2O+qGqqMM96Zg1rhyFOyJG/hEEOC0yqQ0IlhF6BFH0mQUoykB+Qb0Rnr2mj01cWcJBD0PUwUoWofDj9sXPp1fE0L8b+tBZRsN2u4MhuVWa1ywOdzwst7x/UwGmGPKq8pDTLKWPQj1E0tpIjTRXFBoWrS9zmGiFfWYIJle6weVA5/ULEMzghP2fYCZs6OOthWzg+8mGw/PbZOQd0qzIrHxN8Cif2kbidlejXYw+vzKXPcPJpudDb8l82zkoiWkJYc5UOF4PnVs6/FEVXGVz6kZbjDMl0tHQ9HSGRU9MiBQXNGJtAi4PPKB6nwHvyivTPIeCHjxcjcbpEm+UTIy8slQxEUIJkQqnbMebFnWyuDlk2CgKt8IMtIVABRy93srE/D435WTzKq3bIHwknfz5+0+ffT2pQ1QYH1PwCcDVGYJNvEAbXFu7eoZYNGi1eQBknVMiIBkihBX2mdFvhiqlG6hdVIoAg2D+88j8SlDia3a/pFwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 4\"\n        title=\"tdd fail 4\"\n        src=\"/static/892bf0fdcec84991ea71737850cde681/a1253/tdd-fail-4.png\"\n        srcset=\"/static/892bf0fdcec84991ea71737850cde681/772e8/tdd-fail-4.png 200w,\n/static/892bf0fdcec84991ea71737850cde681/e17e5/tdd-fail-4.png 400w,\n/static/892bf0fdcec84991ea71737850cde681/a1253/tdd-fail-4.png 657w\"\n        sizes=\"(max-width: 657px) 100vw, 657px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Same drill as last time, first step to fix this is to define the function in the decimal util module and export it so it's visible:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/decimal-util.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> Decimal </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimal.js&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">prev</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">cur</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Implementation TBD...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  percentDiff,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>Results of running the tests again at this point should surprise no one - they all fail comparing <code>undefined</code> to the expected calculation. Just like when we started the TDD process in the calculator module, an empty function implicitly returns undefined:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 646px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3afcbbd8fbe99b8d32d408d2856d6546/27524/tdd-fail-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.40557275541795%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAACpUlEQVQ4y5WVaVLbQBCFdQ3bsvbd2jeMbSgXBEhy//t03hvNEEc4VcmPj26N2r2pe7DCOJFxPsr4cJS8rGXneJ/Yd3R7dX7L3vXFcrxA+n6UC5zO/SCRH0qEFyTQkvg3ZyQBsT6LNQxk0bNnOzI6rhxx+ACHJ3ABj+AIzmDW55Nm9ANpkAwlST3tkH8YkUZ01jJj/7dhr41TV+MtODojlklMOyybD3zpLkbKAC+M7mrj7Qp7hXFsOVEoXpWJV+cSppn4QbwY6SC2CfKPWMwgRakZSqW+3btfov8PlhdEcmg6uX57k5e3D6m7YSkBAf4K2wO5RmXIHzvIqm9aOWMWH4ZJurZXI9RWtYzQSY0ZHRC4LiupoDcIfKgaqfC7GucVoFM1NpylEpk2GPIqjKVMUhmyXLqsgCykTTIp41T6NJcCMsX7ENJZZaoyZMlpUUqGqMRBPzeYyw2yZj83GqNvzWZQh53Bvt2UGJGvL6/y9v5d5uNJPTNIguwMEbI0ktnRRtnlB4WLRD43JUS0EYdn9OGIvsx1K0/o2yP6c8HZI56HQyUnyPZQSodgOZ4zyAI9LVAZK1UOmaYP74HG5SpiO6iHMCJ87+tnpUO6sLlbso+PULWdnJ+vCt447KHaDmRubpKt7uNOc7sdhs9ddsCEcXm+PMk8zlJxHFBSi3Jz9I1jUuOMo1Oj7AqYEvernVY95NXTRrgX8eMOTW/RzxlMcDpBDjnOwYyeNbApoAewXztbVo/3H3Y4TBZ2ev1uy93d7LXZbTN3dx3yi72+f8j7j58y4KJlORFGgllQct3u3dx7c4msS+YFO6CcU9fLhD611PGhJqzeCeNzQAC2JYdjdUNDesrRctX9kaG6YJFlwo3BF1f/AqgTZJhpEsC1i7UeRvGX7MgvfnNVgAQCbZAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd fail 5\"\n        title=\"tdd fail 5\"\n        src=\"/static/3afcbbd8fbe99b8d32d408d2856d6546/27524/tdd-fail-5.png\"\n        srcset=\"/static/3afcbbd8fbe99b8d32d408d2856d6546/772e8/tdd-fail-5.png 200w,\n/static/3afcbbd8fbe99b8d32d408d2856d6546/e17e5/tdd-fail-5.png 400w,\n/static/3afcbbd8fbe99b8d32d408d2856d6546/27524/tdd-fail-5.png 646w\"\n        sizes=\"(max-width: 646px) 100vw, 646px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now we can solve this by filling in the implementation for the <code>percentDiff</code> function:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/decimal-util.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> Decimal </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;decimal.js&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">prev</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">cur</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevDec </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(prev);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> curDec </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Decimal</span><span class=\"mtk1\">(cur);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> diff </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> curDec.</span><span class=\"mtk5\">minus</span><span class=\"mtk1\">(prevDec);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> diff</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">dividedBy</span><span class=\"mtk1\">(prevDec)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk4\">100</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">toDecimalPlaces</span><span class=\"mtk1\">(</span><span class=\"mtk4\">2</span><span class=\"mtk1\">, Decimal.ROUND_HALF_UP)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk5\">toString</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  percentDiff,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>And now all the decimal util tests pass:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 617px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/713e7a2ed61a530d78bde762b025d19e/bc962/tdd-pass.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.35980551053485%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAA1ElEQVQoz51Qy3LCMAzMd9Qk8UNOHD9ShjsM/f+P2kqCMIyHXnpY21qtVpKHcXZIuSDXHVuukPg02X9jkGM/X3C7/+B6u2PdiiYm69Vc8Oktd88L1NBYB2oVbT/rtFupqO1bJ5Z3Lk0hzQpvQktivmleuMeGDSGuGMbJwXAHm1asKat4SRsjszgjckwsDAdoecX91Lry+Nx99gHEYusJ1gUt8iHCPznRHAYH+v8TbjhJgghfKertuFg6mnFWkXkTfzLo8ZgwEkzmFZb4MvyroJ+w534BnAnDmsDgE8AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd-pass\"\n        title=\"tdd-pass\"\n        src=\"/static/713e7a2ed61a530d78bde762b025d19e/bc962/tdd-pass.png\"\n        srcset=\"/static/713e7a2ed61a530d78bde762b025d19e/772e8/tdd-pass.png 200w,\n/static/713e7a2ed61a530d78bde762b025d19e/e17e5/tdd-pass.png 400w,\n/static/713e7a2ed61a530d78bde762b025d19e/bc962/tdd-pass.png 617w\"\n        sizes=\"(max-width: 617px) 100vw, 617px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now let's turn our attention back to the calculator module, recall we had changed it to use the decimal util module to clean up the percentage difference calculation.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lib/calculator.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// This module is already imported because its used in other functions in the calculator module</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> decimalUtil </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./decimal-util&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// other imports and functions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">calcYearlyDiff</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">expenseSummary</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(expenseSummary).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">year</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">yearSummary</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">parseInt</span><span class=\"mtk1\">(year, </span><span class=\"mtk4\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> intYear </span><span class=\"mtk7\">-</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">expenseSummary[prevYear]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;N/A&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// NEW: Use decimal-util module for percentage diff calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      yearSummary.percentageDiffPreviousYear.total </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(expenseSummary[prevYear].total, yearSummary.total);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">Object</span><span class=\"mtk1\">.</span><span class=\"mtk5\">entries</span><span class=\"mtk1\">(yearSummary.average.byCategory).</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(([</span><span class=\"mtk10 mtki\">curCategory</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">curAvg</span><span class=\"mtk1\">]) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> prevAvg </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> expenseSummary[prevYear].average.byCategory[curCategory];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">!</span><span class=\"mtk1\">prevAvg) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;new category&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk7\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// NEW: Use decimal-util module for percentage diff calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          yearSummary.percentageDiffPreviousYear[curCategory] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> decimalUtil.</span><span class=\"mtk5\">percentDiff</span><span class=\"mtk1\">(prevAvg, curAvg);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }); </span><span class=\"mtk3\">// for each category average within year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }); </span><span class=\"mtk3\">// for each year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> expenseSummary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>At this point the calculator tests should pass since we've finished implementing the decimal util <code>percentDiff</code> function:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 749px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f97fe6b373c9e705332595fc7d9ecb56/5bb8b/tdd-pass-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.49799732977303%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAAk0lEQVQY06WP2w7CIBBE+Q+w5bJciq0m2hij//9dI0tDvSTWBx9Oll3YGUbk/YQ8HqAtYdcbqE7/hTieZ1xvd5zmCygkdNqiN64aaOvWvsHz5z29zRghjYUvQgwLxpSR8ljPPg6FpVKI0GXBkq8CxvkKi3BtBkIRQfnFgX/DsRsc4bP/GVmmADmE6sKCW49fxb/xAOcxirTCMbJ2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tdd pass 2\"\n        title=\"tdd pass 2\"\n        src=\"/static/f97fe6b373c9e705332595fc7d9ecb56/5bb8b/tdd-pass-2.png\"\n        srcset=\"/static/f97fe6b373c9e705332595fc7d9ecb56/772e8/tdd-pass-2.png 200w,\n/static/f97fe6b373c9e705332595fc7d9ecb56/e17e5/tdd-pass-2.png 400w,\n/static/f97fe6b373c9e705332595fc7d9ecb56/5bb8b/tdd-pass-2.png 749w\"\n        sizes=\"(max-width: 749px) 100vw, 749px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>A quick note about the calculator module - since it's now delegating some of the functionality to the decimal-util module, the calculator tests function more like integration tests than unit tests because they're not isolated to just the one module. If this bothers you, you can introduce a mock to mock out the behavior of the decimal util module. I'm not a huge fan of this approach as it results in testing the implementation details rather than the actual output of the function. This is not strictly related to TDD so won't go into any more detail here, other than to say, I'm fine with having some of the tests more like integration tests. If in the future a bug gets introduced into decimal util that affects the calculator result, the calculator tests will fail which would be a good warning.</p>\n<p>One more quick note about the calculator - eagle eyed readers may have observed that the <code>calcYearlyDiff</code> function modifies its input. Normally I wouldn't do this, especially in a large application where there could be many callers of this function and modifying the input would be unexpected. But for a small side project where the input is actually running through a series of transformations and isn't used anywhere else, I decided this was fine. A future refactor could first make a deep copy of the input, and then operate only on the copy. Since the test makes assertions on the returned result, it would still be expected to pass.</p>\n<h2>Conclusion</h2>\n<p>I hope this post has given you some ideas about how to get started with TDD. The TDD approach lends itself really well to cases where the exact requirements are known. I've found this to especially be the case with calculations, validations and transformation type code. Next time you're adding a new feature to a project, if you know exactly how the new feature should behave, try to write a test for it first.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/tdd-by-example/"}}},{"node":{"id":"3a1ba4b4-52d8-52c5-a9b6-09cb99867c93","frontmatter":{"title":"Promotional interest rates and the fine print","date":"December 2020","category":"personal finance"},"excerpt":"Taking a break from programming topics to blog about personal finance today. Wanted to share an experience I had recently with one of the…","html":"<p>Taking a break from programming topics to blog about personal finance today. Wanted to share an experience I had recently with one of the banks in Canada that left me feeling deceived, even though strictly speaking, they did nothing wrong.</p>\n<h2>Background</h2>\n<p>First, a little background. If there’s one thing the Covid era has taught us, it’s the importance of having a well stocked emergency fund.  Readers familiar with basic personal finance may want to skip this section and jump ahead to “The Incident”, otherwise, read on while I explain the concept.</p>\n<p>An emergency fund is basically a pile of cash that you sock away somewhere safe but that can be accessed easily and quickly, so that you have something to fall back on should an emergency happen. For example, being able to pay for an unexpected car repair when you rely on your car to get to work, or paying to replace the hot water tank should it break down.</p>\n<p>Financial experts say you should have approximately 3 - 6 months worth of expenses saved up in an emergency fund. This can be calculated by tracking all your expenses for a few months including fixed expenses such as mortgage/rent, car payments, property taxes, utilities, cell phone/internet, etc, and variable expenses such as groceries, personal care, clothing, gas, restaurants, entertainment etc. (albeit, much less of the latter categories lately). Then take an average of your monthly expenses, multiply by either 3 or 6 and that’s how much you should have saved in an emergency fund.</p>\n<p>As an aside, if you’re looking for an app to track your expenses and make recommendations on savings and an emergency fund, check out <a href=\"https://github.com/danielabar/tidysum\">Tidysum</a>, a free, privacy-focused command line tool I wrote.</p>\n<p>I would argue that given the effects of this pandemic, a 1 year or slightly larger emergency fund is more appropriate to provide breathing room in case of a job loss where the entire industry is affected. This probably won’t be the last pandemic we face and who knows what other catastrophes may occur so better safe than sorry.</p>\n<p>Ok so we’ve established the need for an emergency fund. Next question is - where should it be located? Keeping that amount of physical cash in your home is not a good idea because it could be lost due to theft or a fire. And physical cash loses its value due to inflation (has been running ~2% in Canada), so you’re literally losing money by holding on to physical cash.</p>\n<p>On the other extreme, to get an inflation beating return, the most common option these days is the stock market, HOWEVER DO NOT PUT YOUR EMERGENCY FUND THERE! The stock market is too volatile for this purpose. Financial experts say don’t put any money in the stock market that you might need in less than 10 years.</p>\n<p>So basically that leaves savings accounts at banks. Unfortunately with interest rates being near 0 these days, it’s difficult to get much return on your cash. The best consistent rate in Canada has been 1.5% from one of the online-only banks. So you’re still losing money to inflation but its better than the big chartered banks that are paying at most 0.1% (at the time of this writing).</p>\n<h2>The Incident</h2>\n<p>Which brings me to the incident that led to writing this blog post. Given the strong need to have an emergency fund (ideally not losing money to inflation), low interest rate environment and knowing that banks pay almost nothing in interest, imagine my delight to receive this offer from one of the major banks. The email subject line was “Ready, set, save with 2.30% interest”</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 757px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ad8a7a72ea80ccd77bb39cd98116dbda/1fbe8/bank-offer-crop.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.03302509907529%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACJElEQVQ4y4VUa2/aQBDkX1dqqlbq50qR+ruqJCgUwiuAwRiD329j4+nOmgtf0uSk0XIP5mZ39jz48u0X3KOHg+vBOZw0HlwTb78d54j93hWY2MO+4iD//frjHgPPC3FuGgRBhLwokaYZ8rxEkmSIkxRZXmjsug6fDXIMTl4gJDnCMFZEcaII5DdBMkZeVtdnVHUtFxYoZM614goO3w8xOB59lWvbLqztXtN7XW2x3TlYrXfYWHvFerPDzj5g+WppPJ58BTOkqJ6QCk+BKvJFLjcZeZAxzXJVGEUJ4jhFWVbIZO1/6SshFZLA2jqqwqIaUcb5R4OkBpdLdyOkklrqwnSpVt0TR1kG4zqVte0FjZjXtq3E9o3EkL4R0plI0nkcTrBYWhiN54rn0UxrxfoQzIIXmViJQT0hboR02RNnOrk9lTYpxL2qLJFJ66RSu4so+SBniMxbNC57dEhS6apacakqiT3aokAjOOe5opELz2IK0cjc7NdZBqlbT8i6sVbaIlLHtWVjtbElzVDBHuS+4xJev+73e0zRFVN3Und2BM8qYZYV2uWJpMq2CKP405fx3j7LN+AN48lCTWAcPr/gz8MID09jTF6WmC/WmEyXeBLTHodj/JUzC2luZjSdr/p9OUeyUPpVTWHT8gPhSkqu9mWgTprBJ6cfANlvrwa8N5TwTr4QfFqL5UaflQGfH2+fUYXscc71fq1fN3E6W4niLb7//I1/r9lwWGuEQckAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bank offer\"\n        title=\"bank offer\"\n        src=\"/static/ad8a7a72ea80ccd77bb39cd98116dbda/1fbe8/bank-offer-crop.png\"\n        srcset=\"/static/ad8a7a72ea80ccd77bb39cd98116dbda/772e8/bank-offer-crop.png 200w,\n/static/ad8a7a72ea80ccd77bb39cd98116dbda/e17e5/bank-offer-crop.png 400w,\n/static/ad8a7a72ea80ccd77bb39cd98116dbda/1fbe8/bank-offer-crop.png 757w\"\n        sizes=\"(max-width: 757px) 100vw, 757px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Well this sounds just wonderful, even if it is only for a limited time (at the time I received it, it would have provided 6 months of the high interest). So naturally I called to sign up. Keep in mind this is from a large, chartered and reputable bank in Canada. Also I’d had some accounts with them in the past, already had their call centre number from having called them before, and confirmed it was the same number as shown in the promotion. So there was no concern about this being a scam.</p>\n<p>The sign up process was straightforward, my account was opened in minutes, and I was able to transfer funds from another institution where I was keeping my emergency fund previously, and only earning 1.5%, looking forward to end of the month to start seeing the 2.3% build up (with the understanding that this is an annualized rate).</p>\n<p>But when month end came and went, was very surprised to see the interest only being a tiny portion of the promised 2.3%. Figuring there must have been a mistake and the promotion hadn’t yet been applied to my account, I called them to determine the issue.</p>\n<p>And this is where things went sideways. I was told that the 2.3% is a combination of of the regular rate of 0.1% and a promotional rate of 2.2%, but that during the promotional period, only the 0.1% would be paid out monthly (and compounded). The 2.2% would only be paid out one-time, after the offer period had finished, and would be based on the average daily balance during the offer period.</p>\n<p>In other words, the 2.2% would NOT be compounded, the way every other interest rate on savings accounts (promotional or otherwise) is calculated and how my intuition had told me this would work. Suddenly this “wonderful” offer was not looking so good, in fact, it was looking more like a trick. When I pointed this out I was told that all this was explained in the terms and conditions.</p>\n<p>Luckily I kept the promotional email. It turns out the the terms and conditions are displayed in tiny font below the fold of the catchy promotional material (bank name has been blanked out as it’s not the point of this post to call out any particular institution):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 715px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/203d40fe0052aeb11134e86307633e5d/d0c0e/bank-terms-and-conditions-tiny.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.8041958041958%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABpklEQVQ4y22TabLCQAiEvf+xNO5rNO67cUm0XG6A9WF1THzvRxczwAANTOn5fFocxzafz229XttqtbLtdutSQC8cDgfbbDYObMvl0t/fbje73+9WIiDGdrtt3W7XOp1OJgF62ZC73c5Op5MHarVarhsMBna9Xr8ByVyv163RaDiq1apLHgBsoFarZT6AYPIjyePx+ATc7/c2Go1sPB5bFEUWhqEDHRgOh5ldUnbpaAWxPCA0yNbr9bx8wBn0+32/E1R3SYLSFgKez+dPha/Xy5tbqVScarPZdKc8zV+q5XLZgiBwP/wXi0Wxh1AmG1VMJhOnDRWBO1Ugp9NpdgYMlIBMOushShrLJEWJ7OioAD3gjE2T1yaQ9HK5FCmLFo+oVH1Ur4AqVZ/RIak6TdPilDHoATumpdVys/hQyy880JIX1oaR0ztAttlsVuilEskHOwk4s8MES5LkG5C10Q+hN9DkTtX5dcJOAipHypeghSnrL0MhT4uHuiN/bUB//Hg8/t9DbT508j9DtIFWDD2SgFD+85eZsFYCsDYkUkCkequE9JOhaA/fMx4eMH9UNbIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bank offer terms\"\n        title=\"bank offer terms\"\n        src=\"/static/203d40fe0052aeb11134e86307633e5d/d0c0e/bank-terms-and-conditions-tiny.png\"\n        srcset=\"/static/203d40fe0052aeb11134e86307633e5d/772e8/bank-terms-and-conditions-tiny.png 200w,\n/static/203d40fe0052aeb11134e86307633e5d/e17e5/bank-terms-and-conditions-tiny.png 400w,\n/static/203d40fe0052aeb11134e86307633e5d/d0c0e/bank-terms-and-conditions-tiny.png 715w\"\n        sizes=\"(max-width: 715px) 100vw, 715px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>And indeed, zooming way in reveals some surprising details about how the interest is calculated. I’ve plucked out the relevant portions below:</p>\n<p>“The special annual interest rate of 2.30% is a combination of promotional and regular annual interest rates…”</p>\n<p>“Promotional interest is calculated as follows:… on the portion of the applicable account’s average daily closing balance from the date the account is opened to the end of the Offer Period…”</p>\n<p>“Promotional interest will be paid in Ap‌ril 2021 into a single Eligible Savings Account”</p>\n<p>“Eligible Accounts will continue to earn regular interest, calculated on the daily closing balance and paid monthly.”</p>\n<p>Ok so technically and legally speaking, there’s nothing wrong here, the interest is being paid out exactly as per the terms. So why am I left with a bad feeling? Well the problem is how most ordinary people understand how interest on savings accounts work, based on their experiences at other banks. It’s generally understood that the posted regular or promotional rate will compound on a monthly basis. This is why people open savings account to get the “magic” of compounding, however small the interest rate may be.</p>\n<p>It is not at all intuitive that an interest rate would only get calculated one-time and not compound. This isn’t even hinted at in the main promotional material. How many people are actually going to zoom in on the tiny font in the terms and conditions to decipher that it will only be a one-time payment and not compounded? Even if you read the terms closely, it’s not obvious that it’s a one-time non-compounding payment because these words are not used. It’s like they went out of their way to not use these obvious words that might set off alarm bells in customers heads that maybe this deal isn’t as good as it sounds.</p>\n<p>I can almost imagine the marketing team (or whoever comes up with these promotions at banks) sitting around a zoom meeting coming up with this idea. Something like…</p>\n<p>“How can we get Canadians to withdraw their funds from our online-only high interest competitors and get them to come to our bank?”</p>\n<p>“I know let’s offer a slightly higher rate, maybe 1.6%”</p>\n<p>“Nah, that would increase our costs but it’s too small to get people out of their natural inertia”</p>\n<p>“How about a really high rate that they wouldn’t be able to ignore, like 2.3%?”</p>\n<p>“Yeah that would work but would affect our bottom line too much”</p>\n<p>“I’ve got an idea, how about we offer the 2.3% but don’t compound it, just make it a one-time payment at the end of the promotional period”</p>\n<p>“Would anyone go for that?”</p>\n<p>“They would if we present it like a regular interest rate, then bury the details in the tiny point font terms and conditions that no one ever reads”</p>\n<p>“Brilliant, we have a winner!”</p>\n<p>Of course that’s all just a dramatization and my possibly over-active imagination of how bank meetings go.</p>\n<h2>Conclusion</h2>\n<p>So what’s the moral of the story here? Could I have been more vigilant about reading the terms? Sure, although I’m not sure that the wording would have overridden my strong intuition about how interest works on savings accounts, based on all my past experience. Is there any legal case to be made that the bank is in the wrong here? Nope, the terms are very clear about how it works.</p>\n<p>However, people don’t make their impressions based on legalities and technicalities. My perception is that I’ve been tricked, even if legally everything is above board. That perception becomes reality, that I can no longer trust this institution and would not want to do business with them again. It’s sad that a Canadian bank would resort to a tactic like this to gain more customers. I hope other institutions won’t attempt to emulate this, and that with this post, I’ve increased some awareness of this issue.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","fields":{"slug":"/blog/emergency-fund-fine-print/"}}}]}},"pageContext":{}}}