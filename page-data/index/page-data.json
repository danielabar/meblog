{
    "componentChunkName": "component---src-pages-index-js",
    "path": "/",
    "result": {"data":{"allMarkdownRemark":{"totalCount":49,"edges":[{"node":{"id":"40da9b16-4faf-592a-b9c0-49d94a2304f9","frontmatter":{"title":"Rails Enums with MySQL or Postgres","date":"May 2022","category":"rails"},"excerpt":"This post will walk you through the steps to add an enum to a Rails model, backed by either a MySQL or Postgres database. If you're notâ€¦","html":"<p class=\"markdown-para\">This post will walk you through the steps to add an enum to a Rails model, backed by either a MySQL or Postgres database. If you're not familiar with enums, an example will be more illuminating than the official definition.</p>\n<p class=\"markdown-para\">Suppose you're building a recurring subscription service. This will need a <code>Plan</code> model that each subscription is associated with. The plan will have a column <code>recurring_interval</code> to indicate how frequently the plan renews. Specifically, the service offers yearly, monthly, weekly and daily plans. When a customer purchases a subscription, the code must calculate the renewal date based on the Plan's <code>recurring_interval</code>. Imagine some conditional logic checking the value of this column, if it's <code>year</code>, add a year to the purchase date, if it's <code>month</code>, add a month and so on.</p>\n<p class=\"markdown-para\">In this case, it's important that the <code>recurring_interval</code> only contain one of a specific list of values: <code>year</code>, <code>month</code>, <code>week</code>, or <code>day</code>. If an unexpected value such as <code>foo</code> or <code>fortnight</code> was persisted in the <code>Plans</code> table, then the code wouldn't know how to calculate the subscriptions' renewal date. This is a perfect use case for enums. On the database side, enums provide data integrity to restrict a column to one of a list of values. See the <a href=\"https://dev.mysql.com/doc/refman/5.7/en/enum.html\" class=\"markdown-link\">MySQL</a> and <a href=\"https://www.postgresql.org/docs/14/datatype-enum.html\" class=\"markdown-link\">PostgreSQL</a> docs for a more formal definition.</p>\n<p class=\"markdown-para\">I'm assuming the <code>Plan</code> table and model already exist as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20220406145959_create_plans.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">CreatePlans</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    create_table </span><span class=\"mtk4\">:plans</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |t|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.boolean </span><span class=\"mtk4\">:active</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.string </span><span class=\"mtk4\">:currency</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;USD&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.integer </span><span class=\"mtk4\">:unit_amount_cents</span><span class=\"mtk1\">, </span><span class=\"mtk4\">null:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">default:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      t.timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"database-migration\" style=\"position:relative;\"><a href=\"#database-migration\" aria-label=\"database migration permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Database Migration</h2>\n<p class=\"markdown-para\">The first step to implement an enum in your Rails project will be to generate a migration to add the column. Start from a terminal and enter the following command to generate a migration to add the <code>recurring_interval</code> column to the <code>Plans</code> table:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate migration AddRecurringIntervalToPlans</span></span></code></pre>\n<p class=\"markdown-para\">This will generate a file similar to the following:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20220407103112_add_recurring_interval_to_plans.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddRecurringIntervalToPlans</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The syntax required to use enums is not supported by the Ruby migration DSL, therefore, it requires use of <code>execute</code> to run raw SQL. We also have to explicitly define the <code>up</code> and <code>down</code> methods since Rails won't automatically know how to reverse the raw SQL in the <code>execute</code> block.</p>\n<p class=\"markdown-para\">Update the generated migration as follows for MySQL:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20220407103112_add_recurring_interval_to_plans.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># MySQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddRecurringIntervalToPlans</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;-SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">ALTER</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TABLE</span><span class=\"mtk6\"> plans ADD recurring_interval ENUM(&#39;year&#39;, &#39;month&#39;, &#39;week&#39;, &#39;day&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    remove_column </span><span class=\"mtk4\">:plans</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:recurring_interval</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The syntax for PostgreSQL is a little different as it first requires creating a custom <a href=\"https://www.postgresql.org/docs/14/sql-createtype.html\" class=\"markdown-link\">data type</a> to define the enum, and then it can be added as a column to the table. Just like with MySQL, <code>execute</code> and explicit <code>up/down</code> methods are required:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># db/migrate/20220407103112_add_recurring_interval_to_plans.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># PostgreSQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">AddRecurringIntervalToPlans</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;-SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">CREATE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TYPE</span><span class=\"mtk6\"> </span><span class=\"mtk5\">plan_recurring_interval</span><span class=\"mtk6\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk6\"> ENUM (&#39;year&#39;, &#39;month&#39;, &#39;week&#39;, &#39;day&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    add_column </span><span class=\"mtk4\">:plans</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:recurring_interval</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:plan_recurring_interval</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    remove_column </span><span class=\"mtk4\">:plans</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:recurring_interval</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;-SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">DROP</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TYPE</span><span class=\"mtk6\"> plan_recurring_interval;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIf you're using the <a href=\"https://docs.rubocop.org/rubocop-rails/\" class=\"markdown-link\">rubocop-rails</a> gem with the default settings, you may encounter a lint error <a href=\"https://docs.rubocop.org/rubocop-rails/cops_rails.html#railssquishedsqlheredocs\" class=\"markdown-link\">Rails/SquishedSQLHeredocs</a>, because the SQL heredoc is not using the squish method. In this case, you can go ahead and append \".squish\" to the SQL heredocs in the migration as suggested by the linter to. Just be aware that some PostgreSQL syntax such as comments and functions do require newlines to be preserved so you may not always want this, but that's not an issue for the simple syntax used in this migration. See the Ruby <a href=\"https://www.rubydoc.info/github/rubyworks/facets/String%3Asquish\" class=\"markdown-link\">String docs</a> for more details about the squish method.\n</aside>\n<p class=\"markdown-para\">One last thing to know before running the migration, is that you must set the <code>schema_format</code> to be <code>:sql</code> in your application config in order for the enum definition to be captured in the schema file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/application.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">config.active_record.schema_format </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:sql</span></span></span></code></pre>\n<p class=\"markdown-para\">This will generate file <code>db/structure.sql</code> instead of the default <code>db/schema.rb</code> file, which should be committed. This has to do with the use of raw SQL in the migration. The <a href=\"https://edgeguides.rubyonrails.org/active_record_migrations.html\" class=\"markdown-link\">Active Record Migrations Guide</a> has a great explanation:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\"><code>db/schema.rb</code> cannot express everything your database may support such as triggers, sequences, stored procedures, etc. While migrations may use execute to create database constructs that are not supported by the Ruby migration DSL, these constructs may not be able to be reconstituted by the schema dumper. If you are using features like these, you should set the schema format to :sql in order to get an accurate schema file that is useful to create new database instances.</p>\n</blockquote>\n<p class=\"markdown-para\">At this point, you should be able to run the migration (and optionally roll it back) with:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rails db:migrate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rails db:rollback</span></span></code></pre>\n<p class=\"markdown-para\">After running the migration, the generated <code>db/structure.sql</code> file should specify the newly added enum column for the <code>plans</code> table.</p>\n<p class=\"markdown-para\">If you're using MySQL:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- db/structure.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CREATE</span><span class=\"mtk1\"> </span><span class=\"mtk7\">TABLE</span><span class=\"mtk1\"> </span><span class=\"mtk6\">`plans`</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">-- other columns...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">`recurring_interval`</span><span class=\"mtk1\"> enum(</span><span class=\"mtk6\">&#39;year&#39;</span><span class=\"mtk1\">,</span><span class=\"mtk6\">&#39;month&#39;</span><span class=\"mtk1\">,</span><span class=\"mtk6\">&#39;week&#39;</span><span class=\"mtk1\">,</span><span class=\"mtk6\">&#39;day&#39;</span><span class=\"mtk1\">) DEFAULT </span><span class=\"mtk7\">NULL</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span></code></pre>\n<p class=\"markdown-para\">And PostgreSQL - note the <code>CREATE</code> statement to first create the custom type, and then it can be used as a table column:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- db/structure.sql</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CREATE</span><span class=\"mtk1\"> </span><span class=\"mtk7\">TYPE</span><span class=\"mtk1\"> </span><span class=\"mtk4\">public</span><span class=\"mtk1\">.</span><span class=\"mtk4\">plan_recurring_interval</span><span class=\"mtk1\"> </span><span class=\"mtk7\">AS</span><span class=\"mtk1\"> ENUM (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&#39;year&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&#39;month&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&#39;week&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&#39;day&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CREATE</span><span class=\"mtk1\"> </span><span class=\"mtk7\">TABLE</span><span class=\"mtk1\"> </span><span class=\"mtk4\">public</span><span class=\"mtk1\">.</span><span class=\"mtk4\">plans</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">-- other columns...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    recurring_interval </span><span class=\"mtk4\">public</span><span class=\"mtk1\">.</span><span class=\"mtk4\">plan_recurring_interval</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"data-integrity\" style=\"position:relative;\"><a href=\"#data-integrity\" aria-label=\"data integrity permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Data Integrity</h2>\n<p class=\"markdown-para\">Ok, now that the enum is defined in the database, let's see the effect on model creation in the Rails console. Launch a Rails console and enter the following to create a new Plan model, set a few attributes, check for validity and save to the database:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan.name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;My Test Plan&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan.recurring_interval </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;week&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan.valid? </span><span class=\"mtk3\"># =&gt; true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan.save!  </span><span class=\"mtk3\"># =&gt; plan saved successfully to database</span></span></span></code></pre>\n<p class=\"markdown-para\">So far so good, we created a new plan with an allowed <code>recurring_interval</code> of <code>week</code>, and it was successfully saved to the database. But what happens if we try to save an unknown <code>recurring_interval</code>, for example <code>fortnight</code>? Back in the Rails console, let's try this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_2.name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Another Plan&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_2.recurring_interval </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;fortnight&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_2.valid? </span><span class=\"mtk3\"># =&gt; true, hmmm... that&#39;s not right</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_2.save! </span><span class=\"mtk3\"># =&gt; error</span></span></span></code></pre>\n<p class=\"markdown-para\">This time, our experience is not so great. We intentionally set an invalid value in the <code>recurring_interval</code> property of the Plan model, ActiveRecord tells us its valid when checking the <code>plan_2.valid?</code> method, but then the transaction is rolled back when trying to save the model to the database with the following error message:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ROLLBACK</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Traceback (most recent call last):</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ActiveRecord::StatementInvalid (Mysql2::Error: Data truncated for column &#39;recurring_interval&#39; at row 1:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">INSERT INTO `plans` (`name`, `created_at`, `updated_at`, `recurring_interval`)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VALUES (&#39;Another plan&#39;, &#39;2022-04-10 12:03:11&#39;, &#39;2022-04-10 12:03:11&#39;, &#39;fortnight&#39;))</span></span></code></pre>\n<p class=\"markdown-para\">What's happening here is we've achieved data integrity at the database level with the use of the <code>enum</code> column type. However, ActiveRecord is not aware of the existence of the enum and so it's allowing a model to be created with invalid data. For complete validation, we also need <em class=\"markdown-emphasis\">application</em> level data integrity, i.e. we want ActiveRecord to tell us the model is invalid with a useful error message rather than having to catch a MySQL (or PostgreSQL) exception. This is what we'll cover in the next section.</p>\n<h2 class=\"markdown-subtitle\" id=\"model-validation\" style=\"position:relative;\"><a href=\"#model-validation\" aria-label=\"model validation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Model Validation</h2>\n<p class=\"markdown-para\">To get ActiveRecord support, the <a href=\"https://edgeapi.rubyonrails.org/classes/ActiveRecord/Enum.html\" class=\"markdown-link\">enum</a> macro (class level declaration) must be added to the model. Since we want these mapped as strings (rather than the default integer), we'll pass in a hash to map the enum attribute values to strings. Add the following to the <code>Plan</code> model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/plan.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Plan</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">year:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;year&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">month:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">week:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;week&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">day:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;day&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now let's try to create a plan in the Rails console as before, with an invalid <code>recurring_interval</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_2.name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Another Plan&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_2.recurring_interval </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;fortnight&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Traceback (most recent call last):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ArgumentError (&#39;fortnight&#39; is not a valid recurring_interval)</span></span></span></code></pre>\n<p class=\"markdown-para\">Much better, this time we get an error from ActiveRecord when trying to set an invalid value for the <code>recurring_interval</code> field. ActiveRecord can tell us this value is invalid with a useful error message, without having to try to save to the database and waiting for a SQL error.</p>\n<h2 class=\"markdown-subtitle\" id=\"enum-methods\" style=\"position:relative;\"><a href=\"#enum-methods\" aria-label=\"enum methods permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enum Methods</h2>\n<p class=\"markdown-para\">In addition to validation, the enum macro also exposes a few convenience instance methods to check and modify values. For example, given a monthly plan has been created:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;A Plan&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>plan</code> instance now has boolean methods for each possible value of the <code>recurring_interval</code> enum: <code>year?</code>, <code>month?</code>, <code>week?</code>, and <code>day?</code>. Usage is as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan.month?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan.year?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">false</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>plan</code> instance now also has bang methods to update the value of <code>recurring_interval</code>: <code>year!</code>, <code>month!</code>, <code>week!</code>, and <code>day!</code> and save to the database. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Update the monthly plan to be a weekly plan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan.week!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Plan Update (0.3ms) UPDATE `plans` SET `updated_at` = &#39;2022-04-11 11:31:38&#39;, `recurring_interval` = &#39;week&#39; WHERE `plans`.`id` = 3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan.week?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan.month?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">false</span></span></span></code></pre>\n<p class=\"markdown-para\">Note that if you call an update method when the model instance already has that value, no database update will run and the method will still return true. For example, calling <code>plan.week!</code> again will not result in an error.</p>\n<h2 class=\"markdown-subtitle\" id=\"enum-scopes\" style=\"position:relative;\"><a href=\"#enum-scopes\" aria-label=\"enum scopes permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enum Scopes</h2>\n<p class=\"markdown-para\">The enum macro also adds <a href=\"https://www.rubyguides.com/2019/10/scopes-in-ruby-on-rails/\" class=\"markdown-link\">scopes</a> to the model class, one for each possible value of the enum. So the <code>Plan</code> class will have: <code>Plan.year</code>, <code>Plan.month</code>, <code>Plan.week</code>, and <code>Plan.day</code>. This allows for easy querying, such as retrieving all the monthly plans. Note that these generated scopes, like all scopes, return an <a href=\"https://edgeapi.rubyonrails.org/classes/ActiveRecord/Relation.html\" class=\"markdown-link\">ActiveRecord::Relation</a> object.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Plan 1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plan_2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.create(</span><span class=\"mtk4\">name:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Plan 2&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">monthly_plans </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Plan</span><span class=\"mtk1\">.month</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Plan Load (0.6ms) SELECT `plans`.* FROM `plans` WHERE `plans`.`recurring_interval` = `month` LIMIT 11</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk3\">#&lt;ActiveRecord::Relation&gt; [...plans...]</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"testing\" style=\"position:relative;\"><a href=\"#testing\" aria-label=\"testing permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Testing</h2>\n<p class=\"markdown-para\">At this point, we have a fully functioning model with both database and application level validation of the <code>recurring_interval</code> value. But we're not done yet, let's add some tests to verify this feature. I'm using <a href=\"https://rspec.info/\" class=\"markdown-link\">RSpec</a> and the <a href=\"https://matchers.shoulda.io/\" class=\"markdown-link\">Shoulda Matchers</a> gem, which contains a lot of convenient matchers to express common validations in Rails.</p>\n<p class=\"markdown-para\">The test uses the <a href=\"https://github.com/thoughtbot/shoulda-matchers/blob/main/lib/shoulda/matchers/active_record/define_enum_for_matcher.rb\" class=\"markdown-link\">define enum for</a> matcher, together with the <code>with_values</code> qualifier to pass in a hash of the expected allowed values for the <code>recurring_interval</code> column. Finally, <code>backed_by_column_of_type</code> is appended to the matcher to assert that the column type is a string (rather than the default integer).</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/models/plan_spec</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">describe Plan, </span><span class=\"mtk4\">type:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:model</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&quot;validations&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      should define_enum_for(</span><span class=\"mtk4\">:recurring_interval</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .with_values(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">year:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;year&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">month:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">week:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;week&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">day:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;day&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ).backed_by_column_of_type(</span><span class=\"mtk4\">:string</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Note that if using MySQL, the test will pass with <code>.backed_by_column_of_type(:string)</code>, however, for PostgreSQL, use <code>.backed_by_column_of_type(:enum)</code>.</p>\n<aside class=\"markdown-aside\">\nFor the TDD purists in the crowd, of course you could write this test before adding the migration and enum macro to the model class, run the test, it will fail, then add the migration and update the model class, run the test again and it will pass. If you're interested in TDD, I've written about a few examples where its useful including <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/tdd-by-example/\">Adding a New Feature</a> and <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/tdd-by-example-bugfix/\">Fixing a Bug</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"add-a-new-value\" style=\"position:relative;\"><a href=\"#add-a-new-value\" aria-label=\"add a new value permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Add a New Value</h2>\n<p class=\"markdown-para\">One last consideration with enums is future maintenance. What happens if a new value needs to be supported? In our Plans case, suppose there's a new business requirement to support \"fortnight\" (every two weeks) as a valid <code>recurring_interval</code>. This can be implemented with another migration. The new value should be added to the end of the list (for MySQL):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bin/rails generate migration ModifyRecurringIntervalForPlans</span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># MySQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ModifyRecurringIntervalForPlans</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;-SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        </span><span class=\"mtk7\">ALTER</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TABLE</span><span class=\"mtk6\"> plans </span><span class=\"mtk7\">MODIFY</span><span class=\"mtk6\"> recurring_interval ENUM(&#39;year&#39;, &#39;month&#39;, &#39;week&#39;, &#39;day&#39;, &#39;fortnight&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    change_column </span><span class=\"mtk4\">:plans</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:recurring_interval</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:string</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">PostgreSQL enum's can be modified through the use of <a href=\"https://www.postgresql.org/docs/14/sql-altertype.html\" class=\"markdown-link\">ALTER TYPE</a>, which supports specifying the position of the new enum value. There is no support for removing a value, therefore the catalog tables must be used for the <code>down</code> migration:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># PostgreSQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ModifyRecurringIntervalForPlans</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActiveRecord::Migration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;-SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        </span><span class=\"mtk7\">ALTER</span><span class=\"mtk6\"> </span><span class=\"mtk7\">TYPE</span><span class=\"mtk6\"> plan_recurring_interval ADD </span><span class=\"mtk7\">VALUE</span><span class=\"mtk6\"> &#39;fortnight&#39; </span><span class=\"mtk7\">AFTER</span><span class=\"mtk6\"> &#39;day&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    execute </span><span class=\"mtk6\">&lt;&lt;-SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      </span><span class=\"mtk7\">DELETE</span><span class=\"mtk6\"> </span><span class=\"mtk7\">FROM</span><span class=\"mtk6\"> pg_enum </span><span class=\"mtk7\">WHERE</span><span class=\"mtk6\"> enumlabel </span><span class=\"mtk7\">=</span><span class=\"mtk6\"> &#39;fortnight&#39; </span><span class=\"mtk7\">AND</span><span class=\"mtk6\"> enumtypid </span><span class=\"mtk7\">=</span><span class=\"mtk6\"> (</span><span class=\"mtk7\">SELECT</span><span class=\"mtk6\"> </span><span class=\"mtk9 mtki\">oid</span><span class=\"mtk6\"> </span><span class=\"mtk7\">FROM</span><span class=\"mtk6\"> pg_type </span><span class=\"mtk7\">WHERE</span><span class=\"mtk6\"> typname </span><span class=\"mtk7\">=</span><span class=\"mtk6\"> &#39;plan_recurring_interval&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    SQL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">The model class must be modified to tell ActiveRecord that the new value should be considered valid:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/plan.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Plan</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  enum </span><span class=\"mtk4\">recurring_interval:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">year:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;year&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">month:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;month&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">week:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;week&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">day:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;day&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">fortnight:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;fortnight&quot;</span><span class=\"mtk1\">   </span><span class=\"mtk3\"># new value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">And of course, don't forget to maintain the test. This is left as an exercise for the reader!</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered working with enums on a Rails project, backed by either a MySQL or PostgreSQL database. We've learned what enums are, why they're useful, how to achieve data integrity from both the database and application via ActiveRecord support, how to test, and maintain enum values. Here's another useful <a href=\"https://sipsandbits.com/2018/04/30/using-database-native-enums-with-rails/\" class=\"markdown-link\">blog post</a> on working with enums in Rails. Finally, if you're working with PostgreSQL and would prefer to stick with <code>db/schema.rb</code>, you might like to give the <a href=\"https://github.com/bibendi/activerecord-postgres_enum\" class=\"markdown-link\">activerecord-postgres_enum</a> gem a try. It enhances the Ruby migration DSL to support PostgreSQL enum types.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-enum-mysql-postgres/"}}},{"node":{"id":"23cd9fea-857e-56a9-81ab-15c12e9656c4","frontmatter":{"title":"About Those Docs","date":"April 2022","category":"productivity"},"excerpt":"Today I want to write about engineering documentation. That is, docs that are written by engineers, for engineers that are working on theâ€¦","html":"<p class=\"markdown-para\">Today I want to write about engineering documentation. That is, docs that are written by engineers, for engineers that are working on the same project. It's known that despite the many benefits of having good project documentation, engineers generally dislike writing it. This means useful docs tend to be lacking on projects. Before we get into how to rectify this, let's first discuss what <em class=\"markdown-emphasis\">not</em> to do.</p>\n<h2 class=\"markdown-subtitle\" id=\"what-not-to-do\" style=\"position:relative;\"><a href=\"#what-not-to-do\" aria-label=\"what not to do permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What Not To Do</h2>\n<p class=\"markdown-para\">For the process-minded, it's tempting to think that the lack-of-documentation problem can be solved with process. For example:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Create an engineering documentation template on the internal wiki with sections such as title, high level description, technical details, etc.</li>\n<li class=\"markdown-list-item\">Amend the Pull Request template for the project to include a checkbox for \"Added Documentation\".</li>\n<li class=\"markdown-list-item\">Inform the team that no PR will be approved unless it also has documentation added, as per the template.</li>\n</ul>\n<p class=\"markdown-para\">Don't do this! Why not? There are several problems with this:</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"force-doesnt-work\" style=\"position:relative;\"><a href=\"#force-doesnt-work\" aria-label=\"force doesnt work permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Force Doesn't Work</h3>\n<p class=\"markdown-para\">Forcing engineers to do anything without them having bought into the benefits is unlikely to yield good results. If you don't believe this, try forcing a team to write automated tests when they don't understand why or how these tests will benefit the project. The result will be useless tests that either fail when nothing is broken or don't fail when something is broken. If you've never worked on a project with such tests, count yourself lucky!</p>\n<p class=\"markdown-para\">Similarly, forcing documentation via process will result in useless paperwork. A template people fill in with the bare minimum, just because they were told they have to. It can also lead to poor team dynamics when people feel they are being forced to do something they wouldn't otherwise want to do.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"templates-dont-work\" style=\"position:relative;\"><a href=\"#templates-dont-work\" aria-label=\"templates dont work permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Templates Don't Work</h3>\n<p class=\"markdown-para\">There's also a problem with the prescribed template approach. It doesn't work for the same reason that prescribing coding solutions wouldn't work. For example, consider a coding template that instructs every developer for every feature they work on to:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Generate a migration for a new table.</li>\n<li class=\"markdown-list-item\">Add a new model.</li>\n<li class=\"markdown-list-item\">Add a new controller to implement all CRUD methods on the model.</li>\n<li class=\"markdown-list-item\">Add new views for CRUD operations on model.</li>\n</ul>\n<p class=\"markdown-para\">Well this may make sense when a new model is being added, but what if the best solution would be to enhance an existing model? Or what if the code change has nothing to do with models? It quickly becomes apparent that a general template solution for code doesn't make sense.</p>\n<p class=\"markdown-para\">The same can be said of documentation. It may not always be the case that a new doc needs to be added. Maybe an existing doc needs more details added or changed.  Maybe an existing doc needs to be removed because it's no longer applicable. Or maybe it's an \"obvious\" change that follows the conventions of the framework being used for development and doesn't require any docs at all. Maybe its a simple bug fix that is adequately explained by thorough unit tests with good descriptions.</p>\n<p class=\"markdown-para\">The kind and amount of documentation that will be needed (or not) for any given code change will vary depending on what is being changed. This is why a templated documentation solution is not recommended.</p>\n<p class=\"markdown-para\">Now that we know what not to do, what should be done instead to ensure useful engineering docs are written and maintained as the project progresses? Unfortunately there is no \"easy button\" on this.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d05486a0bed8555c1e344b80dd6763d4/41099/not-easy-documentation.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQDBQH/xAAXAQADAQAAAAAAAAAAAAAAAAAAAwQB/9oADAMBAAIQAxAAAAHoTeRrq76UybfIMsAf/8QAHBAAAwABBQAAAAAAAAAAAAAAAQIDEQASEzEy/9oACAEBAAEFAqsxO7DSpyJVDrszmQrqCRNcr5//xAAaEQABBQEAAAAAAAAAAAAAAAASAAECEDEh/9oACAEDAQE/AYgOp95f/8QAFhEBAQEAAAAAAAAAAAAAAAAAEQEg/9oACAECAQE/AauP/8QAGRAAAwEBAQAAAAAAAAAAAAAAAAEhERAz/9oACAEBAAY/Ao8R6M0nIU1Ln//EABsQAQEBAAIDAAAAAAAAAAAAAAERADFRIWFx/9oACAEBAAE/IVRNZe8SSlmAeLw4avl2YsZPuhMRRcGCPrGDf//aAAwDAQACAAMAAAAQcAAA/8QAGBEBAQADAAAAAAAAAAAAAAAAEQEAEEH/2gAIAQMBAT8QaGJhXG//xAAZEQABBQAAAAAAAAAAAAAAAAAAARAhMVH/2gAIAQIBAT8QxCVL/wD/xAAcEAEBAAIDAQEAAAAAAAAAAAABEQAhMUFRYXH/2gAIAQEAAT8Q3puhitXfRswlwKIknqcTGFOF8TKPlVrN+5MbSzaZXibr+4vF2jn3YQ3gBOAz/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not easy documentation\"\n        title=\"not easy documentation\"\n        src=\"/static/d05486a0bed8555c1e344b80dd6763d4/41099/not-easy-documentation.jpg\"\n        srcset=\"/static/d05486a0bed8555c1e344b80dd6763d4/e07e9/not-easy-documentation.jpg 200w,\n/static/d05486a0bed8555c1e344b80dd6763d4/066f9/not-easy-documentation.jpg 400w,\n/static/d05486a0bed8555c1e344b80dd6763d4/41099/not-easy-documentation.jpg 500w\"\n        sizes=\"(max-width: 500px) 100vw, 500px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p class=\"markdown-para\">Good docs are part art, part science, and require some practice for everyone to get in the habit. Let's look at some things that can help.</p>\n<h2 class=\"markdown-subtitle\" id=\"frame-of-mind\" style=\"position:relative;\"><a href=\"#frame-of-mind\" aria-label=\"frame of mind permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Frame of Mind</h2>\n<p class=\"markdown-para\">The first thing to do is get into the right frame of mind for writing. What do I mean by this?</p>\n<p class=\"markdown-para\">Engineers: Think about a time when you joined an existing project. Were you able to get the project built and running on your laptop by following the <code>README.md</code> or did you have to reach out to a team member for help?</p>\n<p class=\"markdown-para\">What if you had to change some details of a third party integration or deploy to the test environment? Were you able to find where the relevant code is, how to configure it for test vs real environments and deploy or did you have to reach out to a team member for help? What if the only person on the team that knew how that particular integration works was on vacation? How frustrating was it to have your assigned tasks take longer than expected due to knowledge in one person's head that's inaccessible to the rest of the team?</p>\n<p class=\"markdown-para\">Or maybe you're the person that's been on the team longest and all the knowledge is in your head. Does your manager get a pained look when you ask to take a long vacation? Do they ask if you're planning to check your Slack notifications periodically? Would you like to take a long vacation without receiving panicky phone calls from your team about the something-or-other feature you worked on having issues in production?</p>\n<p class=\"markdown-para\">If you're the only one on the team that knows how most features work or how the app is configured or how the build pipeline works, how many interruptions do you get in a day from colleagues asking you about details that are only in your head? Wondering why you can never seem to focus? Research shows that every interruption slows you down by about <a href=\"https://medium.com/thrive-global/this-is-how-interruptions-kill-your-productivity-bb89c86a4eb8\" class=\"markdown-link\">20 minutes</a> to get back on track with your original task. The more knowledge that only you know, the more hits your productivity will take.</p>\n<p class=\"markdown-para\">Thinking about the scenarios described above will put you in a good frame of mind for writing documentation, that is to say, empathy for future team members and yourself. The general idea is you want to write yourself off the critical path. Never be the only one on a team that knows how something works or where some important configuration is located. Whenever someone comes to you with a question about the project that they couldn't find anywhere else, that's an opportunity to add some documentation about that feature or process.</p>\n<p class=\"markdown-para\">Another way to think about it is to imagine you're the new person on this project - write the docs that would help \"new you\" get up to speed quickly. This will also help \"future you\" who may forget 6 months down the line how something you built works.</p>\n<aside class=\"markdown-aside\">\nA personal benefit of documenting your knowledge is it makes it easier to move off the project and onto something new. Managers may be hesitant to move someone if they feel the project would suffer from loss of that person's expertise.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"what-to-document\" style=\"position:relative;\"><a href=\"#what-to-document\" aria-label=\"what to document permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What to Document</h2>\n<p class=\"markdown-para\">Now that we're in the right frame of mind to write, what should get documented? Below are some general principles, and then we'll get into specifics.</p>\n<p class=\"markdown-para\">As a general rule, document the non-obvious things. For example, for a Rails project following all the conventions, there's no need to document where the router is located, or where the models, views and controllers should go. Rails developers will already know this, and newbies can read the <a href=\"https://guides.rubyonrails.org/getting_started.html\" class=\"markdown-link\">Rails Guides</a> to learn the conventions.</p>\n<aside class=\"markdown-aside\">\nThis is one of the many benefits of choosing a well structured, convention based framework for your project. It reduces the amount of documentation you have to write as every project will have the same structure and any developer familiar with the framework will be able to dive in quickly.\n</aside>\n<p class=\"markdown-para\">On the other hand, if the project is written in an \"anything goes\" style framework, or not following conventions, or for example, using a library that <a href=\"https://www.dictionary.com/browse/automagically\" class=\"markdown-link\">automagically</a> generates an API such as <a href=\"https://jsonapi-resources.com/v0.10/guide/index.html\" class=\"markdown-link\">json-resources</a>, then this should be documented.</p>\n<p class=\"markdown-para\">Also document anything where questions or misunderstandings frequently arise. For example, if there are multiple sources for configuration information but everyone tends to assume it can only come from environment variables, document this.</p>\n<p class=\"markdown-para\">Now let's get into some specific documents that should be in the project.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"architecture-decision-records\" style=\"position:relative;\"><a href=\"#architecture-decision-records\" aria-label=\"architecture decision records permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture Decision Records</h3>\n<p class=\"markdown-para\">Write up an <a href=\"https://adr.github.io/\" class=\"markdown-link\">ADR</a> for proposed architectural changes to the project. This is a markdown document that gets created in a <code>/decisions</code> directory in the project. Here are some suggested <a href=\"https://github.com/joelparkerhenderson/architecture-decision-record\" class=\"markdown-link\">templates</a> but feel free to add or remove sections as appropriate to the change being proposed.</p>\n<p class=\"markdown-para\">In the early days of a project, there will be many architectural decisions to be made such as choice of server side framework, client side framework, database, background job processing, monolith vs microservices etc. For example, if you would like to propose that the project should use Rails 7, and eschew any JavaScript SPA in favor of <a href=\"https://turbo.hotwired.dev/\" class=\"markdown-link\">Turbo, Stimulus, and Hotwire</a>, you would write an ADR explaining why you think that would be optimal for the project, technical details, and potential drawbacks.</p>\n<p class=\"markdown-para\">This document gets submitted as a Pull Request, which the rest of the team can review and provide their feedback. For example, someone may be aware of a specific business requirement that wouldn't be well served by the proposed solution, it's important to capture that information. When all the feedback has been addressed and team is in agreement, the PR gets merged, which means its been approved, and the project proceeds with that decision.</p>\n<aside class=\"markdown-aside\">\nFor new developers joining the project, it's not necessary for them to pore over all the historical ADRs. However, it is useful anytime someone asks \"Why was technology X used for this project? Technology Y is superior to X!\". Anyone wanting to know why certain decisions were made can read the relevant ADR(s) to understand the context in which the team was working at the time.\n</aside>\n<p class=\"markdown-para\">Use ADRs for large, high impact decisions that are difficult to change later. Don't use this for smaller decisions like what to name a method or what the max method length lint rule should be.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"readmemd-project-setup\" style=\"position:relative;\"><a href=\"#readmemd-project-setup\" aria-label=\"readmemd project setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Readme.md Project Setup</h3>\n<p class=\"markdown-para\">The <code>README.md</code> is a markdown file located in the project root. The main purpose is to ensure a new engineer can follow the setup instructions within the readme to get the project checked out, built and successfully running, without getting on a call with anyone else on the team. This is especially critical in fully distributed or <a href=\"../working-towards-asynchronous-future\" class=\"markdown-link\">asynchronous</a> teams where people may be working non-overlapping hours.</p>\n<p class=\"markdown-para\">Here are some sections the readme should contain:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">High level overview/description of project</li>\n<li class=\"markdown-list-item\">Architecture diagram</li>\n<li class=\"markdown-list-item\">Required dependencies (eg: Docker, language version, version manager etc.)</li>\n<li class=\"markdown-list-item\">Step by step instructions to install, configure, build, and run project on laptop</li>\n<li class=\"markdown-list-item\">Instructions for how to run all the tests</li>\n<li class=\"markdown-list-item\">\n<p class=\"markdown-para\">Links to \"Further Reading\" (each should be a markdown file in the <code>/docs</code> dir), for example, but not limited to:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Troubleshooting</li>\n<li class=\"markdown-list-item\">Workflows</li>\n<li class=\"markdown-list-item\">3rd party integrations (one doc for each)</li>\n<li class=\"markdown-list-item\">Configuration</li>\n<li class=\"markdown-list-item\">Continuous Integration</li>\n<li class=\"markdown-list-item\">Environments</li>\n</ul>\n</li>\n</ul>\n<p class=\"markdown-para\">Let's look at the \"Further Reading\" docs in turn.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"troubleshooting\" style=\"position:relative;\"><a href=\"#troubleshooting\" aria-label=\"troubleshooting permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Troubleshooting</h3>\n<p class=\"markdown-para\">This should include errors that may be encountered when setting up the project and how to resolve them. A common source of these issues is different laptop OS, i.e. Mac vs Windows vs Linux.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"workflows\" style=\"position:relative;\"><a href=\"#workflows\" aria-label=\"workflows permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Workflows</h3>\n<p class=\"markdown-para\">Given that a new developer has the project running on their laptop, this document should explain how to go through the most common workflows in the application. An example for an e-commerce application might include login as a test user, search for a product, and purchase it with a test credit card.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"3rd-party-integrations\" style=\"position:relative;\"><a href=\"#3rd-party-integrations\" aria-label=\"3rd party integrations permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3rd Party Integrations</h3>\n<p class=\"markdown-para\">For each service that the project integrates with (eg: Braintree, Stripe, Mandrill, etc.) add a document explaining:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">What the service does and why the project is using it.</li>\n<li class=\"markdown-list-item\">Differences in local vs deployed use (eg: is there a fake version of it for local use? How to update laptop config to use a real version, does the service provide a sandbox vs production mode?).</li>\n<li class=\"markdown-list-item\">Where/how it's configured.</li>\n<li class=\"markdown-list-item\">How to get an account/credentials to the service.</li>\n<li class=\"markdown-list-item\">Does the service use webhooks? If yes, document the project endpoints that receive these.</li>\n<li class=\"markdown-list-item\">Link to the docs for the client library that's being used to communicate with the service.</li>\n<li class=\"markdown-list-item\">Troubleshooting - for example, is all communication with the service logged somewhere?</li>\n</ul>\n<h3 class=\"markdown-sub-subtitle\" id=\"configuration\" style=\"position:relative;\"><a href=\"#configuration\" aria-label=\"configuration permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configuration</h3>\n<p class=\"markdown-para\">This document should explain where and how the project is configured. For example, where is the database host/name/port/password? Where is the Redis URL? Where are all the 3rd party API keys?</p>\n<p class=\"markdown-para\">Typically the source of this config will vary when the project is run locally on developers laptop vs in a deployed environment. For example, on a laptop there may be a git ignored <code>.env</code> file the developer needs to create, whereas on deployed environments, configuration may come from a secrets manager such as <a href=\"https://www.hashicorp.com/products/vault\" class=\"markdown-link\">Vault</a>. If there are secret values that cannot be committed, then document how/where the developer can find local values.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"continuous-integration\" style=\"position:relative;\"><a href=\"#continuous-integration\" aria-label=\"continuous integration permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continuous Integration</h3>\n<p class=\"markdown-para\">This document should explain where and how continuous integration (CI) is being run for the project, for example:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">What tooling/services are being used for continuous integration? (Github Actions, Circle CI, Travis CI, Jenkins, etc.)</li>\n<li class=\"markdown-list-item\">Where is the CI script(s) located in project?</li>\n<li class=\"markdown-list-item\">Where are notifications sent in the event of a CI failure? (eg: email, Slack)</li>\n<li class=\"markdown-list-item\">How to troubleshoot if a commit results in a CI failure?</li>\n</ul>\n<h3 class=\"markdown-sub-subtitle\" id=\"environments\" style=\"position:relative;\"><a href=\"#environments\" aria-label=\"environments permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Environments</h3>\n<p class=\"markdown-para\">This document should cover:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">What are all the deployed environments (eg. dev, staging, production) and where to find them, how to get credentials to ssh into the server, where are the log files, etc.</li>\n<li class=\"markdown-list-item\">How to deploy branch code to each environment (if supported).</li>\n<li class=\"markdown-list-item\">How to access server logs.</li>\n<li class=\"markdown-list-item\">How to monitor deployments.</li>\n<li class=\"markdown-list-item\">How to access/query database(s) in each environment.</li>\n</ul>\n<h2 class=\"markdown-subtitle\" id=\"code-comments\" style=\"position:relative;\"><a href=\"#code-comments\" aria-label=\"code comments permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Comments</h2>\n<p class=\"markdown-para\">So far, we've covered what kind of documents to write. But there are a few other ways that important project information can be conveyed from within the code itself. The first of these is code comments.</p>\n<p class=\"markdown-para\">This one can be controversial. If you've read <a href=\"https://www.oreilly.com/library/view/clean-code-a/9780136083238/\" class=\"markdown-link\">Clean Code</a>, then you know the recommendation is to think carefully about naming things (variables, methods, classes etc), and to structure your code into smaller, single-purpose methods so that the intention is clear from the names and structure. The idea is this eliminates the need for code comments.</p>\n<p class=\"markdown-para\">However, there's still a place for code comments, and this has to do with the <em class=\"markdown-emphasis\">why</em> rather than <em class=\"markdown-emphasis\">what</em>. For example, suppose some section of code is storing the same information in two different places. It may be obvious from reading it that's what its doing. But the natural question an engineer will have when reading that code is <em class=\"markdown-emphasis\">why</em> is this necessary? Perhaps the answer has to do with compliance requirements for the industry this project is involved in. Adding in the why as a code comment will be helpful, and prevent future developers from shooting themselves in the foot.</p>\n<p class=\"markdown-para\">When doing this, follow the documentation conventions for the programming language the project is written in, and add the comment at the method or class level rather than inline, where it can get messy as the code is refactored.</p>\n<h2 class=\"markdown-subtitle\" id=\"automated-tests\" style=\"position:relative;\"><a href=\"#automated-tests\" aria-label=\"automated tests permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Automated Tests</h2>\n<p class=\"markdown-para\">Another way that documentation can be written is through the use of automated tests.</p>\n<p class=\"markdown-para\">When well named and described, automated tests can also serve as a form of documentation, although they don't take the place of everything mentioned in this document.</p>\n<p class=\"markdown-para\">For example, there may be a business rule where a statuses received from a 3rd party integration get converted to different statuses within the project. Given that there's a method that is solely responsible for this conversion, unit tests to cover each status translation with meaningful descriptions can document this requirement adequately.</p>\n<h2 class=\"markdown-subtitle\" id=\"less-suck\" style=\"position:relative;\"><a href=\"#less-suck\" aria-label=\"less suck permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Less Suck</h2>\n<p class=\"markdown-para\">Now that you know the benefits of documentation and what to document, how can we make it less sucky to create?</p>\n<p class=\"markdown-para\">My recommendation is that all documentation written by engineers for engineers should be written in markdown and located with the project source. Specifically, a <code>README.md</code> in the project root, and all other docs in a <code>/docs</code> directory, with links from the <code>Further Reading</code> section of the readme, to each doc.</p>\n<p class=\"markdown-para\">The reason for having all engineering docs with the code, rather than an external tool such as Confluence, is that the docs participate in the same lifecyle as the code. That is, they get included in PR reviews, which raises their visibility among the team. This also makes it more natural to maintain them, as the developer doesn't need to remember to login to some external tool after the PR is merged to add docs. Also, the docs become easily searchable along with the code, making them easier to maintain. In my experience, docs located outside the source get forgotten and stale.</p>\n<p class=\"markdown-para\">The reason for using markdown is it's a lightweight, developer-friendly text format. Just about every IDE and editor as a plugin for it. The <a href=\"https://marketplace.visualstudio.com/items?itemName=yzhang.markdown-all-in-one&#x26;ssr=false#review-details\" class=\"markdown-link\">Markdown All in One</a> for VS Code comes with syntax highlighting and snippets, which makes editing easy and efficient.</p>\n<p class=\"markdown-para\">For example, suppose you just finished adding Stripe integration into a project and are now adding a document explaining how it's integrated into the project. Using VS Code the process would be:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Hotkey to open the integrated terminal (for me it's <kbd class=\"markdown-kbd\">Ctrl</kbd> + <kbd class=\"markdown-kbd\">`</kbd> )</li>\n<li class=\"markdown-list-item\">Enter in terminal: <code>touch docs/working-with-stripe.md</code>.</li>\n<li class=\"markdown-list-item\">Hotkey to launch fuzzy file search (for me it's <kbd class=\"markdown-kbd\">Cmd</kbd> + <kbd class=\"markdown-kbd\">P</kbd> ).</li>\n<li class=\"markdown-list-item\">Start typing <code>working</code> or <code>stripe</code> until the new markdown file is selected and hit <kbd class=\"markdown-kbd\">Enter</kbd>.</li>\n<li class=\"markdown-list-item\">Start typing information about working with Stripe in the doc.</li>\n<li class=\"markdown-list-item\">Edit <code>README.md</code>, under the \"Further Reading\" section, add a link to your new doc, for example: <code>[Working with Stripe](docs/working-with-stripe.md)</code>.</li>\n<li class=\"markdown-list-item\">Follow your usual git process to add/commit.</li>\n</ul>\n<p class=\"markdown-para\">Never even had to leave the editor, beautiful! The above makes creating/maintaining docs follow the same flow developers are already used to for code.</p>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This document has covered avoiding a process-based prescription for documentation, how to put yourself in the right frame of mind for writing, what areas of a project should be documented, and recommendations to make it as easy and natural as possible. But don't limit yourself to just the suggested areas covered here. As your project grows, you will discover other areas that require documentation, add them as you go.</p>\n<p class=\"markdown-para\">Finally, I'd like to leave you with a few more references. Having good documentation also supports asynchronous work. When all information is \"self serve\", it eliminates the need for the entire team to be <a href=\"https://danielabaron.me/blog/working-towards-asynchronous-future/\" class=\"markdown-link\">online at the same time</a>, which can greatly improve quality of life. Also, here is another <a href=\"https://chelseatroy.com/2021/09/14/the-art-of-documentation/\" class=\"markdown-link\">take</a> on the topic of documentation, which among other things, takes a closer look at the value of code comments.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","fields":{"slug":"/blog/about-those-docs/"}}},{"node":{"id":"4d925f9d-dbf8-54d9-a7d8-139976793723","frontmatter":{"title":"Use Ruby to Parse Command Line Output","date":"March 2022","category":"ruby"},"excerpt":"This post will show you how to chain together multiple Ruby one-liners to parse command line output from system commands, and executeâ€¦","html":"<p class=\"markdown-para\">This post will show you how to chain together multiple Ruby one-liners to parse command line output from system commands, and execute further system commands using the output from the previous command. Why would you want to do this? Consider the following scenario.</p>\n<p class=\"markdown-para\">Our team is using <a href=\"../nomad-tips-and-tricks\" class=\"markdown-link\">Nomad</a> to deploy a Rails application which runs with multiple instances of Puma and a Sidekiq server for background jobs. Each of these runs in Docker containers, all orchestrated by Nomad. We frequently need to run a shell in one of the containers to perform some troubleshooting. This requires running two commands.</p>\n<p class=\"markdown-para\">The first command gets the status of the Nomad job that runs Puma and Sidekiq. This command displays a list of allocations, which can be used to get at the Docker containers running the multiple instances of Puma and Sidekiq. Then a second command is needed to run a shell in a container, which requires the allocation ID of the container to run in. It looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">### FIRST COMMAND ###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Get status of job `myapp` which runs Puma and Sidekiq</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">$ nomad job status myapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Output of the status command</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Name          = myapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Type          = service</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Status        = running</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Allocations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ID        Node ID   Task Group  Version  Desired  Status   Created    Modified</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1afe229e  3008ce71  puma        123      run      running  2d20h ago  2d20h ago</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ff39a003  3008ce71  puma        123      run      running  2d20h ago  2d20h ago</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">9bd5fa5d  5163a6cb  puma        123      run      running  2d20h ago  2d20h ago</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">e5353169  3008ce71  sidekiq     123      run      running  2d20h ago  2d20h ago</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">### SECOND COMMAND ###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run a shell in the sidekiq container, given Allocation ID from the previous command</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">$ nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task sidekiq e5353169  /bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Now we&#39;re in the sidekiq container</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">root@d60b9bcf4827:/myapp#</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"the-problem\" style=\"position:relative;\"><a href=\"#the-problem\" aria-label=\"the problem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Problem</h2>\n<p class=\"markdown-para\">Not only does this require two commands, but it also requires visually scanning the output of the status command to find the Allocation ID of the sidekiq container, then copying it to paste into the second command to run a shell in this container.  If this was required only once in a while, it would be fine to leave as is. But this is a task everyone on our team has to do frequently, and the manual effort was getting tedious. Since we're a Ruby shop, it was a natural fit to use Ruby to help with automating this.</p>\n<h2 class=\"markdown-subtitle\" id=\"script-solution\" style=\"position:relative;\"><a href=\"#script-solution\" aria-label=\"script solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Script Solution</h2>\n<p class=\"markdown-para\">Here is the script that allows the above workflow to be completed in one step, with no copy/pasting. It's placed in the <code>script</code> directory in the project root. Don't worry if it seems hard to understand, all will be explained.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># USAGE: ./script/run-nomad-shell.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Parse sidekiq allocation ID from status output, storing it in $id variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">id=</span><span class=\"mtk6\">$(echo $(ruby -e &quot;</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\">nomad status myapp</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\"> =~ /^(\\w+)\\s+\\w+\\s+sidekiq.*/&quot; -e &quot;puts </span><span class=\"mtk4\">\\$</span><span class=\"mtk6\">1&quot;))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run a shell in sidekiq allocation parsed from previous step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task sidekiq $id /bin/bash</span></span></span></code></pre>\n<p class=\"markdown-para\">The first line uses a chain of ruby one-liners to execute the <code>nomad status</code> command, and parse it with regex to capture the sidekiq container allocation ID. The result of the regex capture group gets stored in a script variable <code>id</code>. This variable is then used in the second command to run a shell in the container.</p>\n<p class=\"markdown-para\">The second command is fairly straightforward, but the first command looks a little hairy, let's break it down.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"ruby-one-liners\" style=\"position:relative;\"><a href=\"#ruby-one-liners\" aria-label=\"ruby one liners permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ruby One Liners</h3>\n<p class=\"markdown-para\">First thing you might notice in this line from the script is that ruby is being executed, but with a <code>-e</code> flag:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">id=</span><span class=\"mtk6\">$(echo $(ruby -e &quot;</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\">nomad status myapp</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\"> =~ /^(\\w+)\\s+\\w+\\s+sidekiq.*/&quot; -e &quot;puts </span><span class=\"mtk4\">\\$</span><span class=\"mtk6\">1&quot;))</span></span></span></code></pre>\n<p class=\"markdown-para\">Normally when running a Ruby program, the file name containing the source code is passed to the <code>ruby</code> command line:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ruby my_program.rb</span></span></code></pre>\n<p class=\"markdown-para\">However, for short programs (aka one liners), the <code>-e</code> flag can be used to pass some code directly as an argument:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ruby -e &quot;puts &#39;One Liner!&#39;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Outputs: One Liner!</span></span></code></pre>\n<p class=\"markdown-para\">Further reading on Ruby <a href=\"https://learnbyexample.github.io/learn_ruby_oneliners/one-liner-introduction.html\" class=\"markdown-link\">one liners</a>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"system-commands\" style=\"position:relative;\"><a href=\"#system-commands\" aria-label=\"system commands permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>System Commands</h3>\n<p class=\"markdown-para\">Another thing to notice in this line from the script is the use of backticks surrounding <code>nomad status myapp</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">id=</span><span class=\"mtk6\">$(echo $(ruby -e &quot;</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\">nomad status myapp</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\"> =~ /^(\\w+)\\s+\\w+\\s+sidekiq.*/&quot; -e &quot;puts </span><span class=\"mtk4\">\\$</span><span class=\"mtk6\">1&quot;))</span></span></span></code></pre>\n<p class=\"markdown-para\">Backticks are used in Ruby to run system commands. For example, the <code>date</code> command in *nix displays the system date and time:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">$ date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Outputs something like: Mon 21 Feb 2022 10:51:36 EST</span></span></span></code></pre>\n<p class=\"markdown-para\">This can also be run within a Ruby program, to try it out, launch an IRB console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">`date`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;Mon 21 Feb 2022 10:53:56 EST</span><span class=\"mtk4\">\\n</span><span class=\"mtk6\">&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Notice the output of the system command is a string ending with the newline character <code>\\n</code>.</p>\n<p class=\"markdown-para\">This technique can also be used in a one-liner with the <code>-e</code> flag, but in this case, the backticks must be escaped, otherwise it will result in a syntax error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ruby -e &quot;\\`date\\`&quot;</span></span></code></pre>\n<p class=\"markdown-para\">Unlike when running in IRB, there is no output from the above. This is because the Ruby code passed via the <code>-e</code> flag is not running any command that would output something to the console like <code>puts</code>. If you wanted to see the output of the system <code>date</code> command returned to the console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ruby -e &quot;puts \\`date\\`&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Outputs something like: Mon 21 Feb 2022 11:09:13 EST</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"regex\" style=\"position:relative;\"><a href=\"#regex\" aria-label=\"regex permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Regex</h3>\n<p class=\"markdown-para\">Next we're going to focus on what the first Ruby one liner is executing in the script:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">id=</span><span class=\"mtk6\">$(echo $(ruby -e &quot;</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\">nomad status myapp</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\"> =~ /^(\\w+)\\s+\\w+\\s+sidekiq.*/&quot; -e &quot;puts </span><span class=\"mtk4\">\\$</span><span class=\"mtk6\">1&quot;))</span></span></span></code></pre>\n<p class=\"markdown-para\">In the previous step, we learned that surrounding a system command with escaped backticks will run that command and return the string output of that command. In the case of the <code>nomad status myapp</code> command, this will be a multi-line string containing all of the job information and list of allocations.</p>\n<p class=\"markdown-para\">The next part of the command is the <code>=~</code> operator. This is the pattern matching operator in Ruby. It takes a string and a regular expression, and returns the index of the first occurrence where the regular expression matches in the string, or <code>nil</code> if there is no match. In Ruby, a regular expression can be denoted with forward slashes. So the general form of the <code>=~</code> operator is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_string </span><span class=\"mtk7\">=~</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/some_regex/</span></span></span></code></pre>\n<p class=\"markdown-para\">Let's look at a simple example. Suppose <code>some_string</code> contains just a single line from the <code>nomad status myapp</code> command, the line that lists the sidekiq allocation ID. Run the following from an IRB console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_string </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;d5353168  2008ce70  sidekiq     191      run      running  2d20h ago  2d20h ago&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_string </span><span class=\"mtk7\">=~</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/sidekiq/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">20</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># 20 is the index of the first occurrence of the match `sidekiq` in some_string</span></span></span></code></pre>\n<p class=\"markdown-para\">Ultimately, we want to be able to extract the value of the allocation ID, which is the first sequence of letters and numbers in this string. The first thing to understand is that we can also match on <a href=\"https://www.regular-expressions.info/shorthand.html\" class=\"markdown-link\">Shorthand Character Classes</a>.</p>\n<p class=\"markdown-para\">For example, the <code>\\w</code> shorthand will match on any letter, number or underscore. The <code>\\s</code> shorthand will match on any whitespace including tabs, space character and newlines.</p>\n<p class=\"markdown-para\">Continuing in the IRB console with the previous example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_string </span><span class=\"mtk7\">=~</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/</span><span class=\"mtk4\">\\w</span><span class=\"mtk6\">/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># some_string starts with a `d` which is a letter so first match is 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_string </span><span class=\"mtk7\">=~</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/</span><span class=\"mtk4\">\\s</span><span class=\"mtk6\">/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># first occurrence of a space character in some_string is at position 8</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"capture-group\" style=\"position:relative;\"><a href=\"#capture-group\" aria-label=\"capture group permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Capture Group</h3>\n<p class=\"markdown-para\">To extract a particular value from a string, we need to use a capture group. The syntax is to enclose the \"captured\" portion of the regex in parenthesis. The captured value is then available in a special variable <code>$1</code> (if there are multiple capture groups within a regex, then second value is available in special variable <code>$2</code> etc.). For example, to capture the first letter or number from our example string:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_string </span><span class=\"mtk7\">=~</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/(</span><span class=\"mtk4\">\\w</span><span class=\"mtk6\">)/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">$1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;d&quot;</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nRetrieving the result of a capture group using the $1, $2 etc. special variables is fine for simple one-liners as in this example. However, if your program is more complicated, it's recommended to use the match method instead of the =~ operator, and use the resulting <a class=\"markdown-link\" href=\"https://rubyapi.org/3.1/o/matchdata\">MatchData</a> object that is returned.\n</aside>\n<p class=\"markdown-para\">To capture the first \"chunk\" of letters and numbers, up until a non letter/number character is encountered, add the <code>+</code> modifier to the shorthand character class which means match one or more:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_string </span><span class=\"mtk7\">=~</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/(</span><span class=\"mtk4\">\\w</span><span class=\"mtk6\">+)/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">$1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;d5353168&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">This looks like what we need, the allocation ID of the sidekiq task. However, recall we set <code>some_string</code> to just one line within the output for demonstration purposes. The actual full output of the <code>nomad status myapp</code> command will be a larger string, composed of multiple lines separated by newline characters <code>\\n</code>.</p>\n<p class=\"markdown-para\">Something like this - I've split it up into separate lines for legibility but it would actually be one big string:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;Name          = myapp\\nType          = service\\nStatus        = running\\n</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Allocations\\nID        Node ID   Task Group  Version  Desired  Status   Created    Modified\\n</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0afe229d  2008ce70  puma        191      run      running  2d20h ago  2d20h ago\\n</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fa39a002  2008ce70  puma        191      run      running  2d20h ago  2d20h ago\\n</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">8bd5fa5c  4163a6ca  puma        191      run      running  2d20h ago  2d20h ago\\n</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">d5353168  2008ce70  sidekiq     191      run      running  2d20h ago  2d20h ago\\n&quot;</span></span></code></pre>\n<p class=\"markdown-para\">This means the regex to capture only the sidekiq allocation id is a little more complicated. Describing it in English would read like:</p>\n<p class=\"markdown-para\">Find a line that starts with a series of letters and numbers, followed by a series of space characters, followed by another series of letters/numbers, followed by a series of space characters, followed by the word sidekiq, followed by any number of any characters, and then capture the first series of letters and numbers.</p>\n<p class=\"markdown-para\">To express this as a regex, let's break down that sentence into sections and write down the portion of the regex just for that part:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Find a line that starts with a series of letters and numbers: <code>^\\w+</code> (caret <code>^</code>matches start of string)</li>\n<li class=\"markdown-list-item\">Followed by a series of space characters: <code>\\s+</code></li>\n<li class=\"markdown-list-item\">Followed by another series of letters/numbers: <code>\\w+</code></li>\n<li class=\"markdown-list-item\">Followed by a series of space characters: <code>\\s+</code></li>\n<li class=\"markdown-list-item\">Followed by the word sidekiq: <code>sidekiq</code></li>\n<li class=\"markdown-list-item\">Followed by any number of any characters: <code>.*</code> (dot <code>.</code> means any character, <code>*</code> means 0 or more times)</li>\n<li class=\"markdown-list-item\">And then capture the first series of letters and numbers: Add parents to first part: <code>^(\\w+)</code></li>\n</ul>\n<p class=\"markdown-para\">Putting this all together results in the following regex to be used in the script:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">/^(</span><span class=\"mtk4\">\\w</span><span class=\"mtk6\">+)</span><span class=\"mtk4\">\\s</span><span class=\"mtk6\">+</span><span class=\"mtk4\">\\w</span><span class=\"mtk6\">+</span><span class=\"mtk4\">\\s</span><span class=\"mtk6\">+sidekiq.*/</span></span></span></code></pre>\n<p class=\"markdown-para\">Want to learn more about Ruby and Regex? Checkout this fantastic <a href=\"https://www.rubyguides.com/2015/06/ruby-regex/\" class=\"markdown-link\">tutorial</a>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"chaining--multiple-one-liners\" style=\"position:relative;\"><a href=\"#chaining--multiple-one-liners\" aria-label=\"chaining  multiple one liners permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chaining  Multiple One Liners</h3>\n<p class=\"markdown-para\">Remember that to retrieve the result of a capture group requires a second line of code, to access the special variable <code>$</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">some_string </span><span class=\"mtk7\">=~</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/(</span><span class=\"mtk4\">\\w</span><span class=\"mtk6\">+)/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">$1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk6\">&quot;d5353168&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">To get this effect in our script will require chaining together multiple <code>ruby -e</code> commands. The first command will execute the system command <code>nomad status myapp</code> and match it against the regex explained in the previous section. The second command will simply use the ruby <code>puts</code> command to output the value of the capture group in the <code>$1</code> special variable to the console. The dollar portion of the special variable must be escaped when run via <code>ruby -e</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ruby -e &quot;\\`nomad status myapp\\` =~ /^(\\w+)\\s+\\w+\\s+sidekiq.*/&quot; -e &quot;puts \\$1&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Outputs value in capture group, which is the sidekiq allocation ID: d5353168</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"converting-to-script-variable\" style=\"position:relative;\"><a href=\"#converting-to-script-variable\" aria-label=\"converting to script variable permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Converting to Script Variable</h3>\n<p class=\"markdown-para\">Now that the value of the sidekiq allocation ID has been output to the console, it has to get stored in a script variable. In other words, we're going to exit Ruby land and go back to Bash.</p>\n<p class=\"markdown-para\">The first step is to wrap the chain of ruby one liners in <code>echo $(...)</code> which runs it in a subshell and returns the value. Finally wrap that whole expression in another <code>$(...)</code> and assign the result to the <code>id</code> variable, which can then be used for the second command which is to run a shell in the sidekiq container:</p>\n<p class=\"markdown-para\">Putting this all together:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">id=</span><span class=\"mtk6\">$(echo $(ruby -e &quot;</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\">nomad status myapp</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\"> =~ /^(\\w+)\\s+\\w+\\s+sidekiq.*/&quot; -e &quot;puts </span><span class=\"mtk4\">\\$</span><span class=\"mtk6\">1&quot;))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task sidekiq $id /bin/bash</span></span></span></code></pre>\n<p class=\"markdown-para\">Finally, save these lines in a file with a shebang, usage, and comments. Remember to make the file executable:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># USAGE: ./script/run-nomad-shell.sh</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Parse sidekiq allocation ID from status output, storing it in $id variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">id=</span><span class=\"mtk6\">$(echo $(ruby -e &quot;</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\">nomad status myapp</span><span class=\"mtk4\">\\`</span><span class=\"mtk6\"> =~ /^(\\w+)\\s+\\w+\\s+sidekiq.*/&quot; -e &quot;puts </span><span class=\"mtk4\">\\$</span><span class=\"mtk6\">1&quot;))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run a shell in sidekiq allocation parsed from previous step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task sidekiq $id /bin/bash</span></span></span></code></pre>\n<p class=\"markdown-para\">Note that the <code>$1</code> is not a bash script variable, that's the result of the capture group from matching on the regex with ruby.</p>\n<h2 class=\"markdown-subtitle\" id=\"generalizing-the-example\" style=\"position:relative;\"><a href=\"#generalizing-the-example\" aria-label=\"generalizing the example permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Generalizing the Example</h2>\n<p class=\"markdown-para\">The example in this post went into detail on my specific use case which was to capture a specific allocation ID from a Nomad status command, and then use that to launch a shell in that container. But this technique can be applied more generally anytime you want to run a system command, and then use the output from that command as input to a further command. The steps are:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Run the first system command at your usual shell and write a regex with capture group that will capture the value you want from the output.</li>\n<li class=\"markdown-list-item\">Use <code>ruby -e</code> to run the first system command, matching on the regex you wrote in the previous step.</li>\n<li class=\"markdown-list-item\">Chain it with a second <code>ruby -e</code> to output the result of the capture group using the <code>$1</code> special variable.</li>\n<li class=\"markdown-list-item\">Wrap it with $(...), echo it, then one more $(...) wrap and assign to a script variable.</li>\n<li class=\"markdown-list-item\">Use the script variable in the next system command.</li>\n</ul>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered how Ruby can be used to run and parse system command output to automate tedious tasks where multiple commands and copy/pasting values are required. I hope you'll be able to apply this technique to speed up your workflows.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/ruby-parse-cli-output/"}}},{"node":{"id":"41a1eab5-7685-581e-9d15-1fb7583289ba","frontmatter":{"title":"Add Related Posts Feature to a Gatsby Blog","date":"February 2022","category":"gatsby"},"excerpt":"This post will explain how to add a Related Posts feature to a Gatsby blog. The idea is to add a small number of links at the bottom of aâ€¦","html":"<p class=\"markdown-para\">This post will explain how to add a Related Posts feature to a Gatsby blog. The idea is to add a small number of links at the bottom of a post page, to other posts that the reader may be interested in. The display of these could be just simple text links, or include a small version of the feature photo and the title. For example, at the end of a post about Gatsby, display a few other articles about Gatsby like this:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVQY0x2QSUgbAQBF59i7eJUcXS+CEksVxCUJKCJpIQdDFBdwjwtGD9pGkWK0adWLHhRXUEuxB0E8elVJxC0GNTqZZBQTZzCKS9W84vzr48HjC75DP17PHjtbXjw7u2xveZDEMLzBvxe4fQb1CZQniDxC7BniL2/c3T0gX12jRG9QlFsiUQU1qiB8sdnIzM3lU5GBPIOJlKwspmbned+mN8Dg2DT2bictPf18HfjO6t81jS2t/qGuvRHXkBNHVwv2ng6+DQ0ifCwuIkGnIyk5FV1aOh8SExkZHdck968JyguNVFS3Y7Y2YdTr+eH6qbG538uUmU10O5qpspoxlBRQ39aIYKmsIjs/n7zi90IjGfocZhYWNWls2M1nUwk1DhcVrf2UllmYnFnR2NrGOjX2Bro6muhsa8Baa6PP2YtwdnLO4b4Pv+8U8VwiJMk83D8Sf40TDIgcHfgRL8JIokw4dEVMjWn/Ri6vOfadIAVl5NAlwQsJNaryH9dsJQQJsgGKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"gatsby related posts example\"\n        title=\"gatsby related posts example\"\n        src=\"/static/574e3d1ff036bf363ef8312daa703884/5a190/gatsby-related-posts-example.png\"\n        srcset=\"/static/574e3d1ff036bf363ef8312daa703884/772e8/gatsby-related-posts-example.png 200w,\n/static/574e3d1ff036bf363ef8312daa703884/e17e5/gatsby-related-posts-example.png 400w,\n/static/574e3d1ff036bf363ef8312daa703884/5a190/gatsby-related-posts-example.png 800w,\n/static/574e3d1ff036bf363ef8312daa703884/bb3ba/gatsby-related-posts-example.png 1121w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p class=\"markdown-para\">The related posts will be curated, that is, the author of the blog is responsible for selecting related articles for each post and populating them in the markdown (we'll be getting into the details of this shortly). If you are looking for a more automated solution, checkout the <a href=\"https://www.npmjs.com/package/gatsby-remark-related-posts\" class=\"markdown-link\">gatsby-remark-related-posts</a> plugin. This plugin didn't suit my use case as I wanted the flexibility to occasionally choose tangential content that a text-based similarity algorithm may not select. I also found it valuable as a learning exercise to build this out myself rather than relying on a plugin.</p>\n<h2 class=\"markdown-subtitle\" id=\"existing-post-page\" style=\"position:relative;\"><a href=\"#existing-post-page\" aria-label=\"existing post page permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Existing Post Page</h2>\n<p class=\"markdown-para\">Before getting into adding Related Posts, let's briefly look at how a typical post page is built with Gatsby using the <a href=\"https://www.npmjs.com/package/gatsby-transformer-remark\" class=\"markdown-link\">gatsby-transformer-remark</a> plugin. If you already have a solid understanding of Gatsby and the remark plugin, feel free to skip ahead to the <a href=\"../gatsby-related-posts#adding-related-posts\" class=\"markdown-link\">adding related posts</a> section.</p>\n<p class=\"markdown-para\">This remark plugin allows you to write posts in markdown, and then exposes fields that it generates such as <code>html</code> and <code>excerpt</code> in the GraphQL server during development, under the node type <code>allMarkdownRemark</code>. It also exposes any frontmatter fields you add at the top of your markdown (content delimited by <code>--</code> symbols).</p>\n<p class=\"markdown-para\">For example, given the following project layout:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ README.md</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ gatsby-config.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ gatsby-node.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ package.json</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ src</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”œâ”€â”€ components</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ article.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ footer.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ header.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ layout.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”œâ”€â”€ markdown</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ here-is-a-post.md</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ another-post.md</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ yet-another-post.md</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”œâ”€â”€ pages</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index.js</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”œâ”€â”€ templates</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ post.js</span></span></code></pre>\n<p class=\"markdown-para\">And some markdown content in <code>markdown/here-is-a-post.md</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"markdown\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">title</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">description</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;This is a sample description for the post.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">date</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;2022-02-15&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">category</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;example&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">featuredImage</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;../images/example.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.</span></span></span></code></pre>\n<p class=\"markdown-para\">The following GraphQL query would find this post and return all its data. Notice that all the fields in the markdown frontmatter can be exposed from the schema via <code>edges -> node -> frontmatter</code>. To execute queries in Gatsby during development, navigate to <a href=\"http://localhost:8000/___graphql\" class=\"markdown-link\">http://localhost:8000/___graphql</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    # limit results to only the example post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\"> } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # These fields come from the top of markdown/here-is-a-post.md</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">          # Images are a little more complicated, making use of gatsby-plugin-sharp and gatsby-transformer-sharp plugins.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              gatsbyImageData(</span><span class=\"mtk10 mtki\">width</span><span class=\"mtk1\">: </span><span class=\"mtk4\">900</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">layout</span><span class=\"mtk1\">:</span><span class=\"mtk4\"> CONSTRAINED</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # This is generated by the gatsby-transformer-remark plugin,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # which converts the markdown content to html.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">And here is the resulting JSON response from the GraphQL server. Notice that it pretty much mirrors the structure of the query, with the exception of being wrapped in a <code>data</code> object and the <code>featuredImage</code> field containing more details for rendering responsive images:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;allMarkdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for the post.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;featuredImage&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk9 mtki\">&quot;childImageSharp&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk9 mtki\">&quot;gatsbyImageData&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk9 mtki\">&quot;layout&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;constrained&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk9 mtki\">&quot;images&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      </span><span class=\"mtk9 mtki\">&quot;sources&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                          </span><span class=\"mtk9 mtki\">&quot;srcSet&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/static/67f.../71a10/example.webp 225w,</span><span class=\"mtk4\">\\n</span><span class=\"mtk12\">/static/67f.../901f1/example.webp 450w,</span><span class=\"mtk4\">\\n</span><span class=\"mtk12\">/static/67f.../5acd1/example.webp 900w&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                          </span><span class=\"mtk9 mtki\">&quot;type&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;image/webp&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                          </span><span class=\"mtk9 mtki\">&quot;sizes&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;(min-width: 900px) 900px, 100vw&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk9 mtki\">&quot;width&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">900</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk9 mtki\">&quot;height&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">599</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;html&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;&lt;p&gt;And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.&lt;/p&gt;...&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nWhile it's easy to understand how the frontmatter text fields are populated, the contents of featuredImage are more complicated. This is generated by some additional plugins that make the job of generating responsive images with Gatsby relatively easy. A full discussion of this topic is outside the scope of this post, but if you'd like to learn more about this, see the Gatsby docs on <a class=\"markdown-link\" href=\"https://www.gatsbyjs.com/docs/working-with-images/\">Working with Images</a>.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"retrieve-all-posts\" style=\"position:relative;\"><a href=\"#retrieve-all-posts\" aria-label=\"retrieve all posts permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Retrieve all Posts</h3>\n<p class=\"markdown-para\">We've just seen an example GraphQL query and JSON response to retrieve a single post. But for building a blog, all the posts must be retrieved, and then fed one at a time to the post template for rendering. This is performed by <code>gatsby-node.js</code>, a file that sits at the project root. It exports a <code>createPages</code> function, which the Gatsby build process will invoke.</p>\n<p class=\"markdown-para\">The <code>createPages</code> function runs a GraphQL query via a promise, to retrieve all post content in the markdown files. The promise result handler will pass these results one at a time to the <code>createPage</code> function. This function receives an object specifying the <code>component</code>, which is the path to the template to be rendered, and a <code>context</code>, which can contain anything, but practically speaking will contain some results of the GraphQL query that has just resolved. In this case, the post <code>slug</code> is passed in via context, which will then be available to the template to execute a GraphQL query to lookup details about just this <code>$slug</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// gatsby-node.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\">.</span><span class=\"mtk5\">createPages</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">graphql</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">actions</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// A Gatsby function which will be used to create the post pages from GraphQL data and a template.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { createPage } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> actions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// This gets ALL markdown posts, sorting by most recent date first.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// We only need to retrieve the slug so that the post template can use this</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// to lookup all the other content from in a page query (see next section).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        allMarkdownRemark(sort: { fields: [frontmatter___date], order: DESC }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    `</span><span class=\"mtk1\">).</span><span class=\"mtk5\">then</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">result</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result.data.allMarkdownRemark.edges.</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(({ </span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">createPage</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          path: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          component: path.</span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;./src/templates/post.js&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// any field provided here in context will be available to the post.js template</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// to be used in a page query to retrieve further details about this post.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          context: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            slug: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"post-template\" style=\"position:relative;\"><a href=\"#post-template\" aria-label=\"post template permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Post Template</h3>\n<p class=\"markdown-para\">The Post template, which is a React component, receives this JSON data as props and renders it. It does so by running a GraphQL page query at build time, using the <code>slug</code> field  provided to it by the <code>createPage</code> function implemented in <code>gatsby-node.js</code>. This query is doing the GraphQL equivalent of something like this SQL statement: <code>SELECT html, title, date... FROM markdown WHERE slug = $slug</code>.</p>\n<p class=\"markdown-para\">Somewhat confusingly, the page query is written <em class=\"markdown-emphasis\">after</em> the rendering code in the template. I'm going to focus in on just the query, and come back to the rendering code in a bit:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// This is called once for each markdown file from gatsby-node.js.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// The $slug paramter is available because of the context that was</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// passed in to the createPage function in gatsby-node.js.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">query</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">$slug</span><span class=\"mtk1\">: </span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    markdownRemark(</span><span class=\"mtk10 mtki\">fields</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">slug</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: $slug } }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gatsbyImageData(</span><span class=\"mtk10 mtki\">width</span><span class=\"mtk1\">: </span><span class=\"mtk4\">900</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">layout</span><span class=\"mtk1\">:</span><span class=\"mtk4\"> CONSTRAINED</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">`</span></span></span></code></pre>\n<p class=\"markdown-para\">Finally, the results of the page query are exposed to the Post component in its <code>props</code> via the <code>data</code> property. For example, the markdown html is available at <code>props.data.markdownRemark.html</code>, whereas the title is available at <code>props.data.markdownRemark.frontmatter.title</code>. The Post component extracts these properties and renders them using React.</p>\n<p class=\"markdown-para\">For example, this Post template renders the title, publish date, a featured image and html content generated from the markdown:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { GatsbyImage } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby-plugin-image&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> markdown </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> props.data.markdownRemark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> title </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> publishedDate </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> featuredImgFluid </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.featuredImage.childImageSharp.gatsbyImageData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> content </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">article</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;Published </span><span class=\"mtk7\">{</span><span class=\"mtk1\">publishedDate</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">GatsbyImage</span><span class=\"mtk1\"> </span><span class=\"mtk5\">image</span><span class=\"mtk7\">={</span><span class=\"mtk1\">featuredImgFluid</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">dangerouslySetInnerHTML</span><span class=\"mtk7\">={</span><span class=\"mtk1\">{ __html: content }</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">article</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">query</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">$slug</span><span class=\"mtk1\">: </span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">`</span></span></span></code></pre>\n<p class=\"markdown-para\">Now that we have an understanding of how a basic post page gets rendered from Markdown content in Gatsby, we can move on to enhancing this process with a Related Posts feature.</p>\n<aside class=\"markdown-aside\">\nIf this all seems like a lot of work to get a basic blog post up, it is! A full discussion of the pros and cons of various blogging solutions is outside the scope of this article, but suffice to say, if you like building things and especially love React, Gatsby is a great choice for a blog. However, if you just want to hit the ground publishing articles and not worry about building an entire website, including design, layout, search, SEO etc, then an online platform such as <a class=\"markdown-link\" href=\"https://medium.com/\">Medium</a> or <a class=\"markdown-link\" href=\"https://dev.to/\">dev.to</a> may be a better choice.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"adding-related-posts\" style=\"position:relative;\"><a href=\"#adding-related-posts\" aria-label=\"adding related posts permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding Related Posts</h2>\n<p class=\"markdown-para\">Probably the most important aspect to understand when adding a new feature to a Gatsby/Markdown site is that you can add anything you want to the frontmatter fields (top section of markdown file contained  within <code>---</code>). There's nothing special about the fields I've shown you so far such as <code>title</code>, <code>description</code>, etc.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"customizing-frontmatter\" style=\"position:relative;\"><a href=\"#customizing-frontmatter\" aria-label=\"customizing frontmatter permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Customizing Frontmatter</h3>\n<p class=\"markdown-para\">To demonstrate this, let's add a nonsense field that has nothing to do with blogging such as <code>favColor</code> to the example post shown earlier:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"markdown\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">title</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">description</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;This is a sample description for the post.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">date</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;2022-02-15&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">category</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;example&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">featuredImage</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;../images/example.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">favColor</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;purple&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.</span></span></span></code></pre>\n<p class=\"markdown-para\">Now let's modify the GraphQL query shown earlier that fetches this markdown post, to include the nonsense field <code>favColor</code>. I'm leaving out the generated <code>html</code> field and image field for simplicity:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    # limit results to only the example post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\"> } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # These fields come from the top of markdown/here-is-a-post.md</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          favColor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">And here is the result - notice the new field <code>favColor</code> in the results:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;allMarkdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for the post.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;favColor&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;purple&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Now that we've verified anything can be added to the frontmatter fields, let's add something useful.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"frontmatter-arrays\" style=\"position:relative;\"><a href=\"#frontmatter-arrays\" aria-label=\"frontmatter arrays permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Frontmatter Arrays</h3>\n<p class=\"markdown-para\">Another important concept to understand is the frontmatter field values are not limited to strings. An array value can be created by nesting a list of values with <code>-</code>. This is exactly what's needed to define a <code>related</code> field, as each markdown post will have three related posts.</p>\n<p class=\"markdown-para\">Here is the <code>markdown/here-is-a-post.md</code> markdown file, with the nonsense field <code>favColor</code> replaced with a <code>related</code> field containing an array value, which specifies the title of three other markdown posts:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"markdown\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">title</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">featuredImage</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;../images/example.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">description</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;This is a sample description for the post.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">date</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;2022-02-15&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">category</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;example&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">related</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk6\">&quot;Related Post 1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk6\">&quot;Related Post 2&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  - </span><span class=\"mtk6\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.</span></span></span></code></pre>\n<p class=\"markdown-para\">Now let's run a query to fetch the example post, this time including the new <code>related</code> array field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    # limit results to only the example post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\"> } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        # These fields come from the top of markdown/here-is-a-post.md</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          related</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">And here are the results - notice that the <code>related</code> field contains an Array of strings, representing the titles of the related posts:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;allMarkdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for the post.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;related&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">&quot;Related Post 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">&quot;Related Post 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Assume there are an additional three markdown files titled \"Related Post 1\", 2 and 3 such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"markdown\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">title</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;Related Post 1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">featuredImage</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;../images/example.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">description</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;This is a sample description for related post 1.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">date</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;2022-02-14&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">category</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;example&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">And here is the sample post. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. In nulla posuere sollicitudin aliquam ultrices sagittis orci a scelerisque.</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"update-retrieval-of-all-posts\" style=\"position:relative;\"><a href=\"#update-retrieval-of-all-posts\" aria-label=\"update retrieval of all posts permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Update Retrieval of all Posts</h3>\n<p class=\"markdown-para\">Recall the post template contains a page query that queries for the current content using the <code>$slug</code> value that was passed in from <code>gatsby-node.js</code>. The template will also need to query for the related posts. In order for this information to be available, <code>gatsby-node.js</code> must be modified to include the <code>related</code> field when its fetching all posts, and then provide this as <code>context</code> to the post template:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// gatsby-node.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\">.</span><span class=\"mtk5\">createPages</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">graphql</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">actions</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// A Gatsby function which will be used to create the post pages from GraphQL data and a template.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { createPage } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> actions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// This gets ALL markdown posts, sorting by most recent date first.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ### NEW: Retrieve custom frontmatter field `related` here ###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">new</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        allMarkdownRemark(sort: { fields: [frontmatter___date], order: DESC }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                related</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    `</span><span class=\"mtk1\">).</span><span class=\"mtk5\">then</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">result</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result.data.allMarkdownRemark.edges.</span><span class=\"mtk5\">forEach</span><span class=\"mtk1\">(({ </span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">createPage</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          path: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          component: path.</span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;./src/templates/post.js&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// any field provided here in context will be available to the post.js template</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// to be used in a page query to retrieve further details about this post.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          context: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            slug: node.fields.slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// ### NEW: Pass relatedPosts array to the template here ###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            relatedPosts: node.frontmatter.related</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">resolve</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"querying-for-multiple-results\" style=\"position:relative;\"><a href=\"#querying-for-multiple-results\" aria-label=\"querying for multiple results permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Querying for Multiple Results</h3>\n<p class=\"markdown-para\">The <a href=\"../gatsby-related-posts#post-template\" class=\"markdown-link\">post template</a>, will need to have its page query modified. In addition to querying for the specific markdown content to be displayed, now it must also query the <code>relatedPosts</code> field (provided by <code>gatsby-node.js</code>) to fetch each related posts title, featured image, and slug for linking.</p>\n<p class=\"markdown-para\">Up until now, the example queries I've been showing you have either retrieved all posts (as used by <code>gatsby-node.js</code>) or have retrieved just a single post using the GraphQL <code>eq</code> filter. But now, the post template must query for the related posts, which is an array of string post titles. Fortunately, GraphQL has an <code>in</code> <a href=\"https://www.gatsbyjs.com/docs/graphql-reference/#filter\" class=\"markdown-link\">filter</a> to do this. For example, the following query will fetch post information for the three related posts:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    # limit results to the specified posts using `in` filter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">in</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ] } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          category</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Here are the results. Notice that the <code>edges</code> array now contains multiple results, whereas previously when using the <code>eq</code> filter, it contained a list of only a single result:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;allMarkdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for related post 1.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-14&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for related post 2.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-13&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 3&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for related post 3.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-12&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"update-post-template-page-query\" style=\"position:relative;\"><a href=\"#update-post-template-page-query\" aria-label=\"update post template page query permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Update Post Template Page Query</h3>\n<p class=\"markdown-para\">Armed with all this knowledge, we can now update the <a href=\"../gatsby-related-posts#post-template\" class=\"markdown-link\">post template</a> page query to fetch each related post title, featured image, and slug for linking. There is no need to fetch the html content as the related posts only display an image and title. It will use the <code>in</code> filter as described in the previous section.</p>\n<p class=\"markdown-para\">Notice that the <code>query</code> now accepts two parameters - the <code>$slug</code> as before, and <code>$relatedPosts</code>, which is denoted as an array with <code>[String!]</code>. This is possible because earlier we modified the <a href=\"../gatsby-related-posts#update-retrieval-of-all-posts\" class=\"markdown-link\">retrieval of all posts</a> to provide this as context.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// This is called once for each markdown file from gatsby-node.js.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// $slug and $relatedPosts paramters are available because of the context that was</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// passed in to the createPage function in gatsby-node.js.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">query</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">$slug</span><span class=\"mtk1\">: </span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">$relatedPosts</span><span class=\"mtk1\">: [</span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">]</span><span class=\"mtk7\">!</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    markdownRemark(</span><span class=\"mtk10 mtki\">fields</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">slug</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: $slug } }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            gatsbyImageData(</span><span class=\"mtk10 mtki\">width</span><span class=\"mtk1\">: </span><span class=\"mtk4\">900</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">layout</span><span class=\"mtk1\">:</span><span class=\"mtk4\"> CONSTRAINED</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">relatedP</span><span class=\"mtk1\">: allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">in</span><span class=\"mtk1\">: $relatedPosts } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                gatsbyImageData(</span><span class=\"mtk10 mtki\">width</span><span class=\"mtk1\">: </span><span class=\"mtk4\">270</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">height</span><span class=\"mtk1\">: </span><span class=\"mtk4\">150</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">layout</span><span class=\"mtk1\">:</span><span class=\"mtk4\"> FIXED</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">`</span></span></span></code></pre>\n<p class=\"markdown-para\">Notice that the new <code>relatedP</code> section is being defined as a sibling to the existing <code>markdownRemark</code> section. The resulting response object will still be wrapped in a <code>data</code> field as before, but will now contain both a <code>markdownRemark</code> field containing the current post content, and a <code>relatedP</code> section, containing an array of <code>edges</code>, representing the list of related posts. This is the power of GraphQL that you can define any structure you'd like the response object to have.</p>\n<p class=\"markdown-para\">Just to visualize the data that is now available to the page template, we can execute an example query that the template would be running for one specific post, leaving out the generated <code>html</code> and image fields for simplicity. Sorry about all the brackets, that's the syntax of the GraphQL filter:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"graphql\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  markdownRemark(</span><span class=\"mtk10 mtki\">fields</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">slug</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">eq</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;/blog/here-is-a-post/&quot;</span><span class=\"mtk1\"> } }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">relatedP</span><span class=\"mtk1\">: allMarkdownRemark(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">filter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">frontmatter</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">title</span><span class=\"mtk1\">: { </span><span class=\"mtk6\">in</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ] } } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    edges {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Here is the result of the above query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;data&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;markdownRemark&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Here is an example markdown post&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;date&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2022-02-15&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This is a sample description for the post.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;fields&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/here-is-a-post/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;relatedP&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;edges&quot;</span><span class=\"mtk1\">: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;fields&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/related-post-1/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 2&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;fields&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/related-post-2/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk9 mtki\">&quot;node&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;frontmatter&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Related Post 3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;fields&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/related-post-3/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"update-post-template-jsx\" style=\"position:relative;\"><a href=\"#update-post-template-jsx\" aria-label=\"update post template jsx permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Update Post Template JSX</h3>\n<p class=\"markdown-para\">Now that we know the shape of the new data available to the post template from its page query, the template JSX can be updated to render it. Specifically, we will pass the data as props to a new <code>RelatedPosts</code> component (described in next section), to prevent the existing Post Template from getting too cluttered:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { GatsbyImage } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby-plugin-image&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ### NEW: Component to render related posts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> RelatedPosts </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/related-posts&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> markdown </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> props.data.markdownRemark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> title </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> publishedDate </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> featuredImgFluid </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.featuredImage.childImageSharp.gatsbyImageData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> content </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ### NEW: Extract related posts from page query</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> related </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> props.data.relatedP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">article</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;Published </span><span class=\"mtk7\">{</span><span class=\"mtk1\">publishedDate</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">GatsbyImage</span><span class=\"mtk1\"> </span><span class=\"mtk5\">image</span><span class=\"mtk7\">={</span><span class=\"mtk1\">featuredImgFluid</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">dangerouslySetInnerHTML</span><span class=\"mtk7\">={</span><span class=\"mtk1\">{ __html: content }</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">article</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">RelatedPosts</span><span class=\"mtk1\"> </span><span class=\"mtk5\">related</span><span class=\"mtk7\">={</span><span class=\"mtk1\">related</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk1\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">query</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">$slug</span><span class=\"mtk1\">: </span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">$relatedPosts</span><span class=\"mtk1\">: [</span><span class=\"mtk9 mtki\">String</span><span class=\"mtk7\">!</span><span class=\"mtk1\">]</span><span class=\"mtk7\">!</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">`</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"related-posts-component\" style=\"position:relative;\"><a href=\"#related-posts-component\" aria-label=\"related posts component permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Related Posts Component</h3>\n<p class=\"markdown-para\">The last step in the process is to define a <code>RelatedPosts</code> component. This component will iterate over the posts it receives as props from the post template page and render their titles and images as links, with the target of the link being the post slug:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/related-posts.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { GatsbyImage } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby-plugin-image&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">RelatedPosts</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">section</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;You may also like...&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">props.related.edges.</span><span class=\"mtk5\">map</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">post</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">key</span><span class=\"mtk7\">={</span><span class=\"mtk1\">post.node.id</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">={</span><span class=\"mtk1\">post.node.fields.slug</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk9 mtki\">GatsbyImage</span><span class=\"mtk1\"> </span><span class=\"mtk5\">image</span><span class=\"mtk7\">={</span><span class=\"mtk1\">post.node.frontmatter.featuredImage.childImageSharp.gatsbyImageData</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">post.node.frontmatter.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ))</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">section</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> RelatedPosts</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered the basics of building blog post pages using Gatsby and the <a href=\"https://www.npmjs.com/package/gatsby-transformer-remark\" class=\"markdown-link\">gatsby-transformer-remark</a> plugin and how to modify the process to add a related posts feature. This involves customizing the markdown frontmatter to include an array of post titles that are related to the current post, modifying the outer query run by the <code>gatsby-node.js</code> build process to pass the related content to the post template, then modifying the post template query and rendering to retrieve and render the related posts.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/gatsby-related-posts/"}}},{"node":{"id":"ee62db41-d335-5e83-a05c-da0ea1ec621c","frontmatter":{"title":"Nomad Tips and Tricks","date":"January 2022","category":"devops"},"excerpt":"I've been working on a platform migration project to containerize and move several web applications and associated services from a homeâ€¦","html":"<p class=\"markdown-para\">I've been working on a platform migration project to containerize and move several web applications and associated services from a home grown system to Hashicorp's <a href=\"https://www.nomadproject.io/\" class=\"markdown-link\">Nomad</a>. Nomad is a workload orchestration tool designed to make it (relatively) easy to deploy, manage and scale containers on private and public clouds. It's <a href=\"https://www.nomadproject.io/docs/nomad-vs-kubernetes\" class=\"markdown-link\">comparable</a> to Kubernetes, but focuses on a smaller scope, delegating features including discovery and secrets management to other tools such as <a href=\"https://www.consul.io/\" class=\"markdown-link\">Consul</a> and <a href=\"https://www.vaultproject.io/\" class=\"markdown-link\">Vault</a>, while providing integration with these. It's also newer than Kubernetes.</p>\n<p class=\"markdown-para\">One of the challenges in working with a newer platform is a smaller community, and finding online help. Many of my web searches lead to the official Nomad docs. While they are well written, if I'm doing a search, it's because I couldn't find the solution the docs. In the spirit of increasing the body of online knowledge, this post will share a few tips and tricks I've picked up going through this migration.</p>\n<aside class=\"markdown-aside\">\nThis post assumes some working knowledge of Hashicorp's Nomad. If you haven't used it before, checkout this excellent <a class=\"markdown-link\" href=\"https://adri-v.medium.com/just-in-time-nomad-80f57cd403ca\">primer</a> and <a class=\"markdown-link\" href=\"https://adri-v.medium.com/just-in-time-nomad-running-traefik-on-hashiqube-7d6dfd8ef9d8\">tutorial</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"job-specification\" style=\"position:relative;\"><a href=\"#job-specification\" aria-label=\"job specification permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Job Specification</h2>\n<p class=\"markdown-para\">The first set of tips are for working with the job specification file (aka jobspec). This is a declarative way of telling Nomad about your application and its resource requirements. The jobspec file is written in <a href=\"https://github.com/hashicorp/hcl\" class=\"markdown-link\">HCL</a>, which stands for Hashicorp Configuration Language.</p>\n<p class=\"markdown-para\">Although it can be irritating when tools require learning a framework-specific (i.e. non portable) language, HCL is similar enough to JSON and YAML that anyone familiar with these will pick it up easily. In fact, if JSON and YAML had a baby it might look something like HCL.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"increase-docker-pull-timeout\" style=\"position:relative;\"><a href=\"#increase-docker-pull-timeout\" aria-label=\"increase docker pull timeout permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Increase Docker Pull Timeout</h3>\n<p class=\"markdown-para\">When using the <a href=\"https://www.nomadproject.io/docs/drivers/docker\" class=\"markdown-link\">Docker driver</a> to run a task, the Nomad client on which the task is running will first pull the Docker image from the specified location. This can be from Docker Hub, Github Container Registry, or a private Docker registry. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;webapp&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">But what happens if there's a networking issue resulting in a longer than usual amount of time to pull the image? In this case, Nomad will timeout the docker pull after 5 minutes and restart according to the <code>restart</code> stanza. If the networking issues are not resolved, the job will eventually fail.</p>\n<p class=\"markdown-para\">To avoid having the job fail when docker pull is taking longer than usual, use the <code>image_pull_timeout</code> property of the docker <code>config</code> stanza to override Nomad's default timeout. For example, to increase it to 10 minutes:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image_pull_timeout</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;10m&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"reuse-docker-tag-for-development\" style=\"position:relative;\"><a href=\"#reuse-docker-tag-for-development\" aria-label=\"reuse docker tag for development permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reuse Docker Tag for Development</h3>\n<p class=\"markdown-para\">When using Docker to run a Nomad task, the Nomad client will use a cached image if the image:tag specified in the docker driver config stanza of the jobspec has already been pulled. However, during development, you may be making changes to a dev version of the Docker image and re-using the same tag.</p>\n<p class=\"markdown-para\">For example when developing a new feature, I'll switch to a git feature branch on my laptop, build an image tagged with the feature branch name, push it to the container registry, and deploy it to the Nomad dev environment (we use multiple <a href=\"https://learn.hashicorp.com/tutorials/nomad/namespaces\" class=\"markdown-link\">namespaces</a> to isolate dev, staging, and production environments). In this case, I don't want Nomad to use the cached image from my last deploy, but to always pull a \"fresh\" version of the image. This can be accomplished using <code>force_pull</code> as shown below:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:my-feature&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">force_pull</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"always-deploy-a-new-job-version\" style=\"position:relative;\"><a href=\"#always-deploy-a-new-job-version\" aria-label=\"always deploy a new job version permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Always deploy a new job version</h3>\n<p class=\"markdown-para\">The command to deploy a new version of a job is <code>nomad job run path/to/nomad/jobspec</code>. However, if nothing has changed in the jobspec file since the last deploy, then Nomad will not take any action. This is fine for production where there will be a new Docker image tag (we use the main line git commit sha) for each deploy, which effectively changes the contents of the Nomad file, thus triggering a new deploy.</p>\n<p class=\"markdown-para\">But for development, we use the same image tag (branch name) so Nomad thinks nothing has changed, even if the image has been updated. Even the <code>force_pull</code> explained in the previous section won't help because Nomad won't get as far as evaluating the jobspec file.</p>\n<p class=\"markdown-para\">To force Nomad to always run a deploy, use a <a href=\"https://www.nomadproject.io/docs/job-specification/meta\" class=\"markdown-link\">meta</a> stanza that is populated with the return value from a uuid function that always generates a unique value. The <code>meta</code> stanza allow user-defined arbitrary key-value pairs. Nomad is written in Golang and so Go functions such as <code>uuidv4()</code> can be interpolated in the Nomad file as shown below. The <code>meta</code> stanza should be placed directly in the <code>job</code> stanza:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">meta</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">run_uuid</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">${</span><span class=\"mtk5\">uuidv4</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"resiliency\" style=\"position:relative;\"><a href=\"#resiliency\" aria-label=\"resiliency permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resiliency</h3>\n<p class=\"markdown-para\">This one is not so much a tip, rather a summary of important stanzas in the jobspec file. One of the many benefits of using an orchestration tool like Nomad is it can handle updates and failures gracefully without manual intervention. In order to take advantage of these features, you must understand and make use of the following stanzas in the job spec file.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/update\" class=\"markdown-link\">update</a> Specifies update strategy Nomad uses when deploying a new version of the task group. i.e. when <code>nomad job run path/to/jobspec</code> is run. For example, perform rolling updates 3 at a time and wait until all tasks for an allocation are running and their Consul health checks are passing for at least 10 seconds before considering the allocation healthy.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/restart\" class=\"markdown-link\">restart</a> Specifies strategy for Nomad to restart failed tasks on the same nomad client. For example, if the application server has crashed, attempt 2 restarts within 30 minutes, delay 15s between each restart, and don't try anymore restarts after those are exhausted.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/check_restart\" class=\"markdown-link\">check_restart</a> Specifies how Nomad should restart a task that is not yet failing, but has become unresponsive or otherwise unhealthy. Works together with Consul health checks. Nomad restarts tasks when a health check has failed. For example, restart the Redis task after its health check has failed 3 consecutive times, and wait 90 seconds after restarting the task to resume health checking.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/reschedule\" class=\"markdown-link\">reschedule</a> This handles the case where the specified number of restarts have been attempted and the task still isn't running. This suggests the issue could be with the Nomad client such as a hardware failure or kernel deadlock. The <code>reschedule</code> stanza is used to specify details for rescheduling a failing task to another nomad client. For example, reschedule the task group an unlimited number of times and increase the delay between subsequent attempts exponentially, with a starting delay of 30 seconds up to a maximum of 1 hour.</p>\n<p class=\"markdown-para\"><a href=\"https://www.nomadproject.io/docs/job-specification/migrate\" class=\"markdown-link\">migrate</a> When a Nomad client needs to come out of service, it gets marked for draining and tasks will no longer be scheduled on it. Then Nomad will migrate all existing jobs to other clients. The <code>migrate</code> stanza specifies the strategy for migrating tasks off of draining nodes. For example, migrate one allocation at a time, and mark migrated allocations healthy once all their tasks are running and associated health checks are passing for 10 seconds or more within a 5 minute deadline.</p>\n<p class=\"markdown-para\">For further details on how these stanzas are used with examples, I recommend these blog posts from Hashicorp's site:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://www.hashicorp.com/blog/resilient-infrastructure-with-nomad-restarting-tasks\" class=\"markdown-link\">Building Resilient Infrastructure: Restarting Tasks</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.hashicorp.com/blog/resilient-infrastructure-with-nomad-scheduling\" class=\"markdown-link\">Building Resilient Infrastructure: Scheduling</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.hashicorp.com/blog/building-resilient-infrastructure-with-nomad-job-lifecycle\" class=\"markdown-link\">Building Resilient Infrastructure: Job Lifecycle</a></li>\n</ul>\n<h3 class=\"markdown-sub-subtitle\" id=\"prestart-hook-for-one-time-initialization\" style=\"position:relative;\"><a href=\"#prestart-hook-for-one-time-initialization\" aria-label=\"prestart hook for one time initialization permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prestart hook for one-time initialization</h3>\n<p class=\"markdown-para\">An application may have some one-time initialization task that needs to be completed before the main application can start. For example, before starting a Rails app, the database migrations should be run. This can be accomplished in Nomad using the <a href=\"https://www.nomadproject.io/docs/job-specification/lifecycle\" class=\"markdown-link\">lifecycle</a> stanza.</p>\n<p class=\"markdown-para\">The idea is, you would have multiple tasks within a group, let's say one task to start the Rails app, and another to run the database migrations. For the migration task, you define the lifecycle hook to be <code>prestart</code>, to indicate the db migrations should run <em class=\"markdown-emphasis\">before</em> the Rails task is started. You would also set <code>sidecar</code> to false, to indicate that this task will start and finish before the main task is started. Setting <code>sidecar</code> to true would make the task run for the duration of the main task, which might be desirable for something like a logging agent.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;dbmigrate&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># The dbmigrate task will run BEFORE the puma task in this group.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">lifecycle</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">hook</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;prestart&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">sidecar</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec rake db:migrate&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;puma&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec puma&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"nomad-environment-variables\" style=\"position:relative;\"><a href=\"#nomad-environment-variables\" aria-label=\"nomad environment variables permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nomad Environment Variables</h3>\n<p class=\"markdown-para\">Nomad ships with a number of <a href=\"https://www.nomadproject.io/docs/runtime/environment\" class=\"markdown-link\">environment variables</a> that are available in the job file <em class=\"markdown-emphasis\">and</em> in any command/scripts that are run in Docker containers as part of the job.</p>\n<p class=\"markdown-para\">Here's an example of using <code>NOMAD_ALLOC_INDEX</code> in a script that runs database migrations, to ensure that it only runs once, when located in a task group that runs multiple instances (specified using <code>count</code> parameter of the <code>group</code> stanza).</p>\n<p class=\"markdown-para\">Here's a modified version of the jobspec from the previous example that introduced the prestart hook:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Will launch 3 instances of the &quot;web&quot; group.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># count parameter can only be specified at the group level.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">count</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># But the database migrations should only run once.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Notice the use of a command script where we will</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># write some custom logic using env var NOMAD_ALLOC_INDEX</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;dbmigrate&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">lifecycle</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">hook</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;prestart&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">sidecar</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;registry/image:tag&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/usr/bin/run-db-migrations&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;puma&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;registry/image:tag&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec puma&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Where <code>/usr/bin/run-db-migrations</code> is a custom script that is added to the Docker image. It checks the value of the <code>NOMAD_ALLOC_INDEX</code> environment variable. Database migrations will only be run when this is <code>z0</code>, the first allocation, and will not be run for any others.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk6\">&quot;z</span><span class=\"mtk1\">$NOMAD_ALLOC_INDEX</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">==</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;z0&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  RAILS_ENV=production bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rake db:migrate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">fi</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"replace-cron-jobs\" style=\"position:relative;\"><a href=\"#replace-cron-jobs\" aria-label=\"replace cron jobs permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Replace Cron Jobs</h3>\n<p class=\"markdown-para\">If your application also has cron jobs, these can easily be replaced with Nomad's <a href=\"https://www.nomadproject.io/docs/job-specification/periodic\" class=\"markdown-link\">periodic</a> jobs. For example, given the following crontab for a job that runs daily at 10:30:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">30 10 * * * nobody bundle exec rake app:some_daily_task</span></span></code></pre>\n<p class=\"markdown-para\">It can be replaced with the following jobspec:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;cron_daily&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;30 10 * * *&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;daily&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;daily&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">   </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;RAILS_ENV=production bundle exec rake app:some_daily_task&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">One challenge with cron jobs, especially for those that run frequently, is how to prevent the next instance of the job from launching, if the previous instance is still running. This can be be <a href=\"https://serverfault.com/questions/82857/prevent-duplicate-cron-jobs-running\" class=\"markdown-link\">tricky</a> to solve with cron, but with Nomad, this can be solved by adding the <code>prohibit_overlap</code> overlap to the <code>periodic</code> stanza.</p>\n<p class=\"markdown-para\">Here's an example of this property for a job that runs every minute:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;cron_frequent_task&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;* * * * *&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">prohibit_overlap</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;frequent&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frequent&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">   </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;RAILS_ENV=production bundle exec rake app:frequent_task&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIf you have a lot of cron jobs to convert to Nomad, it can be tedious to write up all the jobspec files by hand. See my post on <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/convert-multiple-cron-jobs-to-nomad-periodic-jobs/\">Migrating Cron Jobs to Nomad the Lazy Way</a> for an easy way to do this.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"turn-off-auto-restart\" style=\"position:relative;\"><a href=\"#turn-off-auto-restart\" aria-label=\"turn off auto restart permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Turn off auto restart</h3>\n<p class=\"markdown-para\">One of the many fantastic features of Nomad is integration with Vault for secrets management. From a jobspec file, you can read in secrets from Vault, and have them loaded as environment variables in the application. Without a platform managing this, if an environment variable is changed, the application must manually be restarted to pick up the new value. With Nomad's Vault integration, any change to a secret in Vault will cause all jobs that use this secret to automatically be restated.</p>\n<p class=\"markdown-para\">However, there may be times where this is undesirable. One such case is for cron jobs (called periodic jobs in Nomad). For example, the application I'm working on has an autorenew cron job that picks up all subscriptions that are due for renewal and renews them, which includes billing the customer and sending a confirmation email. We would not want this job stopped in the middle and restarted just because a setting had been changed, it would be better for the job to complete and have the change be picked up next time the job runs.</p>\n<p class=\"markdown-para\">In order to implement this behaviour, set <code>change_mode = \"noop\"</code> in the <code>template</code> stanza that reads in the secrets (default is <code>restart</code>):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;autorenew&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;autorenew&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;autornew&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">destination</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;secrets/local.env&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">env</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">change_mode</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;noop&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">data</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> &lt;&lt;EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">API_KEY=&quot;{{with secret &quot;secret/data/api-key&quot;}}{{.Data.value}}{{end}}&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The <code>destination</code> file is still updated when the secrets change and so the updated value will be used the next time the cron job is scheduled.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"populate-environment-variables-from-vault\" style=\"position:relative;\"><a href=\"#populate-environment-variables-from-vault\" aria-label=\"populate environment variables from vault permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Populate Environment Variables from Vault</h3>\n<p class=\"markdown-para\">As mentioned in the previous section, Nomad integrates with Vault for secrets management, which can be used to set environment variables for the containerized application that Nomad is running as a task. This is accomplished with the <a href=\"https://www.nomadproject.io/docs/job-specification/template\" class=\"markdown-link\">template</a> stanza. This stanza has a few parameters. Most significant is the <code>data</code>  parameter which can take either a single line string, or multi-line using a heredoc. This string is written using a <a href=\"https://learn.hashicorp.com/tutorials/nomad/go-template-syntax\" class=\"markdown-link\">Go template</a> and is one of the least intuitive aspects of Nomad.</p>\n<p class=\"markdown-para\">Let's start with a simple example. Suppose the application has a single secret such as DB_PASSWORD that the application expects to be provided as an environment variable to connect to the database. Given that the <a href=\"https://learn.hashicorp.com/tutorials/vault/getting-started-install?in=vault/getting-started\" class=\"markdown-link\">Vault CLI</a> has been installed and configured, the database password would be persisted in Vault as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault kv put kv/secret/config DB_PASSWORD=veryverysecretpassword</span></span></span></code></pre>\n<p class=\"markdown-para\">Then the following jobspec would read in this secret (when being deployed by Nomad) and expose it as an environment variable to the application:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">type</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;service&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Here is where the Vault integration happens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># result of data template will be populated in this file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">destination</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;secrets/file.env&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># all key/value pairs read will be exposed as environment variables to the frontend task</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">env</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># read secret from Vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">data</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> &lt;&lt;EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{with secret &quot;kv/secret/config&quot;}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">DB_PASSWORD={{.Data.data.DB_PASSWORD | toJSON}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{end}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">If you're thinking \"whaaaat the heck is that data thing???\", don't worry. Like I mentioned earlier, this part of Nomad is not very intuitive. While a full coverage of the <a href=\"https://learn.hashicorp.com/tutorials/nomad/go-template-syntax\" class=\"markdown-link\">template syntax</a> is out of scope for this post, here's a brief explanation of what's going on:</p>\n<p class=\"markdown-para\">The <code>&#x3C;&#x3C;IDENTIFIER ... IDENTIFIER</code> denotes the beginning and end of the heredoc, which is a multiline template string. Think of the content in the heredoc as a function that outputs some value. Whatever is output will get written to the <code>destination</code> file, which is <code>secrets/file.env</code> in the above example.</p>\n<p class=\"markdown-para\">Any plain string literals such as <code>DB_PASSWORD</code> will get output exactly as they appear.</p>\n<p class=\"markdown-para\">Anything between double curly braces <code>{{ ... }}</code> represents a dynamic portion of the template, these contain actions.</p>\n<p class=\"markdown-para\"><code>with</code> is an action that redefines the context available to the template. I couldn't find a good explanation of what <code>with secret</code> does but from observation, it reads in the secret stored in Vault at the given location (<code>kv/secret/config</code> in the above example). Now the value from Vault can be traversed using <code>.Data.data.DB_PASSWORD</code>. The reason for <code>.Data.data</code> has to do with how Vault stores the data.</p>\n<p class=\"markdown-para\">The pipe symbol <code>|</code> is used to chain together one or more commands. Since the database password could contain special characters, it's recommended to run all values extracted from Vault through the <code>toJSON</code> function to ensure they're properly parsed.</p>\n<p class=\"markdown-para\">The result of all this is the following contents written to the destination file <code>secrets/file.env</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">DB_PASSWORD=veryverysecretpassword</span></span></code></pre>\n<p class=\"markdown-para\">And if you were to shell in the container (next section on Nomad CLI will explain how to do that) and run <code>env</code>, the <code>DB_PASSWORD</code> environment variable would be listed.</p>\n<p class=\"markdown-para\">Well that's all well and good for a single environment variable, but what if your application has many environment variables? For example, it could be using multiple databases, and integrate with third party services for transactional email, marketing campaigns, payment provider etc., all of which require configuring secrets.</p>\n<p class=\"markdown-para\">Of course you could populate multiple key/value pairs in Vault like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault kv put kv/secret/config DB_PASSWORD=veryverysecretpassword OTHER_DB_PASSWORD=anothersecret EMAIL_PROVIDER_API_KEY=abc123...</span></span></span></code></pre>\n<p class=\"markdown-para\">And update the template data with a row for each secret.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">destination</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;secrets/file.env</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        env = true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        # read multiple secrets from Vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        data = &lt;&lt;EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{with secret &quot;</span><span class=\"mtk1\">kv/secret/config</span><span class=\"mtk6\">&quot;}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">DB_PASSWORD={{.Data.data.DB_PASSWORD | toJSON}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">OTHER_DB_PASSWORD={{.Data.data.OTHER_DB_PASSWORD | toJSON}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">EMAIL_PROVIDER_API_KEY={{.Data.data.EMAIL_PROVIDER_API_KEY | toJSON}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{end}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The problem  with this is the <code>template</code> stanza will get quite lengthy. Also maintenance becomes an issue because the <code>template</code> stanza can only be placed in the <code>task</code> stanza. So if the jobspec has multiple groups/tasks, the lengthy template needs to occur in all of them, and if a new secret is added, multiple template stanzas need to be updated.</p>\n<p class=\"markdown-para\">Fortunately there's a more efficient way to do this. It involves populating Vault with a JSON file rather than individual key/value pairs. Then using the <code>range</code> action in the template stanza, to iterate over the key/value map from Vault, and dynamically create all environment variables from the json that was loaded in Vault.</p>\n<p class=\"markdown-para\">To start, create a json file with all the secrets, this is just temporary and can be deleted after its loaded into Vault. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"># data.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;DB_PASSWORD&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;veryverysecretpassword&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;OTHER_DB_PASSWORD&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;anothersecret&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;EMAIL_PROVIDER_API_KEY&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;abc123&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Run the following command to load this file into Vault:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault kv put kv/secret/config @data.json</span></span></span></code></pre>\n<p class=\"markdown-para\">Update the template stanza in the jobspec to use the <code>range</code> action to iterate over each key/value pair in Vault. Since the value being read from Vault is a map, two variables <code>$key</code> and <code>$value</code> can be assigned with the result of each key/value pair, i.e. environment variable and its value. These then get written out with a literal equals sign <code>=</code> between them, with the value being piped through the <code>toJSON</code> function as explained previously:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">destination</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;secrets/file.env</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        env = true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        # read multiple secrets from Vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        data = &lt;&lt;EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{with secret &quot;</span><span class=\"mtk1\">kv/hover/config</span><span class=\"mtk6\">&quot;}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{range $key, $value := .Data.data}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{$key}}={{$value | toJSON}}{{end}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">{{end}}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">EOH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">After this job is deployed, the destination file <code>secrets/file.env</code> will be populated as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">DB_PASSWORDveryverysecretpassword</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">OTHER_DB_PASSWORDanothersecret</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">EMAIL_PROVIDER_API_KEYabc123</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"nomad-cli\" style=\"position:relative;\"><a href=\"#nomad-cli\" aria-label=\"nomad cli permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nomad CLI</h2>\n<p class=\"markdown-para\">This next section contains tips on working with the Nomad CLI. Follow the <a href=\"https://www.nomadproject.io/docs/install\" class=\"markdown-link\">instructions</a> for your OS to install it. Although Nomad does have a Web UI to display jobs, their status, and allocations among many other things, it's usually more convenient to use the CLI to get this information.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"validation\" style=\"position:relative;\"><a href=\"#validation\" aria-label=\"validation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Validation</h3>\n<p class=\"markdown-para\">For a new jobspec file, or if you've made changes to an existing one, you'll want to validate it first, before submitting it to Nomad for deployment. This will provide quick feedback if there are any errors in the file.</p>\n<p class=\"markdown-para\">For example, given the following jobspec:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># example.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;us-west-1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">type</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;service&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;hashicorp/web-frontend&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">ports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;http&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;https&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">It can be validated as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job validate example.nomad</span></span></code></pre>\n<p class=\"markdown-para\">Output from the validate command shows validation passed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Job Warnings:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0 warning(s):</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Job validation successful</span></span></code></pre>\n<p class=\"markdown-para\">As an exercise, we can intentionally break this, suppose the job had specified <code>type = \"services\"</code> instead of <code>service</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># example.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;example&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;us-west-1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">type</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;services&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frontend&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;hashicorp/web-frontend&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">ports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;http&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;https&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">This time the result of running the validation command <code>nomad job validate example.nomad</code> yields an error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Job validation errors:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1 error occurred:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t* Invalid job type: &quot;services&quot;</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"allocation-status\" style=\"position:relative;\"><a href=\"#allocation-status\" aria-label=\"allocation status permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Allocation Status</h3>\n<p class=\"markdown-para\">After deploying a job (<code>nomad job run /path/to/jobspec_file</code>), the output of this command may indicate that it's complete, but it's possible that some tasks may have failed to start. In order to get more insight into this, you'll want to query the job and <em class=\"markdown-emphasis\">allocation</em> status.</p>\n<p class=\"markdown-para\">Before showing the CLI command for allocation status, let's take a brief detour to define it. An allocation is how Nomad declares that some tasks in a given job should be run on a particular node, aka Nomad client machine.</p>\n<p class=\"markdown-para\">All of the jobspec examples so far have shown a single task, but you can actually have multiple tasks within a group, and multiple groups within a job. Putting multiple tasks within the same group tells Nomad that you want all those tasks running on the same Nomad client machine. Having one task per group and multiple groups within a job tells Nomad that it's free to allocate each task group to separate Nomad clients (although it could still choose to allocate them to the same client, pending resource utilization).</p>\n<p class=\"markdown-para\">For example, suppose you submit the following jobspec to run a Rails app including 3 Puma servers and Sidekiq for background job processing:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># railsapp.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;rails-app&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;us-west-1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">type</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;service&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;web&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">count</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;puma&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec puma&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;background&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;sidekiq&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;bundle exec sidekiq&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">After submitting the job via <code>nomad job run railsapp.nomad</code>, the console output will show that submission is complete. But to check whether things are actually working, first check the job status:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job status rails-app</span></span></code></pre>\n<p class=\"markdown-para\">The last portion of this output will show the allocations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Allocations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ID        Node ID   Task Group  Version  Desired  Status   Created   Modified</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">dac34c14  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">df7e2471  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">26002bd0  2008ce70  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fa2b2ed6  4163a6ca  background   1       run      running  1d6h ago  1d6h ago</span></span></code></pre>\n<p class=\"markdown-para\">There are 4 allocations - 3 are for the <code>web</code> group because the jobspec indicated a <code>count</code> property of 3 for these, and 1 for the <code>background</code> group because this jobspec only indicated 1 sidekiq process (the <code>count</code> property defaults to 1).</p>\n<p class=\"markdown-para\">In the previous example, all allocations were successfully started, but sometimes you may see the status as <code>failed</code>. In this case, you can inspect the allocation to investigate by passing the allocation ID (first column of previous output) to the <code>nomad alloc status</code> command. For example, to inspect the first <code>web</code> allocation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad alloc status dac34c14</span></span></code></pre>\n<p class=\"markdown-para\">The output will include events that happened during this allocation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Task &quot;puma&quot; is &quot;running&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Task Events:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Started At     = 2021-12-17T19:28:21Z</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Finished At    = N/A</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Total Restarts = 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Last Restart   = N/A</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Recent Events:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Time                       Type        Description</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-17T14:28:21-05:00  Started     Task started by client</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-17T14:28:19-05:00  Driver      Downloading image</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-17T14:28:18-05:00  Task Setup  Building Task Directory</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-17T14:28:14-05:00  Received    Task received by client</span></span></code></pre>\n<p class=\"markdown-para\">If something went wrong such as the Nomad client could not download the Docker image, the error would be shown in the events.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Bonus:</strong> The Nomad CLI supports tab completion. Simply run <code>nomad -autocomplete-install</code> to enable it.</p>\n<p class=\"markdown-para\">For example, given a list of allocations displayed from the <code>nomad status rails-app</code> command:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Allocations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ID        Node ID   Task Group  Version  Desired  Status   Created   Modified</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">dac34c14  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">df7e2471  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">26002bd0  2008ce70  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fa2b2ed6  4163a6ca  background   1       run      running  1d6h ago  1d6h ago</span></span></code></pre>\n<p class=\"markdown-para\">You can type in <code>nomad alloc status da{TAB}</code> and Nomad will fill in the allocation ID to complete the command.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"run-a-shell-in-container\" style=\"position:relative;\"><a href=\"#run-a-shell-in-container\" aria-label=\"run a shell in container permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Run a shell in container</h3>\n<p class=\"markdown-para\">Sometimes you'll want to shell into a running container to troubleshoot something. For example, to check whether the expected environment variables were properly populated from Vault secrets, or whether you can ping a certain host if having some networking issues. This can be done with the <code>nomad alloc exec</code> command, passing in the task name and allocation id.</p>\n<p class=\"markdown-para\">To launch a shell in the sidekiq container from the previous example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task sidekiq fa2b2ed6 /bin/bash</span></span></span></code></pre>\n<p class=\"markdown-para\">Tab completion still works here for the allocation ID.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"run-a-command-in-container\" style=\"position:relative;\"><a href=\"#run-a-command-in-container\" aria-label=\"run a command in container permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Run a command in container</h3>\n<p class=\"markdown-para\">Taking it one step further, you might want to run a specific command from a shell in the container. For example, with a Rails app, a common troubleshooting technique is to launch a Rails console and run some application code.</p>\n<p class=\"markdown-para\">The two step way to do this is to run a shell as before, then type in your command from within the shell, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task puma fa2b2ed6 /bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">root@725b3752ada5: bundle </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> rails c</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># do rails console things...</span></span></span></code></pre>\n<p class=\"markdown-para\">Shorten this to one step with the <code>-c</code> flag to pass a command to the shell:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task puma fa2b2ed6 /bin/bash -c </span><span class=\"mtk6\">&quot;bundle exec rails c&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Tab completion still works here for the allocation ID.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"node-status\" style=\"position:relative;\"><a href=\"#node-status\" aria-label=\"node status permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Node Status</h3>\n<p class=\"markdown-para\">Recall the list of allocations that were displayed from the <code>nomad job status rails-app</code> command:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Allocations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ID        Node ID   Task Group  Version  Desired  Status   Created   Modified</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">dac34c14  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">df7e2471  4163a6ca  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">26002bd0  2008ce70  web          1       run      running  1d6h ago  1d6h ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">fa2b2ed6  4163a6ca  background   1       run      running  1d6h ago  1d6h ago</span></span></code></pre>\n<p class=\"markdown-para\">We've been looking at the allocations, but you can also get more information about the node (aka Nomad client machine) that the allocation is running on. This is done by passing the Node ID (second column in the Allocations table) to the <code>nomad node status</code> command. In the above table, we can see that two of the <code>web</code> task groups and the <code>background</code> group are running on the same node, whereas the third <code>web</code> group got allocated to a different node.</p>\n<p class=\"markdown-para\">To get information about the node that's running the two web and background groups:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad node status 4163a6ca</span></span></code></pre>\n<p class=\"markdown-para\">This displays a lot of output, just going to highlight a few things. The Node Events can be useful for troubleshooting, for example if the node is no longer able to connect to the docker daemon. In the example below, it was able to recover:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Node Events</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Time                  Subsystem       Message</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-06T18:49:11Z  Cluster         Node re-registered</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-06T18:42:08Z  Cluster         Node heartbeat missed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-03T23:07:31Z  Driver: docker  Healthy</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2021-12-03T23:04:01Z  Driver: docker  Failed to connect to docker daemon</span></span></code></pre>\n<p class=\"markdown-para\">The output also shows cpu and memory resources that are allocated on this node and how much is currently being used:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Allocated Resources</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CPU              Memory         Disk</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">36988/36784 MHz  32 GiB/31 GiB  2.1 GiB/93 GiB</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Host Resource Utilization</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">CPU            Memory          Disk</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">889/36784 MHz  4.8 GiB/31 GiB  110 MiB/98 GiB</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"job-version---whats-changed\" style=\"position:relative;\"><a href=\"#job-version---whats-changed\" aria-label=\"job version   whats changed permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Job Version - What's Changed?</h3>\n<p class=\"markdown-para\">Every time you run <code>nomad job run /path/to/jobspec</code>, Nomad will create a new version of the job. It can be useful to know what was changed between versions.</p>\n<p class=\"markdown-para\">The following command will display the complete version history for a job:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job history -p job_name</span></span></code></pre>\n<p class=\"markdown-para\">However, if there have been a lot of deploys, the output of this can be too verbose. It's also possible to get history for just one specific version number, which will show the diff between that version and the previous version.</p>\n<p class=\"markdown-para\">For example, the <code>rails-app</code> job from the previous section has 50 versions. To see the difference between version 50 and 49 that came before it:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job history -version 50 -p rails-app</span></span></code></pre>\n<p class=\"markdown-para\">The sample output below shows that the <code>sidekiq</code> task in the <code>background</code> group had its memory increased from 2GB to 8GB:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Version     = 50</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Stable      = true</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Submit Date = 2021-12-17T14:27:22-05:00</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Diff        =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+/- Job: &quot;rails-app&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+/- Task Group: &quot;background&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  +/- Task: &quot;sidekiq&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    +/- Resources {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      +/- MemoryMB:    &quot;2048&quot; =&gt; &quot;8192&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          MemoryMaxMB: &quot;0&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"aliases-and-bash-functions\" style=\"position:relative;\"><a href=\"#aliases-and-bash-functions\" aria-label=\"aliases and bash functions permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Aliases and Bash Functions</h3>\n<p class=\"markdown-para\">Here are a few aliases and shell functions I use to save myself typing for the most frequently run Nomad CLI commands.</p>\n<p class=\"markdown-para\">Get status for the main web app <code>rails-app</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># change the alias value for something easy to remember for your job</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">alias</span><span class=\"mtk1\"> nsra=</span><span class=\"mtk6\">&quot;nomad status rails-app&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Get allocation status:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># usage nas {alloc id}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">alias</span><span class=\"mtk1\"> nas=</span><span class=\"mtk6\">&quot;nomad alloc status&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Tab complete will work with the alias, for example, if first few characters of the allocation ID are <code>4d</code>, then type: <code>nas 4d{TAB}</code></p>\n<p class=\"markdown-para\">The other commands I use most frequently are to run a shell, and Rails console in a container. An alias won't work here as the allocation ID occurs in the middle of the command, and AFAIK, aliases don't support variables. However, this can be solved with shell functions.</p>\n<p class=\"markdown-para\">Add the following functions to your bash or zsh profile. Replace the task names with the values from your jobspec file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run bash in the Nomad puma container specified by allocation id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Usage: nab alloc_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">nab</span><span class=\"mtk1\"> () { nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task puma $@ /bin/bash }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run a Rails console in the Nomad puma container specified by allocation id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Usage: nrc alloc_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">nrc</span><span class=\"mtk1\"> () { nomad alloc </span><span class=\"mtk9\">exec</span><span class=\"mtk1\"> -i -t -task puma $@ /bin/bash -c </span><span class=\"mtk6\">&quot;bundle exec rails c&quot;</span><span class=\"mtk1\"> }</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"easily-switch-between-namespaces\" style=\"position:relative;\"><a href=\"#easily-switch-between-namespaces\" aria-label=\"easily switch between namespaces permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Easily switch between Namespaces</h3>\n<p class=\"markdown-para\">When running Nomad CLI commands from a laptop and connecting to a remote Nomad cluster, there are a number of environment variables that must be specified. These include:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><code>NOMAD_NAMESPACE</code>: Namespace to limit commands to, for example, our team uses: <code>dev</code>, <code>staging</code>, and <code>prod</code>.</li>\n<li class=\"markdown-list-item\"><code>NOMAD_ADDR</code>: Address of the machine where Nomad server is running. For our installation, this varies by namespace.</li>\n<li class=\"markdown-list-item\"><code>NOMAD_TOKEN</code>: ACL token to authenticate API requests. For our setup, this also varies by namespace.</li>\n</ul>\n<p class=\"markdown-para\">When using multiple namespaces and having to switch between them, it's tedious to have to remember to modify one's profile to ensure the correct set of environment variables are exported.</p>\n<p class=\"markdown-para\"><a href=\"https://direnv.net/\" class=\"markdown-link\">direnv</a> is a shell extension that makes this more convenient. It will load/unload environment variables based on presence of a <code>.envrc</code> file in the current directory. Here's how I've organized to support easily switching between our dev, staging, and prod environments.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad-env</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ dev</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â””â”€â”€ .envrc</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”œâ”€â”€ staging</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â”‚Â Â  â””â”€â”€ .envrc</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">â””â”€â”€ prod</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â””â”€â”€ .envrc</span></span></code></pre>\n<p class=\"markdown-para\">Where each .envrc file contains:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_ADDR=https://nomad-server-url (for the current env)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_TOKEN=acl_token (for the current env)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_NAMESPACE=dev (or staging or prod)</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nNote that direnv is not Nomad specific. This tool can be used anywhere you need to easily switch between sets of environment variables.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered a number of useful tips for working with Nomad including working with the jobspec HCL file and making use of the Nomad CLI. Here are some resources for further reading and bookmarking if you're going to be using Nomad:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://www.nomadproject.io/docs/job-specification\" class=\"markdown-link\">Job Specification</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.nomadproject.io/docs/commands\" class=\"markdown-link\">Command Line Reference</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.nomadproject.io/docs/runtime/environment\" class=\"markdown-link\">Environment Variables</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://github.com/angrycub/nomad_example_jobs\" class=\"markdown-link\">Github Repo with Numerous Example Jobs</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/nomad-tips-and-tricks/"}}}]}},"pageContext":{}},
    "staticQueryHashes": ["163244226"]}