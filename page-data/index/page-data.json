{
    "componentChunkName": "component---src-pages-index-js",
    "path": "/",
    "result": {"data":{"allMarkdownRemark":{"totalCount":41,"edges":[{"node":{"id":"c92d7f13-ff75-5632-be8c-e9b5ff992ddc","frontmatter":{"title":"Rails Feature Test Solved by Regex","date":"November 2021","category":"rails"},"excerpt":"If you’ve been programming for awhile, you’ve probably encountered regular expressions, and more specifically, this saying: Some people…","html":"<p class=\"markdown-para\">If you’ve been programming for awhile, you’ve probably encountered regular expressions, and more specifically, this saying:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Some people, when confronted with a problem, think “I know, I'll use regular expressions.” Now they have two problems.</p>\n</blockquote>\n<p class=\"markdown-para\">There's some discussion as to the origin of this saying <a href=\"http://regex.info/blog/2006-09-15/247\" class=\"markdown-link\">here</a>. Personally, I approach the use of regular expressions (aka regex) in my code with some trepidation, as they can be difficult to read, and I prefer to leave clean, easy to read code for the future developers (including myself) who will maintain the code.</p>\n<p class=\"markdown-para\">However, sometimes it is the optimal choice. This post will walk through an example, where using a regex was useful in expressing an expectation in a feature test for a Rails project, plus a nice Ruby way of writing the regex that makes it easier to read.</p>\n<h2 class=\"markdown-subtitle\" id=\"The-Problem\" style=\"position:relative;\"><a href=\"#The-Problem\" aria-label=\"The Problem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Problem</h2>\n<p class=\"markdown-para\">The application I’m working on allows users to setup multi-factor authentication. The last screen of the setup displays a recovery code that the user can enter in the event that they get locked out of their account. This code is a series of 16 randomly generated numbers and letters, displayed in chunks of 4, each separated by a space for legibility. Here's a sample recovery code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">1f08 6a11 b093 8fd6</span></span></code></pre>\n<p class=\"markdown-para\">After a PR got merged that made some changes to the multi-factor flow, a bug was introduced where the recovery code was no longer being displayed. The user would still get the screen instructing them to save the recovery code, but where the code should be displayed was a blank.</p>\n<p class=\"markdown-para\">Investigation revealed that the recovery code was still being generated by the server, but a UI bug was preventing it from being displayed. The fix was straightforward, however, this application has a very thorough suite of feature tests and I was surprised that one of the tests had not caught this bug.</p>\n<h2 class=\"markdown-subtitle\" id=\"Feature-Test\" style=\"position:relative;\"><a href=\"#Feature-Test\" aria-label=\"Feature Test permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Feature Test</h2>\n<p class=\"markdown-para\">Turns out there was a feature test that runs through the multi-factor auth steps, but it only verified that the user landed on the recovery screen by verifying the page title. It did not verify that the recovery code was actually displayed. As part of fixing this bug, this test had to be enhanced to also verify the display of the recovery code.</p>\n<p class=\"markdown-para\">Here is a portion of the markup that displays the recovery code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;Code: &lt;</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;1f08 6a11 b093 8fd6&lt;/</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;&lt;/</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">To make it easier to test, I first added a <code>data-test</code> attribute to the element containing the recovery code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;Code: &lt;</span><span class=\"mtk7\">strong</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-test</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;recovery-code&quot;</span><span class=\"mtk1\">&gt;1f08 6a11 b093 8fd6&lt;/</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;&lt;/</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Next I needed to add a step to the feature test to retrieve the element containing the recovery code by <code>data-test</code> selector and verify its contents. Capybara's <a href=\"https://github.com/teamcapybara/capybara#querying\" class=\"markdown-link\">have_selector</a> RSpec matcher is useful for finding an element by selector and text value. For example, given the following markup:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-test</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;message&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Hello</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">A feature test could select this element and verify its contents as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">expect(page).to have_selector(</span><span class=\"mtk6\">&quot;div[data-test=&#39;message&#39;]&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Hello&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Regex\" style=\"position:relative;\"><a href=\"#Regex\" aria-label=\"Regex permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Regex</h2>\n<p class=\"markdown-para\">In the case of the recovery code, the text value is randomly generated so it won’t work to have a static value in the text option for the <code>have_selector</code> matcher. What's needed is a way to express: The recovery code should look like 4 alpha numeric characters, followed by a space, followed by 4 more alpha numeric characters, and so on. This is where a regex is a good solution. It turns out, the text option of Capybara's <code>have_selector</code> also accepts a regular expression. So the test to verify that the recovery code is displayed needs to look something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This expectation will pass if the string in element recovery-code matches the regex /TBD/.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">expect(page).to have_selector(</span><span class=\"mtk6\">&quot;strong[data-test=&#39;recovery-code&#39;]&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/TBD/</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIt's not obvious from the Capybara docs that there even is a text option or that it also accepts a regex. This Stackoverflow Q&A goes through the source to determine the <a class=\"markdown-link\" href=\"https://stackoverflow.com/questions/23961636/what-are-the-options-to-capybaras-have-selector\">supported options</a>.\n</aside>\n<p class=\"markdown-para\">To match the recovery code accurately, the regex needs to match on any 4 letters or numbers, followed by a space, followed by any 4 letters or numbers, up to 4 chunks of these. To match any letter or number the <code>\\w</code> shorthand can be used, which is equivalent to <code>[0-9a-zA-Z_]</code>. To specify 4 of these, the range repetition syntax <code>{n}</code> can be used. For example to specify 4 characters in a row: <code>\\w{4}</code>. To match the whitespace, <code>\\s</code> is used. Putting this all together:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">expect(page).to have_selector(</span><span class=\"mtk6\">&quot;strong[data-test=&#39;recovery-code&#39;]&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/</span><span class=\"mtk4\">\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk6\">/</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">While this works, it's difficult to read. Fortunately, Ruby has an alternate syntax for specifying a regex that is not whitespace sensitive. To use it, wrap the regex in <code>%r{...}</code> instead of <code>/.../</code>, then add the <code>x</code> modifier which makes it ignore whitespace. This allows the regex to be split up among multiple lines, and it can even have comments beside each line. So the previous line can be rewritten as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">recovery_code_format </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">%r{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  </span><span class=\"mtk4\">\\w</span><span class=\"mtk6\">{</span><span class=\"mtk4\">4</span><span class=\"mtk1\">}     </span><span class=\"mtk3\"># Any 4 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\s        </span><span class=\"mtk3\"># Whitespace character</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\w{</span><span class=\"mtk4\">4</span><span class=\"mtk1\">}     </span><span class=\"mtk3\"># Any 4 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\s        </span><span class=\"mtk3\"># Whitespace character</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\w{</span><span class=\"mtk4\">4</span><span class=\"mtk1\">}     </span><span class=\"mtk3\"># Any 4 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\s        </span><span class=\"mtk3\"># Whitespace character</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\w{</span><span class=\"mtk4\">4</span><span class=\"mtk1\">}     </span><span class=\"mtk3\"># Any 4 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">expect(page).to have_selector(</span><span class=\"mtk6\">&quot;strong[data-test=&#39;recovery-code&#39;]&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> recovery_code_format)</span></span></span></code></pre>\n<p class=\"markdown-para\">This is much more legible and easier to maintain should the recovery code format change in the future.</p>\n<aside class=\"markdown-aside\">\nIt's beyond the scope of this post to go in depth on regex in Ruby. See this excellent <a class=\"markdown-link\" href=\"https://www.rubyguides.com/2015/06/ruby-regex/\">guide</a> for more on this topic.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"Interactive-Regex\" style=\"position:relative;\"><a href=\"#Interactive-Regex\" aria-label=\"Interactive Regex permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Interactive Regex</h2>\n<p class=\"markdown-para\">Unless you're writing regex's constantly, it's unlikely your first attempt will be correct. In the example covered in this post, it's being used as part of a Capybara feature test. Since feature tests are slower to run, it will take a relatively long time to get feedback on if the regex is working.</p>\n<p class=\"markdown-para\">To speed things up, launch a Rails or IRB console to try out the regex interactively, using the <code>=~</code> operator to determine if a regex matches a string. This operator returns the index occurrence of the first match or <code>nil</code> if there is no match. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">001</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> recovery_code </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;1f08 6a11 b093 8fd6&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">002</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> recovery_code </span><span class=\"mtk7\">=~</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/</span><span class=\"mtk4\">\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk6\">/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">0</span><span class=\"mtk1\">   </span><span class=\"mtk3\"># This means a match was found at position 0 of recovery_code.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># test some more inputs...</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Conclusion\" style=\"position:relative;\"><a href=\"#Conclusion\" aria-label=\"Conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered a use case for regex in a Capybara feature test for Rails, how to make it legible, and how to try it out in the console to get quick feedback.</p>\n<h2 class=\"markdown-subtitle\" id=\"Related-Content\" style=\"position:relative;\"><a href=\"#Related-Content\" aria-label=\"Related Content permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Related Content</h2>\n<p class=\"markdown-para\">The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p class=\"markdown-para\">Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\" class=\"markdown-link\">Agile Web Development with Rails 6</a>.</p>\n<p class=\"markdown-para\">Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\" class=\"markdown-link\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p class=\"markdown-para\">Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\" class=\"markdown-link\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p class=\"markdown-para\">Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\" class=\"markdown-link\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-feature-test-solved-regex/"}}},{"node":{"id":"d472ffdd-c948-5d9f-b7cc-11a60dd52f15","frontmatter":{"title":"Build a CI/CD Pipeline for a Gatsby Site","date":"October 2021","category":"gatsby"},"excerpt":"This post will walk through how to set up a CI/CD (Continuous Integration and Continuous Deployment) pipeline for a Gatsby site. Let's start…","html":"<p class=\"markdown-para\">This post will walk through how to set up a CI/CD (Continuous Integration and Continuous Deployment) pipeline for a Gatsby site. Let's start with a definition from <a href=\"https://en.wikipedia.org/wiki/CI/CD\" class=\"markdown-link\">Wikipedia</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">In software engineering, CI/CD is the combined practices of continuous integration (CI) and either continuous delivery or continuous deployment (CD). CI/CD bridges the gaps between development and operation activities and teams by enforcing automation in building, testing and deployment of applications.</p>\n</blockquote>\n<p class=\"markdown-para\">Why would something like this be needed for a blog? This blog is built with Gatsby, with the posts being written in Markdown, and deployed to static <a href=\"https://guides.github.com/features/pages/\" class=\"markdown-link\">Github Pages</a>. A relatively simple workflow, and yet, it takes some non-trivial amount of time and manual effort to publish each article as it's ready. Once an article is finished, there's a sense of \"phew, got that done, time to share it with the world\", but going through manual effort to deploy is no fun.</p>\n<p class=\"markdown-para\">This is where a CI/CD pipeline can save the day. The idea is to automate all the steps that are currently being done manually and trigger this automation at an appropriate point in the workflow, such as when a branch gets merged to the main line. Often, the initial effort to setup this automation will be greater than the amount of time it takes to do one or even several manual deploys. However, over time, the automation wins out. Think of this as an investment of your time now, to save time in the future.</p>\n<h2 class=\"markdown-subtitle\" id=\"Identify-the-Steps\" style=\"position:relative;\"><a href=\"#Identify-the-Steps\" aria-label=\"Identify the Steps permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Identify the Steps</h2>\n<p class=\"markdown-para\">First part in building an automated pipeline is to identify the steps that are currently being done manually, then they can be automated one by one. Here are the steps involved in publishing an article on this blog:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Merge the PR containing the finished article to <code>main</code> (and any other changes that may have been needed, for example, may have identified a css change to improve spacing on article pages).</li>\n<li class=\"markdown-list-item\">Pull the latest <code>main</code> branch (which now contains recently merged article) to my local dev environment.</li>\n<li class=\"markdown-list-item\">Run the <a href=\"../gatsby-unit-testing\" class=\"markdown-link\">unit tests</a> and make sure the entire suite is passing. (Even though the tests were run on the branch when writing the article, it's critical to run them after merging in case a bug gets introduced as a result of the merge).</li>\n<li class=\"markdown-list-item\">If the tests fail, stop and investigate. The remaining steps should <em class=\"markdown-emphasis\">only</em> be performed if the tests pass.</li>\n<li class=\"markdown-list-item\">Run the production Gatsby build to generate the optimized bundles for serving the production site.</li>\n<li class=\"markdown-list-item\">Deploy the production build to Github Pages.</li>\n<li class=\"markdown-list-item\">Ingest the markdown content as documents to the <a href=\"../roll-your-own-search-service-for-gatsby-part5\" class=\"markdown-link\">search service</a> using Heroku's <code>pg:psql</code> command.</li>\n</ol>\n<h2 class=\"markdown-subtitle\" id=\"Choose-an-Automation-Tool\" style=\"position:relative;\"><a href=\"#Choose-an-Automation-Tool\" aria-label=\"Choose an Automation Tool permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Choose an Automation Tool</h2>\n<p class=\"markdown-para\">Next step in building a pipeline is to choose a tool to perform the actions that have been identified in the previous step. There are many to choose from including <a href=\"https://www.travis-ci.com/\" class=\"markdown-link\">Travis CI</a>, <a href=\"https://circleci.com/\" class=\"markdown-link\">Circle CI</a>, <a href=\"https://www.jenkins.io/\" class=\"markdown-link\">Jenkins</a>, and many more.</p>\n<p class=\"markdown-para\">For side projects, I used to reach for Travis or Circle CI, but ever since the introduction of <a href=\"https://github.com/features/actions\" class=\"markdown-link\">Github Actions</a>, that has become my go to solution for any automation required on Github projects. It's a nice choice because it integrates with Github seamlessly, (as it's built by the same company) and there's no need to authorize a third party application to your Github account.</p>\n<p class=\"markdown-para\">The remainder of this post assumes some working knowledge of Github Actions, if you haven't used it before, checkout the <a href=\"https://docs.github.com/en/actions/quickstart\" class=\"markdown-link\">Quickstart Guide</a>.</p>\n<h2 class=\"markdown-subtitle\" id=\"Continuous-Integration\" style=\"position:relative;\"><a href=\"#Continuous-Integration\" aria-label=\"Continuous Integration permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continuous Integration</h2>\n<p class=\"markdown-para\">Let's start with the \"CI\" part of the process. This should run on every commit, every branch, to ensure the site can build and the tests are passing. This is to provide feedback as early as possible if a bug has been introduced.</p>\n<p class=\"markdown-para\">To get this going with Github Actions, add a <code>.github/workflows</code> directory in the root of your project. Then add a file named <code>ci.yml</code> in this directory. It can be named anything, just choose a name that is descriptive as to what this workflow does.</p>\n<p class=\"markdown-para\">Since this workflow should run on every branch and every commit that gets pushed, the <code>on: push</code> trigger will be used. Workflows run on Github Action runners (specified in the <code>runs-on</code> instruction). Keep in mind that unlike a local development environment, these are starting \"fresh\" each time. This means any dependencies needed by the site such as Node.js and npm packages defined in <code>package.json</code> will need to be installed.</p>\n<p class=\"markdown-para\">Here is the continuous integration workflow used on this blog, with annotations to explain each step. Steps with <code>uses</code> are referring to pre-built actions that are available in the <a href=\"https://github.com/marketplace?type=actions\" class=\"markdown-link\">Actions Marketplace</a>. The other steps are running commands exactly as specified on the runner machine:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run this workflow on any push to any branch.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">push</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># A workflow can have one or more jobs.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This workflow has just a single job named `ci`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ci</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Run this job on a Github hosted action runner with the latest version of ubuntu installed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># A job has one or more steps.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Checkout the project source files to the Github Action runner.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># This is roughly equivalent to running `git checkout`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Install the version of Node.js used by project.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup node</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-node@v2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">node-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;14&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">cache</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;npm&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Install package dependencies as defined in package.json file in root of project.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Run `gatsby build`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm run build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Run the Jest unit tests and generate a coverage report.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm test -- --coverage</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Continuous-Deployment-When\" style=\"position:relative;\"><a href=\"#Continuous-Deployment-When\" aria-label=\"Continuous Deployment When permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continuous Deployment: When</h2>\n<p class=\"markdown-para\">This part needs careful consideration because it will deploy new code to production. The first thing to think about is <em class=\"markdown-emphasis\">when</em> should it run. Clearly the simple <code>on: push</code> trigger used for the CI workflow would not be suitable as we don't want just any work-in-progress branch getting deployed.</p>\n<p class=\"markdown-para\">One solution is to use a trigger filter to limit which branches a workflow will run on. For example, to indicate that a given workflow should only run when commits are pushed to the <code>main</code> branch:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/cd.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">push</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">main</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># steps to build and deploy the site...</span></span></span></code></pre>\n<p class=\"markdown-para\">Given that the only way code should get pushed to <code>main</code> is when an approved PR (Pull Request) is merged (either via merge commit or squash &#x26; merge), the above workflow trigger would ensure that a deploy only goes out when a PR is merged.</p>\n<aside class=\"markdown-aside\">\nPreventing direct pushes to the default branch can be controlled using Github's <a class=\"markdown-link\" href=\"https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/defining-the-mergeability-of-pull-requests/managing-a-branch-protection-rule\">branch protection rules</a>.\n</aside>\n<p class=\"markdown-para\">However, even if the project is configured to not allow commits to be pushed directly to <code>main</code>, there's still a problem. What if the tests fail on <code>main</code> as a result of the merge commit (or squash/merge) from the PR? Recall that since the CI workflow has trigger <code>on: push</code>, it will also run when a PR gets merged to <code>main</code>. Even though the tests would have run on the branch that got merged, there's a chance that something goes wrong as a result of the merge and tests fail on <code>main</code>. In this case, the deploy should not run.</p>\n<p class=\"markdown-para\">So what we want to express is: \"Only run this workflow on the main branch, and <em class=\"markdown-emphasis\">after</em> continuous integration has completed successfully on the main branch.\" The way to express this with Github Actions is to use the <a href=\"https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows#workflow_run\" class=\"markdown-link\">workflow_run</a> trigger, which allows one workflow to be dependent on another.</p>\n<p class=\"markdown-para\">For example, to indicate that the CD workflow should only run on the <code>main</code> branch, after the CI workflow has completed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/cd.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">workflow_run</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">workflows</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;CI&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">main</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">types</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">completed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># steps to build and deploy the site...</span></span></span></code></pre>\n<p class=\"markdown-para\">However, there's still one more complication to deal with, <code>completed</code> just means the workflow finished, it does not mean it was successful. i.e. it would run even if the tests in the <code>CI</code> workflow failed. Unfortunately, there's no <code>type</code> keyword to indicate completed successfully, however, the result of the workflow run is available in the <a href=\"https://docs.github.com/en/actions/learn-github-actions/contexts\" class=\"markdown-link\">github context</a> and can be used in an <code>if</code> expression as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/cd.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">workflow_run</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">workflows</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;CI&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">main</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">types</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">completed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ github.event.workflow_run.conclusion == &#39;success&#39; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># steps to build and deploy the site...</span></span></span></code></pre>\n<p class=\"markdown-para\">Putting it all together, the above workflow says: Kick off the <code>CD</code> workflow  on the <code>main</code> branch, after the <code>CI</code> workflow has completed on the <code>main</code> branch, but only run the <code>deploy</code> job if the <code>CI</code> workflow completed successfully.</p>\n<aside class=\"markdown-aside\">\nIt seems awkward to implement \"If workflow A is successful, then run workflow B\" in two different portions of the workflow file. First in the workflow_run -> types section, and second as an if condition in the job. At the time of this writing, this is the only way I could find to do it. I would imagine as Github Actions matures, there will eventually be a more succinct way to express this.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"Continuous-Deployment-Steps\" style=\"position:relative;\"><a href=\"#Continuous-Deployment-Steps\" aria-label=\"Continuous Deployment Steps permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continuous Deployment: Steps</h2>\n<p class=\"markdown-para\">Now that the \"when\" part of continuous deployment has been defined, it's time to automate it by scripting all the manual steps into the workflow file. For this blog, it needs some of the same steps as CI (checkout out project source, installing dependencies and running the production build), and then it needs a few other specific steps including generating an <code>.env</code> file for production, deploying to Github Pages, and finally ingesting the markdown documents to a <a href=\"../roll-your-own-search-service-for-gatsby-part5\" class=\"markdown-link\">search service</a>.</p>\n<p class=\"markdown-para\">Some of these steps require \"secrets\", that is, values that should not be hard-coded in the workflow file (or anywhere in the source code). Secrets can be added to any Github repository to which you've got admin rights. Click on \"Settings\" from the main repository page on Github, then select the \"Secrets\" option. Then the secret values can be accessed as <code>{{ secrets.MY_SECRET }}</code> in workflow files.</p>\n<p class=\"markdown-para\">Here is the workflow file containing all these steps, with annotations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/cd.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run on main branch after CI workflow has completed on main.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">workflow_run</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">workflows</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;CI&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">main</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">types</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">completed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Only go ahead with the job if CI completed successfully (i.e. tests passed).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ github.event.workflow_run.conclusion == &#39;success&#39; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Checkout project source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Install Node.js dependency</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup node</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-node@v2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">node-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;14&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">cache</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;npm&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Install package.json dependencies</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># A simple bash script to generate the .env file from repository secrets.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># This is to avoid hard-coding urls for services such as analytics and search.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># For production, its important to run this step BEFORE building the site because</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># its a static site, and so environment variables are used at build time rather</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># than run time.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Generate prod env file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">HELLO_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.HELLO_URL }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">SEARCH_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.SEARCH_URL }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">SEARCH_ENABLED</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.SEARCH_ENABLED }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">touch .env.production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">echo HELLO_URL=&quot;$HELLO_URL&quot; &gt;&gt; .env.production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">echo SEARCH_URL=&quot;$SEARCH_URL&quot; &gt;&gt; .env.production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">echo SEARCH_ENABLED=&quot;$SEARCH_ENABLED&quot; &gt;&gt; .env.production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">shell</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Run the production build - this runs: gatsby build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># which generates the &quot;public&quot; directory containing the entire site.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm run build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Use a community action from the Actions Marketplace to deploy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># the &quot;public&quot; directory generated by the build to Github Pages.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Deploy to Github Pages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">peaceiris/actions-gh-pages@v3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">github_token</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.GITHUB_TOKEN }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">publish_dir</span><span class=\"mtk1\">: </span><span class=\"mtk6\">./public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Finally, ingest the search.sql file (also generated by the build)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># into the Heroku database for the application hosting the search service.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Ingest search docs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">HEROKU_APP_NAME</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.HEROKU_APP_NAME }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">HEROKU_API_KEY</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.HEROKU_API_KEY }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">HEROKU_API_KEY=$HEROKU_API_KEY cat search.sql | heroku pg:psql --app $HEROKU_APP_NAME</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">shell</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash</span></span></span></code></pre>\n<p class=\"markdown-para\">Of course your Gatsby site may have some different details. For example, instead of using a custom search service hosted on Heroku, it may be using a commercial service such as Algolia. In that case, it would require researching what are the automation steps to update the search index on Algolia. Or if the site is hosted somewhere other than Github Pages, for example Netlify, it would require some some <a href=\"https://github.com/netlify/actions\" class=\"markdown-link\">automation</a> specific to that platform.</p>\n<h2 class=\"markdown-subtitle\" id=\"Conclusion\" style=\"position:relative;\"><a href=\"#Conclusion\" aria-label=\"Conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has walked through how to think about the process of CI/CD for a Gatsby site. It begins by writing down the current list of manual tasks, figuring out which of these steps need to run when, and setting up Github Action workflows to automate them. It also explained how to use the <code>workflow_run</code> trigger to make one workflow dependent on the success of another. I hope this will serve as an inspiration for others to automate some manual tasks they may be doing on their projects.</p>\n<h2 class=\"markdown-subtitle\" id=\"Related-Content\" style=\"position:relative;\"><a href=\"#Related-Content\" aria-label=\"Related Content permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Related Content</h2>\n<p class=\"markdown-para\">The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p class=\"markdown-para\">Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\" class=\"markdown-link\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p class=\"markdown-para\">Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\" class=\"markdown-link\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p class=\"markdown-para\">Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\" class=\"markdown-link\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<p class=\"markdown-para\">Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\" class=\"markdown-link\">Agile Web Development with Rails 6</a>.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/ci-cd-pipeline-for-gatsby/"}}},{"node":{"id":"0c2e1691-4b14-536c-acee-4d0f120de743","frontmatter":{"title":"Rails Strong Params for GET Request","date":"October 2021","category":"rails"},"excerpt":"If you've been using Rails for a while, you've probably encountered Strong Parameters. This feature was introduced in Rails 4 and is…","html":"<p class=\"markdown-para\">If you've been using Rails for a while, you've probably encountered <a href=\"https://api.rubyonrails.org/v6.1.3/classes/ActionController/StrongParameters.html\" class=\"markdown-link\">Strong Parameters</a>. This feature was introduced in Rails 4 and is intended to prevent mass assignment. The typical use case for this is to protect a POST or PUT/PATCH endpoint, which is invoked when a user submits a form and a controller action tries to create or update the corresponding model.</p>\n<p class=\"markdown-para\">This post will demonstrate how strong params can also be used to protect a GET request. Why would you ever want to do that? I'll get to that in a minute. First, let's look at the typical case for strong params.</p>\n<h2 class=\"markdown-subtitle\" id=\"Typical-Case-POST\" style=\"position:relative;\"><a href=\"#Typical-Case-POST\" aria-label=\"Typical Case POST permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Typical Case: POST</h2>\n<p class=\"markdown-para\">Given an HTML form such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">form</span><span class=\"mtk1\"> </span><span class=\"mtk5\">action</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;/person&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;person[name]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;person_name&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;person[email]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;person_email&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">button</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;submit&quot;</span><span class=\"mtk1\">&gt;Create&lt;/</span><span class=\"mtk7\">button</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">form</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">When the user fills out this form and clicks submit button, it will invoke a <code>POST</code> http action to the <code>/person</code> endpoint, with the following parameters:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;person&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;name&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;fred&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;fred@example.com&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The corresponding <code>PersonController#create</code> method is responsible for creating a new <code>Person</code> model with the <code>name</code> and <code>email</code> properties populated and saving to the database. A naive implementation would look like:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">PeopleController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Person</span><span class=\"mtk1\">.create(params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">But what if a sneaky user modifies the form or uses a REST client to submit an additional parameter that happens to be used internally, but is not intended to be set by a user such as <code>is_admin</code>, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;person&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;name&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;fred&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;fred@example.com&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;is_admin&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;true&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The Rails solution is to use strong parameters to only allow the <code>name</code> and <code>email</code> properties of the form to be saved, rather than passing the entire user generated <code>params</code> to the model create method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">PeopleController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Person</span><span class=\"mtk1\">.create(person_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">person_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.require(</span><span class=\"mtk4\">:person</span><span class=\"mtk1\">).permit(</span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now, any additional parameters submitted to the <code>/person</code> endpoint will be discarded when <code>Person.create</code> is called because the <code>person_params</code> method only allows <code>name</code> and <code>email</code>.</p>\n<h2 class=\"markdown-subtitle\" id=\"Unusual-Case-GET\" style=\"position:relative;\"><a href=\"#Unusual-Case-GET\" aria-label=\"Unusual Case GET permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unusual Case: GET</h2>\n<p class=\"markdown-para\">Consider another case where strong params could be useful. Suppose your application exposes a <code>GET /search?q=something</code> endpoint, but behind the scenes, the actual search action is delegated to a third party service.</p>\n<p class=\"markdown-para\">The search form accepts a search term from the user named <code>q</code>. Since this is a query and doesn't modify any state, the <code>GET</code> method is used.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">form</span><span class=\"mtk1\"> </span><span class=\"mtk5\">action</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;/search&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">method</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;get&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;q&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">button</span><span class=\"mtk1\">&gt;Search&lt;/</span><span class=\"mtk7\">button</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">form</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">The search action is handled by the search controller, which passes on the params given to it to the third party search service to perform the actual search:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SearchController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">ThirdPartySearchService</span><span class=\"mtk1\">.call(params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Where the incoming <code>params</code> look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;q&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;something the user typed into the form&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Since <code>params</code> comes from the user, it would be useful to restrict the fields that get sent to the third party search service to only the expected fields. In this simple example there's only one expected field <code>q</code>.</p>\n<p class=\"markdown-para\">This sounds like a job for strong parameters! But recall the typical example is for protecting a model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">PeopleController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Person</span><span class=\"mtk1\">.create(person_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">person_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.require(</span><span class=\"mtk4\">:person</span><span class=\"mtk1\">).permit(</span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This doesn't seem to be a good fit for a controller handling a <code>GET</code> request because the search controller is not creating or updating a model. Specifically, this line seems like a magic incantation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.require(</span><span class=\"mtk4\">:person</span><span class=\"mtk1\">).permit(</span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">Here we get to the point where as a newcomer to Rails, it's very easy to copy/paste these seemingly magical incantations and as long as your usage is the same as the typical case, it will work just fine. However, sometimes your use case may be a little different, and the copy/paste no longer works. In this case, it requires digging in a little to understand what's going on \"under the hood\" so to speak.</p>\n<h2 class=\"markdown-subtitle\" id=\"TLDR\" style=\"position:relative;\"><a href=\"#TLDR\" aria-label=\"TLDR permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h2>\n<p class=\"markdown-para\">For those that just want the solution real quick, here it is - simply call <code>permit</code> on the params with the single required field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SearchController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">ThirdPartySearchService</span><span class=\"mtk1\">.call(search_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.permit(</span><span class=\"mtk4\">:q</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">To understand why this works, read on...</p>\n<h2 class=\"markdown-subtitle\" id=\"Deeper-Explanation\" style=\"position:relative;\"><a href=\"#Deeper-Explanation\" aria-label=\"Deeper Explanation permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deeper Explanation</h2>\n<p class=\"markdown-para\">To make strong parameters work for the search controller, we need to understand what <code>params</code> is. It appears to be a hash of inputs to the controller, that come from either an HTML form, url, or query parameters.</p>\n<p class=\"markdown-para\">However, it's actually a method that returns an instance of <a href=\"https://api.rubyonrails.org/classes/ActionController/Parameters.html\" class=\"markdown-link\">ActionController::Parameters</a>. This instance is initialized with a hash of the input parameters. It also has methods like <code>require</code> and <code>permit</code> which return new instances of <code>ActionController::Parameters</code> so that's why they can be chained together like <code>params.require(:something).permit(:somefield, :otherfield)</code>.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"require\" style=\"position:relative;\"><a href=\"#require\" aria-label=\"require permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>require</h3>\n<p class=\"markdown-para\">Looking at the api docs for the <a href=\"https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-require\" class=\"markdown-link\">require</a> method, it accepts a key, and returns the value from the hash if the key exists, otherwise it raises <code>ActionController::ParameterMissing</code>. If the value happens to be a hash, then it returns a new instance of <code>ActionController::Parameters</code> initialized with the value. This means that given input parameters to a controller such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;a&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;some value&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;b&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;something else&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;c&quot;</span><span class=\"mtk1\">=&gt;{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;d&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;in a hash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The following could be run in the controller:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.require(</span><span class=\"mtk4\">:a</span><span class=\"mtk1\">)  </span><span class=\"mtk3\"># &quot;some value&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.require(</span><span class=\"mtk4\">:x</span><span class=\"mtk1\">)  </span><span class=\"mtk3\"># *** ActionController::ParameterMissing Exception: param is missing or the value is empty: x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.require(</span><span class=\"mtk4\">:c</span><span class=\"mtk1\">)  </span><span class=\"mtk3\"># &lt;ActionController::Parameters {&quot;d&quot;=&gt;&quot;in a hash&quot;} permitted: false&gt;</span></span></span></code></pre>\n<h3 class=\"markdown-sub-subtitle\" id=\"permit\" style=\"position:relative;\"><a href=\"#permit\" aria-label=\"permit permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>permit</h3>\n<p class=\"markdown-para\">Looking at the api docs for the <a href=\"https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-permit\" class=\"markdown-link\">permit</a> method, it accepts a list of filters, and returns a new instance of <code>ActionController::Parameters</code> containing only fields that were specified in the filters. Carrying on with the a,b,c hash example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># returns new instance of params with ONLY the `b` field</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.permit(</span><span class=\"mtk4\">:b</span><span class=\"mtk1\">)  </span><span class=\"mtk3\"># &lt;ActionController::Parameters {&quot;b&quot;=&gt;&quot;something else&quot;} permitted: true&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Notice that <code>ActionController::Parameters</code> is not tied to a model, it simply operates on a hash. This is why it can be used in any controller, even when not dealing with a model. Also, there's no rule that says you first have to call <code>require</code>, and then chain with <code>permit</code>. You're free to use any combination of these as it suits the use case.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"Solution-Explained\" style=\"position:relative;\"><a href=\"#Solution-Explained\" aria-label=\"Solution Explained permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution Explained</h3>\n<p class=\"markdown-para\">Now getting back to the search controller, in this case, there are no required fields (let's assume the service will do something reasonable like returning a default set of results when not given a query). The only requirement is that the controller should only pass the <code>q</code> field on to the service and nothing else. This is why it calls the <code>permit</code> method on params, specifying the <code>q</code> field, and then passes the resulting new params object to the third party service:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SearchController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">ThirdPartySearchService</span><span class=\"mtk1\">.call(search_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.permit(</span><span class=\"mtk4\">:q</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Conclusion\" style=\"position:relative;\"><a href=\"#Conclusion\" aria-label=\"Conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered the typical use case for strong parameters in Rails and how it can also be used for a non typical case of an http GET request. It also took a deeper dive into some seemingly Rails \"magic\", to explain some methods of controller parameters.</p>\n<h2 class=\"markdown-subtitle\" id=\"Related-Content\" style=\"position:relative;\"><a href=\"#Related-Content\" aria-label=\"Related Content permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Related Content</h2>\n<p class=\"markdown-para\">The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p class=\"markdown-para\">Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\" class=\"markdown-link\">Agile Web Development with Rails 6</a>.</p>\n<p class=\"markdown-para\">Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\" class=\"markdown-link\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p class=\"markdown-para\">Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\" class=\"markdown-link\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p class=\"markdown-para\">Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\" class=\"markdown-link\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-strong-params-get/"}}},{"node":{"id":"7397cada-13e5-52f5-95d5-24ed085f5816","frontmatter":{"title":"Get started with Gatsby and Unit Testing","date":"September 2021","category":"gatsby"},"excerpt":"This post will demonstrate how to add unit tests to a Gatsby project using Jest and react-testing-library. Gatsby is a static site generator…","html":"<p class=\"markdown-para\">This post will demonstrate how to add unit tests to a Gatsby project using Jest and react-testing-library. Gatsby is a static site generator powered by React and GraphQL so the libraries to test it are similar to those used for testing any React project.</p>\n<h2 class=\"markdown-subtitle\" id=\"Why\" style=\"position:relative;\"><a href=\"#Why\" aria-label=\"Why permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why?</h2>\n<p class=\"markdown-para\">Before getting into the mechanics of how to do this, why does a Gatsby site need tests? To answer this, consider a common use case for a Gatsby site - a personal or company blog. For example, this blog was initialized with the <a href=\"https://github.com/gatsbyjs/gatsby-starter-hello-world\" class=\"markdown-link\">Hello World Gatsby starter project</a>. Then I started writing some posts in markdown. Over time I gradually added more features including pagination, SEO, typography with self-hosted google fonts, responsive nav menu for desktop vs mobile layouts, custom analytics, and search.</p>\n<p class=\"markdown-para\">Even for a simple blog site without all these features, it's still valuable to add some basic unit tests to snapshot all the page layouts and components. Then if your blog does have additional features, especially those requiring user interaction such as search, it will be even more valuable to add unit testing to verify the user's interactions with these components.</p>\n<p class=\"markdown-para\">Finally Gatsby can be used for more than just blogging and any site will benefit from at least some basic snapshot tests, and some more complex tests for interactive components or components that have more logic in them than simply rendering a layout.</p>\n<h2 class=\"markdown-subtitle\" id=\"Initial-Setup\" style=\"position:relative;\"><a href=\"#Initial-Setup\" aria-label=\"Initial Setup permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Initial Setup</h2>\n<p class=\"markdown-para\">Start by following the Gatsby <a href=\"https://www.gatsbyjs.com/docs/how-to/testing/unit-testing/\" class=\"markdown-link\">unit testing</a> docs, which explain how to get setup for unit testing including installing the necessary libraries from npm, configuring jest and babel, and setting up some useful mocks.</p>\n<p class=\"markdown-para\">However, rather than installing <code>react-test-renderer</code> as shown in the Gatsby docs, I recommend installing <a href=\"https://testing-library.com/docs/react-testing-library/intro/\" class=\"markdown-link\">React Testing Library</a>. This is because <code>react-test-renderer</code> will only render a component and then you can verify the expected output, but does not support interactivity like clicking a button or entering text into an input box. React Testing Library on the other hand, will provide a lot more flexibility with interaction and querying the DOM.</p>\n<p class=\"markdown-para\">Specifically, instead of <code>react-test-renderer</code>, install these additional libraries:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">npm i @testing-library/jest-dom testing-library/react testing-library/user-event --save-dev</span></span></code></pre>\n<p class=\"markdown-para\">One additional step is to set the jest test environment to <code>jsdom</code>. By default, its set to <code>node</code> and any tests that attempt to query the DOM will fail without this change:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// jest.config.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  testEnvironment: </span><span class=\"mtk6\">&quot;jsdom&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// rest of the config from following Gatsby instructions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Simple-Snapshot-Test\" style=\"position:relative;\"><a href=\"#Simple-Snapshot-Test\" aria-label=\"Simple Snapshot Test permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Simple Snapshot Test</h2>\n<p class=\"markdown-para\">Now that all the testing libraries are installed and configured, it's time to write a simple test. The footer component on my blog simply renders out social links and the copyright:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/footer.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./footer.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { FaTwitter, FaGithub, FaCodepen, FaLinkedinIn } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react-icons/fa&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Footer</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">footer</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;footer&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">p</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.copy</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;All materials © Daniela Baron 2021&lt;/</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.social</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">a</span><span class=\"mtk1\"> </span><span class=\"mtk5\">href</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;https://twitter.com/DanielaMBaron&quot;</span><span class=\"mtk1\">&gt;&lt;</span><span class=\"mtk9 mtki\">FaTwitter</span><span class=\"mtk1\"> /&gt;&lt;/</span><span class=\"mtk7\">a</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">a</span><span class=\"mtk1\"> </span><span class=\"mtk5\">href</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;https://github.com/danielabar&quot;</span><span class=\"mtk1\">&gt;&lt;</span><span class=\"mtk9 mtki\">FaGithub</span><span class=\"mtk1\"> /&gt;&lt;/</span><span class=\"mtk7\">a</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">a</span><span class=\"mtk1\"> </span><span class=\"mtk5\">href</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;https://codepen.io/danielabar&quot;</span><span class=\"mtk1\">&gt;&lt;</span><span class=\"mtk9 mtki\">FaCodepen</span><span class=\"mtk1\"> /&gt;&lt;/</span><span class=\"mtk7\">a</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">a</span><span class=\"mtk1\"> </span><span class=\"mtk5\">href</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;https://www.linkedin.com/in/danielabaron/&quot;</span><span class=\"mtk1\">&gt;&lt;</span><span class=\"mtk9 mtki\">FaLinkedinIn</span><span class=\"mtk1\"> /&gt;&lt;/</span><span class=\"mtk7\">a</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">footer</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Footer</span></span></span></code></pre>\n<p class=\"markdown-para\">Since there's no logic or interactivity in this component, the unit test for it will simply render it using the <code>render</code> function from react testing library, then verify against the snapshot using jest's <code>toMatchSnapshot</code> function:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/footer.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Footer </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./footer&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Footer&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders correctly&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">Footer</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(container).</span><span class=\"mtk5\">toMatchSnapshot</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<p class=\"markdown-para\">See the Jest docs to learn more about <a href=\"https://jestjs.io/docs/snapshot-testing\" class=\"markdown-link\">snapshot testing</a>.</p>\n<h2 class=\"markdown-subtitle\" id=\"Run-Tests\" style=\"position:relative;\"><a href=\"#Run-Tests\" aria-label=\"Run Tests permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Run Tests</h2>\n<p class=\"markdown-para\">The command to run tests in a terminal is simply <code>jest</code>, however, since the jest library is installed in the <code>node_modules</code> of the project, you would have to run it specifying the full path from your project root: <code>node_modules/bin/jest</code>. That's a little tedious to type out each time.  A better way is to add a <code>test</code> entry in the <code>scripts</code> section of the project's <code>package.json</code> file. When running npm scripts, npm will search the projects' local <code>node_modules</code> directory for the binary, saving you the trouble of having to specify the full path:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// package.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;scripts&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;test&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;jest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Now the tests can be run with <code>npm test</code>.</p>\n<h2 class=\"markdown-subtitle\" id=\"Component-with-Props\" style=\"position:relative;\"><a href=\"#Component-with-Props\" aria-label=\"Component with Props permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Component with Props</h2>\n<p class=\"markdown-para\">Let's move on to a slightly more complex component that accepts some props. In the example below, the <code>AllLink</code> component accepts a <code>marginTop</code> prop to control how much space is styled right above it. This component gets rendered in various places throughout my blog and the spacing can vary. Notice the <code>data-testid</code> attribute on the outer element, this will be used later by the test.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/all-link.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./all-link.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">marginTop</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;all-wrapper&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">style</span><span class=\"mtk7\">={</span><span class=\"mtk1\">{ marginTop: marginTop }</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/blog&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.allLink</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      All Articles</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">The test uses the <code>render</code> function from react testing library to render the component, this time with the <code>marginTop</code> prop. To verify that the <code>marginTop</code> prop value was correctly applied as the style, the <code>screen.getByTestId</code> function from react testing library is used. This function accepts a string value such as <code>\"all-wrapper\"</code> and returns the DOM node in the component that has this value set as its <code>data-testid</code> attribute.</p>\n<p class=\"markdown-para\">Then, jest-dom's <a href=\"https://github.com/testing-library/jest-dom#tohavestyle\" class=\"markdown-link\">toHaveStyle</a> matcher is used to verify that the DOM node has a <code>marginTop</code> style of <code>30px</code>, which is what was provided when the test rendered the <code>AllLink</code> component:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/all-link.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> AllLink </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./all-link&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;AllLink&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders correctly&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">AllLink</span><span class=\"mtk1\"> </span><span class=\"mtk5\">marginTop</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;30px&quot;</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> div </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;all-wrapper&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(div).</span><span class=\"mtk5\">toHaveStyle</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;marginTop: 30px&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Component-with-Children\" style=\"position:relative;\"><a href=\"#Component-with-Children\" aria-label=\"Component with Children permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Component with Children</h2>\n<p class=\"markdown-para\">In a typical Gatsby site, there will most likely be a <code>&#x3C;Layout></code> component used by every page to get a consistent look and feel. My <code>&#x3C;Layout></code> component simply renders the <code>&#x3C;Header></code> and <code>&#x3C;Footer></code> components, and then renders the page content in between these using the <code>children</code> prop:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/layout.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./layout.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Header </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./header.js&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Footer </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./footer.js&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">children</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Header</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.content</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">children</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Footer</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">The Layout component test renders the component with some simple content using a <code>data-testid</code> attribute to verify it was rendered. Note that the <code>&#x3C;Header></code> and <code>&#x3C;Footer></code> components are wrapped in DOM nodes with <code>data-testid</code> attributes of <code>header</code> and <code>footer</code> respectively. This makes them easy to find in the <code>Layout</code> component test to verify it did indeed render the Header and Footer components. The easiest way to verify that an element got rendered is to use jest-dom's <a href=\"https://github.com/testing-library/jest-dom#tobeinthedocument\" class=\"markdown-link\">toBeInTheDocument</a> matcher:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/layout.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Layout&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders correctly&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;test-content&quot;</span><span class=\"mtk1\">&gt;test content&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;header&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;test-content&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;footer&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Mocking-Dependencies\" style=\"position:relative;\"><a href=\"#Mocking-Dependencies\" aria-label=\"Mocking Dependencies permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mocking Dependencies</h2>\n<p class=\"markdown-para\">The <code>&#x3C;Header></code> component makes use of a custom <code>useViewport</code> hook to change the navigation menu layout between responsive design (viewport width &#x3C; 640px) and regular (viewport width >= 640px). The <code>useViewport</code> hook returns the current width of the viewport:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/header.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> useViewport </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../hooks/useviewport&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./header.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> NavMenuResponsive </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./nav-menu-responsive&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> NavMenu </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./nav-menu&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Header</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { width } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useViewport</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> breakpoint </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">640</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use result of useViewport hook to determine which navigation component to render</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">menuHelper</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> width </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> breakpoint </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk9 mtki\">NavMenuResponsive</span><span class=\"mtk1\"> /&gt; </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk9 mtki\">NavMenu</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">header</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;header&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.logo</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.profileWrapper</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &lt;</span><span class=\"mtk7\">img</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.profileImg</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">src</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/images/profile.png&quot;</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">alt</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Profile&quot;</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.headerItem</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.title</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            Daniela Baron</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk5\">menuHelper</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">header</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Header</span></span></span></code></pre>\n<p class=\"markdown-para\">To test the <code>&#x3C;Header></code> component, the <code>useViewport</code> hook will need to be mocked out because it depends on the <code>window</code> object which isn't present when unit tests are running (Jest tests run via Node.js, not in a browser).</p>\n<p class=\"markdown-para\">Since the hook is imported from a module, the test will use the <code>jest.mock(...)</code> function to mock out the entire module. Furthermore, a mock function that returns a width is specified as the return result from the <code>default</code> export. Then each test can modify the returned width value and verify the correct version of the navigation menu gets rendered, as well as verifying that the <code>useViewport</code> hook was called.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/header.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> useViewport </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../hooks/useviewport&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Header </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./header&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> mockWidth </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1024</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">jest.</span><span class=\"mtk5\">mock</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;../hooks/useviewport&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> ({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  __esModule: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  default: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> ({ width: mockWidth })),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Header&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">afterEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    jest.</span><span class=\"mtk5\">clearAllMocks</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders nav menu for wide widths&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    mockWidth </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">900</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">Header</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;nav-menu&quot;</span><span class=\"mtk1\">)).toBeInTheDocument</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(useViewport).</span><span class=\"mtk5\">toHaveBeenCalled</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders nav menu responsive for narrow widths&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    mockWidth </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">400</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">Header</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;nav-menu-responsive&quot;</span><span class=\"mtk1\">)).toBeInTheDocument</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(useViewport).</span><span class=\"mtk5\">toHaveBeenCalled</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<p class=\"markdown-para\">This is just one example of Jest mocking, there are many more variations and use cases. Learn more about it <a href=\"https://jestjs.io/docs/mock-functions\" class=\"markdown-link\">here</a>.</p>\n<h2 class=\"markdown-subtitle\" id=\"User-Interaction\" style=\"position:relative;\"><a href=\"#User-Interaction\" aria-label=\"User Interaction permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>User Interaction</h2>\n<p class=\"markdown-para\">The <code>&#x3C;SearchInput></code> component renders an input text box where user can type in a search term. When they hit <kbd class=\"markdown-kbd\">Enter</kbd>, the UI will navigate to the search results for that page at url <code>/search-results/?q=searchTermUserTypedIn</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/search-input.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { navigate } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { MdSearch } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react-icons/md&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./search-input.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> ENTER_KEY </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Enter&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SearchInput</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">eventKey</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">text</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (eventKey </span><span class=\"mtk7\">===</span><span class=\"mtk1\"> ENTER_KEY) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">navigate</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`/search-results/?q=</span><span class=\"mtk7\">${</span><span class=\"mtk1\">text</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.wrapper</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">MdSearch</span><span class=\"mtk1\"> </span><span class=\"mtk5\">size</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;1.7rem&quot;</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">type</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;text&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.search</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;search-input&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">aria-label</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Search&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">placeholder</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Search, eg: Rails&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">onKeyPress</span><span class=\"mtk7\">={</span><span class=\"mtk10 mtki\">event</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span><span class=\"mtk1\">(event.key, event.target.value)</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> SearchInput</span></span></span></code></pre>\n<p class=\"markdown-para\">In order to simulate a user typing into the search input box, the test for this component will use functions from the <a href=\"https://testing-library.com/docs/ecosystem-user-event/\" class=\"markdown-link\">user-event</a> library, which works with react testing library to provide more realistic simulations of browser events.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">WATCH OUT:</strong> Do not attempt to use the <a href=\"https://testing-library.com/docs/dom-testing-library/api-events\" class=\"markdown-link\">fireEvent</a> function from react testing library. Although in theory it should be possible to simulate the correct combination of key press/up/down events using the <code>fireEvent</code> function, in practice I couldn't get it working. Then I read that it's recommended to use the <a href=\"https://testing-library.com/docs/ecosystem-user-event/\" class=\"markdown-link\">user-event</a> library for this purpose and it made everything much easier.</p>\n<p class=\"markdown-para\">Also this test should not attempt to navigate to another page for real as this is just a unit test running in Node.js, not an end-to-end test running in a browser. To avoid real navigation, Gatsby's <code>navigate</code> function is mocked out with a Jest mock function. Since this is universally desired across all the tests, the mock function can be defined in the global <code>__mocks__/gatsby.js</code> file. The first part of this file you should already have from following the <a href=\"https://www.gatsbyjs.com/docs/how-to/testing/unit-testing/\" class=\"markdown-link\">initial setup</a> instructions:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// __mocks__/gatsby.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> gatsby </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> jest.</span><span class=\"mtk5\">requireActual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;gatsby&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span><span class=\"mtk1\">gatsby,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  graphql: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Link: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">().</span><span class=\"mtk5\">mockImplementation</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      activeClassName,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      activeStyle,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      getProps,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      innerRef,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      partiallyActive,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ref,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      replace,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      to,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">...</span><span class=\"mtk1\">rest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }) </span><span class=\"mtk9 mtki\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      React.</span><span class=\"mtk5\">createElement</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;a&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">...</span><span class=\"mtk1\">rest,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        href: to,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// +++ ADD MOCK NAVIGATE FUNCTION HERE +++</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  navigate: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">And here is the test for the <code>&#x3C;SearchInput></code> component. It uses the <code>getByTestId</code> function to locate the text input element, then uses the <code>userEvent.type</code> function to enter some example text into the search box. Finally Jest's <code>toHaveBeenCalledWith</code> function is used to verify the mock version of the <code>navigate</code> function was called after user hit <kbd class=\"markdown-kbd\">Enter</kbd>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { navigate } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> userEvent </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/user-event&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> SearchInput </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./search-input&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;SearchInput&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;navigates to search results on Enter key press&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">SearchInput</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> inputEl </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;search-input&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    userEvent.</span><span class=\"mtk5\">type</span><span class=\"mtk1\">(inputEl, </span><span class=\"mtk6\">&quot;Rails{enter}&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(navigate).</span><span class=\"mtk5\">toHaveBeenCalledWith</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;/search-results/?q=Rails&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<p class=\"markdown-para\">Notice the use of the special control character <code>{enter}</code> to simulate the <kbd class=\"markdown-kbd\">Enter</kbd> key. See the user-event docs for a list of all such <a href=\"https://testing-library.com/docs/ecosystem-user-event/#special-characters\" class=\"markdown-link\">control characters</a>.</p>\n<h2 class=\"markdown-subtitle\" id=\"Meta-Tags\" style=\"position:relative;\"><a href=\"#Meta-Tags\" aria-label=\"Meta Tags permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Meta Tags</h2>\n<p class=\"markdown-para\">Many Gatsby sites will have an <code>&#x3C;SEO></code> component that gets included in every page. It uses a static query to get the site's metadata such as title, description, url, etc. (defined in <code>gatsby-config.js</code>), and also accepts properties to override these. Then it uses <code>react-helmet</code> to output meta tags for site description, image, url, and also the social sharing tags so that nice looking cards can be generated on the various social media platforms when someone shares a link to your site.</p>\n<p class=\"markdown-para\">A full discussion of how to build this component is out of scope for this post as I just want to focus on how to test it, but the Gatsby docs have a step-by-step <a href=\"https://www.gatsbyjs.com/docs/add-seo-component/\" class=\"markdown-link\">guide</a> on how to do this. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/SEO.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Helmet } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react-helmet&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { useStaticQuery, graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SEO</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">title</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">description</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">pathname</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> data </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useStaticQuery</span><span class=\"mtk1\">(</span><span class=\"mtk5\">graphql</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    query SEOQuery {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      site {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        siteMetadata {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          defaultTitle: title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          titleTemplate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          defaultDescription: description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          siteUrl: url</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          defaultImage: image</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  `</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> seo </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    title: title </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> data.site.siteMetadata.defaultTitle,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    description: description </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> data.site.siteMetadata.defaultDescription,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    image: </span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">data.site.siteMetadata.siteUrl</span><span class=\"mtk7\">}${</span><span class=\"mtk1\">image </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> data.site.siteMetadata.defaultImage</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    url: </span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">data.site.siteMetadata.siteUrl</span><span class=\"mtk7\">}${</span><span class=\"mtk1\">pathname </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/&quot;</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Helmet</span><span class=\"mtk1\"> </span><span class=\"mtk5\">title</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">titleTemplate</span><span class=\"mtk7\">={</span><span class=\"mtk1\">data.site.siteMetadata.titleTemplate</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.description</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;image&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.image</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.url </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">property</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;og:url&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.url</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.title </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">property</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;og:title&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.description </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">property</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;og:description&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.description</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.image </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">property</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;og:image&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.image</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;twitter:card&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;summary_large_image&quot;</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.title </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;twitter:title&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.description </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;twitter:description&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.description</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt; </span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.image </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;twitter:image&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.image</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Helmet</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">In order to test this component, the <code>useStaticQuery</code> hook must be mocked out. This is because the build time GraphQL server may not be running when tests are running and unit tests should not have any external dependencies.</p>\n<p class=\"markdown-para\">This can be done in the test, or if there's only one component that uses a static query, the mock can be defined in the global <code>__mocks__/gatsby.js</code>. Unlike the mocked Gatsby <code>navigate</code> function demonstrated earlier, the return result matters because the values will be used to generate the meta tag values, therefore Gatsby's <code>mockImplementation</code> function will be used to have the mock return a result:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// __mocks__/gatsby.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> gatsby </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> jest.</span><span class=\"mtk5\">requireActual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;gatsby&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span><span class=\"mtk1\">gatsby,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other mocks...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// +++ ADD NEW MOCK HERE +++</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  useStaticQuery: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">().</span><span class=\"mtk5\">mockImplementation</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// When component calls useStaticQuery(...), this result will be returned</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      site: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        siteMetadata: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          defaultTitle: </span><span class=\"mtk6\">&quot;Jane Doe Blog&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          titleTemplate: </span><span class=\"mtk6\">&quot;%s · Jane Doe&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          defaultDescription: </span><span class=\"mtk6\">&quot;Blog description.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          siteUrl: </span><span class=\"mtk6\">&quot;https://someblog.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          defaultImage: </span><span class=\"mtk6\">&quot;/images/profile.png&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The other thing that will be different about this test is that the meta tags are not query-able in react testing library. This is because <code>react-helmet</code> renders side effects to the document <code>&#x3C;head></code> element. Instead, the <code>Helmet.peek</code> method is used which returns all the markup assigned to Helmet.</p>\n<p class=\"markdown-para\">Here are a few example tests for the Home Page and an Article Page. It gets quite lengthy verifying all the meta tags so will only include a few to demonstrate the idea. See <a href=\"https://github.com/danielabar/meblog/blob/master/src/components/SEO.spec.js\" class=\"markdown-link\">SEO.spec.js</a> on my blog project on Github for the complete listing.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/SEO.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Helmet </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react-helmet&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> SEO </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./SEO&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;SEO&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders for home page&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">SEO</span><span class=\"mtk1\"> </span><span class=\"mtk5\">title</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Home&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">pathname</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/&quot;</span><span class=\"mtk1\">/&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> helmet </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Helmet.</span><span class=\"mtk5\">peek</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(helmet.title).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Home · Jane Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(helmet.metaTags).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect.</span><span class=\"mtk5\">arrayContaining</span><span class=\"mtk1\">([</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Blog description.&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/images/profile.png&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:url&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;website&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:type&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Home&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:title&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Blog description.&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/images/profile.png&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;summary_large_image&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:card&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Home&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:title&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Blog description.&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/images/profile.png&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders for an article page&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">SEO</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">title</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Article Title&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">description</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Article Description&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">image</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/static/abc123/def/article-image.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">pathname</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/blog/article-slug/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> helmet </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Helmet.</span><span class=\"mtk5\">peek</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(helmet.title).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Article Title · Jane Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(helmet.metaTags).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect.</span><span class=\"mtk5\">arrayContaining</span><span class=\"mtk1\">([</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Description&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/static/abc123/def/article-image.jpg&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/blog/article-slug/&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:url&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;article&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:type&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Title&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:title&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Description&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/static/abc123/def/article-image.jpg&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;summary_large_image&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:card&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Title&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:title&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Description&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/static/abc123/def/article-image.jpg&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Pagination-Logic\" style=\"position:relative;\"><a href=\"#Pagination-Logic\" aria-label=\"Pagination Logic permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pagination Logic</h2>\n<p class=\"markdown-para\">Another type of component you might want to test is one that implements some business logic. For example, on my site all the blog list pages are paginated, 5 articles at a time, with Previous and Next links shown across the bottom of each list of 5 articles. The display of these links is implemented with a <code>&#x3C;Pagination></code> component that receives some props indicating if this is the first page or last page, and the previous/next page links.</p>\n<p class=\"markdown-para\">The rules for this component are that the previous link should be disabled if this is the first page and the next link should be disabled if this is the last page. For any other page, both previous and next links will be enabled. The href for (enabled) previous/next links should be for the page number as provided in the props.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/pagination.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./pagination.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">{!</span><span class=\"mtk1\">props.isFirst </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.prev</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.pagination</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;previous-enabled&quot;</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">={</span><span class=\"mtk1\">props.prevPage</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rel</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;prev&quot;</span><span class=\"mtk1\">&gt; ← prev &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">{</span><span class=\"mtk1\">props.isFirst </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.prev</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.pagination</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.inactive</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;previous-disabled&quot;</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ← prev</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">{!</span><span class=\"mtk1\">props.isLast </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.next</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.pagination</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;next-enabled&quot;</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">={</span><span class=\"mtk1\">props.nextPage</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rel</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;next&quot;</span><span class=\"mtk1\">&gt; next → &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">{</span><span class=\"mtk1\">props.isLast </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.next</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.pagination</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.inactive</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;next-disabled&quot;</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        next →</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">The tests for this component should cover all possible cases: first page, middle page, last page, and an edge case where there only is one page (first and last links disabled). Each test renders the component with props representing these scenarios, then verifies the presence or absence of expected DOM elements by <code>data-testid</code>.</p>\n<p class=\"markdown-para\">If a link is expected, then the test will also verify its expected href value. I couldn't find a convenience <code>getByHref...</code> query from react testing library so the \"escape hatch\" <code>document.querySelector...</code> is used to verify the href attributes of the links.</p>\n<p class=\"markdown-para\">Verifying all the expectations gets quite lengthy so this snippet below shows only the tests for first and middle page. See <a href=\"https://github.com/danielabar/meblog/blob/master/src/components/pagination.spec.js\" class=\"markdown-link\">pagination.spec.js</a> on my blog project on Github for the complete listing.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/pagination.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Pagination </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./pagination&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Pagination&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders first page&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">Pagination</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">isFirst</span><span class=\"mtk7\">={</span><span class=\"mtk4\">true</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">prevPage</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/blog/0&quot;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">isLast</span><span class=\"mtk7\">={</span><span class=\"mtk4\">false</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">nextPage</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/blog/2&quot;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;previous-enabled&quot;</span><span class=\"mtk1\">)).not.</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;previous-disabled&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;next-enabled&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;next-disabled&quot;</span><span class=\"mtk1\">)).not.</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;[data-testid=&#39;next-enabled&#39;] a&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">getAttribute</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;href&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;/blog/2&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders middle page&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">Pagination</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">isFirst</span><span class=\"mtk7\">={</span><span class=\"mtk4\">false</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">prevPage</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/blog/3&quot;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">isLast</span><span class=\"mtk7\">={</span><span class=\"mtk4\">false</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">nextPage</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/blog/5&quot;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;previous-enabled&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;previous-disabled&quot;</span><span class=\"mtk1\">)).not.</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;next-enabled&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;next-disabled&quot;</span><span class=\"mtk1\">)).not.</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;[data-testid=&#39;previous-enabled&#39;] a&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">getAttribute</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;href&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;/blog/3&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;[data-testid=&#39;next-enabled&#39;] a&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">getAttribute</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;href&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;/blog/5&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Templates\" style=\"position:relative;\"><a href=\"#Templates\" aria-label=\"Templates permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Templates</h2>\n<p class=\"markdown-para\">So far all of the test examples have been for components. Pages and templates can also be tested in a similar manner. For example, here is my <code>Post</code> template, which is used to render each post (including the one that you're reading right now), consisting of the article html content, published date, featured image, and title:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Img </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby-image&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./post.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> markdown </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> props.data.markdownRemark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> publishedDate </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> featuredImgFluid </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.featuredImage.childImageSharp.fluid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> content </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> title </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.published</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;Published </span><span class=\"mtk7\">{</span><span class=\"mtk1\">publishedDate</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">Img</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fluid</span><span class=\"mtk7\">={</span><span class=\"mtk1\">featuredImgFluid</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.featureImage</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.content</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">dangerouslySetInnerHTML</span><span class=\"mtk7\">={</span><span class=\"mtk1\">{ __html: content }</span><span class=\"mtk7\">}</span><span class=\"mtk1\">/&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Results of graphql query will NOT be available when this a unit test renders this template</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  query($slug: String!) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    markdownRemark(fields: { slug: { eq: $slug } }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        date(formatString: &quot;DD MMM YYYY&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            fluid(maxWidth: 800) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              ...GatsbyImageSharpFluid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">`</span></span></span></code></pre>\n<p class=\"markdown-para\">The main difference is that for pages or templates that use <code>graphql</code>, recall that this is mocked out, therefore will not return any results. From the initial Gatsby unit test setup <a href=\"(https://www.gatsbyjs.com/docs/how-to/testing/unit-testing/)\" class=\"markdown-link\">instructions</a>, you should have:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// __mocks__/gatsby.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> gatsby </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> jest.</span><span class=\"mtk5\">requireActual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;gatsby&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span><span class=\"mtk1\">gatsby,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// All graphql queries are mocked out</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  graphql: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// rest of the mocks...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">The important thing to understand for testing is when the Gatsby templates are built, results from the graphql query are made available in the <code>data</code> prop. This means that when the template is rendered in a test, simply pass in an example of what the query would have returned as <code>data</code> when rendering, then use snapshot testing:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Post </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./post&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Post&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Renders in layout&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// An example of what the graphql query used by the Post template returns:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> postData </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      markdownRemark: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fields: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          slug: </span><span class=\"mtk6\">&quot;/blog/some-slug&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date: </span><span class=\"mtk6\">&quot;14 Aug 2021&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title: </span><span class=\"mtk6\">&quot;This is the title&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          featuredImage: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            childImageSharp: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              fluid: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                aspectRatio: </span><span class=\"mtk4\">1.5</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                base64: </span><span class=\"mtk6\">&quot;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4k=&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                sizes: </span><span class=\"mtk6\">&quot;(max-width: 800px) 100vw, 800px&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                src: </span><span class=\"mtk6\">&quot;/static/69f6b/14b42/some-img.jpg&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                srcSet: </span><span class=\"mtk6\">&quot;/static/69f6b/f836f/some-img.jpg 200w, /static/69f6b/2244e/some-img.jpg 400w, /static/69f6b/14b42/some-img.jpg 800w, /static/69f6b/a7715/some-img.jpg 1000w&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        html:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">&quot;&lt;p&gt;Here is the first paragraph&lt;/p&gt;&lt;h2&gt;Sub Heading&lt;/h2&gt;&lt;p&gt;And another paragraph&lt;/p&gt;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Render the template with the data prop to mimic graphql passing results to it:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data</span><span class=\"mtk7\">={</span><span class=\"mtk1\">postData</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(container).</span><span class=\"mtk5\">toMatchSnapshot</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Google-Fonts-Gotcha\" style=\"position:relative;\"><a href=\"#Google-Fonts-Gotcha\" aria-label=\"Google Fonts Gotcha permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Google Fonts Gotcha</h2>\n<p class=\"markdown-para\">This section isn't a testing technique, but describes how to get past a Jest error you may encounter when loading fonts.</p>\n<p class=\"markdown-para\">When using Google Fonts (or other open source fonts), the recommended solution is to self host them. The <a href=\"https://github.com/fontsource/fontsource\" class=\"markdown-link\">@fontsource</a> project provides an easy way to do this, making each font available as an npm package. For example, I use <a href=\"https://www.npmjs.com/package/@fontsource/bai-jamjuree\" class=\"markdown-link\">bai-jamjuree</a> on this site:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/pages/index.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@fontsource/bai-jamjuree/200.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@fontsource/bai-jamjuree/300.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// rest of the font sizes and home page...</span></span></span></code></pre>\n<p class=\"markdown-para\">However, when running a Jest test for a page that loads fonts from <code>@fontsource</code>, it will fail with this error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">SyntaxError: Invalid or unexpected token</span></span></code></pre>\n<p class=\"markdown-para\">The issue is that Jest can't handle static file imports, which includes importing assets such as css and fonts. The solution is to add a regex pattern for <code>@fontsource</code> in the <code>moduleNameMapper</code> section of <code>jest.config.js</code> which tells Jest how to handle various import types (similar to how Webpack works):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// jest.config.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  moduleNameMapper: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;@fontsource/*&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;&lt;rootDir&gt;/__mocks__/font-mock.js&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// other rules...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other configuration...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Where <code>font-mock</code> simply exports an empty module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// __mocks__/font-mock.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span></code></pre>\n<p class=\"markdown-para\">Now when a Jest test encounters any import starting with <code>@fontsource</code>, it won't attempt to load the module for real, and instead will replace it with the mock empty module defined in <code>__mocks__/font-mock.js</code>.</p>\n<h2 class=\"markdown-subtitle\" id=\"Jest-Test-Options\" style=\"position:relative;\"><a href=\"#Jest-Test-Options\" aria-label=\"Jest Test Options permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Jest Test Options</h2>\n<p class=\"markdown-para\">This section isn't Gatsby specific, but just want to share a few useful options that can be used on any project that's running tests with Jest.</p>\n<p class=\"markdown-para\">During development, it's convenient to have Jest watch for any file changes, and automatically re-run affected tests. This provides nearly instant feedback if anything has broken. Given that you've added <code>\"test\": \"jest\",</code> to <code>package.json</code>, the command to have Jest run in \"watch\" mode is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">npm test -- --watch</span></span></code></pre>\n<p class=\"markdown-para\">Jest can also generate a coverage report showing percentage of lines and files in the project that have been \"covered\", i.e. exercised by a test. Don't stress about getting this all the way up to 100% as that can be difficult. Rather, the coverage report is useful to identify areas of the project that are missing or low on tests and see where test coverage could be improved. The command to run tests and generate the coverage report is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">npm test -- --coverage</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Conclusion\" style=\"position:relative;\"><a href=\"#Conclusion\" aria-label=\"Conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered how to get started with unit testing on a Gatsby project using Jest and react testing library. It has covered simple snapshot testing, testing components with props, components with children, mocking dependencies globally and per test, user interaction, meta tags, business logic and templates. It has also covered a few different options for how to run the tests. I hope this will encourage everyone who maintains a Gatsby site to go ahead and add some tests.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/gatsby-unit-testing/"}}},{"node":{"id":"848d2c81-d508-5776-ac83-fb1e50ef5848","frontmatter":{"title":"Fix Rails Blocked Host Error with Docker","date":"September 2021","category":"rails"},"excerpt":"This post will demonstrate how to solve the Rails Blocked Host error when running a Rails app in a Docker container. But first, what is the…","html":"<p class=\"markdown-para\">This post will demonstrate how to solve the Rails Blocked Host error when running a Rails app in a Docker container.</p>\n<p class=\"markdown-para\">But first, what is the blocked host error? The symptom is the following error message is returned when making any request to the server. For example: <code>https://myapp.com</code> would return a 500 error with details:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;Blocked host: myapp.com&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;To allow requests to myapp.com, add the following to your environment configuration:&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;config.hosts </span><span class=\"mtk8\">&lt;&lt;</span><span class=\"mtk1\"> &quot;myapp.com&quot;&lt;/</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">This happens because as of v6, Rails has introduced a new <code>ActionDispatch::HostAuthorization</code> middleware to prevent <a href=\"https://danielmiessler.com/blog/dns-rebinding-explained/\" class=\"markdown-link\">DNS rebinding attacks</a>. This middleware is controlled by a new <code>hosts</code> configuration to specify what hosts the server will respond to. Here is the default configuration for development, i.e. when <code>RAILS_ENV=development</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/environments/development.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.configure </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.hosts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;0.0.0.0/0&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk3\"># All IPv4 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;::/0&quot;</span><span class=\"mtk1\">),      </span><span class=\"mtk3\"># All IPv6 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;localhost&quot;</span><span class=\"mtk1\">              </span><span class=\"mtk3\"># The localhost reserved domain.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other config settings...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">This means that when running a Rails server (assume default port 3000) in development mode on your laptop, you could address it as <code>http://localhost:3000</code> or <code>http://127.0.0.1:3000</code> or even by your internal IP address such as <code>http://193.168.1.2:3000</code>.</p>\n<p class=\"markdown-para\">In production, if your app should be available at <code>https://myapp.com</code>, then the hosts could be configured as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/environments/production.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.configure </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.hosts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;myapp.com&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other config settings...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">In this case, the Rails server would respond to any requests from <code>https://myapp.com</code>, but not from an IP address such as <code>https://145.83.11.7</code>.</p>\n<h2 class=\"markdown-subtitle\" id=\"Docker-and-Docker-Compose\" style=\"position:relative;\"><a href=\"#Docker-and-Docker-Compose\" aria-label=\"Docker and Docker Compose permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker and Docker Compose</h2>\n<p class=\"markdown-para\">But what happens if you're running microservices, with several Rails apps each running in their own container, that need to make requests to each other?</p>\n<p class=\"markdown-para\">Here's the setup: Suppose there is an app called <code>mainapp</code>, and it uses a microservice that provides subscription management services called <code>subscription_service</code>. The <code>mainapp</code> developers don't want to have to checkout and install the code for <code>subscription_service</code> so docker compose is used to ensure all services can be started from the main app.</p>\n<p class=\"markdown-para\">Here's a simplified docker-compose file showing only the main app and subscription services. <code>mainapp</code> has all the <code>app</code> code available to it via a host mount because this is the main app under development. <code>subscription_service</code> uses a private image from the <a href=\"https://github.blog/2020-09-01-introducing-github-container-registry/\" class=\"markdown-link\">Github Container Registry</a> because that is an already built microservice that <code>mainapp</code> depends on.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># docker-compose.yml (mainapp)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">mainapp</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;bundle exec rails s -b &#39;0.0.0.0&#39;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">subscription_service</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ghcr.io/my_org/subscription_service/subscription-app:latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;bundle exec rails s -b &#39;0.0.0.0&#39; -p 4000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;4000:4000&quot;</span></span></span></code></pre>\n<p class=\"markdown-para\">Since both <code>mainapp</code> and <code>subscription_service</code> are started in the same docker network created when <code>docker-compose up</code> is run, it should be possible for the main app to make http requests to the subscription service. For example, the subscription service exposes a REST style API to retrieve all plans, with <code>GET {{host}}/api/v1/plans</code>. Therefore, the following code in <code>mainapp</code>, using Faraday to make an http request <em class=\"markdown-emphasis\">should</em> work:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Any ruby file in mainapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">url </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://subscription_service:4000/api/v1/plans&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.get(url, </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">, {</span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># expect response.status to be 200 and response.body to contain list of plans</span></span></span></code></pre>\n<p class=\"markdown-para\">But rather than the expected 200 response and a list of plans, a 500 error is returned with the following details:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;Blocked host: subscription_service&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;To allow requests to subscription_service, add the following to your environment configuration:&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;config.hosts </span><span class=\"mtk8\">&lt;&lt;</span><span class=\"mtk1\"> &quot;subscription_service&quot;&lt;/</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">The problem is <code>subscription_service</code> is a Rails 6 app, with the default <code>config.hosts</code> specified in <code>config/environments/development.rb</code>. This means it only responds to requests at <code>http://localhost:4000</code> or an IP address. But <code>mainapp</code> is attempting to call <code>http://subscription_service:4000</code> which has not been allowed.</p>\n<h2 class=\"markdown-subtitle\" id=\"Solution\" style=\"position:relative;\"><a href=\"#Solution\" aria-label=\"Solution permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h2>\n<p class=\"markdown-para\">The solution is to modify the development configuration in the subscription microservice to allow a host of <code>subscription_service</code>. This is the service name that is specified in the main app's <code>docker-compose.yml</code> file. The modified config looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/environments/development.rb in Subscription service project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.configure </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.hosts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;0.0.0.0/0&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk3\"># All IPv4 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;::/0&quot;</span><span class=\"mtk1\">),      </span><span class=\"mtk3\"># All IPv6 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;localhost&quot;</span><span class=\"mtk1\">,             </span><span class=\"mtk3\"># The localhost reserved domain.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;subscription_service&quot;</span><span class=\"mtk1\">   </span><span class=\"mtk3\"># Allow this to be addressed when running in containers via docker-compose.yml.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other config settings...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">One problem with this solution is it requires that every project that wants to use the subscription microservice to name it <code>subscription_service</code> in their <code>docker-compose.yml</code>. An alternate way to solve this problem while providing more flexibility would be to use an environment variable as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/environments/development.rb in Subscription service project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.configure </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.hosts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;0.0.0.0/0&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk3\"># All IPv4 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;::/0&quot;</span><span class=\"mtk1\">),      </span><span class=\"mtk3\"># All IPv6 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;localhost&quot;</span><span class=\"mtk1\">,             </span><span class=\"mtk3\"># The localhost reserved domain.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ENV[</span><span class=\"mtk6\">&quot;SERVER_HOST_NAME&quot;</span><span class=\"mtk1\">]  </span><span class=\"mtk3\"># Allow this to be addressed when running in containers via docker-compose.yml.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other config settings...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p class=\"markdown-para\">Now suppose a project that wishes to use the subscription microservice would like to refer to it as <code>subs</code>, for example <code>GET http://subs:4000/api/v1/plans</code>. Then they could do so by specifying <code>subs</code> as the value for <code>SERVER_HOST_NAME</code> in the <code>environment</code> section of the subscription service in the docker compose file as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># docker-compose.yml (mainapp)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">mainapp</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;bundle exec rails s -b &#39;0.0.0.0&#39;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">subs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ghcr.io/my_org/subscription_service/subscription-app:latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;bundle exec rails s -b &#39;0.0.0.0&#39; -p 4000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;4000:4000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">SERVER_HOST_NAME</span><span class=\"mtk1\">: </span><span class=\"mtk6\">subs</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Conclusion\" style=\"position:relative;\"><a href=\"#Conclusion\" aria-label=\"Conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered what the Rails Blocked Host error is and several different ways to solve it for development and production. See the Rails docs on <a href=\"https://guides.rubyonrails.org/configuring.html#configuring-middleware\" class=\"markdown-link\">configuring middleware</a> to learn more about <code>ActionDispatch::HostAuthorization</code> middleware.</p>\n<h2 class=\"markdown-subtitle\" id=\"Related-Content\" style=\"position:relative;\"><a href=\"#Related-Content\" aria-label=\"Related Content permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Related Content</h2>\n<p class=\"markdown-para\">The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p class=\"markdown-para\">Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\" class=\"markdown-link\">Agile Web Development with Rails 6</a>.</p>\n<p class=\"markdown-para\">Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\" class=\"markdown-link\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p class=\"markdown-para\">Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\" class=\"markdown-link\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p class=\"markdown-para\">Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\" class=\"markdown-link\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-blocked-host-docker-fix/"}}}]}},"pageContext":{}},
    "staticQueryHashes": ["163244226"]}