{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":39,"edges":[{"node":{"id":"0c2e1691-4b14-536c-acee-4d0f120de743","frontmatter":{"title":"Rails Strong Params for GET Request","date":"October 2021","category":"rails"},"excerpt":"If you've been using Rails for a while, you've probably encountered Strong Parameters. This feature was introduced in Rails 4 and is…","html":"<p>If you've been using Rails for a while, you've probably encountered <a href=\"https://api.rubyonrails.org/v6.1.3/classes/ActionController/StrongParameters.html\">Strong Parameters</a>. This feature was introduced in Rails 4 and is intended to prevent mass assignment. The typical use case for this is to protect a POST or PUT/PATCH endpoint, which is invoked when a user submits a form and a controller action tries to create or update the corresponding model.</p>\n<p>This post will demonstrate how strong params can also be used to protect a GET request. Why would you ever want to do that? I'll get to that in a minute. First, let's look at the typical case for strong params.</p>\n<h2>Typical Case: POST</h2>\n<p>Given an HTML form such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">form</span><span class=\"mtk1\"> </span><span class=\"mtk5\">action</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;/person&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;person[name]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;person_name&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;person[email]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">id</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;person_email&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">button</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;submit&quot;</span><span class=\"mtk1\">&gt;Create&lt;/</span><span class=\"mtk7\">button</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">form</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p>When the user fills out this form and clicks submit button, it will invoke a <code>POST</code> http action to the <code>/person</code> endpoint, with the following parameters:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;person&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;name&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;fred&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;fred@example.com&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The corresponding <code>PersonController#create</code> method is responsible for creating a new <code>Person</code> model with the <code>name</code> and <code>email</code> properties populated and saving to the database. A naive implementation would look like:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">PeopleController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Person</span><span class=\"mtk1\">.create(params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>But what if a sneaky user modifies the form or uses a REST client to submit an additional parameter that happens to be used internally, but is not intended to be set by a user such as <code>is_admin</code>, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;person&quot;</span><span class=\"mtk1\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;name&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;fred&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;email&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;fred@example.com&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&quot;is_admin&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;true&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The Rails solution is to use strong parameters to only allow the <code>name</code> and <code>email</code> properties of the form to be saved, rather than passing the entire user generated <code>params</code> to the model create method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">PeopleController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Person</span><span class=\"mtk1\">.create(person_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">person_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.require(</span><span class=\"mtk4\">:person</span><span class=\"mtk1\">).permit(</span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now, any additional parameters submitted to the <code>/person</code> endpoint will be discarded when <code>Person.create</code> is called because the <code>person_params</code> method only allows <code>name</code> and <code>email</code>.</p>\n<h2>Unusual Case: GET</h2>\n<p>Consider another case where strong params could be useful. Suppose your application exposes a <code>GET /search?q=something</code> endpoint, but behind the scenes, the actual search action is delegated to a third party service.</p>\n<p>The search form accepts a search term from the user named <code>q</code>. Since this is a query and doesn't modify any state, the <code>GET</code> method is used.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">form</span><span class=\"mtk1\"> </span><span class=\"mtk5\">action</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;/search&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">method</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;get&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;q&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">button</span><span class=\"mtk1\">&gt;Search&lt;/</span><span class=\"mtk7\">button</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">form</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p>The search action is handled by the search controller, which passes on the params given to it to the third party search service to perform the actual search:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SearchController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">ThirdPartySearchService</span><span class=\"mtk1\">.call(params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Where the incoming <code>params</code> look like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;q&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;something the user typed into the form&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Since <code>params</code> comes from the user, it would be useful to restrict the fields that get sent to the third party search service to only the expected fields. In this simple example there's only one expected field <code>q</code>.</p>\n<p>This sounds like a job for strong parameters! But recall the typical example is for protecting a model:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">PeopleController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Person</span><span class=\"mtk1\">.create(person_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">person_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.require(</span><span class=\"mtk4\">:person</span><span class=\"mtk1\">).permit(</span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>This doesn't seem to be a good fit for a controller handling a <code>GET</code> request because the search controller is not creating or updating a model. Specifically, this line seems like a magic incantation:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.require(</span><span class=\"mtk4\">:person</span><span class=\"mtk1\">).permit(</span><span class=\"mtk4\">:name</span><span class=\"mtk1\">, </span><span class=\"mtk4\">:email</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>Here we get to the point where as a newcomer to Rails, it's very easy to copy/paste these seemingly magical incantations and as long as your usage is the same as the typical case, it will work just fine. However, sometimes your use case may be a little different, and the copy/paste no longer works. In this case, it requires digging in a little to understand what's going on \"under the hood\" so to speak.</p>\n<h2>TL;DR</h2>\n<p>For those that just want the solution real quick, here it is - simply call <code>permit</code> on the params with the single required field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SearchController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">ThirdPartySearchService</span><span class=\"mtk1\">.call(search_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.permit(</span><span class=\"mtk4\">:q</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>To understand why this works, read on...</p>\n<h2>Deeper Explanation</h2>\n<p>To make strong parameters work for the search controller, we need to understand what <code>params</code> is. It appears to be a hash of inputs to the controller, that come from either an HTML form, url, or query parameters.</p>\n<p>However, it's actually a method that returns an instance of <a href=\"https://api.rubyonrails.org/classes/ActionController/Parameters.html\">ActionController::Parameters</a>. This instance is initialized with a hash of the input parameters. It also has methods like <code>require</code> and <code>permit</code> which return new instances of <code>ActionController::Parameters</code> so that's why they can be chained together like <code>params.require(:something).permit(:somefield, :otherfield)</code>.</p>\n<h3>require</h3>\n<p>Looking at the api docs for the <a href=\"https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-require\">require</a> method, it accepts a key, and returns the value from the hash if the key exists, otherwise it raises <code>ActionController::ParameterMissing</code>. If the value happens to be a hash, then it returns a new instance of <code>ActionController::Parameters</code> initialized with the value. This means that given input parameters to a controller such as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;a&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;some value&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;b&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;something else&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;c&quot;</span><span class=\"mtk1\">=&gt;{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;d&quot;</span><span class=\"mtk1\">=&gt;</span><span class=\"mtk6\">&quot;in a hash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The following could be run in the controller:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.require(</span><span class=\"mtk4\">:a</span><span class=\"mtk1\">)  </span><span class=\"mtk3\"># &quot;some value&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.require(</span><span class=\"mtk4\">:x</span><span class=\"mtk1\">)  </span><span class=\"mtk3\"># *** ActionController::ParameterMissing Exception: param is missing or the value is empty: x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.require(</span><span class=\"mtk4\">:c</span><span class=\"mtk1\">)  </span><span class=\"mtk3\"># &lt;ActionController::Parameters {&quot;d&quot;=&gt;&quot;in a hash&quot;} permitted: false&gt;</span></span></span></code></pre>\n<h3>permit</h3>\n<p>Looking at the api docs for the <a href=\"https://api.rubyonrails.org/classes/ActionController/Parameters.html#method-i-permit\">permit</a> method, it accepts a list of filters, and returns a new instance of <code>ActionController::Parameters</code> containing only fields that were specified in the filters. Carrying on with the a,b,c hash example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># returns new instance of params with ONLY the `b` field</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">params.permit(</span><span class=\"mtk4\">:b</span><span class=\"mtk1\">)  </span><span class=\"mtk3\"># &lt;ActionController::Parameters {&quot;b&quot;=&gt;&quot;something else&quot;} permitted: true&gt;</span></span></span></code></pre>\n<p>Notice that <code>ActionController::Parameters</code> is not tied to a model, it simply operates on a hash. This is why it can be used in any controller, even when not dealing with a model. Also, there's no rule that says you first have to call <code>require</code>, and then chain with <code>permit</code>. You're free to use any combination of these as it suits the use case.</p>\n<h3>Solution Explained</h3>\n<p>Now getting back to the search controller, in this case, there are no required fields (let's assume the service will do something reasonable like returning a default set of results when not given a query). The only requirement is that the controller should only pass the <code>q</code> field on to the service and nothing else. This is why it calls the <code>permit</code> method on params, specifying the <code>q</code> field, and then passes the resulting new params object to the third party service:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SearchController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ActionController::Base</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">ThirdPartySearchService</span><span class=\"mtk1\">.call(search_params)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search_params</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    params.permit(</span><span class=\"mtk4\">:q</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Conclusion</h2>\n<p>This post has covered the typical use case for strong parameters in Rails and how it can also be used for a non typical case of an http GET request. It also took a deeper dive into some seemingly Rails \"magic\", to explain some methods of controller parameters.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-strong-params-get/"}}},{"node":{"id":"7397cada-13e5-52f5-95d5-24ed085f5816","frontmatter":{"title":"Get started with Gatsby and Unit Testing","date":"September 2021","category":"gatsby"},"excerpt":"This post will demonstrate how to add unit tests to a Gatsby project using Jest and react-testing-library. Gatsby is a static site generator…","html":"<p>This post will demonstrate how to add unit tests to a Gatsby project using Jest and react-testing-library. Gatsby is a static site generator powered by React and GraphQL so the libraries to test it are similar to those used for testing any React project.</p>\n<h2>Why?</h2>\n<p>Before getting into the mechanics of how to do this, why does a Gatsby site need tests? To answer this, consider a common use case for a Gatsby site - a personal or company blog. For example, this blog was initialized with the <a href=\"https://github.com/gatsbyjs/gatsby-starter-hello-world\">Hello World Gatsby starter project</a>. Then I started writing some posts in markdown. Over time I gradually added more features including pagination, SEO, typography with self-hosted google fonts, responsive nav menu for desktop vs mobile layouts, custom analytics, and search.</p>\n<p>Even for a simple blog site without all these features, it's still valuable to add some basic unit tests to snapshot all the page layouts and components. Then if your blog does have additional features, especially those requiring user interaction such as search, it will be even more valuable to add unit testing to verify the user's interactions with these components.</p>\n<p>Finally Gatsby can be used for more than just blogging and any site will benefit from at least some basic snapshot tests, and some more complex tests for interactive components or components that have more logic in them than simply rendering a layout.</p>\n<h2>Initial Setup</h2>\n<p>Start by following the Gatsby <a href=\"https://www.gatsbyjs.com/docs/how-to/testing/unit-testing/\">unit testing</a> docs, which explain how to get setup for unit testing including installing the necessary libraries from npm, configuring jest and babel, and setting up some useful mocks.</p>\n<p>However, rather than installing <code>react-test-renderer</code> as shown in the Gatsby docs, I recommend installing <a href=\"https://testing-library.com/docs/react-testing-library/intro/\">React Testing Library</a>. This is because <code>react-test-renderer</code> will only render a component and then you can verify the expected output, but does not support interactivity like clicking a button or entering text into an input box. React Testing Library on the other hand, will provide a lot more flexibility with interaction and querying the DOM.</p>\n<p>Specifically, instead of <code>react-test-renderer</code>, install these additional libraries:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">npm i @testing-library/jest-dom testing-library/react testing-library/user-event --save-dev</span></span></code></pre>\n<p>One additional step is to set the jest test environment to <code>jsdom</code>. By default, its set to <code>node</code> and any tests that attempt to query the DOM will fail without this change:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// jest.config.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  testEnvironment: </span><span class=\"mtk6\">&quot;jsdom&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// rest of the config from following Gatsby instructions...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2>Simple Snapshot Test</h2>\n<p>Now that all the testing libraries are installed and configured, it's time to write a simple test. The footer component on my blog simply renders out social links and the copyright:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/footer.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./footer.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { FaTwitter, FaGithub, FaCodepen, FaLinkedinIn } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react-icons/fa&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Footer</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">footer</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;footer&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">p</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.copy</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;All materials © Daniela Baron 2021&lt;/</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.social</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">a</span><span class=\"mtk1\"> </span><span class=\"mtk5\">href</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;https://twitter.com/DanielaMBaron&quot;</span><span class=\"mtk1\">&gt;&lt;</span><span class=\"mtk9 mtki\">FaTwitter</span><span class=\"mtk1\"> /&gt;&lt;/</span><span class=\"mtk7\">a</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">a</span><span class=\"mtk1\"> </span><span class=\"mtk5\">href</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;https://github.com/danielabar&quot;</span><span class=\"mtk1\">&gt;&lt;</span><span class=\"mtk9 mtki\">FaGithub</span><span class=\"mtk1\"> /&gt;&lt;/</span><span class=\"mtk7\">a</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">a</span><span class=\"mtk1\"> </span><span class=\"mtk5\">href</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;https://codepen.io/danielabar&quot;</span><span class=\"mtk1\">&gt;&lt;</span><span class=\"mtk9 mtki\">FaCodepen</span><span class=\"mtk1\"> /&gt;&lt;/</span><span class=\"mtk7\">a</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">a</span><span class=\"mtk1\"> </span><span class=\"mtk5\">href</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;https://www.linkedin.com/in/danielabaron/&quot;</span><span class=\"mtk1\">&gt;&lt;</span><span class=\"mtk9 mtki\">FaLinkedinIn</span><span class=\"mtk1\"> /&gt;&lt;/</span><span class=\"mtk7\">a</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">footer</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Footer</span></span></span></code></pre>\n<p>Since there's no logic or interactivity in this component, the unit test for it will simply render it using the <code>render</code> function from react testing library, then verify against the snapshot using jest's <code>toMatchSnapshot</code> function:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/footer.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Footer </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./footer&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Footer&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders correctly&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">Footer</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(container).</span><span class=\"mtk5\">toMatchSnapshot</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<p>See the Jest docs to learn more about <a href=\"https://jestjs.io/docs/snapshot-testing\">snapshot testing</a>.</p>\n<h2>Run Tests</h2>\n<p>The command to run tests in a terminal is simply <code>jest</code>, however, since the jest library is installed in the <code>node_modules</code> of the project, you would have to run it specifying the full path from your project root: <code>node_modules/bin/jest</code>. That's a little tedious to type out each time.  A better way is to add a <code>test</code> entry in the <code>scripts</code> section of the project's <code>package.json</code> file. When running npm scripts, npm will search the projects' local <code>node_modules</code> directory for the binary, saving you the trouble of having to specify the full path:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// package.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;scripts&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;test&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;jest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Now the tests can be run with <code>npm test</code>.</p>\n<h2>Component with Props</h2>\n<p>Let's move on to a slightly more complex component that accepts some props. In the example below, the <code>AllLink</code> component accepts a <code>marginTop</code> prop to control how much space is styled right above it. This component gets rendered in various places throughout my blog and the spacing can vary. Notice the <code>data-testid</code> attribute on the outer element, this will be used later by the test.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/all-link.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./all-link.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">marginTop</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;all-wrapper&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">style</span><span class=\"mtk7\">={</span><span class=\"mtk1\">{ marginTop: marginTop }</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/blog&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.allLink</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      All Articles</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>The test uses the <code>render</code> function from react testing library to render the component, this time with the <code>marginTop</code> prop. To verify that the <code>marginTop</code> prop value was correctly applied as the style, the <code>screen.getByTestId</code> function from react testing library is used. This function accepts a string value such as <code>\"all-wrapper\"</code> and returns the DOM node in the component that has this value set as its <code>data-testid</code> attribute.</p>\n<p>Then, jest-dom's <a href=\"https://github.com/testing-library/jest-dom#tohavestyle\">toHaveStyle</a> matcher is used to verify that the DOM node has a <code>marginTop</code> style of <code>30px</code>, which is what was provided when the test rendered the <code>AllLink</code> component:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/all-link.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> AllLink </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./all-link&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;AllLink&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders correctly&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">AllLink</span><span class=\"mtk1\"> </span><span class=\"mtk5\">marginTop</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;30px&quot;</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> div </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;all-wrapper&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(div).</span><span class=\"mtk5\">toHaveStyle</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;marginTop: 30px&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<h2>Component with Children</h2>\n<p>In a typical Gatsby site, there will most likely be a <code>&#x3C;Layout></code> component used by every page to get a consistent look and feel. My <code>&#x3C;Layout></code> component simply renders the <code>&#x3C;Header></code> and <code>&#x3C;Footer></code> components, and then renders the page content in between these using the <code>children</code> prop:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/layout.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./layout.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Header </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./header.js&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Footer </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./footer.js&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">children</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Header</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.content</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">children</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Footer</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>The Layout component test renders the component with some simple content using a <code>data-testid</code> attribute to verify it was rendered. Note that the <code>&#x3C;Header></code> and <code>&#x3C;Footer></code> components are wrapped in DOM nodes with <code>data-testid</code> attributes of <code>header</code> and <code>footer</code> respectively. This makes them easy to find in the <code>Layout</code> component test to verify it did indeed render the Header and Footer components. The easiest way to verify that an element got rendered is to use jest-dom's <a href=\"https://github.com/testing-library/jest-dom#tobeinthedocument\">toBeInTheDocument</a> matcher:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/layout.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Layout&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders correctly&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;test-content&quot;</span><span class=\"mtk1\">&gt;test content&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;header&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;test-content&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;footer&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<h2>Mocking Dependencies</h2>\n<p>The <code>&#x3C;Header></code> component makes use of a custom <code>useViewport</code> hook to change the navigation menu layout between responsive design (viewport width &#x3C; 640px) and regular (viewport width >= 640px). The <code>useViewport</code> hook returns the current width of the viewport:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/header.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> useViewport </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../hooks/useviewport&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./header.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> NavMenuResponsive </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./nav-menu-responsive&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> NavMenu </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./nav-menu&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">Header</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> { width } </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useViewport</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> breakpoint </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">640</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Use result of useViewport hook to determine which navigation component to render</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">menuHelper</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> width </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> breakpoint </span><span class=\"mtk7\">?</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk9 mtki\">NavMenuResponsive</span><span class=\"mtk1\"> /&gt; </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk9 mtki\">NavMenu</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">header</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;header&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.logo</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.profileWrapper</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &lt;</span><span class=\"mtk7\">img</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.profileImg</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">src</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/images/profile.png&quot;</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">alt</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Profile&quot;</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.headerItem</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.title</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            Daniela Baron</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk5\">menuHelper</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">header</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> Header</span></span></span></code></pre>\n<p>To test the <code>&#x3C;Header></code> component, the <code>useViewport</code> hook will need to be mocked out because it depends on the <code>window</code> object which isn't present when unit tests are running (Jest tests run via Node.js, not in a browser).</p>\n<p>Since the hook is imported from a module, the test will use the <code>jest.mock(...)</code> function to mock out the entire module. Furthermore, a mock function that returns a width is specified as the return result from the <code>default</code> export. Then each test can modify the returned width value and verify the correct version of the navigation menu gets rendered, as well as verifying that the <code>useViewport</code> hook was called.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/header.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> useViewport </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../hooks/useviewport&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Header </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./header&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> mockWidth </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1024</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">jest.</span><span class=\"mtk5\">mock</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;../hooks/useviewport&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> ({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  __esModule: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  default: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> ({ width: mockWidth })),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Header&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">afterEach</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    jest.</span><span class=\"mtk5\">clearAllMocks</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders nav menu for wide widths&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    mockWidth </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">900</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">Header</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;nav-menu&quot;</span><span class=\"mtk1\">)).toBeInTheDocument</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(useViewport).</span><span class=\"mtk5\">toHaveBeenCalled</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders nav menu responsive for narrow widths&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    mockWidth </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">400</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">Header</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;nav-menu-responsive&quot;</span><span class=\"mtk1\">)).toBeInTheDocument</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(useViewport).</span><span class=\"mtk5\">toHaveBeenCalled</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<p>This is just one example of Jest mocking, there are many more variations and use cases. Learn more about it <a href=\"https://jestjs.io/docs/mock-functions\">here</a>.</p>\n<h2>User Interaction</h2>\n<p>The <code>&#x3C;SearchInput></code> component renders an input text box where user can type in a search term. When they hit <kbd>Enter</kbd>, the UI will navigate to the search results for that page at url <code>/search-results/?q=searchTermUserTypedIn</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/search-input.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { navigate } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { MdSearch } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react-icons/md&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./search-input.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> ENTER_KEY </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Enter&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SearchInput</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">eventKey</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">text</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (eventKey </span><span class=\"mtk7\">===</span><span class=\"mtk1\"> ENTER_KEY) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">navigate</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`/search-results/?q=</span><span class=\"mtk7\">${</span><span class=\"mtk1\">text</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.wrapper</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">MdSearch</span><span class=\"mtk1\"> </span><span class=\"mtk5\">size</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;1.7rem&quot;</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">type</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;text&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.search</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;search-input&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">aria-label</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Search&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">placeholder</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Search, eg: Rails&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">onKeyPress</span><span class=\"mtk7\">={</span><span class=\"mtk10 mtki\">event</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span><span class=\"mtk1\">(event.key, event.target.value)</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> SearchInput</span></span></span></code></pre>\n<p>In order to simulate a user typing into the search input box, the test for this component will use functions from the <a href=\"https://testing-library.com/docs/ecosystem-user-event/\">user-event</a> library, which works with react testing library to provide more realistic simulations of browser events.</p>\n<p><strong>WATCH OUT:</strong> Do not attempt to use the <a href=\"https://testing-library.com/docs/dom-testing-library/api-events\">fireEvent</a> function from react testing library. Although in theory it should be possible to simulate the correct combination of key press/up/down events using the <code>fireEvent</code> function, in practice I couldn't get it working. Then I read that it's recommended to use the <a href=\"https://testing-library.com/docs/ecosystem-user-event/\">user-event</a> library for this purpose and it made everything much easier.</p>\n<p>Also this test should not attempt to navigate to another page for real as this is just a unit test running in Node.js, not an end-to-end test running in a browser. To avoid real navigation, Gatsby's <code>navigate</code> function is mocked out with a Jest mock function. Since this is universally desired across all the tests, the mock function can be defined in the global <code>__mocks__/gatsby.js</code> file. The first part of this file you should already have from following the <a href=\"https://www.gatsbyjs.com/docs/how-to/testing/unit-testing/\">initial setup</a> instructions:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// __mocks__/gatsby.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> gatsby </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> jest.</span><span class=\"mtk5\">requireActual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;gatsby&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span><span class=\"mtk1\">gatsby,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  graphql: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Link: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">().</span><span class=\"mtk5\">mockImplementation</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      activeClassName,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      activeStyle,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      getProps,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      innerRef,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      partiallyActive,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ref,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      replace,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      to,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">...</span><span class=\"mtk1\">rest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }) </span><span class=\"mtk9 mtki\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      React.</span><span class=\"mtk5\">createElement</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;a&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">...</span><span class=\"mtk1\">rest,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        href: to,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// +++ ADD MOCK NAVIGATE FUNCTION HERE +++</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  navigate: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And here is the test for the <code>&#x3C;SearchInput></code> component. It uses the <code>getByTestId</code> function to locate the text input element, then uses the <code>userEvent.type</code> function to enter some example text into the search box. Finally Jest's <code>toHaveBeenCalledWith</code> function is used to verify the mock version of the <code>navigate</code> function was called after user hit <kbd>Enter</kbd>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { navigate } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> userEvent </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/user-event&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> SearchInput </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./search-input&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;SearchInput&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;navigates to search results on Enter key press&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">SearchInput</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> inputEl </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> screen.</span><span class=\"mtk5\">getByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;search-input&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    userEvent.</span><span class=\"mtk5\">type</span><span class=\"mtk1\">(inputEl, </span><span class=\"mtk6\">&quot;Rails{enter}&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(navigate).</span><span class=\"mtk5\">toHaveBeenCalledWith</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;/search-results/?q=Rails&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<p>Notice the use of the special control character <code>{enter}</code> to simulate the <kbd>Enter</kbd> key. See the user-event docs for a list of all such <a href=\"https://testing-library.com/docs/ecosystem-user-event/#special-characters\">control characters</a>.</p>\n<h2>Meta Tags</h2>\n<p>Many Gatsby sites will have an <code>&#x3C;SEO></code> component that gets included in every page. It uses a static query to get the site's metadata such as title, description, url, etc. (defined in <code>gatsby-config.js</code>), and also accepts properties to override these. Then it uses <code>react-helmet</code> to output meta tags for site description, image, url, and also the social sharing tags so that nice looking cards can be generated on the various social media platforms when someone shares a link to your site.</p>\n<p>A full discussion of how to build this component is out of scope for this post as I just want to focus on how to test it, but the Gatsby docs have a step-by-step <a href=\"https://www.gatsbyjs.com/docs/add-seo-component/\">guide</a> on how to do this. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/SEO.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Helmet } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react-helmet&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { useStaticQuery, graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SEO</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">title</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">description</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">pathname</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> data </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useStaticQuery</span><span class=\"mtk1\">(</span><span class=\"mtk5\">graphql</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    query SEOQuery {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      site {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        siteMetadata {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          defaultTitle: title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          titleTemplate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          defaultDescription: description</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          siteUrl: url</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          defaultImage: image</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  `</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> seo </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    title: title </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> data.site.siteMetadata.defaultTitle,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    description: description </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> data.site.siteMetadata.defaultDescription,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    image: </span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">data.site.siteMetadata.siteUrl</span><span class=\"mtk7\">}${</span><span class=\"mtk1\">image </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> data.site.siteMetadata.defaultImage</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    url: </span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">data.site.siteMetadata.siteUrl</span><span class=\"mtk7\">}${</span><span class=\"mtk1\">pathname </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/&quot;</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Helmet</span><span class=\"mtk1\"> </span><span class=\"mtk5\">title</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">titleTemplate</span><span class=\"mtk7\">={</span><span class=\"mtk1\">data.site.siteMetadata.titleTemplate</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.description</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;image&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.image</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.url </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">property</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;og:url&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.url</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.title </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">property</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;og:title&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.description </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">property</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;og:description&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.description</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.image </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">property</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;og:image&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.image</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;twitter:card&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;summary_large_image&quot;</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.title </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;twitter:title&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.description </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;twitter:description&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.description</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt; </span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">seo.image </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">meta</span><span class=\"mtk1\"> </span><span class=\"mtk5\">name</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;twitter:image&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">content</span><span class=\"mtk7\">={</span><span class=\"mtk1\">seo.image</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Helmet</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In order to test this component, the <code>useStaticQuery</code> hook must be mocked out. This is because the build time GraphQL server may not be running when tests are running and unit tests should not have any external dependencies.</p>\n<p>This can be done in the test, or if there's only one component that uses a static query, the mock can be defined in the global <code>__mocks__/gatsby.js</code>. Unlike the mocked Gatsby <code>navigate</code> function demonstrated earlier, the return result matters because the values will be used to generate the meta tag values, therefore Gatsby's <code>mockImplementation</code> function will be used to have the mock return a result:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// __mocks__/gatsby.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> gatsby </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> jest.</span><span class=\"mtk5\">requireActual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;gatsby&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span><span class=\"mtk1\">gatsby,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other mocks...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// +++ ADD NEW MOCK HERE +++</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  useStaticQuery: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">().</span><span class=\"mtk5\">mockImplementation</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// When component calls useStaticQuery(...), this result will be returned</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      site: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        siteMetadata: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          defaultTitle: </span><span class=\"mtk6\">&quot;Jane Doe Blog&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          titleTemplate: </span><span class=\"mtk6\">&quot;%s · Jane Doe&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          defaultDescription: </span><span class=\"mtk6\">&quot;Blog description.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          siteUrl: </span><span class=\"mtk6\">&quot;https://someblog.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          defaultImage: </span><span class=\"mtk6\">&quot;/images/profile.png&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The other thing that will be different about this test is that the meta tags are not query-able in react testing library. This is because <code>react-helmet</code> renders side effects to the document <code>&#x3C;head></code> element. Instead, the <code>Helmet.peek</code> method is used which returns all the markup assigned to Helmet.</p>\n<p>Here are a few example tests for the Home Page and an Article Page. It gets quite lengthy verifying all the meta tags so will only include a few to demonstrate the idea. See <a href=\"https://github.com/danielabar/meblog/blob/master/src/components/SEO.spec.js\">SEO.spec.js</a> on my blog project on Github for the complete listing.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/SEO.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Helmet </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react-helmet&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> SEO </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./SEO&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;SEO&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders for home page&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">SEO</span><span class=\"mtk1\"> </span><span class=\"mtk5\">title</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Home&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">pathname</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/&quot;</span><span class=\"mtk1\">/&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> helmet </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Helmet.</span><span class=\"mtk5\">peek</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(helmet.title).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Home · Jane Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(helmet.metaTags).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect.</span><span class=\"mtk5\">arrayContaining</span><span class=\"mtk1\">([</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Blog description.&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/images/profile.png&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:url&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;website&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:type&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Home&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:title&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Blog description.&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/images/profile.png&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;summary_large_image&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:card&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Home&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:title&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Blog description.&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/images/profile.png&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders for an article page&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">SEO</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">title</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Article Title&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">description</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Article Description&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">image</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/static/abc123/def/article-image.jpg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">pathname</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/blog/article-slug/&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> helmet </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Helmet.</span><span class=\"mtk5\">peek</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(helmet.title).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Article Title · Jane Doe&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(helmet.metaTags).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect.</span><span class=\"mtk5\">arrayContaining</span><span class=\"mtk1\">([</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Description&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/static/abc123/def/article-image.jpg&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/blog/article-slug/&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:url&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;article&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:type&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Title&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:title&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Description&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/static/abc123/def/article-image.jpg&quot;</span><span class=\"mtk1\">, property: </span><span class=\"mtk6\">&quot;og:image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;summary_large_image&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:card&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Title&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:title&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;Article Description&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:description&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        { content: </span><span class=\"mtk6\">&quot;https://someblog.com/static/abc123/def/article-image.jpg&quot;</span><span class=\"mtk1\">, name: </span><span class=\"mtk6\">&quot;twitter:image&quot;</span><span class=\"mtk1\">, },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<h2>Pagination Logic</h2>\n<p>Another type of component you might want to test is one that implements some business logic. For example, on my site all the blog list pages are paginated, 5 articles at a time, with Previous and Next links shown across the bottom of each list of 5 articles. The display of these links is implemented with a <code>&#x3C;Pagination></code> component that receives some props indicating if this is the first page or last page, and the previous/next page links.</p>\n<p>The rules for this component are that the previous link should be disabled if this is the first page and the next link should be disabled if this is the last page. For any other page, both previous and next links will be enabled. The href for (enabled) previous/next links should be for the page number as provided in the props.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/pagination.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./pagination.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">{!</span><span class=\"mtk1\">props.isFirst </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.prev</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.pagination</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;previous-enabled&quot;</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">={</span><span class=\"mtk1\">props.prevPage</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rel</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;prev&quot;</span><span class=\"mtk1\">&gt; ← prev &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">{</span><span class=\"mtk1\">props.isFirst </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.prev</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.pagination</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.inactive</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;previous-disabled&quot;</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ← prev</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">{!</span><span class=\"mtk1\">props.isLast </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.next</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.pagination</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;next-enabled&quot;</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">={</span><span class=\"mtk1\">props.nextPage</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">rel</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;next&quot;</span><span class=\"mtk1\">&gt; next → &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">{</span><span class=\"mtk1\">props.isLast </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.next</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.pagination</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.inactive</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-testid</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;next-disabled&quot;</span><span class=\"mtk1\"> &gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        next →</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>The tests for this component should cover all possible cases: first page, middle page, last page, and an edge case where there only is one page (first and last links disabled). Each test renders the component with props representing these scenarios, then verifies the presence or absence of expected DOM elements by <code>data-testid</code>.</p>\n<p>If a link is expected, then the test will also verify its expected href value. I couldn't find a convenience <code>getByHref...</code> query from react testing library so the \"escape hatch\" <code>document.querySelector...</code> is used to verify the href attributes of the links.</p>\n<p>Verifying all the expectations gets quite lengthy so this snippet below shows only the tests for first and middle page. See <a href=\"https://github.com/danielabar/meblog/blob/master/src/components/pagination.spec.js\">pagination.spec.js</a> on my blog project on Github for the complete listing.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/pagination.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Pagination </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./pagination&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Pagination&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders first page&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">Pagination</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">isFirst</span><span class=\"mtk7\">={</span><span class=\"mtk4\">true</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">prevPage</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/blog/0&quot;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">isLast</span><span class=\"mtk7\">={</span><span class=\"mtk4\">false</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">nextPage</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/blog/2&quot;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;previous-enabled&quot;</span><span class=\"mtk1\">)).not.</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;previous-disabled&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;next-enabled&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;next-disabled&quot;</span><span class=\"mtk1\">)).not.</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;[data-testid=&#39;next-enabled&#39;] a&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">getAttribute</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;href&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;/blog/2&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;renders middle page&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">Pagination</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">isFirst</span><span class=\"mtk7\">={</span><span class=\"mtk4\">false</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">prevPage</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/blog/3&quot;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">isLast</span><span class=\"mtk7\">={</span><span class=\"mtk4\">false</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">nextPage</span><span class=\"mtk7\">={</span><span class=\"mtk6\">&quot;/blog/5&quot;</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;previous-enabled&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;previous-disabled&quot;</span><span class=\"mtk1\">)).not.</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;next-enabled&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(screen.</span><span class=\"mtk5\">queryByTestId</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;next-disabled&quot;</span><span class=\"mtk1\">)).not.</span><span class=\"mtk5\">toBeInTheDocument</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;[data-testid=&#39;previous-enabled&#39;] a&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">getAttribute</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;href&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;/blog/3&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(document.</span><span class=\"mtk5\">querySelector</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;[data-testid=&#39;next-enabled&#39;] a&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">getAttribute</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;href&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk5\">toEqual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;/blog/5&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span></code></pre>\n<h2>Templates</h2>\n<p>So far all of the test examples have been for components. Pages and templates can also be tested in a similar manner. For example, here is my <code>Post</code> template, which is used to render each post (including the one that you're reading right now), consisting of the article html content, published date, featured image, and title:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Img </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby-image&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./post.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> markdown </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> props.data.markdownRemark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> publishedDate </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> featuredImgFluid </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.featuredImage.childImageSharp.fluid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> content </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> title </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> markdown.frontmatter.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.published</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;Published </span><span class=\"mtk7\">{</span><span class=\"mtk1\">publishedDate</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">Img</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fluid</span><span class=\"mtk7\">={</span><span class=\"mtk1\">featuredImgFluid</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.featureImage</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.content</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> </span><span class=\"mtk5\">dangerouslySetInnerHTML</span><span class=\"mtk7\">={</span><span class=\"mtk1\">{ __html: content }</span><span class=\"mtk7\">}</span><span class=\"mtk1\">/&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Results of graphql query will NOT be available when this a unit test renders this template</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">graphql</span><span class=\"mtk6\">`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  query($slug: String!) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    markdownRemark(fields: { slug: { eq: $slug } }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      frontmatter {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        date(formatString: &quot;DD MMM YYYY&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        featuredImage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          childImageSharp {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            fluid(maxWidth: 800) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">              ...GatsbyImageSharpFluid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      fields {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">`</span></span></span></code></pre>\n<p>The main difference is that for pages or templates that use <code>graphql</code>, recall that this is mocked out, therefore will not return any results. From the initial Gatsby unit test setup <a href=\"(https://www.gatsbyjs.com/docs/how-to/testing/unit-testing/)\">instructions</a>, you should have:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// __mocks__/gatsby.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> gatsby </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> jest.</span><span class=\"mtk5\">requireActual</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;gatsby&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span><span class=\"mtk1\">gatsby,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// All graphql queries are mocked out</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  graphql: jest.</span><span class=\"mtk5\">fn</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// rest of the mocks...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The important thing to understand for testing is when the Gatsby templates are built, results from the graphql query are made available in the <code>data</code> prop. This means that when the template is rendered in a test, simply pass in an example of what the query would have returned as <code>data</code> when rendering, then use snapshot testing:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/templates/post.spec.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { render, screen } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@testing-library/jest-dom&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Post </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./post&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Post&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">it</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Renders in layout&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// An example of what the graphql query used by the Post template returns:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> postData </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      markdownRemark: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fields: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          slug: </span><span class=\"mtk6\">&quot;/blog/some-slug&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date: </span><span class=\"mtk6\">&quot;14 Aug 2021&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title: </span><span class=\"mtk6\">&quot;This is the title&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          featuredImage: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            childImageSharp: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              fluid: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                aspectRatio: </span><span class=\"mtk4\">1.5</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                base64: </span><span class=\"mtk6\">&quot;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4k=&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                sizes: </span><span class=\"mtk6\">&quot;(max-width: 800px) 100vw, 800px&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                src: </span><span class=\"mtk6\">&quot;/static/69f6b/14b42/some-img.jpg&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                srcSet: </span><span class=\"mtk6\">&quot;/static/69f6b/f836f/some-img.jpg 200w, /static/69f6b/2244e/some-img.jpg 400w, /static/69f6b/14b42/some-img.jpg 800w, /static/69f6b/a7715/some-img.jpg 1000w&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        html:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">&quot;&lt;p&gt;Here is the first paragraph&lt;/p&gt;&lt;h2&gt;Sub Heading&lt;/h2&gt;&lt;p&gt;And another paragraph&lt;/p&gt;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Render the template with the data prop to mimic graphql passing results to it:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> container </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">render</span><span class=\"mtk1\">(&lt;</span><span class=\"mtk9 mtki\">Post</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data</span><span class=\"mtk7\">={</span><span class=\"mtk1\">postData</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">expect</span><span class=\"mtk1\">(container).</span><span class=\"mtk5\">toMatchSnapshot</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<h2>Google Fonts Gotcha</h2>\n<p>This section isn't a testing technique, but describes how to get past a Jest error you may encounter when loading fonts.</p>\n<p>When using Google Fonts (or other open source fonts), the recommended solution is to self host them. The <a href=\"https://github.com/fontsource/fontsource\">@fontsource</a> project provides an easy way to do this, making each font available as an npm package. For example, I use <a href=\"https://www.npmjs.com/package/@fontsource/bai-jamjuree\">bai-jamjuree</a> on this site:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/pages/index.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { graphql } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@fontsource/bai-jamjuree/200.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;@fontsource/bai-jamjuree/300.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// rest of the font sizes and home page...</span></span></span></code></pre>\n<p>However, when running a Jest test for a page that loads fonts from <code>@fontsource</code>, it will fail with this error:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">SyntaxError: Invalid or unexpected token</span></span></code></pre>\n<p>The issue is that Jest can't handle static file imports, which includes importing assets such as css and fonts. The solution is to add a regex pattern for <code>@fontsource</code> in the <code>moduleNameMapper</code> section of <code>jest.config.js</code> which tells Jest how to handle various import types (similar to how Webpack works):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// jest.config.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  moduleNameMapper: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;@fontsource/*&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;&lt;rootDir&gt;/__mocks__/font-mock.js&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// other rules...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// other configuration...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Where <code>font-mock</code> simply exports an empty module:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// __mocks__/font-mock.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">module</span><span class=\"mtk1\">.</span><span class=\"mtk9 mtki\">exports</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {};</span></span></span></code></pre>\n<p>Now when a Jest test encounters any import starting with <code>@fontsource</code>, it won't attempt to load the module for real, and instead will replace it with the mock empty module defined in <code>__mocks__/font-mock.js</code>.</p>\n<h2>Jest Test Options</h2>\n<p>This section isn't Gatsby specific, but just want to share a few useful options that can be used on any project that's running tests with Jest.</p>\n<p>During development, it's convenient to have Jest watch for any file changes, and automatically re-run affected tests. This provides nearly instant feedback if anything has broken. Given that you've added <code>\"test\": \"jest\",</code> to <code>package.json</code>, the command to have Jest run in \"watch\" mode is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">npm test -- --watch</span></span></code></pre>\n<p>Jest can also generate a coverage report showing percentage of lines and files in the project that have been \"covered\", i.e. exercised by a test. Don't stress about getting this all the way up to 100% as that can be difficult. Rather, the coverage report is useful to identify areas of the project that are missing or low on tests and see where test coverage could be improved. The command to run tests and generate the coverage report is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">npm test -- --coverage</span></span></code></pre>\n<h2>Conclusion</h2>\n<p>This post has covered how to get started with unit testing on a Gatsby project using Jest and react testing library. It has covered simple snapshot testing, testing components with props, components with children, mocking dependencies globally and per test, user interaction, meta tags, business logic and templates. It has also covered a few different options for how to run the tests. I hope this will encourage everyone who maintains a Gatsby site to go ahead and add some tests.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/gatsby-unit-testing/"}}},{"node":{"id":"848d2c81-d508-5776-ac83-fb1e50ef5848","frontmatter":{"title":"Fix Rails Blocked Host Error with Docker","date":"September 2021","category":"rails"},"excerpt":"This post will demonstrate how to solve the Rails Blocked Host error when running a Rails app in a Docker container. But first, what is the…","html":"<p>This post will demonstrate how to solve the Rails Blocked Host error when running a Rails app in a Docker container.</p>\n<p>But first, what is the blocked host error? The symptom is the following error message is returned when making any request to the server. For example: <code>https://myapp.com</code> would return a 500 error with details:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;Blocked host: myapp.com&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;To allow requests to myapp.com, add the following to your environment configuration:&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;config.hosts </span><span class=\"mtk8\">&lt;&lt;</span><span class=\"mtk1\"> &quot;myapp.com&quot;&lt;/</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p>This happens because as of v6, Rails has introduced a new <code>ActionDispatch::HostAuthorization</code> middleware to prevent <a href=\"https://danielmiessler.com/blog/dns-rebinding-explained/\">DNS rebinding attacks</a>. This middleware is controlled by a new <code>hosts</code> configuration to specify what hosts the server will respond to. Here is the default configuration for development, i.e. when <code>RAILS_ENV=development</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/environments/development.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.configure </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.hosts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;0.0.0.0/0&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk3\"># All IPv4 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;::/0&quot;</span><span class=\"mtk1\">),      </span><span class=\"mtk3\"># All IPv6 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;localhost&quot;</span><span class=\"mtk1\">              </span><span class=\"mtk3\"># The localhost reserved domain.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other config settings...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>This means that when running a Rails server (assume default port 3000) in development mode on your laptop, you could address it as <code>http://localhost:3000</code> or <code>http://127.0.0.1:3000</code> or even by your internal IP address such as <code>http://193.168.1.2:3000</code>.</p>\n<p>In production, if your app should be available at <code>https://myapp.com</code>, then the hosts could be configured as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/environments/production.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.configure </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.hosts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;myapp.com&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other config settings...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>In this case, the Rails server would respond to any requests from <code>https://myapp.com</code>, but not from an IP address such as <code>https://145.83.11.7</code>.</p>\n<h2>Docker and Docker Compose</h2>\n<p>But what happens if you're running microservices, with several Rails apps each running in their own container, that need to make requests to each other?</p>\n<p>Here's the setup: Suppose there is an app called <code>mainapp</code>, and it uses a microservice that provides subscription management services called <code>subscription_service</code>. The <code>mainapp</code> developers don't want to have to checkout and install the code for <code>subscription_service</code> so docker compose is used to ensure all services can be started from the main app.</p>\n<p>Here's a simplified docker-compose file showing only the main app and subscription services. <code>mainapp</code> has all the <code>app</code> code available to it via a host mount because this is the main app under development. <code>subscription_service</code> uses a private image from the <a href=\"https://github.blog/2020-09-01-introducing-github-container-registry/\">Github Container Registry</a> because that is an already built microservice that <code>mainapp</code> depends on.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># docker-compose.yml (mainapp)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">mainapp</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;bundle exec rails s -b &#39;0.0.0.0&#39;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">subscription_service</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ghcr.io/my_org/subscription_service/subscription-app:latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;bundle exec rails s -b &#39;0.0.0.0&#39; -p 4000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;4000:4000&quot;</span></span></span></code></pre>\n<p>Since both <code>mainapp</code> and <code>subscription_service</code> are started in the same docker network created when <code>docker-compose up</code> is run, it should be possible for the main app to make http requests to the subscription service. For example, the subscription service exposes a REST style API to retrieve all plans, with <code>GET {{host}}/api/v1/plans</code>. Therefore, the following code in <code>mainapp</code>, using Faraday to make an http request <em>should</em> work:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Any ruby file in mainapp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">url </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://subscription_service:4000/api/v1/plans&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.get(url, </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">, {</span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># expect response.status to be 200 and response.body to contain list of plans</span></span></span></code></pre>\n<p>But rather than the expected 200 response and a list of plans, a 500 error is returned with the following details:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;Blocked host: subscription_service&lt;/</span><span class=\"mtk7\">h1</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;To allow requests to subscription_service, add the following to your environment configuration:&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;config.hosts </span><span class=\"mtk8\">&lt;&lt;</span><span class=\"mtk1\"> &quot;subscription_service&quot;&lt;/</span><span class=\"mtk7\">pre</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p>The problem is <code>subscription_service</code> is a Rails 6 app, with the default <code>config.hosts</code> specified in <code>config/environments/development.rb</code>. This means it only responds to requests at <code>http://localhost:4000</code> or an IP address. But <code>mainapp</code> is attempting to call <code>http://subscription_service:4000</code> which has not been allowed.</p>\n<h2>Solution</h2>\n<p>The solution is to modify the development configuration in the subscription microservice to allow a host of <code>subscription_service</code>. This is the service name that is specified in the main app's <code>docker-compose.yml</code> file. The modified config looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/environments/development.rb in Subscription service project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.configure </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.hosts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;0.0.0.0/0&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk3\"># All IPv4 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;::/0&quot;</span><span class=\"mtk1\">),      </span><span class=\"mtk3\"># All IPv6 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;localhost&quot;</span><span class=\"mtk1\">,             </span><span class=\"mtk3\"># The localhost reserved domain.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;subscription_service&quot;</span><span class=\"mtk1\">   </span><span class=\"mtk3\"># Allow this to be addressed when running in containers via docker-compose.yml.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other config settings...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>One problem with this solution is it requires that every project that wants to use the subscription microservice to name it <code>subscription_service</code> in their <code>docker-compose.yml</code>. An alternate way to solve this problem while providing more flexibility would be to use an environment variable as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/environments/development.rb in Subscription service project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.configure </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  config.hosts </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;0.0.0.0/0&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk3\"># All IPv4 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">IPAddr</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;::/0&quot;</span><span class=\"mtk1\">),      </span><span class=\"mtk3\"># All IPv6 addresses.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;localhost&quot;</span><span class=\"mtk1\">,             </span><span class=\"mtk3\"># The localhost reserved domain.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ENV[</span><span class=\"mtk6\">&quot;SERVER_HOST_NAME&quot;</span><span class=\"mtk1\">]  </span><span class=\"mtk3\"># Allow this to be addressed when running in containers via docker-compose.yml.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># other config settings...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now suppose a project that wishes to use the subscription microservice would like to refer to it as <code>subs</code>, for example <code>GET http://subs:4000/api/v1/plans</code>. Then they could do so by specifying <code>subs</code> as the value for <code>SERVER_HOST_NAME</code> in the <code>environment</code> section of the subscription service in the docker compose file as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># docker-compose.yml (mainapp)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;3.3&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">mainapp</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">build</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">context</span><span class=\"mtk1\">: </span><span class=\"mtk4\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;bundle exec rails s -b &#39;0.0.0.0&#39;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">volumes</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">.:/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;3000:3000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">subs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">image</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ghcr.io/my_org/subscription_service/subscription-app:latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">command</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash -c &quot;bundle exec rails s -b &#39;0.0.0.0&#39; -p 4000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">ports</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">&quot;4000:4000&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">environment</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">SERVER_HOST_NAME</span><span class=\"mtk1\">: </span><span class=\"mtk6\">subs</span></span></span></code></pre>\n<h2>Conclusion</h2>\n<p>This post has covered what the Rails Blocked Host error is and several different ways to solve it for development and production. See the Rails docs on <a href=\"https://guides.rubyonrails.org/configuring.html#configuring-middleware\">configuring middleware</a> to learn more about <code>ActionDispatch::HostAuthorization</code> middleware.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk8 { color: #F8F8F0; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-blocked-host-docker-fix/"}}},{"node":{"id":"334ba24b-01a2-58f3-9962-67e64296c56e","frontmatter":{"title":"Testing Faraday with RSpec","date":"August 2021","category":"ruby"},"excerpt":"If you've ever developed code that had to integrate with a third party service that didn't have an up-to-date gem available, there's a good…","html":"<p>If you've ever developed code that had to integrate with a third party service that didn't have an up-to-date gem available, there's a good chance you've had to reach for an HTTP client to make requests to the service. <a href=\"https://github.com/lostisland/faraday\">Faraday</a> is a popular choice. It's easy to use and well documented. However, the way in which it gets used will impact how the code can be tested. This post will go through two different ways it can be tested.</p>\n<h2>Setup</h2>\n<p>Suppose you're building an app to display today's weather in a given city. We'll be using the <a href=\"https://www.weatherapi.com/docs/\">Weather API</a> to get the weather data via a restful API that returns JSON data. Usage requires signing up for an API key, but the free tier is very generous and will be adequate for this demo.</p>\n<p>A request to get the current weather and air quality index, for example, for Paris, looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> https://api.weatherapi.com/v1/current.json?key=yourApiKey&amp;q=Paris&amp;aqi=yes</span></span></span></code></pre>\n<p>And the response looks something like this (shortened for brevity):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;location&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;name&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Paris&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;country&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;France&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;localtime&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-08-08 23:00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;current&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;last_updated&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-08-08 22:00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;temp_c&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">18.0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;condition&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;text&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Partly cloudy&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;icon&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;//cdn.weatherapi.com/weather/64x64/night/116.png&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;code&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1003</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;feelslike_c&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">18.0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;uv&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">4.0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;air_quality&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;us-epa-index&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Here is the first attempt at writing the <code>WeatherClient</code> using Faraday. It exposes a single method <code>today</code> that makes a <code>Faraday.get</code> request to the weather api, and parses the response to return a sentence such as:</p>\n<p>\"Weather for Paris, France is 18 degrees. Cloudy. Air quality is Good.\"</p>\n<p>The mapping of <code>us-epa-index</code> to an air quality string such as <code>Good</code>, <code>Moderate</code> etc. comes from the Weather API docs. <a href=\"https://github.com/bkeepers/dotenv\">dotenv</a> is used to avoid hard-coding the API key and instead pull it from a git ignored <code>.env</code> file.</p>\n<p>This is a plain old Ruby project with no Rails, so the dependencies are required:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/weather_client.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;dotenv/load&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;faraday&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;json&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">today</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.get(</span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1/current.json&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parse_today(</span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">.parse(response.body))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">parse_today</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">json</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    location </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> json[</span><span class=\"mtk6\">&#39;location&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    current </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> json[</span><span class=\"mtk6\">&#39;current&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    condition </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> current[</span><span class=\"mtk6\">&#39;condition&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;Weather for </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">location[</span><span class=\"mtk6\">&#39;name&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">location[</span><span class=\"mtk6\">&#39;country&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> is </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">current[</span><span class=\"mtk6\">&#39;temp_c&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> degrees. </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">condition[</span><span class=\"mtk6\">&#39;text&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\"> Air quality is </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">air_quality(current[</span><span class=\"mtk6\">&#39;air_quality&#39;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&#39;us-epa-index&#39;</span><span class=\"mtk1\">])</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">air_quality</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">aq_val</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    aq_map </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">1</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Good&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">2</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Moderate&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">3</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Unhealthy for sensitive groups&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">4</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Unhealthy&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">5</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Very Unhealthy&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">6</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Hazardous&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    aq_map[aq_val] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Unknown&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Some example usage in an irb console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">irb -r ./app/weather_client.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">irb(main):001:0&gt; WeatherClient.new.today(city: &#39;Paris&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=&gt; &quot;Weather for Paris, France is 17.0 degrees. Partly cloudy. Air quality is Good&quot;</span></span></code></pre>\n<h2>1. RSpec Stubbing</h2>\n<p>How to write a test for <code>WeatherClient</code>? Calling out to the Weather API is a side effect, and tests should not have any side effects. For example, each call uses up request quota for the API key. Even if usage were unlimited, this code is requesting the <em>current</em> weather. This means at any given day/time, the response could be different so it will be impossible to write a test expecting a specific result. Another consideration is the Weather API could go down at the same instance when the test is run, this would cause the test to fail even though no code changes had been made on this app.</p>\n<p>Since the <code>today</code> method calls <code>Faraday.get</code> directly, RSpec stubbing must be used to set the returned response of the <code>Faraday.get</code> method for the test. This will prevent a real HTTP request from being sent when the test is run and instead return a canned response of our design. In order to do this, we must know what kind of object is returned by <code>Faraday.get</code>, which is a <code>Faraday::Response</code>.</p>\n<p>Then the code calls the <code>body</code> method of the returned <code>Faraday::Response</code> object, this contains the string content of the Weather API response. In order for this to work in a test, the stub of <code>Faraday.get</code> must return a test double, which will stand in for the <code>Faraday::Response</code> object. Then the <code>body</code> method of the test double is also stubbed to return the actual string response.</p>\n<p>Here is the test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/weather_client_spec.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;./app/weather_client_old&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">RSpec</span><span class=\"mtk1\">.describe WeatherClient </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&#39;#today&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;gets current weather for a city&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># stub Faraday `get` method to avoid making a real HTTP request when test is run</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      response_dbl </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> instance_double(</span><span class=\"mtk6\">&#39;Faraday::Response&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      allow(Faraday).to receive(</span><span class=\"mtk4\">:get</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .with(</span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1/current.json&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Paris&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .and_return(response_dbl)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># stub body method on response object to return a canned response for Paris weather</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      allow(response_dbl).to receive(</span><span class=\"mtk4\">:body</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .and_return(</span><span class=\"mtk6\">&#39;{&quot;location&quot;:{&quot;name&quot;:&quot;Paris&quot;,&quot;country&quot;:&quot;France&quot;},&quot;current&quot;:{&quot;temp_c&quot;:16.0,&quot;condition&quot;:{&quot;text&quot;:&quot;Clear&quot;},&quot;air_quality&quot;:{&quot;us-epa-index&quot;:1}}}&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      paris_weather </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> described_class.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">.today(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Paris&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(paris_weather).to eq(</span><span class=\"mtk6\">&#39;Weather for Paris, France is 16.0 degrees. Clear. Air quality is Good&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h3>Problems</h3>\n<p>While this works, it feels a little clunky. It requires knowing some details of Faraday like the fact that calling <code>get</code> returns a <code>Faraday::Response</code> object. If a future release of Faraday will refactor to return a different object, then this test will fail even the refactored object behaves exactly the same as in the previous version. Generally speaking, use of stubs/mocks can make a test brittle because its verifying some implementation details rather than focusing on the expected return value of a method.</p>\n<p>Also the double stubbing required - once for <code>Faraday.get</code> and again for the response double it returns, makes the test hard to read.</p>\n<p>Another issue occurs when trying to add another Weather API request. For example, in addition to the current weather <code>/current.json</code>, there's another endpoint for the future weather at <code>/forecast.json</code>. When using <code>Faraday.get</code>, each request has to repeat the base url, headers, and common parameters such as the API key, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">today</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.get(</span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1/current.json&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parse_today(</span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">.parse(response.body))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Some duplication with `today` method including base url, headers, and setting of API key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">forecast</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.get(</span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1/forecast.json&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with response...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>2. Faraday Stubbing</h2>\n<p>Fortunately, Faraday provides a cleaner solution for testing, which will be explained in this section. This will require some refactoring and introducing several new concepts.</p>\n<h3>Faraday Connection</h3>\n<p>First, to fix the issue of code duplication - that every request to the API requires repeating the base url and common parameters. Faraday provides a <code>Faraday::Connection</code> object to store common configuration. Subsequent http requests such as <code>get</code>, <code>post</code>, etc. can be made on the connection object.</p>\n<p>To create a connection object, call <code>Faraday.new</code>. For example, the <code>today</code> method on <code>WeatherClient</code> could be written like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">today</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">url:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">params:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">] },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> conn.get(</span><span class=\"mtk6\">&#39;current.json&#39;</span><span class=\"mtk1\">, { </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city, </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parse_today(</span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">.parse(response.body))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>At this point, it doesn't seem like much of an improvement because all the common logic (base url, api key and headers) are still in the <code>today</code> method.</p>\n<p>The beauty of this approach comes when pulling out the connection object into the <code>initialize</code> method and making it an instance variable. Then it can be shared among multiple API methods without having to repeat the base url, api key and headers. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">url:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">params:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">] },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">today</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> @conn.get(</span><span class=\"mtk6\">&#39;current.json&#39;</span><span class=\"mtk1\">, { </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city, </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parse_today(</span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">.parse(response.body))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">future</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> @conn.get(</span><span class=\"mtk6\">&#39;forecast.json&#39;</span><span class=\"mtk1\">, { </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with response...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Ok so the code duplication issue has been solved with use of an instance <code>Faraday::Connection</code> object, but how does this help with testing?</p>\n<h3>Faraday Test Adapter</h3>\n<p>Faraday comes with a built-in test adapter for defining stubbed HTTP requests to mock out network services. A <code>Faraday::Connection</code> object can then be instantiated using the test adapter. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Test adapter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">stubs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Adapter</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Test</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Stubs</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Instantiate a connection that uses the test adapter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\"> { |b| b.adapter(</span><span class=\"mtk4\">:test</span><span class=\"mtk1\">, stubs) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Define any number of mock network requests on the test adapter, which yields an array of three elements:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   1. HTTP response code</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   2. Hash of HTTP response headers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   3. String of HTTP response body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">stubs.get(</span><span class=\"mtk6\">&#39;/some-endpoint&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">200</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk6\">&#39;Content-Type&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&#39;{&quot;name&quot;: &quot;some canned response for testing&quot;}&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>If the stubbed connection object <code>conn</code> gets used to make an HTTP request that matches what is stubbed, then the HTTP response code will be 200 and the response body will be the canned response. No real network request to <code>/some-endpoint</code> will be made. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">resp </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> conn.get(</span><span class=\"mtk6\">&#39;/some-endpoint&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">resp.status </span><span class=\"mtk3\"># 200</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">resp.headers </span><span class=\"mtk3\"># { &#39;Content-Type&#39;: &#39;application/json&#39; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">resp.body </span><span class=\"mtk3\"># &#39;{&quot;name&quot;: &quot;some canned response for testing&quot;}&#39;</span></span></span></code></pre>\n<p>So the next question is - how to make <code>WeatherClient</code> use this stubbed connection object instead of a real connection object when running tests? This leads to the last and final concept that will tie this all together.</p>\n<h3>Dependency Injection</h3>\n<p>Dependency injection will allow us to \"inject\" a stubbed Faraday connection into <code>WeatherClient</code> for testing purposes. But first, what is dependency injection? According to <a href=\"https://en.wikipedia.org/wiki/Dependency_injection\">Wikipedia</a>:</p>\n<blockquote>\n<p>In software engineering, dependency injection is a technique in which an object receives other objects that it depends on, called dependencies. Typically, the receiving object is called a client and the passed-in ('injected') object is called a service. The code that passes the service to the client is called the injector. Instead of the client specifying which service it will use, the injector tells the client what service to use. The 'injection' refers to the passing of a dependency (a service) into the client that uses it.</p>\n</blockquote>\n<p>In this example, <code>WeatherClient</code> is the \"receiving object\", and the \"service\" we want to pass in is a <code>Faraday::Connection</code>. The problem with the current implementation of <code>WeatherClient</code> is that the initializer <em>always</em> instantiates a new instance of <code>Faraday::Connection</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># always constructs a new Faraday::Connection object</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">url:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">params:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">] },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>To make <code>WeatherClient</code> support injecting a connection object, the <code>initialize</code> method is modified to optionally accept a <code>conn</code> parameter, and either use the provided parameter, or if not specified, instantiate a new Faraday connection object:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Make Faraday connection injectable for easier testing.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">conn</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> conn </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">url:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">params:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">] },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>And finally, a test can be written against this version of <code>WeatherClient</code>, initializing it with a stubbed <code>Faraday::Connection</code> to avoid making real HTTP requests:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;./app/weather_client&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">RSpec</span><span class=\"mtk1\">.describe WeatherClient </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Faraday test adapter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  let(</span><span class=\"mtk4\">:stubs</span><span class=\"mtk1\">) { </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Adapter</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Test</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Stubs</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Faraday::Connection object that uses the test adapter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  let(</span><span class=\"mtk4\">:conn</span><span class=\"mtk1\">) { </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\"> { |b| b.adapter(</span><span class=\"mtk4\">:test</span><span class=\"mtk1\">, stubs) } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># WeatherClient with the stubbed connection object injected</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  let(</span><span class=\"mtk4\">:client</span><span class=\"mtk1\">) { described_class.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(conn) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Clear default connection to prevent it from being cached between different tests.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This allows for each test to have its own set of stubs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  after </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.default_connection </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&#39;#today&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;gets current weather for a city&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Block yields an array with 3 items:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">#   1. HTTP response code</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">#   2. Hash of headers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">#   3. String response body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      stubs.get(</span><span class=\"mtk6\">&#39;current.json&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">200</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          { </span><span class=\"mtk6\">&#39;Content-Type&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">&#39;{&quot;location&quot;:{&quot;name&quot;:&quot;Paris&quot;,&quot;country&quot;:&quot;France&quot;},&quot;current&quot;:{&quot;temp_c&quot;:16.0,&quot;condition&quot;:{&quot;text&quot;:&quot;Clear&quot;},&quot;air_quality&quot;:{&quot;us-epa-index&quot;:1}}}&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      paris_weather </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> client.today(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Paris&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(paris_weather).to eq(</span><span class=\"mtk6\">&#39;Weather for Paris, France is 16.0 degrees. Clear. Air quality is Good&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Verify every stubbed method that was defined on test adapter actually got called when code was exercised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      stubs.verify_stubbed_calls</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Which Approach to Use?</h2>\n<p>My preference is to use the built-in Faraday test adapter whenever possible because it results in cleaner looking tests and is officially supported by the library. However, as with most technical decisions, the correct answer is, it depends.</p>\n<p>If you're fortunate to be green fielding a project, or at the very least, the client class that will be making HTTP requests, then go ahead and design the class with dependency injection and use the built-in Faraday test adapter.</p>\n<p>If on the other hand, you're dealing with legacy code that uses the Faraday class helper methods such as <code>Faraday.get</code>, <code>Faraday.post</code>, then the safest solution may be to use regular RSpec stubbing. The exception to this would be if the project has really solid end-to-end test coverage, then you could consider refactoring some of the legacy code that uses Faraday to make it easier to test.</p>\n<h2>Conclusion</h2>\n<p>This post has covered two different ways of using and testing Faraday for making HTTP requests to an external service. The first approach is to use Faraday's class helper methods, and test with regular RSpec stubbing. Although this works, it can lead to brittle, difficult to read tests, but may be the safest option when dealing with legacy code. The second approach is to design the client class with dependency injection, then use Faraday's built-in test adapter to inject a stubbed connection into the class for testing. This results in cleaner, easier to read tests.</p>\n<p>All the code used in this post can be found on <a href=\"https://github.com/danielabar/ruby-weather\">Github</a>.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/testing-faraday-with-rspec/"}}},{"node":{"id":"489497a9-2600-5b48-aa26-a2ea8b93b5d0","frontmatter":{"title":"Add Rubocop to an Existing Rails Project","date":"July 2021","category":"rails"},"excerpt":"I think Rubocop is awesome! There are some that find it (and linters in general) annoying, even leading to git commit messages along the…","html":"<p>I think Rubocop is awesome! There are some that find it (and linters in general) annoying, even leading to git commit messages along the lines of \"F@%#^!ng rubocop\". But for me, coding with Rubocop is like having a wizard with the entire collective wisdom of the Ruby community sitting beside me, pointing out where improvements could be made, resulting in more idiomatic Ruby.</p>\n<p>Before going any further, for those unfamiliar with what is Rubocop, from the <a href=\"https://github.com/rubocop/rubocop\">docs</a>:</p>\n<blockquote>\n<p>RuboCop is a Ruby static code analyzer (a.k.a. linter) and code formatter. Out of the box it will enforce many of the guidelines outlined in the community Ruby Style Guide. Apart from reporting the problems discovered in your code, RuboCop can also automatically fix many of them for you.</p>\n</blockquote>\n<p>Whenever starting a new Rails project, one of my first commits is to install and configure Rubocop, plus a few extensions for rules specific to Rails, performance, and thread safety. This keeps the code consistent and in line with best practices no matter how many developers are working on the project.</p>\n<p>However, sometimes you may be working on a legacy project that was not started with Rubocop. In this case, it’s still valuable to bring it in, but there are some challenges. Given that the entire history of the project was developed without a linter, there will likely be many offences. Could be hundreds or more, and offences of all different types. It can be overwhelming to go through all the output. Some of these may be easy to fix like extra empty lines before an ending block, and some may be more difficult like reducing complexity of a method with too much branching logic. As always, any code changes may cause unintended bugs.</p>\n<p>This post will walk you through a 4 step process for introducing Rubocop into an existing legacy project while minimizing the chances of breaking production, and maintaining your sanity. Some working knowledge of Rubocop is assumed. If you haven't used it before, go through the <a href=\"https://docs.rubocop.org/rubocop/1.18/index.html\">intro docs</a> and <a href=\"https://docs.rubocop.org/rubocop/1.18/usage/basic_usage.html\">basic usage</a>.</p>\n<h2>1. Test Coverage</h2>\n<p>Before making any changes, verify the project has decent test coverage. This should include unit/model tests for business logic and database interactions, request tests for all exposed API endpoints and web/end-to-end tests (aka Acceptance tests) for all essential web flows. This last category of tests can be the most difficult and time consuming to setup but is essential before bringing in a linter on a legacy project. It’s not necessary to have every single user interaction covered by web tests, but at the very least, identify the most essential flows to your business and make sure these are covered. For example, for an e-commerce site, this might include search, add to cart, and checkout.</p>\n<h2>2. Install Rubocop and Autocorrect</h2>\n<p>Add rubocop to the project Gemfile and run <code>bundle install</code>. Then create a <code>.rubocop.yml</code> configuration file in the project root. I typically exclude Rails auto generated files and disable the <code>Style/Documentation</code> rule. Although I'm a huge fan of <em>useful</em> documentation, have found that when the <code>Style/Documentation</code> is enabled, developers may write comments like \"Customer Model\" for <code>class Customer &#x3C; ApplicationRecord</code> just to get the rule to pass.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">AllCops</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">NewCops</span><span class=\"mtk1\">: </span><span class=\"mtk6\">enable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Exclude</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;db/schema.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;Gemfile&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;lib/tasks/*.rake&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;bin/*&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;config/puma.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;config/spring.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;config/environments/development.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;config/environments/production.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;spec/spec_helper.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Style/Documentation</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">false</span></span></span></code></pre>\n<p>Just to get a sense of how many rule offenses are currently in the project, run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop</span></span></code></pre>\n<p>You'll probably get multiple screen fulls of output scrolling past, with a summary such as (this is an example from a project from my recent experience with this):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">96 files inspected, 270 offenses detected, 215 auto-correctable</span></span></code></pre>\n<p>At this point, it's hard to make sense of all the output or know where to start. To help organize all this, Rubocop has several format options, one of which is <code>--format offenses</code>. This will summarize how many occurrences of each rule violation it found, and order them by descending occurrence. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop --format offenses</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">56   Layout/FirstHashElementIndentation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">54   Layout/HashAlignment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">18   Metrics/BlockLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">16   Metrics/MethodLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">16   Style/StringLiterals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">14   Style/TrailingCommaInHashLiteral</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">13   Layout/LineLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">12   Layout/EmptyLinesAroundClassBody</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">8    Layout/SpaceInsideHashLiteralBraces</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">7    Layout/SpaceAfterComma</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">6    Layout/ExtraSpacing</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">6    Layout/SpaceInsideStringInterpolation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4    Layout/TrailingEmptyLines</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4    Metrics/AbcSize</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3    Layout/EmptyLinesAroundBlockBody</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Layout/ArgumentAlignment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Layout/EmptyLinesAroundModuleBody</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Layout/SpaceInsideArrayLiteralBrackets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Lint/SymbolConversion</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Metrics/CyclomaticComplexity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Naming/VariableNumber</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Style/IdenticalConditionalBranches</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Style/IfUnlessModifier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Style/RedundantBegin</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/EmptyLineAfterGuardClause</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/EmptyLineAfterMagicComment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/EmptyLines</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/SpaceInsideBlockBraces</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/TrailingWhitespace</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Metrics/ModuleLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Metrics/PerceivedComplexity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Naming/ConstantName</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/AndOr</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/MutableConstant</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/RedundantParentheses</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/RedundantReturn</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/RedundantSelf</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/SafeNavigation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/SymbolArray</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">270  Total</span></span></code></pre>\n<p>This seems like a lot of work to go through manually and fix all these. Luckily, Rubocop has an autocorrect option that will update the code to fix any offenses where the rule is auto-correctable. To see if a rule is auto-correctable or not, see the <a href=\"https://docs.rubocop.org/rubocop/1.18/cops.html\">Cops documentation</a>. For example, from the above summary report, there are 56 occurrences of the <code>Layout/FirstHashElementIndentation</code> violation. According to the <a href=\"https://docs.rubocop.org/rubocop/1.18/cops_layout.html#layoutfirsthashelementindentation\">docs</a> for this rule, it supports autocorrection.</p>\n<p>Now run Rubocop with the autocorrect flag, I'm using the \"safe\" version of this <code>-a</code> rather than \"all\" <code>-A</code>. Slight difference that some rules are autocorrectable, but not necessarily safe in they may change semantics of the code or generate false positives (detecting a rule offense when there is none really).</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop -a</span></span></code></pre>\n<p>You'll see all the same scrolling output as before as it finds each rule violation, but this time it will also show <code>[Corrected]</code> beside all the ones that were auto corrected. At this point, there will probably be a lot of changed files. Review these changes with <code>git status</code> and <code>git diff</code> or git <code>difftool</code>, run tests, and if all the tests pass, commit the changes.</p>\n<h2>3. Inventory Remaining Offenses</h2>\n<p>At this point, all the easy fixes have been done. Now we're entering into trickier territory. Let's run the summary report again to see how many offenses are left to deal with. An example from a recent project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop --format offenses</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">19  Metrics/MethodLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">18  Metrics/BlockLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">13  Layout/LineLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4   Metrics/AbcSize</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2   Metrics/CyclomaticComplexity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2   Metrics/ModuleLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2   Naming/VariableNumber</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Lint/EmptyConditionalBody</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Metrics/PerceivedComplexity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Naming/ConstantName</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Style/MutableConstant</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Style/SafeNavigation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">65  Total</span></span></code></pre>\n<p>Well, this is a lot better than the 270 that we started with, autocorrect was able to reduce the offenses by ~75% on this project. But what to do about the remaining offenses? Notice these are areas of the code where potentially significant refactoring needs to be done which could break functionality.</p>\n<p>For example <code>Metrics/MethodLength</code> refers to the number of lines in a method. According to the <a href=\"https://docs.rubocop.org/rubocop/1.18/cops_metrics.html#metricsmethodlength\">docs</a> for this rule, the default <code>Max</code> value is 10. Your project may have some big hairy methods that are way longer than this and difficult to break up in a meaningful way.</p>\n<p>An even trickier one to deal with is <code>Metrics/AbcSize</code>. This <a href=\"https://docs.rubocop.org/rubocop/1.18/cops_metrics.html#metricsabcsize\">rule</a> calculates a score based on the number of assignments, branches (aka method calls), and conditions in a given method. The default <code>Max</code> value for this rule is 17. It can be difficult to reduce this score, it could be on some methods that are very complicated and not well understood. Perhaps the original developer that worked on it is no longer at the company and the tests aren't that helpful in explaining what the method does.</p>\n<p>My approach when bringing in Rubocop is not to make any logical changes to the existing code. The Pull Request will already be quite large due to the easy auto-correctable offenses. It will be difficult for the PR reviewers scanning through all the changes to catch potentially breaking logical changes among all the trivial auto-corrected changes. There may also be differences among the team on how to approach the logical changes, while not requiring any discussion for the auto-corrected changes.</p>\n<h2>4. Tune Remaining Offenses</h2>\n<p>So how to get Rubocop to pass at this point? A naive approach is to simply disable all the remaining rules, for example, add to <code>.rubocop.yml</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/MethodLength</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/AbcSize</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># etc for each rule that couldn&#39;t be auto-corrected</span></span></span></code></pre>\n<p>The problem with the naive approach is that there's nothing to stop the code quality from getting worse as more features are added to the project. For example, the next developer to work on a method with a high <code>AbcSize</code> score won't get a warning when they go to add another assignment to the offending method, and the next developer and the next after that. The complexity will keep increasing.</p>\n<p>A better approach is to capture the existing maximum value for every rule, and configure that as the maximum allowed on this project. What this does is effectively draw a line in the sand to express: \"Yeah we know it's not great but at least things will get no worse\". For example, suppose the longest method length in your project is 25 and you don't want it to get any worse than that in the future, then you'd add the following to <code>.rubocop.yml</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/MethodLength</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Max</span><span class=\"mtk1\">: </span><span class=\"mtk4\">25</span></span></span></code></pre>\n<p>Then the next developer to modify this method, say to add a new feature or fix a bug will get a warning that the maximum has been exceeded. A refactor can be undertaken at that time, which will be more comprehensible in the scope of just that feature, rather than in the massive Rubocop pull request.</p>\n<p>So the next question is - how do you go about finding the max violation values in the project? Clearly no one is going to go around manually counting method lengths or calculating <code>AbcSize</code> scores.</p>\n<p>There are two ways to do this, the first involves more effort but is useful for understanding what's going on. The second way is more automated. Let's start with the manual method just to get a better understanding.</p>\n<h3>Manual Tuning</h3>\n<p>For each of the rules that could not be auto-corrected, run rubocop, filtering the output for just that rule. For example, to see only the <code>Metrics/MethodLength</code> violations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop | grep &quot;MethodLength&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/controllers/application_controller.rb:3:3: C: Metrics/MethodLength: Method has too many lines. [12/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/controllers/base_acme_controller.rb:2:3: C: Metrics/MethodLength: Method has too many lines. [12/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/controllers/endpoint_tester_controller.rb:20:3: C: Metrics/MethodLength: Method has too many lines. [26/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/controllers/healthcheck_controller.rb:8:3: C: Metrics/MethodLength: Method has too many lines. [13/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/client.rb:38:5: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/some_feature.rb:23:7: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/some_feature.rb:46:7: C: Metrics/MethodLength: Method has too many lines. [13/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/another_feature.rb:24:7: C: Metrics/MethodLength: Method has too many lines. [18/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/another_feature.rb:50:7: C: Metrics/MethodLength: Method has too many lines. [18/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/another_feature.rb:76:7: C: Metrics/MethodLength: Method has too many lines. [22/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/another_feature.rb:106:7: C: Metrics/MethodLength: Method has too many lines. [31/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:23:7: C: Metrics/MethodLength: Method has too many lines. [13/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:44:7: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:67:7: C: Metrics/MethodLength: Method has too many lines. [14/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:89:7: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:112:7: C: Metrics/MethodLength: Method has too many lines. [13/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:133:7: C: Metrics/MethodLength: Method has too many lines. [16/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:157:7: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:23:7: C: Metrics/MethodLength: Method has too many lines. [11/10]</span></span></code></pre>\n<p>Notice at the end of each line, there are two numbers shown in square brackets, for example <code>[15/10]</code>. The first number is the value count for this instance of the rule violation, the second number is the default or max configured value. So <code>[15/10]</code> means the method has 15 lines, but the maximum allowed is 10.</p>\n<p>Looking at the above output, we can see that the maximum method length is 31. That's not great, but remember, we're not trying to optimize at this point, just prevent things from getting worse. So this would get added to <code>.rubocop.yml</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/MethodLength</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Max</span><span class=\"mtk1\">: </span><span class=\"mtk4\">31</span></span></span></code></pre>\n<p>Repeat this for every rule that has a <code>Max</code> value that can be configured. For other rules such as <code>Naming/ConstantName</code> or <code>Style/SafeNavigation</code>, use your judgement if its just a small number of occurrences, and its easy to fix, go ahead, otherwise, disable the rule in <code>.rubocop.yml</code>.</p>\n<h3>Automatic Tuning</h3>\n<p>An easier way is to run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop --auto-gen-config</span></span></code></pre>\n<p>This will generate a <code>.rubocop-todo.yml</code> file listing all the offenses and excluding the specific files in your project that violate the rules. For rules that have a <code>Max</code> value, it will determine the largest value from your project and configure the rule with that value. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop-todo.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Offense count: 4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Configuration parameters: IgnoredMethods, CountRepeatedAttributes.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/AbcSize</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Max</span><span class=\"mtk1\">: </span><span class=\"mtk4\">38</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Offense count: 19</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Configuration parameters: CountComments, CountAsOne, ExcludedMethods, IgnoredMethods.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/MethodLength</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Max</span><span class=\"mtk1\">: </span><span class=\"mtk4\">31</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Offense count: 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Naming/ConstantName</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Exclude</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&#39;lib/acme/logger_formatter.rb&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ...</span></span></span></code></pre>\n<p>It also generates (or updates existing) a <code>.rubocop.yml</code> that inherits from the todo file. This way rubocop passes with no code changes (because all the offenses are effectively ignored). Then you can go over each configured rule in the <code>.rubocop-todo.yml</code> and bring it over to <code>.rubocop.yml</code>.</p>\n<p>Whichever option you chose (manual or automatic tuning), at the end of this process, you should have some changes to <code>.rubocop.yml</code> and minimal if any code changes. Review the changes, run tests, and commit. Now you're ready to submit a pull request for adding Rubocop to a legacy project.</p>\n<h2>Conclusion</h2>\n<p>This post has covered a 4 step process for how to introduce Rubocop into a legacy project while avoiding a lot of manual effort, and minimizing the chances of breaking things.</p>\n<p>The first step was to ensure good test coverage, especially end-to-end tests for flows that are essential to the business. The second step was to install Rubocop and use the safe auto-correct feature. The third step was to use the summary reporting feature to take an inventory of the remaining offenses. The fourth step was to tune each remaining offense to ensure that code quality will get no worse as the project moves forward.</p>\n<p>I hope this will encourage others to bring in Rubocop into old legacy projects to start taking advantage of its many benefits.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/add-rubocop-to-legacy-project/"}}}]}},"pageContext":{}},"staticQueryHashes":["163244226"]}