{
    "componentChunkName": "component---src-pages-index-js",
    "path": "/",
    "result": {"data":{"allMarkdownRemark":{"totalCount":44,"edges":[{"node":{"id":"c05066a2-3b0b-5ae4-b724-05d4506939f9","frontmatter":{"title":"Automate Keyboard with Mac","date":"December 2021","category":"OSX"},"excerpt":"This post will explain how to automate a series of key sequences on a Mac and assign a keyboard shortcut to play the entire sequence. But…","html":"<p class=\"markdown-para\">This post will explain how to automate a series of key sequences on a Mac and assign a keyboard shortcut to play the entire sequence. But first, a little background on how I came to be solving this particular problem.</p>\n<p class=\"markdown-para\">I recently found myself having to use a website to perform a critical task. This website required constantly refreshing, as in every second, to get up to date data. However, pressing the browser refresh button or keyboard shortcut for refresh triggered navigation to the previous page rather than refreshing the current data. The only way to force a refresh on the current page was to select a different value from a dropdown that had values for number of kilometers away for the location data being displayed. For example, 10km away, 20km away, etc.</p>\n<p class=\"markdown-para\">At first I was using the mouse to do this which involved one click on the dropdown control to open it, and another click on any option other than the currently selected one. However, after a few minutes of this, my right wrist (mouse hand) began to ache. Fortunately the dropdown was keyboard accessible, and could be manipulated with the following key sequence:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><kbd class=\"markdown-kbd\">Space</kbd> to open the dropdown.</li>\n<li class=\"markdown-list-item\"><kbd class=\"markdown-kbd\">Tab</kbd> to move the focus to the next selection within the open dropdown.</li>\n<li class=\"markdown-list-item\"><kbd class=\"markdown-kbd\">Down Arrow</kbd> to select the next option, if current selection was last in the list, this would circle around to the first selection.</li>\n<li class=\"markdown-list-item\"><kbd class=\"markdown-kbd\">Enter</kbd> to submit the change.</li>\n</ul>\n<p class=\"markdown-para\">However, after several more minutes of refreshing via keyboard, both my wrists started to ache. This is something to watch out for if you type for a living, a repetitive strain injury can put a serious dent in your career. That's why seeking out automation solutions to replace repetitive tasks is so important. In this case, I wasn't seeking to replace the entire workflow, only this small repetitive sequence that was causing wrist strain.</p>\n<aside class=\"markdown-aside\">\nThe automation solution described in this post is not a bot that scoops up concert tickets or causes other such mischief by impersonating human users. It is only to automate a small repetitive sequence that is otherwise painful to execute over and over. A real human is still required to provide personal information to authenticate to the website and get to the location selection screen.\n</aside>\n<p class=\"markdown-para\">You would think there was a built-in macro recorder on Mac for this sort of thing, but that's not the case. There are a few third party apps, some paid, some freemium, but it seemed like overkill to install an app just for this small automation. It turns out, it is possible to do with native Mac apps, but the solution is not intuitive. There are four parts to the solution:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Use the built-in <a href=\"https://support.apple.com/en-ca/guide/script-editor/welcome/mac\" class=\"markdown-link\">Script Editor</a> app to write an <a href=\"https://developer.apple.com/library/archive/documentation/AppleScript/Conceptual/AppleScriptLangGuide/introduction/ASLR_intro.html\" class=\"markdown-link\">AppleScript</a> script to activate Chrome (or whatever browser) and send the key sequences as system events.</li>\n<li class=\"markdown-list-item\">Use the built-in <a href=\"https://support.apple.com/en-ca/guide/automator/welcome/mac\" class=\"markdown-link\">Automator</a> app to \"register\" the AppleScript as a service.</li>\n<li class=\"markdown-list-item\">Use the <a href=\"https://support.apple.com/en-mide/guide/mac-help/kbdm162/mac\" class=\"markdown-link\">Keyboard Preferences</a> to assign a keyboard shortcut to the newly registered service.</li>\n<li class=\"markdown-list-item\">Enable the Automator, Script Editor, and the custom script to control your computer in the <a href=\"https://support.apple.com/en-ae/guide/mac-help/mh32356/mac\" class=\"markdown-link\">Security &#x26; Privacy</a> -> Accessibility preferences.</li>\n</ol>\n<p class=\"markdown-para\">Ok, let's dive into each of these.</p>\n<h2 class=\"markdown-subtitle\" id=\"1-ScriptEditor\" style=\"position:relative;\"><a href=\"#1-ScriptEditor\" aria-label=\"1 ScriptEditor permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. ScriptEditor</h2>\n<p class=\"markdown-para\">Launch the <a href=\"https://support.apple.com/en-ca/guide/script-editor/welcome/mac\" class=\"markdown-link\">Script Editor</a> app, create a new file, and enter the following AppleScript code. <code>tell</code> is is a statement that sends a command to a script object:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"applescript\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">tell</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">application</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Google Chrome&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">to</span><span class=\"mtk1\"> </span><span class=\"mtk9\">activate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">tell</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">application</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;System Events&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">-- Space</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk9\">key code</span><span class=\"mtk1\"> </span><span class=\"mtk4\">49</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">-- Tab</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk9\">key code</span><span class=\"mtk1\"> </span><span class=\"mtk4\">48</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">-- Down Arrow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk9\">key code</span><span class=\"mtk1\"> </span><span class=\"mtk4\">123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">-- Enter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk9\">key code</span><span class=\"mtk1\"> </span><span class=\"mtk4\">76</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end tell</span></span></span></code></pre>\n<p class=\"markdown-para\">This script ensures that Chrome is the active application, and then uses the <code>key code</code> command to emulate key presses using Apple's system events. You're not limited to these key codes of course, you can script any sequence you like using this <a href=\"https://eastmanreference.com/complete-list-of-applescript-key-codes\" class=\"markdown-link\">reference</a>:</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPElEQVQ4y2VTS0uyYRB9/5U/I3BRIQmBJKSYl+yeFyxv5aKNaCl2I1BQEKLMu5bt2wpCpIjYplxUtjofZ+D1U1ocznNmRuc4MyofHx94f3+fYDgcTt6fn58zYC0xrad5NBpBOTs7QywWQyqVAt/ExcWF6NPTU5yfn0/ijMXjcSSTSamJRqOSJ05OTtDpdKAUi0WUSiU0Gg1UKhVBrVYTMK4yUS6XBXzX6/UJ87N3d3fo9/tQ7HY7XC4X/H4/dnd3cXBwgJ2dHQSDQWxvbyMQCMDpdEp+c3Nzor1eLzY2NqTOYDBgZWUFr6+vUPjNj4+P0oVgR7WrytVq9U+czvlrqB8eHnB/f4/BYABFo9GIE3bb39+Hw+EQbbVasbe3B4vFImwymSba4/HAbDaLXltbE200GtFut6Hkcjnp2Gq10Gw2xa0Kajp4enqaccc4HVKTC4UCbm9v5UKUubk56eJ2u2U2BJ1ubW2Ja2o6IVNz5pzx+vo6bDabvPV6PVZXV9HtdqFks1nQJefBDXIe08wrIOiCWyUTzKu5TCbz3+H8/Dx0Op1sNxKJyDyOjo5ki9R8h0IhwfHxsWyZNT6fTzZPp1qtVhy+vb1Bubq6QjqdRj6fx+XlpXTiQZNvbm7kiBOJhDBj19fX4kh19fLyIgfPmcsdHh4eihveE++MrtiNbnhbS0tLWF5exsLCgrhjDes583A4LBexuLgo239+foby+/uL7+9vwc/Pzx9WMR6PZ3Iq+P/lpnu9Hr6+vvAPlmkDrDBx2FIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"apple keycode reference\"\n        title=\"apple keycode reference\"\n        src=\"/static/1b6265210751adba1d67a0845a2840b0/5a190/apple-keycode-reference.png\"\n        srcset=\"/static/1b6265210751adba1d67a0845a2840b0/772e8/apple-keycode-reference.png 200w,\n/static/1b6265210751adba1d67a0845a2840b0/e17e5/apple-keycode-reference.png 400w,\n/static/1b6265210751adba1d67a0845a2840b0/5a190/apple-keycode-reference.png 800w,\n/static/1b6265210751adba1d67a0845a2840b0/c1b63/apple-keycode-reference.png 1200w,\n/static/1b6265210751adba1d67a0845a2840b0/54c3a/apple-keycode-reference.png 1257w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p class=\"markdown-para\">Hit <kbd class=\"markdown-kbd\">Cmd</kbd> + <kbd class=\"markdown-kbd\">s</kbd> to save the script, but save it as an <em class=\"markdown-emphasis\">application</em> (app extension), not a script file. Save this anywhere you like, but remember the location, we'll return to this later.</p>\n<aside class=\"markdown-aside\">\nAppleScript can be used to do a lot more than automating the keyboard. It can be used to create custom workflows for just about any aspect of your Mac and even to create apps. This post is limited to keyboard automation but if you're interested in learning more about what can be done with AppleScript, checkout this <a class=\"markdown-link\" href=\"https://discover.hubpages.com/technology/applescript_code\">post</a>.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"2-Automator\" style=\"position:relative;\"><a href=\"#2-Automator\" aria-label=\"2 Automator permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Automator</h2>\n<p class=\"markdown-para\">Although it's not obvious, this next step will register the script app created in the previous step as a Service, which is necessary for being able to assign a keyboard shortcut to it.</p>\n<p class=\"markdown-para\">Launch the <a href=\"https://support.apple.com/en-ca/guide/automator/welcome/mac\" class=\"markdown-link\">Automator</a> app and choose Quick Action.</p>\n<p class=\"markdown-para\">Set the \"Workflow receives\" dropdown to \"no input\".</p>\n<p class=\"markdown-para\">Using the search bar at the top, search for \"Launch Application\" and drag the result to the middle of the workflow pane (on top of the message that says Drag actions or files here).</p>\n<p class=\"markdown-para\">From the Launch Application inner pane that gets created, click on the Application dropdown and select the script <code>.app</code> file created in the previous step. Unless you saved it in the main Applications folder, it probably will not show up in the list of options. However, the second from last option says \"Other...\", select that. It will open a file finder window, navigate to wherever you saved your <code>.app</code> file and select it.</p>\n<p class=\"markdown-para\">Notice that it only allows selection of <code>.app</code> files, this is why we saved our script as an application in the previous step.</p>\n<p class=\"markdown-para\">Hit <kbd class=\"markdown-kbd\">Cmd</kbd> + <kbd class=\"markdown-kbd\">s</kbd> to save the Quick Action. Give it a meaningful name such as \"Chrome Dropdown Selector\". This save dialog doesn't give you a choice as to where the Quick Action gets saved, but fyi, it will be saved in <code>~/Library/Services/*.workflow</code>.</p>\n<h2 class=\"markdown-subtitle\" id=\"3-Keyboard-Shortcut\" style=\"position:relative;\"><a href=\"#3-Keyboard-Shortcut\" aria-label=\"3 Keyboard Shortcut permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Keyboard Shortcut</h2>\n<p class=\"markdown-para\">Open System Preferences -> Keyboard.</p>\n<p class=\"markdown-para\">Click on \"Services\" from the left pane. Then in the right pane, scroll all the way down to \"General\". Here you will see the Quick Action created in the previous step. It will show up as whatever name you saved it as.</p>\n<p class=\"markdown-para\">Select your Quick Action, then click on the \"Add Shortcut\" button directly beside it, and press your desired keyboard shortcut to associate it with this Action. Test that your desired shortcut isn't already in use for some other feature.</p>\n<p class=\"markdown-para\">Almost there, one more step to pull this all together.</p>\n<h2 class=\"markdown-subtitle\" id=\"4-Security\" style=\"position:relative;\"><a href=\"#4-Security\" aria-label=\"4 Security permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Security</h2>\n<p class=\"markdown-para\">By default, Mac will not allow any custom scripts/workflow/automation etc to control your computer. This must be enabled with the following steps:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">Open System Preferences -> Security &#x26; Privacy.</li>\n<li class=\"markdown-list-item\">Click the lock icon at the bottom left and enter your computer password.</li>\n<li class=\"markdown-list-item\">Select Accessibility from the left hand side.</li>\n<li class=\"markdown-list-item\">Click on the Privacy tab at the top.</li>\n<li class=\"markdown-list-item\">From the right hand list of applications, make sure Automator and Script Editor are selected. If they don't appear in the list, click on the plus button, locate them from the Applications folder (might be under Applications/Utilities) and add them.</li>\n<li class=\"markdown-list-item\">Also add the script app file created in Step 1.</li>\n</ul>\n<p class=\"markdown-para\">Now open the browser to the web site where the automation should be performed, ensure focus is on the select control, and hit the keyboard shortcut that was set in Step 3.</p>\n<h2 class=\"markdown-subtitle\" id=\"Conclusion\" style=\"position:relative;\"><a href=\"#Conclusion\" aria-label=\"Conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">Phew, that was a lot of work, but worth it to save some wrist strain. This is just the tip of the iceberg in terms of what these automation tools can do for your Mac. Here are some resources I used to put this all together and further reading:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\"><a href=\"https://eastmanreference.com/how-to-automate-your-keyboard-in-mac-os-x-with-applescript\" class=\"markdown-link\">Automate Keyboard with AppleScript</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://eastmanreference.com/complete-list-of-applescript-key-codes\" class=\"markdown-link\">Complete List of AppleScript Keycodes</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.addictivetips.com/mac-os/convert-an-applescript-to-an-app-on-macos/\" class=\"markdown-link\">Save AppleScript as Application</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.addictivetips.com/mac-os/run-an-applescript-with-a-keyboard-shortcut-on-macos/\" class=\"markdown-link\">Run AppleScript with Keyboard Shortcut</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://developer.apple.com/library/archive/documentation/AppleScript/Conceptual/AppleScriptLangGuide/introduction/ASLR_intro.html\" class=\"markdown-link\">AppleScript Language Guide</a></li>\n<li class=\"markdown-list-item\"><a href=\"https://www.idownloadblog.com/2018/11/21/cool-things-mac-automator-tutorial/\" class=\"markdown-link\">10 Cool Things to do with Automator</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/automate-keyboard-mac/"}}},{"node":{"id":"c05effd5-0385-5cd2-b201-06a523790aeb","frontmatter":{"title":"Working Towards an Asynchronous Future","date":"December 2021","category":"career"},"excerpt":"I was inspired to write this after reading a post about how big tech companies organize their software engineering processes and the curious…","html":"<p class=\"markdown-para\">I was inspired to write this after reading a post about how big tech companies organize their software engineering processes and the <a href=\"https://blog.pragmaticengineer.com/project-management-at-big-tech/\" class=\"markdown-link\">curious absence of scrum</a> at these companies. While I don't work at a FAANG (or MAANA given some company renames), I am fortunate to be working on a team where engineers are empowered to be self organizing, and try different ways of working to optimize for results, developer productivity, and overall quality of life.</p>\n<p class=\"markdown-para\">To this end, our team has moved increasingly to an asynchronous work style and the results have been fantastic. This post will walk through why we decided to try this, how we're doing it, and address some common concerns.</p>\n<h2 class=\"markdown-subtitle\" id=\"Background\" style=\"position:relative;\"><a href=\"#Background\" aria-label=\"Background permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Background</h2>\n<p class=\"markdown-para\">But first, a little background. Our team is composed of three engineers (looking for a fourth at the time of this writing), and a product manager. We also have an engineering manager who manages several teams. There is no QA as the product has a thorough suite of end-to-end tests that cover just about every feature and workflow.</p>\n<p class=\"markdown-para\">The product consists of several publicly accessible web apps, built with Rails and MySQL. Our team is in full control over the product direction, features to be added and tech debt that should be addressed. The code base is very large, having been developed and iterated on over 10 years.</p>\n<p class=\"markdown-para\">We're part of a mid-sized company that delivers a number of other products and services. Prior to the pandemic, most people worked in office, with occasional work-from-home days. After the pandemic, the company went fully remote and will remain that way going forward.</p>\n<p class=\"markdown-para\">Our team has never been big fans of the official scrum methodology, preferring a more kanban/flow approach to delivering features. So we were fairly light on ceremonial meetings, but we did have some regular meetings including a daily standup and some planning meetings. We were also in the habit of \"let's hop on a call\" type meetings, for example to deal with a tricky production bug or figure out how a new feature should be integrated into the existing product.</p>\n<p class=\"markdown-para\">This all came to a head one day when our manager seemed really stressed out in standup and remarked that he was in too many meetings. Since none of us were fans of meetings to start with (is any engineer really??), we decided right there and then to move standup to an async channel using Slack and to generally try and work more asynchronously.</p>\n<h2 class=\"markdown-subtitle\" id=\"Remote--Async\" style=\"position:relative;\"><a href=\"#Remote--Async\" aria-label=\"Remote  Async permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Remote !== Async</h2>\n<p class=\"markdown-para\">Some terminology to clarify before moving on. Sometimes the terms remote working and asynchronous working get used interchangeably but there's an important difference.</p>\n<p class=\"markdown-para\">Remote working is when the entire team is not co-located in a physical office, and instead is working from home or some other location. However, they are still required to all be online and working during official business hours, typically 9am - 5pm. Some companies may have a variation on this where everyone is required to be online during \"core hours\", say 10am - 4pm, with a little flexibility for those that wish to start and finish earlier or later by about an hour. This results in the majority of the teams' work hours overlapping which makes it easy to book meetings or impromptu calls because there's an expectation that every one is available at the same time.</p>\n<p class=\"markdown-para\">Asynchronous working takes this to another level. In addition to the team not being co-located, there is no expectation of overlapping work hours at all. Each team member picks their own working hours that suit them best. Furthermore, these hours don't have to be contiguous or the same times each day. For example, someone may find their optimal focus time is in the very early hours of the morning, then take the afternoon off for exercise, running errands, picking up kids from school etc. and then log back in later in the evening to complete some tasks. Someone else may prefer to start around midday or later, and work late into the night because that's when they're at their most productive.</p>\n<aside class=\"markdown-aside\">\nIf you'd like to learn more about planning your day for optimal focus time, and when you'll get the best results from focusing on certain kinds of problems, the book <a class=\"markdown-link\"href=\"https://www.danpink.com/books/when/\">When: The Scientific Secrets of Perfect Timing</a> presents compelling research and stories on this. I also gave a <a class=\"markdown-link\" href=\"https://danielabar.github.io/when/#/\">presentation</a> on this topic.\n</aside>\n<p class=\"markdown-para\">There can also be a spectrum, where a team may want some real-time meetings such as weekly one on ones with managers, but the rest of the week everyone is free to manage their time however suits them. This is where our team has landed.</p>\n<p class=\"markdown-para\">Now that the definitions are out of the way, how does a team go from everyone working pretty much the same hours to async?</p>\n<h2 class=\"markdown-subtitle\" id=\"Communication\" style=\"position:relative;\"><a href=\"#Communication\" aria-label=\"Communication permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Communication</h2>\n<p class=\"markdown-para\">One thing we realized in moving to async is that we would all have to hone our written communication skills, since this would be taking the place of verbal communication. Not only can effective writing replace a lot of meetings, there's also a benefit to the company. Decisions and discussions in a written format are easily accessible to everyone, not just whoever happened to participate in the meeting that day. This is also helpful to the team in an environment of shifting priorities, where people may not remember what was discussed in a meeting several months ago. When decisions are written down, this is no longer a problem.</p>\n<p class=\"markdown-para\">Here are a few examples of the type of writing our team has been doing to reduce the need for all of us to be online at the same time. We try as much as possible to choose writing tools that support markdown, which is more developer friendly than WYSIWG editors, but that's just our team preference.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 667px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEFA//EABYBAQEBAAAAAAAAAAAAAAAAAAIDBP/aAAwDAQACEAMQAAABu5OfldYRcf/EABkQAQEBAAMAAAAAAAAAAAAAAAEAAgMREv/aAAgBAQABBQJhz3bYPHPf/8QAFxEAAwEAAAAAAAAAAAAAAAAAAQIQEf/aAAgBAwEBPwELs//EABcRAQEBAQAAAAAAAAAAAAAAAAEAAhL/2gAIAQIBAT8B70uob//EABsQAAEEAwAAAAAAAAAAAAAAABAAAQIhETFC/9oACAEBAAY/AlWzmPT2P//EABwQAQACAQUAAAAAAAAAAAAAAAEAERAhMUFRcf/aAAgBAQABPyFla7SkDhRxCQAo9Qvqf//aAAwDAQACAAMAAAAQ4z//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEUH/2gAIAQMBAT8QwI//xAAbEQEAAgIDAAAAAAAAAAAAAAABADERIYGx0f/aAAgBAgEBPxALDgK4u5lDXfk//8QAGxAAAgMBAQEAAAAAAAAAAAAAAREAITFRYXH/2gAIAQEAAT8QAQGWzgkY4DA1ewvwjjSLl0QpIa4CWD9M/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"markdown all the things\"\n        title=\"markdown all the things\"\n        src=\"/static/4e1e2d0e387f8bb940c46deb12b1355f/e20b3/markdown-all-the-things.jpg\"\n        srcset=\"/static/4e1e2d0e387f8bb940c46deb12b1355f/e07e9/markdown-all-the-things.jpg 200w,\n/static/4e1e2d0e387f8bb940c46deb12b1355f/066f9/markdown-all-the-things.jpg 400w,\n/static/4e1e2d0e387f8bb940c46deb12b1355f/e20b3/markdown-all-the-things.jpg 667w\"\n        sizes=\"(max-width: 667px) 100vw, 667px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<aside class=\"markdown-aside\">\nThe topic of documentation, such as how to write it, what should get documented, how to maintain it etc. is enough for a whole blog post on its own. See this excellent <a class=\"markdown-link\" href=\"https://chelseatroy.com/2021/09/14/the-art-of-documentation/\">post</a> for thorough coverage of this topic.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"Pull-Requests\" style=\"position:relative;\"><a href=\"#Pull-Requests\" aria-label=\"Pull Requests permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pull Requests</h3>\n<p class=\"markdown-para\">When a pull request is submitted for review, the developer writes a detailed description including what the new code does, what areas of the project were modified, and most importantly, step by step instructions for the reviewer to exercise the code. Our review process includes not just providing feedback on the code, but also having the reviewer check out the branch and try out the new feature or bug fix on their laptops.</p>\n<p class=\"markdown-para\">This level of detail in the PR description eliminates the need for real-time discussion about what the PR does. Having the reviewer try it out means at least one other person besides the original developer gains an understanding of this feature beyond what merely scanning the code can provide.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"Project-Docs\" style=\"position:relative;\"><a href=\"#Project-Docs\" aria-label=\"Project Docs permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Project Docs</h3>\n<p class=\"markdown-para\">The main project <code>README.md</code> file contains project setup instructions which we strive to maintain whenever there's a change, such as some new configuration or external dependency required. The idea being that a new developer should be able to spin up a working dev environment without getting stuck and needing real time help from someone else on the team. If something is discovered that's missing from the setup instructions, that's a great first PR for the new developer to submit to update the readme.</p>\n<p class=\"markdown-para\">When a new feature is added such as a third party integration, we add or update the project documentation as part of the PR. This takes the form of markdown files in a <code>/docs</code> directory of the project, and a link to this doc from the <code>Further Reading</code> section of the main project <code>README.md</code> file. The benefit of maintaining these docs is it spreads the knowledge of each feature so if someone has a question, they can find the answer in the docs rather than requiring the original developer to be online to answer. Keeping the docs with the project source means they're more likely to turn up in a search when someone is making a change, and therefore get maintained along with the code as it evolves.</p>\n<aside class=\"markdown-aside \">\nEven for a non async team, maintaining docs along with the code is helpful because the original developer may be on vacation or have left the company, and this knowledge could otherwise be forever lost.\n</aside >\n<h3 class=\"markdown-sub-subtitle\" id=\"Jira\" style=\"position:relative;\"><a href=\"#Jira\" aria-label=\"Jira permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Jira</h3>\n<p class=\"markdown-para\">Hear me out, please don't close this tab. Jira is painful when used as a management tool. Like those dreaded sprint review meetings where the scrum master is closing out the sprint, and there's one lonely ticket in the Done column and all the others are scattered throughout the Not Started, In Progress, and In Review columns. Or when developers have to track actual hours vs estimate hours in Jira, shudder!</p>\n<p class=\"markdown-para\">But our use of Jira is simply to use the epics to write down an overall goal, and the individual tickets within an epic serve as our todo list. We write detailed descriptions in each ticket, including context and scope. Links are used to identify dependencies between tickets. Bug reports include steps to reproduce and actual vs expected results. This way everyone knows the big picture, what everyone else is working on, and can pick up work without a planning meeting or any other real-time coordination.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"Slack-Async\" style=\"position:relative;\"><a href=\"#Slack-Async\" aria-label=\"Slack Async permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slack Async</h3>\n<p class=\"markdown-para\">For simple question and answer communication, we use Slack but in an async fashion. Effectively this means there's no expectation of an immediate reply and we don't monitor whether someone's dot is green on Slack. We mostly disable notifications to make this type of communication less disruptive to focus time.</p>\n<aside class=\"markdown-aside\">\nRegardless of your team being async or not, it's a good idea to minimize notifications and other <a class=\"markdown-link\" href =\"https://danielabaron.me/blog/off-with-the-digital-distractions/\">digital distractions</a> to get the most out of your focus time.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"Wiki-Discussions\" style=\"position:relative;\"><a href=\"#Wiki-Discussions\" aria-label=\"Wiki Discussions permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wiki Discussions</h3>\n<p class=\"markdown-para\">We use Github to host our project source, which also has a Wiki. We use this when a team member has something they'd like to discuss that is more involved than what could be covered with a Slack question. They can add a page and write up a discussion topic in markdown, and share it with the team via Slack. Then team members can update the document with their thoughts on the topic on their own time. This replaces the \"let's hop on a call\" type of meetings and has helped us resolve a number of issues. The benefit of this written approach over a real-time meeting is each developer can do some analysis on the code before piping in to the \"conversation\". This results in more accurate and thoughtful points being made.</p>\n<p class=\"markdown-para\">The meeting equivalent of this is where some participants say \"umm... let me check...\", clackety clack of keyboards, while other participants watch and wait. The async version of this has been more effective for our team and leaves a searchable artifact for ourselves and future team members.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"Architecture-Decision-Records\" style=\"position:relative;\"><a href=\"#Architecture-Decision-Records\" aria-label=\"Architecture Decision Records permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture Decision Records</h3>\n<p class=\"markdown-para\"><a href=\"https://adr.github.io/\" class=\"markdown-link\">ADR</a> is a more formal written document to be used when someone would like to propose a significant architectural change to the project. It gets submitted as a markdown document in a PR, then team members can discuss via PR comments. This is a new format we're experimenting with so it's too early to report on its effectiveness.</p>\n<p class=\"markdown-para\">What brought this about is since the project code is ~10 years old, we sometimes come across areas of the code where the original developer is long gone and it's not well understood why that particular implementation was chosen. There may have been a meeting at that time to discuss the approach, but of course, the conclusions of that meeting are forever lost. The idea with ADR docs is to generate discussion about proposed changes <em class=\"markdown-emphasis\">and</em> have the reasoning and final decisions captured in writing for posterity.</p>\n<h2 class=\"markdown-subtitle\" id=\"Ownership\" style=\"position:relative;\"><a href=\"#Ownership\" aria-label=\"Ownership permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ownership</h2>\n<p class=\"markdown-para\">In addition to effective writing, another thing that's required to make async work is that each engineer has full ownership of their tasks. This means they are responsible for the entire feature end to end and have freedom to make all implementation decisions. This minimizes real time coordination with other engineers. For example, rather than splitting a feature into back end assigned to one engineer, and another gets the front end, one person would be responsible for the entire vertical slice.</p>\n<p class=\"markdown-para\">This doesn't mean \"cowboy\" style coding, there's still room for questions and discussion as described in the previous section on writing. But it's left to the engineer's judgement as to whether something is significant enough to require team input, or if it's something they can make an \"executive\" decision on.</p>\n<aside class=\"markdown-aside\">\nHaving every engineer on the team be an equal and effective owner is easy to accomplish when the size of the team is small relative to the size of the code base. This allows each person to work independently, minimizing the chance of stepping on someone else's toes.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"Trust\" style=\"position:relative;\"><a href=\"#Trust\" aria-label=\"Trust permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Trust</h2>\n<p class=\"markdown-para\">Related to the ownership point, is trust. I don't think it would be possible for a team to work asynchronously without a high degree of trust. We trust that each team member is intrinsically motivated to move the project forward without any monitoring of their online status and that they can manage their time effectively to complete their tasks. We also trust that if someone is stuck on something, they'll reach out for help, or if they finish a task, they'll take the initiative to go into the epic list and pick up another one rather than waiting to be assigned.</p>\n<h2 class=\"markdown-subtitle\" id=\"Objections\" style=\"position:relative;\"><a href=\"#Objections\" aria-label=\"Objections permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Objections</h2>\n<p class=\"markdown-para\">This post is not to suggest that everyone should stop what they're doing and switch to this approach. If your team feels happy and productive working fixed hours and having regular meetings, then by all means, continue.</p>\n<p class=\"markdown-para\">But for those feeling burned out by all the meetings or open to exploring a more flexible way of working, there may be concerns like \"what about...\" or \"our team could never...\". This next section will address some common concerns with async working.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"But-our-team-does-Scrum\" style=\"position:relative;\"><a href=\"#But-our-team-does-Scrum\" aria-label=\"But our team does Scrum permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>But our team does Scrum</h3>\n<p class=\"markdown-para\">I'm going to tread carefully here as this post is not intended as a scrum good or bad discussion.</p>\n<p class=\"markdown-para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEP0lEQVQ4yz2PWUzTdwDH/3vYFpfNJ3WgYMCDTW2hBQpFjgK2tJQeHC1HYbAhh0MOlUOGzNaCIm25HYqIioNwq4ALRJdlatRkczO6LTHbvJa9bA/b9GHLkub3WeRhD5983j75fqU1yZH+LWYNijyjUBVaROIHdrEjWydCMhLEq1GbhVoWIBYu6MTSw2Ixc6NATE5litnudDF/0yH6JywiqzFPmD6uFMaW3cLYUiakgF0qv9ymZ1u2VmzP1pJaXkBMkRVthYPVGgXS5nX0H9UzcbOc8eUsFmuNfFf3Hlf6TPTOWdlZ30SsqwfDsS70HT2sBCNy09mWpRVyu16klBeImCLrytI3E+TiLdka0V5rEwNTB8X09Wwx684QN2vNYn4sUwzMZgpVzV5ReXpQ3P31a3Hr6VdCWpsS6ZflpCG36UW43UBiqZ1oh4VdFQW8plYgbVhLZ72Joak6Lt7KZfp6PhNLOSzcLeLEpJmommpqz5/hl39+5uGLH5HWpUb5ZTb9/0FtZRHxJVlEFuaSXxlGe+PbTI4ZWPqhhLnr+Vy+XcilO4Us3C6m77yduIY6MrsH6Lgyg3thBukN9TZ/wC4V61KjRKBWRZg1ha2WJEKMOsbP6ODxJham05m642Bsycb41VzGr+UwtlhMh7eUpIa9RDq7kB1sQ9bcjiSFb/RL8mAkebBY8Y4NSLINSGGBzF9I59HV7XS7E+mdsuIZNuE9a8Y7YqZn1EKLV0v87lJiXV3Et/nY6fYhScoQv6QMRVKGihUrQpHCQ1il2kRRWRDXakOZciXQN22h97yJ/gtmfGct9IxaOeTToWluIMbdg9rVidrlQXpFttH/ujyYVbIgsTo8mODojQQrNpGUGsahsnd5oH6Hbypj8A4msbctm/3H7XjPZtD7qYVWnxZN0wFi3T3EuTyoj3iR9r0f7m+tjuR4c6zocsfT5dEwMKijqVOHozqOspo9fNheg3fIzHp9HFsdZjpP2egayaPFYySxuYHo9j5i3D5ULy8Pzpj9AxczGZjPEScX7QxdsTOyXIT7dA72fTpqvOVUd1TRVpGGNSUcmyUBd0EincUpuHLVVGUls8eWTmWOnqo8I9LiZYd/Yc7O9KhFnBmy0N2Tj/eQFXdxPJXGBKrysqg3JeMyqvCYIvGZo/CYoum0xnKxOZ/7w/XcO1nHg+H9fO4uQfptTON/8kkEfwyHiM8ObKUpRYEzdQdOrZw2g5z2tO20GWS4M5QcNihw6hUcs8YwUmbkfl8dj859xOPRVp5MOPn+cDnS74MB/ufnAmE2UCw3bqYxWUmbSYErXYFzBSWudCVOgwKfQ8O9c838eeMEz7/o58VyN38tdfHT+GG+LLVwyqxH+ncyyP/3eBDMrRdLjVtoTFHiNkbgNESsRF/SmibnREkqN/qqeTp3hGdzLp7MHeHpJTfPFtv59ugeLuVoqMi28x/ez5qoIrsUOgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Bart Simpson writing lines\"\n        title=\"Bart Simpson writing lines\"\n        src=\"/static/a19cae528584e1d1ab0f472ce5f07dda/5a190/bart-simpson-scrum.png\"\n        srcset=\"/static/a19cae528584e1d1ab0f472ce5f07dda/772e8/bart-simpson-scrum.png 200w,\n/static/a19cae528584e1d1ab0f472ce5f07dda/e17e5/bart-simpson-scrum.png 400w,\n/static/a19cae528584e1d1ab0f472ce5f07dda/5a190/bart-simpson-scrum.png 800w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p class=\"markdown-para\">If your team believes that scrum is the best thing since sliced bread and you're all feeling happy and healthy doing it, then by all means, keep on scrumming! However, strict adherence to the <a href=\"https://scrumexplainer.com/scrum/scrum-methodology/\" class=\"markdown-link\">scrum methodology</a> is incompatible with asynchronous work. This is due to the numerous ceremonial meetings required every week or other week.</p>\n<p class=\"markdown-para\">Our team intentionally rejects scrum in favour of a flow approach. Our PM  has a strong sense of product direction and is able to express this well in writing. We break down tasks as small as possible, putting them behind feature flags where appropriate. This allows us to deliver small increments of value continuously, without any big bang planning meetings.</p>\n<p class=\"markdown-para\">For estimates, we use the T-shirt sizing approach. For tricky problems requiring team input, we use the writing approaches described earlier in this post. This eliminates the need for backlog grooming meetings and <a href=\"https://www.simplilearn.com/what-is-planning-poker-article\" class=\"markdown-link\">planning poker</a> games.</p>\n<p class=\"markdown-para\">We use a slack channel to post our daily updates. This has worked out better than real-time standup because seeing the updates in writing is easier to absorb and reply if someone is having a blocker, without holding up the whole team. How often has it happened that you're trying to remember your tasks so that you can recite them when it's your turn, so much so that you miss what others are saying.</p>\n<p class=\"markdown-para\">Finally, if there's a process improvement someone would like to explore, for example, turning on auto-merge on PR's, we just try it, no need to wait for official \"end of sprint\" retrospective meeting. We provide each other feedback continuously which eliminates that ceremony as well.</p>\n<aside class=\"markdown-aside\">\nI started my career before Scrum, when Waterfall was the only option. Over the years as Scrum became increasingly trendy, I've noticed some surprising similarities between the two. This post on <a class=\"markdown-link\" href=\"https://medium.com/serious-scrum/the-unmistakable-signs-you-are-participating-in-fake-agile-theater-a7d1bd6a5dbc\">Agile Theatre</a> takes a fascinating look at that.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"We-dont-have-time-for-all-that-writing\" style=\"position:relative;\"><a href=\"#We-dont-have-time-for-all-that-writing\" aria-label=\"We dont have time for all that writing permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>We don't have time for all that writing</h3>\n<p class=\"markdown-para\">This reminds me of a similar argument against automated testing. It goes something like this:</p>\n<p class=\"markdown-para\"><em class=\"markdown-emphasis\">\"We don't have time to write tests, we're too rushed meeting the deadlines\".</em></p>\n<p class=\"markdown-para\">To which my answer is:</p>\n<p class=\"markdown-para\"><em class=\"markdown-emphasis\">\"Then there must be plenty of time for fixing bugs and putting out production fires\".</em></p>\n<p class=\"markdown-para\">In a similar way, if a team doesn't have time to write, then there must be plenty of time for developers to sit around in endless meetings rather than focusing on their work.</p>\n<p class=\"markdown-para\">Take an example of a single developer stuck on a problem. The seemingly quick approach is to reach out to the team, i.e. \"let's hop on a call\". Let's say there's 4 engineers on the team and they all get caught up in real time trying to solve this problem. I've seen these types of meetings run on for 3 hours or even more. That's at least 12 hours of people time!</p>\n<p class=\"markdown-para\">Now, imagine the original developer taking the time to articulate the problem in a wiki discussion doc or ADR. This could include a description of the problem, approaches that have been tried and didn't work, and consideration of a few alternatives with their pros and cons. A practiced writer may be able to accomplish this in about an hour. Then the doc is shared with the team where others who have knowledge in this area can share their feedback in the document. Since the problem is now well laid out, let's say the 3 other engineers on the team take an hour each to provide feedback. Then the original developer can review this for another hour to arrive at the solution. That's 5 hours rather than 12, <em class=\"markdown-emphasis\">and</em> there's a written artifact for anyone else that may later want to understand why that particular solution was chosen.</p>\n<p class=\"markdown-para\">The effects compound further when considering that many initiatives get put on the back burner for some other higher priority, then get restarted in 6 months to a year. Even if by some good fortune, the original engineers that had that meeting are still at the company, what are the chances anyone will remember the details and outcome of a meeting from about a year ago? This can lead to yet another meeting and the original 12 hours were wasted.</p>\n<aside class=\"markdown-aside\">\nOne \"solution\" I've seen to the forgotten outcome of meetings problem, is to designate one participant to take notes. However, when someone is tasked with note taking, it's difficult for that person to be an active participant in the technical problem solving. This results in highly skilled, highly paid engineers doing secretarial duties. Not only can it create resentment if the same person tends to be selected for this task (especially insidious if assigned to the only female engineer), but it's not the most effective use of engineering time.\n</aside>\n<h3 class=\"markdown-sub-subtitle\" id=\"Im-not-a-good-writer\" style=\"position:relative;\"><a href=\"#Im-not-a-good-writer\" aria-label=\"Im not a good writer permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>I'm not a good writer</h3>\n<p class=\"markdown-para\">Notice the emphasis has been on <em class=\"markdown-emphasis\">effective</em> writing rather than <em class=\"markdown-emphasis\">good</em> writing. This isn't about making the New York Times bestseller list or being nominated for a <a href=\"https://en.wikipedia.org/wiki/Pulitzer_Prize\" class=\"markdown-link\">Pulitzer Prize</a>. The goal is to make yourself understood to the rest of the team. Yes this takes some practice, but so does anything worth doing. Just as it takes time to develop effective programming skills, so too does it take time to develop writing skills.</p>\n<p class=\"markdown-para\">As long as everyone on the team is willing to work on this, it shouldn't be a blocker. Those team members that are stronger writers should remember to be kind to others with respect to spelling and grammar errors. Personally I don't think this matters much for internal docs as long as the overall meaning of the document is clear.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"What-about-Onboarding\" style=\"position:relative;\"><a href=\"#What-about-Onboarding\" aria-label=\"What about Onboarding permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What about Onboarding?</h3>\n<p class=\"markdown-para\">Full disclosure: Since going asynchronous, our team has not yet on-boarded a new team member, so this process may need some work. There are three aspects to consider here:</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Technical Setup:</strong> The project <code>README.md</code> should be sufficiently detailed and up to date so that a new team member can install all dependencies they need, get the project running and tests passing without getting on a call with another engineer. Ideally, the project docs also contain some \"What's next\" steps like how to run through a typical workflow in the application.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Domain Knowledge:</strong> It's not enough to have knowledge of the tech stack and familiarity with the code. An engineer also needs to understand the business domain. In my experience, this has been done by having the new person book 1-1 meetings with various domain experts in the company. This hasn't been a good experience because I've found myself furiously scribbling (or typing) notes trying to absorb all the important information being given and missing about half of it due to talking speed being faster than note taking speed. It's also sub-optimal for the domain experts because they need to spend this time repeating the same things every time a new person starts.</p>\n<p class=\"markdown-para\">This process could be optimized by having domain experts would write down their knowledge such as what the products are doing, critical workflows, business rules, what are the primary sources of revenue etc. Then the new person could review these and reach out to each expert with follow-on questions. The answers to these questions could then be used to update the business docs, leaving them improved for everyone.</p>\n<p class=\"markdown-para\"><strong class=\"markdown-strong\">Team Introduction:</strong> The initial introduction to the team might be a case where it's nice to have a real time meeting. No specific agenda other than for everyone to introduce themselves and \"shoot the breeze\" a bit. In the event that it's not possible to get everyone online all at the same time, this could be scheduled as individual 1-1 short meetings with team members.</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"What-about-human-connection\" style=\"position:relative;\"><a href=\"#What-about-human-connection\" aria-label=\"What about human connection permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What about human connection?</h3>\n<p class=\"markdown-para\">Connection with others is an important part of being human, we are social creatures. Having said that, different people vary in the amount of social connections they need to feel fulfilled and function effectively. This can depend on introversion/extroversion and other dimensions of personality. Some people thrive on socializing at work and developing friendships with colleagues, while others may prefer to keep emotional distance between their work and social lives. There is no right or wrong here, and I don't think this is something that companies can mandate. The role a company can play is to provide some social opportunities (such as in-person or virtual events, depending on where things land with the pandemic and <a href=\"https://www.who.int/westernpacific/emergencies/covid-19/information/covid-19-variants\" class=\"markdown-link\">variants</a>), while keeping attendance optional.</p>\n<p class=\"markdown-para\">Another way of thinking of this is how connected do you really feel to your colleagues from attending scrum ceremonies and other work-related meetings? I don't believe even daily stand-ups are meaningfully connecting people. If you want to try an experiment with this - next time your spouse or a good friend asks you how was your day, try responding with: Yesterday I... Today I'm planning to... Blockers are...</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"How-do-I-know-people-are-working\" style=\"position:relative;\"><a href=\"#How-do-I-know-people-are-working\" aria-label=\"How do I know people are working permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How do I know people are working?</h3>\n<p class=\"markdown-para\">This is a question some managers might have, and it goes back to the point about <a href=\"#Trust\" class=\"markdown-link\">trust</a>. I would argue that without trust, it's going to be difficult for any team to effectively deliver software, whether asynchronous or not.</p>\n<p class=\"markdown-para\">There may be an old school approach among some managers that they feel the need to \"see\" the team at all times at their desk either physically, or virtually with surveillance software. There are many ways that managers can have visibility into engineering <em class=\"markdown-emphasis\">output</em> including git commits, pull requests, and jira. Slack integration with these tools can make it even easier to see what's going on. There is absolutely no need to monitor anyone's <em class=\"markdown-emphasis\">input</em> (i.e. time spent on laptop).</p>\n<p class=\"markdown-para\">Another angle on the trust issue - many engineers are put on a rotating on-call schedule to handle production issues. So think about that for a moment - an organization trusts someone with access to production but not with the ability to get their work done on their own schedule?</p>\n<h3 class=\"markdown-sub-subtitle\" id=\"What-if-theres-an-emergency\" style=\"position:relative;\"><a href=\"#What-if-theres-an-emergency\" aria-label=\"What if theres an emergency permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What if there's an emergency?</h3>\n<p class=\"markdown-para\">This is the situation where everyone needs to get on a real-time call to resolve some urgent issue. I like to answer this concern with another question: What is the team doing if there's an emergency <em class=\"markdown-emphasis\">outside</em> of standard business hours? A well organized team will have:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">A rotating on-call schedule, ideally with a primary and secondary person to take the calls.</li>\n<li class=\"markdown-list-item\">A monitoring and alerting system to inform the on-call person of an issue.</li>\n<li class=\"markdown-list-item\">A playbook/troubleshooting guide for common problems.</li>\n<li class=\"markdown-list-item\">A maintenance procedure where if the on-call person encounters a new problem, they add the solution to the troubleshooting guide after it's resolved. This increases the body of knowledge for everyone.</li>\n<li class=\"markdown-list-item\">Compensation for people when they're on call.</li>\n</ul>\n<p class=\"markdown-para\">Given that the above is in place, then that's the same procedure to follow if there's an emergency at any time. It's not sustainable to require the entire team to be in potential emergency mode, even for a standard workday.</p>\n<h2 class=\"markdown-subtitle\" id=\"Who-does-this-work-best-for\" style=\"position:relative;\"><a href=\"#Who-does-this-work-best-for\" aria-label=\"Who does this work best for permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Who does this work best for?</h2>\n<p class=\"markdown-para\">Wrapping this all up, here are some characteristics of a team for which the async style of working is likely to succeed:</p>\n<ul class=\"markdown-list-unordered\">\n<li class=\"markdown-list-item\">A team of effective writers, or at the very least, everyone's willing to spend time developing this skill.</li>\n<li class=\"markdown-list-item\">Small team size <em class=\"markdown-emphasis\">relative</em> to size of code base. The project should be large enough that every developer can work independently on a feature without requiring real time coordination.</li>\n<li class=\"markdown-list-item\">It's not necessary that all team members be senior, but a recent graduate or junior developer may require some real time guidance and mentoring.</li>\n<li class=\"markdown-list-item\">Great for product and SaaS companies where teams have full control over the product or service. May be more challenging to implement with project based consulting as it would require \"selling\" each client on the idea.</li>\n</ul>\n<h2 class=\"markdown-subtitle\" id=\"Final-Thoughts\" style=\"position:relative;\"><a href=\"#Final-Thoughts\" aria-label=\"Final Thoughts permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final Thoughts</h2>\n<p class=\"markdown-para\">Our team has found a great deal of benefits from working asynchronously. The individual benefits include freedom to manage your own time, and arrange work around life rather than the other way around. Having a nearly clear calendar allows everyone to do their most important work whenever is optimal for them. The benefits also extend to the company. When everything important about a project is written down, it eliminates the \"single point of failure\" where all knowledge about a given area is in a single person's head. If that person goes on vacation or leaves the company, the rest of the team or even new team members can get up to speed.</p>\n<p class=\"markdown-para\">I would love to hear your thoughts on this - has your team tried asynchronous work? What has worked well? What have been some challenges?</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","fields":{"slug":"/blog/working-towards-asynchronous-future/"}}},{"node":{"id":"c382bd2e-abc6-5f49-9e07-c45c351245f0","frontmatter":{"title":"Migrate Cron Jobs to Nomad the Lazy Way","date":"November 2021","category":"devops"},"excerpt":"Laziness is usually considered a negative or insulting term, but when it comes to software engineering, this can be a valuable attribute…","html":"<p class=\"markdown-para\">Laziness is usually considered a negative or insulting term, but when it comes to software engineering, this can be a valuable attribute. This post will walk through a problem I was facing in converting multiple cron jobs from a legacy platform to a new one, and how being lazy saved manual effort and made future maintenance easier.</p>\n<p class=\"markdown-para\">The application I'm working on has a custom build and deploy pipeline based on <a href=\"https://en.wikipedia.org/wiki/Xen\" class=\"markdown-link\">xen</a> and some home grown promotion tools. Our team is working on switching to a more modern workflow including building out a private cloud with Openstack, the Hashicorp stack for infrastructure as code (including Terraform, Nomad, Vault, and Consul), and Github Actions for CI/CD automation.</p>\n<aside class=\"markdown-aside\">\nThe remainder of this post assumes some familiarity with Hashicorp's Nomad. If you haven't used it before, checkout this excellent <a class=\"markdown-link\" href=\"https://adri-v.medium.com/just-in-time-nomad-80f57cd403ca\">primer</a> and <a class=\"markdown-link\" href=\"https://adri-v.medium.com/just-in-time-nomad-running-traefik-on-hashiqube-7d6dfd8ef9d8\">tutorial</a>.\n</aside>\n<p class=\"markdown-para\">As part of this migration, 30+ cron jobs from the old xen based build had to be converted to run on Nomad. Nomad has a <a href=\"https://www.nomadproject.io/docs/job-specification/periodic\" class=\"markdown-link\">periodic</a> stanza that is designed to run a given task on a particular schedule, so this is perfect for running cron jobs. However, the <code>periodic</code> stanza which defines the <code>cron</code> schedule can only be placed at the Nomad <code>job</code> level. This means that each entry in the application's former crontab needs its own <code>.nomad</code> job file. Each resulting <code>.nomad</code> job file would end up looking very similar, the only differences being in the job, group, and task names, the cron schedule, and the command to run.</p>\n<p class=\"markdown-para\">Being a <a href=\"https://medium.com/the-lazy-developer/on-laziness-26d7a9f32066\" class=\"markdown-link\">lazy</a> developer, there was no way I wanted to manually write over 30 nomad files. Not only would the initial work be tedious, but what if they all required a change in the future? Even with global find/replace in files, that would still be too much manual effort. Instead, I decided to write a generator - a bash script to parse the existing crontab (well, a modified version of it which I'll discuss soon) and generate each nomad file from a template file.</p>\n<h2 class=\"markdown-subtitle\" id=\"Cron\" style=\"position:relative;\"><a href=\"#Cron\" aria-label=\"Cron permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cron</h2>\n<p class=\"markdown-para\">To start, let's take a look at the existing crontab. This is for a Rails application so all the jobs are written using rake:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">* * * * * nobody bundle exec rake app:frequent_tasks</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">5,10,15,25,30 * * * * nobody bundle exec rake app:export_widgets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0 * * * * nobody bundle exec rake app:cleanup_widgets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Nomad-Example\" style=\"position:relative;\"><a href=\"#Nomad-Example\" aria-label=\"Nomad Example permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nomad Example</h2>\n<p class=\"markdown-para\">Now let's look at what the first job would look like written as a Nomad file. This project uses the <a href=\"https://github.blog/2020-09-01-introducing-github-container-registry/\" class=\"markdown-link\">Github Container Registry</a> to store its Docker images. The same image is used to run the app with Puma, database migrations, and cron jobs, therefore it intentionally doesn't have a <code>CMD</code> or <code>ENTRYPOINT</code> specified in its <code>Dockerfile</code>, rather, each Nomad task specifies the command to run. This is accomplished by specifying <code>bash</code> as the command to run, then passing an array of arguments with the actual command to run.</p>\n<p class=\"markdown-para\"><code>prohibit_overlap</code> prevents two instances of the same cron jobs from running at the same time, in the case that the first run takes longer and the second instance would have been scheduled to start.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;app_frequent_tasks&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;dc1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;* * * * *&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">prohibit_overlap</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;frequent_tasks&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;frequent_tasks&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">   </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;RAILS_ENV=production bundle exec rake app:frequent_tasks&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">resources</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">cpu</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">500</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">env</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">RAILS_ENV</span><span class=\"mtk7\">=</span><span class=\"mtk1\">production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Access secrets from Vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Details not relevant for this example.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Note the use of <code>RAILS_ENV=production</code> in the command args. In theory, this shouldn't be required due to use of the <code>env</code> stanza further below, but in practice, the <code>env</code> stanza did not work for me so I had to specify it in the command args.</p>\n<h2 class=\"markdown-subtitle\" id=\"Nomad-Template\" style=\"position:relative;\"><a href=\"#Nomad-Template\" aria-label=\"Nomad Template permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nomad \"Template\"</h2>\n<p class=\"markdown-para\">To express this in a more general way, the rake task name from the cron entry (eg: <code>frequent_tasks</code>) becomes the job name, pre-pended with app (eg: <code>app_frequent_tasks</code>). The cron schedule (eg: <code>* * * * *</code>) becomes the periodic cron value. The rake task name is also used for the Nomad group and task name, and as the last value in the <code>args</code> for the Docker command configuration in the Nomad file.</p>\n<p class=\"markdown-para\">In order to write a script that will generate these Nomad files for each cron, start with a \"template\" Nomad file that is structured as the above, but with the specific values as strings <code>JOB_NAME</code> and <code>CRON_VALUE</code> that can be replaced. Use of the word template here refers to a file template that the script will use, not the <code>template</code> Nomad stanza used to read values from Vault or Consul:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># template.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;app_JOB_NAME&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;dc1&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;CRON_VALUE&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">prohibit_overlap</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">group</span><span class=\"mtk6\"> &quot;JOB_NAME&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">task</span><span class=\"mtk6\"> &quot;JOB_NAME&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">driver</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;docker&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">config</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">image</span><span class=\"mtk1\">   </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;ghcr.io/org/project/app:latest&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">command</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;bash&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;-c&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;RAILS_ENV=production bundle exec rake app:JOB_NAME&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">resources</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">cpu</span><span class=\"mtk1\">    </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">500</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">env</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">RAILS_ENV</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">template</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Access secrets from Vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Details not relevant for this example.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Generator-Script\" style=\"position:relative;\"><a href=\"#Generator-Script\" aria-label=\"Generator Script permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Generator Script</h2>\n<p class=\"markdown-para\">The generator script will have to iterate over each line of the cron, and parse it into the cron value, and job name. I ran into a snag here as there was no natural character to separate on. Couldn't use space or comma since these can also occur within the cron value. This required a one-time manual task of creating a file <code>cron-input</code> to add a pipe character separating the cron schedule from remainder of command. Also removed the <code>nobody</code> user:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">* * * * *|bundle exec rake app:frequent_tasks</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">5,10,15,25,30 * * * *|bundle exec rake app:export_widgets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0 * * * *|bundle exec rake app:cleanup_widgets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<p class=\"markdown-para\">And finally, here is the annotated script to iterate over <code>cron-input</code> and generate the <code>.nomad</code> files:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This is the pipe separated version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">INPUT_FILE=/path/to/cron-input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># The &quot;template&quot; nomad file with strings JOB_NAME and CRON_VALUE to be replaced</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">TEMPLATE_FILE=/path/to/template.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Record the original value of Internal File Separator so we can put it back later</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">OIFS=$IFS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Iterate over each line in input file (aka pipe separated cron)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">while</span><span class=\"mtk1\"> </span><span class=\"mtk9\">read</span><span class=\"mtk1\"> line</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Temporarily set Internal File Separator to pipe character for parsing cron input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  IFS=</span><span class=\"mtk6\">&#39;|&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Parse line of cron-input into cron and command values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Example, given a line: * * * * *|bundle exec rake app:frequent_tasks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Then cron_value will be &quot;* * * * *&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># and command_value will be &quot;bundle exec rake app:frequent_tasks&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">read</span><span class=\"mtk1\"> -r cron_value command_value </span><span class=\"mtk7\">&lt;&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$line&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Temporarily set Internal File Separate to colon character to parse out the job name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  IFS=</span><span class=\"mtk6\">&#39;:&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Parse `command_value` from previous step to extract the job name.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Example, given a command_value: bundle exec rake app:frequent_tasks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Then discard will be &quot;bundle exec rake app&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># and job_name will be &quot;frequent_tasks&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># The first part is not needed so the variable is called `discard`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9\">read</span><span class=\"mtk1\"> -r discard job_name </span><span class=\"mtk7\">&lt;&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;$command_value&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Generate nomad file for job from the template file.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Example, if the job_name extracted from previous step was: &quot;frequent_tasks&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># then generate a file named frequent_tasks.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Assumes there is a directory named `generated` to contain all the resulting .nomad files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  cp TEMPLATE_FILE generated/$job_name.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Replace all strings JOB_NAME and CRON_VALUE in generated file with values parsed from cron input file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># On a mac, must provide a bakup extension when editing files in place, on Linux, this can be skipped</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  sed -i </span><span class=\"mtk6\">&#39;.bak&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;s/JOB_NAME/</span><span class=\"mtk1\">$job_name</span><span class=\"mtk6\">/g;s/CRON_VALUE/</span><span class=\"mtk1\">$cron_value</span><span class=\"mtk6\">/&quot;</span><span class=\"mtk1\"> $job_name.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">done</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> $INPUT_FILE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># remove temporary .bak files from sed (only needed on mac)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">rm generated/</span><span class=\"mtk7\">*</span><span class=\"mtk1\">.bak</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># reset original Internal File Separator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">IFS=$OIFS</span></span></span></code></pre>\n<p class=\"markdown-para\">Running this script will result in a <code>.nomad</code> file being generated for each entry in the <code>cron-input</code> file. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└── generated</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── frequent_tasks.nomad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── export_widgets.nomad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ├── cleanup_widgets.nomad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    └── ...</span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Deploy\" style=\"position:relative;\"><a href=\"#Deploy\" aria-label=\"Deploy permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy</h2>\n<p class=\"markdown-para\">It's not enough to generate the files, they also need to be deployed to Nomad so that it can start scheduling each periodic job to run based on the specified cron schedule. For just a single file, the command is:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">nomad job run generated/frequent_tasks.nomad</span></span></code></pre>\n<p class=\"markdown-para\">However, since the theme of this post is laziness, I'm not going to enter 30+ commands like the above to submit each job. Instead, the following script can be used to iterate over each nomad file in the generated directory:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Contains generated nomad files from previous step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">GENERATED_DIR=/path/to/generated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Iterate over each file in generated directory and submit it to nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> $GENERATED_DIR/</span><span class=\"mtk7\">*;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  nomad job run $i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">done</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIn order to run nomad commands like the above, you must have nomad <a class=\"markdown-link\" href=\"https://www.nomadproject.io/docs/install\">installed</a> and have configured environment variables NOMAD_ADDR, NOMAD_NAMESPACE, AND NOMAD_TOKEN in your profile.\n</aside>\n<p class=\"markdown-para\">This can also be incorporated into a CI/CD workflow. Modify the script slightly to accept arguments for the nomad address, namespace, and token (so that they can be provided by the pipeline) and set them before invoking nomad:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/bin/bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Will be provided by pipeline when invoking this script</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_ADDR=$1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_NAMESPACE=$2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">NOMAD_TOKEN=$3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This directory should contain all the generated nomad files from previous step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">GENERATED_DIR=/path/to/generated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Iterate over each file in generated directory and submit it to nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> $GENERATED_DIR/</span><span class=\"mtk7\">*;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  nomad job run $i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">done</span></span></span></code></pre>\n<p class=\"markdown-para\">Given that this script is named <code>run-nomad-periodic.sh</code>, here's an example of running it in a step as part of a Github Actions based workflow. It assumes that all the Nomad environment variables have been configured as Github repository <a href=\"https://docs.github.com/en/actions/security-guides/encrypted-secrets\" class=\"markdown-link\">secrets</a>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/deploy.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Deploy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">workflow_run</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">workflows</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;CI&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">main</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">types</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">completed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">build_image</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># build Docker image for app and push to container registry...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy_prod</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">needs</span><span class=\"mtk1\">: </span><span class=\"mtk6\">build_image</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">NOMAD_ADDR</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.NOMAD_ADDR }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">NOMAD_NAMESPACE</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.NOMAD_NAMESPACE }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">NOMAD_TOKEN</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.NOMAD_TOKEN }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Nomad Periodic</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">./path/to/run-nomad.periodic.sh $NOMAD_ADDR $NOMAD_NAMESPACE $NOMAD_TOKEN</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nThe workflow_run event is used to trigger a workflow when another workflow has completed. In this case, the Deploy workflow will only run after the CI (Continuous Integration) workflow has completed. See my post on <a class=\"markdown-link\" href=\"https://danielabaron.me/blog/ci-cd-pipeline-for-gatsby/#Continuous-Deployment-When\">CI/CD</a> to learn more about the workflow_run event.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"Maintenance\" style=\"position:relative;\"><a href=\"#Maintenance\" aria-label=\"Maintenance permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Maintenance</h2>\n<p class=\"markdown-para\">Here's where the power of laziness really shines. Suppose a change is needed to the periodic jobs. For example, the data center is being changed. There's no need to use global find/replace to edit the generated files directly. Rather, the <code>nomad.template</code> file can be modified:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"nomad\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># template.nomad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">job</span><span class=\"mtk6\"> &quot;app_JOB_NAME&quot;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># was dc1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">datacenters</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;dc2&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">periodic</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">cron</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;CRON_VALUE&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">prohibit_overlap</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p class=\"markdown-para\">Then run the generator script again to regenerate the nomad files, then they can be deployed again with the run script.</p>\n<h2 class=\"markdown-subtitle\" id=\"Conclusion\" style=\"position:relative;\"><a href=\"#Conclusion\" aria-label=\"Conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has explained why, when faced with a large repetitive task, it's good to embrace your inner laziness and find an automated way to perform this task. Specifically we've covered how to automate generation of Nomad periodic jobs from multiple cron jobs from a legacy platform and how to deploy them via scripts.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/convert-multiple-cron-jobs-to-nomad-periodic-jobs/"}}},{"node":{"id":"c92d7f13-ff75-5632-be8c-e9b5ff992ddc","frontmatter":{"title":"Rails Feature Test Solved by Regex","date":"November 2021","category":"rails"},"excerpt":"If you’ve been programming for awhile, you’ve probably encountered regular expressions, and more specifically, this saying: Some people…","html":"<p class=\"markdown-para\">If you’ve been programming for awhile, you’ve probably encountered regular expressions, and more specifically, this saying:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">Some people, when confronted with a problem, think “I know, I'll use regular expressions.” Now they have two problems.</p>\n</blockquote>\n<p class=\"markdown-para\">There's some discussion as to the origin of this saying <a href=\"http://regex.info/blog/2006-09-15/247\" class=\"markdown-link\">here</a>. Personally, I approach the use of regular expressions (aka regex) in my code with some trepidation, as they can be difficult to read, and I prefer to leave clean, easy to read code for the future developers (including myself) who will maintain the code.</p>\n<p class=\"markdown-para\">However, sometimes it is the optimal choice. This post will walk through an example, where using a regex was useful in expressing an expectation in a feature test for a Rails project, plus a nice Ruby way of writing the regex that makes it easier to read.</p>\n<h2 class=\"markdown-subtitle\" id=\"The-Problem\" style=\"position:relative;\"><a href=\"#The-Problem\" aria-label=\"The Problem permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Problem</h2>\n<p class=\"markdown-para\">The application I’m working on allows users to setup multi-factor authentication. The last screen of the setup displays a recovery code that the user can enter in the event that they get locked out of their account. This code is a series of 16 randomly generated numbers and letters, displayed in chunks of 4, each separated by a space for legibility. Here's a sample recovery code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">1f08 6a11 b093 8fd6</span></span></code></pre>\n<p class=\"markdown-para\">After a PR got merged that made some changes to the multi-factor flow, a bug was introduced where the recovery code was no longer being displayed. The user would still get the screen instructing them to save the recovery code, but where the code should be displayed was a blank.</p>\n<p class=\"markdown-para\">Investigation revealed that the recovery code was still being generated by the server, but a UI bug was preventing it from being displayed. The fix was straightforward, however, this application has a very thorough suite of feature tests and I was surprised that one of the tests had not caught this bug.</p>\n<h2 class=\"markdown-subtitle\" id=\"Feature-Test\" style=\"position:relative;\"><a href=\"#Feature-Test\" aria-label=\"Feature Test permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Feature Test</h2>\n<p class=\"markdown-para\">Turns out there was a feature test that runs through the multi-factor auth steps, but it only verified that the user landed on the recovery screen by verifying the page title. It did not verify that the recovery code was actually displayed. As part of fixing this bug, this test had to be enhanced to also verify the display of the recovery code.</p>\n<p class=\"markdown-para\">Here is a portion of the markup that displays the recovery code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;Code: &lt;</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;1f08 6a11 b093 8fd6&lt;/</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;&lt;/</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">To make it easier to test, I first added a <code>data-test</code> attribute to the element containing the recovery code:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;Code: &lt;</span><span class=\"mtk7\">strong</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-test</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;recovery-code&quot;</span><span class=\"mtk1\">&gt;1f08 6a11 b093 8fd6&lt;/</span><span class=\"mtk7\">strong</span><span class=\"mtk1\">&gt;&lt;/</span><span class=\"mtk7\">p</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">Next I needed to add a step to the feature test to retrieve the element containing the recovery code by <code>data-test</code> selector and verify its contents. Capybara's <a href=\"https://github.com/teamcapybara/capybara#querying\" class=\"markdown-link\">have_selector</a> RSpec matcher is useful for finding an element by selector and text value. For example, given the following markup:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"html\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">data-test</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;message&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Hello</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span></code></pre>\n<p class=\"markdown-para\">A feature test could select this element and verify its contents as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">expect(page).to have_selector(</span><span class=\"mtk6\">&quot;div[data-test=&#39;message&#39;]&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;Hello&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Regex\" style=\"position:relative;\"><a href=\"#Regex\" aria-label=\"Regex permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Regex</h2>\n<p class=\"markdown-para\">In the case of the recovery code, the text value is randomly generated so it won’t work to have a static value in the text option for the <code>have_selector</code> matcher. What's needed is a way to express: The recovery code should look like 4 alpha numeric characters, followed by a space, followed by 4 more alpha numeric characters, and so on. This is where a regex is a good solution. It turns out, the text option of Capybara's <code>have_selector</code> also accepts a regular expression. So the test to verify that the recovery code is displayed needs to look something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># This expectation will pass if the string in element recovery-code matches the regex /TBD/.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">expect(page).to have_selector(</span><span class=\"mtk6\">&quot;strong[data-test=&#39;recovery-code&#39;]&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/TBD/</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<aside class=\"markdown-aside\">\nIt's not obvious from the Capybara docs that there even is a text option or that it also accepts a regex. This Stackoverflow Q&A goes through the source to determine the <a class=\"markdown-link\" href=\"https://stackoverflow.com/questions/23961636/what-are-the-options-to-capybaras-have-selector\">supported options</a>.\n</aside>\n<p class=\"markdown-para\">To match the recovery code accurately, the regex needs to match on any 4 letters or numbers, followed by a space, followed by any 4 letters or numbers, up to 4 chunks of these. To match any letter or number the <code>\\w</code> shorthand can be used, which is equivalent to <code>[0-9a-zA-Z_]</code>. To specify 4 of these, the range repetition syntax <code>{n}</code> can be used. For example to specify 4 characters in a row: <code>\\w{4}</code>. To match the whitespace, <code>\\s</code> is used. Putting this all together:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">expect(page).to have_selector(</span><span class=\"mtk6\">&quot;strong[data-test=&#39;recovery-code&#39;]&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/</span><span class=\"mtk4\">\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk6\">/</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p class=\"markdown-para\">While this works, it's difficult to read. Fortunately, Ruby has an alternate syntax for specifying a regex that is not whitespace sensitive. To use it, wrap the regex in <code>%r{...}</code> instead of <code>/.../</code>, then add the <code>x</code> modifier which makes it ignore whitespace. This allows the regex to be split up among multiple lines, and it can even have comments beside each line. So the previous line can be rewritten as:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">recovery_code_format </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">%r{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  </span><span class=\"mtk4\">\\w</span><span class=\"mtk6\">{</span><span class=\"mtk4\">4</span><span class=\"mtk1\">}     </span><span class=\"mtk3\"># Any 4 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\s        </span><span class=\"mtk3\"># Whitespace character</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\w{</span><span class=\"mtk4\">4</span><span class=\"mtk1\">}     </span><span class=\"mtk3\"># Any 4 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\s        </span><span class=\"mtk3\"># Whitespace character</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\w{</span><span class=\"mtk4\">4</span><span class=\"mtk1\">}     </span><span class=\"mtk3\"># Any 4 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\s        </span><span class=\"mtk3\"># Whitespace character</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \\w{</span><span class=\"mtk4\">4</span><span class=\"mtk1\">}     </span><span class=\"mtk3\"># Any 4 characters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">expect(page).to have_selector(</span><span class=\"mtk6\">&quot;strong[data-test=&#39;recovery-code&#39;]&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">text:</span><span class=\"mtk1\"> recovery_code_format)</span></span></span></code></pre>\n<p class=\"markdown-para\">This is much more legible and easier to maintain should the recovery code format change in the future.</p>\n<aside class=\"markdown-aside\">\nIt's beyond the scope of this post to go in depth on regex in Ruby. See this excellent <a class=\"markdown-link\" href=\"https://www.rubyguides.com/2015/06/ruby-regex/\">guide</a> for more on this topic.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"Interactive-Regex\" style=\"position:relative;\"><a href=\"#Interactive-Regex\" aria-label=\"Interactive Regex permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Interactive Regex</h2>\n<p class=\"markdown-para\">Unless you're writing regex's constantly, it's unlikely your first attempt will be correct. In the example covered in this post, it's being used as part of a Capybara feature test. Since feature tests are slower to run, it will take a relatively long time to get feedback on if the regex is working.</p>\n<p class=\"markdown-para\">To speed things up, launch a Rails or IRB console to try out the regex interactively, using the <code>=~</code> operator to determine if a regex matches a string. This operator returns the index occurrence of the first match or <code>nil</code> if there is no match. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">001</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> recovery_code </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;1f08 6a11 b093 8fd6&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">002</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> recovery_code </span><span class=\"mtk7\">=~</span><span class=\"mtk1\"> </span><span class=\"mtk6\">/</span><span class=\"mtk4\">\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk4\">\\s\\w</span><span class=\"mtk7\">{4}</span><span class=\"mtk6\">/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk4\">0</span><span class=\"mtk1\">   </span><span class=\"mtk3\"># This means a match was found at position 0 of recovery_code.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># test some more inputs...</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Conclusion\" style=\"position:relative;\"><a href=\"#Conclusion\" aria-label=\"Conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has covered a use case for regex in a Capybara feature test for Rails, how to make it legible, and how to try it out in the console to get quick feedback.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/rails-feature-test-solved-regex/"}}},{"node":{"id":"d472ffdd-c948-5d9f-b7cc-11a60dd52f15","frontmatter":{"title":"Build a CI/CD Pipeline for a Gatsby Site","date":"October 2021","category":"gatsby"},"excerpt":"This post will walk through how to set up a CI/CD (Continuous Integration and Continuous Deployment) pipeline for a Gatsby site. Let's start…","html":"<p class=\"markdown-para\">This post will walk through how to set up a CI/CD (Continuous Integration and Continuous Deployment) pipeline for a Gatsby site. Let's start with a definition from <a href=\"https://en.wikipedia.org/wiki/CI/CD\" class=\"markdown-link\">Wikipedia</a>:</p>\n<blockquote class=\"markdown-blockquote\">\n<p class=\"markdown-para\">In software engineering, CI/CD is the combined practices of continuous integration (CI) and either continuous delivery or continuous deployment (CD). CI/CD bridges the gaps between development and operation activities and teams by enforcing automation in building, testing and deployment of applications.</p>\n</blockquote>\n<p class=\"markdown-para\">Why would something like this be needed for a blog? This blog is built with Gatsby, with the posts being written in Markdown, and deployed to static <a href=\"https://guides.github.com/features/pages/\" class=\"markdown-link\">Github Pages</a>. A relatively simple workflow, and yet, it takes some non-trivial amount of time and manual effort to publish each article as it's ready. Once an article is finished, there's a sense of \"phew, got that done, time to share it with the world\", but going through manual effort to deploy is no fun.</p>\n<p class=\"markdown-para\">This is where a CI/CD pipeline can save the day. The idea is to automate all the steps that are currently being done manually and trigger this automation at an appropriate point in the workflow, such as when a branch gets merged to the main line. Often, the initial effort to setup this automation will be greater than the amount of time it takes to do one or even several manual deploys. However, over time, the automation wins out. Think of this as an investment of your time now, to save time in the future.</p>\n<h2 class=\"markdown-subtitle\" id=\"Identify-the-Steps\" style=\"position:relative;\"><a href=\"#Identify-the-Steps\" aria-label=\"Identify the Steps permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Identify the Steps</h2>\n<p class=\"markdown-para\">First part in building an automated pipeline is to identify the steps that are currently being done manually, then they can be automated one by one. Here are the steps involved in publishing an article on this blog:</p>\n<ol class=\"markdown-list-ordered\">\n<li class=\"markdown-list-item\">Merge the PR containing the finished article to <code>main</code> (and any other changes that may have been needed, for example, may have identified a css change to improve spacing on article pages).</li>\n<li class=\"markdown-list-item\">Pull the latest <code>main</code> branch (which now contains recently merged article) to my local dev environment.</li>\n<li class=\"markdown-list-item\">Run the <a href=\"../gatsby-unit-testing\" class=\"markdown-link\">unit tests</a> and make sure the entire suite is passing. (Even though the tests were run on the branch when writing the article, it's critical to run them after merging in case a bug gets introduced as a result of the merge).</li>\n<li class=\"markdown-list-item\">If the tests fail, stop and investigate. The remaining steps should <em class=\"markdown-emphasis\">only</em> be performed if the tests pass.</li>\n<li class=\"markdown-list-item\">Run the production Gatsby build to generate the optimized bundles for serving the production site.</li>\n<li class=\"markdown-list-item\">Deploy the production build to Github Pages.</li>\n<li class=\"markdown-list-item\">Ingest the markdown content as documents to the <a href=\"../roll-your-own-search-service-for-gatsby-part5\" class=\"markdown-link\">search service</a> using Heroku's <code>pg:psql</code> command.</li>\n</ol>\n<h2 class=\"markdown-subtitle\" id=\"Choose-an-Automation-Tool\" style=\"position:relative;\"><a href=\"#Choose-an-Automation-Tool\" aria-label=\"Choose an Automation Tool permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Choose an Automation Tool</h2>\n<p class=\"markdown-para\">Next step in building a pipeline is to choose a tool to perform the actions that have been identified in the previous step. There are many to choose from including <a href=\"https://www.travis-ci.com/\" class=\"markdown-link\">Travis CI</a>, <a href=\"https://circleci.com/\" class=\"markdown-link\">Circle CI</a>, <a href=\"https://www.jenkins.io/\" class=\"markdown-link\">Jenkins</a>, and many more.</p>\n<p class=\"markdown-para\">For side projects, I used to reach for Travis or Circle CI, but ever since the introduction of <a href=\"https://github.com/features/actions\" class=\"markdown-link\">Github Actions</a>, that has become my go to solution for any automation required on Github projects. It's a nice choice because it integrates with Github seamlessly, (as it's built by the same company) and there's no need to authorize a third party application to your Github account.</p>\n<p class=\"markdown-para\">The remainder of this post assumes some working knowledge of Github Actions, if you haven't used it before, checkout the <a href=\"https://docs.github.com/en/actions/quickstart\" class=\"markdown-link\">Quickstart Guide</a>.</p>\n<h2 class=\"markdown-subtitle\" id=\"Continuous-Integration\" style=\"position:relative;\"><a href=\"#Continuous-Integration\" aria-label=\"Continuous Integration permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continuous Integration</h2>\n<p class=\"markdown-para\">Let's start with the \"CI\" part of the process. This should run on every commit, every branch, to ensure the site can build and the tests are passing. This is to provide feedback as early as possible if a bug has been introduced.</p>\n<p class=\"markdown-para\">To get this going with Github Actions, add a <code>.github/workflows</code> directory in the root of your project. Then add a file named <code>ci.yml</code> in this directory. It can be named anything, just choose a name that is descriptive as to what this workflow does.</p>\n<p class=\"markdown-para\">Since this workflow should run on every branch and every commit that gets pushed, the <code>on: push</code> trigger will be used. Workflows run on Github Action runners (specified in the <code>runs-on</code> instruction). Keep in mind that unlike a local development environment, these are starting \"fresh\" each time. This means any dependencies needed by the site such as Node.js and npm packages defined in <code>package.json</code> will need to be installed.</p>\n<p class=\"markdown-para\">Here is the continuous integration workflow used on this blog, with annotations to explain each step. Steps with <code>uses</code> are referring to pre-built actions that are available in the <a href=\"https://github.com/marketplace?type=actions\" class=\"markdown-link\">Actions Marketplace</a>. The other steps are running commands exactly as specified on the runner machine:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/ci.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run this workflow on any push to any branch.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">push</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># A workflow can have one or more jobs.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This workflow has just a single job named `ci`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">ci</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Run this job on a Github hosted action runner with the latest version of ubuntu installed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># A job has one or more steps.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Checkout the project source files to the Github Action runner.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># This is roughly equivalent to running `git checkout`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Install the version of Node.js used by project.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup node</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-node@v2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">node-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;14&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">cache</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;npm&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Install package dependencies as defined in package.json file in root of project.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Run `gatsby build`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm run build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Run the Jest unit tests and generate a coverage report.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm test -- --coverage</span></span></span></code></pre>\n<h2 class=\"markdown-subtitle\" id=\"Continuous-Deployment-When\" style=\"position:relative;\"><a href=\"#Continuous-Deployment-When\" aria-label=\"Continuous Deployment When permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continuous Deployment: When</h2>\n<p class=\"markdown-para\">This part needs careful consideration because it will deploy new code to production. The first thing to think about is <em class=\"markdown-emphasis\">when</em> should it run. Clearly the simple <code>on: push</code> trigger used for the CI workflow would not be suitable as we don't want just any work-in-progress branch getting deployed.</p>\n<p class=\"markdown-para\">One solution is to use a trigger filter to limit which branches a workflow will run on. For example, to indicate that a given workflow should only run when commits are pushed to the <code>main</code> branch:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/cd.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">push</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk6\">main</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># steps to build and deploy the site...</span></span></span></code></pre>\n<p class=\"markdown-para\">Given that the only way code should get pushed to <code>main</code> is when an approved PR (Pull Request) is merged (either via merge commit or squash &#x26; merge), the above workflow trigger would ensure that a deploy only goes out when a PR is merged.</p>\n<aside class=\"markdown-aside\">\nPreventing direct pushes to the default branch can be controlled using Github's <a class=\"markdown-link\" href=\"https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/defining-the-mergeability-of-pull-requests/managing-a-branch-protection-rule\">branch protection rules</a>.\n</aside>\n<p class=\"markdown-para\">However, even if the project is configured to not allow commits to be pushed directly to <code>main</code>, there's still a problem. What if the tests fail on <code>main</code> as a result of the merge commit (or squash/merge) from the PR? Recall that since the CI workflow has trigger <code>on: push</code>, it will also run when a PR gets merged to <code>main</code>. Even though the tests would have run on the branch that got merged, there's a chance that something goes wrong as a result of the merge and tests fail on <code>main</code>. In this case, the deploy should not run.</p>\n<p class=\"markdown-para\">So what we want to express is: \"Only run this workflow on the main branch, and <em class=\"markdown-emphasis\">after</em> continuous integration has completed successfully on the main branch.\" The way to express this with Github Actions is to use the <a href=\"https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows#workflow_run\" class=\"markdown-link\">workflow_run</a> trigger, which allows one workflow to be dependent on another.</p>\n<p class=\"markdown-para\">For example, to indicate that the CD workflow should only run on the <code>main</code> branch, after the CI workflow has completed:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/cd.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">workflow_run</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">workflows</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;CI&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">main</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">types</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">completed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># steps to build and deploy the site...</span></span></span></code></pre>\n<p class=\"markdown-para\">However, there's still one more complication to deal with, <code>completed</code> just means the workflow finished, it does not mean it was successful. i.e. it would run even if the tests in the <code>CI</code> workflow failed. Unfortunately, there's no <code>type</code> keyword to indicate completed successfully, however, the result of the workflow run is available in the <a href=\"https://docs.github.com/en/actions/learn-github-actions/contexts\" class=\"markdown-link\">github context</a> and can be used in an <code>if</code> expression as follows:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/cd.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">workflow_run</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">workflows</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;CI&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">main</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">types</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">completed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ github.event.workflow_run.conclusion == &#39;success&#39; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># steps to build and deploy the site...</span></span></span></code></pre>\n<p class=\"markdown-para\">Putting it all together, the above workflow says: Kick off the <code>CD</code> workflow  on the <code>main</code> branch, after the <code>CI</code> workflow has completed on the <code>main</code> branch, but only run the <code>deploy</code> job if the <code>CI</code> workflow completed successfully.</p>\n<aside class=\"markdown-aside\">\nIt seems awkward to implement \"If workflow A is successful, then run workflow B\" in two different portions of the workflow file. First in the workflow_run -> types section, and second as an if condition in the job. At the time of this writing, this is the only way I could find to do it. I would imagine as Github Actions matures, there will eventually be a more succinct way to express this.\n</aside>\n<h2 class=\"markdown-subtitle\" id=\"Continuous-Deployment-Steps\" style=\"position:relative;\"><a href=\"#Continuous-Deployment-Steps\" aria-label=\"Continuous Deployment Steps permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continuous Deployment: Steps</h2>\n<p class=\"markdown-para\">Now that the \"when\" part of continuous deployment has been defined, it's time to automate it by scripting all the manual steps into the workflow file. For this blog, it needs some of the same steps as CI (checkout out project source, installing dependencies and running the production build), and then it needs a few other specific steps including generating an <code>.env</code> file for production, deploying to Github Pages, and finally ingesting the markdown documents to a <a href=\"../roll-your-own-search-service-for-gatsby-part5\" class=\"markdown-link\">search service</a>.</p>\n<p class=\"markdown-para\">Some of these steps require \"secrets\", that is, values that should not be hard-coded in the workflow file (or anywhere in the source code). Secrets can be added to any Github repository to which you've got admin rights. Click on \"Settings\" from the main repository page on Github, then select the \"Secrets\" option. Then the secret values can be accessed as <code>{{ secrets.MY_SECRET }}</code> in workflow files.</p>\n<p class=\"markdown-para\">Here is the workflow file containing all these steps, with annotations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .github/workflows/cd.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">CD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run on main branch after CI workflow has completed on main.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">on</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">workflow_run</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">workflows</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">&quot;CI&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">branches</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">main</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">types</span><span class=\"mtk1\">: [</span><span class=\"mtk6\">completed</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">jobs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">deploy</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">runs-on</span><span class=\"mtk1\">: </span><span class=\"mtk6\">ubuntu-latest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Only go ahead with the job if CI completed successfully (i.e. tests passed).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ github.event.workflow_run.conclusion == &#39;success&#39; }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">steps</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Checkout project source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Checkout source</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/checkout@v1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Install Node.js dependency</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Setup node</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">actions/setup-node@v2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">node-version</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;14&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">cache</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&quot;npm&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Install package.json dependencies</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm install</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># A simple bash script to generate the .env file from repository secrets.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># This is to avoid hard-coding urls for services such as analytics and search.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># For production, its important to run this step BEFORE building the site because</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># its a static site, and so environment variables are used at build time rather</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># than run time.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Generate prod env file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">HELLO_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.HELLO_URL }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">SEARCH_URL</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.SEARCH_URL }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">SEARCH_ENABLED</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.SEARCH_ENABLED }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">touch .env.production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">echo HELLO_URL=&quot;$HELLO_URL&quot; &gt;&gt; .env.production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">echo SEARCH_URL=&quot;$SEARCH_URL&quot; &gt;&gt; .env.production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">echo SEARCH_ENABLED=&quot;$SEARCH_ENABLED&quot; &gt;&gt; .env.production</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">shell</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Run the production build - this runs: gatsby build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># which generates the &quot;public&quot; directory containing the entire site.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk6\">npm run build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Use a community action from the Actions Marketplace to deploy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># the &quot;public&quot; directory generated by the build to Github Pages.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Deploy to Github Pages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">uses</span><span class=\"mtk1\">: </span><span class=\"mtk6\">peaceiris/actions-gh-pages@v3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">with</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">github_token</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.GITHUB_TOKEN }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">publish_dir</span><span class=\"mtk1\">: </span><span class=\"mtk6\">./public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Finally, ingest the search.sql file (also generated by the build)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># into the Heroku database for the application hosting the search service.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      - </span><span class=\"mtk7\">name</span><span class=\"mtk1\">: </span><span class=\"mtk6\">Ingest search docs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">env</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">HEROKU_APP_NAME</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.HEROKU_APP_NAME }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk7\">HEROKU_API_KEY</span><span class=\"mtk1\">: </span><span class=\"mtk6\">${{ secrets.HEROKU_API_KEY }}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">run</span><span class=\"mtk1\">: </span><span class=\"mtk7\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">HEROKU_API_KEY=$HEROKU_API_KEY cat search.sql | heroku pg:psql --app $HEROKU_APP_NAME</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">shell</span><span class=\"mtk1\">: </span><span class=\"mtk6\">bash</span></span></span></code></pre>\n<p class=\"markdown-para\">Of course your Gatsby site may have some different details. For example, instead of using a custom search service hosted on Heroku, it may be using a commercial service such as Algolia. In that case, it would require researching what are the automation steps to update the search index on Algolia. Or if the site is hosted somewhere other than Github Pages, for example Netlify, it would require some some <a href=\"https://github.com/netlify/actions\" class=\"markdown-link\">automation</a> specific to that platform.</p>\n<h2 class=\"markdown-subtitle\" id=\"Conclusion\" style=\"position:relative;\"><a href=\"#Conclusion\" aria-label=\"Conclusion permalink\" class=\"markdown-header-link before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p class=\"markdown-para\">This post has walked through how to think about the process of CI/CD for a Gatsby site. It begins by writing down the current list of manual tasks, figuring out which of these steps need to run when, and setting up Github Action workflows to automate them. It also explained how to use the <code>workflow_run</code> trigger to make one workflow dependent on the success of another. I hope this will serve as an inspiration for others to automate some manual tasks they may be doing on their projects.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/ci-cd-pipeline-for-gatsby/"}}}]}},"pageContext":{}},
    "staticQueryHashes": ["163244226"]}