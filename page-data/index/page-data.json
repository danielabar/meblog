{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"allMarkdownRemark":{"totalCount":37,"edges":[{"node":{"id":"a4831b51-78ea-511c-8529-47e95444e661","frontmatter":{"title":"Testing Faraday with RSpec","date":"August 2021","category":"ruby"},"excerpt":"If you've ever developed code that had to integrate with a third party service that didn't have an up-to-date gem available, there's a goodâ€¦","html":"<p>If you've ever developed code that had to integrate with a third party service that didn't have an up-to-date gem available, there's a good chance you've had to reach for an HTTP client to make requests to the service. <a href=\"https://github.com/lostisland/faraday\">Faraday</a> is a popular choice. It's easy to use and well documented. However, the way in which it gets used will impact how the code can be tested. This post will go through two different ways it can be tested.</p>\n<h2>Setup</h2>\n<p>Suppose you're building an app to display today's weather in a given city. We'll be using the <a href=\"https://www.weatherapi.com/docs/\">Weather API</a> to get the weather data via a restful API that returns JSON data. Usage requires signing up for an API key, but the free tier is very generous and will be adequate for this demo.</p>\n<p>A request to get the current weather and air quality index, for example, for Paris, looks like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> https://api.weatherapi.com/v1/current.json?key=yourApiKey&amp;q=Paris&amp;aqi=yes</span></span></span></code></pre>\n<p>And the response looks something like this (shortened for brevity):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;location&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;name&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Paris&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;country&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;France&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;localtime&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-08-08 23:00&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;current&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;last_updated&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-08-08 22:00&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;temp_c&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">18.0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;condition&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;text&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Partly cloudy&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;icon&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;//cdn.weatherapi.com/weather/64x64/night/116.png&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;code&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1003</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;feelslike_c&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">18.0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;uv&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">4.0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">&quot;air_quality&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk9 mtki\">&quot;us-epa-index&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Here is the first attempt at writing the <code>WeatherClient</code> using Faraday. It exposes a single method <code>today</code> that makes a <code>Faraday.get</code> request to the weather api, and parses the response to return a sentence such as:</p>\n<p>\"Weather for Paris, France is 18 degrees. Cloudy. Air quality is Good.\"</p>\n<p>The mapping of <code>us-epa-index</code> to an air quality string such as <code>Good</code>, <code>Moderate</code> etc. comes from the Weather API docs. <a href=\"https://github.com/bkeepers/dotenv\">dotenv</a> is used to avoid hard-coding the API key and instead pull it from a git ignored <code>.env</code> file.</p>\n<p>This is a plain old Ruby project with no Rails, so the dependencies are required:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/weather_client.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;dotenv/load&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;faraday&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;json&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">today</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.get(</span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1/current.json&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parse_today(</span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">.parse(response.body))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">parse_today</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">json</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    location </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> json[</span><span class=\"mtk6\">&#39;location&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    current </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> json[</span><span class=\"mtk6\">&#39;current&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    condition </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> current[</span><span class=\"mtk6\">&#39;condition&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;Weather for </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">location[</span><span class=\"mtk6\">&#39;name&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">, </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">location[</span><span class=\"mtk6\">&#39;country&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> is </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">current[</span><span class=\"mtk6\">&#39;temp_c&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> degrees. </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">condition[</span><span class=\"mtk6\">&#39;text&#39;</span><span class=\"mtk1\">]</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\"> Air quality is </span><span class=\"mtk7\">#{</span><span class=\"mtk1\">air_quality(current[</span><span class=\"mtk6\">&#39;air_quality&#39;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&#39;us-epa-index&#39;</span><span class=\"mtk1\">])</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">air_quality</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">aq_val</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    aq_map </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">1</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Good&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">2</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Moderate&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">3</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Unhealthy for sensitive groups&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">4</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Unhealthy&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">5</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Very Unhealthy&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">6</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;Hazardous&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    aq_map[aq_val] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Unknown&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Some example usage in an irb console:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">irb -r ./app/weather_client.rb</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">irb(main):001:0&gt; WeatherClient.new.today(city: &#39;Paris&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">=&gt; &quot;Weather for Paris, France is 17.0 degrees. Partly cloudy. Air quality is Good&quot;</span></span></code></pre>\n<h2>1. RSpec Stubbing</h2>\n<p>How to write a test for <code>WeatherClient</code>? Calling out to the Weather API is a side effect, and tests should not have any side effects. For example, each call uses up request quota for the API key. Even if usage were unlimited, this code is requesting the <em>current</em> weather. This means at any given day/time, the response could be different so it will be impossible to write a test expecting a specific result. Another consideration is the Weather API could go down at the same instance when the test is run, this would cause the test to fail even though no code changes had been made on this app.</p>\n<p>Since the <code>today</code> method calls <code>Faraday.get</code> directly, RSpec stubbing must be used to set the returned response of the <code>Faraday.get</code> method for the test. This will prevent a real HTTP request from being sent when the test is run and instead return a canned response of our design. In order to do this, we must know what kind of object is returned by <code>Faraday.get</code>, which is a <code>Faraday::Response</code>.</p>\n<p>Then the code calls the <code>body</code> method of the returned <code>Faraday::Response</code> object, this contains the string content of the Weather API response. In order for this to work in a test, the stub of <code>Faraday.get</code> must return a test double, which will stand in for the <code>Faraday::Response</code> object. Then the <code>body</code> method of the test double is also stubbed to return the actual string response.</p>\n<p>Here is the test:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># spec/weather_client_spec.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;./app/weather_client_old&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">RSpec</span><span class=\"mtk1\">.describe WeatherClient </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&#39;#today&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;gets current weather for a city&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># stub Faraday `get` method to avoid making a real HTTP request when test is run</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      response_dbl </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> instance_double(</span><span class=\"mtk6\">&#39;Faraday::Response&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      allow(Faraday).to receive(</span><span class=\"mtk4\">:get</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .with(</span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1/current.json&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Paris&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .and_return(response_dbl)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># stub body method on response object to return a canned response for Paris weather</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      allow(response_dbl).to receive(</span><span class=\"mtk4\">:body</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .and_return(</span><span class=\"mtk6\">&#39;{&quot;location&quot;:{&quot;name&quot;:&quot;Paris&quot;,&quot;country&quot;:&quot;France&quot;},&quot;current&quot;:{&quot;temp_c&quot;:16.0,&quot;condition&quot;:{&quot;text&quot;:&quot;Clear&quot;},&quot;air_quality&quot;:{&quot;us-epa-index&quot;:1}}}&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      paris_weather </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> described_class.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">.today(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Paris&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(paris_weather).to eq(</span><span class=\"mtk6\">&#39;Weather for Paris, France is 16.0 degrees. Clear. Air quality is Good&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h3>Problems</h3>\n<p>While this works, it feels a little clunky. It requires knowing some details of Faraday like the fact that calling <code>get</code> returns a <code>Faraday::Response</code> object. If a future release of Faraday will refactor to return a different object, then this test will fail even the refactored object behaves exactly the same as in the previous version. Generally speaking, use of stubs/mocks can make a test brittle because its verifying some implementation details rather than focusing on the expected return value of a method.</p>\n<p>Also the double stubbing required - once for <code>Faraday.get</code> and again for the response double it returns, makes the test hard to read.</p>\n<p>Another issue occurs when trying to add another Weather API request. For example, in addition to the current weather <code>/current.json</code>, there's another endpoint for the future weather at <code>/forecast.json</code>. When using <code>Faraday.get</code>, each request has to repeat the base url, headers, and common parameters such as the API key, for example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">today</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.get(</span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1/current.json&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parse_today(</span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">.parse(response.body))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Some duplication with `today` method including base url, headers, and setting of API key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">forecast</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.get(</span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1/forecast.json&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                             </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                           { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with response...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>2. Faraday Stubbing</h2>\n<p>Fortunately, Faraday provides a cleaner solution for testing, which will be explained in this section. This will require some refactoring and introducing several new concepts.</p>\n<h3>Faraday Connection</h3>\n<p>First, to fix the issue of code duplication - that every request to the API requires repeating the base url and common parameters. Faraday provides a <code>Faraday::Connection</code> object to store common configuration. Subsequent http requests such as <code>get</code>, <code>post</code>, etc. can be made on the connection object.</p>\n<p>To create a connection object, call <code>Faraday.new</code>. For example, the <code>today</code> method on <code>WeatherClient</code> could be written like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">today</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">url:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">params:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">] },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> conn.get(</span><span class=\"mtk6\">&#39;current.json&#39;</span><span class=\"mtk1\">, { </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city, </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parse_today(</span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">.parse(response.body))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>At this point, it doesn't seem like much of an improvement because all the common logic (base url, api key and headers) are still in the <code>today</code> method.</p>\n<p>The beauty of this approach comes when pulling out the connection object into the <code>initialize</code> method and making it an instance variable. Then it can be shared among multiple API methods without having to repeat the base url, api key and headers. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">url:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">params:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">] },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">today</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> @conn.get(</span><span class=\"mtk6\">&#39;current.json&#39;</span><span class=\"mtk1\">, { </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city, </span><span class=\"mtk4\">aqi:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;yes&#39;</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    parse_today(</span><span class=\"mtk9 mtki\">JSON</span><span class=\"mtk1\">.parse(response.body))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">future</span><span class=\"mtk1\">(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> @conn.get(</span><span class=\"mtk6\">&#39;forecast.json&#39;</span><span class=\"mtk1\">, { </span><span class=\"mtk4\">q:</span><span class=\"mtk1\"> city })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># do something with response...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Ok so the code duplication issue has been solved with use of an instance <code>Faraday::Connection</code> object, but how does this help with testing?</p>\n<h3>Faraday Test Adapter</h3>\n<p>Faraday comes with a built-in test adapter for defining stubbed HTTP requests to mock out network services. A <code>Faraday::Connection</code> object can then be instantiated using the test adapter. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Test adapter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">stubs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Adapter</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Test</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Stubs</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Instantiate a connection that uses the test adapter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\"> { |b| b.adapter(</span><span class=\"mtk4\">:test</span><span class=\"mtk1\">, stubs) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Define any number of mock network requests on the test adapter, which yields an array of three elements:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   1. HTTP response code</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   2. Hash of HTTP response headers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#   3. String of HTTP response body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">stubs.get(</span><span class=\"mtk6\">&#39;/some-endpoint&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">200</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    { </span><span class=\"mtk6\">&#39;Content-Type&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&#39;{&quot;name&quot;: &quot;some canned response for testing&quot;}&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>If the stubbed connection object <code>conn</code> gets used to make an HTTP request that matches what is stubbed, then the HTTP response code will be 200 and the response body will be the canned response. No real network request to <code>/some-endpoint</code> will be made. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">resp </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> conn.get(</span><span class=\"mtk6\">&#39;/some-endpoint&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">resp.status </span><span class=\"mtk3\"># 200</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">resp.headers </span><span class=\"mtk3\"># { &#39;Content-Type&#39;: &#39;application/json&#39; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">resp.body </span><span class=\"mtk3\"># &#39;{&quot;name&quot;: &quot;some canned response for testing&quot;}&#39;</span></span></span></code></pre>\n<p>So the next question is - how to make <code>WeatherClient</code> use this stubbed connection object instead of a real connection object when running tests? This leads to the last and final concept that will tie this all together.</p>\n<h3>Dependency Injection</h3>\n<p>Dependency injection will allow us to \"inject\" a stubbed Faraday connection into <code>WeatherClient</code> for testing purposes. But first, what is dependency injection? According to <a href=\"https://en.wikipedia.org/wiki/Dependency_injection\">Wikipedia</a>:</p>\n<blockquote>\n<p>In software engineering, dependency injection is a technique in which an object receives other objects that it depends on, called dependencies. Typically, the receiving object is called a client and the passed-in ('injected') object is called a service. The code that passes the service to the client is called the injector. Instead of the client specifying which service it will use, the injector tells the client what service to use. The 'injection' refers to the passing of a dependency (a service) into the client that uses it.</p>\n</blockquote>\n<p>In this example, <code>WeatherClient</code> is the \"receiving object\", and the \"service\" we want to pass in is a <code>Faraday::Connection</code>. The problem with the current implementation of <code>WeatherClient</code> is that the initializer <em>always</em> instantiates a new instance of <code>Faraday::Connection</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># always constructs a new Faraday::Connection object</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">url:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">params:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">] },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>To make <code>WeatherClient</code> support injecting a connection object, the <code>initialize</code> method is modified to optionally accept a <code>conn</code> parameter, and either use the provided parameter, or if not specified, instantiate a new Faraday connection object:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">WeatherClient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Make Faraday connection injectable for easier testing.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">conn</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @conn </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> conn </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">url:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;https://api.weatherapi.com/v1&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">params:</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">key:</span><span class=\"mtk1\"> ENV[</span><span class=\"mtk6\">&#39;WEATHER_API_KEY&#39;</span><span class=\"mtk1\">] },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> { </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>And finally, a test can be written against this version of <code>WeatherClient</code>, initializing it with a stubbed <code>Faraday::Connection</code> to avoid making real HTTP requests:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">require</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;./app/weather_client&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">RSpec</span><span class=\"mtk1\">.describe WeatherClient </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Faraday test adapter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  let(</span><span class=\"mtk4\">:stubs</span><span class=\"mtk1\">) { </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Adapter</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Test</span><span class=\"mtk1\">::</span><span class=\"mtk9 mtki\">Stubs</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Faraday::Connection object that uses the test adapter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  let(</span><span class=\"mtk4\">:conn</span><span class=\"mtk1\">) { </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.</span><span class=\"mtk7\">new</span><span class=\"mtk1\"> { |b| b.adapter(</span><span class=\"mtk4\">:test</span><span class=\"mtk1\">, stubs) } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># WeatherClient with the stubbed connection object injected</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  let(</span><span class=\"mtk4\">:client</span><span class=\"mtk1\">) { described_class.</span><span class=\"mtk7\">new</span><span class=\"mtk1\">(conn) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># Clear default connection to prevent it from being cached between different tests.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># This allows for each test to have its own set of stubs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  after </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">Faraday</span><span class=\"mtk1\">.default_connection </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">nil</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  describe </span><span class=\"mtk6\">&#39;#today&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    it </span><span class=\"mtk6\">&#39;gets current weather for a city&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Block yields an array with 3 items:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">#   1. HTTP response code</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">#   2. Hash of headers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">#   3. String response body</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      stubs.get(</span><span class=\"mtk6\">&#39;current.json&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">200</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          { </span><span class=\"mtk6\">&#39;Content-Type&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;application/json&#39;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk6\">&#39;{&quot;location&quot;:{&quot;name&quot;:&quot;Paris&quot;,&quot;country&quot;:&quot;France&quot;},&quot;current&quot;:{&quot;temp_c&quot;:16.0,&quot;condition&quot;:{&quot;text&quot;:&quot;Clear&quot;},&quot;air_quality&quot;:{&quot;us-epa-index&quot;:1}}}&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      paris_weather </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> client.today(</span><span class=\"mtk4\">city:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;Paris&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      expect(paris_weather).to eq(</span><span class=\"mtk6\">&#39;Weather for Paris, France is 16.0 degrees. Clear. Air quality is Good&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\"># Verify every stubbed method that was defined on test adapter actually got called when code was exercised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      stubs.verify_stubbed_calls</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Which Approach to Use?</h2>\n<p>My preference is to use the built-in Faraday test adapter whenever possible because it results in cleaner looking tests and is officially supported by the library. However, as with most technical decisions, the correct answer is, it depends.</p>\n<p>If you're fortunate to be green fielding a project, or at the very least, the client class that will be making HTTP requests, then go ahead and design the class with dependency injection and use the built-in Faraday test adapter.</p>\n<p>If on the other hand, you're dealing with legacy code that uses the Faraday class helper methods such as <code>Faraday.get</code>, <code>Faraday.post</code>, then the safest solution may be to use regular RSpec stubbing. The exception to this would be if the project has really solid end-to-end test coverage, then you could consider refactoring some of the legacy code that uses Faraday to make it easier to test.</p>\n<h2>Conclusion</h2>\n<p>This post has covered two different ways of using and testing Faraday for making HTTP requests to an external service. The first approach is to use Faraday's class helper methods, and test with regular RSpec stubbing. Although this works, it can lead to brittle, difficult to read tests, but may be the safest option when dealing with legacy code. The second approach is to design the client class with dependency injection, then use Faraday's built-in test adapter to inject a stubbed connection into the class for testing. This results in cleaner, easier to read tests.</p>\n<p>All the code used in this post can be found on <a href=\"https://github.com/danielabar/ruby-weather\">Github</a>.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/testing-faraday-with-rspec/"}}},{"node":{"id":"f75c3ca0-d88e-5888-83da-17b1d57670a1","frontmatter":{"title":"Add Rubocop to an Existing Rails Project","date":"July 2021","category":"rails"},"excerpt":"I think Rubocop is awesome! There are some that find it (and linters in general) annoying, even leading to git commit messages along theâ€¦","html":"<p>I think Rubocop is awesome! There are some that find it (and linters in general) annoying, even leading to git commit messages along the lines of \"F@%#^!ng rubocop\". But for me, coding with Rubocop is like having a wizard with the entire collective wisdom of the Ruby community sitting beside me, pointing out where improvements could be made, resulting in more idiomatic Ruby.</p>\n<p>Before going any further, for those unfamiliar with what is Rubocop, from the <a href=\"https://github.com/rubocop/rubocop\">docs</a>:</p>\n<blockquote>\n<p>RuboCop is a Ruby static code analyzer (a.k.a. linter) and code formatter. Out of the box it will enforce many of the guidelines outlined in the community Ruby Style Guide. Apart from reporting the problems discovered in your code, RuboCop can also automatically fix many of them for you.</p>\n</blockquote>\n<p>Whenever starting a new Rails project, one of my first commits is to install and configure Rubocop, plus a few extensions for rules specific to Rails, performance, and thread safety. This keeps the code consistent and in line with best practices no matter how many developers are working on the project.</p>\n<p>However, sometimes you may be working on a legacy project that was not started with Rubocop. In this case, itâ€™s still valuable to bring it in, but there are some challenges. Given that the entire history of the project was developed without a linter, there will likely be many offences. Could be hundreds or more, and offences of all different types. It can be overwhelming to go through all the output. Some of these may be easy to fix like extra empty lines before an ending block, and some may be more difficult like reducing complexity of a method with too much branching logic. As always, any code changes may cause unintended bugs.</p>\n<p>This post will walk you through a 4 step process for introducing Rubocop into an existing legacy project while minimizing the chances of breaking production, and maintaining your sanity. Some working knowledge of Rubocop is assumed. If you haven't used it before, go through the <a href=\"https://docs.rubocop.org/rubocop/1.18/index.html\">intro docs</a> and <a href=\"https://docs.rubocop.org/rubocop/1.18/usage/basic_usage.html\">basic usage</a>.</p>\n<h2>1. Test Coverage</h2>\n<p>Before making any changes, verify the project has decent test coverage. This should include unit/model tests for business logic and database interactions, request tests for all exposed API endpoints and web/end-to-end tests (aka Acceptance tests) for all essential web flows. This last category of tests can be the most difficult and time consuming to setup but is essential before bringing in a linter on a legacy project. Itâ€™s not necessary to have every single user interaction covered by web tests, but at the very least, identify the most essential flows to your business and make sure these are covered. For example, for an e-commerce site, this might include search, add to cart, and checkout.</p>\n<h2>2. Install Rubocop and Autocorrect</h2>\n<p>Add rubocop to the project Gemfile and run <code>bundle install</code>. Then create a <code>.rubocop.yml</code> configuration file in the project root. I typically exclude Rails auto generated files and disable the <code>Style/Documentation</code> rule. Although I'm a huge fan of <em>useful</em> documentation, have found that when the <code>Style/Documentation</code> is enabled, developers may write comments like \"Customer Model\" for <code>class Customer &#x3C; ApplicationRecord</code> just to get the rule to pass.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">AllCops</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">NewCops</span><span class=\"mtk1\">: </span><span class=\"mtk6\">enable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Exclude</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;db/schema.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;Gemfile&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;lib/tasks/*.rake&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;bin/*&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;config/puma.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;config/spring.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;config/environments/development.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;config/environments/production.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&quot;spec/spec_helper.rb&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Style/Documentation</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">false</span></span></span></code></pre>\n<p>Just to get a sense of how many rule offenses are currently in the project, run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop</span></span></code></pre>\n<p>You'll probably get multiple screen fulls of output scrolling past, with a summary such as (this is an example from a project from my recent experience with this):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">96 files inspected, 270 offenses detected, 215 auto-correctable</span></span></code></pre>\n<p>At this point, it's hard to make sense of all the output or know where to start. To help organize all this, Rubocop has several format options, one of which is <code>--format offenses</code>. This will summarize how many occurrences of each rule violation it found, and order them by descending occurrence. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop --format offenses</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">56   Layout/FirstHashElementIndentation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">54   Layout/HashAlignment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">18   Metrics/BlockLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">16   Metrics/MethodLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">16   Style/StringLiterals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">14   Style/TrailingCommaInHashLiteral</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">13   Layout/LineLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">12   Layout/EmptyLinesAroundClassBody</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">8    Layout/SpaceInsideHashLiteralBraces</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">7    Layout/SpaceAfterComma</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">6    Layout/ExtraSpacing</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">6    Layout/SpaceInsideStringInterpolation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4    Layout/TrailingEmptyLines</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4    Metrics/AbcSize</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3    Layout/EmptyLinesAroundBlockBody</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Layout/ArgumentAlignment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Layout/EmptyLinesAroundModuleBody</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Layout/SpaceInsideArrayLiteralBrackets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Lint/SymbolConversion</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Metrics/CyclomaticComplexity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Naming/VariableNumber</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Style/IdenticalConditionalBranches</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Style/IfUnlessModifier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2    Style/RedundantBegin</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/EmptyLineAfterGuardClause</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/EmptyLineAfterMagicComment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/EmptyLines</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/SpaceInsideBlockBraces</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Layout/TrailingWhitespace</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Metrics/ModuleLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Metrics/PerceivedComplexity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Naming/ConstantName</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/AndOr</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/MutableConstant</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/RedundantParentheses</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/RedundantReturn</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/RedundantSelf</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/SafeNavigation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1    Style/SymbolArray</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">270  Total</span></span></code></pre>\n<p>This seems like a lot of work to go through manually and fix all these. Luckily, Rubocop has an autocorrect option that will update the code to fix any offenses where the rule is auto-correctable. To see if a rule is auto-correctable or not, see the <a href=\"https://docs.rubocop.org/rubocop/1.18/cops.html\">Cops documentation</a>. For example, from the above summary report, there are 56 occurrences of the <code>Layout/FirstHashElementIndentation</code> violation. According to the <a href=\"https://docs.rubocop.org/rubocop/1.18/cops_layout.html#layoutfirsthashelementindentation\">docs</a> for this rule, it supports autocorrection.</p>\n<p>Now run Rubocop with the autocorrect flag, I'm using the \"safe\" version of this <code>-a</code> rather than \"all\" <code>-A</code>. Slight difference that some rules are autocorrectable, but not necessarily safe in they may change semantics of the code or generate false positives (detecting a rule offense when there is none really).</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop -a</span></span></code></pre>\n<p>You'll see all the same scrolling output as before as it finds each rule violation, but this time it will also show <code>[Corrected]</code> beside all the ones that were auto corrected. At this point, there will probably be a lot of changed files. Review these changes with <code>git status</code> and <code>git diff</code> or git <code>difftool</code>, run tests, and if all the tests pass, commit the changes.</p>\n<h2>3. Inventory Remaining Offenses</h2>\n<p>At this point, all the easy fixes have been done. Now we're entering into trickier territory. Let's run the summary report again to see how many offenses are left to deal with. An example from a recent project:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop --format offenses</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">19  Metrics/MethodLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">18  Metrics/BlockLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">13  Layout/LineLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4   Metrics/AbcSize</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2   Metrics/CyclomaticComplexity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2   Metrics/ModuleLength</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2   Naming/VariableNumber</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Lint/EmptyConditionalBody</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Metrics/PerceivedComplexity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Naming/ConstantName</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Style/MutableConstant</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1   Style/SafeNavigation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">65  Total</span></span></code></pre>\n<p>Well, this is a lot better than the 270 that we started with, autocorrect was able to reduce the offenses by ~75% on this project. But what to do about the remaining offenses? Notice these are areas of the code where potentially significant refactoring needs to be done which could break functionality.</p>\n<p>For example <code>Metrics/MethodLength</code> refers to the number of lines in a method. According to the <a href=\"https://docs.rubocop.org/rubocop/1.18/cops_metrics.html#metricsmethodlength\">docs</a> for this rule, the default <code>Max</code> value is 10. Your project may have some big hairy methods that are way longer than this and difficult to break up in a meaningful way.</p>\n<p>An even trickier one to deal with is <code>Metrics/AbcSize</code>. This <a href=\"https://docs.rubocop.org/rubocop/1.18/cops_metrics.html#metricsabcsize\">rule</a> calculates a score based on the number of assignments, branches (aka method calls), and conditions in a given method. The default <code>Max</code> value for this rule is 17. It can be difficult to reduce this score, it could be on some methods that are very complicated and not well understood. Perhaps the original developer that worked on it is no longer at the company and the tests aren't that helpful in explaining what the method does.</p>\n<p>My approach when bringing in Rubocop is not to make any logical changes to the existing code. The Pull Request will already be quite large due to the easy auto-correctable offenses. It will be difficult for the PR reviewers scanning through all the changes to catch potentially breaking logical changes among all the trivial auto-corrected changes. There may also be differences among the team on how to approach the logical changes, while not requiring any discussion for the auto-corrected changes.</p>\n<h2>4. Tune Remaining Offenses</h2>\n<p>So how to get Rubocop to pass at this point? A naive approach is to simply disable all the remaining rules, for example, add to <code>.rubocop.yml</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/MethodLength</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/AbcSize</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># etc for each rule that couldn&#39;t be auto-corrected</span></span></span></code></pre>\n<p>The problem with the naive approach is that there's nothing to stop the code quality from getting worse as more features are added to the project. For example, the next developer to work on a method with a high <code>AbcSize</code> score won't get a warning when they go to add another assignment to the offending method, and the next developer and the next after that. The complexity will keep increasing.</p>\n<p>A better approach is to capture the existing maximum value for every rule, and configure that as the maximum allowed on this project. What this does is effectively draw a line in the sand to express: \"Yeah we know it's not great but at least things will get no worse\". For example, suppose the longest method length in your project is 25 and you don't want it to get any worse than that in the future, then you'd add the following to <code>.rubocop.yml</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/MethodLength</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Max</span><span class=\"mtk1\">: </span><span class=\"mtk4\">25</span></span></span></code></pre>\n<p>Then the next developer to modify this method, say to add a new feature or fix a bug will get a warning that the maximum has been exceeded. A refactor can be undertaken at that time, which will be more comprehensible in the scope of just that feature, rather than in the massive Rubocop pull request.</p>\n<p>So the next question is - how do you go about finding the max violation values in the project? Clearly no one is going to go around manually counting method lengths or calculating <code>AbcSize</code> scores.</p>\n<p>There are two ways to do this, the first involves more effort but is useful for understanding what's going on. The second way is more automated. Let's start with the manual method just to get a better understanding.</p>\n<h3>Manual Tuning</h3>\n<p>For each of the rules that could not be auto-corrected, run rubocop, filtering the output for just that rule. For example, to see only the <code>Metrics/MethodLength</code> violations:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop | grep &quot;MethodLength&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/controllers/application_controller.rb:3:3: C: Metrics/MethodLength: Method has too many lines. [12/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/controllers/base_acme_controller.rb:2:3: C: Metrics/MethodLength: Method has too many lines. [12/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/controllers/endpoint_tester_controller.rb:20:3: C: Metrics/MethodLength: Method has too many lines. [26/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">app/controllers/healthcheck_controller.rb:8:3: C: Metrics/MethodLength: Method has too many lines. [13/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/client.rb:38:5: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/some_feature.rb:23:7: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/some_feature.rb:46:7: C: Metrics/MethodLength: Method has too many lines. [13/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/another_feature.rb:24:7: C: Metrics/MethodLength: Method has too many lines. [18/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/another_feature.rb:50:7: C: Metrics/MethodLength: Method has too many lines. [18/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/another_feature.rb:76:7: C: Metrics/MethodLength: Method has too many lines. [22/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/another_feature.rb:106:7: C: Metrics/MethodLength: Method has too many lines. [31/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:23:7: C: Metrics/MethodLength: Method has too many lines. [13/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:44:7: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:67:7: C: Metrics/MethodLength: Method has too many lines. [14/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:89:7: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:112:7: C: Metrics/MethodLength: Method has too many lines. [13/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:133:7: C: Metrics/MethodLength: Method has too many lines. [16/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:157:7: C: Metrics/MethodLength: Method has too many lines. [15/10]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lib/acme/endpoints/yet_another_feature.rb:23:7: C: Metrics/MethodLength: Method has too many lines. [11/10]</span></span></code></pre>\n<p>Notice at the end of each line, there are two numbers shown in square brackets, for example <code>[15/10]</code>. The first number is the value count for this instance of the rule violation, the second number is the default or max configured value. So <code>[15/10]</code> means the method has 15 lines, but the maximum allowed is 10.</p>\n<p>Looking at the above output, we can see that the maximum method length is 31. That's not great, but remember, we're not trying to optimize at this point, just prevent things from getting worse. So this would get added to <code>.rubocop.yml</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/MethodLength</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Max</span><span class=\"mtk1\">: </span><span class=\"mtk4\">31</span></span></span></code></pre>\n<p>Repeat this for every rule that has a <code>Max</code> value that can be configured. For other rules such as <code>Naming/ConstantName</code> or <code>Style/SafeNavigation</code>, use your judgement if its just a small number of occurrences, and its easy to fix, go ahead, otherwise, disable the rule in <code>.rubocop.yml</code>.</p>\n<h3>Automatic Tuning</h3>\n<p>An easier way is to run:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bundle exec rubocop --auto-gen-config</span></span></code></pre>\n<p>This will generate a <code>.rubocop-todo.yml</code> file listing all the offenses and excluding the specific files in your project that violate the rules. For rules that have a <code>Max</code> value, it will determine the largest value from your project and configure the rule with that value. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"yml\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># .rubocop-todo.yml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Offense count: 4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Configuration parameters: IgnoredMethods, CountRepeatedAttributes.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/AbcSize</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Max</span><span class=\"mtk1\">: </span><span class=\"mtk4\">38</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Offense count: 19</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Configuration parameters: CountComments, CountAsOne, ExcludedMethods, IgnoredMethods.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Metrics/MethodLength</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Max</span><span class=\"mtk1\">: </span><span class=\"mtk4\">31</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Offense count: 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Naming/ConstantName</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">Exclude</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk6\">&#39;lib/acme/logger_formatter.rb&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ...</span></span></span></code></pre>\n<p>It also generates (or updates existing) a <code>.rubocop.yml</code> that inherits from the todo file. This way rubocop passes with no code changes (because all the offenses are effectively ignored). Then you can go over each configured rule in the <code>.rubocop-todo.yml</code> and bring it over to <code>.rubocop.yml</code>.</p>\n<p>Whichever option you chose (manual or automatic tuning), at the end of this process, you should have some changes to <code>.rubocop.yml</code> and minimal if any code changes. Review the changes, run tests, and commit. Now you're ready to submit a pull request for adding Rubocop to a legacy project.</p>\n<h2>Conclusion</h2>\n<p>This post has covered a 4 step process for how to introduce Rubocop into a legacy project while avoiding a lot of manual effort, and minimizing the chances of breaking things.</p>\n<p>The first step was to ensure good test coverage, especially end-to-end tests for flows that are essential to the business. The second step was to install Rubocop and use the safe auto-correct feature. The third step was to use the summary reporting feature to take an inventory of the remaining offenses. The fourth step was to tune each remaining offense to ensure that code quality will get no worse as the project moves forward.</p>\n<p>I hope this will encourage others to bring in Rubocop into old legacy projects to start taking advantage of its many benefits.</p>\n<h2>Related Content</h2>\n<p>The following section contains affiliate links for related content you may find useful. I get a small commission from purchases which helps me maintain this site.</p>\n<p>Looking to level up on Rails 6? You might like this book: <a href=\"https://amzn.to/3wS8GNA\">Agile Web Development with Rails 6</a>.</p>\n<p>Working on a large legacy code base? This book <a href=\"https://amzn.to/3accwHF\">Working Effectively with Legacy Code</a> is a must read.</p>\n<p>Martin Fowler's <a href=\"https://amzn.to/2RFC0Xn\">Refactoring: Improving the Design of Existing Code</a> is also amazingly useful on this topic.</p>\n<p>Is your organization introducing microservices? This book <a href=\"https://amzn.to/3uSxa87\">Building Event-Driven Microservices: Leveraging Organizational Data at Scale</a> is a fantastic resource on this topic.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/add-rubocop-to-legacy-project/"}}},{"node":{"id":"efbe756f-75c9-5ec6-8330-f548243338e7","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search UI","date":"July 2021","category":"Gatsby"},"excerpt":"This is the fifth and final in a multi-part series of posts detailing how I built the search feature for this blog. This post will explainâ€¦","html":"<p>This is the fifth and final in a multi-part series of posts detailing how I built the search feature for this blog. This post will explain how to build a search UI with Gatsby, making use of the search service that we've built up throughout the earlier posts in this series.</p>\n<p>In case you missed it:</p>\n<ul>\n<li><a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> covers the existing options for adding search to a Gatsby site, and why I decided not to use any of them, and instead build a custom search service.</li>\n<li><a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> covers the design and population of the <code>documents</code> table that contains all the content to be searched.</li>\n<li><a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> provides an introduction to PostgreSQL Full Text Search, showing some examples of using it to write queries to search against a documents table.</li>\n<li><a href=\"../roll-your-own-search-service-for-gatsby-part4\">Part 4: Search API</a> explains how to expose an HTTP based search API using Rails and PostgreSQL, and how to deploy it.</li>\n</ul>\n<h2>API Refresher</h2>\n<p>A quick reminder of where <a href=\"../roll-your-own-search-service-for-gatsby-part4\">Part 4: Search API</a> left off, the search API (hosted on a Rails server) can be executed with a <code>GET</code> to the <code>/search</code> endpoint and any given <code>q</code> parameter to specify the search term. For example:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=tdd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span></code></pre>\n<p>Returns:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">HTTP/1.1 200 OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Content-Type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json; charset=utf-8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;TDD by Example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A practical example of using TDD to add a new feature to an existing project.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;javascript&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-01-02&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/tdd-by-example/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;If youve been coding for any length of time, youve probably heard that you should test your code, and by that I mean writing automatedâ€¦&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;TDD by Example: Fixing a Bug&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A practical example of using TDD to fix a bug and do some refactoring on an existing project.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;javascript&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-05-16&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/tdd-by-example-bugfix/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This post will demonstrate an example of using TDD (test driven development) to fix a bug on an existing project. If youre not familiarâ€¦&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Solving a Python Interview Question in Ruby&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Learn how to model tuples in Ruby and solve a Python data science interview question in Ruby.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;ruby&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-03-01&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/python-interview-question-in-ruby/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A few months ago, I came across a tweet posing a technical interview question for a data science position using Python:  Lets set aside forâ€¦&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span></code></pre>\n<p>This needs to be integrated with Gatsby. Even though it's a static site generator, it also ships with React and has full dynamic capabilities at run time. This means the pages/components can execute code like <code>await fetch('https://prod-host/search?q=tdd')...</code>, and use React hooks such as <code>useEffect</code> to load data from an endpoint (i.e. side effect) and <code>setState</code> to populate state such as a list of search results retrieved from the endpoint.</p>\n<h2>Design</h2>\n<p>Before diving into the search components, the following diagram illustrates the search flow for an example user that wants to search for blog posts on \"rails\":</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3cd9d9c34bd970955e4bf8457d819c03/b5dee/search-ui-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 92.5626515763945%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsSAAALEgHS3X78AAACKElEQVQ4y6VUa3PiMAzk//+6m7keLeVRoC20IS+/kjgJ0a3kuIWDfLlmZseyLa+0kiaz2nhyZU2VakgpTapUZIwhoyo67As6HRXlJ0vJQQnSD00Ob/r2TJ3vBWxHzLqmp7buqG34oiddVOSxZ0eVOypSi7WiMnVCXGZOEIluCKPBF+duAGFNtfXUVK0Qn/tBznkdot19Z/cvZpcbJuYMNUrA2WSJkcyvfEDGhBLoIliwxwyjMw0khJ0/k3zYXzpz1iI/C/LzxEpJxAZY3eyyBpwRI/3UcIDN63hWoQxSV5CdPrQQcIM4SONaKROXaHZZ3CJFR9MSKz8oyZQuPACsbqTLHIiz4qBZopGtJY/7zneCK8L0M6PkeKIiUZCG0SkZFiOE7uYa9wUItEyFH8HB2iZMBa/fhMDb7p1ellvaAKunNS0f11g3tH95A15x/kLvuwNqZUgVmFkEYfs+IdYsZUcrjmWuJDOrnNyHcRnEbip/hWnCUyEwGOjGeapdI3CmAmrU0cl+4IEYwW9vCCMpy3p6WNDiz1KkPv4O9vN8Bfkr2q52tF3v0JRSVORpIQEix02GOTqm0QTOhKWy5IBgRz+W6ev2S+6k5HyMzJJr23w9rGx9Vccgd5iWHAd7t9lD8rNIZCzmQfrDrzkdXo/I3ojcIlMYnwAONimZu8zOMhIjuNsMpyvJODTKS9NilycJPQ76cTTuYeoPE8luCOPh/0J+X/d+kj/BX9kavulaTfgBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"search ui\"\n        title=\"search ui\"\n        src=\"/static/3cd9d9c34bd970955e4bf8457d819c03/5a190/search-ui-2.png\"\n        srcset=\"/static/3cd9d9c34bd970955e4bf8457d819c03/772e8/search-ui-2.png 200w,\n/static/3cd9d9c34bd970955e4bf8457d819c03/e17e5/search-ui-2.png 400w,\n/static/3cd9d9c34bd970955e4bf8457d819c03/5a190/search-ui-2.png 800w,\n/static/3cd9d9c34bd970955e4bf8457d819c03/c1b63/search-ui-2.png 1200w,\n/static/3cd9d9c34bd970955e4bf8457d819c03/b5dee/search-ui-2.png 1237w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>Step 1</h3>\n<p>A new <code>search-input</code> component is added in the top navigation bar. The user can enter a search term into the input box, and hit <kbd>Enter</kbd> when ready to search.</p>\n<h3>Step 2</h3>\n<p>The <code>search-input</code> will capture the value entered into the input box, and trigger navigation to the new search results page, passing along the <code>q</code> parameter which represents the search term.</p>\n<p>It's important to ensure that the <code>q</code> parameter becomes part of the search results page url, i.e. <code>/search-results?q=rails</code>. This is to support a user wanting to bookmark the search results page for a particular search term or wanting to share the url.</p>\n<h3>Step 3</h3>\n<p>The <code>search-results?q=rails</code> page will extract the search term value from the <code>q</code> parameter in the url (<code>rails</code> in this example). It will use this to execute a <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API\">fetch</a> request against the Rails server search endpoint (see <a href=\"../roll-your-own-search-service-for-gatsby-part4\">Part 4: Search API</a> for more details about the server side).</p>\n<p>The search results from the server get converted to a format expected by the existing <code>article-list</code> component, and passed in as props to that component. Then these results are rendered, including a \"Read\" link to the article whose <code>href</code> attribute is populated from the <code>slug</code> property of the search results.</p>\n<h2>Search Input</h2>\n<p>Now let's take a closer look at each UI component, starting with the new <code>search-input</code>, which is added to the top navigation bar.</p>\n<p>The input element has an <code>onKeyPress</code> event handler, which invokes a <code>search</code> function that checks if the <kbd>Enter</kbd> key has been pressed, and if so, navigates to the new <code>/search-results</code> page. This event handler has access to the current character code being entered via <code>event.charCode</code> and the complete value of the text entered in the input via <code>event.target.value</code>.</p>\n<p>Notice that the argument to the <code>onKeyPress</code> attribute of the <code>&#x3C;input></code> element is a function, <em>not</em> the invocation of the function. Also notice that the entire text value is passed to the <code>/search-results</code> page with a template string <code>/search-results/?q=${text}</code>.</p>\n<p>To navigate to a page programmatically, Gatsby provides the <a href=\"https://www.gatsbyjs.com/docs/reference/built-in-components/gatsby-link/#how-to-use-the-navigate-helper-function\">navigate</a> helper function.</p>\n<p>For the magnifying glass icon displayed in the search input, I'm using the <a href=\"https://github.com/react-icons/react-icons\">react-icons</a> library, specifically the <code>MdSearch</code> icon from Material Design. This project uses css modules for scoped styles.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/search-input.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;react&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { navigate } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;gatsby&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { MdSearch } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react-icons/md&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./search-input.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> ENTER_KEY_CODE </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">13</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SearchInput</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span><span class=\"mtk1\"> (</span><span class=\"mtk10 mtki\">charCode</span><span class=\"mtk1\">, </span><span class=\"mtk10 mtki\">text</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (charCode </span><span class=\"mtk7\">===</span><span class=\"mtk1\"> ENTER_KEY_CODE) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">navigate</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`/search-results/?q=</span><span class=\"mtk7\">${</span><span class=\"mtk1\">text</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.wrapper</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">MdSearch</span><span class=\"mtk1\"> </span><span class=\"mtk5\">size</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;1.7rem&quot;</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">input</span><span class=\"mtk1\"> </span><span class=\"mtk5\">type</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;text&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.search</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5\">aria-label</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Search&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5\">placeholder</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;Search, eg: Rails&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5\">onKeyPress</span><span class=\"mtk7\">={</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">event</span><span class=\"mtk1\">) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk5\">search</span><span class=\"mtk1\">(event.charCode, event.target.value)</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> SearchInput</span></span></span></code></pre>\n<p>Then the new <code>&#x3C;SearchInput></code> component is added to the existing <code>&#x3C;NavMenu></code> component, which renders the navigation links at the top right of the page:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/nav-menu.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./nav-menu.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> SearchInput </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./search-input&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">NavMenu</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk7\">nav</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.nav</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">ul</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.navList</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">li</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.headerItem</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/blog&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            Blog</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;/</span><span class=\"mtk7\">li</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">li</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.headerItem</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">=</span><span class=\"mtk6\">&quot;/about&quot;</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            About</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;/</span><span class=\"mtk7\">li</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">{</span><span class=\"mtk3\">/* NEW: SearchInput ADDED HERE */</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">li</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">styles.headerItem</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk9 mtki\">SearchInput</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;/</span><span class=\"mtk7\">li</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">ul</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk7\">nav</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> NavMenu</span></span></span></code></pre>\n<h2>Search Results</h2>\n<p>In Gatsby terms, this is a \"page\" rather than a component because it's the target of the router, and it lives in the <code>pages</code> project directory. But technically, it's still a React component. This page does all the heavy lifting of search so it's a little more involved than the <code>search-input</code> component.</p>\n<h3>Parse Query</h3>\n<p>The first challenge is to extract the <code>q</code> parameter from the url to this page, which represents the search term. For example, if this page gets called with <code>/search-results?q=rails</code>, then it needs to set a variable <code>searchTerm</code> to the value \"rails\".</p>\n<p>Surprisingly, I found this wasn't possible with the Gatsby router, which is basically a wrapper around <a href=\"https://github.com/reach/router\">reach-router</a>. I had to bring in the <a href=\"https://github.com/sindresorhus/query-string\">query-string</a> library to parse the query portion of the url.</p>\n<p>Here is just the first snippet of the component to parse <code>searchTerm</code> out of the url using the <code>useLocation</code> hook provided by the <code>reach-router</code> and the <code>parse</code> method of the <code>query-string</code> library. Note that <code>location.search</code> refers to the <code>search</code> property of the <code>location</code> object returned by the <code>useLocation()</code> hook, not to be confused with the actual search term in the url. The <code>search</code> property of the <code>location</code> object refers to any portion of the url string after and including the <code>?</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/pages/search-results.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { useLocation } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;@reach/router&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> queryString </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;query-string&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Example: Called with `/search-results?q=rails</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SearchResults</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> location </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useLocation</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> queryString.</span><span class=\"mtk5\">parse</span><span class=\"mtk1\">(location.search);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> searchTerm </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> query.q</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// location.search = &quot;?q=rails&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// query = {q: &quot;rails&quot;}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// searchTerm = &quot;rails&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      TBD...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> SearchResults;</span></span></span></code></pre>\n<p>The <code>&#x3C;Layout></code> component in the returned JSX is a wrapper or \"box\" component for every page on this site. It uses <code>props.children</code> to render any content that it's given between the <code>&#x3C;Header></code> and <code>&#x3C;Footer></code> components (also existing components, details not important for search feature). Using it in the <code>SearchResults</code> page ensures it will have the same look and feel as every other page on this site:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/components/layout.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./layout.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Header </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./header.js&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Footer </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./footer.js&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> ({ </span><span class=\"mtk10 mtki\">children</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Header</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.content</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">children</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Footer</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<h3>Fetch Results</h3>\n<p>The next step is to fetch search results from the server for the <code>searchTerm</code> that was parsed out of the url. Since fetching data is considered a side effect, this code goes in a <a href=\"https://reactjs.org/docs/hooks-effect.html\">useEffect</a> hook.</p>\n<p>Fetching the data will require an <code>async/await</code> function. When combining <code>async/await</code> with the <code>useEffect</code> hook in React, it's necessary to define the <code>async</code> function and invoke it directly in the hook. This gets a little messy so the actual function to get results from the server <code>getSearchResults</code> will be defined outside, and a smaller function that simply wraps this <code>fetchData</code> will be defined inside the <code>useEffect</code> hook.</p>\n<p>I'm using the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API\">Fetch API</a> to get results from the search server.</p>\n<p>Finally, to make use of the search results for rendering into the DOM, they'll need to be in state, so let's bring in the <code>useState</code> hook for that.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/pages/search-results.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React, { useEffect, useState } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { useLocation } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;@reach/router&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> queryString </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;query-string&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SearchResults</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Parse query from URL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> location </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useLocation</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> queryString.</span><span class=\"mtk5\">parse</span><span class=\"mtk1\">(location.search);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> searchTerm </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> query.q</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// For saving search results in state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> [list, setList] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useState</span><span class=\"mtk1\">([]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// This function will be called from within the useEffect hook.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">getSearchResults</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">query</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> json </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fetch</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`https://prod.rails.host/search?q=</span><span class=\"mtk7\">${</span><span class=\"mtk1\">query</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      method: </span><span class=\"mtk6\">&#39;GET&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      headers: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;application/json&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (response.ok) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      json </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> response.</span><span class=\"mtk5\">json</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> json;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">useEffect</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// fetchData is simply a wrapper around getSearchResults.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// This is needed due to how React handles async functions within useEffect hook.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// `searchTerm` is what was parsed out of the URL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// eg: `rails` for url `/search-results?q=rails`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fetchData</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> searchResults </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">getSearchResults</span><span class=\"mtk1\">(searchTerm);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Save searchResults in state so they can be used for rendering</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">setList</span><span class=\"mtk1\">(searchResults);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Call the wrapper function directly within the useEffect hook.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">fetchData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }, [searchTerm]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      TBD...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> SearchResults;</span></span></span></code></pre>\n<h3>Render Results</h3>\n<p>Now that the search results have been retrieved from the server, they need to be rendered. One way to do this would be to iterate over the search results in the JSX that's returned by the <code>SearchResults</code> component and generate a few simple DOM nodes populated from each <code>searchResult</code> field. Something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/pages/search-results.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React, { useEffect } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;gatsby&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { useLocation } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;@reach/router&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> queryString </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;query-string&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SearchResults</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk3\">/* The `list` variable in state has array of searchResults */</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">{</span><span class=\"mtk1\">list.</span><span class=\"mtk5\">map</span><span class=\"mtk1\">((</span><span class=\"mtk10 mtki\">searchResult</span><span class=\"mtk1\">) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">article</span><span class=\"mtk1\"> </span><span class=\"mtk5\">key</span><span class=\"mtk7\">={</span><span class=\"mtk1\">searchResult.id</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">searchResult.published_at</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">searchResult.title</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">searchResult.category</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">searchResult.excerpt</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          &lt;</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to</span><span class=\"mtk7\">={</span><span class=\"mtk1\">searchResult.slug</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;Read&lt;/</span><span class=\"mtk9 mtki\">Link</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;/</span><span class=\"mtk7\">article</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ))</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> SearchResults;</span></span></span></code></pre>\n<p>However, this site already has an <code>&#x3C;ArticleList></code> component that is used to display a list of articles such as on the home page or on the paginated blog pages. To maintain a similar look and feel, I wanted to re-use it to display search results.</p>\n<p>Here is what the <code>&#x3C;ArticleList></code> component looks like:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ef668c37a9ef5f809f9d2a4872136ce8/e8d6f/search-fields.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.46190102120974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABeklEQVQoz2VS2XarMAzM//9e05ZAaNobkrAZ450lZK5k0nR7mCNb4NGMpE1wA3qhoIWFES7C2wGDHyP4+3VasMy3B/g+j9c/4PxGtj2S7Q7Za47kKcVum2H3nGKf5Dhk7xFcUEn9ABda5uVe6AtMuvFuQlMpmN6h7wyk4EeWzjoqncJMKkkpnT/jSLl5uBLxDKMCtPSwenWyGfyE8tShPiq0hYY4GdSFQXnUaM+eEP6giXmP5mLxkTeoL4qKTSsh20lfU2TJHulLFsF2OX7kBS5HQQ971GeJsuAzFb54iDKgqxyKdwHVedyut7tlki0astpqVOeOCNoYK1JdnloikLD9CCPJWhcoDgS6U47zsnUY7upWQupJW3WQtaZeODgdYu+c5r54aOqtVZ5+piGMNOFxieeJerhifkw4EkqxTjnZpkie2XqOfPdGU99H62/ZAf8OR/A2cHs4GmUjwXc81sbZCT0p88ZHVasy3sXwY/dYSURY4+9d/Lz/B2Kyr21GuoleAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"search fields\"\n        title=\"search fields\"\n        src=\"/static/ef668c37a9ef5f809f9d2a4872136ce8/5a190/search-fields.png\"\n        srcset=\"/static/ef668c37a9ef5f809f9d2a4872136ce8/772e8/search-fields.png 200w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/e17e5/search-fields.png 400w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/5a190/search-fields.png 800w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/c1b63/search-fields.png 1200w,\n/static/ef668c37a9ef5f809f9d2a4872136ce8/e8d6f/search-fields.png 1273w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This component expects a single prop <code>articles</code>. During the Gatsby build process, the <code>articles</code> prop is populated with a list of \"nodes\", which are objects generated from the <code>gatsby-transformer-remark</code> plugin. These contain the metadata from the markdown content of each blog post (title, publish date, etc.).</p>\n<p>The <code>&#x3C;ArticleList></code> component iterates over the <code>articles</code> prop, and renders an <code>&#x3C;Article></code> component for each node. Here is what an <code>&#x3C;Article></code> component looks like, a single entry in the <code>ArticleList</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f014ed6a8678b50057c72057f4d63d97/cff1a/search-article.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.600341102899375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAmklEQVQI10WM2Q6CMBBF/f8PdMFCIjFQujmFlh2vQzH6cHJnyT2n4HvIp4OtuoM6wDBWBpCZQHr84Xl3KqIsDMrc4CF0Sqs6rPOGZVpx0tIgO2e4X0RCXAuIW8FzjqpUMA1xwUPV7pibwHeX2EUdDYjt+BcS9dDSw+mWk7jkYb6pKof21XNhQvADMybIRJCN6TcPC7b1nWS79AMCDeLBNnKBkAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"search article\"\n        title=\"search article\"\n        src=\"/static/f014ed6a8678b50057c72057f4d63d97/5a190/search-article.png\"\n        srcset=\"/static/f014ed6a8678b50057c72057f4d63d97/772e8/search-article.png 200w,\n/static/f014ed6a8678b50057c72057f4d63d97/e17e5/search-article.png 400w,\n/static/f014ed6a8678b50057c72057f4d63d97/5a190/search-article.png 800w,\n/static/f014ed6a8678b50057c72057f4d63d97/c1b63/search-article.png 1200w,\n/static/f014ed6a8678b50057c72057f4d63d97/29007/search-article.png 1600w,\n/static/f014ed6a8678b50057c72057f4d63d97/cff1a/search-article.png 1759w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The code for the <code>ArticleList</code> component:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./article-list.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Article </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./article&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">props</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;</span><span class=\"mtk7\">section</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">{</span><span class=\"mtk1\">props.articles.</span><span class=\"mtk5\">map</span><span class=\"mtk1\">(({ </span><span class=\"mtk10 mtki\">node</span><span class=\"mtk1\"> }) </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk9 mtki\">Article</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">key</span><span class=\"mtk7\">={</span><span class=\"mtk1\">node.id</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">id</span><span class=\"mtk7\">={</span><span class=\"mtk1\">node.id</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">to</span><span class=\"mtk7\">={</span><span class=\"mtk1\">node.fields.slug</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">title</span><span class=\"mtk7\">={</span><span class=\"mtk1\">node.frontmatter.title</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">category</span><span class=\"mtk7\">={</span><span class=\"mtk1\">node.frontmatter.category</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">date</span><span class=\"mtk7\">={</span><span class=\"mtk1\">node.frontmatter.date</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5\">excerpt</span><span class=\"mtk7\">={</span><span class=\"mtk1\">node.excerpt</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ))</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &lt;/</span><span class=\"mtk7\">section</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>One really cool thing about Gatsby is the same components can be re-used for dynamic content as well. All that's needed is to convert the search results from the search service into \"node\" objects expected by the <code>&#x3C;ArticleList></code> component, pass that in as the <code>articles</code> prop, and it will render dynamically.</p>\n<p>In order to do that, a new function <code>toNodeArray</code> is added which converts the array of <code>searchResults</code> to an array of <code>nodes</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/pages/search-results.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React, { useEffect, useState } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { useLocation } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;@reach/router&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> queryString </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;query-string&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> ArticleList </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/article-list&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./search-results.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SearchResults</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Parse searchTerm out of url</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> location </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useLocation</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> queryString.</span><span class=\"mtk5\">parse</span><span class=\"mtk1\">(location.search);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> searchTerm </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> query.q</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Used for saving search results within this component</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> [list, setList] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useState</span><span class=\"mtk1\">([]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">getSearchResults</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">query</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// snip...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Convert search results from search service to a format expected by ArticleList</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">toNodeArray</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">searchResults</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> searchResults.</span><span class=\"mtk5\">map</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">sr</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        node: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          excerpt: sr.excerpt,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          fields: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            slug: sr.slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          frontmatter: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            category: sr.category,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            date: sr.published_at,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            title: sr.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          id: sr.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">useEffect</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fetchData</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> searchResults </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">getSearchResults</span><span class=\"mtk1\">(searchTerm);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Save search results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">setList</span><span class=\"mtk1\">(searchResults);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">fetchData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }, [searchTerm]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.header</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;Search Results For: </span><span class=\"mtk7\">{</span><span class=\"mtk1\">query.q</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">{</span><span class=\"mtk3\">/* Pass in converted searchResults to ArticleList component */</span><span class=\"mtk7\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">ArticleList</span><span class=\"mtk1\"> </span><span class=\"mtk5\">articles</span><span class=\"mtk7\">={</span><span class=\"mtk5\">toNodeArray</span><span class=\"mtk1\">(list)</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> SearchResults;</span></span></span></code></pre>\n<p>And that's it, now the search results are displayed!</p>\n<p>Here's an example of search results display for <code>rails</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f66bc789a7cd12c486dc6ce161b863e4/1b1d5/search-results-example.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.74885844748859%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/ElEQVQ4y3WU63KjMAyFef+n6+xssw0kBDZAAuFi7iRcTn1kSLOd7Y8zkh1jSZ/kWF3TQ+UlyrxCWRjdrim6usf0mDHepx+1/U67yRraO+qyQVt36KoB93bEYxgxjwswA8u0ajba9n4KYmW3AocPF6eDj9C7IjhFSC43BH6E6HxBHCXrOkT4N0LghbJmwO+SDPNbjqPtap1Ezp8DbK3drw/YuwNcx4PvniXgSfvHvSvB0jiTi2nj1TZVB6sqe8TXAipTyPTlzChNchSpEkvG/yuNWO79A4/+y0rJQz+jawl2wvwwjLCswrf16m8MX5vxbApL9o4+zl6A4KiZhTfJlJ1OLinytBCfyhJTQVXUcvk8Lc+mkaFpSpIJNzJynZMwIrf9uyP79O2dI/s8Q0umKitlxAptc93YVvOTDEvVwnNDXMNYK3l2l5Zd3XQJrvLR0N01/Fay5LjRUmRt5lAz7Aed+ki9MJv/5beVxY9kTCYzKsu0+WbIrVK/kjiKpe1pqFBmtWTQN4NErRQzaeWwXDjOX3P36q+vxiJoMiKXw/4IT3Pav9vad2Xgyez3204CsmTOmpSqA/F10W90wGfJStfvuYF02bCK5XIy41q675vXwUaotQmcU/p8afwfqFVjLmyaEarUb1jD7ttBoG/21Wc5G0czKsvT38rmmU+h0C5qmchknAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"search results example\"\n        title=\"search results example\"\n        src=\"/static/f66bc789a7cd12c486dc6ce161b863e4/5a190/search-results-example.png\"\n        srcset=\"/static/f66bc789a7cd12c486dc6ce161b863e4/772e8/search-results-example.png 200w,\n/static/f66bc789a7cd12c486dc6ce161b863e4/e17e5/search-results-example.png 400w,\n/static/f66bc789a7cd12c486dc6ce161b863e4/5a190/search-results-example.png 800w,\n/static/f66bc789a7cd12c486dc6ce161b863e4/1b1d5/search-results-example.png 876w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>Refactor: Search Service</h3>\n<p>The <code>SearchResults</code> component is getting a little messy having too much logic in it. It can be cleaned up by extracting the <code>getSearchResults</code> and <code>toNodeArray</code> functions into a search service module.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/services/search.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">getSearchResults</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">query</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> json </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fetch</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`https://prod.rails.host/search?q=</span><span class=\"mtk7\">${</span><span class=\"mtk1\">query</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    method: </span><span class=\"mtk6\">&#39;GET&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    headers: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;application/json&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (response.ok) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    json </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> response.</span><span class=\"mtk5\">json</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> json;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">toNodeArray</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">searchResults</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> searchResults.</span><span class=\"mtk5\">map</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">sr</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      node: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        excerpt: sr.excerpt,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fields: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          slug: sr.slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        frontmatter: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          category: sr.category,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          date: sr.published_at,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          title: sr.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        id: sr.title</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And now this function can be used in the search results component with less clutter:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/pages/search-results.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> React, { useEffect, useState } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;react&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { Link } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;gatsby&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { useLocation } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;@reach/router&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> queryString </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;query-string&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Use utility functions from a service to avoid cluttering up this component</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> { getSearchResults, toNodeArray } </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;../services/search&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> Layout </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/layout&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> ArticleList </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;../components/article-list&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> styles </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;./search-results.module.css&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> </span><span class=\"mtk5\">SearchResults</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> () </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> location </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useLocation</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> query </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> queryString.</span><span class=\"mtk5\">parse</span><span class=\"mtk1\">(location.search);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> searchTerm </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> query.q</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> [list, setList] </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">useState</span><span class=\"mtk1\">([]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">useEffect</span><span class=\"mtk1\">(() </span><span class=\"mtk9 mtki\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fetchData</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> searchResults </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">getSearchResults</span><span class=\"mtk1\">(searchTerm);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5\">setList</span><span class=\"mtk1\">(searchResults);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5\">fetchData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }, [searchTerm]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk7\">div</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.container</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk7\">h2</span><span class=\"mtk1\"> </span><span class=\"mtk5\">className</span><span class=\"mtk7\">={</span><span class=\"mtk1\">styles.header</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&gt;Search Results For: </span><span class=\"mtk7\">{</span><span class=\"mtk1\">query.q</span><span class=\"mtk7\">}</span><span class=\"mtk1\">&lt;/</span><span class=\"mtk7\">h2</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;</span><span class=\"mtk9 mtki\">ArticleList</span><span class=\"mtk1\"> </span><span class=\"mtk5\">articles</span><span class=\"mtk7\">={</span><span class=\"mtk5\">toNodeArray</span><span class=\"mtk1\">(list)</span><span class=\"mtk7\">}</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;/</span><span class=\"mtk7\">div</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk9 mtki\">Layout</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">default</span><span class=\"mtk1\"> SearchResults;</span></span></span></code></pre>\n<h3>Refactor: Search URL</h3>\n<p>Another issue is that the search URL is currently hard-coded to the production Rails host:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/services/search.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">getSearchResults</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">query</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> json </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// HARD-CODED URL HERE!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fetch</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`https://prod.rails.host/search?q=</span><span class=\"mtk7\">${</span><span class=\"mtk1\">query</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    method: </span><span class=\"mtk6\">&#39;GET&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    headers: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;application/json&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span></span></span></code></pre>\n<p>Given that the Rails server is CORS enabled, (see <a href=\"../roll-your-own-search-service-for-gatsby-part4\">Part 4: Search Service</a> for more details), the production server will not accept requests from <code>localhost</code>.</p>\n<p>Ideally for development, the search server runs locally and the Gatsby site points to the local version of the search url. And when the Gatsby site is deployed, it points to the production version of the search url. This can be achieved with environment variables.</p>\n<p>Even though Gatsby is a static site generator, environment variables can be used at build time and referenced via <code>process.env.SOME_VAR</code>. This is done via the <a href=\"https://www.npmjs.com/package/dotenv\">dotenv</a> package which comes with Gatsby. To enable it, add the following at the beginning of <code>gatsby-config.js</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// gatsby-config.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">require</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;dotenv&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk5\">config</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  path: </span><span class=\"mtk6\">`.env.</span><span class=\"mtk7\">${</span><span class=\"mtk1\">process.env.NODE_ENV</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">...</span></span></span></code></pre>\n<p>This will load any files in the project root starting with <code>.env...</code> and matching the node environment.</p>\n<p>Then add the dotenv files for development and production in the project root (replacing the production value with wherever the Rails server is hosted):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"># .env.development</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SEARCH_URL=http://localhost:3000/search</span></span></code></pre>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"># .env.production</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SEARCH_URL=https://prod.rails.host/search</span></span></code></pre>\n<p>Finally, go back to the code that fetches search results and replace the hard-coded url with <code>process.env.SEARCH_URL</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"js\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/services/search.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">export</span><span class=\"mtk1\"> </span><span class=\"mtk7\">async</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">function</span><span class=\"mtk1\"> </span><span class=\"mtk5\">getSearchResults</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">query</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">let</span><span class=\"mtk1\"> json </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// USE ENVIRONMENT VARIABLE FOR SEARCH SERVER URL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">const</span><span class=\"mtk1\"> response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">await</span><span class=\"mtk1\"> </span><span class=\"mtk5\">fetch</span><span class=\"mtk1\">(</span><span class=\"mtk6\">`</span><span class=\"mtk7\">${</span><span class=\"mtk1\">process.env.SEARCH_URL</span><span class=\"mtk7\">}</span><span class=\"mtk6\">?q=</span><span class=\"mtk7\">${</span><span class=\"mtk1\">query</span><span class=\"mtk7\">}</span><span class=\"mtk6\">`</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    method: </span><span class=\"mtk6\">&#39;GET&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    headers: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">&#39;Accept&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk6\">&#39;application/json&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">...</span></span></span></code></pre>\n<p>Now when running Gatsby in development mode <code>gatsby develop -H 0.0.0.0</code>, it will use the <code>localhost</code> search url specified in <code>.env.development</code>. And when the Gatsby build is run for production <code>gatsby build</code>, it will use the production search url specified in <code>.env.production</code>.</p>\n<h2>Conclusion</h2>\n<p>This concludes the multi-part series on rolling your own search service for a static site. If you've been following from the beginning, <a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> introduced the challenge of adding a dynamic feature like search to a static site, listed a few existing options and some problems with them, and suggested an alternate idea to use PostgreSQL and Rails to solve the problem.</p>\n<p><a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> covered how to build a search index from the markdown content on the Gatsby site. <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> gave an introduction to PostgreSQL full text search and terminology used in it such as <code>to_tsvector</code> and <code>to_tsquery</code>. <a href=\"../roll-your-own-search-service-for-gatsby-part4\">Part 4: Search API</a> covered how to build a simple search API with Rails and PostgreSQL full text search.</p>\n<p>Finally this last part covered how to build a search UI for a Gatsby site and how to tie it all together with the Rails search service.</p>\n<p>I just want to point out that this may not be an optimal solution for every static site that requires a search feature. It was a lot of work and now requires some maintenance in populating the search index whenever a new article is published. For some sites, using a paid service like <a href=\"https://www.algolia.com/\">Algolia</a> or <a href=\"https://www.elastic.co/subscriptions/cloud\">Managed Elasticsearch</a> may be a perfectly good option.</p>\n<p>However, it was a lot of fun and a good learning experience putting all this together. If you enjoy building things, definitely give it a try.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part5/"}}},{"node":{"id":"18acec04-4600-5e8a-9b17-3c907b9b3846","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search API","date":"July 2021","category":"Rails"},"excerpt":"This is the fourth in a multi-part series of posts detailing how I built the search feature for this blog. This post will explain how toâ€¦","html":"<p>This is the fourth in a multi-part series of posts detailing how I built the search feature for this blog. This post will explain how to build a search API with Rails, using the <a href=\"https://github.com/Casecommons/pg_search\">pg-search</a> gem and how to deploy it to production.</p>\n<p>In case you missed it, <a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> of this series covers the existing options for adding search to a Gatsby site, and why I decided not to use any of them, and instead build a custom search service. <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> covers the design and population of the <code>documents</code> table that contains all the content to be searched. <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> provides an introduction to PostgreSQL Full Text Search, showing some examples of using it to write queries to search against a documents table.</p>\n<h2>Install</h2>\n<p>First step is to add the <code>pg-search</code> gem to the <code>Gemfile</code> and run <code>bundle install</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Postgres Full Text Search</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gem </span><span class=\"mtk6\">&#39;pg_search&#39;</span></span></span></code></pre>\n<h2>Model</h2>\n<p>Next step is to add a search scope to the <code>Document</code> model. This model and the population of the underlying <code>documents</code> table was covered in <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a>. As a quick reminder, here are a few rows from this table, <code>body</code> column shortened for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hello=&gt; select title, category, slug, left(body, 40) as body from documents;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                               title                                |     category     |                          slug                           |                   body</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------------------------------------------------------------+------------------+---------------------------------------------------------+------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Add a Language to gatsby-remark-vscode                             | web development  | /blog/add-language-gatsby-remark-vscode/                |  This blog is built with [Gatsby](https:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> A VS Code Alternative to Postman                                   | Web Development  | /blog/postman-alternative-vscode/                       |  If youve been doing web development for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails CORS Middleware For Multiple Resources                       | rails            | /blog/rails-cors-middleware-multiple/                   |  A short post for today on a usage of [C</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                                       | javascript       | /blog/tdd-by-example-bugfix/                            |  This post will demonstrate an example o</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Saving on monthly expenses - A Cautionary Tale                     | personal finance | /blog/save-monthly-expense-caution/                     |  Today I want to share a cautionary tale</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails Blocked Host Solved by Docker Cleanup                        | rails            | /blog/rails-blocked-host-docker-clean/                  |  Today I want to share a debugging story</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ...</span></span></code></pre>\n<p>And here is the current model class:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p><code>pg_search_scope</code> from the <code>pg_search</code> gem is used to define a method on the model class that will execute a full text search against the <code>documents</code> table. It accepts a hash of options, of which the <code>against</code> property is required, to specify an array of fields to be searched. The <code>PgSearch::Model</code> module must also be included in the model. For example, to search the  <code>body</code> field:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  pg_search_scope </span><span class=\"mtk4\">:search_doc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[body]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>To see this in action, open a Rails console with <code>bin/rails c</code> and run the <code>search_doc</code> method on the <code>Documents</code> model for search term <code>tdd</code>.</p>\n<p>I've inserted some line breaks in the query that the gem generated and the results for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">003</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search_doc(</span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Document Load (</span><span class=\"mtk4\">138</span><span class=\"mtk1\">.8ms)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  INNER JOIN (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> AS pg_search_id,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (ts_rank((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))), (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)), </span><span class=\"mtk4\">0</span><span class=\"mtk1\">)) AS rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    WHERE ((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))) @@ (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)))) AS pg_search_9b16b44d0e0a5cac4f968b</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ON </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> pg_search_9b16b44d0e0a5cac4f968b.pg_search_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ORDER BY pg_search_9b16b44d0e0a5cac4f968b.rank DESC, </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> ASC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  LIMIT $1  [[</span><span class=\"mtk6\">&quot;LIMIT&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">11</span><span class=\"mtk1\">]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">=&gt; </span><span class=\"mtk3\">#&lt;ActiveRecord::Relation [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#&lt;Document id: 15, title: &quot;TDD by Example&quot;, description: &quot;A practical example of using TDD to add a new feat...&quot;, category: &quot;javascript&quot;, published_at: &quot;2021-01-02&quot;, slug: &quot;/blog/tdd-by-example/&quot;, body: &quot; If youve been coding for any length of time, youv...&quot;, created_at: &quot;2021-06-26 19:18:51&quot;, updated_at: &quot;2021-06-26 19:18:51&quot;, excerpt: &quot;If youve been coding for any length of time, youve...&quot;&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#&lt;Document id: 6, title: &quot;TDD by Example: Fixing a Bug&quot;, description: &quot;A practical example of using TDD to fix a bug and ...&quot;, category: &quot;javascript&quot;, published_at: &quot;2021-05-16&quot;, slug: &quot;/blog/tdd-by-example-bugfix/&quot;, body: &quot; This post will demonstrate an example of using TD...&quot;, created_at: &quot;2021-06-26 19:18:51&quot;, updated_at: &quot;2021-06-26 19:18:51&quot;, excerpt: &quot;This post will demonstrate an example of using TDD...&quot;&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">#&lt;Document id: 12, title: &quot;Solving a Python Interview Question in Ruby&quot;, description: &quot;Learn how to model tuples in Ruby and solve a Pyth...&quot;, category: &quot;ruby&quot;, published_at: &quot;2021-03-01&quot;, slug: &quot;/blog/python-interview-question-in-ruby/&quot;, body: &quot; A few months ago, I came across a tweet posing a ...&quot;, created_at: &quot;2021-06-26 19:18:51&quot;, updated_at: &quot;2021-06-26 19:18:51&quot;, excerpt: &quot;A few months ago, I came across a tweet posing a t...&quot;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ]</span><span class=\"mtk7\">&gt;</span></span></span></code></pre>\n<p>The <code>ts_vector</code>, <code>ts_query</code>, and <code>ts_rank</code> Postgres functions were covered in <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> of this series. As a reminder, here was the query to search the documents <code>body</code> field for the search term <code>tdd</code> and order results by descending rank:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk7\">as</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ORDER BY</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span><span class=\"mtk1\"> </span><span class=\"mtk7\">DESC</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Adding the <code>pg_search_scope</code> to the model enabled executing a full text search against PostgreSQL, without having to write this query in the model. The generated query also uses the PostgreSQL <code>coalesce</code> function which returns the first non null value from its given list of arguments. This is to ensure that a null value will not get passed to the ts_vector function. For example <code>coalesce(\"documents\".\"body\"::text, '')</code> will return an empty string if it encounters a null <code>body</code> field in the <code>documents</code> table.</p>\n<p>Also note the generated query returns a max of 11 results, as set by the <code>LIMIT</code> option.</p>\n<p>The result of the generated <code>search_doc</code> function is an <code>ActiveRecord::Relation</code>, representing the list of <code>Document</code> model results that match the query. In this example, the first two are articles explicitly on TDD, and the last is an article about solving an interview question, in which the TDD approach is used. These are the same results we saw when running the simpler version of the query against using the <code>psql</code> client in <a href=\"../roll-your-own-search-service-for-gatsby-part3\">Part 3: Search Engine</a> of this series.</p>\n<p>The gem also supports searching by multiple fields. For example, to search by <code>body</code>, and <code>title</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  pg_search_scope </span><span class=\"mtk4\">:search_doc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[body title]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now the generated query includes both <code>documents.body</code> and <code>documents.title</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">irb(main):</span><span class=\"mtk4\">007</span><span class=\"mtk1\">:</span><span class=\"mtk4\">0</span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search_doc(</span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Document Load (</span><span class=\"mtk4\">131</span><span class=\"mtk1\">.1ms)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk7\">*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">INNER JOIN (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  SELECT </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> AS pg_search_id,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (ts_rank((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;title&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)) </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))), (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)), </span><span class=\"mtk4\">0</span><span class=\"mtk1\">)) AS rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  FROM </span><span class=\"mtk6\">&quot;documents&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  WHERE ((to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;title&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">)) </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, coalesce(</span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;body&quot;</span><span class=\"mtk1\">::text, </span><span class=\"mtk6\">&#39;&#39;</span><span class=\"mtk1\">))) @@ (to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;&#39;&#39; &#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;tdd&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39; &#39;&#39;&#39;</span><span class=\"mtk1\">)))) AS pg_search_9b16b44d0e0a5cac4f968b</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ON </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> pg_search_9b16b44d0e0a5cac4f968b.pg_search_id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ORDER BY pg_search_9b16b44d0e0a5cac4f968b.rank DESC, </span><span class=\"mtk6\">&quot;documents&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\"> ASC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">LIMIT $1  [[</span><span class=\"mtk6\">&quot;LIMIT&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">11</span><span class=\"mtk1\">]]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Results are the same as before for this example</span></span></span></code></pre>\n<p>For my blog search, this is all I need from the <code>pg-search</code> gem. However, I've barely scratched the surface of all the available features, see the <a href=\"https://github.com/Casecommons/pg_search\">docs</a> if you need more features.</p>\n<h2>Route and Controller</h2>\n<p>It's great that there's an easy way to search the <code>Document</code> model, but recall the goal of this exercise is to build a search API accessible over HTTP so that the Gatsby blog can make use of it. This will require exposing a route such as <code>GET /search?q=foo</code> and a controller to handle this route, delegating the heavy lifting of search to the <code>Document</code> model.</p>\n<p>Starting with the route. This will be read only so only exposing the <code>index</code> method:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/routes.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.routes.draw </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  resources </span><span class=\"mtk4\">:search</span><span class=\"mtk1\">, </span><span class=\"mtk4\">only:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[index]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Since the resource is named <code>search</code>, Rails will expect a search controller with an <code>index</code> method. This will only be used for an HTTP API so it only returns json:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/controllers/search_controller.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">SearchController</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    q </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> params[</span><span class=\"mtk4\">:q</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    respond_to </span><span class=\"mtk7\">do</span><span class=\"mtk1\"> |</span><span class=\"mtk9\">format</span><span class=\"mtk1\">|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9\">format</span><span class=\"mtk1\">.json { render </span><span class=\"mtk4\">json:</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search(q) }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>What is this method <code>Document.search</code>? Recall earlier when hooking up the <code>pg_search</code> gem to the <code>Document</code> model, we defined a search scope of <code>search_doc</code>. However, this won't be suitable for calling directly from the API because that would expose <em>all</em> fields from the Document model including the <code>body</code> field, primary id and auto generated timestamps. These aren't necessary for the API results.</p>\n<p>The <code>body</code> field specifically is huge and unnecessary because the blog contains the actual article content. It only needs the slug returned in API results to generate a link to the article.</p>\n<p>So I've added a new <code>search</code> method on the <code>Document</code> model to wrap the call to <code>search_doc</code> and convert the results to an api format that limits the returned fields:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># app/models/document.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">Document</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki mtku\">ApplicationRecord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">include</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">PgSearch</span><span class=\"mtk1\">::Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  pg_search_scope </span><span class=\"mtk4\">:search_doc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4\">against:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[title body]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:title</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">uniqueness:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  validates </span><span class=\"mtk4\">:body</span><span class=\"mtk1\">, </span><span class=\"mtk4\">presence:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\"># NEW METHOD:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#   1. Wrap call to search_doc generated by pg_search gem.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">#   2. Convert results to limit which fields are returned.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">self.search</span><span class=\"mtk1\">(</span><span class=\"mtk10 mtki\">query</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    docs </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">Document</span><span class=\"mtk1\">.search_doc(query)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    docs.map(</span><span class=\"mtk7\">&amp;</span><span class=\"mtk4\">:to_api</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">def</span><span class=\"mtk1\"> </span><span class=\"mtk5\">to_api</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">title:</span><span class=\"mtk1\"> title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">description:</span><span class=\"mtk1\"> description,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">category:</span><span class=\"mtk1\"> category,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">published_at:</span><span class=\"mtk1\"> published_at,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">slug:</span><span class=\"mtk1\"> slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">excerpt:</span><span class=\"mtk1\"> excerpt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<p>Now that the route and controller are in place, run <code>bin/rails routes</code> to verify the route is available:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ bin/rails routes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Prefix        Verb   URI Pattern                   Controller#Action</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">search_index  GET    /search(.:format)             search#index</span></span></code></pre>\n<h2>API</h2>\n<p>To see the search route in action, we'll create a <code>search.http</code> file and use a VS Code REST client extension to execute some search requests. I've written about this <a href=\"../postman-alternative-vscode\">useful extension</a> before.</p>\n<p>Start by defining the <code>host</code> variable as a rest-client environment variable in a project-specific <code>settings.json</code> file:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"json\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// .vscode/settings.json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtki\">&quot;rest-client.environmentVariables&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;local&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;host&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;http://localhost:3000&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;production&quot;</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk9 mtki\">&quot;host&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;https://prod-host.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Then create an http file to contain all the search requests, let's start with just one request to search for <code>tdd</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># http/search.http</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=tdd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span></code></pre>\n<p>Hit <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>E</kbd> to select the <code>local</code> environment from the environment selector that pops up.</p>\n<p>Then hit <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>R</kbd> while the cursor is anywhere on the <code>GET</code> request line to run it.</p>\n<p>A new editor tab will open up in a side-by-side view with the results of executing the search request against the local Rails server. Here are the results. These are the same three articles we saw before when invoking the <code>search_doc</code> method on the <code>Document</code> model, but this time, only the API fields are returned.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">HTTP/1.1 200 OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Content-Type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json; charset=utf-8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;TDD by Example&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A practical example of using TDD to add a new feature to an existing project.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;javascript&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-01-02&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/tdd-by-example/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;If youve been coding for any length of time, youve probably heard that you should test your code, and by that I mean writing automatedâ€¦&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;TDD by Example: Fixing a Bug&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A practical example of using TDD to fix a bug and do some refactoring on an existing project.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;javascript&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-05-16&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/tdd-by-example-bugfix/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;This post will demonstrate an example of using TDD (test driven development) to fix a bug on an existing project. If youre not familiarâ€¦&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;title&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Solving a Python Interview Question in Ruby&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;description&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;Learn how to model tuples in Ruby and solve a Python data science interview question in Ruby.&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;category&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;ruby&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;published_at&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;2021-03-01&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;slug&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;/blog/python-interview-question-in-ruby/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9 mtki\">&quot;excerpt&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk12\">&quot;A few months ago, I came across a tweet posing a technical interview question for a data science position using Python:  Lets set aside forâ€¦&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span></code></pre>\n<p>To add more search examples to the http file, separate them with <code>###</code>. For example, to see how it behaves when no results are found:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">```http</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># http/search.http</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Example request that returns results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=tdd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">###</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Example request when no results found</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">GET</span><span class=\"mtk1\"> {{host}}/search?q=zzzzzzzzz</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Accept:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json</span></span></span></code></pre>\n<p>Running the search for <code>zzzzzzzzz</code> returns an empty array because no documents match this search term:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"http\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">HTTP/1.1 200 OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Content-Type:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">application/json; charset=utf-8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[]</span></span></span></code></pre>\n<h2>Automated Tests</h2>\n<p>This article is getting quite lengthy, so rather than going over the document and search request tests in detail, here are the links to the RSpec test files for these:</p>\n<ul>\n<li><a href=\"https://github.com/danielabar/hello-visitor/blob/main/spec/models/document_spec.rb\">Document Model Tests</a></li>\n<li><a href=\"https://github.com/danielabar/hello-visitor/blob/main/spec/requests/search_spec.rb\">Search Request Tests</a></li>\n</ul>\n<h2>CORS</h2>\n<p>The last thing that is needed for the search feature is to enable <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS\">CORS</a> because the blog that needs to make requests to the search service is hosted on a different server (Github Pages) than the Rails search service (Heroku). In Rails, this can be configured using the <code>rack-cors</code> middleware. See an earlier <a href=\"../rails-cors-middleware-multiple\">article</a> I wrote about this for more details.</p>\n<p>Here is the configuration. <code>ALLOWED_ORIGIN</code> gets set to the blog url in production. For example, if the blog (or any web site really) that needs to access the search service is hosted at <code>https://my-awesome-blog.com</code>, then the <code>ALLOWED_ORIGIN</code> environment variable would be set to <code>https://my-awesome-blog.com</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># config/initializers/cors.rb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9 mtki\">Rails</span><span class=\"mtk1\">.application.config.middleware.insert_before </span><span class=\"mtk4\">0</span><span class=\"mtk1\">, </span><span class=\"mtk9 mtki\">Rack</span><span class=\"mtk1\">::Cors </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  allow </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origins ENV[</span><span class=\"mtk6\">&#39;ALLOWED_ORIGIN&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk7\">||</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;http://localhost:8000&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    resource </span><span class=\"mtk6\">&#39;/search&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">headers:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">:any</span><span class=\"mtk1\">, </span><span class=\"mtk4\">methods:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">%</span><span class=\"mtk1\">i[get]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">end</span></span></span></code></pre>\n<h2>Deployment</h2>\n<p>Now that the search service is working locally, it's time to deploy it. I'm using Heroku with the PostgreSQL add-on so these instructions will be specific to that platform.</p>\n<p>The <code>search.sql</code> file mentioned in instructions below was covered in <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> of this series.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"bash\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Install the Heroku CLI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">brew tap heroku/brew </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> brew install heroku</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Create an app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">cd</span><span class=\"mtk1\"> /path/to/project</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku create</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Given that all changes are merged to main branch, deploy to Heroku</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">git push heroku main</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Run migrations (this will create the documents table)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku run rake db:migrate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Configure environment variable used by CORS initializer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">heroku config:set ALLOWED_ORIGIN=https://your.blog.com</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Ingest search documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cat </span><span class=\"mtk7\">~</span><span class=\"mtk1\">/path/to/search.sql </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> heroku pg:psql --app app-name</span></span></span></code></pre>\n<p>To test that it's working on Heroku:</p>\n<ul>\n<li>Update the <code>.vscode/settings.json</code> file, <code>production</code> section with the Heroku host. This will be something like <code>https://your-app-name.herokuapp.com</code>.</li>\n<li>Hit <kbd>Cmd</kbd> + <kbd>Opt</kbd> + <kbd>E</kbd> to select the <code>production</code> environment from the environment selector that pops up.</li>\n<li>Run the <code>GET {{host}}/search?q=tdd</code> search request, this time it should return the same results but from the production server.</li>\n</ul>\n<p>If the production request doesn't succeed, check the Heroku logs with <code>heroku logs --tail</code> for further investigation.</p>\n<h2>What's Next?</h2>\n<p>This post explained how to build a search service API using Rails and PostgreSQL with the help of the <a href=\"https://github.com/Casecommons/pg_search\">pg-search</a> gem and how to deploy it. Next up, see <a href=\"../roll-your-own-search-service-for-gatsby-part5\">Part 5: Search GUI</a> for how to build the search UI components of the Gatsby blog, which will tie everything in this series together.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk12 { color: #CFCFC2; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part4/"}}},{"node":{"id":"333e30e6-e0bf-5284-a5b7-12b08b15bc3b","frontmatter":{"title":"Roll Your Own Search with Rails and Postgres: Search Engine","date":"July 2021","category":"PostgreSQL"},"excerpt":"This is the third in a multi-part series of posts detailing how I built the search feature for this blog. This post will provide an overviewâ€¦","html":"<p>This is the third in a multi-part series of posts detailing how I built the search feature for this blog. This post will provide an overview of the search engine, provided by PostgreSQL <a href=\"https://www.postgresql.org/docs/13/textsearch.html\">Full Text Search</a>, and introduce some concepts that will be needed in understanding how to integrate this with Rails.</p>\n<p>In case you missed it, <a href=\"../roll-your-own-search-service-for-gatsby-part1\">Part 1: Search Introduction</a> of this series covers the existing options for adding search to a Gatsby site, and why I decided not to use any of them, and instead build a custom search service. <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> covers the design and population of the <code>documents</code> table that contains all the content to be searched.</p>\n<h2>PostgreSQL Full Text Search</h2>\n<p>A full discussion of how PostgreSQL full text search works is beyond the scope of this article, and I'm actually going to be using a gem that makes integrating it into Rails fairly easy. However, in order to make sense of what the gem is doing, it's worth taking a look \"under the hood\" into the search functions at the database level.</p>\n<p>Recall the <code>documents</code> table, covered in <a href=\"../roll-your-own-search-service-for-gatsby-part2\">Part 2: Search Index</a> of this series, looks like this, just showing a few rows, <code>body</code> column shortened for legibility:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hello=&gt; select title, category, slug, left(body, 40) as body from documents;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                               title                                |     category     |                          slug                           |                   body</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--------------------------------------------------------------------+------------------+---------------------------------------------------------+------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Add a Language to gatsby-remark-vscode                             | web development  | /blog/add-language-gatsby-remark-vscode/                |  This blog is built with [Gatsby](https:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> A VS Code Alternative to Postman                                   | Web Development  | /blog/postman-alternative-vscode/                       |  If youve been doing web development for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails CORS Middleware For Multiple Resources                       | rails            | /blog/rails-cors-middleware-multiple/                   |  A short post for today on a usage of [C</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                                       | javascript       | /blog/tdd-by-example-bugfix/                            |  This post will demonstrate an example o</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Saving on monthly expenses - A Cautionary Tale                     | personal finance | /blog/save-monthly-expense-caution/                     |  Today I want to share a cautionary tale</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Rails Blocked Host Solved by Docker Cleanup                        | rails            | /blog/rails-blocked-host-docker-clean/                  |  Today I want to share a debugging story</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ...</span></span></code></pre>\n<p>Now suppose you were interested in searching for posts about TDD by searching the <code>body</code> column. A naive approach would be something like this:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk1\"> </span><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents </span><span class=\"mtk7\">WHERE</span><span class=\"mtk1\"> body </span><span class=\"mtk7\">LIKE</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;%TDD%&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The performance of <code>LIKE</code> wildcarding may not be very good because the <code>body</code> column contains the entire post content so it could be very large. Also what if the post content refers to lowercase <code>tdd</code>? Then this query would miss some matches. Yes you could use <code>lower(body)</code> instead of <code>body</code> but what if you want to search for <code>expenses</code> but the body has <code>expense</code>? Now you also need to take pluralization and grammar into account. This reveals the limitations of <code>LIKE</code> wildcard searching.</p>\n<h3>to_tsvector</h3>\n<p>With full text search, Postgres provides the <code>to_tsvector</code> function. This function parses a text document into tokens, normalizes the tokens to <a href=\"https://en.wikipedia.org/wiki/Lexeme\">lexemes</a>, and returns a <code>tsvector</code> which lists the lexemes together with their positions in the document. It will not process stop words such as <code>a</code>, <code>the</code>, <code>but</code> etc. because these are words that occur in the English language too frequently to be useful for searching. It also eliminates pluralization and punctuation. This reduces the words to a common form which will be most useful for searching. It does all this by consulting a set of dictionaries for the specified language, which is the first argument to the <code>to_tsvector</code> function.</p>\n<p>Phew, that was a lot of words to explain the <code>to_tsvector</code> function. Let's see an example. Below I've taken just one paragraph from a blog post I wrote about <a href=\"../tdd-by-example-bugfix\">TDD</a>, and then run it through the <code>to_tsvector</code> function using the <code>english</code> language dictionaries (these are provided by PostgreSQL):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven&#39;&#39;t actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>And here is the result, it gets returned all in one line but I've broken it up into multiple lines for legibility. The result is a list of lexemes (normalized english words) and their position in the text that was given as the second argument passed to the <code>to_tsvector</code> function. If the same lexeme appears multiple times in the document text, each position is listed in a comma separated format:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;actual&#39;:54</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;alreadi&#39;:43</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;approach&#39;:5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;assert&#39;:38</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;assum&#39;:39</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;bug&#39;:41</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;buggi&#39;:31</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;code&#39;:14,35,65</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;differ&#39;:7</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;exercis&#39;:29</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;fail&#39;:22,49</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;figur&#39;:9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;first&#39;:19</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;fix&#39;:45,55,63</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;go&#39;:60</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;haven&#39;:52</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;lie&#39;:17</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;make&#39;:37</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;pass&#39;:75</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;portion&#39;:32</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;problem&#39;:16</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;run&#39;:66</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;tdd&#39;:3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;test&#39;:23,27,47,68</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;time&#39;:72</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;write&#39;:20</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;yet&#39;:57</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;</span></span></code></pre>\n<p>Notice how all the words have been lower cased, punctuation removed, and no stop words appear in the results.</p>\n<h3>to_tsquery</h3>\n<p>Looking at the results of <code>to_tsvector</code>, you can start to see how this approach overcomes the limitations of <code>LIKE</code> wildcard searching. But how do you actually use it in a search? This is where the <code>to_tsquery</code> function comes in. This function takes in a language parameter, and a string to search for, and converts it to the <code>tsquery</code> data type. Then the <code>@@</code> operator is used to check if a query (aka <code>tsquery</code>) is contained in a <code>tsvector</code>, which was the output of the <code>to_tsvector</code> function.</p>\n<p>Once again, an example will help to clarify this:</p>\n<p>Suppose you'd like to know whether the word <code>TDD</code> appears in the sample paragraph I extracted earlier from the TDD article. First run the paragraph through the <code>to_tsvector</code> function, then use the <code>@@</code> operator to determine whether the <code>tsquery</code> of <code>TDD</code> is contained in the <code>tsvector</code>:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven&#39;&#39;t actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- true</span></span></span></code></pre>\n<p>The result is true, meaning the term was found. Note that even though I passed in upper case <code>TDD</code>, it matched on the lower case <code>tdd</code> from the list of lexemes returned by the <code>to_tsvector</code> function:</p>\n<p>Let's try searching for the word <code>fixed</code>. Notice the root of this word <code>fix</code> is in the list of lexemes, but not literally <code>fixed</code>. The list of <code>lexemes</code> shown earlier has the word <code>fix</code> appearing in 3 places in the paragraph text: <code>'fix':45,55,63</code>.</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">select</span><span class=\"mtk1\"> to_tsvector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&#39;But with TDD, the approach is different. After figuring out where in the code the problem lies, you first write a failing test. That is, a test that exercises the buggy portion of the code, and makes assertions assuming the bug has already been fixed. This test will fail because you haven&#39;&#39;t actually fixed it yet. Then you go in and fix the code, run the test again, and this time it should pass&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;fixed&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-- true</span></span></span></code></pre>\n<p>Again, a match is found, so the <code>@@ to_tsquery</code> operator returns true.</p>\n<h3>Searching a Table</h3>\n<p>The above examples were manually constructed by extracting some paragraph text from one article. This demonstrates the usefulness of the <code>to_tsvector</code> and <code>to_tsquery</code> functions.</p>\n<p>Now its time to use these against the <code>documents</code> table to show how a real search would work. For example, to search all documents for <code>TDD</code> in the <code>body</code> column, and return a list of title and slugs for the matching documents:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Results:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                    title                    |                   slug</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------------------------------------------+------------------------------------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                | /blog/tdd-by-example-bugfix/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby | /blog/python-interview-question-in-ruby/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                              | /blog/tdd-by-example/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<p>The first and third results make sense, I've written two articles on TDD. But why is the second article on <a href=\"../python-interview-question-in-ruby\">Solving a Python Interview Question in Ruby</a> showing up in the results? Reviewing that article, indeed it does refer several times to TDD as that is used to solve the interview question. So it makes sense that it's included in the results, but why is it showing up before the <code>TDD by Example</code> article?</p>\n<h2>ts_rank</h2>\n<p>This brings up the question of rank. The <code>ts_rank</code> function takes a <code>tsvector</code> and <code>tsquery</code> and returns a number indicating how strong of a match the query is against the given list of lexemes. Let's include the rank in the previous query:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Results:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                    title                    |                   slug                   |   ts_rank</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------------------------------------------+------------------------------------------+-------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                | /blog/tdd-by-example-bugfix/             |  0.09741346</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby | /blog/python-interview-question-in-ruby/ |  0.096883096</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                              | /blog/tdd-by-example/                    |  0.09793941</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<p>The above results show that the <code>Solving a Python Interview Question in Ruby</code> result is the lowest ranked in the list. In order to make search results useful, the most relevant results should be listed first. To make these results sorted by relevance, we can order by descending rank (i.e. highest first):</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"sql\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SELECT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  title,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  slug,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ts_rank(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk7\">as</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">FROM</span><span class=\"mtk1\"> documents</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">WHERE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  to_tsvector(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, body) @@ to_tsquery(</span><span class=\"mtk6\">&#39;english&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;TDD&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ORDER BY</span><span class=\"mtk1\"> </span><span class=\"mtk9\">rank</span><span class=\"mtk1\"> </span><span class=\"mtk7\">DESC</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Now the results show the first article <code>TDD by Example</code> is the most relevant, followed by the next article using TDD to fix a bug, and finally in last place, the interview article where TDD is referred to, but as frequently as the other two articles:</p>\n<pre class=\"grvsc-container gatsby-highlight monokai\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">                    title                    |                   slug                   |    rank</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------------------------------------------+------------------------------------------+-------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example                              | /blog/tdd-by-example/                    |  0.09793941</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> TDD by Example: Fixing a Bug                | /blog/tdd-by-example-bugfix/             |  0.09741346</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> Solving a Python Interview Question in Ruby | /blog/python-interview-question-in-ruby/ |  0.096883096</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(3 rows)</span></span></code></pre>\n<h2>What's Next?</h2>\n<p>This post provided an introduction to PostgreSQL full text search with some examples of using the <code>ts_vector</code>, <code>ts_query</code> and <code>ts_rank</code> functions. Next up, see <a href=\"../roll-your-own-search-service-for-gatsby-part4\">Part 4: Search API</a> for how to integrate this into a Rails model and controller to provide a search API.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","fields":{"slug":"/blog/roll-your-own-search-service-for-gatsby-part3/"}}}]}},"pageContext":{}}}